</html>
            function closeProjectDetailModal() {
                const modal = document.getElementById('projectDetailModal');
                if (modal) {
                    modal.remove();
                }
            }

            // Get status label
            function getStatusLabel(status) {
                const labels = {
                    'planning': 'Äang láº­p káº¿ hoáº¡ch',
                    'waiting_quotation': 'Chá» bÃ¡o giÃ¡',
                    'quotation_approved': 'ÄÃ£ duyá»‡t bÃ¡o giÃ¡',
                    'in_production': 'Äang sáº£n xuáº¥t',
                    'installation': 'Äang láº¯p Ä‘áº·t',
                    'handover': 'ÄÃ£ bÃ n giao',
                    'completed': 'HoÃ n thÃ nh',
                    'cancelled': 'ÄÃ£ há»§y'
                };
                return labels[status] || status;
            }

            // Manage project phases
            function manageProjectPhases(projectId) {
                window.location.href = `projects.html?projectId=${projectId}&tab=phases`;
            }

            // Export projects to Excel
            function exportProjects() {
                alert('Chá»©c nÄƒng xuáº¥t Excel Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn');
            }

            // Edit project
            function editProject(projectId) {
                window.location.href = `projects.html?edit=${projectId}`;
            }

            // Delete project
            async function deleteProject(projectId) {
                if (!confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a dá»± Ã¡n nÃ y?')) {
                    return;
                }

                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const result = await response.json();

                    if (result.success) {
                        loadProjects();
                        showSuccessNotification('ÄÃ£ xÃ³a dá»± Ã¡n thÃ nh cÃ´ng');
                    } else {
                        alert('Lá»—i: ' + result.message);
                    }
                } catch (error) {
                    console.error('Lá»—i:', error);
                    alert('Lá»—i khi xÃ³a dá»± Ã¡n');
                }
            }

            // Open project modal (create new)
            function openProjectModal() {
                const modal = document.getElementById('createProjectModal');
                if (!modal) {
                    console.error('Create project modal not found');
                    return;
                }

                modal.classList.remove('hidden');

                // Load customers
                loadCustomersForProjectModal().catch(err => {
                    console.error('Error loading customers:', err);
                });

                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                const startDateInput = document.getElementById('projectStartDate');
                const deadlineInput = document.getElementById('projectDeadline');

                if (startDateInput) {
                    startDateInput.value = today;
                }

                if (deadlineInput) {
                    const nextMonth = new Date();
                    nextMonth.setMonth(nextMonth.getMonth() + 1);
                    deadlineInput.value = nextMonth.toISOString().split('T')[0];
                }

                // Auto-generate project code
                generateProjectCodeForModal().catch(err => {
                    console.error('Error generating project code:', err);
                });
            }

            // Close create project modal
            function closeCreateProjectModal() {
                const modal = document.getElementById('createProjectModal');
                if (modal) {
                    modal.classList.add('hidden');
                }
                const form = document.getElementById('createProjectForm');
                if (form) {
                    form.reset();
                }
            }

            // Generate project code
            async function generateProjectCodeForModal() {
                try {
                    const token = localStorage.getItem('token');

                    // Get existing project codes to avoid duplicates
                    const response = await fetch(`${API_BASE}/projects`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    let existingCodes = [];
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            existingCodes = result.data.map(p => p.project_code);
                        }
                    }

                    // Find all CTVR codes and get the highest number
                    const ctvrCodes = existingCodes.filter(code => code && code.startsWith('CTVR'));
                    let maxNumber = 0;

                    ctvrCodes.forEach(code => {
                        const match = code.match(/^CTVR(\d+)$/);
                        if (match) {
                            const num = parseInt(match[1], 10);
                            if (num > maxNumber) {
                                maxNumber = num;
                            }
                        }
                    });

                    // Generate next code: CTVR001, CTVR002, CTVR003, etc.
                    const nextNumber = maxNumber + 1;
                    const newCode = `CTVR${nextNumber.toString().padStart(3, '0')}`;

                    const codeInput = document.getElementById('projectCode');
                    if (codeInput) {
                        codeInput.value = newCode;
                    }
                } catch (error) {
                    console.error('Error generating project code:', error);
                    // Fallback: start from CTVR001 if error
                    const codeInput = document.getElementById('projectCode');
                    if (codeInput) {
                        codeInput.value = 'CTVR001';
                    }
                }
            }

            // Load customers for project modal
            async function loadCustomersForProjectModal() {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/customers`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    const select = document.getElementById('projectCustomerId');
                    if (!select) {
                        console.error('Customer select element not found');
                        return;
                    }

                    select.innerHTML = '<option value="">-- Chá»n khÃ¡ch hÃ ng --</option>';

                    if (result.success && result.data && result.data.length > 0) {
                        result.data.forEach(customer => {
                            const option = document.createElement('option');
                            option.value = customer.id;
                            option.textContent = `${customer.full_name || 'N/A'} - ${customer.phone || ''}`;
                            select.appendChild(option);
                        });
                    } else {
                        console.warn('No customers found or invalid response:', result);
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '-- ChÆ°a cÃ³ khÃ¡ch hÃ ng --';
                        select.appendChild(option);
                    }
                } catch (error) {
                    console.error('Lá»—i khi táº£i danh sÃ¡ch khÃ¡ch hÃ ng:', error);
                    const select = document.getElementById('projectCustomerId');
                    if (select) {
                        select.innerHTML = '<option value="">-- Lá»—i khi táº£i danh sÃ¡ch --</option>';
                    }
                }
            }

            // Save project
            async function saveProjectInTab(event) {
                event.preventDefault();

                // Get form values
                const projectCode = document.getElementById('projectCode')?.value.trim();
                const projectName = document.getElementById('projectName')?.value.trim();
                const customerId = document.getElementById('projectCustomerId')?.value;
                const startDate = document.getElementById('projectStartDate')?.value;
                const deadline = document.getElementById('projectDeadline')?.value;
                const notes = document.getElementById('projectNotes')?.value.trim();

                // Frontend validation
                if (!projectCode) {
                    alert('Vui lÃ²ng nháº­p mÃ£ dá»± Ã¡n');
                    document.getElementById('projectCode')?.focus();
                    return;
                }

                if (!projectName) {
                    alert('Vui lÃ²ng nháº­p tÃªn dá»± Ã¡n');
                    document.getElementById('projectName')?.focus();
                    return;
                }

                if (!customerId) {
                    alert('Vui lÃ²ng chá»n khÃ¡ch hÃ ng');
                    document.getElementById('projectCustomerId')?.focus();
                    return;
                }

                if (!startDate) {
                    alert('Vui lÃ²ng chá»n ngÃ y báº¯t Ä‘áº§u');
                    document.getElementById('projectStartDate')?.focus();
                    return;
                }

                if (!deadline) {
                    alert('Vui lÃ²ng chá»n ngÃ y giao dá»± kiáº¿n');
                    document.getElementById('projectDeadline')?.focus();
                    return;
                }

                // Validate dates
                const startDateObj = new Date(startDate);
                const deadlineDateObj = new Date(deadline);

                if (deadlineDateObj < startDateObj) {
                    alert('NgÃ y giao dá»± kiáº¿n pháº£i sau ngÃ y báº¯t Ä‘áº§u');
                    document.getElementById('projectDeadline')?.focus();
                    return;
                }

                const projectData = {
                    project_code: projectCode,
                    project_name: projectName,
                    customer_id: parseInt(customerId),
                    start_date: startDate,
                    deadline: deadline,
                    status: 'new',
                    notes: notes || null
                };

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/projects`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(projectData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Táº¡o dá»± Ã¡n thÃ nh cÃ´ng!');
                        closeCreateProjectModal();
                        // Reload projects list
                        if (typeof loadProjectsInTab === 'function') {
                            await loadProjectsInTab();
                        }
                    } else {
                        const errorMsg = result.message || 'KhÃ´ng thá»ƒ táº¡o dá»± Ã¡n';
                        alert('Lá»—i: ' + errorMsg);
                        console.error('Error creating project:', result);
                    }
                } catch (error) {
                    console.error('Lá»—i:', error);
                    alert('Lá»—i káº¿t ná»‘i server. Vui lÃ²ng kiá»ƒm tra káº¿t ná»‘i máº¡ng vÃ  thá»­ láº¡i.');
                }
            }

            // Open add customer modal from project modal
            function openAddCustomerModalFromProject() {
                // Close project modal temporarily
                closeCreateProjectModal();
                // Open customer modal
                if (typeof openCustomerModal === 'function') {
                    openCustomerModal();
                } else {
                    alert('Vui lÃ²ng thÃªm khÃ¡ch hÃ ng táº¡i tab "Quáº£n lÃ½ KhÃ¡ch hÃ ng"');
                }
            }

            // Format currency helper
            function formatCurrency(amount) {
                if (!amount) return '0â‚«';
                return new Intl.NumberFormat('vi-VN').format(amount) + 'â‚«';
            }

            // Format date helper
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN');
            }

            // Escape HTML helper
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Load company logo and name
            async function loadCompanyLogo() {
                try {
                    const response = await fetch(`${API_BASE}/company-settings`);
                    const result = await response.json();

                    if (result.success && result.data) {
                        // Load logo
                        if (result.data.logo_path) {
                            const logoImg = document.getElementById('companyLogo');
                            const logoIcon = document.getElementById('companyLogoIcon');
                            if (logoImg && logoIcon) {
                                logoImg.src = result.data.logo_path;
                                logoImg.classList.remove('hidden');
                                logoIcon.classList.add('hidden');
                            }
                        }

                        // Load company name
                        const companyNameEl = document.getElementById('companyName');
                        if (companyNameEl && result.data.company_name) {
                            companyNameEl.textContent = result.data.company_name;
                        }
                    }
                } catch (error) {
                    console.error('Lá»—i load logo:', error);
                }
            }

            // ====== PROJECT CARDS FUNCTIONS ======
            let projectCardsData = []; // Store projects data for filtering

            // Load and render project cards
            async function loadProjectCards() {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/projects`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const result = await response.json();

                    if (result.success && result.data) {
                        // Filter out completed projects
                        projectCardsData = (result.data || []).filter(project => {
                            const status = (project.status || '').toLowerCase();
                            const progress = parseFloat(project.progress_percent) || 0;
                            return status !== 'completed' && progress < 100;
                        });

                        // Update heading with count
                        const heading = document.getElementById('projectsHeading');
                        if (heading) {
                            heading.innerHTML = `Dá»± Ã¡n Ä‘ang triá»ƒn khai <span class="text-blue-600">(${projectCardsData.length})</span>`;
                        }

                        // Render project cards
                        renderProjectCards(projectCardsData);

                        // Update KPI counts
                        loadProjectsKPI(result.data);
                    } else {
                        console.error('Failed to load projects:', result.message);
                        const container = document.getElementById('projectsContainer');
                        if (container) {
                            container.innerHTML = '<p class="text-center text-red-500 py-8">Lá»—i khi táº£i dá»¯ liá»‡u dá»± Ã¡n</p>';
                        }
                    }
                } catch (error) {
                    console.error('Error loading projects:', error);
                    const container = document.getElementById('projectsContainer');
                    if (container) {
                        container.innerHTML = '<p class="text-center text-red-500 py-8">Lá»—i káº¿t ná»‘i server</p>';
                    }
                }
            }

            // Render project cards
            function renderProjectCards(projects) {
                const container = document.getElementById('projectsContainer');
                if (!container) return;

                container.innerHTML = '';

                if (projects.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 py-8">ChÆ°a cÃ³ dá»± Ã¡n nÃ o. HÃ£y táº¡o dá»± Ã¡n má»›i!</p>';
                    return;
                }

                projects.forEach(project => {
                    try {
                        const cardHTML = createProjectCardHTML(project);
                        container.insertAdjacentHTML('beforeend', cardHTML);
                    } catch (error) {
                        console.error('Error creating card for project:', project.id, error);
                    }
                });
            }

            // Create project card HTML
            function createProjectCardHTML(project) {
                const progress = project.progress_percent || 0;
                const status = project.status || 'new';
                const customerName = project.customer_name || 'N/A';
                const customerPhone = project.customer_phone || '';
                const projectCode = project.project_code || '';
                const projectName = project.project_name || 'N/A';
                const startDate = project.start_date ? formatDate(project.start_date) : 'N/A';
                const deadline = project.deadline ? formatDate(project.deadline) : 'N/A';
                const totalValue = project.total_value ? formatCurrency(project.total_value) : '0â‚«';

                // Determine status badge
                var statusBadge = '';
                if (status === 'approved' || status === 'quotation_approved') {
                    statusBadge = '<span class="status-badge bg-green-100 text-green-700"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>ÄÃ£ duyá»‡t</span>';
                } else if (status === 'pending' || status === 'quotation_pending' || status === 'waiting_quotation') {
                    statusBadge = '<span class="status-badge bg-yellow-100 text-yellow-700"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Chá» duyá»‡t</span>';
                } else if (status === 'in_production') {
                    statusBadge = '<span class="status-badge bg-blue-100 text-blue-700">Äang sáº£n xuáº¥t</span>';
                } else if (status === 'installation') {
                    statusBadge = '<span class="status-badge bg-purple-100 text-purple-700">Äang láº¯p Ä‘áº·t</span>';
                } else {
                    statusBadge = '<span class="status-badge bg-gray-100 text-gray-600">Má»›i</span>';
                }

                // Determine progress color
                var progressColor = 'bg-gray-400';
                if (progress >= 75) progressColor = 'bg-green-500';
                else if (progress >= 50) progressColor = 'bg-blue-500';
                else if (progress >= 25) progressColor = 'bg-orange-500';

                // Workflow steps
                var workflowSteps = ['BÃ¡o giÃ¡', 'Thiáº¿t káº¿', 'BÃ³c tÃ¡ch', 'Sáº£n xuáº¥t', 'Láº¯p Ä‘áº·t', 'BÃ n giao'];
                var progressNum = parseFloat(progress) || 0;
                var completedSteps = 0;

                // XÃ¡c Ä‘á»‹nh sá»‘ bÆ°á»›c hoÃ n thÃ nh dá»±a trÃªn status VÃ€ progress
                if (progressNum >= 95 || status === 'completed' || status === 'handover') {
                    completedSteps = 6; // Táº¥t cáº£ hoÃ n thÃ nh
                } else if (status === 'installation' || progressNum >= 80) {
                    completedSteps = 5; // Äáº¿n Láº¯p Ä‘áº·t
                } else if (status === 'in_production' || status === 'production' || progressNum >= 50) {
                    completedSteps = 4; // Äáº¿n Sáº£n xuáº¥t (BÃ¡o giÃ¡, Thiáº¿t káº¿, BÃ³c tÃ¡ch Ä‘Ã£ xong)
                } else if (status === 'bom_extraction' || status === 'design' || progressNum >= 35) {
                    completedSteps = 3; // Äáº¿n BÃ³c tÃ¡ch
                } else if (status === 'quotation_approved' || status === 'approved' || project.contract_locked || progressNum >= 20) {
                    completedSteps = 2; // Äáº¿n Thiáº¿t káº¿
                } else if (status === 'quotation_pending' || status === 'waiting_quotation' || project.quote_locked || progressNum >= 10) {
                    completedSteps = 1; // Äáº¿n BÃ¡o giÃ¡
                } else {
                    completedSteps = 0; // Má»›i táº¡o
                }

                var workflowHTML = '';
                workflowSteps.forEach(function (step, index) {
                    var isActive = index < completedSteps;
                    workflowHTML += '<div class="workflow-step">';
                    workflowHTML += '<div class="workflow-step-circle ' + (isActive ? 'active' : 'inactive') + '">';
                    workflowHTML += isActive ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>' : 'â€”';
                    workflowHTML += '</div>';
                    workflowHTML += '<span class="text-xs text-center mt-1">' + step + '</span>';
                    workflowHTML += '</div>';
                });


                var customerPhoneHTML = '';
                if (customerPhone) {
                    customerPhoneHTML = '<span class="flex items-center gap-1">' +
                        '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />' +
                        '</svg>' + escapeHtml(customerPhone) + '</span>';
                }

                var html = '';
                html += '<div class="project-card bg-white shadow-lg rounded-2xl p-6 fade-in" ';
                html += 'data-status="' + status + '" ';
                html += 'data-progress="' + progress + '" ';
                html += 'data-name="' + escapeHtml(projectName) + '" ';
                html += 'data-customer="' + escapeHtml(customerName) + '" ';
                html += 'data-phone="' + customerPhone + '" ';
                html += 'data-code="' + projectCode + '" ';
                html += 'data-project-id="' + project.id + '">';

                html += '<div class="flex justify-between items-start mb-4">';
                html += '<div class="flex-1">';
                html += '<div class="flex items-center gap-3 mb-2">';
                html += '<h3 class="text-xl font-bold">' + escapeHtml(projectName) + '</h3>';
                html += '<span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">' + escapeHtml(projectCode) + '</span>';
                html += '</div>';
                html += '<div class="flex items-center gap-4 text-sm text-gray-600 mb-3">';
                html += '<span class="flex items-center gap-1">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">';
                html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />';
                html += '</svg>' + escapeHtml(customerName) + '</span>';
                html += customerPhoneHTML;
                html += '</div></div>';

                html += '<div class="text-right">';
                html += '<div class="text-sm text-gray-600 mb-1">NgÃ y báº¯t Ä‘áº§u: <span class="font-medium">' + startDate + '</span></div>';
                html += '<div class="text-sm text-gray-600 mb-1">NgÃ y giao: <span class="font-medium">' + deadline + '</span></div>';
                html += '<div class="text-lg font-bold text-green-600">' + totalValue + '</div>';
                html += '</div></div>';

                html += '<div class="mb-3">';
                html += '<div class="flex justify-between items-center mb-1">';
                html += '<span class="text-sm font-medium">Tiáº¿n Ä‘á»™: ' + progress + '%</span>';
                html += '</div>';
                html += '<div class="progress-bar bg-gray-200">';
                html += '<div class="' + progressColor + ' h-full" style="width: ' + progress + '%;"></div>';
                html += '</div></div>';

                html += '<div class="flex items-center gap-2 mb-3">' + statusBadge + '</div>';

                html += '<div class="mt-4 pt-4 border-t border-gray-200">';
                html += '<div class="flex justify-between items-center">' + workflowHTML + '</div>';
                html += '</div>';

                html += '<div class="mt-4 flex gap-2 flex-wrap">';
                html += '<button onclick="window.location.href=\'design-new.html?projectId=' + project.id + '\';" class="action-btn border-2 border-blue-500 text-blue-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>';
                html += 'Thiáº¿t káº¿</button>';

                html += '<button onclick="window.location.href=\'project-doors.html?projectId=' + project.id + '\';" class="action-btn border-2 border-indigo-500 text-indigo-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>';
                html += 'Cá»­a</button>';

                html += '<button onclick="viewProjectDetails(' + JSON.stringify(projectCode) + ');" class="action-btn border-2 border-purple-500 text-purple-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>';
                html += 'Chi tiáº¿t</button>';

                html += '<button onclick="editProject(' + project.id + ');" class="action-btn border-2 border-green-500 text-green-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>';
                html += 'Sá»­a</button>';

                html += '<button onclick="deleteProject(' + project.id + ')" class="action-btn border-2 border-red-500 text-red-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>';
                html += 'XÃ³a</button>';
                html += '</div></div>';

                return html;
            }

            // Filter project cards
            function filterProjectCards() {
                const searchInput = document.getElementById('searchProjectInput');
                const statusFilter = document.getElementById('statusFilter');
                const progressFilter = document.getElementById('progressFilter');

                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                const statusValue = statusFilter ? statusFilter.value : 'all';
                const progressValue = progressFilter ? progressFilter.value : 'all';

                const projectCards = document.querySelectorAll('.project-card');
                let visibleCount = 0;

                projectCards.forEach(card => {
                    const name = (card.getAttribute('data-name') || '').toLowerCase();
                    const customer = (card.getAttribute('data-customer') || '').toLowerCase();
                    const phone = (card.getAttribute('data-phone') || '').toLowerCase();
                    const code = (card.getAttribute('data-code') || '').toLowerCase();
                    const status = card.getAttribute('data-status') || '';
                    const progress = parseInt(card.getAttribute('data-progress')) || 0;

                    // Search filter
                    const matchesSearch = !searchTerm ||
                        name.includes(searchTerm) ||
                        customer.includes(searchTerm) ||
                        phone.includes(searchTerm) ||
                        code.includes(searchTerm);

                    // Status filter
                    let matchesStatus = true;
                    if (statusValue !== 'all') {
                        if (statusValue === 'approved') {
                            matchesStatus = status === 'approved' || status === 'quotation_approved';
                        } else if (statusValue === 'pending') {
                            matchesStatus = status === 'pending' || status === 'quotation_pending' || status === 'waiting_quotation';
                        } else if (statusValue === 'not-created') {
                            matchesStatus = status === 'new' || status === 'planning';
                        }
                    }

                    // Progress filter
                    let matchesProgress = true;
                    if (progressValue !== 'all') {
                        if (progressValue === '0-25') {
                            matchesProgress = progress >= 0 && progress <= 25;
                        } else if (progressValue === '25-50') {
                            matchesProgress = progress > 25 && progress <= 50;
                        } else if (progressValue === '50-75') {
                            matchesProgress = progress > 50 && progress <= 75;
                        } else if (progressValue === '75-100') {
                            matchesProgress = progress > 75 && progress <= 100;
                        }
                    }

                    // Show/hide card
                    if (matchesSearch && matchesStatus && matchesProgress) {
                        card.classList.remove('hidden');
                        visibleCount++;
                    } else {
                        card.classList.add('hidden');
                    }
                });

                // Update count in heading
                const heading = document.getElementById('projectsHeading');
                if (heading) {
                    heading.innerHTML = 'Dá»± Ã¡n Ä‘ang triá»ƒn khai <span class="text-blue-600">(' + visibleCount + ')</span>';
                }
            }

            // Load KPI counts for projects
            function loadProjectsKPI(allProjects) {
                // Running projects (not completed)
                const runningProjects = allProjects.filter(p => {
                    const status = (p.status || '').toLowerCase();
                    const progress = parseFloat(p.progress_percent) || 0;
                    return status !== 'completed' && progress < 100;
                });

                // Pending quotations
                const pendingQuotations = allProjects.filter(p => {
                    const status = (p.status || '').toLowerCase();
                    return status === 'pending' || status === 'quotation_pending' || status === 'waiting_quotation';
                });

                // Production orders (in_production or bom_extraction)
                const productionOrders = allProjects.filter(p => {
                    const status = (p.status || '').toLowerCase();
                    return status === 'in_production' || status === 'bom_extraction' || status === 'production';
                });

                // Completed projects
                const completedProjects = allProjects.filter(p => {
                    const status = (p.status || '').toLowerCase();
                    const progress = parseFloat(p.progress_percent) || 0;
                    return status === 'completed' || progress >= 100;
                });

                // Update KPI elements
                const runningEl = document.getElementById('runningProjectsCount');
                const pendingEl = document.getElementById('pendingQuotationsCount');
                const productionEl = document.getElementById('productionOrdersCount');
                const completedEl = document.getElementById('completedProjectsCount');

                if (runningEl) runningEl.textContent = runningProjects.length;
                if (pendingEl) pendingEl.textContent = pendingQuotations.length;
                if (productionEl) productionEl.textContent = productionOrders.length;
                if (completedEl) completedEl.textContent = completedProjects.length;
            }

            // Call loadProjectCards when switching to projects tab
            const originalSwitchTab = window.switchTab;
            window.switchTab = function (tabName, button) {
                if (typeof originalSwitchTab === 'function') {
                    originalSwitchTab(tabName, button);
                } else {
                    // Default tab switching logic
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    const targetTab = document.getElementById('tab-' + tabName);
                    if (targetTab) {
                        targetTab.classList.add('active');
                    }
                    if (button) {
                        button.classList.add('active');
                    }
                }

                // Load project cards when switching to projects tab
                if (tabName === 'projects') {
                    loadProjectCards();
                }
            };
        </script>

        <!-- User Menu Dropdown -->
        <div id="userMenuDropdown"
            class="hidden fixed right-4 top-16 w-48 bg-white rounded-lg shadow-xl z-[9999] border border-gray-200">
