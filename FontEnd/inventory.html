<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Kho - Hệ thống quản lý cửa nhôm kính</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/sidebar-enterprise.css">
    <link rel="stylesheet" href="css/success-notification.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            z-index: 1000;
        }

        .main-content {
            margin-left: 260px;
            background: #f3f4f6;
            min-height: 100vh;
        }

        .nav-item {
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: rgba(59, 130, 246, 0.3);
            border-left: 3px solid #60a5fa;
        }

        .header-gradient {
            background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1000;
        }

        .kpi-card-gradient {
            background: linear-gradient(to bottom right, #ffffff, #f0f9ff);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-button {
            transition: all 0.3s ease;
        }

        .tab-button.active {
            border-bottom: 3px solid #10b981;
            color: #10b981;
            font-weight: 600;
        }

        .sub-tab-button {
            transition: all 0.3s ease;
        }

        .sub-tab-button.active {
            border-bottom: 3px solid #14b8a6;
            color: #14b8a6;
            font-weight: 600;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
    <link rel="stylesheet" href="css/notification-header.css">
</head>

<body>

    <!-- Header Notification (Top Right) -->
    <div class="header-notification-container">
        <button id="headerNotificationButton" class="header-notification-button" onclick="toggleHeaderNotifications()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <span id="headerNotificationBadge" class="header-notification-badge hidden">0</span>
        </button>

        <div id="headerNotificationsDropdown" class="header-notifications-dropdown">
            <div class="header-notifications-header">
                <h3>Thông báo</h3>
            </div>
            <div id="headerNotificationsList" class="header-notifications-list">
                <!-- Notifications will be loaded here -->
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar text-white">
        <!-- Logo -->
        <a href="settings.html" class="block p-6 border-b border-blue-600 hover:bg-blue-700 transition cursor-pointer">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-400 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0"
                    id="companyLogoContainer">
                    <img id="companyLogo" src="" alt="Logo" class="hidden w-full h-full object-contain">
                    <svg id="companyLogoIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" class="w-6 h-6 text-white">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <span class="text-xl font-bold" id="companyName">ViralWindow</span>
            </div>
        </a>

        <!-- User Profile -->
        <div class="p-4 border-b border-blue-600 relative">
            <div class="flex items-center gap-3 cursor-pointer hover:bg-blue-700 rounded-lg p-2"
                onclick="toggleSidebarUserMenu()">
                <div class="w-10 h-10 bg-blue-400 rounded-full flex items-center justify-center font-semibold overflow-hidden"
                    id="sidebarUserAvatar">
                    <div id="sidebarUserAvatarInitial">U</div>
                    <img id="sidebarUserAvatarImage" src="" alt="Avatar"
                        class="hidden w-full h-full object-cover rounded-full">
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-sm" id="sidebarUserName">Lê Văn Hải</div>
                    <div class="text-xs text-blue-200">Quản lý</div>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <!-- User Menu Dropdown -->
            <div id="sidebarUserMenuDropdown"
                class="hidden absolute left-0 right-0 mt-2 bg-white rounded-lg shadow-xl z-[9999] border border-gray-200">
                <div class="p-2">
                    <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">Hồ
                        sơ</a>
                    <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">Cài
                        đặt</a>
                    <hr class="my-2">
                    <button onclick="handleLogout()"
                        class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 rounded">Đăng
                        xuất</button>
                </div>
            </div>
        </div>

        <!-- Navigation Menu -->
        <nav class="sidebar-nav">
            <!-- TỔNG QUAN -->
            <a href="index.html" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span>TỔNG QUAN</span>
            </a>

            <!-- KINH DOANH -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span>KINH DOANH</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="sales.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span>Khách hàng & Dự án</span>
                </a>
                <a href="quotation-new.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Báo giá</span>
                </a>
            </div>

            <!-- KỸ THUẬT -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>KỸ THUẬT</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="design-new.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                    <span>Thiết kế & Bóc tách</span>
                </a>
                <a href="material-requests.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Yêu cầu vật tư</span>
                </a>
            </div>

            <!-- SẢN XUẤT -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                    </svg>
                    <span>SẢN XUẤT</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="production.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                    <span>Quy trình sản xuất</span>
                </a>
                <a href="production-management.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Lệnh sản xuất</span>
                </a>
            </div>

            <!-- KHO & VẬT TƯ -->
            <div class="nav-item has-submenu expanded">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    <span>KHO & VẬT TƯ</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu expanded">
                <a href="inventory.html" class="submenu-item active">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    <span>Kho vật tư</span>
                </a>
                <a href="exported-materials.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                    <span>Xuất vật tư</span>
                </a>
            </div>

            <!-- THI CÔNG & NGHIỆM THU -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>THI CÔNG & NGHIỆM THU</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="installation.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>Lắp đặt</span>
                </a>
                <a href="handover.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    <span>Bàn giao</span>
                </a>
            </div>

            <!-- TÀI CHÍNH -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>TÀI CHÍNH</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="finance-dashboard.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span>Tài chính</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <!-- Top Header Bar -->
        <div class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-semibold text-gray-800">Quản lý Kho</h1>
                <p class="text-sm text-gray-500 mt-1">Quản lý nhập xuất, tồn kho và nhôm thừa</p>
            </div>
            <div class="flex items-center gap-4">

                <!-- User Menu -->
                <div class="relative">
                    <button onclick="toggleHeaderUserMenu()"
                        class="flex items-center gap-2 p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition">
                        <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-semibold overflow-hidden"
                            id="headerUserAvatar">
                            <div id="headerUserAvatarInitial">U</div>
                            <img id="headerUserAvatarImage" src="" alt="Avatar"
                                class="hidden w-full h-full object-cover rounded-full">
                        </div>
                    </button>
                    <!-- User Dropdown -->
                    <div id="headerUserMenuDropdown"
                        class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl z-[9999] border border-gray-200">
                        <div class="p-2">
                            <a href="profile.html"
                                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">Hồ sơ</a>
                            <a href="settings.html"
                                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">Cài đặt</a>
                            <hr class="my-2">
                            <button onclick="handleLogout()"
                                class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 rounded">Đăng
                                xuất</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-6">
            <!-- SUMMARY CARDS -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="kpi-card kpi-card-gradient bg-white rounded-xl shadow p-5 fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Tổng mặt hàng</p>
                            <p class="text-3xl font-bold" id="statTotalItems">0</p>
                            <p class="text-xs text-gray-500 mt-1">Tổng hợp từ 4 module</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" class="w-6 h-6 text-green-600">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="kpi-card kpi-card-gradient bg-white rounded-xl shadow p-5 fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Cảnh báo tồn kho</p>
                            <p class="text-3xl font-bold text-red-600" id="statLowStock">0</p>
                            <p class="text-xs text-gray-500 mt-1">Tổng hợp từ 4 module</p>
                        </div>
                        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" class="w-6 h-6 text-red-600">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="kpi-card kpi-card-gradient bg-white rounded-xl shadow p-5 fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Giá trị tồn kho</p>
                            <p class="text-3xl font-bold text-green-600" id="statInventoryValue">0.0M</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" class="w-6 h-6 text-green-600">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="kpi-card kpi-card-gradient bg-white rounded-xl shadow p-5 fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Nhôm thừa</p>
                            <p class="text-3xl font-bold text-orange-600" id="statScraps">0</p>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" class="w-6 h-6 text-orange-600">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TABS -->
            <div class="bg-white rounded-xl shadow mb-6">
                <div class="border-b border-gray-200 px-6">
                    <div class="flex gap-8">
                        <button
                            class="tab-button px-4 py-4 flex items-center gap-2 text-gray-600 hover:text-green-600 active"
                            onclick="switchTab('accessory', this)">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Phụ kiện
                        </button>
                        <button class="tab-button px-4 py-4 flex items-center gap-2 text-gray-600 hover:text-green-600"
                            onclick="switchTab('aluminum', this)">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            Kho nhôm
                        </button>
                        <button class="tab-button px-4 py-4 flex items-center gap-2 text-gray-600 hover:text-green-600"
                            onclick="switchTab('glass', this)">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                            Kính
                        </button>
                        <button class="tab-button px-4 py-4 flex items-center gap-2 text-gray-600 hover:text-green-600"
                            onclick="switchTab('other', this)">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                            </svg>
                            Vật tư phụ
                        </button>
                        <button class="tab-button px-4 py-4 flex items-center gap-2 text-gray-600 hover:text-green-600"
                            onclick="switchTab('transactions', this)">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            Xuất vật tư
                        </button>
                        <button class="tab-button px-4 py-4 flex items-center gap-2 text-gray-600 hover:text-green-600"
                            onclick="switchTab('scraps', this)">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" />
                            </svg>
                            Nhôm thừa
                        </button>
                        <a href="warehouse-export.html"
                            class="tab-button px-4 py-4 flex items-center gap-2 text-gray-600 hover:text-green-600">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Xuất kho
                        </a>
                    </div>
                </div>

                <!-- TAB: PHỤ KIỆN -->
                <div id="tab-accessory" class="tab-content active p-6">
                    <div class="bg-white rounded-xl shadow p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex-1">
                                <input type="text" id="searchAccessory" placeholder="Tìm kiếm phụ kiện..."
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                                    onkeyup="filterAccessory()">
                            </div>
                            <select id="accessoryCategoryFilter"
                                class="mx-4 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                                onchange="filterAccessory()">
                                <option value="all">Tất cả danh mục</option>
                                <option value="Khóa">Khóa</option>
                                <option value="Bản lề">Bản lề</option>
                                <option value="Tay nắm">Tay nắm</option>
                                <option value="Phụ kiện lùa">Phụ kiện lùa</option>
                                <option value="Phụ kiện khác">Phụ kiện khác</option>
                            </select>
                            <button
                                class="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 hover:bg-teal-600"
                                onclick="openAccessoryModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Thêm phụ kiện
                            </button>
                        </div>

                        <!-- Accessories Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">MÃ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TÊN
                                            PHỤ
                                            KIỆN</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">DANH
                                            MỤC
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ĐƠN
                                            VỊ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">GIÁ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TỒN
                                            KHO
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TỔNG
                                            GIÁ
                                            TRỊ</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">THAO
                                            TÁC
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="accessoryTable">
                                    <!-- Accessories will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB: HỆ NHÔM -->
                <div id="tab-aluminum" class="tab-content p-6">
                    <div class="bg-white rounded-xl shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">Danh sách kho nhôm</h2>
                            <div class="flex gap-4">
                                <input type="text" id="searchAluminum" placeholder="Tìm kiếm theo mã, tên hoặc hãng..."
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                                    onkeyup="filterAluminum()">
                                <button
                                    class="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 hover:bg-teal-600"
                                    onclick="openAluminumModal()">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Thêm kho nhôm
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">MÃ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">HỆ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TÊN
                                            THANH NHÔM</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">MẶT
                                            CẮT
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TỈ
                                            TRỌNG
                                            THÔ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">MÉT
                                            DÀI
                                            (M)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">SỐ
                                            LƯỢNG
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">MÀU
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">GIÁ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TỔNG
                                            GIÁ
                                            TRỊ</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">THAO
                                            TÁC
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="aluminumTable">
                                    <!-- Aluminum systems will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB: KÍNH -->
                <div id="tab-glass" class="tab-content p-6">
                    <div class="bg-white rounded-xl shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">Danh sách kính</h2>
                            <div class="flex gap-4">
                                <input type="text" id="searchGlass" placeholder="Tìm kiếm theo mã, tên..."
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                                    onkeyup="filterGlass()">
                                <button
                                    class="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 hover:bg-teal-600"
                                    onclick="openGlassModal()">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Thêm kính
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">MÃ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TÊN
                                            KÍNH
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">LOẠI
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ĐỘ
                                            DÀY
                                            (MM)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">KÍCH
                                            THƯỚC (D x R)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">DIỆN
                                            TÍCH (M²)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">GIÁ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TỒN
                                            KHO
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TỔNG
                                            GIÁ
                                            TRỊ</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">THAO
                                            TÁC
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="glassTable">
                                    <!-- Glass items will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB: VẬT TƯ PHỤ -->
                <div id="tab-other" class="tab-content p-6">
                    <!-- Sub-tabs for Vật tư phụ -->
                    <div class="bg-white rounded-xl shadow mb-6">
                        <div class="border-b border-gray-200 px-6">
                            <div class="flex gap-4">
                                <button
                                    class="sub-tab-button px-4 py-3 flex items-center gap-2 text-gray-600 hover:text-teal-600 active"
                                    onclick="switchSubTab('ke', this)">
                                    Ke
                                </button>
                                <button
                                    class="sub-tab-button px-4 py-3 flex items-center gap-2 text-gray-600 hover:text-teal-600"
                                    onclick="switchSubTab('gioang', this)">
                                    Gioăng
                                </button>
                                <button
                                    class="sub-tab-button px-4 py-3 flex items-center gap-2 text-gray-600 hover:text-teal-600"
                                    onclick="switchSubTab('nhua-op', this)">
                                    Nhựa ốp
                                </button>
                                <button
                                    class="sub-tab-button px-4 py-3 flex items-center gap-2 text-gray-600 hover:text-teal-600"
                                    onclick="switchSubTab('keo', this)">
                                    Keo
                                </button>
                                <button
                                    class="sub-tab-button px-4 py-3 flex items-center gap-2 text-gray-600 hover:text-teal-600"
                                    onclick="switchSubTab('khac', this)">
                                    Khác
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold" id="otherSubTabTitle">Danh sách vật tư phụ - Ke</h2>
                            <div class="flex gap-4">
                                <input type="text" id="searchOther" placeholder="Tìm kiếm theo mã, tên..."
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                                    onkeyup="filterOther()">
                                <button
                                    class="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 hover:bg-teal-600"
                                    onclick="openOtherModal()">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Thêm vật tư
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">MÃ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TÊN
                                            VẬT
                                            TƯ</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">LOẠI
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ĐƠN
                                            VỊ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">GIÁ
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TỒN
                                            KHO
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TỔNG
                                            GIÁ
                                            TRỊ</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">THAO
                                            TÁC
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="otherTable">
                                    <!-- Other items will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB: XUẤT VẬT TƯ CHO DỰ ÁN -->
                <div id="tab-transactions" class="tab-content p-6">
                    <!-- Chọn dự án -->
                    <div class="bg-white rounded-xl shadow p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Xuất vật tư cho dự án</h2>
                        </div>
                        <div class="flex gap-4 items-end">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Chọn dự án</label>
                                <select id="exportProjectSelect"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                                    onchange="loadProjectMaterials()">
                                    <option value="">-- Chọn dự án để xuất vật tư --</option>
                                </select>
                            </div>
                            <button onclick="openAddMaterialModal()" id="btnAddMaterial" disabled
                                class="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 hover:bg-teal-600 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Thêm vật tư
                            </button>
                        </div>
                    </div>

                    <!-- Thông tin dự án đã chọn -->
                    <div id="selectedProjectInfo"
                        class="hidden bg-gradient-to-r from-teal-500 to-blue-500 rounded-xl shadow p-4 mb-6 text-white">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg" id="selectedProjectName">-</h3>
                                <p class="text-sm opacity-90" id="selectedProjectCustomer">Khách hàng: -</p>
                            </div>
                            <div class="flex items-center gap-6">
                                <div class="text-right">
                                    <p class="text-2xl font-bold" id="selectedProjectTotalCost">0 ₫</p>
                                    <p class="text-sm opacity-90">Tổng chi phí vật tư</p>
                                </div>
                                <button onclick="confirmMaterialExport()" id="btnConfirmExport"
                                    class="bg-white text-teal-600 px-6 py-2 rounded-lg font-semibold flex items-center gap-2 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
                                    disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Xác nhận xuất
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Thanh tìm kiếm và filter -->
                    <div class="bg-white rounded-xl shadow p-6 mb-6">
                        <div class="flex gap-4 items-end">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tìm kiếm vật tư</label>
                                <input type="text" id="exportMaterialSearch" placeholder="Tìm kiếm theo tên vật tư..."
                                    oninput="filterExportedMaterials()"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                            </div>
                            <div id="exportCategoryFilterContainer" style="min-width: 200px;">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Danh mục</label>
                                <select id="exportCategoryFilter" onchange="filterExportedMaterials()"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                    <option value="">Tất cả danh mục</option>
                                </select>
                            </div>
                            <div id="exportSystemFilterContainer" style="min-width: 250px;">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hệ</label>
                                <select id="exportSystemFilter" onchange="filterExportedMaterials()"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                    <option value="">Tất cả hệ</option>
                                    <option value="VRA – Hệ 55 mở quay">VRA – Hệ 55 mở quay</option>
                                    <option value="VRA – Hệ 50">VRA – Hệ 50</option>
                                    <option value="VRA – Hệ 64 (cửa sổ lùa)">VRA – Hệ 64 (cửa sổ lùa)</option>
                                    <option value="VRE – Hệ 65 mở quay (Mạnh Quy)">VRE – Hệ 65 mở quay (Mạnh Quy)
                                    </option>
                                    <option value="VRE – Hệ 65 mở quay (Yangly)">VRE – Hệ 65 mở quay (Yangly)</option>
                                    <option value="VRE – Hệ xếp trượt 80">VRE – Hệ xếp trượt 80</option>
                                    <option value="VRE – Hệ lùa 120 & 180">VRE – Hệ lùa 120 & 180</option>
                                    <option value="Hệ lùa 94 mới">Hệ lùa 94 mới</option>
                                    <option value="Thủy lực">Thủy lực</option>
                                    <option value="Mặt dựng">Mặt dựng</option>
                                </select>
                            </div>
                            <div id="exportTypeFilterContainer" style="min-width: 150px;">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Loại</label>
                                <select id="exportTypeFilter" onchange="filterExportedMaterials()"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                    <option value="">Tất cả loại</option>
                                    <option value="accessory">Phụ kiện</option>
                                    <option value="aluminum">Kho nhôm</option>
                                    <option value="glass">Kính</option>
                                    <option value="other">Vật tư phụ</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs cho 2 danh sách -->
                    <div class="bg-white rounded-xl shadow mb-6">
                        <div class="border-b border-gray-200">
                            <nav class="flex -mb-px">
                                <button onclick="switchMaterialListTab('exported')" id="tabExportedBtn"
                                    class="px-6 py-3 text-sm font-medium border-b-2 border-teal-500 text-teal-600 active">
                                    ✅ Vật tư đã xuất (<span id="exportedCount">0</span>)
                                </button>
                                <button onclick="switchMaterialListTab('insufficient')" id="tabInsufficientBtn"
                                    class="px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                    ⚠️ Vật tư chưa đủ (<span id="insufficientCount">0</span>)
                                </button>
                            </nav>
                        </div>
                    </div>

                    <!-- Danh sách vật tư đã xuất (đủ kho) -->
                    <div id="exportedMaterialsSection" class="bg-white rounded-xl shadow overflow-hidden mb-6">
                        <div class="p-4 bg-green-50 border-b border-green-200">
                            <h3 class="text-lg font-semibold text-green-800">✅ Vật tư đã xuất (Đủ kho)</h3>
                            <p class="text-sm text-green-600 mt-1">Các vật tư này đã được xuất thành công vì trong kho
                                có đủ số lượng</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TÊN
                                            VẬT TƯ</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">LOẠI
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">SỐ
                                            LƯỢNG</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ĐƠN
                                            GIÁ</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            THÀNH TIỀN</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TỒN
                                            KHO</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">GHI
                                            CHÚ</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">THAO
                                            TÁC</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="exportedMaterialsTable">
                                    <tr>
                                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                            Chọn dự án để xem vật tư đã xuất
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Danh sách vật tư chưa đủ (thiếu kho) -->
                    <div id="insufficientMaterialsSection" class="bg-white rounded-xl shadow overflow-hidden hidden">
                        <div class="p-4 bg-orange-50 border-b border-orange-200">
                            <h3 class="text-lg font-semibold text-orange-800">⚠️ Vật tư chưa đủ (Thiếu kho)</h3>
                            <p class="text-sm text-orange-600 mt-1">Các vật tư này chưa thể xuất vì trong kho không có
                                hoặc không đủ. Cần bổ sung vào kho trước khi xuất.</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TÊN
                                            VẬT TƯ</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">LOẠI
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">CẦN
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">TỒN
                                            KHO</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            THIẾU</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            TRẠNG THÁI</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">GHI
                                            CHÚ</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">THAO
                                            TÁC</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="insufficientMaterialsTable">
                                    <tr>
                                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                            Không có vật tư chưa đủ
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <!-- TAB: NHÔM THỪA -->
                <div id="tab-scraps" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-4">
                            <button onclick="toggleUsedScraps()" id="toggleUsedBtn"
                                class="px-4 py-2 bg-teal-500 text-white rounded-lg font-medium flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                Hiện đã dùng
                            </button>
                            <span class="text-gray-600" id="scrapsCount">Tổng: 0 đoạn nhôm thừa</span>
                        </div>
                    </div>

                    <div id="scrapsList" class="space-y-4">
                        <!-- Scraps will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Add Inventory Item -->
        <div id="addItemModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Thêm vật tư mới</h2>
                    <button onclick="closeAddItemModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <form id="addItemForm" onsubmit="saveAddItem(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mã vật tư *</label>
                            <input type="text" id="itemCode" required placeholder="VD: VT-001"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tên vật tư *</label>
                            <input type="text" id="itemName" required placeholder="VD: Nhôm Xingfa 55"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Loại *</label>
                                <select id="itemType" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- Chọn loại --</option>
                                    <option value="aluminum">Nhôm</option>
                                    <option value="glass">Kính</option>
                                    <option value="accessory">Phụ kiện</option>
                                    <option value="other">Khác</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Đơn vị *</label>
                                <input type="text" id="itemUnit" required placeholder="VD: kg, m, cái"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tồn kho</label>
                                <input type="number" id="itemStock" step="1" value="0"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Định mức tối thiểu</label>
                                <input type="number" id="itemMinStock" step="1" value="10"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Đơn giá (₫)</label>
                                <input type="number" id="itemPrice" step="1000" value="0"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả</label>
                            <textarea id="itemDescription" rows="3"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" onclick="closeAddItemModal()"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium hover:bg-gray-50">
                            Hủy
                        </button>
                        <button type="submit"
                            class="bg-teal-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-600">
                            Thêm mới
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL: Edit Inventory Item -->
        <div id="editItemModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Chỉnh sửa vật tư</h2>
                    <button onclick="closeEditItemModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <form id="editItemForm" onsubmit="saveEditItem(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tên vật tư *</label>
                            <input type="text" id="editItemName" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Loại *</label>
                                <select id="editItemType" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="aluminum">Nhôm</option>
                                    <option value="glass">Kính</option>
                                    <option value="accessory">Phụ kiện</option>
                                    <option value="other">Khác</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Đơn vị *</label>
                                <input type="text" id="editItemUnit" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tồn kho</label>
                                <input type="number" id="editItemStock" step="1"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Định mức tối thiểu</label>
                                <input type="number" id="editItemMinStock" step="1"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Đơn giá (₫)</label>
                                <input type="number" id="editItemPrice" step="1000"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" onclick="closeEditItemModal()"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium hover:bg-gray-50">
                            Hủy
                        </button>
                        <button type="submit"
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700">
                            Cập nhật
                        </button>
                    </div>
                    <input type="hidden" id="editItemId">
                </form>
            </div>
        </div>

        <!-- MODAL: Add/Edit Aluminum System -->
        <div id="aluminumModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center">
            <div class="bg-white rounded-xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold" id="aluminumModalTitle">Thêm kho nhôm mới</h2>
                    <button onclick="closeAluminumModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <form id="aluminumForm" onsubmit="saveAluminum(event)">
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mã hệ nhôm *</label>
                            <input type="text" id="aluminumCode" required placeholder="VD: XF-001"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hệ *</label>
                            <select id="aluminumSystem" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                <option value="">-- Chọn hệ --</option>
                                <option value="VRA – Hệ 55 mở quay">VRA – Hệ 55 mở quay</option>
                                <option value="VRA – Hệ 50">VRA – Hệ 50</option>
                                <option value="VRA – Hệ 64 (cửa sổ lùa)">VRA – Hệ 64 (cửa sổ lùa)</option>
                                <option value="VRE – Hệ 65 mở quay (Mạnh Quy)">VRE – Hệ 65 mở quay (Mạnh Quy)</option>
                                <option value="VRE – Hệ 65 mở quay (Yangly)">VRE – Hệ 65 mở quay (Yangly)</option>
                                <option value="VRE – Hệ xếp trượt 80">VRE – Hệ xếp trượt 80</option>
                                <option value="VRE – Hệ lùa 120 & 180">VRE – Hệ lùa 120 & 180</option>
                                <option value="Hệ lùa 94 mới">Hệ lùa 94 mới</option>
                                <option value="Thủy lực">Thủy lực</option>
                                <option value="Mặt dựng">Mặt dựng</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mặt Cắt <span
                                    id="aluminumCrossSectionRequired" class="text-red-500">*</span></label>
                            <input type="file" id="aluminumCrossSection" accept="image/*"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                            <p class="text-sm text-gray-500 mt-1">Nếu đã có ảnh, bạn có thể giữ nguyên hoặc chọn ảnh mới
                            </p>
                            <div id="aluminumCrossSectionPreview" class="mt-2 hidden">
                                <img id="aluminumCrossSectionImg" src="" alt="Mặt cắt"
                                    class="max-w-xs max-h-32 object-contain border border-gray-300 rounded">
                                <button type="button" onclick="clearAluminumCrossSection()"
                                    class="mt-2 text-sm text-red-600 hover:text-red-800">Xóa ảnh</button>
                            </div>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tên thanh nhôm *</label>
                            <input type="text" id="aluminumName" required placeholder="VD: Thanh ngang cửa đi"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tỉ trọng thô *</label>
                            <input type="number" id="aluminumDensity" required step="0.001" placeholder="VD: 2.700"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mét dài (M) *</label>
                            <input type="number" id="aluminumLength" required step="0.01" placeholder="VD: 6.0"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Số lượng</label>
                            <input type="number" id="aluminumQuantity" step="1" min="0" placeholder="VD: 0"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Giá (VNĐ)</label>
                            <input type="number" id="aluminumPrice" step="1000" placeholder="VD: 50000"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Màu</label>
                            <input type="text" id="aluminumColor" placeholder="VD: Trắng, Xám, Đen..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả</label>
                            <textarea id="aluminumDescription" rows="3"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4">
                        <button type="button" onclick="closeAluminumModal()"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium hover:bg-gray-50">
                            Hủy
                        </button>
                        <button type="submit"
                            class="bg-teal-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-600">
                            Thêm mới
                        </button>
                    </div>
                    <input type="hidden" id="aluminumId">
                </form>
            </div>
        </div>

        <!-- MODAL: Add/Edit Glass -->
        <div id="glassModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center">
            <div class="bg-white rounded-xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold" id="glassModalTitle">Thêm kính mới</h2>
                    <button onclick="closeGlassModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <form id="glassForm" onsubmit="saveGlass(event)">
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mã kính *</label>
                            <input type="text" id="glassCode" required placeholder="VD: K-001"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Loại kính *</label>
                            <select id="glassType" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                <option value="">-- Chọn loại --</option>
                                <option value="Kính cường lực">Kính cường lực</option>
                                <option value="Kính thường">Kính thường</option>
                                <option value="Kính 2 lớp">Kính 2 lớp</option>
                                <option value="Kính 3 lớp">Kính 3 lớp</option>
                                <option value="Kính dán an toàn">Kính dán an toàn</option>
                                <option value="Khác">Khác</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tên kính *</label>
                            <input type="text" id="glassName" required placeholder="VD: Kính cường lực 8mm"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Độ dày (mm) *</label>
                            <input type="number" id="glassThickness" required step="0.1" placeholder="VD: 8.0"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Chiều dài (m) *</label>
                            <input type="number" id="glassLength" required step="0.01" placeholder="VD: 2.0"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                                oninput="calculateGlassArea()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Chiều rộng (m) *</label>
                            <input type="number" id="glassWidth" required step="0.01" placeholder="VD: 1.5"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                                oninput="calculateGlassArea()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Diện tích (m²)</label>
                            <input type="number" id="glassArea" step="0.01" readonly
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Giá (VNĐ)</label>
                            <input type="number" id="glassPrice" step="1000" placeholder="VD: 200000"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tồn kho (tấm)</label>
                            <input type="number" id="glassStock" step="1" value="0"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả</label>
                            <textarea id="glassDescription" rows="3"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4">
                        <button type="button" onclick="closeGlassModal()"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium hover:bg-gray-50">
                            Hủy
                        </button>
                        <button type="submit"
                            class="bg-teal-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-600">
                            Thêm mới
                        </button>
                    </div>
                    <input type="hidden" id="glassId">
                </form>
            </div>
        </div>

        <!-- MODAL: Add/Edit Other -->
        <div id="otherModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center">
            <div class="bg-white rounded-xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold" id="otherModalTitle">Thêm vật tư khác</h2>
                    <button onclick="closeOtherModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <form id="otherForm" onsubmit="saveOther(event)">
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mã vật tư *</label>
                            <input type="text" id="otherCode" required placeholder="VD: VT-001"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Danh mục *</label>
                            <select id="otherSubCategory" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                <option value="Ke">Ke</option>
                                <option value="Gioăng">Gioăng</option>
                                <option value="Nhựa ốp">Nhựa ốp</option>
                                <option value="Keo">Keo</option>
                                <option value="Khác">Khác</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tên vật tư *</label>
                            <input type="text" id="otherName" required placeholder="VD: Keo silicon"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Đơn vị *</label>
                            <input type="text" id="otherUnit" required placeholder="VD: cái, kg, m"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Giá (VNĐ)</label>
                            <input type="number" id="otherPrice" step="1000" placeholder="VD: 50000"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tồn kho</label>
                            <input type="number" id="otherStock" step="0.01" value="0"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Định mức tối thiểu</label>
                            <input type="number" id="otherMinStock" step="1" value="10"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả</label>
                            <textarea id="otherDescription" rows="3"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4">
                        <button type="button" onclick="closeOtherModal()"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium hover:bg-gray-50">
                            Hủy
                        </button>
                        <button type="submit"
                            class="bg-teal-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-600">
                            Thêm mới
                        </button>
                    </div>
                    <input type="hidden" id="otherId">
                </form>
            </div>
        </div>

        <!-- MODAL: Add Transaction -->
        <div id="transactionModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center">
            <div class="bg-white rounded-xl p-6 w-full max-w-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Thêm giao dịch</h2>
                    <button onclick="closeTransactionModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <form id="transactionForm" onsubmit="saveTransaction(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Vật tư *</label>
                            <select id="transactionItem" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-- Chọn vật tư --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Dự án *</label>
                            <select id="transactionProject" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-- Chọn dự án --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Số lượng *</label>
                            <input type="number" id="transactionQuantity" required step="1" min="1"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ghi chú</label>
                            <textarea id="transactionNotes" rows="3"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" onclick="closeTransactionModal()"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium hover:bg-gray-50">
                            Hủy
                        </button>
                        <button type="submit"
                            class="bg-teal-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-600">
                            Thêm giao dịch
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL: Thêm vật tư cho dự án -->
        <div id="addMaterialModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center">
            <div class="bg-white rounded-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Thêm vật tư cho dự án</h2>
                    <button onclick="closeAddMaterialModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Tabs chọn loại vật tư -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Loại vật tư</label>
                    <div class="flex gap-2 border-b border-gray-200">
                        <button onclick="switchMaterialType('accessory', this)"
                            class="material-type-tab px-4 py-2 font-medium text-gray-600 hover:text-teal-600 border-b-2 border-transparent hover:border-teal-500 active"
                            data-type="accessory">
                            Phụ kiện
                        </button>
                        <button onclick="switchMaterialType('aluminum', this)"
                            class="material-type-tab px-4 py-2 font-medium text-gray-600 hover:text-teal-600 border-b-2 border-transparent hover:border-teal-500"
                            data-type="aluminum">
                            Kho nhôm
                        </button>
                        <button onclick="switchMaterialType('glass', this)"
                            class="material-type-tab px-4 py-2 font-medium text-gray-600 hover:text-teal-600 border-b-2 border-transparent hover:border-teal-500"
                            data-type="glass">
                            Kính
                        </button>
                        <button onclick="switchMaterialType('other', this)"
                            class="material-type-tab px-4 py-2 font-medium text-gray-600 hover:text-teal-600 border-b-2 border-transparent hover:border-teal-500"
                            data-type="other">
                            Vật tư phụ
                        </button>
                    </div>
                </div>

                <!-- Thanh tìm kiếm đơn giản -->
                <div class="mb-4">
                    <input type="text" id="materialSearchInput" placeholder="Tìm kiếm theo mã, tên vật tư..."
                        oninput="filterMaterials()"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>

                <!-- Bảng vật tư có thể chọn -->
                <div class="mb-4 max-h-80 overflow-y-auto border border-gray-200 rounded-lg">
                    <table class="w-full">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-10">
                                    <input type="checkbox" id="selectAllMaterials"
                                        onchange="toggleSelectAllMaterials()">
                                </th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">TÊN VẬT TƯ
                                </th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">TỒN KHO</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ĐƠN GIÁ</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-24">SỐ
                                    LƯỢNG
                                </th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">GHI CHÚ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200" id="inventorySelectTable">
                            <tr>
                                <td colspan="6" class="px-3 py-8 text-center text-gray-500">
                                    Đang tải tất cả sản phẩm...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-between items-center">
                    <span id="selectedMaterialsCount" class="text-sm text-gray-600">Đã chọn: 0 vật tư</span>
                    <div class="flex gap-4">
                        <button type="button" onclick="closeAddMaterialModal()"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium hover:bg-gray-50">
                            Hủy
                        </button>
                        <button type="button" onclick="addSelectedMaterials()"
                            class="bg-teal-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-600">
                            Thêm vật tư đã chọn
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Sửa vật tư -->
        <div id="editMaterialModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center">
            <div class="bg-white rounded-xl p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Sửa vật tư</h2>
                    <button onclick="closeEditMaterialModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <form id="editMaterialForm" onsubmit="saveEditMaterial(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tên vật tư</label>
                            <input type="text" id="editMaterialName" readonly
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Số lượng *</label>
                            <input type="number" id="editMaterialQuantity" required step="0.01" min="0.01"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ghi chú</label>
                            <textarea id="editMaterialNotes" rows="2"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                        </div>
                    </div>
                    <input type="hidden" id="editMaterialId">

                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" onclick="closeEditMaterialModal()"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium hover:bg-gray-50">Hủy</button>
                        <button type="submit"
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700">Cập
                            nhật</button>
                    </div>
                </form>
            </div>
        </div>


        <!-- MODAL: Add/Edit Accessory -->
        <div id="accessoryModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center">
            <div class="bg-white rounded-xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold" id="accessoryModalTitle">Thêm phụ kiện mới</h2>
                    <button onclick="closeAccessoryModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <form id="accessoryForm" onsubmit="saveAccessory(event)">
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mã phụ kiện *</label>
                            <input type="text" id="accessoryCode" required placeholder="VD: PK-001"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Danh mục *</label>
                            <select id="accessoryCategory" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                <option value="">-- Chọn danh mục --</option>
                                <option value="Khóa">Khóa</option>
                                <option value="Bản lề">Bản lề</option>
                                <option value="Tay nắm">Tay nắm</option>
                                <option value="Phụ kiện lùa">Phụ kiện lùa</option>
                                <option value="Phụ kiện khác">Phụ kiện khác</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tên phụ kiện *</label>
                            <input type="text" id="accessoryName" required placeholder="VD: Khóa tay gạt inox 304"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Đơn vị *</label>
                            <input type="text" id="accessoryUnit" required placeholder="VD: Bộ, Cái, Mét"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Giá nhập (₫)</label>
                            <input type="number" id="accessoryPurchasePrice" step="1000"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Giá bán (₫) *</label>
                            <input type="number" id="accessorySalePrice" required step="1000"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tồn kho</label>
                            <input type="number" id="accessoryStock" step="1" value="0"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Định mức tối thiểu</label>
                            <input type="number" id="accessoryMinStock" step="1" value="10"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả</label>
                            <textarea id="accessoryDescription" rows="3"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" onclick="closeAccessoryModal()"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium hover:bg-gray-50">
                            Hủy
                        </button>
                        <button type="submit"
                            class="bg-teal-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-600">
                            Thêm mới
                        </button>
                    </div>
                    <input type="hidden" id="accessoryId">
                </form>
            </div>
        </div>

        <script>
            const API_BASE = 'http://localhost:3001/api';

            // Load company logo and name
            async function loadCompanyLogo() {
                try {
                    const response = await fetch(`${API_BASE}/company-settings`);
                    const result = await response.json();

                    if (result.success && result.data) {
                        // Load logo
                        if (result.data.logo_path) {
                            const logoImg = document.getElementById('companyLogo');
                            const logoIcon = document.getElementById('companyLogoIcon');
                            if (logoImg && logoIcon) {
                                logoImg.src = result.data.logo_path;
                                logoImg.classList.remove('hidden');
                                logoIcon.classList.add('hidden');
                            }
                        }

                        // Load company name
                        const companyNameEl = document.getElementById('companyName');
                        if (companyNameEl && result.data.company_name) {
                            companyNameEl.textContent = result.data.company_name;
                        }
                    }
                } catch (error) {
                    console.error('Lỗi load logo:', error);
                }
            }

            let currentFilter = 'all';
            let currentTransFilter = 'export'; // Chỉ hiển thị xuất kho
            let editingAccessoryId = null;
            let allAccessoriesData = [];
            let showUsedScraps = false;

            // ==================== BIẾN CHO XUẤT VẬT TƯ ====================
            let selectedProjectId = null;        // ID dự án đang chọn để xuất vật tư
            let inventoryDataForExport = [];      // Dữ liệu vật tư kho theo loại (đổi tên để tránh conflict)
            let allInventoryDataForExport = [];   // Dữ liệu gốc để filter
            let allExportedMaterials = [];       // Dữ liệu vật tư đã xuất (gốc) để filter
            // currentMaterialType được khai báo ở dòng 4949 (không khai báo lại ở đây)

            // Code xuất vật tư được định nghĩa ở cuối file (dòng 4234+)

            // ==================== XUẤT VẬT TƯ ====================

            // Load danh sách dự án
            async function loadProjectsForExport() {
                try {
                    const response = await fetch(`${API_BASE}/project-materials/projects/bom-extraction`);
                    const result = await response.json();

                    const select = document.getElementById('exportProjectSelect');
                    select.innerHTML = '<option value="">-- Chọn dự án để xuất vật tư --</option>';

                    if (result.success && result.data) {
                        result.data.forEach(project => {
                            const opt = document.createElement('option');
                            opt.value = project.id;
                            opt.textContent = `${project.project_code} - ${project.project_name} (${project.customer_name || 'N/A'})`;
                            opt.dataset.customer = project.customer_name || '';
                            opt.dataset.name = project.project_name;
                            select.appendChild(opt);
                        });
                    }
                } catch (error) {
                    console.error('Lỗi load dự án:', error);
                }
            }

            // Load vật tư của dự án đã chọn
            async function loadProjectMaterials() {
                const select = document.getElementById('exportProjectSelect');
                selectedProjectId = select.value;

                const btnAdd = document.getElementById('btnAddMaterial');
                const projectInfo = document.getElementById('selectedProjectInfo');
                const btnConfirmExport = document.getElementById('btnConfirmExport');

                if (!selectedProjectId) {
                    btnAdd.disabled = true;
                    if (btnConfirmExport) btnConfirmExport.disabled = true;
                    projectInfo.classList.add('hidden');

                    // Reset các bảng
                    document.getElementById('exportedCount').textContent = '0';
                    document.getElementById('insufficientCount').textContent = '0';
                    displayExportedMaterialsTable([]);
                    displayInsufficientMaterialsTable([]);

                    return;
                }

                btnAdd.disabled = false;

                // Hiển thị thông tin dự án
                const selectedOpt = select.options[select.selectedIndex];
                document.getElementById('selectedProjectName').textContent = selectedOpt.textContent;
                document.getElementById('selectedProjectCustomer').textContent = `Khách hàng: ${selectedOpt.dataset.customer || 'N/A'}`;
                projectInfo.classList.remove('hidden');

                try {
                    const response = await fetch(`${API_BASE}/project-materials/${selectedProjectId}`);
                    // Kiểm tra response status trước khi parse JSON
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API error response:', errorText);
                        console.error('Status:', response.status, response.statusText);
                        throw new Error(`API error (${response.status}): ${response.statusText}`);
                    }

                    const result = await response.json();

                    console.log('API Response:', result); // Debug log

                    // Luôn hiển thị dữ liệu, kể cả khi mảng rỗng
                    if (result.success && result.data && Array.isArray(result.data)) {
                        console.log('📦 Tổng vật tư:', result.data.length);
                        console.log('✅ Đã xuất:', result.exported?.length || 0);
                        console.log('⚠️ Chưa đủ:', result.insufficient?.length || 0);
                        console.log('📋 Exported data:', result.exported);
                        console.log('📋 Insufficient data:', result.insufficient);

                        // Lưu dữ liệu gốc để filter
                        allExportedMaterials = result.data || [];

                        // Cập nhật tổng chi phí (chỉ tính vật tư đã xuất)
                        document.getElementById('selectedProjectTotalCost').textContent = formatCurrency(result.total_cost || 0);

                        // Cập nhật số lượng
                        const exportedCount = result.exported_count || (result.exported ? result.exported.length : 0);
                        const insufficientCount = result.insufficient_count || (result.insufficient ? result.insufficient.length : 0);

                        document.getElementById('exportedCount').textContent = exportedCount;
                        document.getElementById('insufficientCount').textContent = insufficientCount;

                        // Kích hoạt nút xác nhận xuất chỉ khi có vật tư đã xuất (đủ kho)
                        if (btnConfirmExport) {
                            btnConfirmExport.disabled = !result.exported || result.exported.length === 0;
                        }

                        // Setup filter dropdowns (chỉ khi có dữ liệu)
                        if (result.data.length > 0) {
                            setupExportedMaterialsFilters(result.data);
                        }

                        // Hiển thị 2 danh sách (luôn hiển thị, kể cả rỗng)
                        displayExportedMaterialsTable(result.exported || []);
                        displayInsufficientMaterialsTable(result.insufficient || []);

                        // Mặc định hiển thị tab "Vật tư đã xuất" nếu có, nếu không thì hiển thị tab có dữ liệu
                        if (exportedCount > 0) {
                            switchMaterialListTab('exported');
                        } else if (insufficientCount > 0) {
                            switchMaterialListTab('insufficient');
                        } else {
                            switchMaterialListTab('exported'); // Mặc định
                        }
                    } else {
                        // Không có dữ liệu hoặc lỗi
                        allExportedMaterials = [];
                        document.getElementById('exportedCount').textContent = '0';
                        document.getElementById('insufficientCount').textContent = '0';
                        document.getElementById('selectedProjectTotalCost').textContent = '0 ₫';
                        displayExportedMaterialsTable([]);
                        displayInsufficientMaterialsTable([]);
                        if (btnConfirmExport) btnConfirmExport.disabled = true;
                    }
                } catch (error) {
                    console.error('Lỗi load vật tư dự án:', error);
                    allExportedMaterials = [];
                    document.getElementById('exportedCount').textContent = '0';
                    document.getElementById('insufficientCount').textContent = '0';

                    // Kiểm tra element tồn tại trước khi set innerHTML
                    const exportedTable = document.getElementById('exportedMaterialsTable');
                    const insufficientTable = document.getElementById('insufficientMaterialsTable');

                    if (exportedTable) {
                        exportedTable.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-red-500">
                                Lỗi khi tải vật tư: ${error.message}
                            </td>
                        </tr>`;
                    }

                    if (insufficientTable) {
                        insufficientTable.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-red-500">
                                Lỗi khi tải vật tư: ${error.message}
                            </td>
                        </tr>`;
                    }

                    if (btnConfirmExport) btnConfirmExport.disabled = true;
                }
            }

            // Setup filter dropdowns cho vật tư đã xuất
            function setupExportedMaterialsFilters(data) {
                // Lấy danh sách category và system từ dữ liệu
                const categories = [...new Set(data.map(item => {
                    // Nếu là accessory hoặc other, lấy category từ material_name hoặc từ database
                    if (item.material_type === 'accessory' || item.material_type === 'other') {
                        // Có thể cần query thêm để lấy category, tạm thời bỏ qua
                        return null;
                    }
                    return null;
                }).filter(c => c))];

                // Ẩn filter category nếu không có dữ liệu
                document.getElementById('exportCategoryFilterContainer').style.display = 'none';

                // Hiển thị filter system nếu có vật tư aluminum
                hasAluminum = data.some(item => item.material_type === 'aluminum');
                document.getElementById('exportSystemFilterContainer').style.display = hasAluminum ? 'block' : 'none';
            }

            // Filter vật tư đã xuất
            function filterExportedMaterials() {
                const searchTerm = document.getElementById('exportMaterialSearch').value.toLowerCase();
                const categoryFilter = document.getElementById('exportCategoryFilter').value;
                const systemFilter = document.getElementById('exportSystemFilter').value;
                const typeFilter = document.getElementById('exportTypeFilter').value;

                let filtered = [...allExportedMaterials];

                // Filter theo search term
                if (searchTerm) {
                    filtered = filtered.filter(item => {
                        const name = (item.material_name || item.item_name || '').toLowerCase();
                        return name.includes(searchTerm);
                    });
                }

                // Filter theo type
                if (typeFilter) {
                    filtered = filtered.filter(item => item.material_type === typeFilter);
                }

                // Filter theo category (nếu có)
                if (categoryFilter) {
                    // Cần query thêm để lấy category, tạm thời bỏ qua
                }

                // Filter theo system (nếu có)
                if (systemFilter) {
                    // Cần query thêm để lấy system, tạm thời bỏ qua
                }

                displayExportedMaterialsTable(filtered);
            }

            // Switch between exported and insufficient materials tabs
            function switchMaterialListTab(tabName) {
                const exportedSection = document.getElementById('exportedMaterialsSection');
                const insufficientSection = document.getElementById('insufficientMaterialsSection');
                const exportedBtn = document.getElementById('tabExportedBtn');
                const insufficientBtn = document.getElementById('tabInsufficientBtn');

                if (tabName === 'exported') {
                    exportedSection.classList.remove('hidden');
                    insufficientSection.classList.add('hidden');
                    exportedBtn.classList.add('border-teal-500', 'text-teal-600', 'active');
                    exportedBtn.classList.remove('border-transparent', 'text-gray-500');
                    insufficientBtn.classList.remove('border-teal-500', 'text-teal-600', 'active');
                    insufficientBtn.classList.add('border-transparent', 'text-gray-500');
                } else {
                    exportedSection.classList.add('hidden');
                    insufficientSection.classList.remove('hidden');
                    insufficientBtn.classList.add('border-teal-500', 'text-teal-600', 'active');
                    insufficientBtn.classList.remove('border-transparent', 'text-gray-500');
                    exportedBtn.classList.remove('border-teal-500', 'text-teal-600', 'active');
                    exportedBtn.classList.add('border-transparent', 'text-gray-500');
                }
            }

            // Display exported materials table (đủ kho)
            function displayExportedMaterialsTable(data) {
                const tbody = document.getElementById('exportedMaterialsTable');

                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                            Chưa có vật tư nào đã xuất (đủ kho)
                        </td>
                    </tr>`;
                    return;
                }

                // Helper functions
                const getTypeName = (type) => {
                    const names = {
                        'accessory': 'Phụ kiện',
                        'aluminum': 'Hệ nhôm',
                        'glass': 'Kính',
                        'other': 'Khác'
                    };
                    return names[type] || type;
                };

                const getTypeColor = (type) => {
                    const colors = {
                        'accessory': 'bg-blue-100 text-blue-700',
                        'aluminum': 'bg-green-100 text-green-700',
                        'glass': 'bg-purple-100 text-purple-700',
                        'other': 'bg-gray-100 text-gray-700'
                    };
                    return colors[type] || 'bg-gray-100 text-gray-700';
                };

                const escapeHtml = (str) => {
                    if (!str) return '';
                    const div = document.createElement('div');
                    div.textContent = String(str);
                    return div.innerHTML;
                };

                // Helper function to format numbers: show integer if whole number, else 2 decimals
                const formatNumber = (num) => {
                    if (num === null || num === undefined || isNaN(num)) return '0';
                    const n = parseFloat(num);
                    return Number.isInteger(n) ? n.toString() : n.toFixed(2).replace(/\.?0+$/, '');
                };

                tbody.innerHTML = data.map(mat => {
                    try {
                        const materialName = mat.material_name || mat.item_name || mat.name || 'N/A';
                        const materialType = mat.material_type || 'other';
                        const quantity = parseFloat(mat.quantity) || 0;
                        let unit = mat.unit || mat.item_unit || 'cái';
                        const unitPrice = parseFloat(mat.unit_price) || 0;
                        const totalCost = parseFloat(mat.total_cost) || (quantity * unitPrice);
                        const availableStock = parseFloat(mat.available_stock) || 0;
                        const notes = mat.stock_note || '';

                        // Đối với kính, đơn vị tồn kho luôn là "tấm" (không phải m²)
                        let stockUnit = unit;
                        if (materialType === 'glass') {
                            stockUnit = 'tấm';
                        }

                        // Xử lý an toàn dữ liệu để tránh lỗi syntax
                        const safeMaterialName = typeof materialName === 'string'
                            ? materialName.replace(/"/g, '&quot;').replace(/'/g, '&#39;')
                            : String(materialName || '');
                        const safeNotes = typeof notes === 'string'
                            ? notes.replace(/"/g, '&quot;').replace(/'/g, '&#39;')
                            : String(notes || '');

                        // Sử dụng data attributes thay vì inline onclick để tránh lỗi syntax
                        const editId = `edit-exported-${mat.id}`;
                        const deleteId = `delete-exported-${mat.id}`;

                        return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 font-medium">${escapeHtml(materialName)}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 text-xs rounded ${getTypeColor(materialType)}">${getTypeName(materialType)}</span>
                            </td>
                            <td class="px-4 py-3">${formatNumber(quantity)} ${unit}</td>
                            <td class="px-4 py-3">${formatCurrency(unitPrice)}</td>
                            <td class="px-4 py-3 font-medium text-green-600">${formatCurrency(totalCost)}</td>
                            <td class="px-4 py-3 text-green-600 font-semibold">${formatNumber(availableStock)} ${stockUnit}</td>
                            <td class="px-4 py-3 text-gray-500 text-sm">${escapeHtml(notes) || '-'}</td>
                            <td class="px-4 py-3">
                                <div class="flex gap-2">
                                    <button id="${editId}" 
                                            data-id="${mat.id}" 
                                            data-name="${safeMaterialName}" 
                                            data-quantity="${quantity}" 
                                            data-notes="${safeNotes}"
                                            class="text-blue-600 hover:text-blue-800 edit-material-btn" 
                                            title="Sửa">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    <button id="${deleteId}" 
                                            data-id="${mat.id}" 
                                            data-name="${safeMaterialName}"
                                            class="text-red-600 hover:text-red-800 delete-material-btn" 
                                            title="Xóa">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    } catch (err) {
                        console.error('Error rendering material:', mat, err);
                        return '';
                    }
                }).join('');

                // Attach event listeners sau khi render để tránh lỗi syntax
                setTimeout(() => {
                    document.querySelectorAll('#exportedMaterialsTable .edit-material-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            const name = this.getAttribute('data-name');
                            const quantity = parseFloat(this.getAttribute('data-quantity')) || 0;
                            const notes = this.getAttribute('data-notes') || '';
                            openEditMaterial(id, name, quantity, notes);
                        });
                    });

                    document.querySelectorAll('#exportedMaterialsTable .delete-material-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            const name = this.getAttribute('data-name');
                            deleteProjectMaterial(id, name);
                        });
                    });
                }, 100);
            }

            // Display insufficient materials table (thiếu kho)
            function displayInsufficientMaterialsTable(data) {
                const tbody = document.getElementById('insufficientMaterialsTable');

                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                            Không có vật tư chưa đủ (tất cả đều đủ kho)
                        </td>
                    </tr>`;
                    return;
                }

                // Helper functions
                const getTypeName = (type) => {
                    const names = {
                        'accessory': 'Phụ kiện',
                        'aluminum': 'Hệ nhôm',
                        'glass': 'Kính',
                        'other': 'Khác'
                    };
                    return names[type] || type;
                };

                const getTypeColor = (type) => {
                    const colors = {
                        'accessory': 'bg-blue-100 text-blue-700',
                        'aluminum': 'bg-green-100 text-green-700',
                        'glass': 'bg-purple-100 text-purple-700',
                        'other': 'bg-gray-100 text-gray-700'
                    };
                    return colors[type] || 'bg-gray-100 text-gray-700';
                };

                const getStockStatusBadge = (status) => {
                    const badges = {
                        'not_found': '<span class="px-2 py-1 text-xs rounded bg-gray-100 text-gray-700">⊘ Không có trong kho</span>',
                        'shortage': '<span class="px-2 py-1 text-xs rounded bg-red-100 text-red-700">✗ Hết kho</span>',
                        'partial': '<span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-700">⚠ Thiếu một phần</span>'
                    };
                    return badges[status] || '<span class="px-2 py-1 text-xs rounded bg-gray-100 text-gray-700">-</span>';
                };

                const escapeHtml = (str) => {
                    if (!str) return '';
                    const div = document.createElement('div');
                    div.textContent = String(str);
                    return div.innerHTML;
                };

                // Helper function to format numbers: show integer if whole number, else 2 decimals
                const formatNumber = (num) => {
                    if (num === null || num === undefined || isNaN(num)) return '0';
                    const n = parseFloat(num);
                    return Number.isInteger(n) ? n.toString() : n.toFixed(2).replace(/\.?0+$/, '');
                };

                tbody.innerHTML = data.map(mat => {
                    try {
                        const materialName = mat.material_name || mat.item_name || mat.name || 'N/A';
                        const materialType = mat.material_type || 'other';
                        // Sử dụng still_needed (số lượng còn cần) thay vì quantity (số lượng đã xuất)
                        const stillNeeded = parseFloat(mat.still_needed) || parseFloat(mat.quantity) || 0;
                        const totalRequired = parseFloat(mat.total_required) || parseFloat(mat.quantity) || 0;
                        const totalExported = parseFloat(mat.total_exported) || parseFloat(mat.quantity) || 0;
                        let unit = mat.unit || mat.item_unit || 'cái';
                        const availableStock = parseFloat(mat.available_stock) || 0;
                        // THIẾU = số lượng cần - tồn kho (khi kho=0, thiếu = cần)
                        const shortage = Math.max(0, stillNeeded - availableStock);
                        const stockStatus = mat.stock_status || 'unknown';
                        const stockNote = mat.stock_note || '';
                        const notes = mat.notes || '';

                        // Đối với kính, đơn vị tồn kho luôn là "tấm" (không phải m²)
                        let stockUnit = unit;
                        if (materialType === 'glass') {
                            stockUnit = 'tấm';
                        }

                        // Xử lý an toàn dữ liệu để tránh lỗi syntax
                        const safeMaterialName = typeof materialName === 'string'
                            ? materialName.replace(/"/g, '&quot;').replace(/'/g, '&#39;')
                            : String(materialName || '');

                        // Sử dụng data attributes thay vì inline onclick để tránh lỗi syntax
                        const deleteId = `delete-insufficient-${mat.id}`;

                        return `
                        <tr class="hover:bg-gray-50 ${stockStatus === 'not_found' ? 'bg-gray-50' : stockStatus === 'shortage' ? 'bg-red-50' : 'bg-yellow-50'}">
                            <td class="px-4 py-3 font-medium">${escapeHtml(materialName)}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 text-xs rounded ${getTypeColor(materialType)}">${getTypeName(materialType)}</span>
                            </td>
                            <td class="px-4 py-3 font-semibold text-blue-600">${formatNumber(stillNeeded)} ${unit}</td>
                            <td class="px-4 py-3 ${availableStock > 0 ? 'text-orange-600' : 'text-gray-500'}">${formatNumber(availableStock)} ${stockUnit}</td>
                            <td class="px-4 py-3 font-semibold text-red-600">${formatNumber(shortage)} ${unit}</td>
                            <td class="px-4 py-3">${getStockStatusBadge(stockStatus)}</td>
                            <td class="px-4 py-3 text-sm text-orange-600 font-medium">${escapeHtml(stockNote)}</td>
                            <td class="px-4 py-3">
                                <div class="flex gap-2">
                                    <button id="${deleteId}" 
                                            data-id="${mat.id}" 
                                            data-name="${safeMaterialName}"
                                            class="text-red-600 hover:text-red-800 delete-material-btn" 
                                            title="Xóa khỏi danh sách">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    } catch (err) {
                        console.error('Error rendering insufficient material:', mat, err);
                        return '';
                    }
                }).join('');

                // Attach event listeners sau khi render để tránh lỗi syntax
                setTimeout(() => {
                    document.querySelectorAll('#insufficientMaterialsTable .delete-material-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const id = this.getAttribute('data-id');
                            const name = this.getAttribute('data-name');
                            deleteProjectMaterial(id, name);
                        });
                    });
                }, 100);
            }

            // Mở modal thêm vật tư
            function openAddMaterialModal() {
                if (!selectedProjectId) {
                    alert('Vui lòng chọn dự án trước');
                    return;
                }
                document.getElementById('addMaterialModal').classList.remove('hidden');
                // Reset
                document.getElementById('inventorySelectTable').innerHTML = `
                <tr>
                    <td colspan="6" class="px-3 py-8 text-center text-gray-500">
                        Đang tải tất cả sản phẩm...
                    </td>
                </tr>`;
                // Clear search
                const searchInput = document.getElementById('materialSearchInput');
                if (searchInput) searchInput.value = '';

                allInventoryDataForExport = [];
                inventoryDataForExport = [];
                updateSelectedCount();

                // Reset về tab Phụ kiện
                currentMaterialTypeInModal = 'accessory';
                const tabs = document.querySelectorAll('.material-type-tab');
                tabs.forEach(tab => {
                    tab.classList.remove('active', 'border-teal-500', 'text-teal-600');
                    tab.classList.add('border-transparent', 'text-gray-600');
                });
                const accessoryTab = document.querySelector('.material-type-tab[data-type="accessory"]');
                if (accessoryTab) {
                    accessoryTab.classList.add('active', 'border-teal-500', 'text-teal-600');
                    accessoryTab.classList.remove('border-transparent', 'text-gray-600');
                }

                // Load vật tư theo loại được chọn
                loadInventoryByTypeForModal('accessory');
            }

            function closeAddMaterialModal() {
                document.getElementById('addMaterialModal').classList.add('hidden');
            }

            // Biến để track loại vật tư hiện tại trong modal
            let currentMaterialTypeInModal = 'accessory';

            // Chuyển tab loại vật tư
            function switchMaterialType(type, buttonElement) {
                currentMaterialTypeInModal = type;

                // Update tab active state
                document.querySelectorAll('.material-type-tab').forEach(tab => {
                    tab.classList.remove('active', 'border-teal-500', 'text-teal-600');
                    tab.classList.add('border-transparent', 'text-gray-600');
                });
                if (buttonElement) {
                    buttonElement.classList.add('active', 'border-teal-500', 'text-teal-600');
                    buttonElement.classList.remove('border-transparent', 'text-gray-600');
                }

                // Clear search
                const searchInput = document.getElementById('materialSearchInput');
                if (searchInput) searchInput.value = '';

                // Load vật tư theo loại
                loadInventoryByTypeForModal(type);
            }

            // Load vật tư theo loại cho modal
            async function loadInventoryByTypeForModal(type) {
                const tbody = document.getElementById('inventorySelectTable');
                if (!tbody) return;

                tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-3 py-8 text-center text-gray-500">
                        Đang tải dữ liệu...
                    </td>
                </tr>`;

                try {
                    const response = await fetch(`${API_BASE}/project-materials/inventory/${type}`);
                    const result = await response.json();

                    if (result.success && result.data) {
                        const items = result.data.map(item => ({
                            ...item,
                            code: item.code || item.item_code || '',
                            name: item.name || item.item_name || '',
                            unit: item.unit || '',
                            price: parseFloat(item.price) || 0,
                            stock: parseFloat(item.stock) || 0,
                            material_type: type
                        }));

                        allInventoryDataForExport = items;
                        inventoryDataForExport = items;
                        displayInventoryTable(items);
                    } else {
                        allInventoryDataForExport = [];
                        inventoryDataForExport = [];
                        tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-3 py-8 text-center text-gray-500">
                                Không có dữ liệu
                            </td>
                        </tr>`;
                    }
                } catch (error) {
                    console.error('Lỗi load vật tư:', error);
                    allInventoryDataForExport = [];
                    inventoryDataForExport = [];
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-3 py-8 text-center text-red-500">
                            Lỗi khi tải dữ liệu: ${error.message}
                        </td>
                    </tr>`;
                }
            }

            // Setup filter dropdowns cho tất cả loại
            function setupAllFiltersDropdowns(data) {
                // Lấy danh sách category từ accessory và other
                const categories = [...new Set(data
                    .filter(item => (item.material_type === 'accessory' || item.material_type === 'other') && item.category)
                    .map(item => item.category)
                    .filter(c => c && c.trim())
                )].sort();

                const categoryFilter = document.getElementById('categoryFilter');
                const categoryContainer = document.getElementById('categoryFilterContainer');

                if (categories.length > 0) {
                    categoryFilter.innerHTML = '<option value="">Tất cả danh mục</option>';
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        categoryFilter.appendChild(option);
                    });
                    categoryContainer.style.display = 'block';
                } else {
                    categoryContainer.style.display = 'none';
                }

                // Lấy danh sách hệ từ aluminum
                const systems = [...new Set(data
                    .filter(item => item.material_type === 'aluminum' && item.aluminum_system)
                    .map(item => item.aluminum_system)
                    .filter(s => s && s.trim())
                )].sort();

                const systemContainer = document.getElementById('systemFilterContainer');
                systemContainer.style.display = systems.length > 0 ? 'block' : 'none';
            }

            // Debounce timer cho search
            let searchDebounceTimer = null;

            // Debounce function cho search input
            function debounceSearch() {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => {
                    filterAllMaterials();
                }, 300); // Đợi 300ms sau khi người dùng ngừng gõ
            }

            // Filter tất cả vật tư (realtime)
            function filterAllMaterials() {
                // Kiểm tra xem có dữ liệu để filter không
                if (!allInventoryDataForExport || allInventoryDataForExport.length === 0) {
                    console.log('Chưa có dữ liệu để filter, đang chờ load...');
                    return;
                }

                const searchInput = document.getElementById('materialSearchInput');
                const typeFilter = document.getElementById('typeFilter');
                const categoryFilter = document.getElementById('categoryFilter');
                const systemFilter = document.getElementById('systemFilter');
                const categoryContainer = document.getElementById('categoryFilterContainer');
                const systemContainer = document.getElementById('systemFilterContainer');

                if (!searchInput) {
                    console.error('Không tìm thấy materialSearchInput');
                    return;
                }

                const searchTerm = removeVietnameseTones(searchInput.value.trim());
                const typeValue = typeFilter ? typeFilter.value : '';
                const categoryValue = categoryFilter ? categoryFilter.value : '';
                const systemValue = systemFilter ? systemFilter.value : '';

                // Hiển thị/ẩn filter phù hợp dựa trên type được chọn
                if (typeValue === 'accessory' || typeValue === 'other') {
                    // Hiển thị category filter, ẩn system filter
                    const categories = [...new Set(allInventoryDataForExport
                        .filter(item => item.material_type === typeValue && item.category)
                        .map(item => item.category)
                        .filter(c => c && c.trim())
                    )].sort();

                    if (categories.length > 0) {
                        categoryFilter.innerHTML = '<option value="">Tất cả danh mục</option>';
                        categories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat;
                            option.textContent = cat;
                            if (cat === categoryValue) option.selected = true;
                            categoryFilter.appendChild(option);
                        });
                        categoryContainer.style.display = 'block';
                    } else {
                        categoryContainer.style.display = 'none';
                    }
                    systemContainer.style.display = 'none';
                } else if (typeValue === 'aluminum') {
                    // Hiển thị system filter, ẩn category filter
                    categoryContainer.style.display = 'none';
                    systemContainer.style.display = 'block';
                } else {
                    // Tất cả loại - ẩn cả hai filter
                    categoryContainer.style.display = 'none';
                    systemContainer.style.display = 'none';
                }

                let filtered = [...allInventoryDataForExport];

                console.log('🔍 Filter với:', {
                    searchTerm,
                    typeValue,
                    categoryValue,
                    systemValue,
                    totalItems: filtered.length
                });

                // Filter theo type TRƯỚC (quan trọng nhất)
                if (typeValue) {
                    filtered = filtered.filter(item => item.material_type === typeValue);
                    console.log('✅ Sau filter type:', filtered.length);
                }

                // Filter theo search term (realtime) - tìm kiếm không phân biệt dấu
                if (searchTerm) {
                    filtered = filtered.filter(item => {
                        // Normalize field names để đảm bảo có code và name
                        const code = removeVietnameseTones(String(item.code || item.item_code || '').toLowerCase());
                        const name = removeVietnameseTones(String(item.name || item.item_name || '').toLowerCase());
                        const searchLower = searchTerm.toLowerCase();

                        // Tìm kiếm trong cả code và name
                        const matchCode = code.includes(searchLower);
                        const matchName = name.includes(searchLower);

                        return matchCode || matchName;
                    });
                    console.log('✅ Sau filter search:', filtered.length, 'với từ khóa:', searchTerm);
                }

                // Filter theo category (chỉ khi đang chọn accessory hoặc other)
                if (categoryValue && (typeValue === 'accessory' || typeValue === 'other')) {
                    filtered = filtered.filter(item => item.category === categoryValue);
                    console.log('✅ Sau filter category:', filtered.length);
                }

                // Filter theo system (chỉ khi đang chọn aluminum)
                if (systemValue && typeValue === 'aluminum') {
                    filtered = filtered.filter(item => item.aluminum_system === systemValue);
                    console.log('✅ Sau filter system:', filtered.length);
                }

                inventoryDataForExport = filtered;
                displayInventoryTable(filtered, 'all');
            }

            // Setup filter dropdown
            function setupFilterDropdown(type, data) {
                const categoryFilter = document.getElementById('categoryFilter');
                const categoryContainer = document.getElementById('categoryFilterContainer');
                const systemContainer = document.getElementById('systemFilterContainer');

                if (type === 'accessory' || type === 'other') {
                    // Lấy danh sách category duy nhất từ dữ liệu
                    const categories = [...new Set(data.map(item => item.category).filter(c => c && c.trim()))];
                    categoryFilter.innerHTML = '<option value="">Tất cả danh mục</option>';

                    // Sắp xếp categories
                    categories.sort().forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        categoryFilter.appendChild(option);
                    });

                    categoryContainer.style.display = categories.length > 0 ? 'block' : 'none';
                    systemContainer.style.display = 'none';
                } else if (type === 'aluminum') {
                    // Lấy danh sách hệ duy nhất từ dữ liệu
                    const systems = [...new Set(data.map(item => item.aluminum_system).filter(s => s && s.trim()))];
                    systemContainer.style.display = systems.length > 0 ? 'block' : 'none';
                    categoryContainer.style.display = 'none';
                } else {
                    // Glass hoặc loại khác - không có filter
                    categoryContainer.style.display = 'none';
                    systemContainer.style.display = 'none';
                }
            }

            // Helper function để loại bỏ dấu tiếng Việt
            function removeVietnameseTones(str) {
                if (!str) return '';
                str = str.toLowerCase();
                str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g, "a");
                str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g, "e");
                str = str.replace(/ì|í|ị|ỉ|ĩ/g, "i");
                str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g, "o");
                str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g, "u");
                str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g, "y");
                str = str.replace(/đ/g, "d");
                return str;
            }

            // Filter materials đơn giản
            function filterMaterials() {
                if (!allInventoryDataForExport || allInventoryDataForExport.length === 0) {
                    return;
                }

                const searchInput = document.getElementById('materialSearchInput');
                if (!searchInput) return;

                const searchTerm = searchInput.value.trim().toLowerCase();
                let filtered = [...allInventoryDataForExport];

                if (searchTerm) {
                    filtered = filtered.filter(item => {
                        const code = (item.code || item.item_code || '').toLowerCase();
                        const name = (item.name || item.item_name || '').toLowerCase();
                        return code.includes(searchTerm) || name.includes(searchTerm);
                    });
                }

                inventoryDataForExport = filtered;
                displayInventoryTable(filtered);
            }

            // Filter materials đơn giản
            function filterMaterials() {
                const searchInput = document.getElementById('materialSearchInput');
                if (!searchInput) return;

                const searchTerm = searchInput.value.trim().toLowerCase();
                let filtered = [...allInventoryDataForExport];

                if (searchTerm) {
                    filtered = filtered.filter(item => {
                        const code = (item.code || item.item_code || '').toLowerCase();
                        const name = (item.name || item.item_name || '').toLowerCase();
                        return code.includes(searchTerm) || name.includes(searchTerm);
                    });
                }

                inventoryDataForExport = filtered;
                displayInventoryTable(filtered);
            }

            // Display inventory table
            function displayInventoryTable(data) {
                const tbody = document.getElementById('inventorySelectTable');

                if (!tbody) {
                    console.error('Không tìm thấy inventorySelectTable');
                    return;
                }

                if (data.length > 0) {
                    tbody.innerHTML = data.map(item => {
                        const name = item.name || item.item_name || '';
                        const code = item.code || item.item_code || '';
                        let unit = item.unit || 'cái';
                        const price = parseFloat(item.price || 0);
                        const stock = parseFloat(item.stock || 0);
                        const materialType = item.material_type || 'other';
                        const typeName = getTypeName(materialType);

                        // Đối với kính, đơn vị tồn kho luôn là "tấm" (không phải m²)
                        let stockUnit = unit;
                        if (materialType === 'glass') {
                            stockUnit = 'tấm';
                        }

                        // Escape HTML để tránh XSS
                        const escapeHtml = (str) => {
                            if (!str) return '';
                            const div = document.createElement('div');
                            div.textContent = str;
                            return div.innerHTML;
                        };

                        return `
                        <tr>
                            <td class="px-3 py-2">
                                <input type="checkbox" class="material-checkbox" data-id="${item.id}" data-type="${materialType}" 
                                       data-name="${escapeHtml(name)}" data-unit="${escapeHtml(unit)}" data-price="${price}"
                                       data-stock="${stock}" onchange="updateSelectedCount()">
                            </td>
                            <td class="px-3 py-2">
                                <div class="flex items-center gap-2">
                                    <span>${escapeHtml(name)}</span>
                                    <span class="px-2 py-0.5 text-xs rounded ${getTypeColorClass(materialType)}">${escapeHtml(typeName)}</span>
                                </div>
                            </td>
                            <td class="px-3 py-2">${stock} ${escapeHtml(stockUnit)}</td>
                            <td class="px-3 py-2">${formatCurrency(price)}</td>
                            <td class="px-3 py-2">
                                <input type="number" class="material-quantity w-20 px-2 py-1 border rounded text-center ${stock === 0 ? 'bg-red-100 border-red-300' : ''}" 
                                       data-id="${item.id}" 
                                       min="${materialType === 'glass' ? '1' : '0.01'}" 
                                       step="${materialType === 'glass' ? '1' : '0.01'}" 
                                       value="${stock === 0 ? 0 : (materialType === 'glass' ? 1 : 1)}" 
                                       max="${stock}"
                                       ${stock === 0 ? 'disabled title="Không có trong kho"' : ''}
                                       onchange="validateMaterialQuantity(this, ${stock}, '${escapeHtml(name)}')"
                                       onblur="validateMaterialQuantity(this, ${stock}, '${escapeHtml(name)}')">
                            </td>
                            <td class="px-3 py-2">
                                <input type="text" class="material-notes w-full px-2 py-1 border rounded" 
                                       data-id="${item.id}" placeholder="Ghi chú...">
                            </td>
                        </tr>
                    `;
                    }).join('');
                } else {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-3 py-8 text-center text-gray-500">
                            Không tìm thấy vật tư nào
                        </td>
                    </tr>`;
                }

                updateSelectedCount();
            }

            // Helper functions
            function getTypeName(type) {
                const names = {
                    'accessory': 'Phụ kiện',
                    'aluminum': 'Kho nhôm',
                    'glass': 'Kính',
                    'other': 'Vật tư phụ'
                };
                return names[type] || 'Khác';
            }

            function getTypeColorClass(type) {
                const colors = {
                    'accessory': 'bg-blue-100 text-blue-700',
                    'aluminum': 'bg-orange-100 text-orange-700',
                    'glass': 'bg-green-100 text-green-700',
                    'other': 'bg-purple-100 text-purple-700'
                };
                return colors[type] || 'bg-gray-100 text-gray-700';
            }

            // Toggle select all
            function toggleSelectAllMaterials() {
                const selectAll = document.getElementById('selectAllMaterials').checked;
                document.querySelectorAll('.material-checkbox').forEach(cb => cb.checked = selectAll);
                updateSelectedCount();
            }

            function updateSelectedCount() {
                const count = document.querySelectorAll('.material-checkbox:checked').length;
                document.getElementById('selectedMaterialsCount').textContent = `Đã chọn: ${count} vật tư`;
            }

            // Xác nhận xuất vật tư (chuyển trạng thái dự án từ Bóc tách sang Sản xuất)
            async function confirmMaterialExport() {
                if (!selectedProjectId) {
                    alert('Vui lòng chọn dự án trước');
                    return;
                }

                // Kiểm tra điều kiện xuất vật tư
                try {
                    const checkResponse = await fetch(`${API_BASE}/project-materials/check-export-requirement/${selectedProjectId}`);

                    // Kiểm tra response status trước khi parse JSON
                    if (!checkResponse.ok) {
                        const errorText = await checkResponse.text();
                        console.error('API error response:', errorText);
                        console.error('Status:', checkResponse.status, checkResponse.statusText);
                        alert(`Lỗi API(${checkResponse.status}): Không thể kiểm tra điều kiện xuất vật tư.Vui lòng thử lại.`);
                        return;
                    }

                    const checkResult = await checkResponse.json();

                    if (!checkResult.success) {
                        alert('Lỗi: ' + (checkResult.message || 'Không thể kiểm tra điều kiện xuất vật tư'));
                        return;
                    }

                    const { has_exported_materials, needs_material_export, message } = checkResult.data;

                    // Kiểm tra xem đã có vật tư được xuất chưa
                    if (!has_exported_materials) {
                        alert('Chưa có vật tư nào được xuất. Vui lòng thêm vật tư trước khi xác nhận xuất.');
                        return;
                    }

                    // Nếu không cần xuất vật tư (đã ở giai đoạn khác), chỉ thông báo
                    if (!needs_material_export) {
                        alert('Dự án không ở giai đoạn Bóc tách. Không cần xác nhận xuất.');
                        return;
                    }

                    // =====================================================================
                    // KIỂM TRA TỒN KHO: Chỉ cho phép xuất vật tư đủ kho
                    // =====================================================================
                    try {
                        const stockCheckResponse = await fetch(`${API_BASE}/project-materials/${selectedProjectId}`);
                        if (stockCheckResponse.ok) {
                            const stockCheckResult = await stockCheckResponse.json();
                            if (stockCheckResult.success && stockCheckResult.data) {
                                // Kiểm tra vật tư chưa đủ (thiếu kho)
                                const insufficientMaterials = stockCheckResult.insufficient || [];

                                if (insufficientMaterials.length > 0) {
                                    const insufficientList = insufficientMaterials.map(m => {
                                        const required = parseFloat(m.quantity) || 0;
                                        const available = parseFloat(m.available_stock) || 0;
                                        const shortage = parseFloat(m.shortage) || 0;
                                        const statusNote = m.stock_note || m.stock_status || '';
                                        return `• ${m.material_name}: Cần ${required} ${m.unit || 'đv'}, Kho: ${available} ${m.unit || 'đv'}, Thiếu: ${shortage} ${m.unit || 'đv'} - ${statusNote}`;
                                    }).join('\n');

                                    alert(
                                        `❌ KHÔNG THỂ XÁC NHẬN XUẤT!\n\n` +
                                        `Có ${insufficientMaterials.length} vật tư CHƯA ĐỦ KHO:\n\n` +
                                        insufficientList + '\n\n' +
                                        `⚠️ Vui lòng bổ sung vật tư vào kho trước khi xác nhận xuất.\n` +
                                        `Chỉ có thể xuất các vật tư đã đủ kho (trong tab "Vật tư đã xuất").`
                                    );
                                    return;
                                }

                                // Kiểm tra xem có vật tư đã xuất (đủ kho) không
                                const exportedMaterials = stockCheckResult.exported || [];
                                if (exportedMaterials.length === 0) {
                                    alert('❌ Không có vật tư nào đủ kho để xuất. Vui lòng kiểm tra lại tồn kho.');
                                    return;
                                }
                            }
                        }
                    } catch (stockError) {
                        console.warn('Could not check stock levels:', stockError);
                        alert('⚠️ Không thể kiểm tra tồn kho. Vui lòng thử lại.');
                        return;
                    }

                    // Xác nhận với người dùng
                    if (!confirm('Xác nhận xuất vật tư và chuyển dự án sang giai đoạn Sản xuất?')) {
                        return;
                    }

                    // Gọi API để xác nhận xuất (tự động chuyển trạng thái)
                    const response = await fetch(`${API_BASE}/project-materials/confirm-export/${selectedProjectId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    // Kiểm tra response status trước khi parse JSON
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API error response:', errorText);
                        console.error('Status:', response.status, response.statusText);
                        alert(`Lỗi API (${response.status}): Không thể xác nhận xuất vật tư. Vui lòng thử lại.`);
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Xác nhận xuất vật tư thành công!', 'Dự án đã chuyển sang giai đoạn Sản xuất.');
                        loadProjectMaterials();
                        // Reload danh sách dự án để cập nhật trạng thái
                        loadProjectsForExport();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể xác nhận xuất vật tư'));
                    }
                } catch (error) {
                    console.error('Lỗi xác nhận xuất vật tư:', error);
                    alert('Lỗi khi xác nhận xuất vật tư: ' + error.message);
                }
            }

            // Thêm vật tư đã chọn vào dự án (với kiểm tra tồn kho)
            async function addSelectedMaterials() {
                const checkedItems = document.querySelectorAll('.material-checkbox:checked');

                if (checkedItems.length === 0) {
                    alert('Vui lòng chọn ít nhất 1 vật tư');
                    return;
                }

                const materials = [];
                const insufficientItems = [];

                // Kiểm tra tồn kho và lấy giá từ kho cho mỗi vật tư
                for (const cb of checkedItems) {
                    const id = cb.dataset.id;
                    const materialType = cb.dataset.type;
                    const materialName = cb.dataset.name;
                    const requestedQty = parseFloat(document.querySelector(`.material-quantity[data-id="${id}"]`).value) || 1;
                    const availableStock = parseFloat(cb.dataset.stock) || 0;
                    const notes = document.querySelector(`.material-notes[data-id="${id}"]`).value;

                    // Kiểm tra tồn kho - CHẶN NẾU KHÔNG ĐỦ
                    if (availableStock === 0) {
                        insufficientItems.push({
                            name: materialName,
                            required: requestedQty,
                            available: 0,
                            shortage: requestedQty,
                            unit: cb.dataset.unit,
                            reason: 'không_có' // Không có trong kho
                        });
                        continue; // Bỏ qua vật tư không có trong kho
                    }

                    if (requestedQty > availableStock) {
                        insufficientItems.push({
                            name: materialName,
                            required: requestedQty,
                            available: availableStock,
                            shortage: requestedQty - availableStock,
                            unit: cb.dataset.unit,
                            reason: 'không_đủ' // Không đủ số lượng
                        });
                        continue; // Bỏ qua vật tư thiếu kho
                    }

                    // Chỉ cho phép nếu: requestedQty > 0 && requestedQty <= availableStock && availableStock > 0
                    if (requestedQty <= 0) {
                        continue; // Bỏ qua nếu số lượng <= 0
                    }

                    // Luôn lấy giá từ kho (ưu tiên giá mới nhất)
                    let unitPrice = 0;
                    try {
                        if (materialType === 'accessory') {
                            const accResponse = await fetch(`${API_BASE}/accessories/${id}`);
                            const accResult = await accResponse.json();
                            if (accResult.success && accResult.data) {
                                unitPrice = parseFloat(accResult.data.sale_price || accResult.data.purchase_price || 0);
                            }
                        } else if (materialType === 'aluminum') {
                            const alumResponse = await fetch(`${API_BASE}/aluminum-systems/${id}`);
                            const alumResult = await alumResponse.json();
                            if (alumResult.success && alumResult.data) {
                                unitPrice = parseFloat(alumResult.data.unit_price || 0);
                            }
                        } else {
                            const invResponse = await fetch(`${API_BASE}/inventory/${id}`);
                            const invResult = await invResponse.json();
                            if (invResult.success && invResult.data) {
                                unitPrice = parseFloat(invResult.data.unit_price || 0);
                            }
                        }
                    } catch (err) {
                        console.warn(`Could not fetch price for ${materialName}:`, err);
                        // Fallback: dùng giá từ dataset nếu có
                        unitPrice = parseFloat(cb.dataset.price) || 0;
                    }

                    // Nếu vẫn không có giá, cảnh báo
                    if (unitPrice === 0) {
                        console.warn(`⚠️ Vật tư "${materialName}" không có giá trong kho. Sẽ lưu với giá = 0.`);
                    }

                    materials.push({
                        material_type: materialType,
                        material_id: parseInt(id),
                        material_name: materialName,
                        quantity: requestedQty,
                        unit: cb.dataset.unit,
                        unit_price: unitPrice,
                        notes: notes || ''
                    });
                }

                // Cảnh báo nếu có vật tư thiếu kho
                if (insufficientItems.length > 0) {
                    const insufficientList = insufficientItems.map(item => {
                        if (item.reason === 'không_có') {
                            return `• ${item.name}: Cần ${item.required} ${item.unit}, Kho: 0 ${item.unit} - ❌ KHÔNG CÓ ĐỂ XUẤT`;
                        } else {
                            return `• ${item.name}: Cần ${item.required} ${item.unit}, Kho: ${item.available} ${item.unit}, Thiếu: ${item.shortage} ${item.unit} - ⚠️ KHÔNG ĐỦ`;
                        }
                    }).join('\n');

                    const noStockCount = insufficientItems.filter(item => item.reason === 'không_có').length;
                    const insufficientCount = insufficientItems.filter(item => item.reason === 'không_đủ').length;

                    let message = `❌ KHÔNG THỂ THÊM VẬT TƯ!\n\n`;
                    if (noStockCount > 0) {
                        message += `Có ${noStockCount} vật tư KHÔNG CÓ trong kho:\n`;
                    }
                    if (insufficientCount > 0) {
                        message += `Có ${insufficientCount} vật tư KHÔNG ĐỦ số lượng:\n`;
                    }
                    message += `\n${insufficientList}\n\n`;
                    message += `Các vật tư này sẽ KHÔNG được thêm vào dự án.\n`;
                    message += `Vui lòng bổ sung vào kho trước khi thêm.`;

                    alert(message);
                }

                // Chỉ thêm vật tư đủ kho
                if (materials.length === 0) {
                    if (insufficientItems.length > 0) {
                        // Đã hiển thị cảnh báo ở trên, không cần hiển thị lại
                        return;
                    }
                    alert('❌ Không có vật tư nào đủ kho để thêm vào dự án.');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/project-materials`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ project_id: selectedProjectId, materials })
                    });

                    const result = await response.json();

                    if (result.success) {
                        const message = insufficientItems.length > 0
                            ? `✅ Đã thêm ${materials.length} vật tư vào dự án.\n\n⚠️ Lưu ý: ${insufficientItems.length} vật tư thiếu kho đã được bỏ qua (đã cảnh báo ở trên).`
                            : `✅ ${result.message}`;
                        alert(message);
                        closeAddMaterialModal();
                        loadProjectMaterials();
                        loadInventorySummary(); // Cập nhật lại tồn kho
                    } else {
                        // Backend đã kiểm tra và trả về lỗi chi tiết
                        if (result.insufficient_materials && result.insufficient_materials.length > 0) {
                            // Hiển thị lỗi chi tiết từ backend (backend đã kiểm tra lại và chặn)
                            alert(result.message);
                        } else {
                            alert('❌ Lỗi: ' + result.message);
                        }
                    }
                } catch (error) {
                    console.error('Lỗi thêm vật tư:', error);
                    alert('❌ Lỗi khi thêm vật tư: ' + error.message);
                }
            }

            // Validate số lượng vật tư khi người dùng nhập
            function validateMaterialQuantity(input, maxStock, materialName) {
                const value = parseFloat(input.value) || 0;

                if (value <= 0) {
                    alert(`⚠️ Số lượng phải lớn hơn 0!`);
                    input.value = 1;
                    input.focus();
                    return false;
                }

                if (maxStock === 0) {
                    alert(`❌ "${materialName}" KHÔNG CÓ trong kho (tồn kho = 0)!\n\nVui lòng bổ sung vào kho trước khi thêm.`);
                    input.value = 0;
                    input.focus();
                    return false;
                }

                if (value > maxStock) {
                    alert(`⚠️ "${materialName}" KHÔNG ĐỦ!\n\nCần: ${value}\nKho có: ${maxStock}\nThiếu: ${value - maxStock}\n\nVui lòng giảm số lượng hoặc bổ sung vào kho.`);
                    input.value = maxStock;
                    input.focus();
                    return false;
                }

                return true;
            }

            // Sửa vật tư
            function openEditMaterial(id, name, quantity, notes) {
                document.getElementById('editMaterialId').value = id;
                document.getElementById('editMaterialName').value = name;
                document.getElementById('editMaterialQuantity').value = quantity;
                document.getElementById('editMaterialNotes').value = notes;
                document.getElementById('editMaterialModal').classList.remove('hidden');
            }

            function openEditMaterial(id, name, quantity, notes) {
                try {
                    const modal = document.getElementById('editMaterialModal');
                    if (!modal) {
                        console.error('Modal editMaterialModal not found');
                        alert('Không tìm thấy form chỉnh sửa. Vui lòng tải lại trang.');
                        return;
                    }

                    document.getElementById('editMaterialId').value = id || '';
                    document.getElementById('editMaterialName').value = name || '';
                    document.getElementById('editMaterialQuantity').value = quantity || 0;
                    document.getElementById('editMaterialNotes').value = notes || '';
                    modal.classList.remove('hidden');
                } catch (error) {
                    console.error('Error opening edit modal:', error);
                    alert('Lỗi khi mở form chỉnh sửa: ' + error.message);
                }
            }

            function closeEditMaterialModal() {
                document.getElementById('editMaterialModal').classList.add('hidden');
            }

            async function saveEditMaterial(e) {
                e.preventDefault();

                const id = document.getElementById('editMaterialId').value;
                const quantityInput = document.getElementById('editMaterialQuantity').value;
                const notes = document.getElementById('editMaterialNotes').value || '';

                // Validate quantity
                const quantity = parseFloat(quantityInput);
                if (isNaN(quantity) || quantity <= 0) {
                    alert('Vui lòng nhập số lượng hợp lệ (lớn hơn 0)');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/project-materials/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            quantity: quantity,
                            notes: notes
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API error:', errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Cập nhật thành công');
                        closeEditMaterialModal();
                        loadProjectMaterials();
                        loadInventorySummary();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể cập nhật'));
                    }
                } catch (error) {
                    console.error('Lỗi cập nhật:', error);
                    alert('Lỗi khi cập nhật: ' + error.message);
                }
            }

            // Xóa vật tư
            async function deleteProjectMaterial(id, name) {
                if (!confirm(`Bạn có chắc muốn xóa "${name}" khỏi dự án?\nSố lượng sẽ được hoàn lại vào kho.`)) {
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/project-materials/${id}`, { method: 'DELETE' });
                    const result = await response.json();

                    if (result.success) {
                        alert(result.message);
                        loadProjectMaterials();
                        loadInventorySummary();
                    } else {
                        alert('Lỗi: ' + result.message);
                    }
                } catch (error) {
                    console.error('Lỗi xóa:', error);
                    alert('Lỗi khi xóa');
                }
            }

            // Helper functions
            function getTypeName(type) {
                const names = { accessory: 'Phụ kiện', aluminum: 'Hệ nhôm', glass: 'Kính', other: 'Khác' };
                return names[type] || type;
            }

            function getTypeColor(type) {
                const colors = {
                    accessory: 'bg-blue-100 text-blue-800',
                    aluminum: 'bg-green-100 text-green-800',
                    glass: 'bg-purple-100 text-purple-800',
                    other: 'bg-gray-100 text-gray-800'
                };
                return colors[type] || 'bg-gray-100 text-gray-800';
            }
            // ==================== END XUẤT VẬT TƯ ====================


            // Check authentication
            function checkAuth() {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            }

            // Load sidebar user info
            async function loadSidebarUserInfo() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        return;
                    }

                    const response = await fetch(`${API_BASE}/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        const user = result.data;
                        const sidebarUserNameEl = document.getElementById('sidebarUserName');
                        if (sidebarUserNameEl) {
                            sidebarUserNameEl.textContent = user.full_name || 'User';
                        }

                        // Hiển thị avatar sidebar
                        const avatarInitial = document.getElementById('sidebarUserAvatarInitial');
                        const avatarImage = document.getElementById('sidebarUserAvatarImage');

                        if (avatarInitial && avatarImage) {
                            if (user.avatar_url) {
                                avatarImage.src = user.avatar_url;
                                avatarImage.classList.remove('hidden');
                                avatarInitial.classList.add('hidden');
                            } else {
                                const initial = (user.full_name || 'U').charAt(0).toUpperCase();
                                avatarInitial.textContent = initial;
                                avatarInitial.classList.remove('hidden');
                                avatarImage.classList.add('hidden');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Lỗi load sidebar user info:', error);
                }
            }

            // Load header user info
            async function loadHeaderUserInfo() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        return;
                    }

                    const response = await fetch(`${API_BASE}/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        const user = result.data;

                        // Hiển thị avatar header
                        const avatarInitial = document.getElementById('headerUserAvatarInitial');
                        const avatarImage = document.getElementById('headerUserAvatarImage');

                        if (avatarInitial && avatarImage) {
                            if (user.avatar_url) {
                                avatarImage.src = user.avatar_url;
                                avatarImage.classList.remove('hidden');
                                avatarInitial.classList.add('hidden');
                            } else {
                                const initial = (user.full_name || 'U').charAt(0).toUpperCase();
                                avatarInitial.textContent = initial;
                                avatarInitial.classList.remove('hidden');
                                avatarImage.classList.add('hidden');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Lỗi load header user info:', error);
                }
            }

            // Toggle notifications dropdown
            function toggleNotifications() {
                const dropdown = document.getElementById('notificationsDropdown');
                dropdown.classList.toggle('hidden');
                if (!dropdown.classList.contains('hidden')) {
                    loadNotifications();
                }
            }

            // Toggle sidebar user menu dropdown
            function toggleSidebarUserMenu() {
                const dropdown = document.getElementById('sidebarUserMenuDropdown');
                if (dropdown) {
                    dropdown.classList.toggle('hidden');
                }
            }

            // Toggle header user menu dropdown
            function toggleHeaderUserMenu() {
                const dropdown = document.getElementById('headerUserMenuDropdown');
                if (dropdown) {
                    dropdown.classList.toggle('hidden');
                }
            }

            // Load notifications
            async function loadNotifications() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    const response = await fetch(`${API_BASE}/notifications`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        displayNotifications(result.data || []);
                        loadUnreadCount();
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            // Load unread count
            async function loadUnreadCount() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    const response = await fetch(`${API_BASE}/notifications/unread`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        const count = result.data.count || 0;
                        const badge = document.getElementById('notificationBadge');
                        if (badge) {
                            if (count > 0) {
                                badge.textContent = count > 99 ? '99+' : count;
                                badge.classList.remove('hidden');
                            } else {
                                badge.classList.add('hidden');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            // Display notifications
            function displayNotifications(notifications) {
                const container = document.getElementById('notificationsList');

                if (notifications.length === 0) {
                    container.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <p>Không có thông báo nào</p>
                    </div>
                `;
                    return;
                }

                container.innerHTML = notifications.slice(0, 10).map(notif => {
                    const typeIcons = {
                        'info': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-blue-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                        'success': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-green-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                        'warning': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-yellow-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>',
                        'error': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-red-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                    };

                    return `
                    <div class="p-4 border-b border-gray-200 hover:bg-gray-50 cursor-pointer ${notif.is_read ? '' : 'bg-blue-50'}" 
                         onclick="markNotificationRead(${notif.id})">
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0 mt-1">
                                ${typeIcons[notif.type] || typeIcons.info}
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-sm ${notif.is_read ? 'text-gray-700' : 'text-gray-900'}">${notif.title}</h4>
                                <p class="text-sm text-gray-600 mt-1">${notif.message}</p>
                                <p class="text-xs text-gray-400 mt-1">${formatTime(notif.created_at)}</p>
                            </div>
                            ${!notif.is_read ? '<div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>' : ''}
                        </div>
                    </div>
                `;
                }).join('');
            }

            // Mark notification as read
            async function markNotificationRead(id) {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    const response = await fetch(`${API_BASE}/notifications/${id}/read`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        loadNotifications();
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            // Handle logout (shared function)
            function handleLogout() {
                if (confirm('Bạn có chắc muốn đăng xuất?')) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                }
            }

            // Format time
            function formatTime(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return 'Vừa xong';
                if (minutes < 60) return `${minutes} phút trước`;
                if (hours < 24) return `${hours} giờ trước`;
                if (days < 7) return `${days} ngày trước`;
                return date.toLocaleDateString('vi-VN');
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', function (event) {
                const notificationsDropdown = document.getElementById('notificationsDropdown');
                const sidebarUserMenuDropdown = document.getElementById('sidebarUserMenuDropdown');
                const headerUserMenuDropdown = document.getElementById('headerUserMenuDropdown');
                const notificationsButton = event.target.closest('[onclick="toggleNotifications()"]');
                const sidebarUserMenuButton = event.target.closest('[onclick="toggleSidebarUserMenu()"]');
                const headerUserMenuButton = event.target.closest('[onclick="toggleHeaderUserMenu()"]');

                if (!notificationsButton && notificationsDropdown && !notificationsDropdown.contains(event.target)) {
                    notificationsDropdown.classList.add('hidden');
                }

                if (!sidebarUserMenuButton && sidebarUserMenuDropdown && !sidebarUserMenuDropdown.contains(event.target)) {
                    sidebarUserMenuDropdown.classList.add('hidden');
                }

                if (!headerUserMenuButton && headerUserMenuDropdown && !headerUserMenuDropdown.contains(event.target)) {
                    headerUserMenuDropdown.classList.add('hidden');
                }
            });

            // Tab switching - Make it global for onclick handlers
            window.switchTab = function (tabName, buttonElement) {
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Check if elements exist
                const tabContent = document.getElementById('tab-' + tabName);
                if (!tabContent) {
                    console.error('Tab content not found:', 'tab-' + tabName);
                    return;
                }

                tabContent.classList.add('active');
                if (buttonElement) {
                    buttonElement.classList.add('active');
                }

                // Load data when switching tabs
                if (tabName === 'accessory') {
                    loadAccessories();
                } else if (tabName === 'aluminum') {
                    loadAluminumSystems();
                } else if (tabName === 'glass') {
                    loadGlassItems();
                } else if (tabName === 'other') {
                    // Initialize sub-tab when switching to other tab
                    if (currentSubTab) {
                        const subTabButtons = document.querySelectorAll('.sub-tab-button');
                        subTabButtons.forEach(btn => {
                            btn.classList.remove('active');
                            const onclick = btn.getAttribute('onclick');
                            if (onclick && onclick.includes(`'${currentSubTab}'`)) {
                                btn.classList.add('active');
                            }
                        });
                        // Update title
                        const titles = {
                            'ke': 'Danh sách vật tư phụ - Ke',
                            'gioang': 'Danh sách vật tư phụ - Gioăng',
                            'nhua-op': 'Danh sách vật tư phụ - Nhựa ốp',
                            'keo': 'Danh sách vật tư phụ - Keo',
                            'khac': 'Danh sách vật tư phụ - Khác'
                        };
                        const titleEl = document.getElementById('otherSubTabTitle');
                        if (titleEl) {
                            titleEl.textContent = titles[currentSubTab] || 'Danh sách vật tư phụ';
                        }
                    }
                    loadOtherItems();
                } else if (tabName === 'transactions') {
                    loadTransactions();
                } else if (tabName === 'scraps') {
                    loadScraps();
                }

                // Luôn cập nhật stats tổng hợp khi chuyển tab
                loadStats();

                // Reset sub-tab khi chuyển tab khác
                if (tabName !== 'other') {
                    currentSubTab = 'ke';
                }
            }

            // Sub-tab switching for Vật tư phụ
            function switchSubTab(subTabName, buttonElement) {
                currentSubTab = subTabName;

                // Update sub-tab buttons
                document.querySelectorAll('.sub-tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (buttonElement) {
                    buttonElement.classList.add('active');
                }

                // Update title
                const titles = {
                    'ke': 'Danh sách vật tư phụ - Ke',
                    'gioang': 'Danh sách vật tư phụ - Gioăng',
                    'nhua-op': 'Danh sách vật tư phụ - Nhựa ốp',
                    'keo': 'Danh sách vật tư phụ - Keo',
                    'khac': 'Danh sách vật tư phụ - Khác'
                };
                const titleEl = document.getElementById('otherSubTabTitle');
                if (titleEl) {
                    titleEl.textContent = titles[subTabName] || 'Danh sách vật tư phụ';
                }

                // Reload items with sub-category filter
                loadOtherItems();
            }

            // Lưu tất cả dữ liệu để tính KPI và filter
            let allInventoryData = []; // Lưu tất cả dữ liệu để tính KPI

            // Sub-tab cho Vật tư phụ
            let currentSubTab = 'ke'; // Mặc định là 'ke'

            function displayInventory(items) {
                // Map module_type từ API tổng hợp
                items = items.map(item => {
                    // Đảm bảo có các trường cần thiết
                    if (!item.stock_quantity && item.quantity !== undefined) {
                        item.stock_quantity = item.quantity;
                    }
                    if (!item.item_type && item.module_type) {
                        item.item_type = item.module_type;
                    }
                    return item;
                });
                const tbody = document.getElementById('inventoryTable');
                tbody.innerHTML = '';

                // Lọc theo filter hiện tại
                let filtered = items;
                if (currentFilter === 'accessory') {
                    // Lọc chỉ phụ kiện
                    filtered = items.filter(item => item.module_type === 'accessory' || item.is_accessory === true);
                } else if (currentFilter === 'aluminum') {
                    // Lọc chỉ hệ nhôm
                    filtered = items.filter(item => item.module_type === 'aluminum' || item.is_aluminum === true);
                } else if (currentFilter === 'glass') {
                    // Lọc chỉ kính
                    filtered = items.filter(item => item.module_type === 'glass' || item.item_type === 'glass');
                } else if (currentFilter === 'other') {
                    // Lọc chỉ khác
                    filtered = items.filter(item => item.module_type === 'other' || (item.item_type === 'other' && !item.is_accessory && !item.is_aluminum));
                } else if (currentFilter === 'low-stock') {
                    // Lọc chỉ cảnh báo
                    filtered = items.filter(item => {
                        const stockQty = parseFloat(item.stock_quantity || item.quantity || 0);
                        const minStock = parseFloat(item.min_stock_level || 0);
                        return stockQty < minStock;
                    });
                }

                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu</td></tr>';
                    return;
                }

                filtered.forEach(item => {
                    // Parse sang number để so sánh chính xác
                    const stockQty = parseFloat(item.stock_quantity) || 0;
                    const minStock = parseFloat(item.min_stock_level) || 0;
                    const isLowStock = stockQty < minStock;
                    const unitPrice = parseFloat(item.unit_price) || 0;
                    const value = stockQty * unitPrice;

                    // Hiển thị category cho phụ kiện hoặc brand cho hệ nhôm
                    let typeLabel = '';
                    const moduleType = item.module_type || item.item_type;
                    if ((item.module_type === 'accessory' || item.is_accessory) && item.category) {
                        typeLabel = `${item.module_name || 'Phụ kiện'} - ${item.category}`;
                    } else if ((item.module_type === 'aluminum' || item.is_aluminum) && item.brand) {
                        typeLabel = `${item.module_name || 'Kho nhôm'} - ${item.brand || ''}`;
                    } else {
                        typeLabel = item.module_name || getItemTypeLabel(moduleType);
                    }

                    const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium">
                            ${item.item_name || item.item_code}
                            ${item.module_type === 'accessory' || item.is_accessory ? '<span class="ml-2 text-xs text-purple-600">(PK)</span>' : ''}
                            ${item.module_type === 'aluminum' || item.is_aluminum ? '<span class="ml-2 text-xs text-blue-600">(Kho nhôm)</span>' : ''}
                            ${item.module_type === 'glass' ? '<span class="ml-2 text-xs text-cyan-600">(Kính)</span>' : ''}
                            ${item.module_type === 'other' ? '<span class="ml-2 text-xs text-gray-600">(Khác)</span>' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm">${typeLabel}</td>
                        <td class="px-4 py-3 text-sm ${isLowStock ? 'text-red-600 font-semibold' : 'text-gray-700'}">
                            ${stockQty.toLocaleString('vi-VN', { minimumFractionDigits: 0, maximumFractionDigits: 2 })} ${item.unit || ''}
                            ${isLowStock ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4 inline ml-1 text-red-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm">${Math.round(minStock)} ${item.unit || ''}</td>
                        <td class="px-4 py-3 text-sm">${formatCurrency(unitPrice)}</td>
                        <td class="px-4 py-3 text-sm font-semibold">${formatCurrency(value)}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs ${isLowStock ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                ${isLowStock ? 'Cảnh báo' : 'Bình thường'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex gap-2">
                                ${item.module_type === 'accessory'
                            ? `<button onclick="switchTab('accessory', null); setTimeout(() => { openAccessoryModal(${item.id}); }, 100);" class="text-blue-600 hover:text-blue-800" title="Quản lý phụ kiện">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                    </button>`
                            : item.module_type === 'aluminum'
                                ? `<button onclick="switchTab('aluminum', null); setTimeout(() => { loadAluminumForEdit(${item.id}); }, 100);" class="text-blue-600 hover:text-blue-800" title="Quản lý hệ nhôm">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                        </svg>
                                    </button>`
                                : `<span class="text-gray-400 text-xs">Xem trong tab ${item.module_name || 'tương ứng'}</span>`
                        }
                            </div>
                        </td>
                    </tr>
                `;
                    tbody.innerHTML += row;
                });
            }

            function filterInventory(type) {
                currentFilter = type;

                // Update button styles
                document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                    btn.classList.remove('bg-teal-500', 'text-white');
                    btn.classList.add('bg-white', 'border', 'border-gray-300');
                });
                document.getElementById('filter-' + type).classList.remove('bg-white', 'border', 'border-gray-300');
                document.getElementById('filter-' + type).classList.add('bg-teal-500', 'text-white');

                // Sử dụng dữ liệu đã load để filter, không cần load lại
                if (allInventoryData.length > 0) {
                    displayInventory(allInventoryData);
                    updateInventoryStats(allInventoryData);
                } else {
                    loadInventory();
                }
            }

            async function loadInventory() {
                try {
                    // Sử dụng API tổng hợp mới
                    const response = await fetch(`${API_BASE}/inventory/aggregated`);
                    const result = await response.json();

                    if (result.success) {
                        allInventoryData = result.data || [];
                        displayInventory(allInventoryData);
                        // Load stats riêng
                        loadStats();
                    } else {
                        console.error('Lỗi load inventory:', result.message);
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            async function loadStats() {
                try {
                    // Kiểm tra xem có đang ở trang inventory không
                    const statTotalItemsEl = document.getElementById('statTotalItems');
                    if (!statTotalItemsEl) {
                        // Không phải trang inventory, không cần load stats
                        return;
                    }

                    const response = await fetch(`${API_BASE}/inventory/stats`);
                    const result = await response.json();

                    console.log('Stats response:', result); // Debug

                    if (result.success && result.data) {
                        const stats = result.data;
                        const totalItems = parseInt(stats.total_items || 0);
                        const lowStock = parseInt(stats.low_stock || 0);
                        const totalValue = parseFloat(stats.total_value || 0);

                        console.log('Stats data:', { totalItems, lowStock, totalValue }); // Debug

                        // Kiểm tra elements tồn tại trước khi truy cập
                        const statLowStockEl = document.getElementById('statLowStock');
                        const statInventoryValueEl = document.getElementById('statInventoryValue');

                        if (statTotalItemsEl) {
                            statTotalItemsEl.textContent = totalItems;
                        }
                        if (statLowStockEl) {
                            statLowStockEl.textContent = lowStock;
                        }

                        // Format giá trị tồn kho
                        if (statInventoryValueEl) {
                            if (totalValue >= 1000000) {
                                statInventoryValueEl.textContent = (totalValue / 1000000).toFixed(1) + 'M';
                            } else if (totalValue >= 1000) {
                                statInventoryValueEl.textContent = (totalValue / 1000).toFixed(0) + 'K';
                            } else {
                                statInventoryValueEl.textContent = totalValue.toLocaleString('vi-VN');
                            }
                        }
                    } else {
                        console.error('Stats API error:', result.message || 'Unknown error');
                    }
                } catch (error) {
                    console.error('Lỗi load stats:', error);
                }
            }

            async function viewLowStockItems() {
                try {
                    const response = await fetch(`${API_BASE}/inventory/low-stock`);
                    const result = await response.json();

                    if (result.success) {
                        // Lọc để chỉ hiển thị các item cảnh báo
                        allInventoryData = result.data || [];
                        currentFilter = 'low-stock';
                        displayInventory(allInventoryData);

                        // Cập nhật filter button
                        document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                            btn.classList.remove('bg-teal-500', 'text-white');
                            btn.classList.add('bg-white', 'border', 'border-gray-300');
                        });
                    }
                } catch (error) {
                    console.error('Lỗi load low stock items:', error);
                }
            }

            function updateInventoryStats(items) {
                // Không cần tính toán nữa, đã có API tổng hợp
                // Chỉ cần load stats từ API
                loadStats();
            }

            // Hàm mở trang chỉnh sửa phụ kiện
            function editAccessoryFromInventory(id) {
                // Mở modal chỉnh sửa phụ kiện
                openAccessoryModal(id);
            }

            // Hàm xem chi tiết vật tư
            function viewInventoryItem(id, isAccessory) {
                if (isAccessory) {
                    // Xem chi tiết phụ kiện - mở modal
                    openAccessoryModal(id);
                } else {
                    // Xem chi tiết vật tư thông thường
                    // Có thể mở modal hoặc chuyển trang
                    alert('Xem chi tiết vật tư ID: ' + id);
                }
            }


            let allTransactions = []; // Lưu tất cả transactions để search

            function displayTransactions(transactions) {
                const tbody = document.getElementById('transactionsTable');
                if (!tbody) {
                    console.warn('transactionsTable element not found. Tab may not be active.');
                    return;
                }
                tbody.innerHTML = '';

                // Chỉ hiển thị giao dịch xuất kho
                let filtered = transactions.filter(t => t.transaction_type === 'export');

                // Áp dụng search filter nếu có
                const searchTerm = document.getElementById('transactionSearch')?.value?.toLowerCase() || '';
                if (searchTerm) {
                    filtered = filtered.filter(trans => {
                        const itemName = (trans.item_name || '').toLowerCase();
                        const projectCode = (trans.project_code || '').toLowerCase();
                        const projectName = (trans.project_name || '').toLowerCase();
                        const notes = (trans.notes || '').toLowerCase();
                        return itemName.includes(searchTerm) ||
                            projectCode.includes(searchTerm) ||
                            projectName.includes(searchTerm) ||
                            notes.includes(searchTerm);
                    });
                }

                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Chưa có giao dịch nào</td></tr>';
                    return;
                }

                filtered.forEach(trans => {
                    // Debug log - chỉ log khi có project_id nhưng không có project data
                    if (trans.project_id && !trans.project_code && !trans.project_name) {
                        console.warn('⚠️ Transaction has project_id but no project data:', {
                            transaction_id: trans.id,
                            project_id: trans.project_id,
                            project_code: trans.project_code,
                            project_name: trans.project_name,
                            note: 'Project may have been deleted or project_id is invalid'
                        });
                    }

                    // Hiển thị dự án: chỉ hiển thị tên dự án
                    let projectDisplay = '<span class="text-gray-400">-</span>';

                    // Kiểm tra và hiển thị project_name
                    if (trans.project_name) {
                        const projectName = trans.project_name.toString().trim();
                        if (projectName !== '') {
                            projectDisplay = projectName;
                        }
                    }
                    // Nếu không có project_name hoặc project_name rỗng, hiển thị "-"

                    const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium">${trans.item_name || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs bg-red-100 text-red-700">
                                Xuất kho
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">${projectDisplay}</td>
                        <td class="px-4 py-3 text-sm">${Math.round(trans.quantity)} ${trans.unit || ''}</td>
                        <td class="px-4 py-3 text-sm">${trans.notes || '-'}</td>
                        <td class="px-4 py-3 text-sm">${formatDateTime(trans.transaction_date)}</td>
                    </tr>
                `;
                    tbody.innerHTML += row;
                });
            }

            function searchTransactions() {
                // Sử dụng dữ liệu đã load để search, không cần load lại
                if (allTransactions.length > 0) {
                    displayTransactions(allTransactions);
                } else {
                    loadTransactions();
                }
            }

            function filterTransactions(type) {
                // Chỉ hỗ trợ xuất kho
                currentTransFilter = 'export';
                loadTransactions();
            }

            // Load Scraps
            async function loadScraps() {
                try {
                    const response = await fetch(`${API_BASE}/inventory/scraps`);
                    const result = await response.json();

                    if (result.success) {
                        displayScraps(result.data || []);
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            function displayScraps(scraps) {
                const container = document.getElementById('scrapsList');
                container.innerHTML = '';

                const filtered = showUsedScraps
                    ? scraps
                    : scraps.filter(s => !s.is_used);

                document.getElementById('scrapsCount').textContent = `Tổng: ${filtered.length} đoạn nhôm thừa`;

                if (filtered.length === 0) {
                    container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-16 h-16 mb-4">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" />
                        </svg>
                        <p>Chưa có nhôm thừa ${showUsedScraps ? 'đã sử dụng' : 'chưa sử dụng'}</p>
                    </div>
                `;
                    return;
                }

                filtered.forEach(scrap => {
                    const card = `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold">${scrap.profile_name || 'Nhôm thừa'}</h4>
                            <p class="text-sm text-gray-600">Chiều dài: ${scrap.length_cm} cm</p>
                            <p class="text-xs text-gray-500">Ngày tạo: ${formatDate(scrap.created_at)}</p>
                        </div>
                        <div class="flex gap-2">
                            ${!scrap.is_used ? `
                                <button onclick="markScrapUsed(${scrap.id})" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600">
                                    Đánh dấu đã dùng
                                </button>
                            ` : ''}
                            <button onclick="deleteScrap(${scrap.id})" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">
                                Xóa
                            </button>
                        </div>
                    </div>
                `;
                    container.innerHTML += card;
                });
            }

            function toggleUsedScraps() {
                showUsedScraps = !showUsedScraps;
                const btn = document.getElementById('toggleUsedBtn');
                btn.textContent = showUsedScraps ? 'Ẩn đã dùng' : 'Hiện đã dùng';
                loadScraps();
            }

            function getItemTypeLabel(type) {
                const labels = {
                    'aluminum': 'Nhôm',
                    'glass': 'Kính',
                    'accessory': 'Phụ kiện',
                    'other': 'Khác'
                };
                return labels[type] || type;
            }

            function formatCurrency(amount) {
                return new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(amount || 0);
            }

            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN');
            }

            function formatDateTime(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleString('vi-VN');
            }

            function openAddItemModal() {
                document.getElementById('addItemModal').classList.remove('hidden');
            }

            function closeAddItemModal() {
                document.getElementById('addItemModal').classList.add('hidden');
                document.getElementById('addItemForm').reset();
            }

            function openTransactionModal() {
                document.getElementById('transactionModal').classList.remove('hidden');
                loadInventoryForTransaction();
                loadProjectsForTransaction();
            }

            async function loadProjectsForTransaction() {
                try {
                    const response = await fetch(`${API_BASE}/projects`);
                    const result = await response.json();

                    if (result.success) {
                        const select = document.getElementById('transactionProject');
                        select.innerHTML = '<option value="">-- Chọn dự án --</option>';
                        result.data.forEach(project => {
                            // Hiển thị tên dự án trước, mã trong ngoặc
                            const displayText = project.project_name
                                ? `${project.project_name} (${project.project_code})`
                                : `${project.project_code} - Dự án`;
                            select.innerHTML += `<option value="${project.id}">${displayText}</option>`;
                        });
                    }
                } catch (error) {
                    console.error('Lỗi khi load danh sách dự án:', error);
                }
            }

            function closeTransactionModal() {
                document.getElementById('transactionModal').classList.add('hidden');
                document.getElementById('transactionForm').reset();
            }

            async function editInventoryItem(id) {
                try {
                    console.log('Editing inventory item with ID:', id);
                    const response = await fetch(`${API_BASE}/inventory/${id}`);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('API response:', result);

                    if (result.success && result.data) {
                        const item = result.data;
                        console.log('Item data:', item);

                        // Kiểm tra xem các element có tồn tại không
                        const editItemId = document.getElementById('editItemId');
                        const editItemName = document.getElementById('editItemName');
                        const editItemType = document.getElementById('editItemType');
                        const editItemUnit = document.getElementById('editItemUnit');
                        const editItemStock = document.getElementById('editItemStock');
                        const editItemMinStock = document.getElementById('editItemMinStock');
                        const editItemPrice = document.getElementById('editItemPrice');
                        const editItemModal = document.getElementById('editItemModal');

                        if (!editItemId || !editItemName || !editItemType || !editItemUnit ||
                            !editItemStock || !editItemMinStock || !editItemPrice || !editItemModal) {
                            console.error('Missing form elements:', {
                                editItemId: !!editItemId,
                                editItemName: !!editItemName,
                                editItemType: !!editItemType,
                                editItemUnit: !!editItemUnit,
                                editItemStock: !!editItemStock,
                                editItemMinStock: !!editItemMinStock,
                                editItemPrice: !!editItemPrice,
                                editItemModal: !!editItemModal
                            });
                            alert('Lỗi: Không tìm thấy form chỉnh sửa');
                            return;
                        }

                        editItemId.value = id;
                        editItemName.value = item.item_name || '';
                        editItemType.value = item.item_type || 'aluminum';
                        editItemUnit.value = item.unit || '';
                        editItemStock.value = item.stock_quantity || 0;
                        editItemMinStock.value = item.min_stock_level || 10;
                        editItemPrice.value = item.unit_price || 0;

                        // Hiển thị modal
                        editItemModal.classList.remove('hidden');
                        console.log('Modal should be visible now');
                    } else {
                        console.error('API returned error:', result);
                        alert('Lỗi: ' + (result.message || 'Không thể tải thông tin vật tư'));
                    }
                } catch (error) {
                    console.error('Error editing inventory item:', error);
                    alert('Lỗi khi tải thông tin vật tư: ' + error.message);
                }
            }

            function closeEditItemModal() {
                document.getElementById('editItemModal').classList.add('hidden');
                document.getElementById('editItemForm').reset();
            }

            async function saveEditItem(event) {
                event.preventDefault();
                const id = document.getElementById('editItemId').value;

                const data = {
                    item_name: document.getElementById('editItemName').value,
                    item_type: document.getElementById('editItemType').value,
                    unit: document.getElementById('editItemUnit').value,
                    stock_quantity: parseInt(document.getElementById('editItemStock').value) || 0,
                    min_stock_level: parseInt(document.getElementById('editItemMinStock').value) || 10,
                    unit_price: parseFloat(document.getElementById('editItemPrice').value) || 0,
                    description: document.getElementById('editItemDescription')?.value || null
                };

                try {
                    const response = await fetch(`${API_BASE}/inventory/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Cập nhật vật tư thành công!');
                        closeEditItemModal();
                        loadInventory();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể cập nhật'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server');
                }
            }

            async function deleteInventoryItem(id) {
                if (!confirm('Bạn có chắc muốn xóa vật tư này?')) return;

                try {
                    const response = await fetch(`${API_BASE}/inventory/${id}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Xóa vật tư thành công!');
                        loadInventory();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể xóa'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server');
                }
            }

            async function saveAddItem(event) {
                event.preventDefault();

                const data = {
                    item_code: document.getElementById('itemCode').value,
                    item_name: document.getElementById('itemName').value,
                    item_type: document.getElementById('itemType').value,
                    unit: document.getElementById('itemUnit').value,
                    stock_quantity: parseInt(document.getElementById('itemStock').value) || 0,
                    min_stock_level: parseInt(document.getElementById('itemMinStock').value) || 10,
                    unit_price: parseFloat(document.getElementById('itemPrice').value) || 0,
                    description: document.getElementById('itemDescription').value || null
                };

                try {
                    const response = await fetch(`${API_BASE}/inventory`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Thêm vật tư thành công!');
                        closeAddItemModal();
                        loadInventory();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể thêm'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server');
                }
            }

            async function loadInventoryForTransaction() {
                try {
                    // Load dữ liệu từ inventory (nhôm, kính, vật tư khác)
                    const inventoryResponse = await fetch(`${API_BASE}/inventory`);
                    const inventoryResult = await inventoryResponse.json();

                    let inventoryItems = [];
                    if (inventoryResult.success) {
                        inventoryItems = inventoryResult.data || [];
                    }

                    // Load dữ liệu phụ kiện từ accessories
                    const accessoriesResponse = await fetch(`${API_BASE}/accessories`);
                    const accessoriesResult = await accessoriesResponse.json();

                    let accessoryItems = [];
                    if (accessoriesResult.success) {
                        // Chuyển đổi dữ liệu phụ kiện sang format giống inventory
                        accessoryItems = (accessoriesResult.data || []).map(acc => ({
                            id: acc.id,
                            item_code: acc.code,
                            item_name: acc.name,
                            item_type: 'accessory',
                            unit: acc.unit,
                            stock_quantity: acc.stock_quantity || 0,
                            min_stock_level: acc.min_stock_level || 10,
                            unit_price: acc.sale_price || acc.purchase_price || 0,
                            description: acc.description,
                            category: acc.category,
                            location: null,
                            created_at: acc.created_at,
                            updated_at: acc.updated_at,
                            is_accessory: true // Flag để phân biệt
                        }));
                    }

                    // Load dữ liệu hệ nhôm từ aluminum-systems
                    const aluminumResponse = await fetch(`${API_BASE}/aluminum-systems`);
                    const aluminumResult = await aluminumResponse.json();

                    let aluminumItems = [];
                    if (aluminumResult.success) {
                        // Chuyển đổi dữ liệu hệ nhôm sang format giống inventory
                        aluminumItems = (aluminumResult.data || []).map(al => ({
                            id: al.id,
                            item_code: al.code,
                            item_name: al.name,
                            item_type: 'aluminum',
                            unit: 'Mét', // Hệ nhôm tính theo mét
                            stock_quantity: 0, // Mặc định 0, có thể cập nhật sau nếu có tracking
                            min_stock_level: 0, // Mặc định 0
                            unit_price: 0, // Có thể thêm giá sau
                            description: al.description,
                            brand: al.brand,
                            thickness_mm: al.thickness_mm,
                            length_m: al.length_m,
                            color: al.color,
                            location: null,
                            created_at: al.created_at,
                            updated_at: al.updated_at,
                            is_aluminum: true // Flag để phân biệt
                        }));
                    }

                    // Merge dữ liệu - giống như loadInventory()
                    const allItems = [...inventoryItems, ...accessoryItems, ...aluminumItems];

                    // Populate dropdown
                    const select = document.getElementById('transactionItem');
                    select.innerHTML = '<option value="">-- Chọn vật tư --</option>';

                    allItems.forEach(item => {
                        const stockQty = parseFloat(item.stock_quantity || 0).toLocaleString('vi-VN', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
                        // Lưu thêm thông tin để biết là phụ kiện hay hệ nhôm
                        const isAccessory = item.is_accessory ? 'true' : 'false';
                        const isAluminum = item.is_aluminum ? 'true' : 'false';
                        const prefix = item.is_aluminum ? '[Hệ nhôm] ' : (item.is_accessory ? '[PK] ' : '');
                        select.innerHTML += `<option value="${item.id}" data-is-accessory="${isAccessory}" data-is-aluminum="${isAluminum}">${prefix}${item.item_name} (${stockQty} ${item.unit || ''})</option>`;
                    });

                    console.log(`Loaded ${allItems.length} items for transaction (${inventoryItems.length} inventory + ${accessoryItems.length} accessories + ${aluminumItems.length} aluminum systems)`);
                } catch (error) {
                    console.error('Lỗi khi load dữ liệu vật tư:', error);
                    alert('Lỗi khi tải danh sách vật tư');
                }
            }

            async function saveTransaction(event) {
                event.preventDefault();

                const inventoryIdEl = document.getElementById('transactionItem');
                const projectIdEl = document.getElementById('transactionProject');
                const quantityEl = document.getElementById('transactionQuantity');

                const inventoryId = inventoryIdEl ? inventoryIdEl.value : '';
                const projectId = projectIdEl ? projectIdEl.value : '';
                const quantity = quantityEl ? parseFloat(quantityEl.value) : 0;

                // Validate
                if (!inventoryId) {
                    alert('Vui lòng chọn vật tư');
                    if (inventoryIdEl) inventoryIdEl.focus();
                    return;
                }
                if (!projectId) {
                    alert('Vui lòng chọn dự án');
                    if (projectIdEl) projectIdEl.focus();
                    return;
                }
                if (!quantity || quantity <= 0) {
                    alert('Vui lòng nhập số lượng hợp lệ (lớn hơn 0)');
                    if (quantityEl) quantityEl.focus();
                    return;
                }

                // Lấy thông tin is_accessory và is_aluminum từ option đã chọn (nếu có)
                const selectedOption = inventoryIdEl.options[inventoryIdEl.selectedIndex];
                const isAccessory = selectedOption ? selectedOption.getAttribute('data-is-accessory') === 'true' : false;
                const isAluminum = selectedOption ? selectedOption.getAttribute('data-is-aluminum') === 'true' : false;

                const data = {
                    inventory_id: parseInt(inventoryId),
                    project_id: parseInt(projectId),
                    transaction_type: 'export', // Luôn là xuất kho
                    quantity: quantity,
                    notes: document.getElementById('transactionNotes').value ? document.getElementById('transactionNotes').value.trim() : null,
                    is_accessory: isAccessory, // Gửi flag để backend biết (optional, backend sẽ tự detect)
                    is_aluminum: isAluminum // Gửi flag để backend biết là hệ nhôm
                };

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/inventory/transactions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Thêm giao dịch thành công!');
                        closeTransactionModal();
                        // Refresh tất cả dữ liệu sau một chút để đảm bảo database đã commit
                        setTimeout(() => {
                            loadTransactions();
                        }, 1000); // Tăng delay lên 1 giây để đảm bảo database đã commit
                        loadInventory();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể thêm giao dịch'));
                    }
                } catch (error) {
                    console.error('Lỗi khi thêm giao dịch:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            async function loadTransactions() {
                try {
                    // Kiểm tra xem tab transactions có đang active không
                    const transactionsTab = document.getElementById('tab-transactions');
                    if (!transactionsTab || !transactionsTab.classList.contains('active')) {
                        // Tab không active, không cần load
                        return;
                    }

                    const response = await fetch(`${API_BASE}/inventory/transactions?transaction_type=export`);
                    const result = await response.json();

                    console.log('📥 Loaded transactions response:', result);

                    if (result.success) {
                        allTransactions = result.data || []; // Lưu để search
                        console.log(`📊 Total transactions: ${allTransactions.length}`);

                        // Log transactions để debug (chỉ log 5 transactions đầu tiên)
                        if (allTransactions.length > 0) {
                            const logCount = Math.min(5, allTransactions.length);
                            for (let i = 0; i < logCount; i++) {
                                const trans = allTransactions[i];
                                console.log(`Transaction ${i + 1}:`, {
                                    id: trans.id,
                                    project_id: trans.project_id,
                                    project_code: trans.project_code,
                                    project_name: trans.project_name,
                                    project_name_type: typeof trans.project_name,
                                    project_name_length: trans.project_name ? trans.project_name.length : 0,
                                    has_name: !!(trans.project_name && trans.project_name.trim() !== '')
                                });
                            }
                        }

                        displayTransactions(allTransactions);
                    }
                } catch (error) {
                    console.error('❌ Lỗi khi load transactions:', error);
                }
            }

            async function markScrapUsed(id) {
                if (!confirm('Bạn có chắc muốn đánh dấu nhôm thừa này đã sử dụng?')) return;

                try {
                    const response = await fetch(`${API_BASE}/inventory/scraps/${id}/mark-used`, {
                        method: 'PUT'
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Đã đánh dấu nhôm thừa đã sử dụng!');
                        loadScraps();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể cập nhật'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server');
                }
            }

            async function deleteScrap(id) {
                if (!confirm('Bạn có chắc muốn xóa nhôm thừa này?')) return;

                try {
                    const response = await fetch(`${API_BASE}/inventory/scraps/${id}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Xóa nhôm thừa thành công!');
                        loadScraps();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể xóa'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server');
                }
            }

            // Accessory Functions
            async function loadAccessories() {
                try {
                    const response = await fetch(`${API_BASE}/accessories`);
                    const result = await response.json();

                    if (result.success) {
                        allAccessoriesData = result.data;
                        displayAccessories(result.data);
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            function displayAccessories(accessories) {
                const tbody = document.getElementById('accessoryTable');
                if (!tbody) return;

                tbody.innerHTML = '';

                // Lọc phụ kiện theo danh mục nếu có
                const categoryFilter = document.getElementById('accessoryCategoryFilter');
                let filteredAccessories = accessories;
                if (categoryFilter && categoryFilter.value && categoryFilter.value !== 'all') {
                    filteredAccessories = accessories.filter(acc => acc.category === categoryFilter.value);
                }

                // Lọc theo tìm kiếm nếu có
                const searchInput = document.getElementById('searchAccessory');
                if (searchInput && searchInput.value.trim()) {
                    const searchTerm = searchInput.value.toLowerCase();
                    filteredAccessories = filteredAccessories.filter(acc =>
                        acc.name.toLowerCase().includes(searchTerm) ||
                        acc.code.toLowerCase().includes(searchTerm) ||
                        (acc.category && acc.category.toLowerCase().includes(searchTerm))
                    );
                }

                if (filteredAccessories.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Chưa có phụ kiện nào</td></tr>';
                    updateAccessoryStats(accessories);
                    return;
                }

                filteredAccessories.forEach(accessory => {
                    const isLowStock = (accessory.stock_quantity || 0) < (accessory.min_stock_level || 10);
                    const stockQty = parseFloat(accessory.stock_quantity || 0);
                    const price = parseFloat(accessory.sale_price || accessory.purchase_price || 0);
                    const totalValue = stockQty * price;
                    const row = `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium">${accessory.code}</td>
                        <td class="px-4 py-3 text-sm">${accessory.name}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs">${accessory.category || 'Khác'}</span>
                        </td>
                        <td class="px-4 py-3 text-sm">${accessory.unit || 'Cái'}</td>
                        <td class="px-4 py-3 text-sm">${formatCurrency(price)}</td>
                        <td class="px-4 py-3 text-sm ${isLowStock ? 'text-red-600' : 'text-green-600'}">
                            ${stockQty.toLocaleString('vi-VN')}
                            ${isLowStock ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4 inline ml-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm font-semibold">${formatCurrency(totalValue)}</td>
                        <td class="px-4 py-3 text-sm">
                            <button class="text-blue-600 hover:text-blue-800 mr-2" onclick="editAccessory(${accessory.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="text-red-600 hover:text-red-800" onclick="deleteAccessory(${accessory.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
                    tbody.innerHTML += row;
                });

                // Cập nhật số liệu thống kê từ dữ liệu gốc (không lọc)
                updateAccessoryStats(accessories);

                // Hiển thị tồn kho phụ kiện
                displayAccessoryStock(accessories);
            }

            function displayAccessoryStock(accessories) {
                const tbody = document.getElementById('accessoryStockTable');
                if (!tbody) return;

                tbody.innerHTML = '';

                if (!accessories || accessories.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu tồn kho</td></tr>';
                    return;
                }

                accessories.forEach(accessory => {
                    const stockQty = parseFloat(accessory.stock_quantity) || 0;
                    const minStock = parseFloat(accessory.min_stock_level) || 10;
                    const isLowStock = stockQty < minStock;
                    const unitPrice = parseFloat(accessory.sale_price || accessory.purchase_price) || 0;
                    const value = stockQty * unitPrice;

                    const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium">${accessory.name}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs">${accessory.category || 'Khác'}</span>
                        </td>
                        <td class="px-4 py-3 text-sm ${isLowStock ? 'text-red-600 font-semibold' : 'text-gray-700'}">
                            ${stockQty.toLocaleString('vi-VN')} ${accessory.unit || 'Cái'}
                            ${isLowStock ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4 inline ml-1 text-red-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm">${Math.round(minStock)} ${accessory.unit || 'Cái'}</td>
                        <td class="px-4 py-3 text-sm">${formatCurrency(unitPrice)}</td>
                        <td class="px-4 py-3 text-sm font-semibold">${formatCurrency(value)}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs ${isLowStock ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                ${isLowStock ? 'Cảnh báo' : 'Bình thường'}
                            </span>
                        </td>
                    </tr>
                `;
                    tbody.innerHTML += row;
                });
            }

            function updateAccessoryStats(accessories) {
                if (!accessories || accessories.length === 0) {
                    const totalEl = document.getElementById('totalAccessoriesCount');
                    const inStockEl = document.getElementById('inStockAccessoriesCount');
                    const lowStockEl = document.getElementById('lowStockAccessoriesCount');
                    const categoriesEl = document.getElementById('totalCategoriesCount');
                    if (totalEl) totalEl.textContent = '0';
                    if (inStockEl) inStockEl.textContent = '0';
                    if (lowStockEl) lowStockEl.textContent = '0';
                    if (categoriesEl) categoriesEl.textContent = '0';
                    return;
                }

                // Tổng số phụ kiện
                const totalAccessories = accessories.length;
                const totalEl = document.getElementById('totalAccessoriesCount');
                if (totalEl) totalEl.textContent = totalAccessories;

                // Đếm số phụ kiện đủ tồn kho và cần nhập thêm
                let inStockCount = 0;
                let lowStockCount = 0;

                accessories.forEach(accessory => {
                    const stockQuantity = accessory.stock_quantity || 0;
                    const minStockLevel = accessory.min_stock_level || 10;

                    if (stockQuantity >= minStockLevel) {
                        inStockCount++;
                    } else {
                        lowStockCount++;
                    }
                });

                const inStockEl = document.getElementById('inStockAccessoriesCount');
                const lowStockEl = document.getElementById('lowStockAccessoriesCount');
                if (inStockEl) inStockEl.textContent = inStockCount;
                if (lowStockEl) lowStockEl.textContent = lowStockCount;

                // Đếm số danh mục duy nhất
                const uniqueCategories = new Set();
                accessories.forEach(accessory => {
                    if (accessory.category) {
                        uniqueCategories.add(accessory.category);
                    }
                });
                const categoriesEl = document.getElementById('totalCategoriesCount');
                if (categoriesEl) categoriesEl.textContent = uniqueCategories.size;
            }

            function filterAccessory() {
                // Sử dụng dữ liệu đã load để filter, không cần load lại từ server
                if (allAccessoriesData.length > 0) {
                    displayAccessories(allAccessoriesData);
                } else {
                    loadAccessories();
                }
            }

            async function openAccessoryModal(id = null) {
                editingAccessoryId = id;
                const modalTitle = document.getElementById('accessoryModalTitle');
                if (modalTitle) {
                    modalTitle.textContent = id ? 'Chỉnh sửa phụ kiện' : 'Thêm phụ kiện mới';
                }
                const form = document.getElementById('accessoryForm');
                if (form) form.reset();
                const accessoryId = document.getElementById('accessoryId');
                if (accessoryId) accessoryId.value = id || '';

                if (id) {
                    loadAccessoryForEdit(id);
                } else {
                    // Tự động tạo mã VRPK khi thêm mới
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`${API_BASE}/inventory/next-vrpk-code`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        if (response.ok) {
                            const result = await response.json();
                            if (result.success && result.data) {
                                const codeEl = document.getElementById('accessoryCode');
                                if (codeEl) {
                                    codeEl.value = result.data.code;
                                    codeEl.readOnly = true;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Lỗi khi lấy mã VRPK:', error);
                    }
                }

                const modal = document.getElementById('accessoryModal');
                if (modal) modal.classList.remove('hidden');
            }

            function closeAccessoryModal() {
                const modal = document.getElementById('accessoryModal');
                if (modal) modal.classList.add('hidden');
                editingAccessoryId = null;
            }

            async function loadAccessoryForEdit(id) {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/accessories/${id}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        const accessory = result.data;
                        const codeEl = document.getElementById('accessoryCode');
                        const categoryEl = document.getElementById('accessoryCategory');
                        const nameEl = document.getElementById('accessoryName');
                        const unitEl = document.getElementById('accessoryUnit');
                        const purchasePriceEl = document.getElementById('accessoryPurchasePrice');
                        const salePriceEl = document.getElementById('accessorySalePrice');
                        const stockEl = document.getElementById('accessoryStock');
                        const minStockEl = document.getElementById('accessoryMinStock');
                        const descriptionEl = document.getElementById('accessoryDescription');

                        if (codeEl) {
                            codeEl.value = accessory.code || '';
                            codeEl.readOnly = false; // Cho phép chỉnh sửa mã khi edit
                        }
                        if (categoryEl) categoryEl.value = accessory.category || '';
                        if (nameEl) nameEl.value = accessory.name || '';
                        if (unitEl) unitEl.value = accessory.unit || '';
                        if (purchasePriceEl) purchasePriceEl.value = accessory.purchase_price || '';
                        if (salePriceEl) salePriceEl.value = accessory.sale_price || '';
                        if (stockEl) stockEl.value = accessory.stock_quantity || 0;
                        if (minStockEl) minStockEl.value = accessory.min_stock_level || 10;
                        if (descriptionEl) descriptionEl.value = accessory.description || '';
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            async function saveAccessory(event) {
                event.preventDefault();

                const codeEl = document.getElementById('accessoryCode');
                const nameEl = document.getElementById('accessoryName');
                const categoryEl = document.getElementById('accessoryCategory');
                const unitEl = document.getElementById('accessoryUnit');
                const purchasePriceEl = document.getElementById('accessoryPurchasePrice');
                const salePriceEl = document.getElementById('accessorySalePrice');
                const stockEl = document.getElementById('accessoryStock');
                const minStockEl = document.getElementById('accessoryMinStock');
                const descriptionEl = document.getElementById('accessoryDescription');

                // Validation - chỉ kiểm tra các trường bắt buộc
                if (!codeEl || !codeEl.value.trim()) {
                    alert('Vui lòng nhập mã phụ kiện');
                    if (codeEl) codeEl.focus();
                    return;
                }
                if (!nameEl || !nameEl.value.trim()) {
                    alert('Vui lòng nhập tên phụ kiện');
                    if (nameEl) nameEl.focus();
                    return;
                }
                if (!categoryEl || !categoryEl.value) {
                    alert('Vui lòng chọn danh mục');
                    if (categoryEl) categoryEl.focus();
                    return;
                }
                if (!unitEl || !unitEl.value.trim()) {
                    alert('Vui lòng nhập đơn vị');
                    if (unitEl) unitEl.focus();
                    return;
                }
                // Giá bán là required trong form, nhưng nếu không có thì để 0
                const salePrice = salePriceEl ? parseFloat(salePriceEl.value) : 0;
                if (isNaN(salePrice) || salePrice < 0) {
                    alert('Vui lòng nhập giá bán hợp lệ (>= 0)');
                    if (salePriceEl) salePriceEl.focus();
                    return;
                }

                const data = {
                    code: codeEl.value.trim(),
                    name: nameEl.value.trim(),
                    category: categoryEl.value,
                    unit: unitEl.value.trim(),
                    purchase_price: purchasePriceEl && purchasePriceEl.value ? (parseFloat(purchasePriceEl.value) || 0) : 0,
                    sale_price: salePrice || 0,
                    stock_quantity: stockEl && stockEl.value ? (parseInt(stockEl.value) || 0) : 0,
                    min_stock_level: minStockEl && minStockEl.value ? (parseInt(minStockEl.value) || 10) : 10,
                    description: descriptionEl && descriptionEl.value ? descriptionEl.value.trim() : null
                };

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const id = editingAccessoryId;
                    const url = id ? `${API_BASE}/accessories/${id}` : `${API_BASE}/accessories`;
                    const method = id ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification(id ? 'Cập nhật phụ kiện thành công!' : 'Thêm phụ kiện thành công!');
                        closeAccessoryModal();
                        loadAccessories();
                        loadStats(); // Cập nhật stats tổng hợp
                        // Reload dropdown trong transaction modal nếu đang mở
                        if (!document.getElementById('transactionModal').classList.contains('hidden')) {
                            loadInventoryForTransaction();
                        }
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể lưu'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            async function editAccessory(id) {
                openAccessoryModal(id);
            }

            async function deleteAccessory(id) {
                if (!confirm('Bạn có chắc muốn xóa phụ kiện này?')) return;

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/accessories/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Xóa phụ kiện thành công!');
                        loadAccessories();
                        loadStats(); // Cập nhật stats tổng hợp
                        // Reload dropdown trong transaction modal nếu đang mở
                        if (!document.getElementById('transactionModal').classList.contains('hidden')) {
                            loadInventoryForTransaction();
                        }
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể xóa'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            // Aluminum Systems Functions
            let editingAluminumId = null;

            function displayAluminumSystems(systems) {
                const tbody = document.getElementById('aluminumTable');
                tbody.innerHTML = '';

                systems.forEach(system => {
                    // Số lượng là số cây/thanh, không phải mét
                    const quantity = parseInt(system.quantity || system.quantity_m || 0);
                    const unitPrice = parseFloat(system.unit_price || 0);
                    const totalValue = quantity * unitPrice;
                    const row = `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium">${system.code}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">${system.aluminum_system || system.system_type || '-'}</span>
                        </td>
                        <td class="px-4 py-3 text-sm">${system.name}</td>
                        <td class="px-4 py-3 text-sm">
                            ${system.cross_section_image ?
                            (() => {
                                // Convert relative path to absolute URL
                                const imageUrl = system.cross_section_image.startsWith('http')
                                    ? system.cross_section_image
                                    : `http://localhost:3001${system.cross_section_image.startsWith('/') ? '' : '/'}${system.cross_section_image}`;
                                return `<img src="${imageUrl}" alt="Mặt cắt" class="w-16 h-16 object-contain border border-gray-300 rounded cursor-pointer" onclick="showImageModal('${imageUrl}')">`;
                            })() :
                            '<span class="text-gray-400">-</span>'}
                        </td>
                        <td class="px-4 py-3 text-sm">${system.density ? parseFloat(system.density).toFixed(3) : '-'}</td>
                        <td class="px-4 py-3 text-sm">${system.length_m || '-'}</td>
                        <td class="px-4 py-3 text-sm font-medium">${quantity.toLocaleString('vi-VN')}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${system.color || '-'}</span>
                        </td>
                        <td class="px-4 py-3 text-sm font-medium">
                            ${unitPrice > 0 ? formatCurrency(unitPrice) : '-'}
                        </td>
                        <td class="px-4 py-3 text-sm font-semibold">${formatCurrency(totalValue)}</td>
                        <td class="px-4 py-3 text-sm">
                            <button class="text-blue-600 hover:text-blue-800 mr-2" onclick="editAluminum(${system.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="text-red-600 hover:text-red-800" onclick="deleteAluminum(${system.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
                    tbody.innerHTML += row;
                });

                // Hiển thị tồn kho hệ nhôm
                displayAluminumStock(systems);
            }

            function displayAluminumStock(systems) {
                const tbody = document.getElementById('aluminumStockTable');
                if (!tbody) return;

                tbody.innerHTML = '';

                if (!systems || systems.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu tồn kho</td></tr>';
                    return;
                }

                systems.forEach(system => {
                    const stockQty = 0; // Kho nhôm không có tracking tồn kho
                    const minStock = 0;
                    const isLowStock = false;
                    const unitPrice = parseFloat(system.unit_price) || 0;
                    const value = stockQty * unitPrice;

                    const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium">${system.name}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs">Kho nhôm</span>
                        </td>
                        <td class="px-4 py-3 text-sm">${stockQty.toLocaleString('vi-VN')} Mét</td>
                        <td class="px-4 py-3 text-sm">${minStock} Mét</td>
                        <td class="px-4 py-3 text-sm">${formatCurrency(unitPrice)}</td>
                        <td class="px-4 py-3 text-sm font-semibold">${formatCurrency(value)}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-700">Bình thường</span>
                        </td>
                    </tr>
                `;
                    tbody.innerHTML += row;
                });
            }

            function filterAluminum() {
                const searchTerm = document.getElementById('searchAluminum').value;
                loadAluminumSystems(searchTerm);
            }

            async function loadAluminumSystems(search = '') {
                try {
                    const url = search ? `${API_BASE}/aluminum-systems?search=${encodeURIComponent(search)}` : `${API_BASE}/aluminum-systems`;
                    const response = await fetch(url);
                    const result = await response.json();

                    if (result.success) {
                        displayAluminumSystems(result.data);
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            function openAluminumModal(id = null) {
                editingAluminumId = id;
                document.getElementById('aluminumModalTitle').textContent = id ? 'Chỉnh sửa kho nhôm' : 'Thêm kho nhôm mới';
                document.getElementById('aluminumForm').reset();
                document.getElementById('aluminumId').value = id || '';

                // Set required attribute for image input
                const fileInput = document.getElementById('aluminumCrossSection');
                const requiredLabel = document.getElementById('aluminumCrossSectionRequired');
                if (id) {
                    // Edit mode: không bắt buộc chọn ảnh mới
                    fileInput.removeAttribute('required');
                    if (requiredLabel) requiredLabel.classList.add('hidden');
                } else {
                    // Add mode: bắt buộc chọn ảnh
                    fileInput.setAttribute('required', 'required');
                    if (requiredLabel) requiredLabel.classList.remove('hidden');
                }

                // Reset preview
                const preview = document.getElementById('aluminumCrossSectionPreview');
                const previewImg = document.getElementById('aluminumCrossSectionImg');
                if (preview) preview.classList.add('hidden');
                if (previewImg) previewImg.src = '';

                // Add event listener for image preview
                if (fileInput && !fileInput.hasAttribute('data-listener')) {
                    fileInput.setAttribute('data-listener', 'true');
                    fileInput.addEventListener('change', function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                previewImg.src = e.target.result;
                                preview.classList.remove('hidden');
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }

                if (id) {
                    loadAluminumForEdit(id);
                }

                document.getElementById('aluminumModal').classList.remove('hidden');
            }

            function clearAluminumCrossSection() {
                const fileInput = document.getElementById('aluminumCrossSection');
                const preview = document.getElementById('aluminumCrossSectionPreview');
                const previewImg = document.getElementById('aluminumCrossSectionImg');
                const requiredLabel = document.getElementById('aluminumCrossSectionRequired');
                if (fileInput) {
                    fileInput.value = '';
                    // Nếu đang ở chế độ thêm mới, set lại required
                    if (!editingAluminumId) {
                        fileInput.setAttribute('required', 'required');
                        if (requiredLabel) requiredLabel.classList.remove('hidden');
                    }
                }
                if (preview) preview.classList.add('hidden');
                if (previewImg) previewImg.src = '';
            }

            function showImageModal(imageUrl) {
                // Convert relative path to absolute URL if needed
                if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('data:')) {
                    imageUrl = `http://localhost:3001${imageUrl.startsWith('/') ? '' : '/'}${imageUrl}`;
                }

                // Create modal if not exists
                let modal = document.getElementById('imageModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'imageModal';
                    modal.className = 'hidden fixed inset-0 bg-black bg-opacity-75 z-[10001] flex items-center justify-center';
                    modal.innerHTML = `
                    <div class="relative max-w-4xl max-h-[90vh] p-4">
                        <button onclick="closeImageModal()" class="absolute top-2 right-2 text-white hover:text-gray-300 z-10">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                        <img id="imageModalImg" src="" alt="Hình ảnh" class="max-w-full max-h-[90vh] object-contain rounded">
                    </div>
                `;
                    document.body.appendChild(modal);
                }
                const img = document.getElementById('imageModalImg');
                if (img) img.src = imageUrl;
                modal.classList.remove('hidden');
            }

            function closeImageModal() {
                const modal = document.getElementById('imageModal');
                if (modal) modal.classList.add('hidden');
            }

            function closeAluminumModal() {
                document.getElementById('aluminumModal').classList.add('hidden');
                editingAluminumId = null;
            }

            async function loadAluminumForEdit(id) {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/aluminum-systems/${id}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        const system = result.data;
                        document.getElementById('aluminumCode').value = system.code || '';
                        document.getElementById('aluminumSystem').value = system.aluminum_system || system.system_type || '';
                        document.getElementById('aluminumName').value = system.name || '';
                        document.getElementById('aluminumDensity').value = system.density || '';
                        document.getElementById('aluminumLength').value = system.length_m || '';
                        document.getElementById('aluminumQuantity').value = system.quantity || 0;
                        document.getElementById('aluminumPrice').value = system.unit_price || '';
                        document.getElementById('aluminumColor').value = system.color || '';
                        document.getElementById('aluminumDescription').value = system.description || '';

                        // Load cross section image if exists
                        if (system.cross_section_image) {
                            const preview = document.getElementById('aluminumCrossSectionPreview');
                            const previewImg = document.getElementById('aluminumCrossSectionImg');
                            const fileInput = document.getElementById('aluminumCrossSection');
                            const requiredLabel = document.getElementById('aluminumCrossSectionRequired');
                            if (previewImg) {
                                // Convert relative path to absolute URL
                                const imageUrl = system.cross_section_image.startsWith('http')
                                    ? system.cross_section_image
                                    : `http://localhost:3001${system.cross_section_image.startsWith('/') ? '' : '/'}${system.cross_section_image}`;
                                previewImg.src = imageUrl;
                            }
                            if (preview) preview.classList.remove('hidden');
                            // Bỏ required khi đã có ảnh (đang edit)
                            if (fileInput) {
                                fileInput.removeAttribute('required');
                            }
                            if (requiredLabel) requiredLabel.classList.add('hidden');
                        }
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            async function saveAluminum(event) {
                event.preventDefault();

                const codeEl = document.getElementById('aluminumCode');
                const nameEl = document.getElementById('aluminumName');
                const densityEl = document.getElementById('aluminumDensity');
                const crossSectionEl = document.getElementById('aluminumCrossSection');

                // Validation
                if (!codeEl || !codeEl.value.trim()) {
                    alert('Vui lòng nhập mã kho nhôm');
                    if (codeEl) codeEl.focus();
                    return;
                }
                if (!nameEl || !nameEl.value.trim()) {
                    alert('Vui lòng nhập tên kho nhôm');
                    if (nameEl) nameEl.focus();
                    return;
                }
                if (!densityEl || !densityEl.value || parseFloat(densityEl.value) <= 0) {
                    alert('Vui lòng nhập tỉ trọng thô hợp lệ');
                    if (densityEl) densityEl.focus();
                    return;
                }

                // Check if image is required (only for new items)
                if (!editingAluminumId && (!crossSectionEl || !crossSectionEl.files || crossSectionEl.files.length === 0)) {
                    alert('Vui lòng chọn hình ảnh mặt cắt');
                    if (crossSectionEl) crossSectionEl.focus();
                    return;
                }

                const id = editingAluminumId;
                const quantityValue = document.getElementById('aluminumQuantity').value ? parseInt(document.getElementById('aluminumQuantity').value) : 0;

                // Kiểm tra xem có file ảnh mới không
                const hasNewImage = crossSectionEl && crossSectionEl.files && crossSectionEl.files.length > 0;
                const existingImageUrl = id ? (() => {
                    const previewImg = document.getElementById('aluminumCrossSectionImg');
                    if (previewImg && previewImg.src && !previewImg.src.includes('data:')) {
                        // Convert absolute URL back to relative path for saving
                        let imgSrc = previewImg.src;
                        if (imgSrc.includes('http://localhost:3001')) {
                            imgSrc = imgSrc.replace('http://localhost:3001', '');
                        }
                        return imgSrc;
                    }
                    return null;
                })() : null;

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const url = id ? `${API_BASE}/aluminum-systems/${id}` : `${API_BASE}/aluminum-systems`;
                    const method = id ? 'PUT' : 'POST';

                    let response;

                    // Nếu có file ảnh mới, dùng FormData để upload
                    if (hasNewImage) {
                        const formData = new FormData();
                        formData.append('image', crossSectionEl.files[0]);
                        formData.append('code', codeEl.value.trim());
                        formData.append('aluminum_system', document.getElementById('aluminumSystem').value);
                        formData.append('name', nameEl.value.trim());
                        formData.append('density', parseFloat(densityEl.value));
                        formData.append('length_m', document.getElementById('aluminumLength').value ? parseFloat(document.getElementById('aluminumLength').value) : '');
                        formData.append('quantity', quantityValue);
                        formData.append('quantity_m', quantityValue);
                        formData.append('unit_price', document.getElementById('aluminumPrice').value ? (parseFloat(document.getElementById('aluminumPrice').value) || 0) : 0);
                        formData.append('color', document.getElementById('aluminumColor').value ? document.getElementById('aluminumColor').value.trim() : '');
                        formData.append('description', document.getElementById('aluminumDescription').value ? document.getElementById('aluminumDescription').value.trim() : '');

                        response = await fetch(url, {
                            method: method,
                            headers: {
                                'Authorization': `Bearer ${token}`
                                // Không set Content-Type, browser sẽ tự set với boundary cho FormData
                            },
                            body: formData
                        });
                    } else {
                        // Nếu không có file mới, dùng JSON (nhẹ hơn)
                        const data = {
                            code: codeEl.value.trim(),
                            aluminum_system: document.getElementById('aluminumSystem').value,
                            name: nameEl.value.trim(),
                            density: parseFloat(densityEl.value),
                            cross_section_image: existingImageUrl, // Giữ nguyên ảnh cũ nếu có
                            length_m: document.getElementById('aluminumLength').value ? parseFloat(document.getElementById('aluminumLength').value) : null,
                            quantity: quantityValue,
                            quantity_m: quantityValue,
                            unit_price: document.getElementById('aluminumPrice').value ? (parseFloat(document.getElementById('aluminumPrice').value) || 0) : 0,
                            color: document.getElementById('aluminumColor').value ? document.getElementById('aluminumColor').value.trim() : null,
                            description: document.getElementById('aluminumDescription').value ? document.getElementById('aluminumDescription').value.trim() : null
                        };

                        response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(data)
                        });
                    }

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    if (response.status === 413) {
                        alert('File ảnh quá lớn! Vui lòng chọn ảnh nhỏ hơn 5MB.');
                        return;
                    }

                    // Đọc response text trước để xử lý lỗi
                    const responseText = await response.text();
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        // Nếu không parse được JSON, có thể là HTML error page
                        console.error('Response không phải JSON:', responseText.substring(0, 200));
                        alert('Lỗi server: ' + response.status + ' ' + response.statusText + '\nVui lòng kiểm tra console để xem chi tiết.');
                        return;
                    }

                    if (result.success) {
                        showSuccessNotification(id ? 'Cập nhật kho nhôm thành công!' : 'Thêm kho nhôm thành công!');
                        closeAluminumModal();
                        loadAluminumSystems();
                        loadStats(); // Cập nhật stats tổng hợp
                        // Reload dropdown trong transaction modal nếu đang mở
                        if (!document.getElementById('transactionModal').classList.contains('hidden')) {
                            loadInventoryForTransaction();
                        }
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể lưu'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            async function editAluminum(id) {
                openAluminumModal(id);
            }

            async function deleteAluminum(id) {
                if (!confirm('Bạn có chắc muốn xóa kho nhôm này?')) return;

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/aluminum-systems/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Xóa hệ nhôm thành công!');
                        loadAluminumSystems();
                        loadStats(); // Cập nhật stats tổng hợp
                        // Reload dropdown trong transaction modal nếu đang mở
                        if (!document.getElementById('transactionModal').classList.contains('hidden')) {
                            loadInventoryForTransaction();
                        }
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể xóa'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            // ========== GLASS MANAGEMENT ==========
            let editingGlassId = null;

            function calculateGlassArea() {
                const length = parseFloat(document.getElementById('glassLength').value) || 0;
                const width = parseFloat(document.getElementById('glassWidth').value) || 0;
                const area = length * width;
                document.getElementById('glassArea').value = area.toFixed(2);
            }

            function getGlassDimensions(item) {
                // Parse từ notes hoặc description để lấy chiều dài x chiều rộng
                // Backend trả về notes as description
                const notes = item.notes || item.description || '';

                // Tìm pattern "Xm x Ym" trong notes (ví dụ: "2.0m x 1.5m")
                const dimensionMatch = notes.match(/(\d+\.?\d*)\s*m\s*x\s*(\d+\.?\d*)\s*m/i);

                if (dimensionMatch) {
                    return `${dimensionMatch[1]}m x ${dimensionMatch[2]}m`;
                }

                // Thử tìm pattern "X x Y" (không có "m")
                const simpleMatch = notes.match(/(\d+\.?\d*)\s*x\s*(\d+\.?\d*)/i);
                if (simpleMatch) {
                    return `${simpleMatch[1]}m x ${simpleMatch[2]}m`;
                }

                // Nếu không tìm thấy, thử parse từ các trường riêng nếu có
                if (item.length_m && item.width_m) {
                    return `${item.length_m}m x ${item.width_m}m`;
                }

                return '-';
            }

            function displayGlassItems(items) {
                const tbody = document.getElementById('glassTable');
                tbody.innerHTML = '';

                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu</td></tr>';
                    return;
                }

                items.forEach(item => {
                    // Backend trả về notes as description, nên dùng description hoặc notes
                    const notes = item.notes || item.description || '';
                    const typeMatch = notes.match(/^([^-]+)/);
                    const thicknessMatch = notes.match(/(\d+\.?\d*)mm/i);
                    const glassType = typeMatch ? typeMatch[1].trim() : (item.description || '-');
                    const thickness = thicknessMatch ? thicknessMatch[1] + 'mm' : '-';

                    // Parse chiều dài x chiều rộng và tính diện tích
                    const dimensions = getGlassDimensions(item);
                    const dimensionMatch = notes.match(/(\d+\.?\d*)\s*m\s*x\s*(\d+\.?\d*)\s*m/i);
                    let area = 0;
                    if (dimensionMatch) {
                        const length = parseFloat(dimensionMatch[1]);
                        const width = parseFloat(dimensionMatch[2]);
                        area = length * width;
                    } else if (item.quantity || item.stock_quantity) {
                        area = parseFloat(item.quantity || item.stock_quantity) || 0;
                    }

                    // TỒN KHO: Ưu tiên quantity, sau đó stock_quantity - PHẢI là number
                    const stock = parseFloat(item.quantity || item.stock_quantity || 0);
                    // GIÁ: PHẢI là number
                    const unitPrice = parseFloat(item.unit_price || 0);
                    // TỔNG GIÁ TRỊ = TỒN KHO * GIÁ (không phải diện tích * giá)
                    const totalValue = stock * unitPrice;

                    const row = `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium">${item.item_code || '-'}</td>
                        <td class="px-4 py-3 text-sm">${item.item_name || '-'}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs">${glassType}</span>
                        </td>
                        <td class="px-4 py-3 text-sm">${thickness}</td>
                        <td class="px-4 py-3 text-sm">${dimensions}</td>
                        <td class="px-4 py-3 text-sm">${area.toLocaleString('vi-VN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} m²</td>
                        <td class="px-4 py-3 text-sm font-medium">
                            ${unitPrice > 0 ? formatCurrency(unitPrice) : '-'}
                        </td>
                        <td class="px-4 py-3 text-sm">${stock.toLocaleString('vi-VN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} tấm</td>
                        <td class="px-4 py-3 text-sm font-semibold">${formatCurrency(totalValue)}</td>
                        <td class="px-4 py-3 text-sm">
                            <button class="text-blue-600 hover:text-blue-800 mr-2" onclick="editGlass(${item.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="text-red-600 hover:text-red-800" onclick="deleteGlass(${item.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
                    tbody.innerHTML += row;
                });

                // Hiển thị tồn kho kính
                displayGlassStock(items);
            }

            function displayGlassStock(items) {
                const tbody = document.getElementById('glassStockTable');
                if (!tbody) return;

                tbody.innerHTML = '';

                if (!items || items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu tồn kho</td></tr>';
                    return;
                }

                items.forEach(item => {
                    const notes = item.notes || item.description || '';
                    const typeMatch = notes.match(/^([^-]+)/);
                    const glassType = typeMatch ? typeMatch[1].trim() : (item.description || '-');

                    const stockQty = parseFloat(item.stock_quantity || item.quantity) || 0;
                    const minStock = parseFloat(item.min_stock_level) || 10;
                    const isLowStock = stockQty < minStock;
                    const unitPrice = parseFloat(item.unit_price) || 0;
                    const value = stockQty * unitPrice;

                    const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium">${item.item_name || '-'}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs">${glassType}</span>
                        </td>
                        <td class="px-4 py-3 text-sm ${isLowStock ? 'text-red-600 font-semibold' : 'text-gray-700'}">
                            ${stockQty.toLocaleString('vi-VN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} tấm
                            ${isLowStock ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4 inline ml-1 text-red-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm">${Math.round(minStock)} tấm</td>
                        <td class="px-4 py-3 text-sm">${formatCurrency(unitPrice)}</td>
                        <td class="px-4 py-3 text-sm font-semibold">${formatCurrency(value)}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs ${isLowStock ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                ${isLowStock ? 'Cảnh báo' : 'Bình thường'}
                            </span>
                        </td>
                    </tr>
                `;
                    tbody.innerHTML += row;
                });
            }

            function filterGlass() {
                const searchTerm = document.getElementById('searchGlass').value.toLowerCase();
                loadGlassItems(searchTerm);
            }

            async function loadGlassItems(search = '') {
                try {
                    const response = await fetch(`${API_BASE}/inventory?item_type=glass`);
                    const result = await response.json();

                    console.log('Load glass items response:', result); // Debug

                    if (result.success) {
                        let items = result.data || [];

                        // Đảm bảo quantity và unit_price là number
                        items = items.map(item => ({
                            ...item,
                            quantity: parseFloat(item.quantity) || 0,
                            stock_quantity: parseFloat(item.quantity) || 0,
                            unit_price: parseFloat(item.unit_price) || 0
                        }));

                        if (search) {
                            items = items.filter(item =>
                                (item.item_code && item.item_code.toLowerCase().includes(search)) ||
                                (item.item_name && item.item_name.toLowerCase().includes(search))
                            );
                        }

                        console.log('Processed items:', items); // Debug
                        displayGlassItems(items);
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            function openGlassModal(id = null) {
                editingGlassId = id;
                document.getElementById('glassModalTitle').textContent = id ? 'Chỉnh sửa kính' : 'Thêm kính mới';
                document.getElementById('glassForm').reset();
                document.getElementById('glassId').value = id || '';

                if (id) {
                    loadGlassForEdit(id);
                }

                document.getElementById('glassModal').classList.remove('hidden');
            }

            function closeGlassModal() {
                document.getElementById('glassModal').classList.add('hidden');
                editingGlassId = null;
            }

            async function loadGlassForEdit(id) {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/inventory/${id}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        const item = result.data;
                        document.getElementById('glassCode').value = item.item_code || '';
                        // Backend trả về notes as description
                        const notes = item.notes || item.description || '';

                        // Parse loại kính từ notes (phần đầu trước dấu -)
                        const typeMatch = notes.match(/^([^-]+)/);
                        const glassType = typeMatch ? typeMatch[1].trim() : (item.description || '');
                        document.getElementById('glassType').value = glassType || '';

                        document.getElementById('glassName').value = item.item_name || '';

                        // Parse độ dày từ notes (tìm pattern "Xmm")
                        const thicknessMatch = notes.match(/(\d+\.?\d*)mm/i);
                        document.getElementById('glassThickness').value = thicknessMatch ? thicknessMatch[1] : '';

                        // Parse chiều dài và rộng từ notes (format: "Xm x Ym")
                        const dimensionMatch = notes.match(/(\d+\.?\d*)\s*m\s*x\s*(\d+\.?\d*)\s*m/i);
                        if (dimensionMatch) {
                            document.getElementById('glassLength').value = dimensionMatch[1];
                            document.getElementById('glassWidth').value = dimensionMatch[2];
                        } else {
                            // Thử pattern đơn giản hơn "X x Y"
                            const simpleMatch = notes.match(/(\d+\.?\d*)\s*x\s*(\d+\.?\d*)/i);
                            if (simpleMatch) {
                                document.getElementById('glassLength').value = simpleMatch[1];
                                document.getElementById('glassWidth').value = simpleMatch[2];
                            }
                        }

                        // Tính lại diện tích
                        calculateGlassArea();

                        document.getElementById('glassPrice').value = item.unit_price || '';
                        // Hiển thị tồn kho - ưu tiên quantity, sau đó stock_quantity
                        const stockValue = item.quantity || item.stock_quantity || 0;
                        document.getElementById('glassStock').value = stockValue;

                        // Lưu phần mô tả (sau dấu - cuối cùng nếu có)
                        const descParts = notes.split(' - ');
                        if (descParts.length > 3) {
                            document.getElementById('glassDescription').value = descParts.slice(3).join(' - ');
                        } else {
                            document.getElementById('glassDescription').value = '';
                        }
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            async function saveGlass(event) {
                event.preventDefault();

                const codeEl = document.getElementById('glassCode');
                const nameEl = document.getElementById('glassName');
                const thicknessEl = document.getElementById('glassThickness');
                const lengthEl = document.getElementById('glassLength');
                const widthEl = document.getElementById('glassWidth');

                // Validation
                if (!codeEl || !codeEl.value.trim()) {
                    alert('Vui lòng nhập mã kính');
                    if (codeEl) codeEl.focus();
                    return;
                }
                if (!nameEl || !nameEl.value.trim()) {
                    alert('Vui lòng nhập tên kính');
                    if (nameEl) nameEl.focus();
                    return;
                }
                if (!thicknessEl || !thicknessEl.value || parseFloat(thicknessEl.value) <= 0) {
                    alert('Vui lòng nhập độ dày hợp lệ');
                    if (thicknessEl) thicknessEl.focus();
                    return;
                }
                if (!lengthEl || !lengthEl.value || parseFloat(lengthEl.value) <= 0) {
                    alert('Vui lòng nhập chiều dài hợp lệ');
                    if (lengthEl) lengthEl.focus();
                    return;
                }
                if (!widthEl || !widthEl.value || parseFloat(widthEl.value) <= 0) {
                    alert('Vui lòng nhập chiều rộng hợp lệ');
                    if (widthEl) widthEl.focus();
                    return;
                }

                const id = editingGlassId;
                // Parse number - đảm bảo là number, không phải string
                // Remove dấu phẩy, dấu chấm (format số) trước khi parse
                const length = parseFloat(lengthEl.value.toString().replace(',', '.')) || 0;
                const width = parseFloat(widthEl.value.toString().replace(',', '.')) || 0;
                const area = length * width;
                const thickness = parseFloat(thicknessEl.value.toString().replace(',', '.')) || 0;
                const glassType = document.getElementById('glassType').value;
                // Tồn kho: ưu tiên giá trị nhập, nếu không có thì dùng diện tích
                const stockInput = document.getElementById('glassStock').value;
                const stock = stockInput ? parseFloat(stockInput.toString().replace(',', '.')) : area;
                const description = document.getElementById('glassDescription').value || '';

                // Giá: parse number, remove tất cả dấu phẩy, dấu chấm (format tiền) trước khi parse
                const priceInput = document.getElementById('glassPrice').value;
                const unitPrice = priceInput ? parseFloat(priceInput.toString().replace(/[^\d]/g, '')) : 0;

                // Lưu chiều dài x chiều rộng vào notes (format: "Loại - Độ dày - Dài x Rộng - Mô tả")
                let notes = `${glassType} - ${thickness}mm - ${length}m x ${width}m`;
                if (description) {
                    notes += ` - ${description}`;
                }

                const data = {
                    item_code: codeEl.value.trim(),
                    item_name: nameEl.value.trim(),
                    item_type: 'glass',
                    unit: 'tấm', // Đơn vị tồn kho là tấm, không phải m²
                    quantity: stock, // Tồn kho - số tấm (PHẢI là number)
                    min_stock_level: 10,
                    unit_price: unitPrice, // Giá - PHẢI là number
                    description: glassType || null,
                    notes: notes
                };

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const url = id ? `${API_BASE}/inventory/${id}` : `${API_BASE}/inventory`;
                    const method = id ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification(id ? 'Cập nhật kính thành công!' : 'Thêm kính thành công!');
                        closeGlassModal();
                        // Reload với search term hiện tại - đợi một chút để đảm bảo DB đã cập nhật
                        setTimeout(() => {
                            const searchTerm = document.getElementById('searchGlass').value || '';
                            loadGlassItems(searchTerm);
                            loadStats(); // Cập nhật stats tổng hợp
                        }, 100);
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể lưu'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            async function editGlass(id) {
                openGlassModal(id);
            }

            async function deleteGlass(id) {
                if (!confirm('Bạn có chắc muốn xóa kính này?')) return;

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/inventory/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Xóa kính thành công!');
                        // Reload với search term hiện tại
                        const searchTerm = document.getElementById('searchGlass').value || '';
                        loadGlassItems(searchTerm);
                        loadStats(); // Cập nhật stats tổng hợp
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể xóa'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            // ========== OTHER ITEMS MANAGEMENT ==========
            let editingOtherId = null;

            function displayOtherItems(items) {
                const tbody = document.getElementById('otherTable');
                tbody.innerHTML = '';

                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu</td></tr>';
                    return;
                }

                items.forEach(item => {
                    // TỒN KHO: Ưu tiên quantity, sau đó stock_quantity - PHẢI là number
                    const stockQty = parseFloat(item.quantity || item.stock_quantity || 0);
                    // GIÁ: PHẢI là number
                    const unitPrice = parseFloat(item.unit_price || 0);
                    // TỔNG GIÁ TRỊ = TỒN KHO * GIÁ
                    const totalValue = stockQty * unitPrice;

                    console.log('Display item:', {
                        code: item.item_code,
                        rawQuantity: item.quantity,
                        rawStockQuantity: item.stock_quantity,
                        rawUnitPrice: item.unit_price,
                        parsedQuantity: stockQty,
                        parsedPrice: unitPrice,
                        totalValue
                    }); // Debug

                    const row = `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium">${item.item_code || '-'}</td>
                        <td class="px-4 py-3 text-sm">${item.item_name || '-'}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-xs">${item.description || item.item_type || '-'}</span>
                        </td>
                        <td class="px-4 py-3 text-sm">${item.unit || '-'}</td>
                        <td class="px-4 py-3 text-sm font-medium">
                            ${unitPrice > 0 ? formatCurrency(unitPrice) : '-'}
                        </td>
                        <td class="px-4 py-3 text-sm">${stockQty.toLocaleString('vi-VN')} ${item.unit || ''}</td>
                        <td class="px-4 py-3 text-sm font-semibold">${formatCurrency(totalValue)}</td>
                        <td class="px-4 py-3 text-sm">
                            <button class="text-blue-600 hover:text-blue-800 mr-2" onclick="editOther(${item.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="text-red-600 hover:text-red-800" onclick="deleteOther(${item.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
                    tbody.innerHTML += row;
                });
            }

            function filterOther() {
                const searchTerm = document.getElementById('searchOther')?.value.toLowerCase() || '';
                loadOtherItems(searchTerm);
            }

            async function loadOtherItems(search = '') {
                try {
                    // Lấy dữ liệu từ accessories thay vì inventory
                    const response = await fetch(`${API_BASE}/accessories`);
                    const result = await response.json();

                    console.log('Load other items response:', result); // Debug

                    if (result.success) {
                        let items = result.data || [];

                        // Danh sách các category thuộc Vật tư phụ
                        const vatTuPhuCategories = ['Ke', 'Gioăng', 'Nhựa ốp', 'Keo', 'Khác'];

                        // Lọc chỉ giữ các items thuộc category Vật tư phụ
                        items = items.filter(item => vatTuPhuCategories.includes(item.category));

                        // Map category sang sub-tab
                        const subCategoryMap = {
                            'ke': 'Ke',
                            'gioang': 'Gioăng',
                            'nhua-op': 'Nhựa ốp',
                            'keo': 'Keo',
                            'khac': 'Khác'
                        };
                        const subCategoryName = subCategoryMap[currentSubTab] || 'Ke';

                        // Lọc theo sub-tab hiện tại (dựa trên category)
                        items = items.filter(item => item.category === subCategoryName);

                        // Chuyển đổi format cho hiển thị
                        items = items.map(item => {
                            const qty = parseFloat(item.stock_quantity) || 0;
                            const price = parseFloat(item.sale_price || item.purchase_price) || 0;
                            return {
                                id: item.id,
                                item_code: item.code,
                                item_name: item.name,
                                description: item.category,
                                unit: item.unit,
                                quantity: qty,
                                stock_quantity: qty,
                                unit_price: price
                            };
                        });

                        if (search) {
                            const searchLower = search.toLowerCase();
                            items = items.filter(item =>
                                (item.item_code && item.item_code.toLowerCase().includes(searchLower)) ||
                                (item.item_name && item.item_name.toLowerCase().includes(searchLower))
                            );
                        }

                        console.log('Processed items:', items); // Debug
                        displayOtherItems(items);
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            async function openOtherModal(id = null) {
                editingOtherId = id;
                document.getElementById('otherModalTitle').textContent = id ? 'Chỉnh sửa vật tư phụ' : 'Thêm vật tư phụ';
                document.getElementById('otherForm').reset();
                document.getElementById('otherId').value = id || '';

                // Set default sub-category based on current sub-tab
                if (!id) {
                    const subCategoryMap = {
                        'ke': 'Ke',
                        'gioang': 'Gioăng',
                        'nhua-op': 'Nhựa ốp',
                        'keo': 'Keo',
                        'khac': 'Khác'
                    };
                    const subCategoryEl = document.getElementById('otherSubCategory');
                    if (subCategoryEl) {
                        subCategoryEl.value = subCategoryMap[currentSubTab] || 'Ke';
                    }

                    // Tự động tạo mã VRPK khi thêm mới
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`${API_BASE}/inventory/next-vrpk-code`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        if (response.ok) {
                            const result = await response.json();
                            if (result.success && result.data) {
                                const codeEl = document.getElementById('otherCode');
                                if (codeEl) {
                                    codeEl.value = result.data.code;
                                    codeEl.readOnly = true;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Lỗi khi lấy mã VRPK:', error);
                    }
                }

                if (id) {
                    loadOtherForEdit(id);
                }

                document.getElementById('otherModal').classList.remove('hidden');
            }

            function closeOtherModal() {
                document.getElementById('otherModal').classList.add('hidden');
                editingOtherId = null;
            }

            async function loadOtherForEdit(id) {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/inventory/${id}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        const item = result.data;
                        const codeEl = document.getElementById('otherCode');
                        if (codeEl) {
                            codeEl.value = item.item_code || '';
                            codeEl.readOnly = false; // Cho phép chỉnh sửa mã khi edit
                        }

                        // Parse description to extract sub-category
                        const description = item.description || '';
                        const subCategoryEl = document.getElementById('otherSubCategory');

                        // Check if description contains sub-category
                        const subCategories = ['Ke', 'Gioăng', 'Nhựa ốp', 'Keo', 'Khác'];
                        let foundSubCategory = 'Ke'; // Default

                        for (const subCat of subCategories) {
                            if (description.includes(subCat)) {
                                foundSubCategory = subCat;
                                break;
                            }
                        }

                        if (subCategoryEl) {
                            subCategoryEl.value = foundSubCategory;
                        }

                        document.getElementById('otherName').value = item.item_name || '';
                        document.getElementById('otherUnit').value = item.unit || '';
                        document.getElementById('otherPrice').value = item.unit_price || '';
                        // Hiển thị tồn kho - ưu tiên quantity, sau đó stock_quantity
                        const stockValue = item.quantity || item.stock_quantity || 0;
                        document.getElementById('otherStock').value = stockValue;
                        document.getElementById('otherMinStock').value = item.min_stock_level || 10;
                        document.getElementById('otherDescription').value = item.notes || '';
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            async function saveOther(event) {
                event.preventDefault();

                const codeEl = document.getElementById('otherCode');
                const nameEl = document.getElementById('otherName');
                const subCategoryEl = document.getElementById('otherSubCategory');
                const unitEl = document.getElementById('otherUnit');

                // Validation
                if (!codeEl || !codeEl.value.trim()) {
                    alert('Vui lòng nhập mã vật tư');
                    if (codeEl) codeEl.focus();
                    return;
                }
                if (!nameEl || !nameEl.value.trim()) {
                    alert('Vui lòng nhập tên vật tư');
                    if (nameEl) nameEl.focus();
                    return;
                }
                if (!subCategoryEl || !subCategoryEl.value) {
                    alert('Vui lòng chọn danh mục');
                    if (subCategoryEl) subCategoryEl.focus();
                    return;
                }
                if (!unitEl || !unitEl.value.trim()) {
                    alert('Vui lòng nhập đơn vị');
                    if (unitEl) unitEl.focus();
                    return;
                }

                const id = editingOtherId;

                // Parse number - đảm bảo là number, không phải string
                // Remove dấu phẩy, dấu chấm (format số) trước khi parse
                const stockInput = document.getElementById('otherStock').value;
                const quantity = stockInput ? parseFloat(stockInput.toString().replace(/[,\.]/g, '').replace(',', '.')) : 0;

                const priceInput = document.getElementById('otherPrice').value;
                // Remove tất cả dấu phẩy, dấu chấm (format tiền) trước khi parse
                const unitPrice = priceInput ? parseFloat(priceInput.toString().replace(/[^\d]/g, '')) : 0;

                // Get sub-category
                const subCategory = subCategoryEl ? subCategoryEl.value : '';

                // Use subCategory as description
                const description = subCategory || null;

                const data = {
                    item_code: codeEl.value.trim(),
                    item_name: nameEl.value.trim(),
                    item_type: 'other',
                    unit: unitEl.value.trim(),
                    quantity: quantity, // Tồn kho - PHẢI là number
                    min_stock_level: parseInt(document.getElementById('otherMinStock').value) || 10,
                    unit_price: unitPrice, // Giá - PHẢI là number
                    description: description || null,
                    notes: document.getElementById('otherDescription').value ? document.getElementById('otherDescription').value.trim() : null
                };

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const url = id ? `${API_BASE}/inventory/${id}` : `${API_BASE}/inventory`;
                    const method = id ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification(id ? 'Cập nhật vật tư thành công!' : 'Thêm vật tư thành công!');
                        closeOtherModal();
                        // Reload với search term hiện tại - đợi một chút để đảm bảo DB đã cập nhật
                        setTimeout(() => {
                            const searchTerm = document.getElementById('searchOther').value || '';
                            loadOtherItems(searchTerm);
                            loadStats();
                        }, 100);
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể lưu'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            async function editOther(id) {
                openOtherModal(id);
            }

            async function deleteOther(id) {
                if (!confirm('Bạn có chắc muốn xóa vật tư này?')) return;

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/inventory/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Xóa vật tư thành công!');
                        // Reload với search term hiện tại
                        const searchTerm = document.getElementById('searchOther').value || '';
                        loadOtherItems(searchTerm);
                        loadStats(); // Cập nhật stats tổng hợp
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể xóa'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            // ==== XUẤT VẬT TƯ CHO DỰ ÁN ====
            let selectedMaterials = {}; // Lưu vật tư đã chọn theo loại: {accessory: [...], aluminum: [...], ...}
            let currentMaterialType = 'accessory';

            // Helper function để escape HTML (tránh XSS)
            function escapeHtml(str) {
                if (!str && str !== 0) return '';
                const div = document.createElement('div');
                div.textContent = String(str);
                return div.innerHTML.replace(/'/g, "\\'");
            }

            async function loadProjectsForExport() {
                try {
                    const response = await fetch(`${API_BASE}/project-materials/projects/bom-extraction`);
                    const result = await response.json();
                    const select = document.getElementById('exportProjectSelect');

                    if (result.success && select) {
                        select.innerHTML = '<option value="">-- Chọn dự án để xuất vật tư --</option>';
                        result.data.forEach(p => {
                            select.innerHTML += `<option value="${p.id}">${p.project_code} - ${p.project_name} (${p.customer_name || 'N/A'})</option>`;
                        });
                    }
                } catch (error) {
                    console.error('Lỗi tải dự án:', error);
                }
            }


            function getMaterialTypeName(type) {
                const names = { accessory: 'Phụ kiện', aluminum: 'Hệ nhôm', glass: 'Kính', other: 'Khác' };
                return names[type] || type;
            }

            function getMaterialTypeColor(type) {
                const colors = { accessory: 'bg-blue-100 text-blue-700', aluminum: 'bg-orange-100 text-orange-700', glass: 'bg-teal-100 text-teal-700', other: 'bg-gray-100 text-gray-700' };
                return colors[type] || 'bg-gray-100 text-gray-700';
            }

            function openAddMaterialModal() {
                document.getElementById('addMaterialModal').classList.remove('hidden');
                // Khởi tạo selectedMaterials nếu chưa có
                if (Object.keys(selectedMaterials).length === 0) {
                    selectedMaterials = { accessory: [], aluminum: [], glass: [], other: [] };
                }
                loadInventoryByType('accessory');
            }

            function closeAddMaterialModal() {
                document.getElementById('addMaterialModal').classList.add('hidden');
                selectedMaterials = {}; // Reset khi đóng modal
            }

            async function loadInventoryByType(type) {
                currentMaterialType = type;
                const tbody = document.getElementById('inventorySelectTable');

                // Highlight nút đang chọn
                document.querySelectorAll('.inventory-type-btn').forEach(btn => {
                    btn.classList.remove('bg-teal-500', 'text-white');
                    btn.classList.add('border-gray-300');
                });
                document.querySelector(`.inventory-type-btn[data-type="${type}"]`)?.classList.add('bg-teal-500', 'text-white');

                tbody.innerHTML = '<tr><td colspan="6" class="px-3 py-8 text-center text-gray-500">Đang tải...</td></tr>';

                try {
                    const response = await fetch(`${API_BASE}/project-materials/inventory/${type}`);
                    const result = await response.json();

                    if (result.success && result.data.length > 0) {
                        tbody.innerHTML = result.data.map(item => {
                            // Kiểm tra nếu đã chọn trước đó
                            const existingSelection = (selectedMaterials[type] || []).find(s => s.id === item.id);
                            const isChecked = existingSelection ? 'checked' : '';
                            const qty = existingSelection ? existingSelection.quantity : 1;
                            const notes = existingSelection ? existingSelection.notes : '';

                            return `
                        <tr>
                            <td class="px-3 py-2"><input type="checkbox" class="material-checkbox" data-id="${item.id}" data-name="${item.name}" data-unit="${item.unit || 'cái'}" data-price="${item.price || 0}" ${isChecked}></td>
                            <td class="px-3 py-2 text-sm font-medium">${item.name}</td>
                            <td class="px-3 py-2 text-sm">${item.stock || 0} ${item.unit || 'cái'}</td>
                            <td class="px-3 py-2 text-sm">${formatCurrency(item.price || 0)}</td>
                            <td class="px-3 py-2"><input type="number" class="material-qty w-full px-2 py-1 border rounded text-center" min="0.01" step="0.01" value="${qty}" data-id="${item.id}"></td>
                            <td class="px-3 py-2"><input type="text" class="material-notes w-full px-2 py-1 border rounded" placeholder="Ghi chú..." data-id="${item.id}" value="${notes}"></td>
                        </tr>
                    `}).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" class="px-3 py-8 text-center text-gray-500">Không có vật tư nào trong kho</td></tr>';
                    }
                    updateSelectedCount();
                } catch (error) {
                    console.error('Lỗi:', error);
                    tbody.innerHTML = '<tr><td colspan="6" class="px-3 py-8 text-center text-red-500">Lỗi tải dữ liệu</td></tr>';
                }
            }

            function toggleSelectAllMaterials() {
                const selectAll = document.getElementById('selectAllMaterials').checked;
                document.querySelectorAll('.material-checkbox').forEach(cb => cb.checked = selectAll);
                saveCurrentSelections();
                updateSelectedCount();
            }

            // Lưu lựa chọn hiện tại trước khi chuyển tab
            function saveCurrentSelections() {
                const selections = [];
                document.querySelectorAll('.material-checkbox:checked').forEach(cb => {
                    const id = parseInt(cb.dataset.id);
                    const qtyInput = document.querySelector(`.material-qty[data-id="${id}"]`);
                    const notesInput = document.querySelector(`.material-notes[data-id="${id}"]`);
                    selections.push({
                        id: id,
                        name: cb.dataset.name,
                        unit: cb.dataset.unit,
                        price: parseFloat(cb.dataset.price) || 0,
                        quantity: parseFloat(qtyInput?.value) || 1,
                        notes: notesInput?.value || ''
                    });
                });
                selectedMaterials[currentMaterialType] = selections;
            }

            // Event listener cho checkboxes
            document.addEventListener('change', function (e) {
                if (e.target.classList.contains('material-checkbox')) {
                    saveCurrentSelections();
                    updateSelectedCount();
                }
            });

            function updateSelectedCount() {
                let total = 0;
                Object.values(selectedMaterials).forEach(arr => total += arr.length);
                document.getElementById('selectedMaterialsCount').textContent = `Đã chọn: ${total} vật tư`;
            }

            async function addSelectedMaterials() {
                saveCurrentSelections(); // Lưu lại lựa chọn cuối cùng

                const projectId = document.getElementById('exportProjectSelect').value;
                if (!projectId) {
                    alert('Vui lòng chọn dự án!');
                    return;
                }

                // Gom tất cả vật tư đã chọn từ tất cả loại
                const allMaterials = [];
                Object.entries(selectedMaterials).forEach(([type, items]) => {
                    items.forEach(item => {
                        if (item.quantity > 0) {
                            allMaterials.push({
                                material_type: type,
                                material_id: item.id,
                                material_name: item.name,
                                quantity: item.quantity,
                                unit: item.unit,
                                unit_price: item.price,
                                notes: item.notes
                            });
                        }
                    });
                });

                if (allMaterials.length === 0) {
                    alert('Vui lòng chọn ít nhất 1 vật tư!');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/project-materials`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ project_id: parseInt(projectId), materials: allMaterials })
                    });
                    const result = await response.json();

                    if (result.success) {
                        alert(`Đã thêm ${allMaterials.length} vật tư vào dự án!`);
                        closeAddMaterialModal();
                        loadProjectMaterials();
                        loadStats(); // Cập nhật thống kê tồn kho
                    } else {
                        alert('Lỗi khi thêm vật tư: ' + result.message);
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server!');
                }
            }

            async function deleteProjectMaterial(id) {
                if (!confirm('Xóa vật tư này? Tồn kho sẽ được hoàn lại.')) return;

                try {
                    const response = await fetch(`${API_BASE}/project-materials/${id}`, { method: 'DELETE' });
                    const result = await response.json();
                    if (result.success) {
                        alert('Đã xóa và hoàn lại tồn kho!');
                        loadProjectMaterials();
                        loadStats();
                    } else {
                        alert('Lỗi: ' + result.message);
                    }
                } catch (error) {
                    alert('Lỗi kết nối!');
                }
            }

            function openEditMaterial(id, name, quantity, notes) {
                try {
                    const modal = document.getElementById('editMaterialModal');
                    if (!modal) {
                        console.error('Modal editMaterialModal not found');
                        alert('Không tìm thấy form chỉnh sửa. Vui lòng tải lại trang.');
                        return;
                    }

                    document.getElementById('editMaterialId').value = id || '';
                    document.getElementById('editMaterialName').value = name || '';
                    document.getElementById('editMaterialQuantity').value = quantity || 0;
                    document.getElementById('editMaterialNotes').value = notes || '';
                    modal.classList.remove('hidden');
                } catch (error) {
                    console.error('Error opening edit modal:', error);
                    alert('Lỗi khi mở form chỉnh sửa: ' + error.message);
                }
            }

            function closeEditMaterialModal() {
                document.getElementById('editMaterialModal').classList.add('hidden');
            }

            async function saveEditMaterial(e) {
                e.preventDefault();
                const id = document.getElementById('editMaterialId').value;
                const quantityInput = document.getElementById('editMaterialQuantity').value;
                const notes = document.getElementById('editMaterialNotes').value || '';

                // Validate quantity
                const quantity = parseFloat(quantityInput);
                if (isNaN(quantity) || quantity <= 0) {
                    alert('Vui lòng nhập số lượng hợp lệ (lớn hơn 0)');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/project-materials/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            quantity: quantity,
                            notes: notes
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API error:', errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        alert('Cập nhật thành công!');
                        closeEditMaterialModal();
                        loadProjectMaterials();
                        loadStats();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể cập nhật'));
                    }
                } catch (error) {
                    console.error('Lỗi cập nhật:', error);
                    alert('Lỗi kết nối: ' + error.message);
                }
            }

            // Initialize
            // Function to initialize page data
            function initializeInventoryPage() {
                loadCompanyLogo();
                if (checkAuth()) {
                    loadSidebarUserInfo();
                    loadHeaderUserInfo();
                    loadUnreadCount();

                    // Refresh notifications every 30 seconds
                    setInterval(() => {
                        loadUnreadCount();
                    }, 30000);
                }

                // Load stats tổng hợp ngay khi trang load
                loadStats();
                loadAccessories();
                loadProjectsForExport(); // Load dự án cho tab Xuất vật tư

                // Check URL parameter for auto-switch to export tab
                const urlParams = new URLSearchParams(window.location.search);
                const tabParam = urlParams.get('tab');
                if (tabParam === 'export') {
                    // Auto-switch to export tab
                    setTimeout(() => {
                        const exportTabButton = document.querySelector('.tab-button[onclick*="transactions"]');
                        if (exportTabButton) {
                            switchTab('transactions', exportTabButton);

                            // Auto-select project if available in sessionStorage
                            const autoSelect = sessionStorage.getItem('autoSelectProject');
                            const exportProjectId = sessionStorage.getItem('exportProjectId');
                            if (autoSelect === 'true' && exportProjectId) {
                                setTimeout(() => {
                                    const projectSelect = document.getElementById('exportProjectSelect');
                                    if (projectSelect) {
                                        projectSelect.value = exportProjectId;
                                        // Trigger change event to load project materials
                                        const changeEvent = new Event('change', { bubbles: true });
                                        projectSelect.dispatchEvent(changeEvent);
                                        // Clear the flag
                                        sessionStorage.removeItem('autoSelectProject');
                                    }
                                }, 500); // Wait for projects to load
                            }
                        }
                    }, 300);
                }

                // Tự động refresh stats mỗi 10 giây để cập nhật realtime
                setInterval(() => {
                    loadStats();
                }, 10000); // 10 giây

                // Tự động refresh dữ liệu mỗi 30 giây để cập nhật realtime
                setInterval(() => {
                    const tabAccessory = document.getElementById('tab-accessory');
                    const tabAluminum = document.getElementById('tab-aluminum');
                    const tabGlass = document.getElementById('tab-glass');
                    const tabOther = document.getElementById('tab-other');

                    if (tabAccessory && tabAccessory.classList.contains('active')) {
                        loadAccessories();
                    } else if (tabAluminum && tabAluminum.classList.contains('active')) {
                        loadAluminumSystems();
                    } else if (tabGlass && tabGlass.classList.contains('active')) {
                        loadGlassItems();
                    } else if (tabOther && tabOther.classList.contains('active')) {
                        loadOtherItems();
                    }
                }, 30000); // 30 giây
            }

            // Listen for both DOMContentLoaded and SPA navigation
            document.addEventListener('DOMContentLoaded', initializeInventoryPage);

            // Listen for SPA page load event
            document.addEventListener('spaPageLoad', function (e) {
                if (e.detail.href && e.detail.href.includes('inventory.html')) {
                    // Small delay to ensure DOM is ready
                    setTimeout(initializeInventoryPage, 100);
                }
            });
        </script>

        <style>
            .icon-square {
                width: 48px;
                height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 8px;
            }
        </style>
    </div> <!-- End main-content -->
    <script src="js/sidebar-enterprise.js"></script>
    <script src="js/notification-header.js"></script>
    <script src="js/success-notification.js"></script>
</body>

</html>