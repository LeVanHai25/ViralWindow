<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thiết kế cửa 2D - ViralWindow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #drawingCanvas {
            border: 1px solid #ddd;
            cursor: crosshair;
            display: block;
            background: #ffffff;
        }
        .toolbar-btn {
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
        }
        .toolbar-btn:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
        }
        .toolbar-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .toolbar-group {
            border-right: 1px solid #e5e7eb;
            padding-right: 8px;
            margin-right: 8px;
        }
        .toolbar-group:last-child {
            border-right: none;
        }
        /* Grid background for canvas container */
        #canvasContainer {
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: #f5f5f5;
        }
    </style>
</head>
<body class="bg-gray-50" onload="init()">
    <!-- TOP HEADER WITH TABS -->
    <div class="bg-gray-800 text-white">
        <!-- Main Tabs -->
        <div class="flex items-center border-b border-gray-700">
            <button class="px-6 py-3 bg-gray-900 font-semibold border-b-2 border-blue-500" onclick="switchMainTab('design')">
                THIẾT KẾ
            </button>
            <button class="px-6 py-3 hover:bg-gray-700 font-semibold" onclick="switchMainTab('bom')">
                BOM
            </button>
            <button class="px-6 py-3 hover:bg-gray-700 font-semibold" onclick="switchMainTab('cutting')">
                TỐI ƯU CẮT
            </button>
            <button class="px-6 py-3 hover:bg-gray-700 font-semibold" onclick="switchMainTab('estimate')">
                DỰ TOÁN
            </button>
            <button class="px-6 py-3 hover:bg-gray-700 font-semibold" onclick="switchMainTab('manufacturing')">
                GIA CÔNG
            </button>
            <button class="px-6 py-3 hover:bg-gray-700 font-semibold" onclick="switchMainTab('accessories')">
                PHỤ KIỆN - GIÁ
            </button>
            
            <!-- Center Button -->
            <div class="flex-1 flex justify-center">
                <button class="px-6 py-2 bg-gray-900 hover:bg-gray-700 rounded font-semibold" onclick="viewProduction()">
                    XEM SẢN XUẤT
                </button>
            </div>
            
            <!-- Right Action Buttons -->
            <div class="flex items-center gap-2 px-4">
                <button onclick="saveDrawing()" class="px-4 py-2 hover:bg-gray-700 rounded flex items-center gap-2" title="Lưu">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                    <span class="text-sm">Lưu</span>
                </button>
                <button onclick="undo()" class="px-4 py-2 hover:bg-gray-700 rounded flex items-center gap-2" title="Undo">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                    </svg>
                    <span class="text-sm">Undo</span>
                </button>
                <button onclick="openToleranceSettings()" class="px-4 py-2 hover:bg-gray-700 rounded flex items-center gap-2" title="Độ hỡ">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                    <span class="text-sm">Độ hỡ</span>
                </button>
                <button onclick="openSettings()" class="px-4 py-2 hover:bg-gray-700 rounded flex items-center gap-2" title="Cài đặt">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="text-sm">Cài đặt</span>
                </button>
            </div>
        </div>
        
        <!-- Sub-tabs for THIẾT KẾ -->
        <div id="designSubTabs" class="flex items-center bg-gray-700 border-b border-gray-600">
            <button class="px-4 py-2 hover:bg-gray-600 text-sm font-medium border-b-2 border-blue-400" onclick="switchSubTab('dimension-split')">
                KT chia
            </button>
            <button class="px-4 py-2 hover:bg-gray-600 text-sm font-medium" onclick="switchSubTab('fengshui')">
                Lỗ Ban
            </button>
            <button class="px-4 py-2 hover:bg-gray-600 text-sm font-medium" onclick="switchSubTab('cross-section')">
                Mặt cắt
            </button>
            <button class="px-4 py-2 hover:bg-gray-600 text-sm font-medium" onclick="switchSubTab('components')">
                C.Thanh
            </button>
        </div>
    </div>

    <!-- TOP TOOLBAR - Design Tools -->
    <div id="dimensionSplitToolbar" class="flex items-center gap-2 border-b border-gray-200 px-4 py-2 bg-white">
        <!-- New items -->
        <div class="flex items-center gap-1">
            <button id="btnNewRec"
                class="px-3 py-1.5 text-xs rounded bg-blue-600 text-white hover:bg-blue-700 flex items-center gap-1"
                title="Tạo cửa hình chữ nhật">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                </svg>
                Rec.
            </button>
            <button id="btnNewNonRec"
                class="px-3 py-1.5 text-xs rounded bg-indigo-600 text-white hover:bg-indigo-700 flex items-center gap-1"
                title="Tạo cửa dạng đặc biệt">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Non-Rec.
            </button>
            <button id="btnImportDoor"
                class="px-3 py-1.5 text-xs rounded bg-gray-700 text-white hover:bg-gray-800 flex items-center gap-1"
                title="Import từ template hoặc cửa khác">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                Import
            </button>
        </div>

        <div class="h-6 w-px bg-gray-300 mx-2"></div>

        <!-- Mullion -->
        <div class="flex items-center gap-1">
            <span class="text-xs text-gray-500 mr-1">Chia đố:</span>
            <button id="btnSplitVertical"
                class="px-2 py-1.5 text-xs rounded border border-gray-300 hover:bg-gray-100 flex items-center gap-1"
                title="Chia dọc">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                Dọc
            </button>
            <button id="btnSplitHorizontal"
                class="px-2 py-1.5 text-xs rounded border border-gray-300 hover:bg-gray-100 flex items-center gap-1"
                title="Chia ngang">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                </svg>
                Ngang
            </button>
        </div>

        <div class="h-6 w-px bg-gray-300 mx-2"></div>

        <!-- Panel Coupling -->
        <div class="flex items-center gap-1">
            <span class="text-xs text-gray-500 mr-1">Ghép khung:</span>
            <button id="btnCoupleVertical"
                class="px-2 py-1.5 text-xs rounded border border-gray-300 hover:bg-gray-100 flex items-center gap-1"
                title="Ghép khung dọc">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                </svg>
                Dọc
            </button>
            <button id="btnCoupleHorizontal"
                class="px-2 py-1.5 text-xs rounded border border-gray-300 hover:bg-gray-100 flex items-center gap-1"
                title="Ghép khung ngang">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                </svg>
                Ngang
            </button>
        </div>

        <div class="h-6 w-px bg-gray-300 mx-2"></div>

        <!-- Window types -->
        <div class="flex items-center gap-1">
            <span class="text-xs text-gray-500 mr-1">Cửa sổ:</span>
            <button id="btnTypeFixed" class="tool-type px-2 py-1.5 text-xs border rounded hover:bg-gray-100 flex items-center gap-1" title="Cố định">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                </svg>
                Fixed
            </button>
            <button id="btnTypeTurnLeft" class="tool-type px-2 py-1.5 text-xs border rounded hover:bg-gray-100 flex items-center gap-1" title="Mở quay trái">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Quay Trái
            </button>
            <button id="btnTypeTurnRight" class="tool-type px-2 py-1.5 text-xs border rounded hover:bg-gray-100 flex items-center gap-1" title="Mở quay phải">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
                Quay Phải
            </button>
            <button id="btnTypeTilt" class="tool-type px-2 py-1.5 text-xs border rounded hover:bg-gray-100 flex items-center gap-1" title="Mở hất">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                </svg>
                Hất
            </button>
            <button id="btnTypeTiltTurn" class="tool-type px-2 py-1.5 text-xs border rounded hover:bg-gray-100 flex items-center gap-1" title="Hất và quay">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Tilt&Turn
            </button>
            <button id="btnTypeTiltSlide" class="tool-type px-2 py-1.5 text-xs border rounded hover:bg-gray-100 flex items-center gap-1" title="Hất và trượt">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18" />
                </svg>
                Tilt&Slide
            </button>
        </div>

        <div class="h-6 w-px bg-gray-300 mx-2"></div>

        <!-- Sliding / Door -->
        <div class="flex items-center gap-1">
            <span class="text-xs text-gray-500 mr-1">Trượt:</span>
            <button id="btnTypeSlide2" class="tool-type px-2 py-1.5 text-xs border rounded hover:bg-gray-100" title="Trượt 2 cánh">2 cánh</button>
            <button id="btnTypeSlide3" class="tool-type px-2 py-1.5 text-xs border rounded hover:bg-gray-100" title="Trượt 3 cánh">3 cánh</button>
            <button id="btnTypeSlide4" class="tool-type px-2 py-1.5 text-xs border rounded hover:bg-gray-100" title="Trượt 4 cánh">4 cánh</button>
        </div>

        <div class="h-6 w-px bg-gray-300 mx-2"></div>

        <!-- Door types -->
        <div class="flex items-center gap-1">
            <span class="text-xs text-gray-500 mr-1">Cửa đi:</span>
            <button id="btnTypeFrench" class="tool-type px-2 py-1.5 text-xs border rounded hover:bg-gray-100 flex items-center gap-1" title="Cửa Pháp">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                </svg>
                French
            </button>
            <button id="btnTypeSingleSide" class="tool-type px-2 py-1.5 text-xs border rounded hover:bg-gray-100 flex items-center gap-1" title="Cửa 1 cánh">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
                1 cánh
            </button>
        </div>
    </div>

    <!-- OLD TOOLBAR (Hidden - chức năng đã chuyển vào sub-tabs) -->
    <div class="bg-white border-b border-gray-200 shadow-sm hidden" id="oldToolbar">
        <!-- Main Toolbar -->
        <div class="flex items-center gap-2 px-4 py-2 overflow-x-auto">
            <!-- Tạo mới -->
            <div class="toolbar-group flex items-center gap-1">
                <button onclick="newDrawing()" class="toolbar-btn px-3 py-2 rounded text-sm font-medium flex items-center gap-2 bg-white">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Tạo mới cửa
                </button>
                <button onclick="newCabinet()" class="toolbar-btn px-3 py-2 rounded text-sm font-medium flex items-center gap-2 bg-white">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    Tạo mới tủ
                </button>
            </div>

            <!-- Tách khung -->
            <div class="toolbar-group flex items-center gap-1">
                <span class="text-xs text-gray-600 font-medium px-2 whitespace-nowrap">Tách khung:</span>
                <button onclick="addVerticalMullion()" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white hover:bg-blue-50 flex flex-col items-center" title="Ngang Đứng - Thêm thanh chia dọc">
                    <div class="w-6 h-6 flex items-center justify-center">
                        <div class="flex flex-col gap-1">
                            <div class="w-4 h-0.5 bg-gray-600"></div>
                            <div class="w-4 h-0.5 bg-gray-600"></div>
                        </div>
                        <div class="flex flex-col gap-1 ml-1">
                            <div class="w-0.5 h-4 bg-gray-600"></div>
                            <div class="w-0.5 h-4 bg-gray-600"></div>
                        </div>
                    </div>
                    <span class="text-xs mt-1">Ngang Đứng</span>
                </button>
                <button onclick="splitFrame()" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white hover:bg-blue-50 flex flex-col items-center" title="Tách khung - Thêm thanh chia dọc">
                    <div class="w-6 h-6 flex items-center justify-center">
                        <div class="flex gap-1">
                            <div class="w-0.5 h-4 bg-gray-600"></div>
                            <div class="w-0.5 h-4 bg-gray-600"></div>
                        </div>
                    </div>
                    <span class="text-xs mt-1">Tách khung</span>
                </button>
            </div>

            <!-- Chia đố -->
            <div class="toolbar-group flex items-center gap-1">
                <span class="text-xs text-gray-600 font-medium px-2 whitespace-nowrap">Chia đố:</span>
                <button onclick="openDivideModal('vertical')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white hover:bg-blue-50 flex flex-col items-center" title="Chia dọc - Thêm thanh chia dọc">
                    <div class="w-6 h-6 flex items-center justify-center">
                        <div class="flex gap-1">
                            <div class="w-0.5 h-4 bg-gray-600"></div>
                            <div class="w-0.5 h-4 bg-gray-600"></div>
                        </div>
                    </div>
                    <span class="text-xs mt-1">Chia dọc</span>
                </button>
                <button onclick="openDivideModal('horizontal')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white hover:bg-blue-50 flex flex-col items-center" title="Chia ngang - Thêm thanh chia ngang">
                    <div class="w-6 h-6 flex items-center justify-center">
                        <div class="flex flex-col gap-1">
                            <div class="w-4 h-0.5 bg-gray-600"></div>
                            <div class="w-4 h-0.5 bg-gray-600"></div>
                        </div>
                    </div>
                    <span class="text-xs mt-1">Chia ngang</span>
                </button>
                <button onclick="addHorizontalMullion()" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white hover:bg-blue-50 flex flex-col items-center" title="Chia đố nhanh - Chia đều giữa">
                    <div class="w-6 h-6 flex items-center justify-center">
                        <div class="w-4 h-0.5 bg-gray-600"></div>
                    </div>
                    <span class="text-xs mt-1">Chia đều</span>
                </button>
            </div>

            <!-- Đổi hướng -->
            <div class="toolbar-group flex items-center gap-1">
                <span class="text-xs text-gray-600 font-medium px-2 whitespace-nowrap">Đổi hướng:</span>
                <button onclick="flipHorizontal()" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white hover:bg-blue-50 flex flex-col items-center" title="Đảo ngang - Đổi trái/phải">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                    </svg>
                    <span class="text-xs mt-1">Đảo ngang</span>
                </button>
                <button onclick="flipVertical()" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white hover:bg-blue-50 flex flex-col items-center" title="Đảo dọc - Đổi trên/dưới">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                    </svg>
                    <span class="text-xs mt-1">Đảo dọc</span>
                </button>
                <button onclick="changePanelDirection()" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white hover:bg-blue-50 flex flex-col items-center" title="Đổi hướng mở - Trái/Phải">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                    <span class="text-xs mt-1">Đổi mở</span>
                </button>
            </div>

            <!-- Cửa sổ mở quay -->
            <div class="toolbar-group flex items-center gap-1">
                <span class="text-xs text-gray-600 font-medium px-2">Cửa sổ mở quay:</span>
                <button onclick="loadTemplateByCode('CS1_LEFT')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">Trái</button>
                <button onclick="loadTemplateByCode('CS1_RIGHT')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">Phải</button>
                <button onclick="loadTemplateByCode('WH')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">Hất</button>
                <button onclick="loadTemplateByCode('CS2')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">2 cánh</button>
            </div>

            <!-- Cửa đi mở quay ngoài -->
            <div class="toolbar-group flex items-center gap-1">
                <span class="text-xs text-gray-600 font-medium px-2">Cửa đi mở quay ngoài:</span>
                <button onclick="loadTemplateByCode('D1_LEFT_OUT')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">Trái</button>
                <button onclick="loadTemplateByCode('D1_RIGHT_OUT')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">Phải</button>
                <button onclick="loadTemplateByCode('D2')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">2 cánh</button>
                <button onclick="loadTemplateByCode('D4')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">4 cánh</button>
            </div>

            <!-- Cửa đi mở quay trong -->
            <div class="toolbar-group flex items-center gap-1">
                <span class="text-xs text-gray-600 font-medium px-2">Cửa đi mở quay trong:</span>
                <button onclick="loadTemplateByCode('D1_LEFT_IN')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">Trái</button>
                <button onclick="loadTemplateByCode('D1_RIGHT_IN')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">Phải</button>
                <button onclick="loadTemplateByCode('D2_IN')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">2 cánh</button>
                <button onclick="loadTemplateByCode('D4_IN')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">4 cánh</button>
            </div>

            <!-- Cửa sổ mở trượt -->
            <div class="toolbar-group flex items-center gap-1">
                <span class="text-xs text-gray-600 font-medium px-2">Cửa sổ mở trượt:</span>
                <button onclick="loadTemplateByCode('CSL2')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">2 cánh</button>
                <button onclick="loadTemplateByCode('CSL3')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">3 cánh</button>
                <button onclick="loadTemplateByCode('CSL4')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">4 cánh</button>
            </div>

            <!-- Cửa đi mở trượt -->
            <div class="toolbar-group flex items-center gap-1">
                <span class="text-xs text-gray-600 font-medium px-2">Cửa đi mở trượt:</span>
                <button onclick="loadTemplateByCode('DL2')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">2 cánh</button>
                <button onclick="loadTemplateByCode('DL3')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">3 cánh</button>
                <button onclick="loadTemplateByCode('DL4')" class="toolbar-btn px-3 py-2 rounded text-sm font-medium bg-white">4 cánh</button>
            </div>
        </div>

        <!-- Secondary Toolbar -->
        <div class="flex items-center justify-between px-4 py-2 bg-gray-50 border-t border-gray-200">
            <div class="flex items-center gap-2">
                <button onclick="undo()" class="p-2 rounded hover:bg-gray-200" title="Hoàn tác">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                    </svg>
                </button>
                <button onclick="redo()" class="p-2 rounded hover:bg-gray-200" title="Làm lại">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" />
                    </svg>
                </button>
                <button onclick="deleteSelected()" class="p-2 rounded hover:bg-gray-200" title="Xóa">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <button onclick="changeGlassColor()" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600">
                Đổi màu kính
            </button>

            <div class="flex items-center gap-2">
                <button onclick="calculateBOM()" class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                    BÓC TÁCH BOM
                </button>
                <button onclick="openExportModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    XUẤT HÌNH
                </button>
                <button onclick="centerCanvas()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                    CANH GIỮA
                </button>
                <button onclick="saveDrawing()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                    LƯU HÌNH
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN CANVAS AREA -->
    <div class="flex h-[calc(100vh-140px)]">
        <!-- LEFT SIDEBAR - ITEMS LIST & PROPERTIES -->
        <div class="w-64 bg-gray-100 border-r border-gray-300 overflow-y-auto p-2 hidden md:block">
            <!-- Items List Section -->
            <div id="itemsListContainer" class="mb-4">
                <h2 class="font-bold text-gray-900 mb-2 text-xs border-b pb-2">Items List</h2>
                <div class="text-xs text-gray-500 text-center py-4">
                    Đang tải...
                </div>
            </div>
            
            <!-- Properties Section -->
            <div class="border-t pt-4">
            <h2 class="font-bold text-gray-900 mb-2 text-xs">Thuộc tính</h2>
            
            <!-- Panel Info -->
            <div id="panelInfo" class="mb-2 text-xs text-gray-500">
                Chưa chọn panel
            </div>
            
            <!-- Kích thước -->
            <div class="mb-2">
                <h3 class="text-xs font-semibold text-gray-700 mb-1">Kích thước</h3>
                <div class="space-y-1">
                    <div>
                        <label class="text-xs text-gray-600">Rộng (B) mm</label>
                        <input type="number" id="inputWidth" value="3200" min="300" max="5000" step="10"
                               onchange="updateDimensions()"
                               class="w-full px-1.5 py-1 border border-gray-300 rounded text-xs">
                    </div>
                    <div>
                        <label class="text-xs text-gray-600">Cao (H) mm</label>
                        <input type="number" id="inputHeight" value="2700" min="300" max="5000" step="10"
                               onchange="updateDimensions()"
                               class="w-full px-1.5 py-1 border border-gray-300 rounded text-xs">
                    </div>
                </div>
            </div>

            <!-- Hệ nhôm -->
            <div class="mb-2">
                <label class="block text-xs font-medium text-gray-700 mb-1">Hệ nhôm</label>
                <select id="selectAluminumSystem" onchange="updateDrawing()" 
                        class="w-full px-1.5 py-1 border border-gray-300 rounded text-xs">
                    <option value="">-- Chọn hệ nhôm --</option>
                </select>
            </div>

            <!-- Màu kính -->
            <div class="mb-2">
                <label class="block text-xs font-medium text-gray-700 mb-1">Màu kính</label>
                <div class="flex gap-1 flex-wrap">
                    <button onclick="setGlassColor('#87CEEB')" class="w-7 h-7 bg-blue-200 rounded border border-gray-300 hover:border-blue-500" title="Xanh nhạt"></button>
                    <button onclick="setGlassColor('#E0F2FE')" class="w-7 h-7 bg-blue-100 rounded border border-gray-300 hover:border-blue-500" title="Xanh rất nhạt"></button>
                    <button onclick="setGlassColor('#F0F9FF')" class="w-7 h-7 bg-blue-50 rounded border border-gray-300 hover:border-blue-500" title="Xanh cực nhạt"></button>
                    <button onclick="setGlassColor('#FFFFFF')" class="w-7 h-7 bg-white rounded border border-gray-300 hover:border-blue-500" title="Trắng"></button>
                </div>
            </div>

            <!-- Zoom controls -->
            <div class="mb-2">
                <label class="block text-xs font-medium text-gray-700 mb-1">Zoom</label>
                <input type="range" id="inputZoom" min="0.5" max="2" step="0.1" value="1" 
                       class="w-full">
                <div class="text-center text-xs text-gray-600 mt-0.5">
                    <span id="zoomLevel">100%</span>
                </div>
            </div>
            
            <!-- Action buttons -->
            <div class="space-y-1 mt-3">
                <button id="btnFlipH" class="w-full px-2 py-1.5 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                    Đảo ngang
                </button>
                <button id="btnFlipV" class="w-full px-2 py-1.5 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                    Đảo dọc
                </button>
                <button id="btnBom" class="w-full px-2 py-1.5 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                    BÓC TÁCH BOM
                </button>
                <button id="btnCenter" class="w-full px-2 py-1.5 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                    CANH GIỮA
                </button>
                <button id="btnExportImg" class="w-full px-2 py-1.5 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                    XUẤT HÌNH
                </button>
                <button id="btnSave" class="w-full px-2 py-1.5 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                    LƯU HÌNH
                </button>
            </div>
            </div>
        </div>

        <!-- CENTER CANVAS -->
        <div class="flex-1 flex flex-col bg-gray-50 overflow-hidden relative">
            <div class="flex-1 overflow-auto" id="canvasContainer">
                <div class="bg-white rounded-lg shadow-md p-4 inline-block m-4">
                    <canvas id="drawingCanvas" width="2000" height="1500"></canvas>
                    <canvas id="doorCanvas" width="2000" height="1500" style="display: none;"></canvas>
                </div>
            </div>
            
            <!-- RIGHT SIDEBAR - PROPERTIES INSPECTOR -->
            <div id="propertiesPanel" class="w-80 bg-white border-l border-gray-300 overflow-y-auto p-4 hidden lg:block">
                <h2 class="font-bold text-gray-900 mb-4 text-sm border-b pb-2">Properties</h2>
                
                <!-- Panel Properties (shown when panel selected) -->
                <div id="panelProperties" class="hidden">
                    <div class="mb-4">
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">Panel Information</h3>
                        <div class="space-y-2 text-xs">
                            <div>
                                <label class="text-gray-600">Panel ID:</label>
                                <div id="propPanelId" class="font-mono text-gray-800">-</div>
                            </div>
                            <div>
                                <label class="text-gray-600">Type:</label>
                                <div id="propPanelType" class="font-semibold text-gray-800">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">Dimensions (mm)</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-600">Width</label>
                                <input type="number" id="propWidth" class="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                       onchange="doorEditorUI.updatePanelProperty('width', this.value)">
                            </div>
                            <div>
                                <label class="text-xs text-gray-600">Height</label>
                                <input type="number" id="propHeight" class="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                       onchange="doorEditorUI.updatePanelProperty('height', this.value)">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">Opening Type</h3>
                        <select id="propOpeningType" class="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                onchange="doorEditorUI.updatePanelProperty('type', this.value)">
                            <option value="fixed">Fixed</option>
                            <option value="turn-left">Turn Left</option>
                            <option value="turn-right">Turn Right</option>
                            <option value="tilt">Tilt</option>
                            <option value="tilt-turn">Tilt & Turn</option>
                            <option value="tilt-slide">Tilt & Slide</option>
                            <option value="sliding-2">Sliding 2</option>
                            <option value="sliding-3">Sliding 3</option>
                            <option value="sliding-4">Sliding 4</option>
                            <option value="single-left">Door Single Left</option>
                            <option value="single-right">Door Single Right</option>
                            <option value="french">French Door</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">Aluminum System</h3>
                        <select id="propAluminumSystem" class="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                onchange="doorEditorUI.updatePanelProperty('aluminumSystem', this.value)">
                            <option value="">-- Select System --</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">Glass</h3>
                        <div class="space-y-2">
                            <div>
                                <label class="text-xs text-gray-600">Color</label>
                                <input type="color" id="propGlassColor" class="w-full h-8 border border-gray-300 rounded"
                                       onchange="doorEditorUI.updatePanelProperty('glassColor', this.value)">
                            </div>
                            <div>
                                <label class="text-xs text-gray-600">Type</label>
                                <select id="propGlassType" class="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                        onchange="doorEditorUI.updatePanelProperty('glassType', this.value)">
                                    <option value="8ly">8mm Low-E</option>
                                    <option value="10ly">10mm Low-E</option>
                                    <option value="8k">8mm Clear</option>
                                    <option value="10k">10mm Clear</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">Hardware</h3>
                        <div class="space-y-2 text-xs">
                            <div>
                                <label class="text-gray-600">Hinges:</label>
                                <input type="number" id="propHinges" min="0" max="5" class="w-16 px-1 py-0.5 border border-gray-300 rounded ml-2"
                                       onchange="doorEditorUI.updatePanelProperty('hinges', this.value)">
                            </div>
                            <div>
                                <label class="text-gray-600">Handle:</label>
                                <input type="checkbox" id="propHandle" class="ml-2"
                                       onchange="doorEditorUI.updatePanelProperty('handle', this.checked)">
                            </div>
                            <div>
                                <label class="text-gray-600">Lock:</label>
                                <input type="checkbox" id="propLock" class="ml-2"
                                       onchange="doorEditorUI.updatePanelProperty('lock', this.checked)">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">Opening Angle</h3>
                        <input type="range" id="propOpeningAngle" min="0" max="180" value="90" class="w-full"
                               onchange="doorEditorUI.updatePanelProperty('openingAngle', this.value)">
                        <div class="text-center text-xs text-gray-600 mt-1">
                            <span id="propOpeningAngleValue">90°</span>
                        </div>
                    </div>
                </div>
                
                <!-- Door Properties (shown when door selected) -->
                <div id="doorProperties">
                    <div class="text-xs text-gray-500 text-center py-8">
                        Select a panel to view properties
                    </div>
                </div>
            </div>
            
            <!-- BOTTOM BAR -->
            <div class="h-8 bg-gray-200 border-t border-gray-300 flex items-center justify-between px-4 text-xs text-gray-600">
                <div class="flex items-center gap-4">
                    <span id="zoomLevel">24.0</span>
                    <span id="cursorPosition">0</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="zoomOut()" class="p-1 hover:bg-gray-300 rounded" title="Zoom Out">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7" />
                        </svg>
                    </button>
                    <button onclick="zoomIn()" class="p-1 hover:bg-gray-300 rounded" title="Zoom In">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7" />
                        </svg>
                    </button>
                    <button onclick="fitToScreen()" class="p-1 hover:bg-gray-300 rounded" title="Fit to Screen">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- BOM CONTENT AREA -->
    <div id="bomContent" class="hidden h-[calc(100vh-140px)] bg-white p-6 overflow-y-auto">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Bóc Tách BOM</h2>
                <div class="flex gap-2">
                    <button onclick="generateBOM()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Bóc Tách BOM
                    </button>
                    <button onclick="exportBOMToExcel()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Xuất Excel
                    </button>
                    <button onclick="printBOM()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                        </svg>
                        In
                    </button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div id="bomSummary" class="grid grid-cols-4 gap-4 mb-6">
                <!-- Summary cards will be populated by JavaScript -->
            </div>

            <!-- Filter -->
            <div class="mb-4 flex items-center gap-4">
                <label class="text-sm font-medium text-gray-700">Lọc theo nhóm:</label>
                <div class="flex gap-2">
                    <button onclick="filterBOM('all')" class="px-3 py-1 bg-blue-600 text-white rounded text-sm bom-filter active" data-filter="all">Tất cả</button>
                    <button onclick="filterBOM('profile')" class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm bom-filter" data-filter="profile">Nhôm</button>
                    <button onclick="filterBOM('glass')" class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm bom-filter" data-filter="glass">Kính</button>
                    <button onclick="filterBOM('accessory')" class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm bom-filter" data-filter="accessory">Phụ kiện</button>
                    <button onclick="filterBOM('gasket')" class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm bom-filter" data-filter="gasket">Gioăng</button>
                </div>
            </div>

            <!-- BOM Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nhóm</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã VT</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quy cách</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Chiều dài (mm)</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">SL</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody id="bomTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                Chưa có dữ liệu BOM. Nhấn "Bóc Tách BOM" để tính toán.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- CUTTING OPTIMIZATION CONTENT AREA -->
    <div id="cuttingContent" class="hidden h-[calc(100vh-140px)] bg-white p-6 overflow-y-auto">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Tối Ưu Cắt</h2>
                <div class="flex gap-2">
                    <button onclick="generateCuttingPlan()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Tạo Kế Hoạch Cắt
                    </button>
                    <button onclick="exportCuttingPlanToExcel()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Xuất Excel
                    </button>
                    <button onclick="printCuttingPlan()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                        </svg>
                        In
                    </button>
                </div>
            </div>

            <!-- Settings -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                <div class="flex items-center gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Chiều dài cây (mm)</label>
                        <input type="number" id="cutStockLength" value="6000" min="1000" max="10000" step="100"
                               class="w-32 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Lưỡi cắt (kerf mm)</label>
                        <input type="number" id="cutKerf" value="3" min="0" max="10" step="0.5"
                               class="w-24 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Thuật toán</label>
                        <select id="cutAlgorithm" class="w-40 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="best-fit">Best Fit Decreasing</option>
                            <option value="first-fit">First Fit Decreasing</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div id="cuttingSummary" class="mb-4 text-sm text-gray-700">
                <!-- Summary will be populated by JavaScript -->
            </div>

            <!-- Cutting Plan Table -->
            <div id="cuttingTableContainer" class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                <div class="p-4 text-center text-gray-500">
                    Chưa có dữ liệu tối ưu cắt. Nhấn "Tạo Kế Hoạch Cắt" để tính toán.
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Chia đố -->
    <div id="divideModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold" id="divideModalTitle">Chia đố</h2>
                <button onclick="closeDivideModal()" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Số lượng chia</label>
                    <input type="number" id="divideCount" min="1" max="10" value="1" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Nhập số lượng thanh chia (1-10)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Chia đều</label>
                    <input type="checkbox" id="divideEvenly" checked 
                           class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm text-gray-700">Chia đều theo kích thước</span>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeDivideModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Hủy
                </button>
                <button onclick="applyDivide()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Áp dụng
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: Xuất hình -->
    <div id="exportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Xuất hình</h2>
                <button onclick="closeExportModal()" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Định dạng</label>
                    <select id="exportFormat" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="png">PNG (Chất lượng cao)</option>
                        <option value="jpg">JPG (Kích thước nhỏ)</option>
                        <option value="pdf">PDF (Văn bản)</option>
                    </select>
                </div>
                <div id="qualityContainer">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Chất lượng</label>
                    <input type="range" id="exportQuality" min="0.1" max="1" step="0.1" value="1" 
                           class="w-full" oninput="updateQualityLabel(this.value)">
                    <p class="text-xs text-gray-500 mt-1">Chất lượng: <span id="qualityLabel">100%</span></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tên file</label>
                    <input type="text" id="exportFileName" value="cua-thiet-ke" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeExportModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Hủy
                </button>
                <button onclick="doExport()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Xuất
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: Color Picker -->
    <div id="colorPickerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Đổi màu kính</h2>
                <button onclick="closeColorPickerModal()" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left: Color Picker -->
                    <div class="lg:col-span-2 space-y-4">
                        <!-- Color Gradient Square -->
                        <div class="relative">
                            <canvas id="colorGradientCanvas" width="300" height="300" 
                                    class="w-full border border-gray-300 rounded-lg cursor-crosshair"
                                    style="max-width: 100%; height: auto;"></canvas>
                        </div>
                        
                        <!-- Current Color & Eyedropper -->
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6 text-gray-600">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                                </svg>
                                <div id="currentColorCircle" class="w-12 h-12 rounded-full border-2 border-gray-300 shadow-md" style="background-color: #08FCFC;"></div>
                            </div>
                            
                            <!-- Hue Slider -->
                            <div class="flex-1">
                                <canvas id="hueSliderCanvas" width="300" height="30" 
                                        class="w-full h-8 border border-gray-300 rounded-lg cursor-pointer"
                                        style="max-width: 100%;"></canvas>
                            </div>
                        </div>
                        
                        <!-- RGB Inputs -->
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">R</label>
                                <input type="number" id="inputR" min="0" max="255" value="8" 
                                       onchange="updateColorFromRGB()"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">G</label>
                                <input type="number" id="inputG" min="0" max="255" value="252" 
                                       onchange="updateColorFromRGB()"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">B</label>
                                <input type="number" id="inputB" min="0" max="255" value="252" 
                                       onchange="updateColorFromRGB()"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right: Door/Window Type Selection -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-900">Chọn loại cửa/cửa sổ</h3>
                        
                        <!-- Cửa sổ mở quay -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Cửa sổ mở quay</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="loadTemplateByCode('CS1_LEFT')" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Trái</button>
                                <button onclick="loadTemplateByCode('CS1_RIGHT')" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Phải</button>
                                <button onclick="loadTemplateByCode('WH')" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Hất</button>
                                <button onclick="loadTemplateByCode('CS2')" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">2 cánh</button>
                            </div>
                        </div>
                        
                        <!-- Cửa đi mở quay ngoài -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Cửa đi mở quay ngoài</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="loadTemplateByCode('D1_LEFT_OUT')" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Trái</button>
                                <button onclick="loadTemplateByCode('D1_RIGHT_OUT')" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Phải</button>
                                <button onclick="loadTemplateByCode('D2')" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">2 cánh</button>
                                <button onclick="loadTemplateByCode('D4')" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">4 cánh</button>
                            </div>
                        </div>
                        
                        <!-- Cửa đi mở quay trong -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Cửa đi mở quay trong</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="loadTemplateByCode('D1_LEFT_IN')" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Trái</button>
                                <button onclick="loadTemplateByCode('D1_RIGHT_IN')" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Phải</button>
                                <button onclick="loadTemplateByCode('D2_IN')" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">2 cánh</button>
                                <button onclick="loadTemplateByCode('D4_IN')" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">4 cánh</button>
                            </div>
                        </div>
                        
                        <!-- Cửa sổ lùa -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Cửa sổ lùa</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="loadTemplateByCode('CSL2')" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">2 cánh</button>
                                <button onclick="loadTemplateByCode('CSL3')" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">3 cánh</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
                    <button onclick="applyGlassColor()" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600">
                        Đổi màu kính
                    </button>
                    <button onclick="closeColorPickerModal()" class="px-6 py-2 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50">
                        Hủy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: BOM (Bill of Materials) -->
    <div id="bomModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Bóc tách BOM (Bill of Materials)</h2>
                <button onclick="closeBOMModal()" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <!-- Loading State -->
                <div id="bomLoading" class="hidden text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-100 border-t-blue-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Đang tính toán BOM...</p>
                </div>

                <!-- BOM Content -->
                <div id="bomContent" class="hidden">
                    <!-- Stock Warnings -->
                    <div id="bomStockWarnings" class="hidden mb-4"></div>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <div class="text-sm text-blue-600 mb-1">Tổng thanh nhôm</div>
                            <div class="text-2xl font-bold text-blue-900" id="bomTotalAluminum">0</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                            <div class="text-sm text-green-600 mb-1">Tổng khối lượng (kg)</div>
                            <div class="text-2xl font-bold text-green-900" id="bomTotalWeight">0</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                            <div class="text-sm text-purple-600 mb-1">Tổng diện tích kính (m²)</div>
                            <div class="text-2xl font-bold text-purple-900" id="bomTotalGlass">0</div>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
                            <div class="text-sm text-orange-600 mb-1">Tổng phụ kiện</div>
                            <div class="text-2xl font-bold text-orange-900" id="bomTotalAccessories">0</div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="border-b border-gray-200 mb-4">
                        <div class="flex gap-4">
                            <button onclick="showBOMTab('aluminum')" class="bom-tab-btn active px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600">
                                Nhôm
                            </button>
                            <button onclick="showBOMTab('glass')" class="bom-tab-btn px-4 py-2 font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent">
                                Kính
                            </button>
                            <button onclick="showBOMTab('accessories')" class="bom-tab-btn px-4 py-2 font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent">
                                Phụ kiện
                            </button>
                            <button onclick="showBOMTab('other')" class="bom-tab-btn px-4 py-2 font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent">
                                Vật tư khác
                            </button>
                        </div>
                    </div>

                    <!-- Aluminum Tab -->
                    <div id="bomTabAluminum" class="bom-tab-content">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Tên</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Vị trí</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Ký hiệu</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Chiều dài (mm)</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Số lượng</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Khối lượng (kg)</th>
                                    </tr>
                                </thead>
                                <tbody id="bomAluminumTableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Glass Tab -->
                    <div id="bomTabGlass" class="bom-tab-content hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Tên</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Vị trí</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Rộng (mm)</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Cao (mm)</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Số lượng</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Diện tích (m²)</th>
                                    </tr>
                                </thead>
                                <tbody id="bomGlassTableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Accessories Tab -->
                    <div id="bomTabAccessories" class="bom-tab-content hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Tên</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Mã</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Số lượng</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Đơn vị</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Vị trí</th>
                                    </tr>
                                </thead>
                                <tbody id="bomAccessoriesTableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Other Materials Tab -->
                    <div id="bomTabOther" class="bom-tab-content hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Tên</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Mã</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Chiều dài/Số lượng</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">Đơn vị</th>
                                    </tr>
                                </thead>
                                <tbody id="bomOtherTableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Error State -->
                <div id="bomError" class="hidden text-center py-8">
                    <div class="text-red-600 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-12 h-12 mx-auto">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <p class="text-gray-600" id="bomErrorMessage">Có lỗi xảy ra khi tính toán BOM</p>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
                    <button onclick="optimizeCutting()" class="px-6 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700">
                        Tối ưu cắt
                    </button>
                    <button onclick="saveBOM()" class="px-6 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                        Lưu BOM
                    </button>
                    <button onclick="closeBOMModal()" class="px-6 py-2 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50">
                        Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Cutting Optimization -->
    <div id="cuttingOptimizationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-7xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Tối ưu cắt nhôm</h2>
                <button onclick="closeCuttingOptimizationModal()" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <!-- Algorithm Info -->
                <div id="algorithmInfo" class="hidden mb-4 px-4 py-2 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                    Thuật toán: First Fit Decreasing (FFD)
                </div>
                
                <!-- Settings -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold mb-3">Cài đặt</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Độ dài cây nhôm tiêu chuẩn (mm)</label>
                            <input type="number" id="barLengthInput" value="6000" min="1000" max="10000" step="100"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Độ rộng lưỡi cắt (mm)</label>
                            <input type="number" id="kerfWidthInput" value="3" min="0" max="10" step="0.5"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                    </div>
                    <button onclick="calculateCuttingOptimization()" class="mt-4 px-6 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700">
                        Tính toán tối ưu
                    </button>
                </div>

                <!-- Loading State -->
                <div id="cuttingOptimizationLoading" class="hidden text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-purple-100 border-t-purple-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Đang tính toán tối ưu cắt...</p>
                </div>

                <!-- Optimization Content -->
                <div id="cuttingOptimizationContent" class="hidden">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <div class="text-sm text-blue-600 mb-1">Tổng số cây nhôm</div>
                            <div class="text-2xl font-bold text-blue-900" id="optTotalBars">0</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                            <div class="text-sm text-green-600 mb-1">Hiệu suất (%)</div>
                            <div class="text-2xl font-bold text-green-900" id="optEfficiency">0%</div>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
                            <div class="text-sm text-orange-600 mb-1">Tổng dư thừa (mm)</div>
                            <div class="text-2xl font-bold text-orange-900" id="optTotalWaste">0</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                            <div class="text-sm text-purple-600 mb-1">Tổng sử dụng (mm)</div>
                            <div class="text-2xl font-bold text-purple-900" id="optTotalUsed">0</div>
                        </div>
                    </div>

                    <!-- Optimization Results by Aluminum System -->
                    <div id="cuttingOptimizationResults">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Error State -->
                <div id="cuttingOptimizationError" class="hidden text-center py-8">
                    <div class="text-red-600 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-12 h-12 mx-auto">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <p class="text-gray-600" id="cuttingOptimizationErrorMessage">Có lỗi xảy ra khi tính toán tối ưu cắt</p>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
                    <button onclick="saveCuttingOptimization()" class="px-6 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                        Lưu kết quả
                    </button>
                    <button onclick="printCuttingPlan()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                        In bản cắt
                    </button>
                    <button onclick="closeCuttingOptimizationModal()" class="px-6 py-2 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50">
                        Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts - New Engine System -->
    <script src="door-templates.js"></script>
    <script src="aluminum-profile-config.js"></script>
    <script src="door-canvas-engine.js"></script>
    <script src="door-model-tree.js"></script>
    <script src="door-bom-engine.js"></script>
    <script src="cut-optimizer.js"></script>
    <script src="door-editor-ui.js"></script>
    
    <!-- Legacy scripts (keep for backward compatibility) -->
    <script src="https://unpkg.com/konva@8/konva.min.js"></script>
    <script src="door-canvas-engine-v2.js"></script>
    <script>
        const API_BASE = 'http://localhost:3001/api';
        window.API_BASE = API_BASE; // Make available globally for door-editor-ui.js
        let currentProjectId = null;
        let currentDoorId = null;
        let canvasEngine = null;
        let templates = [];
        let currentTemplate = null;
        let aluminumSystems = [];
        let currentMainTab = 'design';
        let currentSubTab = 'dimension-split';

        // Switch main tab
        function switchMainTab(tabName) {
            currentMainTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('[onclick^="switchMainTab"]').forEach(btn => {
                btn.classList.remove('bg-gray-900', 'border-b-2', 'border-blue-500');
                btn.classList.add('hover:bg-gray-700');
            });
            if (event && event.target) {
                event.target.classList.add('bg-gray-900', 'border-b-2', 'border-blue-500');
                event.target.classList.remove('hover:bg-gray-700');
            }
            
            // Show/hide sub-tabs
            const subTabs = document.getElementById('designSubTabs');
            const dimensionToolbar = document.getElementById('dimensionSplitToolbar');
            const canvasArea = document.querySelector('.flex.h-\\[calc\\(100vh-140px\\)\\]');
            
            // Hide all content areas
            document.getElementById('estimateContent').classList.add('hidden');
            document.getElementById('manufacturingContent').classList.add('hidden');
            document.getElementById('accessoriesContent').classList.add('hidden');
            const bomContent = document.getElementById('bomContent');
            const cuttingContent = document.getElementById('cuttingContent');
            if (bomContent) bomContent.classList.add('hidden');
            if (cuttingContent) cuttingContent.classList.add('hidden');
            if (dimensionToolbar) dimensionToolbar.classList.add('hidden');
            if (canvasArea) canvasArea.classList.add('hidden');
            
            if (tabName === 'design') {
                subTabs.classList.remove('hidden');
                if (dimensionToolbar) dimensionToolbar.classList.remove('hidden');
                if (canvasArea) canvasArea.classList.remove('hidden');
                // Show appropriate sub-tab content
                switchSubTab(currentSubTab);
            } else if (tabName === 'bom') {
                if (bomContent) bomContent.classList.remove('hidden');
                loadBOMData(); // Load BOM when switching to BOM tab
            } else if (tabName === 'cutting') {
                if (cuttingContent) cuttingContent.classList.remove('hidden');
                loadCuttingPlan(); // Load cutting plan when switching to Cutting tab
            } else if (tabName === 'estimate') {
                document.getElementById('estimateContent').classList.remove('hidden');
            } else if (tabName === 'manufacturing') {
                document.getElementById('manufacturingContent').classList.remove('hidden');
            } else if (tabName === 'accessories') {
                document.getElementById('accessoriesContent').classList.remove('hidden');
            }
            
            console.log('Switched to tab:', tabName);
        }

        // Switch sub-tab
        function switchSubTab(subTabName) {
            currentSubTab = subTabName;
            
            // Update sub-tab buttons
            document.querySelectorAll('[onclick^="switchSubTab"]').forEach(btn => {
                btn.classList.remove('border-b-2', 'border-blue-400');
            });
            if (event && event.target) {
                event.target.classList.add('border-b-2', 'border-blue-400');
            }
            
            // Show/hide toolbars based on sub-tab
            const dimensionToolbar = document.getElementById('dimensionSplitToolbar');
            if (dimensionToolbar) {
                if (subTabName === 'dimension-split') {
                    dimensionToolbar.classList.remove('hidden');
                } else {
                    dimensionToolbar.classList.add('hidden');
                }
            }
            
            // TODO: Load content for other sub-tabs (Lỗ Ban, Mặt cắt, C.Thanh)
            console.log('Switched to sub-tab:', subTabName);
        }

        // View production
        function viewProduction() {
            window.location.href = `production.html?projectId=${currentProjectId}&doorId=${currentDoorId}`;
        }

        // Open tolerance settings
        function openToleranceSettings() {
            // Mở modal cài đặt độ hỡ
            const modal = document.getElementById('toleranceModal');
            if (modal) {
                modal.classList.remove('hidden');
            } else {
                // Tạo modal nếu chưa có
                const toleranceModal = document.createElement('div');
                toleranceModal.id = 'toleranceModal';
                toleranceModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                toleranceModal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full">
                        <h3 class="text-lg font-bold mb-4">Cài đặt độ hỡ</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Độ hỡ khung (mm)</label>
                                <input type="number" id="frameTolerance" value="50" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Độ hỡ cánh (mm)</label>
                                <input type="number" id="sashTolerance" value="30" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Độ hỡ kính (mm)</label>
                                <input type="number" id="glassTolerance" value="10" class="w-full px-3 py-2 border rounded">
                            </div>
                        </div>
                        <div class="flex gap-2 mt-6">
                            <button onclick="saveToleranceSettings()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Lưu</button>
                            <button onclick="closeToleranceModal()" class="flex-1 px-4 py-2 border rounded hover:bg-gray-50">Hủy</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(toleranceModal);
            }
        }

        function closeToleranceModal() {
            const modal = document.getElementById('toleranceModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function saveToleranceSettings() {
            const frameTolerance = document.getElementById('frameTolerance').value;
            const sashTolerance = document.getElementById('sashTolerance').value;
            const glassTolerance = document.getElementById('glassTolerance').value;
            
            if (canvasEngine) {
                canvasEngine.frameDeduction = parseFloat(frameTolerance) || 50;
                canvasEngine.sashDeduction = parseFloat(sashTolerance) || 30;
                canvasEngine.glassDeduction = parseFloat(glassTolerance) || 10;
                canvasEngine.draw();
            }
            
            closeToleranceModal();
            alert('Đã lưu cài đặt độ hỡ');
        }

        // Open settings
        function openSettings() {
            // Mở modal cài đặt
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.classList.remove('hidden');
            } else {
                // Tạo modal nếu chưa có
                const settingsModal = document.createElement('div');
                settingsModal.id = 'settingsModal';
                settingsModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                settingsModal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full">
                        <h3 class="text-lg font-bold mb-4">Cài đặt</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Đơn vị</label>
                                <select id="unitSetting" class="w-full px-3 py-2 border rounded">
                                    <option value="mm">mm</option>
                                    <option value="cm">cm</option>
                                    <option value="m">m</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Hiển thị kích thước</label>
                                <input type="checkbox" id="showDimensions" checked class="mr-2">
                                <span class="text-sm">Hiển thị kích thước trên canvas</span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Màu nền canvas</label>
                                <input type="color" id="canvasBgColor" value="#e5e7eb" class="w-full h-10 border rounded">
                            </div>
                        </div>
                        <div class="flex gap-2 mt-6">
                            <button onclick="saveSettings()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Lưu</button>
                            <button onclick="closeSettingsModal()" class="flex-1 px-4 py-2 border rounded hover:bg-gray-50">Hủy</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(settingsModal);
            }
        }

        function closeSettingsModal() {
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function saveSettings() {
            const showDimensions = document.getElementById('showDimensions').checked;
            const canvasBgColor = document.getElementById('canvasBgColor').value;
            
            if (canvasEngine) {
                canvasEngine.showDimensions = showDimensions;
                canvasEngine.draw();
            }
            
            // Update canvas background
            const canvasContainer = document.getElementById('canvasContainer');
            if (canvasContainer) {
                canvasContainer.style.background = canvasBgColor;
            }
            
            closeSettingsModal();
            alert('Đã lưu cài đặt');
        }

        // Template code mapping
        const templateCodeMap = {
            'CS1_LEFT': 'W1_1C',
            'CS1_RIGHT': 'W1_1C',
            'WH': 'TOP_HUNG',
            'CS2': 'W1_2C',
            'D1_LEFT_OUT': 'D1_1C_OUT',
            'D1_RIGHT_OUT': 'D1_1C_OUT',
            'D2': 'D1_2C_OUT',
            'D4': 'D1_4C_OUT',
            'D1_LEFT_IN': 'D1_1C_IN',
            'D1_RIGHT_IN': 'D1_1C_IN',
            'D2_IN': 'D1_2C_IN',
            'D4_IN': 'D1_2C_IN',
            'CSL2': 'WSLID_2C',
            'CSL3': 'WSLID_3C',
            'CSL4': 'WSLID_2C',
            'DL2': 'SL_2C',
            'DL3': 'SL_4C',
            'DL4': 'SL_4C'
        };

        // Initialize
        async function init() {
            // Initialize color picker
            setTimeout(() => {
                initColorPicker();
            }, 100);
            // Get project ID and door ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentProjectId = urlParams.get('projectId');
            // Hỗ trợ cả doorId và doorld (lỗi chính tả)
            currentDoorId = urlParams.get('doorId') || urlParams.get('doorld');

            // Initialize canvas engine V2
            const canvas = document.getElementById('drawingCanvas');
            
            // Set canvas size lớn hơn
            canvas.width = 2000;
            canvas.height = 1500;
            
            canvasEngine = new DoorCanvasEngineV2('drawingCanvas', {
                doorWidth: 800, // Kích thước cửa nhỏ hơn ban đầu
                doorHeight: 1200,
                initialScale: 0.6 // Scale phù hợp để hiển thị đầy đủ thông số
            });
            
            // Setup panel click handler
            canvasEngine.onPanelClick = (panel) => {
                openPanelPropertiesModal(panel);
            };
            
            // Center canvas ngay sau khi khởi tạo
            setTimeout(() => {
                canvasEngine.center();
            }, 100);

            // Load templates
            await loadTemplates();
            
            // Load aluminum systems
            await loadAluminumSystems();
            
            // Load existing door if doorId provided
            if (currentDoorId) {
                try {
                    await loadDoorDrawing(currentDoorId);
                    // Kiểm tra xem có panels không, nếu không thì tạo cửa mặc định
                    setTimeout(() => {
                        if (!canvasEngine.panels || canvasEngine.panels.length === 0) {
                            console.log('No panels after loading door, creating default door');
                            createDefaultDoor();
                        }
                    }, 500);
                } catch (error) {
                    console.error('Error loading door:', error);
                    createDefaultDoor();
                }
            } else {
                // Default: tạo cửa mặc định
                createDefaultDoor();
            }

            // Setup dimension change callback
            canvasEngine.onDimensionsChange = (width, height) => {
                document.getElementById('inputWidth').value = Math.round(width);
                document.getElementById('inputHeight').value = Math.round(height);
                // Kích thước được hiển thị trực tiếp trên canvas, không cần update panel
            };
            
            // Đảm bảo tab KT chia được hiển thị mặc định
            const dimensionToolbar = document.getElementById('dimensionSplitToolbar');
            if (dimensionToolbar) {
                dimensionToolbar.classList.remove('hidden');
            }
        }

        // Load templates from JSON
        async function loadTemplates() {
            try {
                const response = await fetch('door-templates.json');
                templates = await response.json();
            } catch (error) {
                console.error('Error loading templates:', error);
                // Fallback: load from API
                try {
                    const response = await fetch(`${API_BASE}/door-templates`);
                    const result = await response.json();
                    if (result.success) {
                        templates = result.data;
                    }
                } catch (apiError) {
                    console.error('Error loading templates from API:', apiError);
                }
            }
        }

        // Load template by code
        function loadTemplateByCode(code) {
            const templateId = templateCodeMap[code];
            let template = null;
            
            // Try to find by mapped ID first
            if (templateId) {
                template = templates.find(t => t.id === templateId || t.code === templateId);
            }
            
            // If not found, try to find by code directly
            if (!template) {
                template = templates.find(t => t.code === code || t.id === code);
            }
            
            if (template) {
                loadTemplate(template);
                // Update active button
                document.querySelectorAll('.toolbar-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (event && event.target) {
                    event.target.classList.add('active');
                }
            } else {
                console.warn('Template not found:', code, 'Available templates:', templates.map(t => t.code || t.id));
                // Try to load from API
                loadTemplateFromAPI(code);
            }
        }
        
        // Load template from API
        async function loadTemplateFromAPI(code) {
            try {
                const response = await fetch(`${API_BASE}/door-templates?code=${code}`);
                const result = await response.json();
                if (result.success && result.data && result.data.length > 0) {
                    const template = result.data[0];
                    templates.push(template);
                    loadTemplate(template);
                } else {
                    alert('Không tìm thấy template: ' + code);
                }
            } catch (error) {
                console.error('Error loading template from API:', error);
                alert('Lỗi khi tải template: ' + code);
            }
        }

        // Tạo cửa mặc định theo hình vẽ (6 panel: FIX+OUT trái, 3 FIX giữa, FIX+OUT+FIX phải)
        function createDefaultDoor() {
            if (!canvasEngine) {
                console.error('Canvas engine not initialized');
                return;
            }
            
            console.log('Creating default door with multiple panels');
            // Kích thước tổng: 3200mm x 2700mm (theo hình vẽ)
            // Trái: 1400mm (FIX 500mm + OUT 1200mm + FIX 1000mm)
            // Phải: 1800mm (FIX panels + 4 OUT panels)
            
            const totalWidth = 3200;
            const totalHeight = 2700;
            
            // Set dimensions
            canvasEngine.setDimensions(totalWidth, totalHeight);
            document.getElementById('inputWidth').value = totalWidth;
            document.getElementById('inputHeight').value = totalHeight;
            
            const defaultTemplate = {
                panels: [
                    // Trái - FIX trên (1400 x 500)
                    {
                        id: 'FIX_LEFT_TOP',
                        type: 'fixed',
                        x: 0,
                        y: 0,
                        width: 1400,
                        height: 500,
                        widthRatio: 1400 / totalWidth,
                        heightRatio: 500 / totalHeight,
                        glassColor: '#87CEEB',
                        glassOpacity: 0.3
                    },
                    // Trái - OUT giữa (1400 x 1200)
                    {
                        id: 'OUT_LEFT',
                        type: 'swing',
                        openDirection: 'right',
                        hinge: 'left',
                        x: 0,
                        y: 500,
                        width: 1400,
                        height: 1200,
                        widthRatio: 1400 / totalWidth,
                        heightRatio: 1200 / totalHeight,
                        glassColor: '#87CEEB',
                        glassOpacity: 0.3
                    },
                    // Trái - FIX dưới (1400 x 1000)
                    {
                        id: 'FIX_LEFT_BOTTOM',
                        type: 'fixed',
                        x: 0,
                        y: 1700,
                        width: 1400,
                        height: 1000,
                        widthRatio: 1400 / totalWidth,
                        heightRatio: 1000 / totalHeight,
                        glassColor: '#87CEEB',
                        glassOpacity: 0.3
                    },
                    // Phải - FIX trên trái (900 x 500)
                    {
                        id: 'FIX_RIGHT_TOP_LEFT',
                        type: 'fixed',
                        x: 1400,
                        y: 0,
                        width: 900,
                        height: 500,
                        widthRatio: 900 / totalWidth,
                        heightRatio: 500 / totalHeight,
                        glassColor: '#87CEEB',
                        glassOpacity: 0.3
                    },
                    // Phải - FIX trên phải (900 x 500)
                    {
                        id: 'FIX_RIGHT_TOP_RIGHT',
                        type: 'fixed',
                        x: 2300,
                        y: 0,
                        width: 900,
                        height: 500,
                        widthRatio: 900 / totalWidth,
                        heightRatio: 500 / totalHeight,
                        glassColor: '#87CEEB',
                        glassOpacity: 0.3
                    },
                    // Phải - OUT 1 (450 x 1200)
                    {
                        id: 'OUT_RIGHT_1',
                        type: 'swing',
                        openDirection: 'left',
                        hinge: 'right',
                        x: 1400,
                        y: 500,
                        width: 450,
                        height: 1200,
                        widthRatio: 450 / totalWidth,
                        heightRatio: 1200 / totalHeight,
                        glassColor: '#87CEEB',
                        glassOpacity: 0.3
                    },
                    // Phải - OUT 2 (450 x 1200)
                    {
                        id: 'OUT_RIGHT_2',
                        type: 'swing',
                        openDirection: 'left',
                        hinge: 'right',
                        x: 1850,
                        y: 500,
                        width: 450,
                        height: 1200,
                        widthRatio: 450 / totalWidth,
                        heightRatio: 1200 / totalHeight,
                        glassColor: '#87CEEB',
                        glassOpacity: 0.3
                    },
                    // Phải - OUT 3 (450 x 1200)
                    {
                        id: 'OUT_RIGHT_3',
                        type: 'swing',
                        openDirection: 'left',
                        hinge: 'right',
                        x: 2300,
                        y: 500,
                        width: 450,
                        height: 1200,
                        widthRatio: 450 / totalWidth,
                        heightRatio: 1200 / totalHeight,
                        glassColor: '#87CEEB',
                        glassOpacity: 0.3
                    },
                    // Phải - OUT 4 (450 x 1200)
                    {
                        id: 'OUT_RIGHT_4',
                        type: 'swing',
                        openDirection: 'left',
                        hinge: 'right',
                        x: 2750,
                        y: 500,
                        width: 450,
                        height: 1200,
                        widthRatio: 450 / totalWidth,
                        heightRatio: 1200 / totalHeight,
                        glassColor: '#87CEEB',
                        glassOpacity: 0.3
                    },
                    // Phải - FIX dưới trái (900 x 1000)
                    {
                        id: 'FIX_RIGHT_BOTTOM_LEFT',
                        type: 'fixed',
                        x: 1400,
                        y: 1700,
                        width: 900,
                        height: 1000,
                        widthRatio: 900 / totalWidth,
                        heightRatio: 1000 / totalHeight,
                        glassColor: '#87CEEB',
                        glassOpacity: 0.3
                    },
                    // Phải - FIX dưới phải (900 x 1000)
                    {
                        id: 'FIX_RIGHT_BOTTOM_RIGHT',
                        type: 'fixed',
                        x: 2300,
                        y: 1700,
                        width: 900,
                        height: 1000,
                        widthRatio: 900 / totalWidth,
                        heightRatio: 1000 / totalHeight,
                        glassColor: '#87CEEB',
                        glassOpacity: 0.3
                    }
                ]
            };
            
            // Load template với panels có vị trí cụ thể
            if (typeof canvasEngine.loadTemplateWithPositions === 'function') {
                canvasEngine.loadTemplateWithPositions(defaultTemplate);
            } else {
                // Fallback: dùng loadTemplate thông thường
                canvasEngine.loadTemplate(defaultTemplate);
            }
            canvasEngine.draw();
            setTimeout(() => {
                canvasEngine.center();
                canvasEngine.draw();
            }, 100);
        }

        // Load template
        // Load templates V2
        async function loadTemplatesV2() {
            try {
                const response = await fetch('door-templates-v2.json');
                templatesV2 = await response.json();
            } catch (error) {
                console.error('Error loading templates V2:', error);
                templatesV2 = [];
            }
        }

        function loadTemplate(template) {
            if (!canvasEngine) return;
            
            // Convert old template format to V2 format if needed
            let templateV2 = null;
            
            if (template.panels && Array.isArray(template.panels)) {
                // Already V2 format
                templateV2 = template;
            } else if (template.cells && Array.isArray(template.cells)) {
                // Old format - convert to V2
                templateV2 = convertTemplateToV2(template);
            } else {
                // Default single panel
                templateV2 = {
                    panels: [{
                        id: 1,
                        type: 'swing',
                        openDirection: 'left',
                        hinge: 'left',
                        widthRatio: 1.0,
                        heightRatio: 1.0,
                        glassColor: '#87CEEB',
                        glassOpacity: 0.3
                    }]
                };
            }
            
            // Load template into engine
            canvasEngine.loadTemplate(templateV2);
            
            // Update dimensions if template has default dimensions
            if (template.defaultWidth && template.defaultHeight) {
                canvasEngine.setDimensions(template.defaultWidth, template.defaultHeight);
                document.getElementById('inputWidth').value = template.defaultWidth;
                document.getElementById('inputHeight').value = template.defaultHeight;
            }
            
            // Vẽ lại và center
            canvasEngine.draw();
            setTimeout(() => {
                canvasEngine.center();
                canvasEngine.draw();
            }, 100);
            
            // Center canvas
            canvasEngine.center();
        }
        
        // Convert old template format to V2
        function convertTemplateToV2(template) {
            const panels = [];
            const rows = template.rows || 1;
            const cols = template.cols || 1;
            const cellWidth = 1.0 / cols;
            const cellHeight = 1.0 / rows;
            
            template.cells.forEach((cell, index) => {
                const row = cell.r || Math.floor(index / cols);
                const col = cell.c || (index % cols);
                
                let type = 'swing';
                let openDirection = 'left';
                let hinge = 'left';
                
                if (cell.type === 'sash') {
                    if (cell.sashType === 'sliding') {
                        type = 'sliding';
                        openDirection = cell.openDir || 'left';
                    } else {
                        type = 'swing';
                        openDirection = cell.openDir || 'left';
                        hinge = cell.openDir || 'left';
                    }
                } else if (cell.type === 'fixed') {
                    type = 'fixed';
                }
                
                panels.push({
                    id: index + 1,
                    type: type,
                    openDirection: openDirection,
                    hinge: hinge,
                    widthRatio: cellWidth,
                    heightRatio: cellHeight,
                    x: col * cellWidth * (template.defaultWidth || 1800),
                    y: row * cellHeight * (template.defaultHeight || 2200),
                    glassColor: '#87CEEB',
                    glassOpacity: 0.3
                });
            });
            
            return { panels: panels };
        }
        
        // Load template by code (V2)
        function loadTemplateByCode(code) {
            // Try V2 templates first
            if (typeof templatesV2 !== 'undefined' && templatesV2) {
                const template = templatesV2.find(t => t.id === code || t.code === code);
                if (template) {
                    loadTemplate(template);
                    return;
                }
            }
            
            // Fallback to old templates
            const templateId = templateCodeMap[code];
            let template = null;
            
            if (templateId) {
                template = templates.find(t => t.id === templateId || t.code === templateId);
            }
            
            if (!template) {
                template = templates.find(t => t.code === code || t.id === code);
            }
            
            if (template) {
                loadTemplate(template);
            } else {
                console.warn('Template not found:', code);
                loadTemplateFromAPI(code);
            }
        }
        
        // Old loadTemplate function (kept for compatibility)
        function loadTemplateOld(template) {
            currentTemplate = template;
            canvasEngine.setTemplate(template);
            
            // Update inputs
            document.getElementById('inputWidth').value = template.defaultWidth || 1200;
            document.getElementById('inputHeight').value = template.defaultHeight || 2400;
            
            // Kích thước được hiển thị trực tiếp trên canvas
        }

        // Load aluminum systems
        async function loadAluminumSystems() {
            try {
                const response = await fetch(`${API_BASE}/aluminum-systems`);
                const result = await response.json();
                if (result.success) {
                    aluminumSystems = result.data;
                    const select = document.getElementById('selectAluminumSystem');
                    select.innerHTML = '<option value="">-- Chọn hệ nhôm --</option>';
                    result.data.forEach(system => {
                        const option = document.createElement('option');
                        option.value = system.id;
                        option.textContent = `${system.name} (${system.brand})`;
                        if (system.brand === 'ViralWindow') {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading aluminum systems:', error);
            }
        }

        // Update dimensions
        function updateDimensions() {
            const width = parseInt(document.getElementById('inputWidth').value) || 1200;
            const height = parseInt(document.getElementById('inputHeight').value) || 2400;
            canvasEngine.setDimensions(width, height);
            // Kích thước được hiển thị trực tiếp trên canvas
        }

        // Set glass color
        function setGlassColor(color) {
            if (!canvasEngine) {
                console.error('Canvas engine not initialized');
                return;
            }
            
            // Apply to all panels
            canvasEngine.setGlassColor(color, true);
            
            // Update active button
            document.querySelectorAll('[onclick^="setGlassColor"]').forEach(btn => {
                btn.classList.remove('border-blue-500');
            });
            if (event && event.target) {
                event.target.classList.add('border-blue-500');
            }
        }

        // Color picker state
        let currentHue = 180; // Cyan hue
        let currentSaturation = 100;
        let currentLightness = 50;
        let selectedColor = '#08FCFC';

        // Change glass color (modal)
        function changeGlassColor() {
            // Initialize color picker with current glass color
            const currentColor = canvasEngine.glassColor || '#87CEEB';
            const rgb = hexToRgb(currentColor);
            if (rgb) {
                const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
                currentHue = hsl.h;
                currentSaturation = hsl.s;
                currentLightness = hsl.l;
                selectedColor = currentColor;
                updateColorPicker();
            }
            document.getElementById('colorPickerModal').classList.remove('hidden');
        }

        // Close color picker modal
        function closeColorPickerModal() {
            document.getElementById('colorPickerModal').classList.add('hidden');
        }

        // ========== BOM FUNCTIONS ==========
        
        let currentBOMData = null;
        let currentBOMFilter = 'all';
        
        // Load BOM data
        async function loadBOMData() {
            const doorDrawingId = getCurrentDoorDrawingId();
            if (!doorDrawingId) {
                document.getElementById('bomTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            Vui lòng lưu bản vẽ trước khi xem BOM.
                        </td>
                    </tr>
                `;
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/door-drawings/${doorDrawingId}/bom`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                const result = await response.json();
                
                if (result.success && result.data.items.length > 0) {
                    currentBOMData = result.data;
                    renderBOMTable(result.data);
                    renderBOMSummary(result.data.totals);
                } else {
                    // No BOM yet - show message
                    document.getElementById('bomTableBody').innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                Chưa có dữ liệu BOM. Nhấn "Bóc Tách BOM" để tính toán.
                            </td>
                        </tr>
                    `;
                    document.getElementById('bomSummary').innerHTML = '';
                }
            } catch (error) {
                console.error('Error loading BOM:', error);
                document.getElementById('bomTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-red-500">
                            Lỗi khi tải BOM: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        // Generate BOM
        async function generateBOM() {
            const doorDrawingId = getCurrentDoorDrawingId();
            if (!doorDrawingId) {
                alert('Vui lòng lưu bản vẽ trước khi tính BOM.');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/door-drawings/${doorDrawingId}/generate-bom`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    },
                    body: JSON.stringify({ recalcCutting: false })
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('Tính BOM thành công!');
                    loadBOMData(); // Reload BOM data
                } else {
                    alert('Lỗi: ' + (result.message || 'Không thể tính BOM'));
                }
            } catch (error) {
                console.error('Error generating BOM:', error);
                alert('Lỗi khi tính BOM: ' + error.message);
            }
        }
        
        // Render BOM table
        function renderBOMTable(data) {
            const tbody = document.getElementById('bomTableBody');
            let html = '';
            
            const items = data.items || [];
            const filteredItems = currentBOMFilter === 'all' 
                ? items 
                : items.filter(item => item.item_type === currentBOMFilter);
            
            if (filteredItems.length === 0) {
                html = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            Không có dữ liệu cho nhóm đã chọn.
                        </td>
                    </tr>
                `;
            } else {
                filteredItems.forEach(item => {
                    const groupName = getGroupName(item.item_type);
                    const spec = formatSpecification(item);
                    
                    html += `
                        <tr class="bom-row" data-type="${item.item_type}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${groupName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.item_code || '-'}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${spec}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${item.length_mm ? formatNumber(item.length_mm) : '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${formatNumber(item.qty || 1)}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${item.note || item.description || '-'}</td>
                        </tr>
                    `;
                });
            }
            
            tbody.innerHTML = html;
        }
        
        // Render BOM summary
        function renderBOMSummary(totals) {
            const summaryDiv = document.getElementById('bomSummary');
            const totalLengthM = (totals.total_profile_length_mm / 1000).toFixed(2);
            
            summaryDiv.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="text-sm text-blue-600 font-medium">Tổng số vật tư</div>
                    <div class="text-2xl font-bold text-blue-900">${totals.total_items}</div>
                </div>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <div class="text-sm text-gray-600 font-medium">Nhôm (Profile)</div>
                    <div class="text-2xl font-bold text-gray-900">${totals.total_profiles}</div>
                    <div class="text-xs text-gray-500 mt-1">${totalLengthM}m ≈ ${totals.estimated_6m_bars} thanh 6m</div>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="text-sm text-green-600 font-medium">Kính</div>
                    <div class="text-2xl font-bold text-green-900">${totals.total_glass}</div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="text-sm text-yellow-600 font-medium">Phụ kiện</div>
                    <div class="text-2xl font-bold text-yellow-900">${totals.total_accessories}</div>
                </div>
            `;
        }
        
        // Filter BOM
        function filterBOM(type) {
            currentBOMFilter = type;
            
            // Update filter buttons
            document.querySelectorAll('.bom-filter').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.querySelector(`[data-filter="${type}"]`).classList.remove('bg-gray-200', 'text-gray-700');
            document.querySelector(`[data-filter="${type}"]`).classList.add('bg-blue-600', 'text-white');
            
            // Re-render table
            if (currentBOMData) {
                renderBOMTable(currentBOMData);
            }
        }
        
        // Helper functions
        function getGroupName(itemType) {
            const names = {
                'profile': 'Nhôm',
                'glass': 'Kính',
                'accessory': 'Phụ kiện',
                'gasket': 'Gioăng',
                'hardware': 'Phụ kiện'
            };
            return names[itemType] || itemType;
        }
        
        function formatSpecification(item) {
            if (item.width_mm && item.height_mm) {
                return `${formatNumber(item.width_mm)} × ${formatNumber(item.height_mm)} mm`;
            } else if (item.length_mm) {
                return `${formatNumber(item.length_mm)} mm`;
            } else if (item.description) {
                return item.description;
            }
            return '-';
        }
        
        function formatNumber(num) {
            return new Intl.NumberFormat('vi-VN').format(num);
        }
        
        function getCurrentDoorDrawingId() {
            // Get from doorEditorUI if available
            if (window.doorEditorUI && window.doorEditorUI.currentDoorDrawingId) {
                return window.doorEditorUI.currentDoorDrawingId;
            }
            // Try to get from currentDoorData
            if (window.doorEditorUI && window.doorEditorUI.currentDoorData && window.doorEditorUI.currentDoorData.door_drawing_id) {
                return window.doorEditorUI.currentDoorData.door_drawing_id;
            }
            // Try to get from URL or other source
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('drawingId') || null;
        }
        
        // Export BOM to Excel (placeholder)
        function exportBOMToExcel() {
            if (!currentBOMData) {
                alert('Chưa có dữ liệu BOM để xuất.');
                return;
            }
            // TODO: Implement Excel export
            alert('Tính năng xuất Excel đang được phát triển.');
        }
        
        // Print BOM
        function printBOM() {
            if (!currentBOMData) {
                alert('Chưa có dữ liệu BOM để in.');
                return;
            }
            window.print();
        }
        
        // ========== CUTTING PLAN FUNCTIONS ==========
        
        let currentCuttingPlanData = null;
        
        // Generate cutting plan
        async function generateCuttingPlan() {
            const doorDrawingId = getCurrentDoorDrawingId();
            if (!doorDrawingId) {
                alert('Vui lòng lưu bản vẽ trước khi tạo kế hoạch cắt.');
                return;
            }
            
            const stockLength = parseInt(document.getElementById('cutStockLength')?.value || '6000', 10);
            const kerf = parseFloat(document.getElementById('cutKerf')?.value || '3', 10);
            const algorithm = document.getElementById('cutAlgorithm')?.value || 'best-fit';
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/door-drawings/${doorDrawingId}/cutting-plan/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    },
                    body: JSON.stringify({ stockLength, kerf, algorithm })
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('Tạo kế hoạch cắt thành công!');
                    loadCuttingPlan(); // Reload cutting plan
                } else {
                    alert('Lỗi: ' + (result.message || 'Không thể tạo kế hoạch cắt'));
                }
            } catch (error) {
                console.error('Error generating cutting plan:', error);
                alert('Lỗi khi tạo kế hoạch cắt: ' + error.message);
            }
        }
        
        // Load cutting plan
        async function loadCuttingPlan() {
            const doorDrawingId = getCurrentDoorDrawingId();
            if (!doorDrawingId) {
                document.getElementById('cuttingTableContainer').innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        Vui lòng lưu bản vẽ trước khi xem kế hoạch cắt.
                    </div>
                `;
                return;
            }
            
            const container = document.getElementById('cuttingTableContainer');
            const summary = document.getElementById('cuttingSummary');
            
            container.innerHTML = '<div class="p-4 text-center text-gray-500">Đang tải...</div>';
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/door-drawings/${doorDrawingId}/cutting-plan`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                const result = await response.json();
                
                if (result.success && result.data && result.data.plans && result.data.plans.length > 0) {
                    currentCuttingPlanData = result.data;
                    renderCuttingPlanTable(result.data);
                    renderCuttingSummary(result.data.summary);
                } else {
                    container.innerHTML = `
                        <div class="p-4 text-center text-gray-500">
                            Chưa có dữ liệu tối ưu cắt. Nhấn "Tạo Kế Hoạch Cắt" để tính toán.
                        </div>
                    `;
                    summary.textContent = '';
                }
            } catch (error) {
                console.error('Error loading cutting plan:', error);
                container.innerHTML = `
                    <div class="p-4 text-center text-red-500">
                        Lỗi khi tải kế hoạch cắt: ${error.message}
                    </div>
                `;
            }
        }
        
        // Render cutting plan table
        function renderCuttingPlanTable(data) {
            const container = document.getElementById('cuttingTableContainer');
            let html = '';
            
            const plans = data.plans || [];
            
            // Group by profile_code (each plan is already grouped)
            for (const plan of plans) {
                const profileCode = plan.profile_code;
                const bars = plan.bars || (typeof plan.plan_json === 'string' ? JSON.parse(plan.plan_json) : plan.plan_json) || [];
                
                if (bars.length === 0) continue;
                
                html += `
                    <div class="border-b border-gray-200">
                        <div class="bg-slate-100 px-4 py-3 font-semibold text-gray-900 border-b border-gray-200">
                            Profile: ${profileCode} (${plan.total_bars} cây, Hiệu suất: ${plan.efficiency?.toFixed(2) || '0.00'}%)
                        </div>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cây</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chiều dài cây (mm)</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Các đoạn</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Dùng (mm)</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Dư (mm)</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Hiệu suất (%)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                bars.forEach(bar => {
                    const pieces = bar.cuts ? bar.cuts.map(c => c.length) : (bar.pieces || []);
                    const piecesStr = pieces.map(p => `${formatNumber(p)}`).join(' + ');
                    
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 text-center">${bar.bar || bar.barIndex || '-'}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-center">${formatNumber(plan.stock_length_mm || 6000)}</td>
                            <td class="px-4 py-3 text-sm text-gray-500">${piecesStr}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-right">${formatNumber(bar.used || bar.usedLength || 0)}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-right">${formatNumber(bar.waste || 0)}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-right">${(bar.efficiency || 0).toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            if (html === '') {
                html = '<div class="p-4 text-center text-gray-500">Không có dữ liệu</div>';
            }
            
            container.innerHTML = html;
        }
        
        // Render cutting summary
        function renderCuttingSummary(summary) {
            const summaryDiv = document.getElementById('cuttingSummary');
            if (!summary) {
                summaryDiv.textContent = '';
                return;
            }
            
            const totalBars = summary.total_bars || 0;
            const totalWaste = summary.total_waste_mm || 0;
            const totalWasteM = (totalWaste / 1000).toFixed(2);
            
            summaryDiv.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <div class="text-sm text-blue-600 font-medium">Tổng số cây</div>
                            <div class="text-2xl font-bold text-blue-900">${formatNumber(totalBars)}</div>
                        </div>
                        <div>
                            <div class="text-sm text-blue-600 font-medium">Tổng dư thừa</div>
                            <div class="text-2xl font-bold text-blue-900">${formatNumber(totalWaste)} mm</div>
                            <div class="text-xs text-blue-600 mt-1">≈ ${totalWasteM} m</div>
                        </div>
                        <div>
                            <div class="text-sm text-blue-600 font-medium">Tổng chiều dài cần mua</div>
                            <div class="text-2xl font-bold text-blue-900">${formatNumber(totalBars * 6)} m</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Export cutting plan to Excel (placeholder)
        function exportCuttingPlanToExcel() {
            if (!currentCuttingPlanData) {
                alert('Chưa có dữ liệu kế hoạch cắt để xuất.');
                return;
            }
            // TODO: Implement Excel export
            alert('Tính năng xuất Excel đang được phát triển.');
        }
        
        // Print cutting plan
        function printCuttingPlan() {
            if (!currentCuttingPlanData) {
                alert('Chưa có dữ liệu kế hoạch cắt để in.');
                return;
            }
            window.print();
        }
        
        // Initialize color picker
        function initColorPicker() {
            const gradientCanvas = document.getElementById('colorGradientCanvas');
            const hueSliderCanvas = document.getElementById('hueSliderCanvas');
            
            if (!gradientCanvas || !hueSliderCanvas) return;
            
            // Draw hue slider
            drawHueSlider(hueSliderCanvas);
            
            // Draw color gradient
            drawColorGradient(gradientCanvas);
            
            // Add event listeners
            gradientCanvas.addEventListener('click', (e) => {
                const rect = gradientCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const scaleX = gradientCanvas.width / rect.width;
                const scaleY = gradientCanvas.height / rect.height;
                selectColorFromGradient(x * scaleX, y * scaleY);
            });
            
            hueSliderCanvas.addEventListener('click', (e) => {
                const rect = hueSliderCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const scaleX = hueSliderCanvas.width / rect.width;
                selectHue(x * scaleX);
            });
        }

        // Draw hue slider
        function drawHueSlider(canvas) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            const gradient = ctx.createLinearGradient(0, 0, width, 0);
            for (let i = 0; i <= 360; i += 60) {
                const hue = i / 360;
                gradient.addColorStop(hue, `hsl(${i}, 100%, 50%)`);
            }
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
        }

        // Draw color gradient
        function drawColorGradient(canvas) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Draw saturation gradient (left to right: 0% to 100%)
            for (let x = 0; x < width; x++) {
                const s = x / width * 100;
                // Draw lightness gradient (top to bottom: 100% to 0%)
                for (let y = 0; y < height; y++) {
                    const l = 100 - (y / height * 100);
                    ctx.fillStyle = `hsl(${currentHue}, ${s}%, ${l}%)`;
                    ctx.fillRect(x, y, 1, 1);
                }
            }
        }

        // Select color from gradient
        function selectColorFromGradient(x, y) {
            const canvas = document.getElementById('colorGradientCanvas');
            const width = canvas.width;
            const height = canvas.height;
            
            currentSaturation = (x / width) * 100;
            currentLightness = 100 - (y / height) * 100;
            
            updateSelectedColor();
        }

        // Select hue from slider
        function selectHue(x) {
            const canvas = document.getElementById('hueSliderCanvas');
            const width = canvas.width;
            
            currentHue = (x / width) * 360;
            if (currentHue < 0) currentHue = 0;
            if (currentHue > 360) currentHue = 360;
            
            drawColorGradient(document.getElementById('colorGradientCanvas'));
            updateSelectedColor();
        }

        // Update selected color
        function updateSelectedColor() {
            const rgb = hslToRgb(currentHue / 360, currentSaturation / 100, currentLightness / 100);
            selectedColor = rgbToHex(rgb.r, rgb.g, rgb.b);
            
            // Update UI
            document.getElementById('currentColorCircle').style.backgroundColor = selectedColor;
            document.getElementById('inputR').value = rgb.r;
            document.getElementById('inputG').value = rgb.g;
            document.getElementById('inputB').value = rgb.b;
        }

        // Update color from RGB inputs
        function updateColorFromRGB() {
            const r = parseInt(document.getElementById('inputR').value) || 0;
            const g = parseInt(document.getElementById('inputG').value) || 0;
            const b = parseInt(document.getElementById('inputB').value) || 0;
            
            const hsl = rgbToHsl(r, g, b);
            currentHue = hsl.h;
            currentSaturation = hsl.s;
            currentLightness = hsl.l;
            
            selectedColor = rgbToHex(r, g, b);
            document.getElementById('currentColorCircle').style.backgroundColor = selectedColor;
            
            drawColorGradient(document.getElementById('colorGradientCanvas'));
        }

        // Update color picker display
        function updateColorPicker() {
            document.getElementById('currentColorCircle').style.backgroundColor = selectedColor;
            const rgb = hexToRgb(selectedColor);
            if (rgb) {
                document.getElementById('inputR').value = rgb.r;
                document.getElementById('inputG').value = rgb.g;
                document.getElementById('inputB').value = rgb.b;
            }
            drawColorGradient(document.getElementById('colorGradientCanvas'));
        }

        // Apply glass color
        function applyGlassColor() {
            if (!canvasEngine) {
                console.error('Canvas engine not initialized');
                return;
            }
            
            // Apply to all panels
            canvasEngine.setGlassColor(selectedColor, true);
            closeColorPickerModal();
        }

        // Color conversion utilities
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function rgbToHex(r, g, b) {
            return "#" + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            }).join("");
        }

        function rgbToHsl(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            
            return {
                h: h * 360,
                s: s * 100,
                l: l * 100
            };
        }

        function hslToRgb(h, s, l) {
            let r, g, b;
            
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            
            return {
                r: Math.round(r * 255),
                g: Math.round(g * 255),
                b: Math.round(b * 255)
            };
        }

        // Zoom functions
        function zoomIn() {
            canvasEngine.zoom(1.2, canvasEngine.canvasWidth / 2, canvasEngine.canvasHeight / 2);
            updateZoomDisplay();
        }

        function zoomOut() {
            canvasEngine.zoom(0.8, canvasEngine.canvasWidth / 2, canvasEngine.canvasHeight / 2);
            updateZoomDisplay();
        }

        function setZoom(level) {
            canvasEngine.setZoom(level);
            updateZoomDisplay();
        }

        function updateZoomDisplay() {
            const percent = Math.round(canvasEngine.scale * 100);
            document.getElementById('zoomLevel').textContent = percent + '%';
            document.getElementById('zoomSlider').value = percent;
        }

        // Center canvas
        function centerCanvas() {
            canvasEngine.resetView();
            updateZoomDisplay();
        }

        // New drawing
        function newDrawing() {
            if (!canvasEngine) {
                alert('Canvas engine chưa được khởi tạo!');
                return;
            }
            
            if (confirm('Bạn có chắc muốn tạo cửa mới? Dữ liệu hiện tại sẽ bị mất.')) {
                currentTemplate = null;
                canvasEngine.panels = [];
                canvasEngine.mullions = []; // Reset đố
                canvasEngine.selectedPanel = null;
                canvasEngine.doorWidth = 800;
                canvasEngine.doorHeight = 1200;
                document.getElementById('inputWidth').value = 800;
                document.getElementById('inputHeight').value = 1200;
                canvasEngine.draw();
                canvasEngine.center();
            }
        }

        // New cabinet
        function newCabinet() {
            if (!canvasEngine) {
                alert('Canvas engine chưa được khởi tạo!');
                return;
            }
            
            if (confirm('Bạn có chắc muốn tạo tủ mới? Dữ liệu hiện tại sẽ bị mất.')) {
                currentTemplate = null;
                canvasEngine.panels = [];
                canvasEngine.mullions = []; // Reset đố
                canvasEngine.selectedPanel = null;
                
                // Tạo panel tủ mặc định (màu nâu, không có kính)
                const cabinetPanel = new Panel({
                    type: 'fixed',
                    openDirection: 'none',
                    widthRatio: 1.0,
                    heightRatio: 1.0,
                    glassColor: '#8B4513', // Màu nâu cho tủ
                    glassOpacity: 1.0
                });
                cabinetPanel.calculateDimensions(canvasEngine.doorWidth, canvasEngine.doorHeight);
                canvasEngine.panels.push(cabinetPanel);
                canvasEngine.draw();
                canvasEngine.center();
            }
        }

        // Add mullion functions
        function addHorizontalMullion() {
            if (!canvasEngine) {
                alert('Canvas engine chưa được khởi tạo!');
                return;
            }
            
            if (canvasEngine.panels.length === 0) {
                alert('Chưa có panel nào để chia! Vui lòng chọn template cửa trước.');
                return;
            }
            
            canvasEngine.addHorizontalMullion();
        }

        function addVerticalMullion() {
            if (!canvasEngine) {
                alert('Canvas engine chưa được khởi tạo!');
                return;
            }
            
            if (canvasEngine.panels.length === 0) {
                alert('Chưa có panel nào để tách! Vui lòng chọn template cửa trước.');
                return;
            }
            
            canvasEngine.addVerticalMullion();
        }

        function splitFrame() {
            addVerticalMullion();
        }

        function divideMullion() {
            addHorizontalMullion();
        }

        // Divide modal
        let currentDivideDirection = 'vertical';
        function openDivideModal(direction) {
            currentDivideDirection = direction;
            document.getElementById('divideModalTitle').textContent = direction === 'vertical' ? 'Chia dọc' : 'Chia ngang';
            document.getElementById('divideModal').classList.remove('hidden');
            document.getElementById('divideCount').value = 1;
            document.getElementById('divideEvenly').checked = true;
        }

        function closeDivideModal() {
            document.getElementById('divideModal').classList.add('hidden');
        }

        function applyDivide() {
            const count = parseInt(document.getElementById('divideCount').value) || 1;
            const evenly = document.getElementById('divideEvenly').checked;

            if (!canvasEngine || canvasEngine.panels.length === 0) {
                alert('Chưa có panel nào để chia!');
                closeDivideModal();
                return;
            }

            if (currentDivideDirection === 'vertical') {
                // Chia dọc
                if (evenly) {
                    // Chia đều
                    for (let i = 1; i <= count; i++) {
                        const x = (canvasEngine.doorWidth / (count + 1)) * i;
                        canvasEngine.addVerticalMullion(x);
                    }
                } else {
                    // Chia tại vị trí người dùng chọn (sẽ cải thiện sau)
                    for (let i = 0; i < count; i++) {
                        canvasEngine.addVerticalMullion();
                    }
                }
            } else {
                // Chia ngang
                if (evenly) {
                    // Chia đều
                    for (let i = 1; i <= count; i++) {
                        const y = (canvasEngine.doorHeight / (count + 1)) * i;
                        canvasEngine.addHorizontalMullion(y);
                    }
                } else {
                    // Chia tại vị trí người dùng chọn
                    for (let i = 0; i < count; i++) {
                        canvasEngine.addHorizontalMullion();
                    }
                }
            }

            closeDivideModal();
        }

        // Flip functions
        function flipHorizontal() {
            if (!canvasEngine) {
                alert('Canvas engine chưa được khởi tạo!');
                return;
            }
            canvasEngine.flipHorizontal();
        }

        function flipVertical() {
            if (!canvasEngine) {
                alert('Canvas engine chưa được khởi tạo!');
                return;
            }
            canvasEngine.flipVertical();
        }

        function changePanelDirection() {
            if (!canvasEngine) {
                alert('Canvas engine chưa được khởi tạo!');
                return;
            }
            if (!canvasEngine.selectedPanel) {
                alert('Vui lòng chọn một panel để đổi hướng!');
                return;
            }
            canvasEngine.changePanelDirection();
        }

        // Export modal
        function openExportModal() {
            document.getElementById('exportModal').classList.remove('hidden');
            document.getElementById('exportFileName').value = `cua-thiet-ke-${Date.now()}`;
            document.getElementById('exportFormat').value = 'png';
            document.getElementById('exportQuality').value = 1;
            updateQualityLabel(1);
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function updateQualityLabel(value) {
            document.getElementById('qualityLabel').textContent = Math.round(value * 100) + '%';
        }

        function doExport() {
            if (!canvasEngine) {
                alert('Canvas engine chưa được khởi tạo!');
                return;
            }

            const format = document.getElementById('exportFormat').value;
            const quality = parseFloat(document.getElementById('exportQuality').value);
            const fileName = document.getElementById('exportFileName').value || 'cua-thiet-ke';

            if (format === 'pdf') {
                // Export as PDF using jsPDF
                exportAsPDF(fileName);
            } else {
                // Export as image
                const dataURL = canvasEngine.exportImage(format, quality);
                const link = document.createElement('a');
                link.download = `${fileName}.${format}`;
                link.href = dataURL;
                link.click();
            }

            closeExportModal();
        }

        function exportAsPDF(fileName) {
            // Check if jsPDF is available
            if (typeof window.jspdf === 'undefined') {
                // Load jsPDF dynamically
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = () => {
                    doPDFExport(fileName);
                };
                document.head.appendChild(script);
            } else {
                doPDFExport(fileName);
            }
        }

        function doPDFExport(fileName) {
            const { jsPDF } = window.jspdf;
            const canvas = document.getElementById('drawingCanvas');
            const imgData = canvas.toDataURL('image/png', 1.0);
            
            // Calculate PDF dimensions (A4 landscape)
            const pdfWidth = 297; // mm
            const pdfHeight = 210; // mm
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
            const imgWidthMM = imgWidth * ratio;
            const imgHeightMM = imgHeight * ratio;
            
            const pdf = new jsPDF({
                orientation: imgWidth > imgHeight ? 'landscape' : 'portrait',
                unit: 'mm',
                format: [pdfWidth, pdfHeight]
            });
            
            pdf.addImage(imgData, 'PNG', (pdfWidth - imgWidthMM) / 2, (pdfHeight - imgHeightMM) / 2, imgWidthMM, imgHeightMM);
            pdf.save(`${fileName}.pdf`);
        }

        // Undo/Redo
        function undo() {
            alert('Chức năng Undo đang được phát triển');
        }

        function redo() {
            alert('Chức năng Redo đang được phát triển');
        }

        function deleteSelected() {
            alert('Chức năng Xóa đang được phát triển');
        }

        // Export image (legacy - now opens modal)
        function exportImage() {
            openExportModal();
        }

        // Save drawing
        async function saveDrawing() {
            if (!currentProjectId) {
                alert('Vui lòng chọn dự án trước khi lưu!');
                return;
            }

            try {
                const width = parseInt(document.getElementById('inputWidth').value) || 1200;
                const height = parseInt(document.getElementById('inputHeight').value) || 2400;
                const aluminumSystemId = document.getElementById('selectAluminumSystem').value;
                
                // First, save/update door_design
                let doorDesignId = currentDoorId;
                
                if (currentDoorId) {
                    // Update existing door
                    const updateResponse = await fetch(`${API_BASE}/projects/${currentProjectId}/doors/${currentDoorId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            width_mm: width,
                            height_mm: height,
                            aluminum_system_id: aluminumSystemId || null,
                            params_json: canvasEngine.getCalculatedDimensions()
                        })
                    });
                    const updateResult = await updateResponse.json();
                    if (!updateResult.success) {
                        throw new Error(updateResult.message || 'Không thể cập nhật cửa');
                    }
                } else {
                    // Create new door
                    const createResponse = await fetch(`${API_BASE}/projects/${currentProjectId}/doors`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            template_id: currentTemplate?.id || null,
                            template_code: currentTemplate?.code || 'D1',
                            aluminum_system_id: aluminumSystemId || null,
                            door_type: 'swing',
                            width_mm: width,
                            height_mm: height,
                            params_json: canvasEngine.getCalculatedDimensions()
                        })
                    });
                    const createResult = await createResponse.json();
                    if (createResult.success && createResult.data && createResult.data.id) {
                        doorDesignId = createResult.data.id;
                        currentDoorId = doorDesignId;
                    } else {
                        throw new Error(createResult.message || 'Không thể tạo cửa');
                    }
                }

                // Then save door_drawing
                const calculatedDims = canvasEngine.getCalculatedDimensions();
                const doorJSON = canvasEngine.toJSON(); // Get door structure from canvas engine
                const drawingData = {
                    project_id: currentProjectId,
                    door_design_id: doorDesignId,
                    template_id: currentTemplate?.id || null,
                    template_code: currentTemplate?.code || 'D1',
                    width_mm: width,
                    height_mm: height,
                    drawing_data: {
                        doorWidth: doorJSON.doorWidth || width,
                        doorHeight: doorJSON.doorHeight || height,
                        panels: doorJSON.panels || [],
                        template: currentTemplate,
                        dimensions: calculatedDims,
                        glass_color: canvasEngine.glassColor
                    },
                    svg_data: canvasEngine.toSVG ? canvasEngine.toSVG() : null,
                    image_data: canvasEngine.toDataURL('image/png', 1.0),
                    params_json: calculatedDims,
                    calculated_dimensions: calculatedDims
                };

                // Check if drawing exists
                const checkResponse = await fetch(`${API_BASE}/door-drawings?door_design_id=${doorDesignId}`);
                const checkResult = await checkResponse.json();
                
                let drawingId = null;
                if (checkResult.success && checkResult.data && checkResult.data.length > 0) {
                    drawingId = checkResult.data[0].id;
                }

                const url = drawingId 
                    ? `${API_BASE}/door-drawings/${drawingId}`
                    : `${API_BASE}/door-drawings`;
                const method = drawingId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(drawingData)
                });

                const result = await response.json();
                if (result.success) {
                    alert('Lưu thành công!');
                    // Update door_designs with drawing_image
                    if (result.data && result.data.image_data) {
                        await fetch(`${API_BASE}/projects/${currentProjectId}/doors/${doorDesignId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                drawing_image: result.data.image_data
                            })
                        });
                    }
                } else {
                    alert('Lỗi: ' + (result.message || 'Không thể lưu'));
                }
            } catch (error) {
                console.error('Error saving drawing:', error);
                alert('Lỗi khi lưu: ' + error.message);
            }
        }

        // Load door drawing
        async function loadDoorDrawing(doorId) {
            try {
                console.log('Loading door drawing for doorId:', doorId);
                
                // First try to load from door_drawings (có drawing_data)
                let drawingData = null;
                try {
                    const drawingResponse = await fetch(`${API_BASE}/door-drawings?door_design_id=${doorId}`);
                    const drawingResult = await drawingResponse.json();
                    if (drawingResult.success && drawingResult.data && drawingResult.data.length > 0) {
                        const drawing = drawingResult.data[0];
                        if (drawing.drawing_data) {
                            drawingData = typeof drawing.drawing_data === 'string' 
                                ? JSON.parse(drawing.drawing_data) 
                                : drawing.drawing_data;
                            console.log('Found drawing_data:', drawingData);
                        }
                    }
                } catch (drawingError) {
                    console.log('No door_drawings found, will try door_designs');
                }
                
                // Load from door_designs
                const response = await fetch(`${API_BASE}/projects/${currentProjectId}/doors/${doorId}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const door = result.data;
                    console.log('Loaded door:', door);
                    
                    // Set dimensions first
                    if (door.width_mm && door.height_mm) {
                        canvasEngine.setDimensions(door.width_mm, door.height_mm);
                        document.getElementById('inputWidth').value = door.width_mm;
                        document.getElementById('inputHeight').value = door.height_mm;
                    }
                    
                    // Load template/panels from drawing_data (ưu tiên)
                    let doorLoaded = false;
                    
                    if (drawingData) {
                        if (drawingData.panels && Array.isArray(drawingData.panels) && drawingData.panels.length > 0) {
                            // Có panels trong drawing_data - load trực tiếp
                            console.log('Loading panels from drawing_data:', drawingData.panels);
                            canvasEngine.loadTemplate({ panels: drawingData.panels });
                            canvasEngine.draw();
                            doorLoaded = true;
                        } else if (drawingData.template) {
                            // Có template trong drawing_data
                            loadTemplate(drawingData.template);
                            doorLoaded = true;
                        }
                    }
                    
                    // Nếu chưa load được, thử load từ template_code
                    if (!doorLoaded) {
                        let template = null;
                        if (door.template_code) {
                            template = templates.find(t => t.code === door.template_code || t.id === door.template_id);
                        }
                        
                        if (template) {
                            loadTemplate(template);
                            doorLoaded = true;
                        } else if (door.structure_json) {
                            // Use structure_json as template
                            try {
                                const structure = typeof door.structure_json === 'string' 
                                    ? JSON.parse(door.structure_json) 
                                    : door.structure_json;
                                if (structure.panels && structure.panels.length > 0) {
                                    canvasEngine.loadTemplate({ panels: structure.panels });
                                    canvasEngine.draw();
                                    doorLoaded = true;
                                }
                            } catch (e) {
                                console.error('Error parsing structure_json:', e);
                            }
                        }
                    }
                    
                    // Nếu vẫn chưa có, tạo cửa mặc định 1 cánh
                    if (!doorLoaded || !canvasEngine.panels || canvasEngine.panels.length === 0) {
                        console.log('No template found, creating default 1-panel door');
                        createDefaultDoor();
                    }
                    
                    // Set aluminum system
                    if (door.aluminum_system_id) {
                        document.getElementById('selectAluminumSystem').value = door.aluminum_system_id;
                    }
                    
                    // Set glass color
                    let glassColor = '#87CEEB'; // Default
                    if (drawingData && drawingData.glass_color) {
                        glassColor = drawingData.glass_color;
                    } else if (door.color) {
                        // Map color name to hex
                        const colorMap = {
                            'xanh': '#87CEEB',
                            'trắng': '#FFFFFF',
                            'đen': '#000000'
                        };
                        glassColor = colorMap[door.color.toLowerCase()] || '#87CEEB';
                    }
                    
                    if (canvasEngine && typeof canvasEngine.setGlassColor === 'function') {
                        canvasEngine.setGlassColor(glassColor, true);
                    }
                    
                    // Center và vẽ lại - đảm bảo cửa được hiển thị
                    setTimeout(() => {
                        canvasEngine.center();
                        canvasEngine.draw();
                        // Force redraw và kiểm tra
                        if (canvasEngine.panels && canvasEngine.panels.length > 0) {
                            console.log('Door loaded successfully with', canvasEngine.panels.length, 'panels');
                        } else {
                            console.warn('Warning: No panels loaded, creating default door');
                            createDefaultDoor();
                        }
                    }, 300);
                    
                } else {
                    throw new Error('Không tìm thấy cửa');
                }
            } catch (error) {
                console.error('Error loading door drawing:', error);
                console.log('Creating default door due to error');
                // Tạo cửa mặc định nếu lỗi
                createDefaultDoor();
            }
        }

        // Update drawing
        function updateDrawing() {
            // Trigger redraw
            canvasEngine.draw();
        }

        // BOM Variables
        currentBOMData = null;

        // Calculate BOM
        async function calculateBOM() {
            if (!currentProjectId) {
                alert('Vui lòng chọn dự án trước khi tính BOM!');
                return;
            }

            if (!currentDoorId) {
                alert('Vui lòng lưu thiết kế cửa trước khi tính BOM!');
                return;
            }

            // Show modal and loading
            document.getElementById('bomModal').classList.remove('hidden');
            document.getElementById('bomLoading').classList.remove('hidden');
            document.getElementById('bomContent').classList.add('hidden');
            document.getElementById('bomError').classList.add('hidden');

            try {
                // First, ensure drawing is saved with latest data
                const width = parseInt(document.getElementById('inputWidth').value) || 1200;
                const height = parseInt(document.getElementById('inputHeight').value) || 2400;
                
                // Save drawing_data with current canvas state
                const drawingData = {
                    doorWidth: width,
                    doorHeight: height,
                    panels: canvasEngine.toJSON().panels || []
                };

                // Update door_drawing with latest drawing_data
                const checkResponse = await fetch(`${API_BASE}/door-drawings?door_design_id=${currentDoorId}`);
                const checkResult = await checkResponse.json();
                
                if (checkResult.success && checkResult.data && checkResult.data.length > 0) {
                    const drawingId = checkResult.data[0].id;
                    await fetch(`${API_BASE}/door-drawings/${drawingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            drawing_data: drawingData,
                            width_mm: width,
                            height_mm: height
                        })
                    });
                }

                // Calculate BOM
                const response = await fetch(`${API_BASE}/bom/projects/${currentProjectId}/doors/${currentDoorId}/calculate`);
                const result = await response.json();

                if (result.success) {
                    currentBOMData = result.data;
                    displayBOM(result.data);
                    
                    // Hiển thị cảnh báo tồn kho nếu có
                    if (result.data.stock_warnings && result.data.stock_warnings.length > 0) {
                        displayStockWarnings(result.data.stock_warnings, result.data.stock_status);
                    } else {
                        hideStockWarnings();
                    }
                    
                    document.getElementById('bomLoading').classList.add('hidden');
                    document.getElementById('bomContent').classList.remove('hidden');
                } else {
                    throw new Error(result.message || 'Không thể tính toán BOM');
                }
            } catch (error) {
                console.error('Error calculating BOM:', error);
                document.getElementById('bomLoading').classList.add('hidden');
                document.getElementById('bomError').classList.remove('hidden');
                document.getElementById('bomErrorMessage').textContent = error.message || 'Có lỗi xảy ra khi tính toán BOM';
            }
        }

        // Display BOM
        function displayBOM(data) {
            const summary = data.summary || {};
            
            // Update summary cards
            document.getElementById('bomTotalAluminum').textContent = summary.aluminum_items || 0;
            document.getElementById('bomTotalWeight').textContent = (summary.total_aluminum_weight_kg || 0).toFixed(2);
            document.getElementById('bomTotalGlass').textContent = (summary.total_glass_area_m2 || 0).toFixed(4);
            document.getElementById('bomTotalAccessories').textContent = summary.total_accessories || summary.accessory_items || 0;
            
            // Hiển thị cảnh báo tồn kho nếu có
            if (data.stock_warnings && data.stock_warnings.length > 0) {
                displayStockWarnings(data.stock_warnings, data.stock_status);
            } else {
                hideStockWarnings();
            }

            // Display Aluminum
            const aluminumItems = data.items.filter(item => item.item_type === 'frame' || item.item_type === 'mullion');
            const aluminumTbody = document.getElementById('bomAluminumTableBody');
            aluminumTbody.innerHTML = aluminumItems.length > 0 ? aluminumItems.map(item => `
                <tr>
                    <td class="border border-gray-300 px-4 py-2 text-sm">
                        ${escapeHtml(item.item_name || 'N/A')}
                        ${item.profile_code ? `<br><span class="text-xs text-gray-500">Mã: ${escapeHtml(item.profile_code)}</span>` : ''}
                        ${item.formula_used ? `<br><span class="text-xs text-blue-600">Công thức: ${escapeHtml(item.formula_used)}</span>` : ''}
                    </td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${escapeHtml(item.position || '-')}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center font-medium">${escapeHtml(item.symbol || '-')}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${(item.length_mm || 0).toLocaleString()}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${item.quantity || 1}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${(item.weight_kg || 0).toFixed(3)}</td>
                </tr>
            `).join('') : '<tr><td colspan="6" class="border border-gray-300 px-4 py-2 text-sm text-center text-gray-500">Không có nhôm</td></tr>';

            // Display Glass
            const glassItems = data.items.filter(item => item.item_type === 'glass');
            const glassTbody = document.getElementById('bomGlassTableBody');
            glassTbody.innerHTML = glassItems.length > 0 ? glassItems.map(item => `
                <tr>
                    <td class="border border-gray-300 px-4 py-2 text-sm">${escapeHtml(item.item_name || 'N/A')}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${escapeHtml(item.position || '-')}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${(item.width_mm || item.length_mm || 0).toLocaleString()}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${(item.height_mm || 0).toLocaleString()}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${item.quantity || 1}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${(item.area_m2 || 0).toFixed(4)}</td>
                </tr>
            `).join('') : '<tr><td colspan="6" class="border border-gray-300 px-4 py-2 text-sm text-center text-gray-500">Không có kính</td></tr>';

            // Display Accessories
            const accessoryItems = data.items.filter(item => item.item_type === 'accessory');
            const accessoryTbody = document.getElementById('bomAccessoriesTableBody');
            accessoryTbody.innerHTML = accessoryItems.length > 0 ? accessoryItems.map(item => `
                <tr>
                    <td class="border border-gray-300 px-4 py-2 text-sm">${escapeHtml(item.item_name || 'N/A')}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${escapeHtml(item.item_code || '-')}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${item.quantity || 1}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${escapeHtml(item.unit || 'pcs')}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${escapeHtml(item.position || '-')}</td>
                </tr>
            `).join('') : '<tr><td colspan="5" class="border border-gray-300 px-4 py-2 text-sm text-center text-gray-500">Không có phụ kiện</td></tr>';

            // Display Other Materials
            const otherItems = data.items.filter(item => item.item_type === 'other');
            const otherTbody = document.getElementById('bomOtherTableBody');
            otherTbody.innerHTML = otherItems.length > 0 ? otherItems.map(item => `
                <tr>
                    <td class="border border-gray-300 px-4 py-2 text-sm">${escapeHtml(item.item_name || 'N/A')}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${escapeHtml(item.item_code || '-')}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${item.length_mm ? item.length_mm.toLocaleString() : (item.quantity || 0)}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm text-center">${escapeHtml(item.unit || '-')}</td>
                </tr>
            `).join('') : '<tr><td colspan="4" class="border border-gray-300 px-4 py-2 text-sm text-center text-gray-500">Không có vật tư khác</td></tr>';

            // Show aluminum tab by default
            showBOMTab('aluminum');
        }

        function escapeHtml(text) {
            if (!text) return '';
            if (typeof text !== 'string') text = String(text);
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Hiển thị cảnh báo tồn kho
        function displayStockWarnings(warnings, status) {
            const container = document.getElementById('bomStockWarnings');
            if (!container) return;
            
            if (warnings.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            const isInsufficient = status === 'insufficient';
            const bgColor = isInsufficient ? 'bg-red-50 border-red-300' : 'bg-yellow-50 border-yellow-300';
            const textColor = isInsufficient ? 'text-red-800' : 'text-yellow-800';
            const icon = isInsufficient ? '⚠️' : '⚠️';
            const title = isInsufficient ? 'CẢNH BÁO: Thiếu vật liệu trong kho' : 'Cảnh báo: Tồn kho thấp';
            
            let html = `
                <div class="${bgColor} border-2 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <div class="text-2xl">${icon}</div>
                        <div class="flex-1">
                            <h4 class="font-bold ${textColor} mb-2">${title}</h4>
                            <ul class="list-disc list-inside space-y-1 text-sm ${textColor}">
            `;
            
            warnings.forEach(warning => {
                const statusIcon = warning.status === 'not_found' ? '❌' : 
                                  warning.status === 'insufficient' ? '⚠️' : '⚠️';
                html += `<li>${statusIcon} ${escapeHtml(warning.message)}</li>`;
            });
            
            html += `
                            </ul>
                            ${isInsufficient ? '<p class="mt-2 text-sm font-medium text-red-700">Vui lòng nhập thêm vật liệu trước khi sản xuất!</p>' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            container.classList.remove('hidden');
        }
        
        // Ẩn cảnh báo tồn kho
        function hideStockWarnings() {
            const container = document.getElementById('bomStockWarnings');
            if (container) {
                container.classList.add('hidden');
                container.innerHTML = '';
            }
        }

        // Show BOM Tab
        function showBOMTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.bom-tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.bom-tab-btn').forEach(btn => {
                btn.classList.remove('active', 'text-blue-600', 'border-blue-600');
                btn.classList.add('text-gray-600', 'border-transparent');
            });

            // Show selected tab
            const tabContent = document.getElementById(`bomTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            const tabBtn = document.querySelector(`[onclick="showBOMTab('${tab}')"]`);
            
            if (tabContent) {
                tabContent.classList.remove('hidden');
            }
            if (tabBtn) {
                tabBtn.classList.add('active', 'text-blue-600', 'border-blue-600');
                tabBtn.classList.remove('text-gray-600', 'border-transparent');
            }
        }

        // Close BOM Modal
        function closeBOMModal() {
            document.getElementById('bomModal').classList.add('hidden');
        }

        // Save BOM
        async function saveBOM() {
            if (!currentBOMData || !currentBOMData.items) {
                alert('Không có dữ liệu BOM để lưu!');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/bom/projects/${currentProjectId}/doors/${currentDoorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        items: currentBOMData.items
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Lưu BOM thành công!');
                    closeBOMModal();
                } else {
                    throw new Error(result.message || 'Không thể lưu BOM');
                }
            } catch (error) {
                console.error('Error saving BOM:', error);
                alert('Lỗi khi lưu BOM: ' + error.message);
            }
        }

        // Cutting Optimization Variables
        let currentOptimizationData = null;

        // Optimize Cutting
        async function optimizeCutting() {
            if (!currentProjectId || !currentDoorId) {
                alert('Vui lòng lưu thiết kế cửa trước khi tối ưu cắt!');
                return;
            }

            // Check if BOM exists in database
            try {
                const bomResponse = await fetch(`${API_BASE}/bom/projects/${currentProjectId}/doors/${currentDoorId}`);
                const bomResult = await bomResponse.json();
                
                if (!bomResult.success || !bomResult.data || !bomResult.data.items || bomResult.data.items.length === 0) {
                    const calculateFirst = confirm('Chưa có BOM. Bạn có muốn tính BOM trước không?');
                    if (calculateFirst) {
                        // Close BOM modal if open
                        closeBOMModal();
                        // Calculate BOM
                        await calculateBOM();
                        // Wait a bit for BOM to be saved
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } else {
                        return;
                    }
                }
            } catch (error) {
                console.error('Error checking BOM:', error);
                const calculateFirst = confirm('Không thể kiểm tra BOM. Bạn có muốn tính BOM trước không?');
                if (calculateFirst) {
                    await calculateBOM();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } else {
                    return;
                }
            }

            // Open optimization modal
            document.getElementById('cuttingOptimizationModal').classList.remove('hidden');
            // Auto calculate if modal is opened
            setTimeout(() => {
                calculateCuttingOptimization();
            }, 300);
        }

        // Calculate Cutting Optimization
        async function calculateCuttingOptimization() {
            if (!currentProjectId || !currentDoorId) {
                alert('Vui lòng lưu thiết kế cửa trước!');
                return;
            }

            const barLength = parseInt(document.getElementById('barLengthInput').value) || 6000;
            const kerfWidth = parseFloat(document.getElementById('kerfWidthInput').value) || 3;
            const algorithm = document.getElementById('algorithmSelect')?.value || 'ffd';

            // Show loading
            document.getElementById('cuttingOptimizationLoading').classList.remove('hidden');
            document.getElementById('cuttingOptimizationContent').classList.add('hidden');
            document.getElementById('cuttingOptimizationError').classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE}/cutting-optimization/projects/${currentProjectId}/doors/${currentDoorId}/optimize?bar_length_mm=${barLength}&kerf_width_mm=${kerfWidth}&algorithm=${algorithm}`);
                const result = await response.json();

                if (result.success) {
                    currentOptimizationData = result.data;
                    displayCuttingOptimization(result.data);
                    document.getElementById('cuttingOptimizationLoading').classList.add('hidden');
                    document.getElementById('cuttingOptimizationContent').classList.remove('hidden');
                } else {
                    throw new Error(result.message || 'Không thể tính toán tối ưu cắt');
                }
            } catch (error) {
                console.error('Error calculating cutting optimization:', error);
                document.getElementById('cuttingOptimizationLoading').classList.add('hidden');
                document.getElementById('cuttingOptimizationError').classList.remove('hidden');
                document.getElementById('cuttingOptimizationErrorMessage').textContent = error.message || 'Có lỗi xảy ra khi tính toán tối ưu cắt';
            }
        }

        // Display Cutting Optimization
        function displayCuttingOptimization(data) {
            // Show algorithm info if available
            if (data.optimizations && data.optimizations.length > 0 && data.optimizations[0].algorithm_used) {
                const algorithmNames = {
                    'ffd': 'First Fit Decreasing (FFD)',
                    'bfd': 'Best Fit Decreasing (BFD)',
                    'wfd': 'Worst Fit Decreasing (WFD)'
                };
                const algoInfo = document.getElementById('algorithmInfo');
                if (algoInfo) {
                    const algo = data.optimizations[0].algorithm_used;
                    algoInfo.textContent = `Thuật toán: ${algorithmNames[algo] || algo}`;
                    algoInfo.classList.remove('hidden');
                }
            }
            
            const optimizations = data.optimizations || [];
            
            // Calculate totals
            let totalBars = 0;
            let totalWaste = 0;
            let totalUsed = 0;
            let totalEfficiency = 0;

            optimizations.forEach(opt => {
                totalBars += opt.summary.total_bars || 0;
                totalWaste += opt.summary.total_waste_mm || 0;
                totalUsed += opt.summary.total_used_mm || 0;
                totalEfficiency += opt.summary.overall_efficiency_percent || 0;
            });

            const avgEfficiency = optimizations.length > 0 ? totalEfficiency / optimizations.length : 0;

            // Update summary cards
            document.getElementById('optTotalBars').textContent = totalBars;
            document.getElementById('optEfficiency').textContent = avgEfficiency.toFixed(2) + '%';
            document.getElementById('optTotalWaste').textContent = totalWaste.toFixed(0);
            document.getElementById('optTotalUsed').textContent = totalUsed.toFixed(0);

            // Display optimization results
            const resultsContainer = document.getElementById('cuttingOptimizationResults');
            resultsContainer.innerHTML = '';

            optimizations.forEach((opt, optIndex) => {
                const systemName = opt.aluminum_name || opt.aluminum_code || 'Hệ nhôm ' + (optIndex + 1);
                const barLength = opt.summary.bar_length_mm || 6000;
                
                let systemHtml = `
                    <div class="mb-8 border border-gray-200 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-900">${systemName}</h3>
                            <div class="text-sm text-gray-600">
                                <span class="font-semibold">${opt.summary.total_bars}</span> cây nhôm | 
                                Hiệu suất: <span class="font-semibold">${opt.summary.overall_efficiency_percent}%</span> | 
                                Dư thừa: <span class="font-semibold">${opt.summary.total_waste_mm}mm</span>
                            </div>
                        </div>
                `;

                // Display each bar
                opt.bars.forEach((bar, barIndex) => {
                    const barEfficiency = ((bar.used / barLength) * 100).toFixed(1);
                    const wasteColor = bar.waste > 200 ? 'text-red-600' : bar.waste > 100 ? 'text-orange-600' : 'text-green-600';
                    
                    systemHtml += `
                        <div class="mb-4 border border-gray-300 rounded-lg p-4 bg-gray-50">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-semibold text-gray-900">Cây nhôm #${bar.bar_number}</h4>
                                <div class="text-sm">
                                    <span>Sử dụng: <strong>${bar.used}mm</strong></span> | 
                                    <span>Dư thừa: <strong class="${wasteColor}">${bar.waste}mm</strong></span> | 
                                    <span>Hiệu suất: <strong>${barEfficiency}%</strong></span>
                                </div>
                            </div>
                            
                            <!-- Visual bar representation -->
                            <div class="mb-3 bg-gray-200 rounded-full h-8 relative overflow-hidden">
                                <div class="absolute inset-0 flex">
                                    ${bar.cuts.map((cut, cutIndex) => {
                                        const cutPercent = (cut.length / barLength) * 100;
                                        const cutColor = cutIndex % 2 === 0 ? 'bg-blue-500' : 'bg-blue-400';
                                        return `<div class="${cutColor} border-r border-white" style="width: ${cutPercent}%"></div>`;
                                    }).join('')}
                                    ${bar.waste > 0 ? `<div class="bg-gray-300" style="width: ${(bar.waste / barLength) * 100}%"></div>` : ''}
                                </div>
                            </div>
                            
                            <!-- Cuts table -->
                            <table class="w-full border-collapse text-sm">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border border-gray-300 px-3 py-2 text-left">TT</th>
                                        <th class="border border-gray-300 px-3 py-2 text-left">Tên</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center">Ký hiệu</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center">Chiều dài (mm)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${bar.cuts.map((cut, cutIndex) => `
                                        <tr>
                                            <td class="border border-gray-300 px-3 py-2 text-center">${cutIndex + 1}</td>
                                            <td class="border border-gray-300 px-3 py-2">${cut.name || 'N/A'}</td>
                                            <td class="border border-gray-300 px-3 py-2 text-center">${cut.symbol || '-'}</td>
                                            <td class="border border-gray-300 px-3 py-2 text-center">${cut.length}</td>
                                        </tr>
                                    `).join('')}
                                    ${bar.waste > 0 ? `
                                        <tr class="bg-gray-100">
                                            <td class="border border-gray-300 px-3 py-2 text-center" colspan="3"><strong>Dư thừa</strong></td>
                                            <td class="border border-gray-300 px-3 py-2 text-center ${wasteColor}"><strong>${bar.waste}mm</strong></td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    `;
                });

                systemHtml += '</div>';
                resultsContainer.innerHTML += systemHtml;
            });
        }

        // Close Cutting Optimization Modal
        function closeCuttingOptimizationModal() {
            document.getElementById('cuttingOptimizationModal').classList.add('hidden');
        }

        // Save Cutting Optimization
        async function saveCuttingOptimization() {
            if (!currentOptimizationData || !currentOptimizationData.optimizations) {
                alert('Không có dữ liệu tối ưu cắt để lưu!');
                return;
            }

            try {
                // Save each optimization
                for (const opt of currentOptimizationData.optimizations) {
                    const response = await fetch(`${API_BASE}/cutting-optimization/projects/${currentProjectId}/doors/${currentDoorId}/save`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            aluminum_system_id: opt.aluminum_system_id,
                            bars: opt.bars,
                            summary: opt.summary
                        })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.message || 'Không thể lưu kết quả tối ưu cắt');
                    }
                }

                alert('Lưu kết quả tối ưu cắt thành công!');
            } catch (error) {
                console.error('Error saving cutting optimization:', error);
                alert('Lỗi khi lưu kết quả tối ưu cắt: ' + error.message);
            }
        }

        // Save Optimization (alias for saveCuttingOptimization)
        async function saveOptimization() {
            return saveCuttingOptimization();
        }

        // Print Optimization (alias for printCuttingPlan)
        function printOptimization() {
            return printCuttingPlan();
        }

        // Calculate Optimization (alias for calculateCuttingOptimization)
        function calculateOptimization() {
            return calculateCuttingOptimization();
        }

        // Print Cutting Plan
        function printCuttingPlan() {
            if (!currentOptimizationData) {
                alert('Không có dữ liệu để in!');
                return;
            }

            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('Không thể mở cửa sổ in. Vui lòng cho phép popup.');
                return;
            }

            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Bản cắt nhôm - Cửa #${currentDoorId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #333; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .bar-section { margin: 20px 0; page-break-inside: avoid; }
                        .bar-header { background: #f0f0f0; padding: 10px; font-weight: bold; }
                        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .waste { color: red; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h1>Bản cắt nhôm - Cửa #${currentDoorId}</h1>
            `;

            currentOptimizationData.optimizations.forEach(opt => {
                html += `<h2>${opt.aluminum_name || opt.aluminum_code || 'Hệ nhôm'}</h2>`;
                opt.bars.forEach(bar => {
                    html += `
                        <div class="bar-section">
                            <div class="bar-header">
                                Cây nhôm #${bar.bar_number} | Sử dụng: ${bar.used}mm | Dư thừa: ${bar.waste}mm | Hiệu suất: ${bar.efficiency}%
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>TT</th>
                                        <th>Tên</th>
                                        <th>Ký hiệu</th>
                                        <th>Chiều dài (mm)</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    bar.cuts.forEach((cut, index) => {
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${cut.name || 'N/A'}</td>
                                <td>${cut.symbol || '-'}</td>
                                <td>${cut.length}</td>
                            </tr>
                        `;
                    });
                    if (bar.waste > 0) {
                        html += `
                            <tr>
                                <td colspan="3"><strong>Dư thừa</strong></td>
                                <td class="waste">${bar.waste}mm</td>
                            </tr>
                        `;
                    }
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                });
            });

            html += `</body></html>`;

            printWindow.document.write(html);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }
    </script>
</body>
</html>
