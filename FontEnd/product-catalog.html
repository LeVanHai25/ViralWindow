<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh m·ª•c s·∫£n ph·∫©m - Product Catalog | ViralWindow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/success-notification.css">
    <script src="js/success-notification.js"></script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        /* Full-height layout */
        html,
        body {
            height: 100%;
            margin: 0;
        }

        /* Glassmorphism header */
        .glass-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            backdrop-filter: blur(10px);
        }

        /* Modern tabs */
        .tab-btn {
            position: relative;
            padding: 12px 20px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s ease;
            border-radius: 12px 12px 0 0;
        }

        .tab-btn:hover {
            background: rgba(99, 102, 241, 0.08);
            color: #4f46e5;
        }

        .tab-btn.active {
            background: white;
            color: #4f46e5;
            font-weight: 600;
            box-shadow: 0 -4px 20px rgba(79, 70, 229, 0.15);
        }

        .tab-btn .count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            margin-left: 6px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 10px;
            background: rgba(99, 102, 241, 0.15);
            color: #4f46e5;
        }

        .tab-btn.active .count {
            background: #4f46e5;
            color: white;
        }

        /* Product cards */
        .product-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e2e8f0;
        }

        .product-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            border-color: #818cf8;
        }

        .product-card .image-container {
            position: relative;
            height: 180px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .product-card:hover .image-container {
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
        }

        .product-card .image-container .placeholder-icon {
            font-size: 4rem;
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        .product-card:hover .placeholder-icon {
            transform: scale(1.1);
            opacity: 0.8;
        }

        /* Action buttons */
        .action-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            transform: translateY(-1px);
        }

        /* Type badges */
        .type-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        /* Search input */
        .search-input {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 16px 12px 44px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #818cf8;
            box-shadow: 0 0 0 4px rgba(129, 140, 248, 0.15);
            outline: none;
        }

        /* Filter selects */
        .filter-select {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px 36px 10px 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236366f1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 18px;
        }

        .filter-select:hover {
            border-color: #a5b4fc;
        }

        .filter-select:focus {
            border-color: #818cf8;
            outline: none;
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.15);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Fade animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeInUp 0.5s ease forwards;
        }

        /* Stats badge */
        .stats-badge {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #86efac;
            color: #15803d;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-50 via-indigo-50/30 to-slate-100 min-h-screen">
    <!-- HEADER -->
    <header class="glass-header text-white sticky top-0 z-50 shadow-lg">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="javascript:void(0)" onclick="history.back()" title="Quay l·∫°i trang tr∆∞·ªõc"
                        class="p-2.5 bg-white/20 hover:bg-white/30 rounded-xl transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold tracking-tight">Danh m·ª•c s·∫£n ph·∫©m</h1>
                        <p class="text-white/70 text-sm">Qu·∫£n l√Ω t·∫•t c·∫£ m·∫´u s·∫£n ph·∫©m - C·ª≠a, Lan can, M√°i, C·∫ßu thang</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="stats-badge px-4 py-2 rounded-xl font-semibold text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                        <span id="totalProductCount">0</span> s·∫£n ph·∫©m
                    </div>
                    <button onclick="openAddModal()"
                        class="px-5 py-2.5 bg-white text-indigo-600 rounded-xl hover:bg-indigo-50 flex items-center gap-2 font-semibold shadow-lg hover:shadow-xl transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Th√™m s·∫£n ph·∫©m
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- TABS + FILTERS -->
    <div class="bg-gradient-to-r from-slate-100 to-indigo-100/50 border-b border-slate-200 sticky top-[76px] z-40">
        <div class="px-6">
            <!-- Product Type Tabs -->
            <div class="flex items-center gap-1 overflow-x-auto pt-3" id="productTypeTabs">
                <button onclick="selectType('')" data-type="" class="tab-btn active">
                    üì¶ T·∫•t c·∫£ <span class="count" id="countAll">0</span>
                </button>
                <button onclick="selectType('door')" data-type="door" class="tab-btn">
                    üö™ C·ª≠a ƒëi <span class="count" id="countDoor">0</span>
                </button>
                <button onclick="selectType('window')" data-type="window" class="tab-btn">
                    ü™ü C·ª≠a s·ªï <span class="count" id="countWindow">0</span>
                </button>
                <button onclick="selectType('railing')" data-type="railing" class="tab-btn">
                    üèóÔ∏è Lan can <span class="count" id="countRailing">0</span>
                </button>
                <button onclick="selectType('glass_wall')" data-type="glass_wall" class="tab-btn">
                    üß± V√°ch k√≠nh <span class="count" id="countGlassWall">0</span>
                </button>
                <button onclick="selectType('roof')" data-type="roof" class="tab-btn">
                    üè† M√°i k√≠nh <span class="count" id="countRoof">0</span>
                </button>
                <button onclick="selectType('stair')" data-type="stair" class="tab-btn">
                    ü™ú C·∫ßu thang <span class="count" id="countStair">0</span>
                </button>
            </div>

            <!-- Filters -->
            <div class="flex items-center gap-4 py-4 bg-white -mx-6 px-6 rounded-t-2xl mt-2 shadow-sm">
                <div class="relative flex-1 max-w-md">
                    <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" id="searchInput" placeholder="T√¨m theo t√™n, m√£ s·∫£n ph·∫©m..."
                        class="search-input w-full" oninput="filterProducts()">
                </div>
                <select id="categoryFilter" class="filter-select min-w-[180px]" onchange="filterProducts()">
                    <option value="">T·∫•t c·∫£ category</option>
                </select>
                <select id="systemFilter" class="filter-select min-w-[160px]" onchange="filterProducts()">
                    <option value="">T·∫•t c·∫£ h·ªá nh√¥m</option>
                </select>
                <div class="ml-auto flex items-center gap-2 text-sm text-slate-500">
                    <span>Hi·ªÉn th·ªã</span>
                    <span id="visibleCount" class="font-bold text-indigo-600">0</span>
                    <span>s·∫£n ph·∫©m</span>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="p-6 bg-white min-h-[calc(100vh-250px)]">
        <div id="productGrid"
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-7 gap-5">
            <!-- Products loaded here -->
        </div>

        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20">
            <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-6">
                <svg class="w-12 h-12 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-slate-600 mb-2">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</h3>
            <p class="text-slate-400 mb-6">B·∫Øt ƒë·∫ßu b·∫±ng c√°ch th√™m s·∫£n ph·∫©m ƒë·∫ßu ti√™n</p>
            <button onclick="openAddModal()"
                class="px-6 py-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition-all flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Th√™m s·∫£n ph·∫©m m·ªõi
            </button>
        </div>
    </main>

    <!-- ADD/EDIT MODAL -->
    <div id="productModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl max-h-[90vh] overflow-hidden animate-fade-in">
            <div
                class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-5 flex justify-between items-center">
                <h2 id="modalTitle" class="text-xl font-bold">Th√™m s·∫£n ph·∫©m m·ªõi</h2>
                <button onclick="closeModal()" class="p-2 hover:bg-white/20 rounded-lg transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="productForm" class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                <input type="hidden" id="productId">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">M√£ s·∫£n ph·∫©m <span
                                class="text-red-500">*</span></label>
                        <input type="text" id="productCode" required
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all"
                            placeholder="VD: RAIL_GLASS_01">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">T√™n s·∫£n ph·∫©m <span
                                class="text-red-500">*</span></label>
                        <input type="text" id="productName" required
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all"
                            placeholder="VD: Lan can k√≠nh">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Lo·∫°i s·∫£n ph·∫©m <span
                                class="text-red-500">*</span></label>
                        <select id="productType" required onchange="updateCategoryOptions()"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 transition-all">
                            <option value="">-- Ch·ªçn lo·∫°i --</option>
                            <option value="door">üö™ C·ª≠a ƒëi</option>
                            <option value="window">ü™ü C·ª≠a s·ªï</option>
                            <option value="railing">üèóÔ∏è Lan can</option>
                            <option value="glass_wall">üß± V√°ch k√≠nh</option>
                            <option value="roof">üè† M√°i k√≠nh</option>
                            <option value="stair">ü™ú C·∫ßu thang</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Category <span
                                class="text-red-500">*</span></label>
                        <select id="productCategory" required
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 transition-all">
                            <option value="">-- Ch·ªçn category --</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">H·ªá nh√¥m</label>
                        <select id="productAluminumSystem"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 transition-all">
                            <option value="">-- Ch·ªçn h·ªá --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Lo·∫°i k√≠nh</label>
                        <input type="text" id="productGlassType"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 transition-all"
                            placeholder="K√≠nh c∆∞·ªùng l·ª±c 10mm">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">R·ªông (mm)</label>
                        <input type="number" id="productWidth"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 transition-all"
                            placeholder="1200" value="1200">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Cao (mm)</label>
                        <input type="number" id="productHeight"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 transition-all"
                            placeholder="2200" value="2200">
                    </div>
                </div>

                <div class="mt-4">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">M√¥ t·∫£</label>
                    <textarea id="productDescription" rows="2"
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 transition-all resize-none"
                        placeholder="M√¥ t·∫£ chi ti·∫øt..."></textarea>
                </div>

                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-100">
                    <button type="button" onclick="closeModal()"
                        class="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-semibold transition-all">H·ªßy</button>
                    <button type="submit"
                        class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-xl font-semibold transition-all shadow-lg">L∆∞u
                        s·∫£n ph·∫©m</button>
                </div>
            </form>
        </div>
    </div>

    <!-- DETAIL MODAL -->
    <div id="detailModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden animate-fade-in">
            <div
                class="bg-gradient-to-r from-teal-600 to-emerald-600 text-white px-6 py-5 flex justify-between items-center">
                <h2 id="detailTitle" class="text-xl font-bold">Chi ti·∫øt s·∫£n ph·∫©m</h2>
                <button onclick="closeDetailModal()" class="p-2 hover:bg-white/20 rounded-lg transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="detailContent" class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let allProducts = [];
        let allSystems = [];
        let currentType = '';
        let typeCounts = {};

        const typeLabels = { door: 'üö™ C·ª≠a ƒëi', window: 'ü™ü C·ª≠a s·ªï', railing: 'üèóÔ∏è Lan can', glass_wall: 'üß± V√°ch k√≠nh', roof: 'üè† M√°i k√≠nh', stair: 'ü™ú C·∫ßu thang', other: 'üì¶ Kh√°c' };
        const typeColors = { door: 'bg-blue-100 text-blue-700 border-blue-200', window: 'bg-cyan-100 text-cyan-700 border-cyan-200', railing: 'bg-purple-100 text-purple-700 border-purple-200', glass_wall: 'bg-amber-100 text-amber-700 border-amber-200', roof: 'bg-emerald-100 text-emerald-700 border-emerald-200', stair: 'bg-pink-100 text-pink-700 border-pink-200', other: 'bg-slate-100 text-slate-700 border-slate-200' };
        const categoryOptions = {
            door: [
                { value: 'door_swing', label: 'C·ª≠a ƒëi m·ªü quay' },
                { value: 'door_slide', label: 'C·ª≠a ƒëi l√πa' },
                { value: 'door_fold', label: 'C·ª≠a x·∫øp tr∆∞·ª£t' },
                { value: 'door_special', label: 'C·ª≠a ƒë·∫∑c bi·ªát' }
            ],
            window: [
                { value: 'window_tilt', label: 'C·ª≠a s·ªï m·ªü h·∫•t' },
                { value: 'window_swing', label: 'C·ª≠a s·ªï m·ªü quay' },
                { value: 'window_slide', label: 'C·ª≠a s·ªï l√πa' },
                { value: 'window_special', label: 'C·ª≠a s·ªï ƒë·∫∑c bi·ªát' }
            ],
            railing: [{ value: 'railing', label: 'Lan can' }],
            glass_wall: [{ value: 'glass_wall', label: 'V√°ch k√≠nh' }],
            roof: [{ value: 'roof', label: 'M√°i k√≠nh' }],
            stair: [{ value: 'stair', label: 'C·∫ßu thang' }],
            other: [{ value: 'other', label: 'Kh√°c' }]
        };

        document.addEventListener('DOMContentLoaded', () => { loadProducts(); loadSystems(); });

        async function loadProducts() {
            try {
                let url = `${API_BASE}/product-templates`;
                if (currentType) url += `?product_type=${currentType}`;
                const response = await fetch(url);
                const result = await response.json();
                if (result.success) {
                    allProducts = result.data;
                    calculateTypeCounts();
                    filterProducts();
                    updateCategoryFilter();
                } else { await loadFromDoorTemplates(); }
            } catch (error) { await loadFromDoorTemplates(); }
        }

        async function loadFromDoorTemplates() {
            try {
                const response = await fetch(`${API_BASE}/door-templates`);
                const result = await response.json();
                if (result.success) {
                    allProducts = result.data.map(d => ({ ...d, product_type: d.family?.includes('win') ? 'window' : 'door' }));
                    calculateTypeCounts();
                    filterProducts();
                }
            } catch (e) { console.error('Fallback failed:', e); }
        }

        function calculateTypeCounts() {
            typeCounts = { all: allProducts.length, door: 0, window: 0, railing: 0, glass_wall: 0, roof: 0, stair: 0 };
            allProducts.forEach(p => { if (typeCounts[p.product_type] !== undefined) typeCounts[p.product_type]++; });
            document.getElementById('countAll').textContent = typeCounts.all;
            document.getElementById('countDoor').textContent = typeCounts.door;
            document.getElementById('countWindow').textContent = typeCounts.window;
            document.getElementById('countRailing').textContent = typeCounts.railing;
            document.getElementById('countGlassWall').textContent = typeCounts.glass_wall;
            document.getElementById('countRoof').textContent = typeCounts.roof;
            document.getElementById('countStair').textContent = typeCounts.stair;
            document.getElementById('totalProductCount').textContent = typeCounts.all;
        }

        async function loadSystems() {
            try {
                const response = await fetch(`${API_BASE}/product-templates/systems`);
                const result = await response.json();
                if (result.success) { allSystems = result.data; populateSystemSelect(); }
            } catch (error) {
                try { const response = await fetch(`${API_BASE}/door-templates/systems`); const result = await response.json(); if (result.success) { allSystems = result.data; populateSystemSelect(); } } catch (e) { }
            }
        }

        function populateSystemSelect() {
            const opts = allSystems.map(s => `<option value="${s.aluminum_system || s.code}">${s.aluminum_system || s.code}</option>`).join('');
            document.getElementById('systemFilter').innerHTML = '<option value=\"\">T·∫•t c·∫£ h·ªá nh√¥m</option>' + opts;
            document.getElementById('productAluminumSystem').innerHTML = '<option value=\"\">-- Ch·ªçn h·ªá --</option>' + opts;
        }

        // Category labels ti·∫øng Vi·ªát
        const categoryLabels = {
            'door_swing': 'C·ª≠a ƒëi m·ªü quay',
            'door_slide': 'C·ª≠a ƒëi l√πa',
            'door_fold': 'C·ª≠a x·∫øp tr∆∞·ª£t',
            'door_special': 'C·ª≠a ƒë·∫∑c bi·ªát',
            'window_tilt': 'C·ª≠a s·ªï m·ªü h·∫•t',
            'window_swing': 'C·ª≠a s·ªï m·ªü quay',
            'window_slide': 'C·ª≠a s·ªï l√πa',
            'window_special': 'C·ª≠a s·ªï ƒë·∫∑c bi·ªát',
            'glass_wall': 'V√°ch k√≠nh',
            'railing': 'Lan can',
            'roof': 'M√°i k√≠nh',
            'stair': 'C·∫ßu thang'
        };

        function updateCategoryFilter() {
            const categories = [...new Set(allProducts.map(p => p.category))].filter(Boolean);
            document.getElementById('categoryFilter').innerHTML = '<option value=\"\">T·∫•t c·∫£ category</option>' + categories.map(c => `<option value=\"${c}\">${categoryLabels[c] || c}</option>`).join('');
        }

        function selectType(type) {
            currentType = type;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            loadProducts();
        }

        function filterProducts() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const system = document.getElementById('systemFilter').value;
            let filtered = allProducts.filter(p => {
                const matchSearch = !search || (p.name?.toLowerCase().includes(search)) || (p.code?.toLowerCase().includes(search));
                const matchCategory = !category || p.category === category;
                const matchSystem = !system || p.aluminum_system === system;
                return matchSearch && matchCategory && matchSystem;
            });
            renderProducts(filtered);
            document.getElementById('visibleCount').textContent = filtered.length;
        }

        function renderProducts(products) {
            const grid = document.getElementById('productGrid');
            const empty = document.getElementById('emptyState');
            if (products.length === 0) { grid.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            grid.innerHTML = products.map((p, i) => createProductCard(p, i)).join('');
        }

        function createProductCard(p, index) {
            const pType = p.product_type || 'other';
            const icon = typeLabels[pType]?.split(' ')[0] || 'üì¶';
            return `
                <div class="product-card animate-fade-in" style="animation-delay: ${index * 30}ms" onclick="viewProductDetail(${p.id})">
                    <div class="image-container">
                        ${p.preview_image
                    ? `<img src="${API_BASE.replace('/api', '')}${p.preview_image}" class="w-full h-full object-contain p-3" alt="${p.name}">`
                    : `<span class="placeholder-icon">${icon}</span>`}
                    </div>
                    <div class="p-4">
                        <div class="flex items-start justify-between gap-2 mb-2">
                            <span class="type-badge ${typeColors[pType]} border">${typeLabels[pType]?.replace(icon, '').trim() || 'Kh√°c'}</span>
                            <span class="text-xs text-slate-400 font-mono">${p.code || ''}</span>
                        </div>
                        <h3 class="font-semibold text-slate-800 text-sm leading-tight mb-2 line-clamp-2">${p.name || 'Ch∆∞a ƒë·∫∑t t√™n'}</h3>
                        <p class="text-xs text-slate-500 mb-3">${p.default_width_mm || 1200} √ó ${p.default_height_mm || 2200} mm</p>
                        <div class="flex gap-2">
                            <button onclick="event.stopPropagation(); editProduct(${p.id})" class="action-btn flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700">S·ª≠a</button>
                            <button onclick="event.stopPropagation(); deleteProduct(${p.id})" class="action-btn bg-red-100 hover:bg-red-200 text-red-600 px-3">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateCategoryOptions() {
            const type = document.getElementById('productType').value;
            const opts = categoryOptions[type] || categoryOptions.other;
            document.getElementById('productCategory').innerHTML = '<option value="">-- Ch·ªçn category --</option>' + opts.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Th√™m s·∫£n ph·∫©m m·ªõi';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productModal').classList.remove('hidden');
            document.getElementById('productModal').classList.add('flex');
        }

        async function editProduct(id) {
            try {
                const response = await fetch(`${API_BASE}/product-templates/${id}`);
                const result = await response.json();
                if (result.success) {
                    const p = result.data;
                    document.getElementById('modalTitle').textContent = 'S·ª≠a s·∫£n ph·∫©m';
                    document.getElementById('productId').value = p.id;
                    document.getElementById('productCode').value = p.code || '';
                    document.getElementById('productName').value = p.name || '';
                    document.getElementById('productType').value = p.product_type || '';
                    updateCategoryOptions();
                    document.getElementById('productCategory').value = p.category || '';
                    document.getElementById('productAluminumSystem').value = p.aluminum_system || '';
                    document.getElementById('productGlassType').value = p.glass_type || '';
                    document.getElementById('productWidth').value = p.default_width_mm || 1200;
                    document.getElementById('productHeight').value = p.default_height_mm || 2200;
                    document.getElementById('productDescription').value = p.description || '';
                    document.getElementById('productModal').classList.remove('hidden');
                    document.getElementById('productModal').classList.add('flex');
                }
            } catch (error) { alert('L·ªói khi t·∫£i s·∫£n ph·∫©m'); }
        }

        function closeModal() { document.getElementById('productModal').classList.add('hidden'); document.getElementById('productModal').classList.remove('flex'); }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const isEdit = !!id;
            const data = {
                code: document.getElementById('productCode').value,
                name: document.getElementById('productName').value,
                product_type: document.getElementById('productType').value,
                category: document.getElementById('productCategory').value,
                aluminum_system: document.getElementById('productAluminumSystem').value,
                glass_type: document.getElementById('productGlassType').value,
                default_width_mm: parseInt(document.getElementById('productWidth').value) || 1200,
                default_height_mm: parseInt(document.getElementById('productHeight').value) || 2200,
                description: document.getElementById('productDescription').value
            };
            try {
                const url = isEdit ? `${API_BASE}/product-templates/${id}` : `${API_BASE}/product-templates`;
                const response = await fetch(url, { method: isEdit ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) { closeModal(); loadProducts(); showSuccessNotification(isEdit ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m th√†nh c√¥ng!'); }
                else { alert('L·ªói: ' + result.message); }
            } catch (error) { alert('L·ªói khi l∆∞u'); }
        });

        async function deleteProduct(id) {
            if (!confirm('X√≥a s·∫£n ph·∫©m n√†y?')) return;
            try {
                const response = await fetch(`${API_BASE}/product-templates/${id}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) { loadProducts(); } else { alert('L·ªói: ' + result.message); }
            } catch (error) { alert('L·ªói khi x√≥a'); }
        }

        async function viewProductDetail(id) { await previewBom(id); }

        async function previewBom(id) {
            try {
                const response = await fetch(`${API_BASE}/product-templates/${id}`);
                const result = await response.json();
                if (result.success) {
                    const p = result.data;
                    document.getElementById('detailTitle').textContent = p.name;
                    let bomData = null;
                    try { const bomResponse = await fetch(`${API_BASE}/product-templates/${id}/bom-preview`); const bomResult = await bomResponse.json(); bomData = bomResult.data; } catch (e) { }
                    document.getElementById('detailContent').innerHTML = renderDetailContent(p, bomData);
                    document.getElementById('detailModal').classList.remove('hidden');
                    document.getElementById('detailModal').classList.add('flex');
                }
            } catch (error) { console.error('Error:', error); }
        }

        function renderDetailContent(p, bomData) {
            const pType = p.product_type || 'other';
            const icon = typeLabels[pType]?.split(' ')[0] || 'üì¶';
            // Kh√¥ng hi·ªÉn th·ªã BOM theo y√™u c·∫ßu
            return `
                <div class="flex gap-6">
                    <div class="w-40 h-40 bg-gradient-to-br from-slate-100 to-slate-200 rounded-2xl flex items-center justify-center flex-shrink-0">
                        ${p.preview_image ? `<img src="${API_BASE.replace('/api', '')}${p.preview_image}" class="w-full h-full object-contain rounded-2xl" alt="${p.name}">` : `<span class="text-5xl">${icon}</span>`}
                    </div>
                    <div class="flex-1">
                        <div class="inline-block mb-3"><span class="type-badge ${typeColors[pType]} border text-sm">${typeLabels[pType]}</span></div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><span class="text-slate-500">M√£:</span> <span class="font-semibold text-slate-800">${p.code}</span></div>
                            <div><span class="text-slate-500">Ph√¢n lo·∫°i:</span> <span class="font-medium text-slate-700">${categoryLabels[p.category] || p.category || '-'}</span></div>
                            <div><span class="text-slate-500">K√≠ch th∆∞·ªõc:</span> <span class="font-medium text-slate-700">${p.default_width_mm} √ó ${p.default_height_mm} mm</span></div>
                            <div><span class="text-slate-500">H·ªá nh√¥m:</span> <span class="font-medium text-slate-700">${p.aluminum_system || '-'}</span></div>
                            <div><span class="text-slate-500">Lo·∫°i k√≠nh:</span> <span class="font-medium text-slate-700">${p.glass_type || '-'}</span></div>
                        </div>
                        ${p.description ? `<p class="mt-3 text-sm text-slate-600 bg-slate-50 p-3 rounded-lg">${p.description}</p>` : ''}
                    </div>
                </div>
            `;
        }

        function closeDetailModal() { document.getElementById('detailModal').classList.add('hidden'); document.getElementById('detailModal').classList.remove('flex'); }
    </script>
</body>

</html>