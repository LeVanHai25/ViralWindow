<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo giá - ViralWindow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/sidebar-enterprise.css">
    <link rel="stylesheet" href="css/notification-system.css">
    <link rel="stylesheet" href="css/notification-header.css">
    <link rel="stylesheet" href="css/success-notification.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Sidebar and main-content styles are now in sidebar-enterprise.css */
        /* Keeping only page-specific styles here */

        .header-gradient {
            background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .item-row:hover {
            background-color: #f9fafb;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .locked {
            opacity: 0.6;
            pointer-events: none;
        }

        #itemsTableSection,
        #summarySection {
            transition: opacity 0.3s ease-in-out;
        }


        /* Table cell wrapping and auto-expand */
        .table-cell-wrap {
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            vertical-align: top;
        }

        .table-input {
            width: 100%;
            min-height: 2rem;
            resize: none;
            overflow: hidden;
            /* Bỏ thanh cuộn, tự giãn chiều cao */
            overflow-wrap: break-word;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .table-input-small {
            width: 100%;
            min-width: 60px;
        }

        /* Column widths - Thiết kế lại theo yêu cầu */
        .col-stt {
            width: 40px;
            min-width: 40px;
            max-width: 40px;
        }

        .col-code {
            width: 70px;
            min-width: 70px;
            max-width: 70px;
        }

        /* Phương án thiết kế cửa nhôm Viralwindow - Tổng 600px */
        .col-design {
            width: 600px;
            min-width: 550px;
        }

        /* Quy cách - 50% của Phương án thiết kế */
        .col-spec {
            width: 300px;
            min-width: 280px;
        }

        /* Kính - 25% của Phương án thiết kế */
        .col-glass {
            width: 150px;
            min-width: 130px;
        }

        /* Phụ kiện - Thu gọn */
        .col-accessories {
            width: 100px;
            min-width: 80px;
        }

        /* Kích thước (mm) - Mở rộng */
        .col-width {
            width: 72px;
            min-width: 72px;
            max-width: 80px;
        }

        .col-height {
            width: 72px;
            min-width: 72px;
            max-width: 80px;
        }

        .col-area {
            width: 75px;
            min-width: 70px;
            max-width: 80px;
        }

        /* Số bộ - Ô text để nhập, sửa và nhân dữ liệu */
        .col-quantity {
            width: 55px;
            min-width: 55px;
            max-width: 55px;
        }

        .col-unit-price {
            width: 100px;
            min-width: 90px;
        }

        .col-accessory-price {
            width: 100px;
            min-width: 90px;
        }

        .col-total {
            width: 110px;
            min-width: 100px;
        }

        /* Thao tác - Tăng kích thước */
        .col-actions {
            width: 60px;
            min-width: 60px;
            max-width: 60px;
        }

        /* Header styling */
        thead th {
            text-align: center;
            vertical-align: middle;
        }

        /* Custom Select Styling - Bỏ mũi tên và cải thiện giao diện */
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: none;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        select:hover {
            border-color: #9CA3AF;
        }

        /* Cải thiện giao diện phần thông tin khách hàng & công trình */
        .customer-project-section {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .customer-project-section h2 {
            color: #1f2937;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-group label::after {
            content: '';
        }

        .form-group label[for*="customer"]::after,
        .form-group label:has(+ select[required])::after {
            content: ' *';
            color: #ef4444;
        }

        .modern-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            color: #1f2937;
            background-color: white;
            transition: all 0.3s ease;
        }

        .modern-select:focus {
            border-color: #3B82F6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .modern-select:hover {
            border-color: #9CA3AF;
        }

        .customer-info-card {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .customer-info-card.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 15px;
            color: #1f2937;
            font-weight: 600;
        }

        .info-item.full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>

<body>

    <!-- Header Notification (Top Right) -->
    <div class="header-notification-container">
        <button id="headerNotificationButton" class="header-notification-button" onclick="toggleHeaderNotifications()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <span id="headerNotificationBadge" class="header-notification-badge hidden">0</span>
        </button>

        <div id="headerNotificationsDropdown" class="header-notifications-dropdown">
            <div class="header-notifications-header">
                <h3>Thông báo</h3>
            </div>
            <div id="headerNotificationsList" class="header-notifications-list">
                <!-- Notifications will be loaded here -->
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar text-white">
        <!-- Logo -->
        <a href="settings.html" class="sidebar-logo block">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-400 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0"
                    id="companyLogoContainer">
                    <img id="companyLogo" src="" alt="Logo" class="hidden w-full h-full object-contain">
                    <svg id="companyLogoIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" class="w-6 h-6 text-white">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <span class="text-xl font-bold" id="companyName">ViralWindow</span>
            </div>
        </a>

        <!-- User Profile -->
        <div class="p-4 border-b border-blue-600 relative">
            <div class="flex items-center gap-3 cursor-pointer hover:bg-blue-700 rounded-lg p-2"
                onclick="toggleSidebarUserMenu()">
                <div class="w-10 h-10 bg-blue-400 rounded-full flex items-center justify-center font-semibold overflow-hidden"
                    id="sidebarUserAvatar">
                    <div id="sidebarUserAvatarInitial">U</div>
                    <img id="sidebarUserAvatarImage" src="" alt="Avatar"
                        class="hidden w-full h-full object-cover rounded-full">
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-sm" id="sidebarUserName">Lê Văn Hải</div>
                    <div class="text-xs text-blue-200">Quản lý</div>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <!-- User Menu Dropdown -->
            <div id="sidebarUserMenuDropdown"
                class="hidden absolute left-0 right-0 mt-2 bg-white rounded-lg shadow-xl z-[9999] border border-gray-200">
                <div class="p-2">
                    <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">Hồ
                        sơ</a>
                    <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">Cài
                        đặt</a>
                    <hr class="my-2">
                    <button onclick="handleLogout()"
                        class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 rounded">Đăng
                        xuất</button>
                </div>
            </div>
        </div>


        <!-- Navigation Menu -->
        <nav class="sidebar-nav">
            <!-- TỔNG QUAN -->
            <a href="index.html" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span>TỔNG QUAN</span>
            </a>

            <!-- KINH DOANH -->
            <div class="nav-item has-submenu expanded">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span>KINH DOANH</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu expanded">
                <a href="sales.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span>Khách hàng & Dự án</span>
                </a>
                <a href="quotation-new.html" class="submenu-item active">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Báo giá</span>
                </a>
            </div>

            <!-- KỸ THUẬT -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>KỸ THUẬT</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="design-new.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                    <span>Thiết kế & Bóc tách</span>
                </a>
                <a href="material-requests.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Yêu cầu vật tư</span>
                </a>
            </div>

            <!-- SẢN XUẤT -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                    </svg>
                    <span>SẢN XUẤT</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="production.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                    <span>Quy trình sản xuất</span>
                </a>
                <a href="production-management.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Lệnh sản xuất</span>
                </a>
            </div>

            <!-- KHO & VẬT TƯ -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    <span>KHO & VẬT TƯ</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="inventory.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    <span>Kho vật tư</span>
                </a>
                <a href="exported-materials.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                    <span>Xuất vật tư</span>
                </a>
            </div>

            <!-- THI CÔNG & NGHIỆM THU -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>THI CÔNG & NGHIỆM THU</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="installation.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>Lắp đặt</span>
                </a>
                <a href="handover.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    <span>Bàn giao</span>
                </a>
            </div>

            <!-- TÀI CHÍNH -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>TÀI CHÍNH</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="finance-dashboard.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span>Tài chính</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <!-- HEADER BAR - Modern Enterprise Design -->
        <div class="header-gradient text-white shadow-lg sticky top-0 z-50">
            <div class="w-full px-6 py-4">
                <div class="flex items-center justify-between">
                    <!-- Left: Project Info -->
                    <div class="flex items-center gap-4">
                        <div class="bg-white/10 rounded-xl p-3">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" class="w-8 h-8">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold tracking-tight" id="projectName">Tên dự án / Công trình</h1>
                            <div class="flex items-center gap-3 mt-1">
                                <span
                                    class="inline-flex items-center gap-1.5 text-sm bg-white/15 px-3 py-1 rounded-full">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                                    </svg>
                                    <span id="quoteCode"></span>
                                </span>
                                <span
                                    class="px-3 py-1 bg-emerald-500/80 rounded-full text-xs font-semibold uppercase tracking-wide"
                                    id="quoteStatus">Bản nháp</span>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Action Buttons -->
                    <div class="flex items-center gap-2">
                        <!-- Primary Actions Group -->
                        <div class="flex items-center gap-2 bg-white/10 rounded-xl p-1.5">
                            <button onclick="resetQuotation()" id="resetBtn"
                                class="p-2.5 hover:bg-white/15 rounded-lg transition-all duration-200 hidden"
                                title="Thiết lập lại">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                            </button>
                            <button onclick="showQuotationHistory()"
                                class="p-2.5 hover:bg-white/15 rounded-lg transition-all duration-200"
                                title="Lịch sử báo giá">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                            <button onclick="saveQuotation()"
                                class="flex items-center gap-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg text-sm font-medium transition-all duration-200"
                                title="Lưu báo giá">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                </svg>
                                Lưu báo giá
                            </button>
                        </div>

                        <!-- Send & Export Group -->
                        <div class="flex items-center gap-2 bg-white/10 rounded-xl p-1.5">
                            <button onclick="sendQuotation()" id="sendQuotationBtn"
                                class="flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 rounded-lg text-sm font-medium transition-all duration-200"
                                title="Gửi báo giá">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                                Gửi báo giá
                            </button>
                            <button onclick="exportExcel()"
                                class="flex items-center gap-2 px-4 py-2 bg-purple-500 hover:bg-purple-600 rounded-lg text-sm font-medium transition-all duration-200"
                                title="Xuất Excel">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Xuất Excel
                            </button>
                        </div>

                        <!-- Approval Actions -->
                        <div class="flex items-center gap-2">
                            <button onclick="approveQuotation()" id="approveBtn"
                                class="flex items-center gap-2 px-4 py-2 bg-amber-500 hover:bg-amber-600 rounded-lg text-sm font-medium transition-all duration-200"
                                title="Chốt báo giá">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Chốt báo giá
                            </button>
                            <button onclick="signContract()" id="signContractBtn"
                                class="flex items-center gap-2 px-4 py-2 bg-rose-500 hover:bg-rose-600 rounded-lg text-sm font-medium transition-all duration-200 hidden"
                                title="Chốt hợp đồng">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                Chốt hợp đồng
                            </button>
                            <button onclick="cancelQuotation()" id="cancelBtn"
                                class="p-2.5 hover:bg-white/15 rounded-lg transition-all duration-200"
                                title="Hủy báo giá">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full">
            <!-- THÔNG BÁO BÁO GIÁ ĐÃ CHỐT (approved) -->
            <div id="approvedNotification"
                class="hidden mb-4 p-4 bg-amber-50 border-l-4 border-amber-500 rounded-lg mx-6 mt-4">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-amber-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h3 class="text-lg font-semibold text-amber-800">✅ Đã chốt báo giá</h3>
                        <p class="text-sm text-amber-700">Báo giá này đã được chốt. Bạn có thể chốt hợp đồng để chuyển
                            sang giai đoạn thiết kế.</p>
                    </div>
                </div>
            </div>

            <!-- THÔNG BÁO ĐÃ CHỐT HỢP ĐỒNG (contract_signed) -->
            <div id="contractSignedNotification"
                class="hidden mb-4 p-4 bg-emerald-50 border-l-4 border-emerald-500 rounded-lg mx-6 mt-4">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-emerald-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z">
                        </path>
                    </svg>
                    <div>
                        <h3 class="text-lg font-semibold text-emerald-800">✅ Đã chốt hợp đồng thành công</h3>
                        <p class="text-sm text-emerald-700">Báo giá này đã được chốt hợp đồng và không thể chỉnh sửa. Dự
                            án đã chuyển sang giai đoạn thiết kế.</p>
                    </div>
                </div>
            </div>

            <!-- CONTENT WRAPPER -->
            <div class="p-6 space-y-6">
                <!-- THÔNG TIN KHÁCH HÀNG + CÔNG TRÌNH -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4">
                        <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            Thông tin khách hàng & Công trình
                        </h2>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label for="customerSelect" class="block text-sm font-semibold text-gray-700 mb-2">
                                    Chọn khách hàng <span class="text-red-500">*</span>
                                </label>
                                <select id="customerSelect" class="modern-select" onchange="loadCustomerInfo()"
                                    required>
                                    <option value="">-- Chọn khách hàng --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="projectSelect" class="block text-sm font-semibold text-gray-700 mb-2">
                                    Chọn dự án
                                </label>
                                <div class="flex items-center gap-2">
                                    <select id="projectSelect" class="modern-select flex-1" onchange="loadProjectInfo()">
                                        <option value="">-- Chọn dự án --</option>
                                    </select>
                                    <!-- ✅ Nút "Chốt hợp đồng" hiện cạnh dropdown Dự án -->
                                    <button onclick="signContract()" id="signContractBtnNextToProject"
                                        class="flex items-center gap-2 px-4 py-3 bg-rose-500 hover:bg-rose-600 rounded-xl text-sm font-medium transition-all duration-200 hidden whitespace-nowrap"
                                        title="Chốt hợp đồng để chuyển giai đoạn">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                        Chốt hợp đồng
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="customerInfo"
                            class="hidden mt-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-5 border border-blue-100">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="info-item">
                                    <span class="info-label">Mã KH</span>
                                    <span id="customerCode" class="info-value text-blue-700"></span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Tên</span>
                                    <span id="customerName" class="info-value"></span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">SĐT</span>
                                    <span id="customerPhone" class="info-value"></span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Email</span>
                                    <span id="customerEmail" class="info-value"></span>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-blue-200">
                                <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Địa chỉ</span>
                                <p id="customerAddress" class="text-sm font-medium text-gray-800 mt-1"></p>
                            </div>
                            <!-- Project Dates Section -->
                            <div id="projectDatesSection" class="hidden mt-4 pt-4 border-t border-blue-200">
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <div class="info-item">
                                        <span class="info-label">Mã dự án</span>
                                        <span id="projectCode" class="info-value text-indigo-700 font-semibold"></span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Ngày bắt đầu</span>
                                        <span id="projectStartDate" class="info-value text-green-700"></span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Ngày giao</span>
                                        <span id="projectDeadline" class="info-value text-orange-700"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- THÔNG TIN BÁO GIÁ -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">
                        <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Thông tin báo giá
                        </h2>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mã BG</label>
                                <input type="text" id="quoteCodeInput"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                                    placeholder="Nhập mã báo giá (VD: VRBG001)" oninput="updateQuoteCode()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ngày báo giá <span
                                        class="text-red-500">*</span></label>
                                <input type="date" id="quoteDate"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                                    required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Người lập báo giá</label>
                                <input type="text" id="quoteCreator"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all bg-gray-50"
                                    readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hiệu lực báo giá
                                    (ngày)</label>
                                <input type="number" id="validityDays" value="15" min="1"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ghi chú chung</label>
                                <textarea id="quoteNotes" rows="2"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all resize-none"
                                    placeholder="Vận chuyển, lắp đặt, VAT..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHỨC NĂNG BÁO GIÁ - TAB CHỌN -->
            <div class="mb-0">
                <!-- TAB NAVIGATION -->
                <div class="bg-white shadow-sm border-y border-gray-100 px-6 py-3">
                    <div class="flex items-center justify-center gap-2">
                        <button onclick="selectViewMode('items')" id="tabItems"
                            class="px-6 py-3 rounded-xl font-medium text-sm transition-all duration-200 bg-blue-600 text-white shadow-md flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                            </svg>
                            Bảng hạng mục báo giá
                        </button>
                        <button onclick="selectViewMode('summary')" id="tabSummary"
                            class="px-6 py-3 rounded-xl font-medium text-sm transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-gray-200 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                            Tổng hợp tiền
                        </button>
                        <button onclick="selectViewMode('both')" id="tabBoth"
                            class="px-6 py-3 rounded-xl font-medium text-sm transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-gray-200 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                            </svg>
                            Cả hai
                        </button>
                    </div>
                </div>

                <!-- CONTENT AREA - FULL SCREEN -->
                <div class="bg-white shadow-lg min-h-[600px]">
                    <!-- BẢNG HẠNG MỤC BÁO GIÁ - FULL SCREEN -->
                    <div id="itemsTableSection" class="p-4 transition-all duration-300 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">Bảng hạng mục báo giá</h2>
                            <div class="flex gap-2">
                                <button onclick="openDoorCatalogModal()"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                                    Chọn mẫu sản phẩm
                                </button>
                                <button onclick="addItemRow()"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700">
                                    + Thêm dòng
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse table-fixed">
                                <!-- Định nghĩa tỉ lệ các cột -->
                                <colgroup>
                                    <col style="width: 40px;"> <!-- STT -->
                                    <col style="width: 70px;"> <!-- Ký hiệu -->
                                    <col style="width: 320px;"> <!-- Quy cách -->
                                    <col style="width: 130px;"> <!-- Kính -->
                                    <col style="width: 100px;"> <!-- Phụ kiện - thu gọn -->
                                    <col style="width: 72px;"> <!-- Rộng - mở rộng -->
                                    <col style="width: 72px;"> <!-- Cao - mở rộng -->
                                    <col style="width: 75px;"> <!-- Tổng diện tích -->
                                    <col style="width: 55px;"> <!-- Số bộ -->
                                    <col style="width: 100px;"> <!-- Đơn Giá -->
                                    <col style="width: 100px;"> <!-- Phụ kiện giá -->
                                    <col style="width: 110px;"> <!-- Thành tiền -->
                                    <col style="width: 60px;"> <!-- Thao tác -->
                                </colgroup>
                                <thead class="bg-blue-50 sticky top-0">
                                    <!-- Hàng header chính -->
                                    <tr>
                                        <th rowspan="2"
                                            class="col-stt border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                            STT
                                        </th>
                                        <th rowspan="2"
                                            class="col-code border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                            Ký hiệu
                                        </th>
                                        <th colspan="3"
                                            class="col-design border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                            Phương án thiết kế cửa nhôm Viralwindow
                                        </th>
                                        <th colspan="2"
                                            class="border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                            Kích thước (mm)
                                        </th>
                                        <th rowspan="2"
                                            class="col-area border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                            Tổng diện tích (m²)
                                        </th>
                                        <th rowspan="2"
                                            class="col-quantity border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                            Số bộ
                                        </th>
                                        <th colspan="1"
                                            class="col-unit-price border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                            Đơn Giá
                                        </th>
                                        <th colspan="1"
                                            class="col-accessory-price border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                            Phụ kiện
                                        </th>
                                        <th colspan="1"
                                            class="col-total border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                            Thành tiền
                                        </th>
                                        <th rowspan="2"
                                            class="col-actions border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                            Thao tác
                                        </th>
                                    </tr>
                                    <!-- Hàng header phụ -->
                                    <tr>
                                        <th style="width: 50%;"
                                            class="col-spec border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                            Quy cách
                                        </th>
                                        <th style="width: 25%;"
                                            class="col-glass border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                            Kính
                                        </th>
                                        <th style="width: 25%;"
                                            class="col-accessories border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                            Phụ kiện
                                        </th>
                                        <th
                                            class="col-width border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                            Rộng
                                        </th>
                                        <th
                                            class="col-height border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                            Cao
                                        </th>
                                        <th
                                            class="col-unit-price border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                            vnđ/m²
                                        </th>
                                        <th
                                            class="col-accessory-price border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                            vnđ/bộ
                                        </th>
                                        <th
                                            class="col-total border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                            vnđ
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                    <!-- Items will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TỔNG HỢP TIỀN - FULL SCREEN -->
                    <div id="summarySection" class="p-4 transition-all duration-300" style="display: none;">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Tổng hợp tiền</h2>
                        <div class="grid grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-lg font-medium text-gray-700">Tổng diện tích:</span>
                                        <span class="text-xl font-bold text-blue-600" id="totalArea">0 m²</span>
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-lg font-medium text-gray-700">Tổng tiền vật tư/nhôm
                                            kính:</span>
                                        <span class="text-xl font-bold text-blue-600" id="totalMaterial">0 ₫</span>
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-lg font-medium text-gray-700">Tổng tiền phụ kiện:</span>
                                        <span class="text-xl font-bold text-blue-600" id="totalAccessories">0 ₫</span>
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-lg font-medium text-gray-700">Chiết khấu (%):</span>
                                        <input type="number" id="discountPercent" value="0" min="0" max="100" step="0.1"
                                            class="w-32 px-3 py-2 border border-gray-300 rounded-lg text-lg font-medium"
                                            onchange="calculateTotals()">
                                    </div>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-sm text-gray-600">Chiết khấu (₫):</span>
                                        <span class="text-lg font-bold text-red-600" id="discountAmount">0 ₫</span>
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-lg font-medium text-gray-700">VAT (%):</span>
                                        <input type="number" id="vatPercent" value="10" min="0" max="100" step="0.1"
                                            class="w-32 px-3 py-2 border border-gray-300 rounded-lg text-lg font-medium"
                                            onchange="calculateTotals()">
                                    </div>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-sm text-gray-600">VAT (₫):</span>
                                        <span class="text-lg font-bold text-red-600" id="vatAmount">0 ₫</span>
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-lg font-medium text-gray-700">Phí vận chuyển/lắp đặt:</span>
                                        <input type="number" id="shippingFee" value="0" min="0" step="1000"
                                            class="w-40 px-3 py-2 border border-gray-300 rounded-lg text-lg font-medium"
                                            onchange="calculateTotals()">
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center justify-center">
                                <div
                                    class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 rounded-2xl p-8 w-full shadow-lg">
                                    <div class="text-center mb-6">
                                        <span class="text-2xl font-bold text-gray-700 block mb-2">Tổng giá trị báo
                                            giá</span>
                                        <span class="text-5xl font-bold text-blue-600" id="finalTotal">0 ₫</span>
                                    </div>
                                    <div class="mt-6 pt-6 border-t border-gray-300">
                                        <p class="text-sm text-gray-600 mb-2">Bằng chữ:</p>
                                        <p class="text-lg font-semibold text-gray-800 italic" id="totalInWords">Không
                                            đồng
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CẢ HAI - VERTICAL LAYOUT -->
                    <div id="bothSection" class="p-4 transition-all duration-300" style="display: none;">
                        <div class="flex flex-col gap-6">
                            <!-- BẢNG HẠNG MỤC - GIỐNG HỆT BẢNG CHÍNH -->
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-bold text-gray-800">Bảng hạng mục báo giá</h2>
                                    <div class="flex gap-2">
                                        <button onclick="openDoorCatalogModal()"
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                                            Chọn mẫu sản phẩm
                                        </button>
                                        <button onclick="addItemRow()"
                                            class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700">
                                            + Thêm dòng
                                        </button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full border-collapse table-fixed">
                                        <!-- Định nghĩa tỉ lệ các cột -->
                                        <colgroup>
                                            <col style="width: 40px;"> <!-- STT -->
                                            <col style="width: 70px;"> <!-- Ký hiệu -->
                                            <col style="width: 300px;"> <!-- Quy cách - 50% -->
                                            <col style="width: 150px;"> <!-- Kính - 25% -->
                                            <col style="width: 150px;"> <!-- Phụ kiện - 25% -->
                                            <col style="width: 55px;"> <!-- Rộng -->
                                            <col style="width: 55px;"> <!-- Cao -->
                                            <col style="width: 75px;"> <!-- Tổng diện tích -->
                                            <col style="width: 55px;"> <!-- Số bộ -->
                                            <col style="width: 100px;"> <!-- Đơn Giá -->
                                            <col style="width: 100px;"> <!-- Phụ kiện giá -->
                                            <col style="width: 110px;"> <!-- Thành tiền -->
                                            <col style="width: 60px;"> <!-- Thao tác -->
                                        </colgroup>
                                        <thead class="bg-blue-50 sticky top-0">
                                            <!-- Hàng header chính -->
                                            <tr>
                                                <th rowspan="2"
                                                    class="col-stt border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                                    STT
                                                </th>
                                                <th rowspan="2"
                                                    class="col-code border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                                    Ký hiệu
                                                </th>
                                                <th colspan="3"
                                                    class="col-design border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                                    Phương án thiết kế cửa nhôm Viralwindow
                                                </th>
                                                <th colspan="2"
                                                    class="border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                                    Kích thước (mm)
                                                </th>
                                                <th rowspan="2"
                                                    class="col-area border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                                    Tổng diện tích (m²)
                                                </th>
                                                <th rowspan="2"
                                                    class="col-quantity border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                                    Số bộ
                                                </th>
                                                <th colspan="1"
                                                    class="col-unit-price border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                                    Đơn Giá
                                                </th>
                                                <th colspan="1"
                                                    class="col-accessory-price border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                                    Phụ kiện
                                                </th>
                                                <th colspan="1"
                                                    class="col-total border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                                    Thành tiền
                                                </th>
                                                <th rowspan="2"
                                                    class="col-actions border px-2 py-3 text-sm font-bold text-gray-700 bg-blue-100">
                                                    Thao tác
                                                </th>
                                            </tr>
                                            <!-- Hàng header phụ -->
                                            <tr>
                                                <th style="width: 50%;"
                                                    class="col-spec border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                                    Quy cách
                                                </th>
                                                <th style="width: 25%;"
                                                    class="col-glass border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                                    Kính
                                                </th>
                                                <th style="width: 25%;"
                                                    class="col-accessories border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                                    Phụ kiện
                                                </th>
                                                <th
                                                    class="col-width border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                                    Rộng
                                                </th>
                                                <th
                                                    class="col-height border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                                    Cao
                                                </th>
                                                <th
                                                    class="col-unit-price border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                                    vnđ/m²
                                                </th>
                                                <th
                                                    class="col-accessory-price border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                                    vnđ/bộ
                                                </th>
                                                <th
                                                    class="col-total border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50">
                                                    vnđ
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="itemsTableBodyBoth">
                                            <!-- Items will be added here - Render riêng cho both view -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- TỔNG HỢP TIỀN -->
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Tổng hợp tiền</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                                        <span class="text-gray-700">Tổng diện tích:</span>
                                        <span class="font-bold" id="totalAreaBoth">0 m²</span>
                                    </div>
                                    <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                                        <span class="text-gray-700">Tổng tiền vật tư/nhôm kính:</span>
                                        <span class="font-bold" id="totalMaterialBoth">0 ₫</span>
                                    </div>
                                    <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                                        <span class="text-gray-700">Tổng tiền phụ kiện:</span>
                                        <span class="font-bold" id="totalAccessoriesBoth">0 ₫</span>
                                    </div>
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <div class="flex justify-between mb-2">
                                            <span class="text-gray-700">Chiết khấu (%):</span>
                                            <input type="number" id="discountPercentBoth" value="0" min="0" max="100"
                                                step="0.1" class="w-24 px-2 py-1 border border-gray-300 rounded text-sm"
                                                onchange="syncFromBothView(); calculateTotals()">
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600 text-sm">Chiết khấu (₫):</span>
                                            <span class="font-bold text-sm" id="discountAmountBoth">0 ₫</span>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <div class="flex justify-between mb-2">
                                            <span class="text-gray-700">VAT (%):</span>
                                            <input type="number" id="vatPercentBoth" value="10" min="0" max="100"
                                                step="0.1" class="w-24 px-2 py-1 border border-gray-300 rounded text-sm"
                                                onchange="syncFromBothView(); calculateTotals()">
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600 text-sm">VAT (₫):</span>
                                            <span class="font-bold text-sm" id="vatAmountBoth">0 ₫</span>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <div class="flex justify-between">
                                            <span class="text-gray-700">Phí vận chuyển/lắp đặt:</span>
                                            <input type="number" id="shippingFeeBoth" value="0" min="0" step="1000"
                                                class="w-32 px-2 py-1 border border-gray-300 rounded text-sm"
                                                onchange="syncFromBothView(); calculateTotals()">
                                        </div>
                                    </div>
                                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 mt-4">
                                        <div class="text-center">
                                            <span class="text-lg font-bold text-gray-800 block mb-2">Tổng giá trị báo
                                                giá</span>
                                            <span class="text-3xl font-bold text-blue-600" id="finalTotalBoth">0
                                                ₫</span>
                                            <p class="text-xs text-gray-600 mt-3">Bằng chữ: <span
                                                    id="totalInWordsBoth">Không đồng</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Chọn mẫu sản phẩm -->
        <div id="doorCatalogModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b">
                    <h2 class="text-2xl font-bold">Chọn mẫu sản phẩm từ danh mục</h2>
                    <button onclick="closeDoorCatalogModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto max-h-[70vh]">
                    <input type="text" id="doorSearch" placeholder="Tìm kiếm sản phẩm..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4" onkeyup="filterDoors()">
                    <div id="doorList" class="grid grid-cols-2 gap-4">
                        <!-- Doors will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Tính từ BOM -->
        <div id="calculateBOMModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Tính giá từ BOM</h2>
                    <button onclick="closeCalculateBOMModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="p-6">
                    <!-- Step 1: Chọn dự án -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chọn dự án</label>
                        <select id="bomProjectSelect" onchange="loadDoorsForBOM()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Chọn dự án --</option>
                        </select>
                    </div>

                    <!-- Step 2: Chọn cửa -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chọn cửa (có thể chọn nhiều)</label>
                        <div id="bomDoorsList" class="border border-gray-300 rounded-lg p-4 max-h-60 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Vui lòng chọn dự án trước</p>
                        </div>
                    </div>

                    <!-- Step 3: Nhập giá -->
                    <div class="mb-6 bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-4">Giá vật tư</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Giá kính (₫/m²)</label>
                                <input type="number" id="glassPricePerM2" value="500000" step="10000"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Giá nhôm (₫/kg)</label>
                                <input type="number" id="aluminumPricePerKg" value="80000" step="1000"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Công lắp đặt (₫/m²)</label>
                                <input type="number" id="installationCostPerM2" value="200000" step="10000"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hoặc cố định (₫/cửa)</label>
                                <input type="number" id="installationCostFixed" value="0" step="10000"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3">
                        <button onclick="closeCalculateBOMModal()"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Hủy
                        </button>
                        <button onclick="calculateQuotationFromBOM()"
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            Tính toán
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Lịch sử báo giá -->
        <div id="quotationHistoryModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-5xl max-h-[90vh] overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b">
                    <h2 class="text-2xl font-bold">Lịch sử báo giá</h2>
                    <div class="flex items-center gap-3">
                        <button onclick="closeQuotationHistoryModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto max-h-[70vh]">
                    <div id="quotationHistoryList" class="space-y-4">
                        <!-- History items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Xem chi tiết báo giá -->
        <div id="quotationDetailModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-7xl max-h-[95vh] overflow-hidden">
                <div
                    class="flex justify-between items-center p-6 border-b bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                    <div>
                        <h2 class="text-2xl font-bold">Chi tiết báo giá</h2>
                        <p class="text-sm mt-1 opacity-90" id="detailQuoteCode">VRBG001</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="exportQuotationDetailToExcel()"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm font-medium flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Xuất Excel
                        </button>
                        <button onclick="closeQuotationDetailModal()"
                            class="text-white hover:bg-white/20 rounded-lg p-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto max-h-[80vh]">
                    <!-- Thông tin báo giá -->
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-bold text-lg mb-3">Thông tin khách hàng</h3>
                            <div class="space-y-2 text-sm">
                                <div><span class="text-gray-600">Khách hàng:</span> <span id="detailCustomerName"
                                        class="font-medium"></span></div>
                                <div><span class="text-gray-600">Dự án:</span> <span id="detailProjectName"
                                        class="font-medium"></span></div>
                                <div><span class="text-gray-600">Ngày báo giá:</span> <span id="detailQuoteDate"
                                        class="font-medium"></span></div>
                                <div><span class="text-gray-600">Hiệu lực:</span> <span id="detailValidityDays"
                                        class="font-medium"></span></div>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-bold text-lg mb-3">Trạng thái & Thời gian</h3>
                            <div class="space-y-2 text-sm">
                                <div><span class="text-gray-600">Trạng thái:</span> <span id="detailStatus"
                                        class="font-medium"></span></div>
                                <div><span class="text-gray-600">Ngày tạo:</span> <span id="detailVersion"
                                        class="font-medium"></span></div>
                                <div><span class="text-gray-600">Người lập:</span> <span id="detailCreator"
                                        class="font-medium"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Bảng hạng mục -->
                    <div class="mb-6">
                        <h3 class="font-bold text-xl mb-4">Bảng hạng mục báo giá</h3>
                        <div class="overflow-x-auto border rounded-lg">
                            <table class="w-full border-collapse table-fixed">
                                <thead class="bg-blue-50">
                                    <!-- Hàng header chính -->
                                    <tr>
                                        <th rowspan="2"
                                            class="border px-2 py-3 text-xs font-bold text-gray-700 bg-blue-100"
                                            style="width: 40px;">STT</th>
                                        <th rowspan="2"
                                            class="border px-2 py-3 text-xs font-bold text-gray-700 bg-blue-100"
                                            style="width: 80px;">Ký hiệu</th>
                                        <th colspan="3"
                                            class="border px-2 py-3 text-xs font-bold text-gray-700 bg-blue-100">Phương
                                            án
                                            thiết kế cửa nhôm Viralwindow</th>
                                        <th colspan="2"
                                            class="border px-2 py-3 text-xs font-bold text-gray-700 bg-blue-100">Kích
                                            thước
                                            (mm)</th>
                                        <th rowspan="2"
                                            class="border px-2 py-3 text-xs font-bold text-gray-700 bg-blue-100"
                                            style="width: 90px;">Tổng diện tích (m²)</th>
                                        <th rowspan="2"
                                            class="border px-2 py-3 text-xs font-bold text-gray-700 bg-blue-100"
                                            style="width: 60px;">Số bộ</th>
                                        <th colspan="1"
                                            class="border px-2 py-3 text-xs font-bold text-gray-700 bg-blue-100">Đơn Giá
                                        </th>
                                        <th colspan="1"
                                            class="border px-2 py-3 text-xs font-bold text-gray-700 bg-blue-100">Phụ
                                            kiện
                                        </th>
                                        <th colspan="1"
                                            class="border px-2 py-3 text-xs font-bold text-gray-700 bg-blue-100">Thành
                                            tiền
                                        </th>
                                    </tr>
                                    <!-- Hàng header phụ -->
                                    <tr>
                                        <th class="border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50"
                                            style="width: 200px;">Quy cách</th>
                                        <th class="border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50"
                                            style="width: 150px;">Kính</th>
                                        <th class="border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50"
                                            style="width: 150px;">Phụ kiện</th>
                                        <th class="border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50"
                                            style="width: 60px;">Rộng</th>
                                        <th class="border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50"
                                            style="width: 60px;">Cao</th>
                                        <th class="border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50"
                                            style="width: 100px;">vnđ/m²</th>
                                        <th class="border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50"
                                            style="width: 100px;">vnđ/bộ</th>
                                        <th class="border px-2 py-2 text-xs font-semibold text-gray-700 bg-blue-50"
                                            style="width: 120px;">vnđ</th>
                                    </tr>
                                </thead>
                                <tbody id="detailItemsTableBody">
                                    <!-- Items will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tổng hợp tiền -->
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-lg">
                        <h3 class="font-bold text-xl mb-4">Tổng hợp tiền</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-4 rounded-lg shadow">
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-700">Tổng diện tích:</span>
                                    <span class="font-bold" id="detailTotalArea">0 m²</span>
                                </div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-700">Tổng tiền vật tư/nhôm kính:</span>
                                    <span class="font-bold" id="detailTotalMaterial">0 ₫</span>
                                </div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-700">Tổng tiền phụ kiện:</span>
                                    <span class="font-bold" id="detailTotalAccessories">0 ₫</span>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow">
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-700">Chiết khấu:</span>
                                    <span class="font-bold" id="detailDiscount">0 ₫</span>
                                </div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-700">VAT:</span>
                                    <span class="font-bold" id="detailVAT">0 ₫</span>
                                </div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-700">Phí vận chuyển/lắp đặt:</span>
                                    <span class="font-bold" id="detailShippingFee">0 ₫</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 bg-white p-6 rounded-lg shadow-lg text-center">
                            <p class="text-gray-700 font-semibold mb-2">Tổng giá trị báo giá</p>
                            <p class="text-4xl font-bold text-blue-600" id="detailFinalTotal">0 ₫</p>
                            <p class="text-sm text-gray-600 mt-2">Bằng chữ: <span id="detailTotalInWords">Không
                                    đồng</span>
                            </p>
                        </div>
                    </div>

                    <!-- Ghi chú -->
                    <div class="mt-6 bg-gray-50 p-4 rounded-lg" id="detailNotesSection">
                        <h3 class="font-bold text-lg mb-2">Ghi chú</h3>
                        <p class="text-sm text-gray-700" id="detailNotes">Không có ghi chú</p>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const API_BASE = 'http://localhost:3001/api';

            // Load company logo and name
            async function loadCompanyLogo() {
                try {
                    const response = await fetch(`${API_BASE}/company-settings`);
                    const result = await response.json();

                    if (result.success && result.data) {
                        // Load logo
                        if (result.data.logo_path) {
                            const logoImg = document.getElementById('companyLogo');
                            const logoIcon = document.getElementById('companyLogoIcon');
                            if (logoImg && logoIcon) {
                                logoImg.src = result.data.logo_path;
                                logoImg.classList.remove('hidden');
                                logoIcon.classList.add('hidden');
                            }
                        }

                        // Load company name
                        const companyNameEl = document.getElementById('companyName');
                        if (companyNameEl && result.data.company_name) {
                            companyNameEl.textContent = result.data.company_name;
                        }
                    }
                } catch (error) {
                    console.error('Lỗi load logo:', error);
                }
            }
            let currentQuotationId = null;
            let currentVersion = 1;
            let parentQuotationId = null; // Lưu ID của V1 khi tạo version mới
            let items = [];
            let itemCounter = 0;
            let isLocked = false;
            let currentDetailQuotationId = null; // ID của báo giá đang xem trong modal chi tiết

            // Reset quotation form
            function resetQuotationForm() {
                currentQuotationId = null;
                currentVersion = 1;
                parentQuotationId = null;
                items = [];
                itemCounter = 0;
                document.getElementById('quoteCode').textContent = 'Draft';
                document.getElementById('quoteCodeInput').value = '';
                document.getElementById('quoteStatus').textContent = getStatusText('draft');
                document.getElementById('customerSelect').value = '';
                document.getElementById('projectSelect').value = '';
                document.getElementById('quoteDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('validityDays').value = 15;
                document.getElementById('quoteNotes').value = '';
                renderItemsTable();
                calculateTotals();
            }

            // Calculate from BOM functions
            function openCalculateFromBOMModal() {
                document.getElementById('calculateBOMModal').classList.remove('hidden');
                loadProjectsForBOM();
            }

            function closeCalculateBOMModal() {
                document.getElementById('calculateBOMModal').classList.add('hidden');
            }

            async function loadProjectsForBOM() {
                try {
                    const response = await fetch(`${API_BASE}/projects`);
                    const result = await response.json();

                    if (result.success) {
                        const select = document.getElementById('bomProjectSelect');
                        select.innerHTML = '<option value="">-- Chọn dự án --</option>';
                        result.data.forEach(project => {
                            select.innerHTML += `<option value="${project.id}">${project.project_code} - ${project.project_name}</option>`;
                        });
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            async function loadDoorsForBOM() {
                const projectId = document.getElementById('bomProjectSelect').value;
                if (!projectId) {
                    document.getElementById('bomDoorsList').innerHTML = '<p class="text-gray-500 text-sm">Vui lòng chọn dự án trước</p>';
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/quotations/projects/${projectId}/doors`);
                    const result = await response.json();

                    if (result.success) {
                        const doors = result.data || [];
                        const container = document.getElementById('bomDoorsList');

                        if (doors.length === 0) {
                            container.innerHTML = '<p class="text-gray-500 text-sm">Dự án này chưa có cửa nào</p>';
                            return;
                        }

                        container.innerHTML = doors.map(door => {
                            const doorName = door.design_code || `Cửa ${door.id}`;
                            const doorInfo = door.width_mm && door.height_mm
                                ? ` (${(door.width_mm / 1000).toFixed(1)}m × ${(door.height_mm / 1000).toFixed(1)}m)`
                                : '';
                            const bomStatus = door.bom_items_count > 0
                                ? `<span class="text-xs text-green-600">(Đã có BOM)</span>`
                                : `<span class="text-xs text-yellow-600">(Chưa có BOM)</span>`;

                            return `
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer border border-gray-200 rounded-lg mb-2">
                                <input type="checkbox" value="${door.id}" class="door-checkbox" name="door-${door.id}">
                                <div class="flex-1">
                                    <div class="font-medium">${doorName}${doorInfo}</div>
                                    ${door.aluminum_name ? `<div class="text-xs text-gray-500">${door.aluminum_name}</div>` : ''}
                                    ${bomStatus}
                                </div>
                            </label>
                        `;
                        }).join('');
                    } else {
                        document.getElementById('bomDoorsList').innerHTML = '<p class="text-red-500 text-sm">Lỗi: ' + (result.message || 'Không thể tải danh sách cửa') + '</p>';
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    document.getElementById('bomDoorsList').innerHTML = '<p class="text-red-500 text-sm">Lỗi khi tải danh sách cửa: ' + error.message + '</p>';
                }
            }

            async function calculateQuotationFromBOM() {
                const projectId = document.getElementById('bomProjectSelect').value;
                const selectedDoors = Array.from(document.querySelectorAll('.door-checkbox:checked')).map(cb => parseInt(cb.value));

                if (!projectId) {
                    alert('Vui lòng chọn dự án');
                    return;
                }

                if (selectedDoors.length === 0) {
                    alert('Vui lòng chọn ít nhất một cửa');
                    return;
                }

                const glassPricePerM2 = parseFloat(document.getElementById('glassPricePerM2').value) || 0;
                const aluminumPricePerKg = parseFloat(document.getElementById('aluminumPricePerKg').value) || 0;
                const installationCostPerM2 = parseFloat(document.getElementById('installationCostPerM2').value) || 0;
                const installationCostFixed = parseFloat(document.getElementById('installationCostFixed').value) || 0;

                try {
                    const response = await fetch(`${API_BASE}/quotations/calculate-from-bom`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            projectId: parseInt(projectId),
                            doorIds: selectedDoors,
                            glassPricePerM2: glassPricePerM2,
                            aluminumPricePerKg: aluminumPricePerKg,
                            installationCostPerM2: installationCostPerM2 || null,
                            installationCostFixed: installationCostFixed || null
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Điền dữ liệu vào form báo giá
                        const bomItems = result.data.items || [];
                        const summary = result.data.summary || {};

                        // Hiển thị cảnh báo tồn kho nếu có
                        if (result.data.stock_warnings && result.data.stock_warnings.length > 0) {
                            const warnings = result.data.stock_warnings;
                            const isInsufficient = result.data.stock_status === 'insufficient';
                            let warningMsg = isInsufficient
                                ? '⚠️ CẢNH BÁO: Một số vật liệu không đủ trong kho:\n\n'
                                : '⚠️ Cảnh báo tồn kho:\n\n';

                            warnings.forEach(w => {
                                warningMsg += `• ${w.message}\n`;
                            });

                            if (isInsufficient) {
                                warningMsg += '\nVui lòng nhập thêm vật liệu trước khi sản xuất!';
                            }

                            alert(warningMsg);
                        }

                        // Xóa các items cũ và thêm items mới từ BOM
                        items = [];
                        itemCounter = 0;

                        bomItems.forEach((item, index) => {
                            itemCounter++;
                            items.push({
                                id: itemCounter,
                                stt: itemCounter,
                                code: item.code || `C${String(itemCounter).padStart(2, '0')}`,
                                design: item.item_name || '',
                                spec: item.spec || '',
                                glass: item.glass || '',
                                accessories: item.accessories || '',
                                width: item.width || 0,
                                height: item.height || 0,
                                area: item.area || 0,
                                quantity: item.quantity || 1,
                                unitPrice: item.unit_price || 0,
                                accessoryPrice: item.accessory_price || 0,
                                total: item.total_price || 0
                            });
                        });

                        // Render lại bảng
                        renderItemsTable();
                        calculateTotals();

                        // Đóng modal
                        closeCalculateBOMModal();

                        // Set project_id nếu có
                        if (projectId) {
                            document.getElementById('projectSelect').value = projectId;
                            loadProjectInfo();
                        }

                        const successMsg = `Đã tính toán thành công!\n- Tổng diện tích kính: ${summary.total_glass_area_m2?.toFixed(2) || 0} m²\n- Tổng khối lượng nhôm: ${summary.total_aluminum_weight_kg?.toFixed(2) || 0} kg\n- Tổng phụ kiện: ${summary.total_accessories || 0} cái`;

                        // Chỉ hiển thị thông báo thành công nếu không có cảnh báo nghiêm trọng
                        if (!result.data.stock_warnings || result.data.stock_status !== 'insufficient') {
                            alert(successMsg);
                        }
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể tính toán từ BOM'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Initialize
            document.addEventListener('DOMContentLoaded', function () {
                loadCompanyLogo();
                loadSidebarUserInfo();
                loadCustomers();
                loadProjects();
                loadDoorCatalog();
                setQuoteDate();
                checkUrlParams();
                // Set default view to items
                selectViewMode('items');
            });

            // Chọn chế độ hiển thị (Tab selection)
            let currentViewMode = 'items'; // 'items', 'summary', 'both'

            function selectViewMode(mode) {
                currentViewMode = mode;

                // Reset all tabs
                document.getElementById('tabItems').className = 'px-6 py-3 rounded-lg font-medium text-sm transition-all duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300';
                document.getElementById('tabSummary').className = 'px-6 py-3 rounded-lg font-medium text-sm transition-all duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300';
                document.getElementById('tabBoth').className = 'px-6 py-3 rounded-lg font-medium text-sm transition-all duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300';

                // Hide all sections (dùng display: none thay vì hidden class để giữ DOM)
                document.getElementById('itemsTableSection').style.display = 'none';
                document.getElementById('summarySection').style.display = 'none';
                document.getElementById('bothSection').style.display = 'none';

                // Show selected section and activate tab
                if (mode === 'items') {
                    document.getElementById('tabItems').className = 'px-6 py-3 rounded-lg font-medium text-sm transition-all duration-200 bg-blue-600 text-white shadow-md';
                    document.getElementById('itemsTableSection').style.display = 'block';
                    // Render lại bảng để đảm bảo dữ liệu hiển thị đúng
                    renderItemsTable();
                } else if (mode === 'summary') {
                    document.getElementById('tabSummary').className = 'px-6 py-3 rounded-lg font-medium text-sm transition-all duration-200 bg-blue-600 text-white shadow-md';
                    document.getElementById('summarySection').style.display = 'block';
                    // Cập nhật tổng hợp tiền
                    calculateTotals();
                } else if (mode === 'both') {
                    document.getElementById('tabBoth').className = 'px-6 py-3 rounded-lg font-medium text-sm transition-all duration-200 bg-blue-600 text-white shadow-md';
                    document.getElementById('bothSection').style.display = 'block';
                    // Render lại bảng và sync data to both view
                    renderItemsTable();
                    syncDataToBothView();
                }
            }

            // Đồng bộ dữ liệu sang view "Cả hai"
            function syncDataToBothView() {
                // Sync items table - re-render
                renderItemsTable();

                // Sync input values
                const discountPercent = document.getElementById('discountPercent')?.value || '0';
                const vatPercent = document.getElementById('vatPercent')?.value || '10';
                const shippingFee = document.getElementById('shippingFee')?.value || '0';

                if (document.getElementById('discountPercentBoth')) document.getElementById('discountPercentBoth').value = discountPercent;
                if (document.getElementById('vatPercentBoth')) document.getElementById('vatPercentBoth').value = vatPercent;
                if (document.getElementById('shippingFeeBoth')) document.getElementById('shippingFeeBoth').value = shippingFee;

                // Recalculate to sync all values
                calculateTotals();
            }

            // Đồng bộ ngược từ view "Cả hai" về view chính
            function syncFromBothView() {
                const discountPercentBoth = document.getElementById('discountPercentBoth')?.value || '0';
                const vatPercentBoth = document.getElementById('vatPercentBoth')?.value || '10';
                const shippingFeeBoth = document.getElementById('shippingFeeBoth')?.value || '0';

                if (document.getElementById('discountPercent')) document.getElementById('discountPercent').value = discountPercentBoth;
                if (document.getElementById('vatPercent')) document.getElementById('vatPercent').value = vatPercentBoth;
                if (document.getElementById('shippingFee')) document.getElementById('shippingFee').value = shippingFeeBoth;
            }

            // Check URL params for projectId, customerId, or quotation ID
            async function checkUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('projectId');
                const customerId = urlParams.get('customerId');
                const id = urlParams.get('id');

                console.log('URL Params:', { projectId, customerId, id });

                // Nếu KHÔNG CÓ bất kỳ parameter nào, đây là trang mới hoàn toàn
                if (!id && !projectId && !customerId) {
                    console.log('New blank quotation page - no data to load');
                    // Enable selects
                    document.getElementById('customerSelect').disabled = false;
                    document.getElementById('projectSelect').disabled = false;
                    // Hide reset button
                    document.getElementById('resetBtn').classList.add('hidden');
                    // Không load gì cả, để user tự chọn
                    return;
                }

                if (id) {
                    // Có id trong URL → Load quotation đó
                    console.log('Loading quotation from URL param id:', id);
                    await loadQuotation(id);
                } else if (projectId) {
                    // Có projectId trong URL → Kiểm tra xem đã có báo giá chưa
                    // Nếu có thì load báo giá đó, nếu không mới tạo mới
                    console.log('Checking for existing quotation for project:', projectId);
                    await loadProjectForQuotation(projectId, customerId);
                }
            }

            // Load sidebar user info
            async function loadSidebarUserInfo() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    const response = await fetch(`${API_BASE}/auth/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();

                    if (result.success) {
                        const user = result.data;
                        const userNameEl = document.getElementById('sidebarUserName');
                        if (userNameEl) {
                            userNameEl.textContent = user.full_name || 'User';
                        }

                        const avatarInitial = document.getElementById('sidebarUserAvatarInitial');
                        const avatarImage = document.getElementById('sidebarUserAvatarImage');

                        if (avatarInitial && avatarImage) {
                            if (user.avatar_url) {
                                avatarImage.src = user.avatar_url;
                                avatarImage.classList.remove('hidden');
                                avatarInitial.classList.add('hidden');
                            } else {
                                const initial = (user.full_name || 'U').charAt(0).toUpperCase();
                                avatarInitial.textContent = initial;
                                avatarInitial.classList.remove('hidden');
                                avatarImage.classList.add('hidden');
                            }
                        }

                        // Also set quote creator if element exists
                        const quoteCreatorEl = document.getElementById('quoteCreator');
                        if (quoteCreatorEl) {
                            quoteCreatorEl.value = user.full_name || 'User';
                        }
                    }
                } catch (error) {
                    console.error('Error loading sidebar user info:', error);
                }
            }

            // Toggle sidebar user menu
            function toggleSidebarUserMenu() {
                const dropdown = document.getElementById('sidebarUserMenuDropdown');
                if (dropdown) {
                    dropdown.classList.toggle('hidden');
                }
            }

            // Handle logout (shared function)
            function handleLogout() {
                if (confirm('Bạn có chắc muốn đăng xuất?')) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                }
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', function (event) {
                // Sidebar user dropdown
                const sidebarDropdown = document.getElementById('sidebarUserMenuDropdown');
                const sidebarButton = event.target.closest('[onclick="toggleSidebarUserMenu()"]');
                if (sidebarDropdown && !sidebarButton && !sidebarDropdown.contains(event.target)) {
                    sidebarDropdown.classList.add('hidden');
                }
            });

            // Set quote date to today
            function setQuoteDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('quoteDate').value = today;
            }

            // Load customers
            async function loadCustomers() {
                try {
                    const response = await fetch(`${API_BASE}/customers`);
                    const result = await response.json();
                    if (result.success) {
                        const select = document.getElementById('customerSelect');
                        select.innerHTML = '<option value="">-- Chọn khách hàng --</option>';
                        result.data.forEach(customer => {
                            select.innerHTML += `<option value="${customer.id}">${customer.customer_code || ''} - ${customer.full_name}</option>`;
                        });
                    }
                } catch (error) {
                    console.error('Error loading customers:', error);
                }
            }

            // Load projects - all projects (used for initial load)
            async function loadProjects() {
                try {
                    const response = await fetch(`${API_BASE}/projects`);
                    const result = await response.json();
                    if (result.success) {
                        const select = document.getElementById('projectSelect');
                        select.innerHTML = '<option value="">-- Chọn dự án --</option>';
                        result.data.forEach(project => {
                            select.innerHTML += `<option value="${project.id}">${project.project_code} - ${project.project_name}</option>`;
                        });
                    }
                } catch (error) {
                    console.error('Error loading projects:', error);
                }
            }

            // Load projects by customer (filter by customer_id)
            async function loadProjectsByCustomer(customerId, preserveProjectId = null) {
                try {
                    if (!customerId) {
                        // If no customer selected, load all projects
                        await loadProjects();
                        return;
                    }

                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/projects?customer_id=${customerId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result.success) {
                        const select = document.getElementById('projectSelect');
                        select.innerHTML = '<option value="">-- Chọn dự án --</option>';

                        if (result.data && result.data.length > 0) {
                            result.data.forEach(project => {
                                select.innerHTML += `<option value="${project.id}">${project.project_code} - ${project.project_name}</option>`;
                            });
                        } else {
                            select.innerHTML += '<option value="" disabled>Khách hàng này chưa có dự án nào</option>';
                        }

                        // Khôi phục giá trị project nếu được yêu cầu và option đó tồn tại
                        if (preserveProjectId) {
                            const optionExists = Array.from(select.options).some(opt => opt.value === preserveProjectId);
                            if (optionExists) {
                                select.value = preserveProjectId;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading projects by customer:', error);
                }
            }

            // Load customer info
            async function loadCustomerInfo() {
                const customerId = document.getElementById('customerSelect').value;
                const customerInfoEl = document.getElementById('customerInfo');
                if (!customerId) {
                    customerInfoEl.classList.add('hidden');
                    customerInfoEl.classList.remove('show');
                    // Reset project dropdown to all projects
                    await loadProjects();
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE}/customers/${customerId}`);
                    const result = await response.json();
                    if (result.success) {
                        const customer = result.data;
                        document.getElementById('customerCode').textContent = customer.customer_code || '-';
                        document.getElementById('customerName').textContent = customer.full_name || '-';
                        document.getElementById('customerPhone').textContent = customer.phone || '-';
                        document.getElementById('customerEmail').textContent = customer.email || '-';
                        document.getElementById('customerAddress').textContent = customer.address || '-';
                        customerInfoEl.classList.remove('hidden');
                        customerInfoEl.classList.add('show');

                        // Load projects của khách hàng này
                        // QUAN TRỌNG: Không tự động load báo giá khi chọn customer
                        // Chỉ load danh sách projects, để user tự chọn dự án
                        await loadProjectsByCustomer(customerId);

                        // Nếu đang edit quotation và có project_id, giữ lại project đó trong dropdown
                        if (currentQuotationId) {
                            // Không làm gì, giữ nguyên project đã chọn
                        } else {
                            // Nếu chưa có quotation, reset project select
                            document.getElementById('projectSelect').value = '';
                        }
                    }
                } catch (error) {
                    console.error('Error loading customer info:', error);
                }
            }

            // Load project info when project is selected from dropdown
            async function loadProjectInfo() {
                const projectId = document.getElementById('projectSelect').value;

                if (!projectId) {
                    // Ẩn phần ngày dự án khi không chọn dự án
                    const projectDatesSection = document.getElementById('projectDatesSection');
                    if (projectDatesSection) {
                        projectDatesSection.classList.add('hidden');
                    }
                    return;
                }

                try {
                    const token = localStorage.getItem('token');

                    // Load thông tin dự án
                    const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();

                    if (result.success) {
                        const project = result.data;

                        // Cập nhật tên dự án trên header
                        document.getElementById('projectName').textContent = project.project_name || 'N/A';

                        // Hiển thị ngày bắt đầu và ngày giao
                        displayProjectDates(project);

                        // QUAN TRỌNG: Chỉ cập nhật project_id nếu đang edit quotation hiện tại
                        // KHÔNG tự động load báo giá cũ của dự án
                        if (currentQuotationId) {
                            try {
                                // Lấy dữ liệu quotation hiện tại
                                const currentQuotationResponse = await fetch(`${API_BASE}/quotations/${currentQuotationId}`, {
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                const currentQuotationResult = await currentQuotationResponse.json();

                                if (currentQuotationResult.success && currentQuotationResult.data) {
                                    const currentQuotation = currentQuotationResult.data;
                                    // Nếu quotation chưa có project_id hoặc project_id khác, cập nhật lại
                                    if (!currentQuotation.project_id || currentQuotation.project_id != projectId) {
                                        const updateData = prepareQuotationData();
                                        updateData.project_id = parseInt(projectId);
                                        // Không thay đổi status khi chỉ cập nhật project_id
                                        updateData.status = currentQuotation.status || 'draft';
                                        await saveQuotationToServer(updateData);
                                        console.log('Đã tự động cập nhật project_id vào quotation:', projectId);
                                    }
                                }
                            } catch (updateError) {
                                console.error('Error updating project_id:', updateError);
                                // Không block việc load project info nếu update lỗi
                            }
                        } else {
                            // Nếu chưa có quotation, chỉ load thông tin dự án
                            // Không tự động tạo mã báo giá - để user tự quyết định
                            // Reset các biến để đảm bảo sạch
                            parentQuotationId = null;

                            // Chỉ tạo mã nếu user chưa nhập gì
                            const currentCode = document.getElementById('quoteCodeInput').value.trim();
                            const quoteCodeDisplay = document.getElementById('quoteCode').textContent.trim();
                            if ((!currentCode || currentCode === '' || currentCode === 'Draft') &&
                                (!quoteCodeDisplay || quoteCodeDisplay === 'Draft' || quoteCodeDisplay === '')) {
                                await generateQuoteCode();
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading project info:', error);
                }
            }

            // Load project for quotation (when coming from projects page)
            async function loadProjectForQuotation(projectId, customerId) {
                try {
                    const token = localStorage.getItem('token');

                    // QUAN TRỌNG: Kiểm tra xem dự án này đã có báo giá chưa
                    // Nếu có, load báo giá đó thay vì tạo mới
                    const quotationsResponse = await fetch(`${API_BASE}/quotations?project_id=${projectId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const quotationsResult = await quotationsResponse.json();

                    if (quotationsResult.success && quotationsResult.data && quotationsResult.data.length > 0) {
                        // Dự án đã có báo giá - load báo giá mới nhất
                        const latestQuotation = quotationsResult.data.sort((a, b) =>
                            new Date(b.created_at) - new Date(a.created_at)
                        )[0];

                        console.log('Project already has quotation, loading:', latestQuotation.id);
                        // Load báo giá đó
                        await loadQuotation(latestQuotation.id);
                        return; // Dừng lại, không tạo mới
                    }

                    // Nếu chưa có báo giá, mới load thông tin dự án và tạo mới
                    const projectResponse = await fetch(`${API_BASE}/projects/${projectId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const projectResult = await projectResponse.json();

                    if (projectResult.success) {
                        const project = projectResult.data;
                        const actualCustomerId = customerId || project.customer_id;

                        // QUAN TRỌNG: Load danh sách khách hàng và dự án trước
                        await loadCustomers();
                        await loadProjects();

                        // Set project info - phải set sau khi đã load options
                        document.getElementById('projectSelect').value = projectId;
                        document.getElementById('customerSelect').value = actualCustomerId;
                        document.getElementById('projectName').textContent = project.project_name || 'N/A';

                        // Chỉ disable selects nếu đang tạo báo giá mới từ projects page
                        // Nếu đang edit quotation hiện có, không disable để có thể thay đổi
                        if (!currentQuotationId) {
                            // Disable selects since they're pre-filled (chỉ khi tạo mới)
                            document.getElementById('projectSelect').disabled = true;
                            document.getElementById('customerSelect').disabled = true;
                        } else {
                            // Nếu đang edit quotation hiện có, cho phép thay đổi
                            document.getElementById('projectSelect').disabled = false;
                            document.getElementById('customerSelect').disabled = false;
                        }

                        // Load thông tin khách hàng trực tiếp từ API
                        if (actualCustomerId) {
                            const customerResponse = await fetch(`${API_BASE}/customers/${actualCustomerId}`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            const customerResult = await customerResponse.json();

                            if (customerResult.success) {
                                const customer = customerResult.data;
                                document.getElementById('customerCode').textContent = customer.customer_code || '-';
                                document.getElementById('customerPhone').textContent = customer.phone || '-';
                                document.getElementById('customerName').textContent = customer.full_name || '-';
                                document.getElementById('customerEmail').textContent = customer.email || '-';
                                document.getElementById('customerAddress').textContent = customer.address || '-';
                                const customerInfoEl = document.getElementById('customerInfo');
                                customerInfoEl.classList.remove('hidden');
                                customerInfoEl.classList.add('show');
                            }
                        }

                        // Hiển thị thông tin ngày của dự án
                        displayProjectDates(project);

                        // Reset currentQuotationId vì đây là báo giá mới
                        currentQuotationId = null;
                        parentQuotationId = null;

                        // Tự động tạo mã báo giá
                        await generateQuoteCode();

                        console.log('Created new quotation for project:', { projectId, customerId: actualCustomerId });
                    }
                } catch (error) {
                    console.error('Error loading project for quotation:', error);
                }
            }

            // Hiển thị ngày bắt đầu và ngày giao của dự án
            function displayProjectDates(project) {
                const projectDatesSection = document.getElementById('projectDatesSection');
                if (!projectDatesSection) return;

                // Format dates
                const formatDate = (dateStr) => {
                    if (!dateStr) return 'Chưa xác định';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                };

                document.getElementById('projectCode').textContent = project.project_code || '-';
                document.getElementById('projectStartDate').textContent = formatDate(project.start_date || project.created_at);
                document.getElementById('projectDeadline').textContent = formatDate(project.deadline);

                projectDatesSection.classList.remove('hidden');
            }

            // Tự động tạo mã báo giá theo format VRBG***
            async function generateQuoteCode() {
                try {
                    const response = await fetch(`${API_BASE}/quotations`);
                    const result = await response.json();

                    let maxNumber = 0;
                    if (result.success && result.data) {
                        // Tìm số lớn nhất trong các mã VRBG hiện có
                        result.data.forEach(q => {
                            const code = q.quotation_code || '';
                            if (code.startsWith('VRBG')) {
                                const num = parseInt(code.replace('VRBG', ''), 10);
                                if (!isNaN(num) && num > maxNumber) {
                                    maxNumber = num;
                                }
                            }
                        });
                    }

                    // Tạo mã mới với số tiếp theo
                    const newNumber = maxNumber + 1;
                    const newCode = 'VRBG' + String(newNumber).padStart(3, '0');

                    document.getElementById('quoteCode').textContent = newCode;
                    document.getElementById('quoteCodeInput').value = newCode;

                    return newCode;
                } catch (error) {
                    console.error('Lỗi tạo mã báo giá:', error);
                    // Fallback: tạo mã từ timestamp
                    const fallbackCode = 'VRBG' + Date.now().toString().slice(-6);
                    document.getElementById('quoteCode').textContent = fallbackCode;
                    document.getElementById('quoteCodeInput').value = fallbackCode;
                    return fallbackCode;
                }
            }

            // Kiểm tra mã báo giá trùng lặp
            async function checkDuplicateQuoteCode(code) {
                if (!code || code.trim() === '') return false;

                try {
                    const response = await fetch(`${API_BASE}/quotations`);
                    const result = await response.json();

                    if (result.success && result.data) {
                        const existing = result.data.find(q =>
                            q.quotation_code === code && q.id !== currentQuotationId
                        );
                        return !!existing;
                    }
                    return false;
                } catch (error) {
                    console.error('Lỗi kiểm tra mã trùng:', error);
                    return false;
                }
            }

            // Cập nhật mã BG khi user nhập và kiểm tra trùng
            async function updateQuoteCode() {
                const input = document.getElementById('quoteCodeInput');
                const code = input.value.trim().toUpperCase();

                if (!code) {
                    document.getElementById('quoteCode').textContent = 'Draft';
                    input.classList.remove('border-red-500', 'border-green-500');
                    return;
                }

                document.getElementById('quoteCode').textContent = code;
                input.value = code; // Force uppercase

                // Kiểm tra trùng lặp
                const isDuplicate = await checkDuplicateQuoteCode(code);

                if (isDuplicate) {
                    input.classList.add('border-red-500');
                    input.classList.remove('border-green-500');
                    showDuplicateWarning(code);
                } else {
                    input.classList.add('border-green-500');
                    input.classList.remove('border-red-500');
                    hideDuplicateWarning();
                }
            }

            // Hiển thị cảnh báo mã trùng
            function showDuplicateWarning(code) {
                let warning = document.getElementById('quoteCodeWarning');
                if (!warning) {
                    warning = document.createElement('p');
                    warning.id = 'quoteCodeWarning';
                    warning.className = 'text-red-600 text-sm mt-1';
                    document.getElementById('quoteCodeInput').parentNode.appendChild(warning);
                }
                warning.textContent = `⚠️ Mã "${code}" đã tồn tại! Vui lòng nhập mã khác.`;
                warning.classList.remove('hidden');
            }

            // Ẩn cảnh báo mã trùng
            function hideDuplicateWarning() {
                const warning = document.getElementById('quoteCodeWarning');
                if (warning) {
                    warning.classList.add('hidden');
                }
            }

            // Update project code to VRBG***
            async function updateProjectCode(projectId, newCode) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            project_code: newCode
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        console.log('Project code updated to:', newCode);
                    }
                } catch (error) {
                    console.error('Error updating project code:', error);
                }
            }

            // Update quote code display - hiển thị ngay khi người dùng nhập
            function updateQuoteCode() {
                const code = document.getElementById('quoteCodeInput').value.trim();
                if (code) {
                    document.getElementById('quoteCode').textContent = code;
                } else {
                    document.getElementById('quoteCode').textContent = '';
                }
            }

            // Add item row
            function addItemRow(item = null) {
                itemCounter++;
                const row = {
                    id: itemCounter,
                    stt: items.length + 1,
                    code: item?.code || `C${String(items.length + 1).padStart(2, '0')}`, // Ký hiệu = Mã sản phẩm
                    design: item?.name || '',
                    spec: item?.name || '', // Quy cách = Tên sản phẩm
                    glass: '',
                    accessories: '',
                    width: item?.width || 0,
                    height: item?.height || 0,
                    area: 0,
                    quantity: item?.quantity || 1,
                    unitPrice: item?.unit_price || 0,
                    accessoryPrice: item?.accessory_price || 0,
                    total: 0
                };
                items.push(row);
                renderItemsTable();
                calculateTotals();
            }

            // Render items table
            function renderItemsTable() {
                // Render main table (full screen)
                const tbody = document.getElementById('itemsTableBody');
                if (tbody) {
                    tbody.innerHTML = items.map((item, index) => `
                    <tr class="item-row" data-id="${item.id}">
                        <td class="col-stt border px-1 py-2 text-center table-cell-wrap text-sm">${index + 1}</td>
                        <td class="col-code border px-1 py-2 table-cell-wrap">
                            <input type="text" value="${item.code}" class="w-full px-1 py-1 border rounded text-xs" onchange="updateItem(${item.id}, 'code', this.value)" onblur="validateItemCode(${item.id})">
                        </td>
                        <td class="col-spec border px-1 py-2 table-cell-wrap">
                            <textarea rows="1" class="table-input px-1 py-1 border rounded text-xs" onchange="updateItem(${item.id}, 'spec', this.value)" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';">${item.spec || ''}</textarea>
                        </td>
                        <td class="col-glass border px-1 py-2 table-cell-wrap">
                            <textarea rows="1" class="table-input px-1 py-1 border rounded text-xs" onchange="updateItem(${item.id}, 'glass', this.value)" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';">${item.glass || ''}</textarea>
                        </td>
                        <td class="col-accessories border px-1 py-2 table-cell-wrap">
                            <textarea rows="1" class="table-input px-1 py-1 border rounded text-xs" onchange="updateItem(${item.id}, 'accessories', this.value)" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';">${item.accessories || ''}</textarea>
                        </td>
                        <td class="col-width border px-1 py-2 table-cell-wrap">
                            <input type="number" value="${item.width}" min="0" step="1" class="w-full px-1 py-1 border rounded text-xs text-center" onchange="updateItem(${item.id}, 'width', parseFloat(this.value))" onblur="calculateItemArea(${item.id})">
                        </td>
                        <td class="col-height border px-1 py-2 table-cell-wrap">
                            <input type="number" value="${item.height}" min="0" step="1" class="w-full px-1 py-1 border rounded text-xs text-center" onchange="updateItem(${item.id}, 'height', parseFloat(this.value))" onblur="calculateItemArea(${item.id})">
                        </td>
                        <td class="col-area border px-1 py-2 text-center table-cell-wrap"><span class="item-area-${item.id} text-xs">${(parseFloat(item.area) || 0).toFixed(2)}</span></td>
                        <td class="col-quantity border px-1 py-2 table-cell-wrap">
                            <input type="number" value="${item.quantity}" min="1" step="1" class="w-full px-1 py-1 border rounded text-xs text-center" onchange="updateItem(${item.id}, 'quantity', parseInt(this.value))" onblur="calculateItemTotal(${item.id})">
                        </td>
                        <td class="col-unit-price border px-1 py-2 table-cell-wrap">
                            <input type="text" value="${formatNumberWithComma(item.unitPrice)}" class="w-full px-1 py-1 border rounded text-xs text-right" oninput="handlePriceInput(this, ${item.id}, 'unitPrice')" onblur="formatPriceOnBlur(this)">
                        </td>
                        <td class="col-accessory-price border px-1 py-2 table-cell-wrap">
                            <input type="text" value="${formatNumberWithComma(item.accessoryPrice)}" class="w-full px-1 py-1 border rounded text-xs text-right" oninput="handlePriceInput(this, ${item.id}, 'accessoryPrice')" onblur="formatPriceOnBlur(this)">
                        </td>
                        <td class="col-total border px-1 py-2 text-right table-cell-wrap"><span class="item-total-${item.id} font-medium text-xs">${formatCurrency(item.total)}</span></td>
                        <td class="col-actions border px-1 py-1 text-center table-cell-wrap">
                            <div class="flex flex-col gap-0.5 items-center">
                                <button onclick="copyItemRow(${item.id})" class="w-full px-1 py-0.5 bg-blue-100 text-blue-700 rounded text-[9px] hover:bg-blue-200 leading-tight">Copy</button>
                                <button onclick="deleteItemRow(${item.id})" class="w-full px-1 py-0.5 bg-red-100 text-red-700 rounded text-[9px] hover:bg-red-200 leading-tight">Xóa</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                    // Auto-adjust textarea heights after render
                    setTimeout(() => {
                        const textareas = tbody.querySelectorAll('textarea');
                        textareas.forEach(textarea => {
                            textarea.style.height = 'auto';
                            textarea.style.height = (textarea.scrollHeight) + 'px';
                        });
                    }, 10);
                }

                // Render both view table (giống hệt bảng chính)
                const tbodyBoth = document.getElementById('itemsTableBodyBoth');
                if (tbodyBoth) {
                    tbodyBoth.innerHTML = items.map((item, index) => `
                    <tr class="item-row" data-id="${item.id}">
                        <td class="col-stt border px-1 py-2 text-center table-cell-wrap text-sm">${index + 1}</td>
                        <td class="col-code border px-1 py-2 table-cell-wrap">
                            <input type="text" value="${item.code}" class="w-full px-1 py-1 border rounded text-xs" onchange="updateItem(${item.id}, 'code', this.value)" onblur="validateItemCode(${item.id})">
                        </td>
                        <td class="col-spec border px-1 py-2 table-cell-wrap">
                            <textarea rows="1" class="table-input px-1 py-1 border rounded text-xs" onchange="updateItem(${item.id}, 'spec', this.value)" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';">${item.spec || ''}</textarea>
                        </td>
                        <td class="col-glass border px-1 py-2 table-cell-wrap">
                            <textarea rows="1" class="table-input px-1 py-1 border rounded text-xs" onchange="updateItem(${item.id}, 'glass', this.value)" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';">${item.glass || ''}</textarea>
                        </td>
                        <td class="col-accessories border px-1 py-2 table-cell-wrap">
                            <textarea rows="1" class="table-input px-1 py-1 border rounded text-xs" onchange="updateItem(${item.id}, 'accessories', this.value)" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';">${item.accessories || ''}</textarea>
                        </td>
                        <td class="col-width border px-1 py-2 table-cell-wrap">
                            <input type="number" value="${item.width}" min="0" step="1" class="w-full px-1 py-1 border rounded text-xs text-center" onchange="updateItem(${item.id}, 'width', parseFloat(this.value))" onblur="calculateItemArea(${item.id})">
                        </td>
                        <td class="col-height border px-1 py-2 table-cell-wrap">
                            <input type="number" value="${item.height}" min="0" step="1" class="w-full px-1 py-1 border rounded text-xs text-center" onchange="updateItem(${item.id}, 'height', parseFloat(this.value))" onblur="calculateItemArea(${item.id})">
                        </td>
                        <td class="col-area border px-1 py-2 text-center table-cell-wrap"><span class="item-area-${item.id} text-xs">${(parseFloat(item.area) || 0).toFixed(2)}</span></td>
                        <td class="col-quantity border px-1 py-2 table-cell-wrap">
                            <input type="number" value="${item.quantity}" min="1" step="1" class="w-full px-1 py-1 border rounded text-xs text-center" onchange="updateItem(${item.id}, 'quantity', parseInt(this.value))" onblur="calculateItemTotal(${item.id})">
                        </td>
                        <td class="col-unit-price border px-1 py-2 table-cell-wrap">
                            <input type="text" value="${formatNumberWithComma(item.unitPrice)}" class="w-full px-1 py-1 border rounded text-xs text-right" oninput="handlePriceInput(this, ${item.id}, 'unitPrice')" onblur="formatPriceOnBlur(this)">
                        </td>
                        <td class="col-accessory-price border px-1 py-2 table-cell-wrap">
                            <input type="text" value="${formatNumberWithComma(item.accessoryPrice)}" class="w-full px-1 py-1 border rounded text-xs text-right" oninput="handlePriceInput(this, ${item.id}, 'accessoryPrice')" onblur="formatPriceOnBlur(this)">
                        </td>
                        <td class="col-total border px-1 py-2 text-right table-cell-wrap"><span class="item-total-${item.id} font-medium text-xs">${formatCurrency(item.total)}</span></td>
                        <td class="col-actions border px-1 py-1 text-center table-cell-wrap">
                            <div class="flex flex-col gap-0.5 items-center">
                                <button onclick="copyItemRow(${item.id})" class="w-full px-1 py-0.5 bg-blue-100 text-blue-700 rounded text-[9px] hover:bg-blue-200 leading-tight">Copy</button>
                                <button onclick="deleteItemRow(${item.id})" class="w-full px-1 py-0.5 bg-red-100 text-red-700 rounded text-[9px] hover:bg-red-200 leading-tight">Xóa</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                    // Auto-adjust textarea heights after render
                    setTimeout(() => {
                        const textareas = tbodyBoth.querySelectorAll('textarea');
                        textareas.forEach(textarea => {
                            textarea.style.height = 'auto';
                            textarea.style.height = (textarea.scrollHeight) + 'px';
                        });
                    }, 10);
                }
            }

            // Update item
            function updateItem(id, field, value) {
                const item = items.find(i => i.id === id);
                if (item) {
                    item[field] = value;
                }
            }

            // Calculate item area (Diện tích 1 bộ và tổng diện tích)
            function calculateItemArea(id) {
                const item = items.find(i => i.id === id);
                if (item && item.width > 0 && item.height > 0) {
                    // Diện tích 1 bộ sản phẩm
                    item.areaPerUnit = (item.width * item.height / 1000000);
                    // Tổng diện tích = Diện tích 1 bộ × Số bộ
                    item.area = item.areaPerUnit * item.quantity;
                    // Cập nhật tất cả các element có class item-area-${id} (có thể có nhiều nếu cả hai view đều hiển thị)
                    document.querySelectorAll(`.item-area-${id}`).forEach(el => {
                        el.textContent = item.area.toFixed(2);
                    });
                    calculateItemTotal(id);
                }
            }

            // Calculate item total
            // Công thức: Thành tiền = [(Diện tích 1 bộ × Đơn giá) + Phụ kiện 1 bộ] × Số bộ
            function calculateItemTotal(id) {
                const item = items.find(i => i.id === id);
                if (item) {
                    // Giá 1 bộ sản phẩm = (Diện tích 1 bộ × Đơn giá/m²) + (Phụ kiện 1 bộ)
                    const areaPerUnit = item.areaPerUnit || (item.width * item.height / 1000000);
                    const pricePerUnit = (areaPerUnit * item.unitPrice) + item.accessoryPrice;
                    // Tổng tiền = Giá 1 bộ × Số bộ
                    item.total = pricePerUnit * item.quantity;
                    // Cập nhật tất cả các element có class item-total-${id} (có thể có nhiều nếu cả hai view đều hiển thị)
                    document.querySelectorAll(`.item-total-${item.id}`).forEach(el => {
                        el.textContent = formatCurrency(item.total);
                    });
                    calculateTotals();
                }
            }

            // Calculate totals
            function calculateTotals() {
                // Đảm bảo tất cả giá trị là số
                const totalArea = items.reduce((sum, item) => sum + (parseFloat(item.area) || 0), 0);
                // Tổng tiền vật tư/nhôm kính = Tổng (Diện tích 1 bộ × Đơn giá × Số bộ)
                const totalMaterial = items.reduce((sum, item) => {
                    const width = parseFloat(item.width) || 0;
                    const height = parseFloat(item.height) || 0;
                    const unitPrice = parseFloat(item.unitPrice) || 0;
                    const quantity = parseInt(item.quantity) || 1;
                    const areaPerUnit = item.areaPerUnit || (width * height / 1000000);
                    return sum + (areaPerUnit * unitPrice * quantity);
                }, 0);
                // Tổng tiền phụ kiện = Tổng (Phụ kiện 1 bộ × Số bộ)
                const totalAccessories = items.reduce((sum, item) => sum + ((parseFloat(item.accessoryPrice) || 0) * (parseInt(item.quantity) || 1)), 0);
                const subtotal = totalMaterial + totalAccessories;

                // Get discount from active view
                const discountPercentEl = document.getElementById('discountPercent') || document.getElementById('discountPercentBoth');
                const discountPercent = parseFloat(discountPercentEl?.value) || 0;
                const discountAmount = (subtotal * discountPercent) / 100;
                const afterDiscount = subtotal - discountAmount;

                // Get VAT from active view
                const vatPercentEl = document.getElementById('vatPercent') || document.getElementById('vatPercentBoth');
                const vatPercent = parseFloat(vatPercentEl?.value) || 0;
                const vatAmount = (afterDiscount * vatPercent) / 100;

                // Get shipping from active view
                const shippingFeeEl = document.getElementById('shippingFee') || document.getElementById('shippingFeeBoth');
                const shippingFee = parseFloat(shippingFeeEl?.value) || 0;
                const finalTotal = afterDiscount + vatAmount + shippingFee;

                // Update main view
                if (document.getElementById('totalArea')) document.getElementById('totalArea').textContent = totalArea.toFixed(2) + ' m²';
                if (document.getElementById('totalMaterial')) document.getElementById('totalMaterial').textContent = formatCurrency(totalMaterial);
                if (document.getElementById('totalAccessories')) document.getElementById('totalAccessories').textContent = formatCurrency(totalAccessories);
                if (document.getElementById('discountAmount')) document.getElementById('discountAmount').textContent = formatCurrency(discountAmount);
                if (document.getElementById('vatAmount')) document.getElementById('vatAmount').textContent = formatCurrency(vatAmount);
                if (document.getElementById('finalTotal')) document.getElementById('finalTotal').textContent = formatCurrency(finalTotal);
                if (document.getElementById('totalInWords')) document.getElementById('totalInWords').textContent = numberToWords(finalTotal);

                // Sync discount and VAT inputs
                if (document.getElementById('discountPercent') && document.getElementById('discountPercentBoth')) {
                    document.getElementById('discountPercentBoth').value = document.getElementById('discountPercent').value;
                }
                if (document.getElementById('vatPercent') && document.getElementById('vatPercentBoth')) {
                    document.getElementById('vatPercentBoth').value = document.getElementById('vatPercent').value;
                }
                if (document.getElementById('shippingFee') && document.getElementById('shippingFeeBoth')) {
                    document.getElementById('shippingFeeBoth').value = document.getElementById('shippingFee').value;
                }

                // Update both view
                if (document.getElementById('totalAreaBoth')) document.getElementById('totalAreaBoth').textContent = totalArea.toFixed(2) + ' m²';
                if (document.getElementById('totalMaterialBoth')) document.getElementById('totalMaterialBoth').textContent = formatCurrency(totalMaterial);
                if (document.getElementById('totalAccessoriesBoth')) document.getElementById('totalAccessoriesBoth').textContent = formatCurrency(totalAccessories);
                if (document.getElementById('discountAmountBoth')) document.getElementById('discountAmountBoth').textContent = formatCurrency(discountAmount);
                if (document.getElementById('vatAmountBoth')) document.getElementById('vatAmountBoth').textContent = formatCurrency(vatAmount);
                if (document.getElementById('finalTotalBoth')) document.getElementById('finalTotalBoth').textContent = formatCurrency(finalTotal);
                if (document.getElementById('totalInWordsBoth')) document.getElementById('totalInWordsBoth').textContent = numberToWords(finalTotal);
            }

            // Validate item code (no duplicates)
            function validateItemCode(id) {
                const item = items.find(i => i.id === id);
                if (!item) return;
                const duplicates = items.filter(i => i.id !== id && i.code === item.code);
                if (duplicates.length > 0) {
                    alert(`Ký hiệu ${item.code} đã tồn tại! Vui lòng chọn ký hiệu khác.`);
                    item.code = `C${String(items.findIndex(i => i.id === id) + 1).padStart(2, '0')}`;
                    renderItemsTable();
                }
            }

            // Copy item row
            function copyItemRow(id) {
                const item = items.find(i => i.id === id);
                if (item) {
                    addItemRow({ ...item, code: '' });
                }
            }

            // Delete item row
            function deleteItemRow(id) {
                if (confirm('Bạn có chắc muốn xóa dòng này?')) {
                    items = items.filter(i => i.id !== id);
                    renderItemsTable();
                    calculateTotals();
                }
            }

            // Load door catalog
            async function loadDoorCatalog() {
                try {
                    // Thử load từ product-templates trước, fallback về door-templates
                    let response = await fetch(`${API_BASE}/product-templates`);
                    let result = await response.json();

                    if (!result.success) {
                        // Fallback về door-templates nếu product-templates không có
                        response = await fetch(`${API_BASE}/door-templates`);
                        result = await response.json();
                    }

                    if (result.success) {
                        window.doorCatalog = result.data;
                        renderDoorCatalog();
                    }
                } catch (error) {
                    console.error('Error loading product catalog:', error);
                    // Fallback cuối cùng
                    try {
                        const response = await fetch(`${API_BASE}/door-templates`);
                        const result = await response.json();
                        if (result.success) {
                            window.doorCatalog = result.data;
                            renderDoorCatalog();
                        }
                    } catch (fallbackError) {
                        console.error('Fallback also failed:', fallbackError);
                    }
                }
            }

            // Render door catalog
            function renderDoorCatalog() {
                if (!window.doorCatalog) return;
                const container = document.getElementById('doorList');
                container.innerHTML = window.doorCatalog.map(door => `
                <div class="border rounded-lg p-4 cursor-pointer hover:bg-gray-50" onclick="selectDoor(${door.id})">
                    <div class="font-medium">${door.code || door.name}</div>
                    <div class="text-sm text-gray-600">${door.name}</div>
                    <div class="text-xs text-gray-500 mt-1">${door.aluminum_system_name || 'N/A'}</div>
                </div>
            `).join('');
            }

            // Open door catalog modal
            function openDoorCatalogModal() {
                document.getElementById('doorCatalogModal').classList.remove('hidden');
            }

            // Close door catalog modal
            function closeDoorCatalogModal() {
                document.getElementById('doorCatalogModal').classList.add('hidden');
            }

            // Select door
            function selectDoor(doorId) {
                const door = window.doorCatalog.find(d => d.id === doorId);
                if (door) {
                    addItemRow({
                        code: door.code || '',
                        name: door.name || '',
                        aluminum_system_name: door.aluminum_system_name || '',
                        width: 0,
                        height: 0,
                        quantity: 1,
                        unit_price: 0,
                        accessory_price: 0
                    });
                    closeDoorCatalogModal();
                }
            }

            // Filter doors
            function filterDoors() {
                const search = document.getElementById('doorSearch').value.toLowerCase();
                const doors = document.querySelectorAll('#doorList > div');
                doors.forEach(door => {
                    const text = door.textContent.toLowerCase();
                    door.style.display = text.includes(search) ? 'block' : 'none';
                });
            }

            // Save quotation
            async function saveQuotation() {
                if (!validateForm()) return;
                const data = prepareQuotationData();
                data.status = data.status || 'draft';
                // Không gửi quotation_code, để backend tự generate
                await saveQuotationToServer(data);
            }

            // Send quotation
            async function sendQuotation() {
                if (!validateForm()) return;
                const data = prepareQuotationData();
                data.status = 'sent';
                // Không gửi quotation_code, để backend tự generate
                await saveQuotationToServer(data);
            }

            // Approve quotation
            async function approveQuotation() {
                if (!validateForm()) return;
                if (!confirm('Bạn có chắc muốn chốt báo giá này? Sau khi chốt, báo giá sẽ không thể chỉnh sửa.')) return;

                const data = prepareQuotationData();
                data.status = 'approved';
                // Không gửi quotation_code, để backend tự generate

                await saveQuotationToServer(data);

                // Gọi workflow API để cập nhật project progress
                // Điều này sẽ cập nhật progress_percent của project lên 25% (bước Báo giá hoàn thành)
                if (currentQuotationId) {
                    try {
                        const token = localStorage.getItem('token');
                        const workflowResponse = await fetch(`${API_BASE}/workflow/quotation/${currentQuotationId}/approve`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                createProductionOrder: false, // Không tạo lệnh SX ngay, để đợi bóc tách
                                createDebt: true,
                                createCommission: false
                            })
                        });

                        const workflowResult = await workflowResponse.json();
                        if (workflowResult.success) {
                            console.log('✅ Workflow triggered - Project progress updated to 25%');
                        } else {
                            console.warn('Workflow response:', workflowResult.message);
                        }
                    } catch (workflowError) {
                        console.error('Workflow API error:', workflowError);
                        // Không throw error, báo giá vẫn đã được lưu
                    }
                }

                // Reload quotation từ server để đảm bảo status được cập nhật đúng
                if (currentQuotationId) {
                    await loadQuotation(currentQuotationId);
                }

                // Reload lại lịch sử báo giá để hiển thị báo giá đã chốt
                // Kiểm tra xem modal lịch sử có đang mở không
                const historyModal = document.getElementById('quotationHistoryModal');
                if (historyModal && !historyModal.classList.contains('hidden')) {
                    await loadQuotationHistory();
                }

                // Ẩn các nút không cần thiết
                document.getElementById('approveBtn').classList.add('hidden'); // Ẩn "Chốt báo giá"
                document.getElementById('sendQuotationBtn').classList.add('hidden'); // Ẩn "Gửi báo giá"
                document.getElementById('cancelBtn').classList.add('hidden'); // Ẩn "Hủy báo giá"

                // ✅ CRITICAL FIX: Hiện nút "Chốt hợp đồng" ở 2 vị trí sau khi chốt báo giá
                const signContractBtn = document.getElementById('signContractBtn');
                if (signContractBtn) {
                    signContractBtn.classList.remove('hidden');
                }
                // Hiện nút cạnh dropdown Dự án (ưu tiên)
                const signContractBtnNextToProject = document.getElementById('signContractBtnNextToProject');
                if (signContractBtnNextToProject) {
                    signContractBtnNextToProject.classList.remove('hidden');
                }

                // Hiển thị thông báo "Đã chốt báo giá" (màu vàng/amber)
                showStatusNotification('approved');

                // Update status display (đã được cập nhật trong loadQuotation, nhưng đảm bảo chắc chắn)
                document.getElementById('quoteStatus').textContent = getStatusText('approved');

                // Không lock form - vẫn có thể xem bình thường
                isLocked = true; // Chỉ đánh dấu là đã chốt, không disable form

                showSuccessNotification('✅ Đã chốt báo giá thành công!', 'Tiến độ dự án đã được cập nhật lên 25%. Bạn có thể chốt hợp đồng để chuyển sang giai đoạn thiết kế.');
            }

            // Sign contract (chuyển VRBG → VR)
            async function signContract() {
                if (!currentQuotationId) {
                    alert('Vui lòng lưu báo giá trước!');
                    return;
                }

                try {
                    const token = localStorage.getItem('token');

                    // Lấy project_id từ dropdown hoặc từ quotation data nếu dropdown rỗng
                    let projectId = document.getElementById('projectSelect').value;

                    // Nếu dropdown không có giá trị, lấy từ quotation data
                    if (!projectId) {
                        const quotationResponse = await fetch(`${API_BASE}/quotations/${currentQuotationId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const quotationResult = await quotationResponse.json();

                        if (quotationResult.success && quotationResult.data && quotationResult.data.project_id) {
                            projectId = quotationResult.data.project_id;

                            // Cập nhật dropdown value và đảm bảo option tồn tại
                            const projectSelect = document.getElementById('projectSelect');
                            const optionExists = Array.from(projectSelect.options).some(opt => opt.value == projectId);
                            if (!optionExists) {
                                // Thêm option mới nếu chưa có
                                const option = document.createElement('option');
                                option.value = projectId;
                                option.textContent = `Dự án ID: ${projectId}`;
                                projectSelect.appendChild(option);
                            }
                            projectSelect.value = projectId;
                        }
                    }

                    // Kiểm tra project_id trước khi chốt hợp đồng
                    if (!projectId) {
                        alert('Lỗi: Báo giá chưa gắn với dự án.\n\nVui lòng chọn dự án trước khi chốt hợp đồng.');
                        return;
                    }

                    if (!confirm('Bạn có chắc muốn chốt hợp đồng? Dự án sẽ chuyển từ mã VRBG sang VR và báo giá sẽ trở thành hợp đồng.')) return;

                    // Đảm bảo project_id được cập nhật trước khi chốt hợp đồng
                    // Nếu project_id trong form khác với database, cập nhật lại
                    const quotationCheckResponse = await fetch(`${API_BASE}/quotations/${currentQuotationId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const quotationCheckResult = await quotationCheckResponse.json();

                    if (quotationCheckResult.success && quotationCheckResult.data) {
                        const quotation = quotationCheckResult.data;
                        // Nếu quotation không có project_id hoặc project_id khác, cập nhật lại
                        if (!quotation.project_id || quotation.project_id != projectId) {
                            console.log('Cập nhật project_id trước khi chốt hợp đồng:', projectId);
                            const updateData = prepareQuotationData();
                            updateData.project_id = parseInt(projectId);
                            // Giữ nguyên status hiện tại
                            updateData.status = quotation.status || 'approved';
                            await saveQuotationToServer(updateData);

                            // Đợi một chút để đảm bảo update hoàn tất
                            await new Promise(resolve => setTimeout(resolve, 500));

                            // Kiểm tra lại sau khi update
                            const verifyResponse = await fetch(`${API_BASE}/quotations/${currentQuotationId}`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            const verifyResult = await verifyResponse.json();
                            if (verifyResult.success && !verifyResult.data.project_id) {
                                alert('Lỗi: Không thể cập nhật project_id. Vui lòng thử lại.');
                                return;
                            }
                        }
                    }

                    const response = await fetch(`${API_BASE}/quotations/${currentQuotationId}/sign-contract`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();
                    if (result.success) {
                        // Reload quotation để cập nhật status và hiển thị đúng thông báo
                        if (currentQuotationId) {
                            await loadQuotation(currentQuotationId);
                        }

                        // Hiển thị thông báo thành công
                        showSuccessNotification('✅ Đã chốt hợp đồng thành công!', `Mã dự án: ${result.data.old_project_code} → ${result.data.new_project_code}. Dự án đã chuyển sang giai đoạn thiết kế.`);

                        // Lấy project_id để redirect
                        const projectIdToRedirect = projectId || result.data.project_id;

                        // Đợi 2 giây để user thấy thông báo rồi tự động chuyển sang trang thiết kế
                        setTimeout(() => {
                            if (projectIdToRedirect) {
                                // Chuyển sang trang thiết kế của dự án
                                window.location.href = `design-new.html?project_id=${projectIdToRedirect}`;
                            } else {
                                // Fallback: về trang quản lý dự án
                                window.location.href = 'sales.html#projects';
                            }
                        }, 2000);
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể chốt hợp đồng'));
                    }
                } catch (error) {
                    console.error('Error signing contract:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            // Cancel quotation - Xóa toàn bộ lịch sử phiên bản
            async function cancelQuotation() {
                // Kiểm tra nếu báo giá đã chốt thì không cho phép hủy
                if (currentQuotationId) {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`${API_BASE}/quotations/${currentQuotationId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const result = await response.json();

                        if (result.success) {
                            const q = result.data;
                            // Nếu báo giá đã chốt (approved hoặc contract_signed) thì không cho phép hủy
                            if (q.status === 'approved' || q.status === 'contract_signed') {
                                alert('Không thể hủy báo giá đã chốt!\n\nBáo giá này đã được chốt và dự án đã chuyển sang giai đoạn tiếp theo. Vui lòng liên hệ quản trị viên nếu cần thay đổi.');
                                return;
                            }
                        }
                    } catch (error) {
                        console.error('Error checking quotation status:', error);
                        // Tiếp tục nếu không load được status
                    }
                }

                const projectId = document.getElementById('projectSelect').value;

                if (!currentQuotationId && !projectId) {
                    alert('Không có báo giá nào để hủy!');
                    return;
                }

                if (!confirm('Bạn có chắc chắn muốn HỦY BÁO GIÁ này?\n\n⚠️ CẢNH BÁO: Tất cả các phiên bản báo giá (V1, V2, V3...) của dự án này sẽ bị XÓA VĨNH VIỄN!\n\nSau khi xóa, bạn sẽ cần tạo lại báo giá từ đầu.')) {
                    return;
                }

                try {
                    const token = localStorage.getItem('token');

                    // Nếu có currentQuotationId, tìm tất cả versions
                    if (currentQuotationId) {
                        // Load quotation hiện tại để lấy project_id
                        const response = await fetch(`${API_BASE}/quotations/${currentQuotationId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const result = await response.json();

                        if (result.success) {
                            const currentQuotation = result.data;
                            const deleteProjectId = currentQuotation.project_id || projectId;

                            if (deleteProjectId) {
                                // Tìm tất cả quotations của project
                                const allQuotationsResponse = await fetch(`${API_BASE}/quotations?project_id=${deleteProjectId}`, {
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                const allQuotationsResult = await allQuotationsResponse.json();

                                if (allQuotationsResult.success && allQuotationsResult.data) {
                                    const quotationIds = allQuotationsResult.data.map(q => q.id);

                                    // Xóa từng quotation
                                    for (const qid of quotationIds) {
                                        await fetch(`${API_BASE}/quotations/${qid}`, {
                                            method: 'DELETE',
                                            headers: { 'Authorization': `Bearer ${token}` }
                                        });
                                    }

                                    showSuccessNotification(`Đã xóa ${quotationIds.length} phiên bản báo giá thành công!`);

                                    // Reset project code về ban đầu (xóa VRBG)
                                    if (deleteProjectId) {
                                        await fetch(`${API_BASE}/projects/${deleteProjectId}`, {
                                            method: 'PUT',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${token}`
                                            },
                                            body: JSON.stringify({
                                                project_code: null // Reset về null để có thể tạo mã mới
                                            })
                                        });
                                    }

                                    // Reload trang với projectId để tạo báo giá mới
                                    if (deleteProjectId) {
                                        const custId = currentQuotation.customer_id || document.getElementById('customerSelect').value;
                                        window.location.href = `quotation-new.html?projectId=${deleteProjectId}${custId ? '&customerId=' + custId : ''}`;
                                    } else {
                                        window.location.href = 'quotation-new.html';
                                    }
                                }
                            }
                        }
                    } else if (projectId) {
                        // Nếu chưa lưu nhưng đã chọn project, chỉ reset trang
                        if (confirm('Báo giá chưa được lưu. Bạn có muốn reset trang?')) {
                            window.location.href = `quotation-new.html?projectId=${projectId}`;
                        }
                    } else {
                        // Không có gì, chỉ reset trang
                        window.location.href = 'quotation-new.html';
                    }
                } catch (error) {
                    console.error('Error canceling quotation:', error);
                    alert('Lỗi khi hủy báo giá: ' + error.message);
                }
            }

            // Reset quotation (Thiết lập lại báo giá từ V1)
            async function resetQuotation() {
                if (!currentQuotationId) {
                    alert('Không tìm thấy báo giá để thiết lập lại!');
                    return;
                }
                if (!confirm('Bạn có muốn thiết lập lại báo giá từ dữ liệu V1? Dữ liệu hiện tại sẽ được cập nhật từ báo giá gốc.')) return;

                try {
                    // Load current quotation to find parent
                    const response = await fetch(`${API_BASE}/quotations/${currentQuotationId}`);
                    const result = await response.json();

                    if (result.success) {
                        const q = result.data;
                        // Find the first quotation (V1) for this project
                        let parentQuotationId = q.parent_quotation_id;

                        // If no parent, find the first quotation for this project
                        if (!parentQuotationId && q.project_id) {
                            const projectQuotationsResponse = await fetch(`${API_BASE}/quotations?project_id=${q.project_id}`);
                            const projectQuotationsResult = await projectQuotationsResponse.json();
                            if (projectQuotationsResult.success && projectQuotationsResult.data.length > 0) {
                                // Find the oldest quotation (V1)
                                const sorted = projectQuotationsResult.data.sort((a, b) =>
                                    new Date(a.created_at) - new Date(b.created_at)
                                );
                                parentQuotationId = sorted[0].id;
                            }
                        }

                        // If still no parent, use current quotation as source
                        if (!parentQuotationId) {
                            parentQuotationId = currentQuotationId;
                        }

                        // Load parent quotation data
                        const parentResponse = await fetch(`${API_BASE}/quotations/${parentQuotationId}`);
                        const parentResult = await parentResponse.json();

                        if (parentResult.success) {
                            const parentQ = parentResult.data;

                            // Reset items to parent's items
                            if (parentQ.items && parentQ.items.length > 0) {
                                items = parentQ.items.map((item, index) => ({
                                    id: index + 1,
                                    stt: index + 1,
                                    code: item.code || `C${String(index + 1).padStart(2, '0')}`,
                                    design: item.item_name || '',
                                    spec: item.spec || '',
                                    glass: item.glass || '',
                                    accessories: item.accessories || '',
                                    width: item.width || 0,
                                    height: item.height || 0,
                                    area: item.area || 0,
                                    quantity: item.quantity || 1,
                                    unitPrice: item.unit_price || 0,
                                    accessoryPrice: item.accessory_price || 0,
                                    total: item.total_price || 0
                                }));
                                itemCounter = items.length;
                                renderItemsTable();
                                calculateTotals();
                            }

                            // Update other fields from parent
                            document.getElementById('quoteNotes').value = parentQ.notes || '';
                            document.getElementById('validityDays').value = parentQ.validity_days || 15;

                            alert('Đã thiết lập lại báo giá từ dữ liệu V1!');
                        } else {
                            alert('Lỗi: Không thể tải dữ liệu báo giá gốc');
                        }
                    } else {
                        alert('Lỗi: Không thể tải dữ liệu báo giá');
                    }
                } catch (error) {
                    console.error('Error resetting quotation:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            // Tạo phiên bản mới từ version gần nhất (từ lịch sử)
            async function createNewVersionFromV1() {
                if (!currentQuotationId) {
                    alert('Không tìm thấy báo giá hiện tại!');
                    return;
                }

                try {
                    const token = localStorage.getItem('token');
                    // Load current quotation
                    const response = await fetch(`${API_BASE}/quotations/${currentQuotationId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();

                    if (!result.success) {
                        alert('Lỗi: Không thể tải dữ liệu báo giá');
                        return;
                    }

                    const q = result.data;

                    // Kiểm tra nếu đã chốt báo giá
                    if (q.status === 'approved' || q.status === 'contract_signed') {
                        alert('Báo giá đã được chốt, không thể tạo phiên bản mới!');
                        return;
                    }

                    // Load tất cả quotations của project
                    const projectQuotationsResponse = await fetch(`${API_BASE}/quotations?project_id=${q.project_id}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const projectQuotationsResult = await projectQuotationsResponse.json();

                    if (!projectQuotationsResult.success || !projectQuotationsResult.data || projectQuotationsResult.data.length === 0) {
                        alert('Không tìm thấy báo giá nào của dự án này!');
                        return;
                    }

                    // Tìm version GẦN NHẤT (version cao nhất hoặc ngày tạo mới nhất)
                    const allQuotations = projectQuotationsResult.data.sort((a, b) =>
                        new Date(b.created_at) - new Date(a.created_at) // Sắp xếp từ mới đến cũ
                    );

                    const latestQuotation = allQuotations[0]; // Version gần nhất
                    const latestQuotationId = latestQuotation.id;

                    // Load dữ liệu version gần nhất
                    const latestResponse = await fetch(`${API_BASE}/quotations/${latestQuotationId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const latestResult = await latestResponse.json();

                    if (!latestResult.success) {
                        alert('Lỗi: Không thể tải dữ liệu báo giá gần nhất');
                        return;
                    }

                    const latestQ = latestResult.data;

                    // Tính version tiếp theo
                    const currentMaxVersion = Math.max(...allQuotations.map(qu => qu.version || 1));
                    const nextVersion = currentMaxVersion + 1;

                    if (!confirm(`Bạn có muốn tạo phiên bản mới V${nextVersion} từ V${latestQuotation.version || currentMaxVersion}? Dữ liệu hiện tại sẽ được thay thế.`)) return;

                    // Load items từ version gần nhất
                    if (latestQ.items && latestQ.items.length > 0) {
                        items = latestQ.items.map((item, index) => ({
                            id: index + 1,
                            stt: index + 1,
                            code: item.code || `C${String(index + 1).padStart(2, '0')}`,
                            design: item.item_name || '',
                            spec: item.spec || '',
                            glass: item.glass || '',
                            accessories: item.accessories || '',
                            width: item.width || 0,
                            height: item.height || 0,
                            area: item.area || 0,
                            quantity: item.quantity || 1,
                            unitPrice: item.unit_price || 0,
                            accessoryPrice: item.accessory_price || 0,
                            total: item.total_price || 0
                        }));
                        itemCounter = items.length;
                    } else {
                        items = [];
                        itemCounter = 0;
                    }

                    // Update form fields từ version gần nhất
                    document.getElementById('customerSelect').value = latestQ.customer_id;
                    document.getElementById('projectSelect').value = latestQ.project_id || '';
                    document.getElementById('quoteDate').value = latestQ.quotation_date ? latestQ.quotation_date.split('T')[0] : new Date().toISOString().split('T')[0];
                    document.getElementById('validityDays').value = latestQ.validity_days || 15;
                    document.getElementById('quoteNotes').value = latestQ.notes || '';
                    document.getElementById('quoteCreator').value = latestQ.creator_name || document.getElementById('quoteCreator').value;

                    // Load cả discount, VAT, shipping từ version gần nhất
                    if (latestQ.discount_percent !== undefined) {
                        document.getElementById('discountPercent').value = latestQ.discount_percent;
                        if (document.getElementById('discountPercentBoth')) {
                            document.getElementById('discountPercentBoth').value = latestQ.discount_percent;
                        }
                    }
                    if (latestQ.vat_percent !== undefined) {
                        document.getElementById('vatPercent').value = latestQ.vat_percent;
                        if (document.getElementById('vatPercentBoth')) {
                            document.getElementById('vatPercentBoth').value = latestQ.vat_percent;
                        }
                    }
                    if (latestQ.shipping_fee !== undefined) {
                        document.getElementById('shippingFee').value = latestQ.shipping_fee;
                        if (document.getElementById('shippingFeeBoth')) {
                            document.getElementById('shippingFeeBoth').value = latestQ.shipping_fee;
                        }
                    }

                    // Update version display
                    currentVersion = nextVersion;
                    document.getElementById('quoteVersion').textContent = `Lần ${nextVersion} (V${nextVersion})`;
                    document.getElementById('quoteStatus').textContent = getStatusText('draft');

                    // Tìm V1 để làm parent VÀ lấy mã báo giá gốc
                    const v1Quotation = allQuotations.find(qu => qu.version === 1 || !qu.parent_quotation_id) || allQuotations[allQuotations.length - 1];
                    const v1QuotationId = v1Quotation.id;

                    // GIỮ NGUYÊN mã báo giá từ V1 - Không tạo mã mới!
                    const originalQuoteCode = v1Quotation.quotation_code || latestQ.quotation_code;
                    document.getElementById('quoteCode').textContent = originalQuoteCode;
                    document.getElementById('quoteCodeInput').value = originalQuoteCode;
                    // Disable input để không cho sửa mã khi tạo version mới
                    document.getElementById('quoteCodeInput').readOnly = true;

                    // Update header với version mới
                    const headerVersion = document.querySelector('.header-gradient h1');
                    if (headerVersion) {
                        headerVersion.innerHTML = `${latestQ.project_name || 'Tên dự án / Công trình'}`;
                    }

                    // Lưu mã báo giá gốc để sử dụng khi lưu
                    window.originalQuoteCode = originalQuoteCode;

                    // Lưu parent_quotation_id (V1) để khi lưu sẽ tạo version mới
                    parentQuotationId = v1QuotationId;

                    // Reset currentQuotationId để tạo mới
                    currentQuotationId = null;
                    isLocked = false;
                    unlockForm();

                    // Render table
                    renderItemsTable();
                    calculateTotals();

                    // Load customer and project info
                    await loadCustomerInfo();
                    await loadProjectInfo();

                    // Close history modal
                    closeQuotationHistoryModal();

                    console.log(`Version mới: V${nextVersion}, Parent ID: ${v1QuotationId}, Dữ liệu từ: V${latestQuotation.version || currentMaxVersion}`);
                    alert(`Đã tải dữ liệu từ V${latestQuotation.version || currentMaxVersion}. Hiện tại là phiên bản V${nextVersion}. Khi lưu sẽ tạo phiên bản mới V${nextVersion}.`);
                } catch (error) {
                    console.error('Error creating new version from V1:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            // Show quotation history modal
            async function showQuotationHistory() {
                // Mở modal lịch sử - hiển thị tất cả báo giá nếu không chọn dự án
                document.getElementById('quotationHistoryModal').classList.remove('hidden');
                await loadQuotationHistory();

                // Không cần hiển thị nút "Tạo phiên bản mới" vì chỉ có 1 báo giá duy nhất
            }

            // Close quotation history modal
            function closeQuotationHistoryModal() {
                document.getElementById('quotationHistoryModal').classList.add('hidden');
            }

            // View quotation detail from history
            async function viewQuotationDetail(quotationId) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/quotations/${quotationId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();

                    if (!result.success) {
                        alert('Lỗi: Không thể tải dữ liệu báo giá');
                        return;
                    }

                    const q = result.data;
                    currentDetailQuotationId = quotationId; // Lưu ID để dùng cho xuất Excel

                    // Đảm bảo có thông tin dự án - load thêm nếu cần
                    let projectName = q.project_name;
                    let projectCode = q.project_code;

                    // Nếu không có project_name từ API nhưng có project_id, load thêm thông tin project
                    if ((!projectName || !projectCode) && q.project_id) {
                        try {
                            const projectResponse = await fetch(`${API_BASE}/projects/${q.project_id}`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            const projectResult = await projectResponse.json();
                            if (projectResult.success && projectResult.data) {
                                projectName = projectName || projectResult.data.project_name || '';
                                projectCode = projectCode || projectResult.data.project_code || '';
                            }
                        } catch (error) {
                            console.error('Error loading project info:', error);
                        }
                    }

                    // Format tên dự án: "Mã - Tên" hoặc chỉ "Tên" nếu không có mã
                    let displayProjectName = 'N/A';
                    if (projectName) {
                        if (projectCode) {
                            displayProjectName = `${projectCode} - ${projectName}`;
                        } else {
                            displayProjectName = projectName;
                        }
                    } else if (projectCode) {
                        displayProjectName = projectCode;
                    }

                    // Hiển thị modal chi tiết
                    document.getElementById('quotationDetailModal').classList.remove('hidden');

                    // Fill thông tin cơ bản
                    document.getElementById('detailQuoteCode').textContent = q.quotation_code || 'N/A';
                    document.getElementById('detailCustomerName').textContent = q.customer_name || 'N/A';
                    document.getElementById('detailProjectName').textContent = displayProjectName;

                    // Format quotation date
                    const quoteDate = q.quotation_date ? new Date(q.quotation_date).toLocaleDateString('vi-VN') : 'N/A';

                    // Format created date with time
                    let createdDateTime = 'N/A';
                    if (q.created_at) {
                        const createdDateObj = new Date(q.created_at);
                        const dateStr = createdDateObj.toLocaleDateString('vi-VN');
                        const timeStr = createdDateObj.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                        createdDateTime = `${dateStr} ${timeStr}`;
                    }

                    document.getElementById('detailQuoteDate').textContent = quoteDate;
                    document.getElementById('detailValidityDays').textContent = (q.validity_days || 0) + ' ngày';
                    document.getElementById('detailStatus').textContent = getStatusText(q.status);
                    document.getElementById('detailVersion').textContent = createdDateTime;
                    document.getElementById('detailCreator').textContent = q.creator_name || 'N/A';

                    // Fill bảng hạng mục - giống mẫu bảng chính
                    const tbody = document.getElementById('detailItemsTableBody');
                    if (q.items && q.items.length > 0) {
                        tbody.innerHTML = q.items.map((item, index) => `
                        <tr class="hover:bg-gray-50">
                            <td class="border px-2 py-2 text-center text-xs">${index + 1}</td>
                            <td class="border px-2 py-2 text-xs">${item.code || ''}</td>
                            <td class="border px-2 py-2 text-xs">${item.spec || ''}</td>
                            <td class="border px-2 py-2 text-xs">${item.glass || ''}</td>
                            <td class="border px-2 py-2 text-xs">${item.accessories || ''}</td>
                            <td class="border px-2 py-2 text-center text-xs">${parseFloat(item.width) || 0}</td>
                            <td class="border px-2 py-2 text-center text-xs">${parseFloat(item.height) || 0}</td>
                            <td class="border px-2 py-2 text-center text-xs">${(parseFloat(item.area) || 0).toFixed(2)}</td>
                            <td class="border px-2 py-2 text-center text-xs">${parseInt(item.quantity) || 0}</td>
                            <td class="border px-2 py-2 text-right text-xs">${formatNumberWithComma(item.unit_price || 0)}</td>
                            <td class="border px-2 py-2 text-right text-xs">${formatNumberWithComma(item.accessory_price || 0)}</td>
                            <td class="border px-2 py-2 text-right text-xs font-medium">${formatCurrency(item.total_price || 0)}</td>
                        </tr>
                    `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="12" class="border px-3 py-4 text-center text-gray-500">Không có hạng mục nào</td></tr>';
                    }

                    // Tính tổng - Sử dụng total_amount từ database
                    let totalArea = 0;
                    let totalMaterial = 0;
                    let totalAccessories = 0;
                    let subtotal = 0;

                    if (q.items) {
                        q.items.forEach(item => {
                            const width = parseFloat(item.width) || 0;
                            const height = parseFloat(item.height) || 0;
                            const quantity = parseInt(item.quantity) || 1;
                            const unitPrice = parseFloat(item.unit_price) || 0;
                            const accessoryPrice = parseFloat(item.accessory_price) || 0;
                            const itemTotalPrice = parseFloat(item.total_price) || 0;

                            const itemArea = (width * height) / 1000000; // mm² to m²
                            const itemTotalArea = itemArea * quantity;
                            totalArea += itemTotalArea;

                            // Tính tiền vật tư: Diện tích 1 bộ × Đơn giá × Số bộ
                            const materialCost = itemArea * unitPrice * quantity;
                            totalMaterial += materialCost;

                            // Tính tiền phụ kiện: Phụ kiện 1 bộ × Số bộ
                            const accessoryCost = accessoryPrice * quantity;
                            totalAccessories += accessoryCost;

                            // Tổng tiền hạng mục
                            subtotal += itemTotalPrice;
                        });
                    }

                    // Lấy thông tin chiết khấu, VAT, phí vận chuyển từ database hoặc tính mặc định
                    const discountPercent = q.discount_percent || 0;
                    const discountAmount = subtotal * (discountPercent / 100);
                    const afterDiscount = subtotal - discountAmount;

                    const vatPercent = q.vat_percent || 10;
                    const vatAmount = afterDiscount * (vatPercent / 100);

                    const shippingFee = q.shipping_fee || 0;

                    // Sử dụng total_amount từ database nếu có, nếu không thì tính
                    const finalTotal = q.total_amount || (afterDiscount + vatAmount + shippingFee);

                    // Fill tổng hợp
                    document.getElementById('detailTotalArea').textContent = totalArea.toFixed(2) + ' m²';
                    document.getElementById('detailTotalMaterial').textContent = formatCurrency(totalMaterial);
                    document.getElementById('detailTotalAccessories').textContent = formatCurrency(totalAccessories);
                    document.getElementById('detailDiscount').textContent = formatCurrency(discountAmount) + ` (${discountPercent}%)`;
                    document.getElementById('detailVAT').textContent = formatCurrency(vatAmount) + ` (${vatPercent}%)`;
                    document.getElementById('detailShippingFee').textContent = formatCurrency(shippingFee);
                    document.getElementById('detailFinalTotal').textContent = formatCurrency(finalTotal);
                    document.getElementById('detailTotalInWords').textContent = numberToWords(finalTotal);

                    // Fill ghi chú
                    if (q.notes) {
                        document.getElementById('detailNotes').textContent = q.notes;
                        document.getElementById('detailNotesSection').style.display = 'block';
                    } else {
                        document.getElementById('detailNotesSection').style.display = 'none';
                    }

                    // Đóng modal lịch sử
                    closeQuotationHistoryModal();
                } catch (error) {
                    console.error('Error viewing quotation detail:', error);
                    alert('Lỗi khi tải chi tiết báo giá: ' + error.message);
                }
            }

            // Close quotation detail modal
            function closeQuotationDetailModal() {
                document.getElementById('quotationDetailModal').classList.add('hidden');
            }

            // Export current quotation to Excel (for purple button in header)
            async function exportExcel() {
                if (!currentQuotationId) {
                    alert('Vui lòng lưu báo giá trước khi xuất Excel!');
                    return;
                }

                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/quotations/${currentQuotationId}/export-excel`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Không thể xuất file Excel');
                    }

                    // Nhận file blob và download
                    const quoteCode = document.getElementById('quoteCode')?.textContent || 'BaoGia';
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Bao_gia_${quoteCode}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();

                    showSuccessNotification('Đã xuất file Excel thành công!');
                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    alert('Lỗi khi xuất Excel: ' + error.message);
                }
            }

            // Export quotation detail to Excel
            async function exportQuotationDetailToExcel() {
                try {
                    // Lấy quotation_id từ biến currentDetailQuotation hoặc từ modal
                    const quoteCode = document.getElementById('detailQuoteCode').textContent;

                    if (!currentDetailQuotationId) {
                        alert('Không tìm thấy thông tin báo giá để xuất.');
                        return;
                    }

                    // Show loading
                    const exportBtn = document.querySelector('button[onclick="exportQuotationDetailToExcel()"]');
                    const originalText = exportBtn.innerHTML;
                    exportBtn.innerHTML = '<svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Đang xuất...';
                    exportBtn.disabled = true;

                    // Gọi API xuất Excel - sử dụng đúng endpoint
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/quotations/${currentDetailQuotationId}/export-excel`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Không thể xuất file Excel');
                    }

                    // Nhận file blob và download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Bao_gia_${quoteCode}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();

                    // Reset button
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;

                    showSuccessNotification('Đã xuất file Excel thành công!');
                } catch (error) {
                    console.error('Error exporting quotation to Excel:', error);
                    alert('Lỗi khi xuất Excel: ' + error.message);

                    // Reset button on error
                    const exportBtn = document.querySelector('button[onclick="exportQuotationDetailToExcel()"]');
                    if (exportBtn) {
                        exportBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> Xuất Excel';
                        exportBtn.disabled = false;
                    }
                }
            }

            // Load quotation history - Load tất cả báo giá của dự án
            async function loadQuotationHistory() {
                try {
                    const token = localStorage.getItem('token');

                    const container = document.getElementById('quotationHistoryList');
                    let quotationsToShow = [];

                    // Lấy project_id từ nhiều nguồn: dropdown, URL, hoặc quotation hiện tại
                    let projectId = document.getElementById('projectSelect')?.value;

                    // Nếu không có từ dropdown, thử lấy từ URL
                    if (!projectId) {
                        const urlParams = new URLSearchParams(window.location.search);
                        projectId = urlParams.get('projectId');
                    }

                    // Nếu vẫn không có, thử lấy từ quotation hiện tại (nếu có)
                    if (!projectId && currentQuotationId) {
                        const currentResponse = await fetch(`${API_BASE}/quotations/${currentQuotationId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const currentResult = await currentResponse.json();

                        if (currentResult.success && currentResult.data) {
                            projectId = currentResult.data.project_id;
                        }
                    }

                    // Load tất cả báo giá của project (kể cả đã chốt)
                    if (projectId) {
                        const allQuotationsResponse = await fetch(`${API_BASE}/quotations?project_id=${projectId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const allQuotationsResult = await allQuotationsResponse.json();

                        if (allQuotationsResult.success && allQuotationsResult.data) {
                            // Lọc tất cả báo giá của project này, kể cả đã chốt
                            quotationsToShow = allQuotationsResult.data.filter(q =>
                                q.project_id == projectId || q.project_id === parseInt(projectId)
                            );
                        }
                    } else if (currentQuotationId) {
                        // Nếu không có projectId nhưng có currentQuotationId, load theo quotation_code
                        const currentResponse = await fetch(`${API_BASE}/quotations/${currentQuotationId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const currentResult = await currentResponse.json();

                        if (currentResult.success && currentResult.data) {
                            const currentQuotation = currentResult.data;
                            const quotationCode = currentQuotation.quotation_code;

                            // Load tất cả quotations và lọc theo quotation_code
                            const allQuotationsResponse = await fetch(`${API_BASE}/quotations`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            const allQuotationsResult = await allQuotationsResponse.json();

                            if (allQuotationsResult.success && allQuotationsResult.data) {
                                // Lọc các báo giá có cùng quotation_code
                                quotationsToShow = allQuotationsResult.data.filter(q =>
                                    q.quotation_code === quotationCode
                                );
                            }
                        }
                    } else {
                        // Load tất cả nếu không có projectId và không có currentQuotationId
                        const allQuotationsResponse = await fetch(`${API_BASE}/quotations`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const allQuotationsResult = await allQuotationsResponse.json();

                        if (allQuotationsResult.success && allQuotationsResult.data) {
                            quotationsToShow = allQuotationsResult.data;
                        }
                    }

                    if (quotationsToShow.length > 0) {

                        if (quotationsToShow.length === 0) {
                            container.innerHTML = '<p class="text-center text-gray-500 py-8">Chưa có báo giá nào.</p>';
                            return;
                        }

                        // Sắp xếp theo thời gian tạo
                        const quotations = quotationsToShow.sort((a, b) =>
                            new Date(a.created_at) - new Date(b.created_at) // Sắp xếp từ cũ đến mới
                        );

                        // Không cần gán version number nữa vì chỉ có 1 báo giá duy nhất

                        // Load items for each quotation (items đã được include trong response)
                        const quotationsWithItems = quotations;

                        container.innerHTML = quotationsWithItems.map((q, index) => {
                            const statusColors = {
                                'draft': 'bg-gray-100 text-gray-800',
                                'sent': 'bg-blue-100 text-blue-800',
                                'revised': 'bg-yellow-100 text-yellow-800',
                                'approved': 'bg-green-100 text-green-800',
                                'contract_signed': 'bg-purple-100 text-purple-800',
                                'cancelled': 'bg-red-100 text-red-800'
                            };

                            const statusText = {
                                'draft': 'Bản nháp',
                                'sent': 'Đã gửi',
                                'revised': 'Đã sửa',
                                'approved': 'Báo giá đã chốt',
                                'contract_signed': 'Đã ký hợp đồng',
                                'cancelled': 'Đã hủy'
                            };

                            const date = q.quotation_date ? new Date(q.quotation_date).toLocaleDateString('vi-VN') : 'N/A';

                            // Format created date with time
                            let createdDateTime = 'N/A';
                            if (q.created_at) {
                                const createdDateObj = new Date(q.created_at);
                                const dateStr = createdDateObj.toLocaleDateString('vi-VN');
                                const timeStr = createdDateObj.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                                createdDateTime = `${dateStr} ${timeStr}`;
                            }

                            const isCurrent = q.id == currentQuotationId;

                            return `
                            <div class="border rounded-lg p-4 ${isCurrent ? 'bg-blue-50 border-blue-300' : 'bg-white'}">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-lg">${q.quotation_code || 'N/A'}</span>
                                            ${isCurrent ? '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded">Hiện tại</span>' : ''}
                                        </div>
                                        <div class="text-sm text-gray-600 mt-1">
                                            <div>Ngày tạo: <span class="font-medium">${createdDateTime}</span></div>
                                            <div class="mt-1">Ngày BG: <span class="font-medium">${date}</span></div>
                                        </div>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColors[q.status] || 'bg-gray-100 text-gray-800'}">
                                        ${statusText[q.status] || q.status}
                                    </span>
                                </div>
                                <div class="grid grid-cols-3 gap-4 mt-3 text-sm">
                                    <div>
                                        <span class="text-gray-600">Tổng tiền:</span>
                                        <span class="font-medium ml-2">${formatCurrency(q.total_amount || 0)}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Số hạng mục:</span>
                                        <span class="font-medium ml-2">${q.items ? q.items.length : 0}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Hiệu lực:</span>
                                        <span class="font-medium ml-2">${q.validity_days || 0} ngày</span>
                                    </div>
                                </div>
                                <div class="mt-3 flex gap-2">
                                    <button onclick="viewQuotationDetail(${q.id})" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                        Xem chi tiết
                                    </button>
                                    ${!isCurrent && (q.status !== 'approved' && q.status !== 'contract_signed') ? `
                                        <button onclick="window.location.href='quotation-new.html?id=${q.id}'" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                            Mở để chỉnh sửa
                                        </button>
                                    ` : ''}
                                    ${q.status === 'draft' ? `
                                        <button onclick="deleteQuotation(${q.id}, '${q.quotation_code || 'N/A'}', '${q.status}')" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700">
                                            Xóa
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                        }).join('');
                    } else {
                        container.innerHTML = '<p class="text-center text-gray-500 py-8">Chưa có phiên bản nào khác của báo giá này.</p>';
                    }
                } catch (error) {
                    console.error('Error loading quotation history:', error);
                    document.getElementById('quotationHistoryList').innerHTML =
                        '<p class="text-center text-red-500 py-8">Lỗi khi tải lịch sử báo giá.</p>';
                }
            }

            // Delete quotation
            async function deleteQuotation(quotationId, quotationCode, status) {
                // Kiểm tra status trước khi xóa - chỉ cho phép xóa báo giá ở trạng thái "Bản nháp" (draft)
                if (status && status !== 'draft') {
                    alert('Không thể xóa báo giá này!\n\nChỉ có thể xóa các báo giá ở trạng thái "Bản nháp".\nBáo giá này đã được chốt hoặc đang ở trạng thái khác.');
                    return;
                }

                // Nếu không có status từ tham số, load quotation để kiểm tra
                if (!status) {
                    try {
                        const token = localStorage.getItem('token');
                        const checkResponse = await fetch(`${API_BASE}/quotations/${quotationId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const checkResult = await checkResponse.json();

                        if (checkResult.success && checkResult.data.status !== 'draft') {
                            alert('Không thể xóa báo giá này!\n\nChỉ có thể xóa các báo giá ở trạng thái "Bản nháp".\nBáo giá này đã được chốt hoặc đang ở trạng thái khác.');
                            return;
                        }
                    } catch (error) {
                        console.error('Error checking quotation status:', error);
                        // Tiếp tục với việc xóa nếu không kiểm tra được
                    }
                }

                // Xác nhận trước khi xóa
                const confirmMessage = `Bạn có chắc chắn muốn xóa báo giá "${quotationCode}"?\n\nHành động này không thể hoàn tác và sẽ xóa hoàn toàn báo giá khỏi database.`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/quotations/${quotationId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Nếu xóa báo giá hiện tại, chuyển về trang mới
                        if (quotationId == currentQuotationId) {
                            alert('Đã xóa báo giá hiện tại. Bạn sẽ được chuyển về trang tạo báo giá mới.');
                            window.location.href = 'quotation-new.html';
                            return;
                        }

                        // Reload lại lịch sử báo giá
                        await loadQuotationHistory();

                        // Hiển thị thông báo thành công
                        showSuccessNotification('Đã xóa báo giá thành công!', `Báo giá "${quotationCode}" đã được xóa khỏi hệ thống.`);
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể xóa báo giá'));
                    }
                } catch (error) {
                    console.error('Error deleting quotation:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            // Export Excel
            async function exportExcel() {
                if (!currentQuotationId) {
                    alert('Vui lòng lưu báo giá trước khi xuất Excel!');
                    return;
                }
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/quotations/${currentQuotationId}/export-excel`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        // Download file
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const quoteCode = document.getElementById('quoteCode').textContent || 'VRBG001';
                        a.download = `Bao_gia_${quoteCode}_${new Date().toISOString().split('T')[0]}.xlsx`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        showSuccessNotification('Đã xuất file Excel thành công!');
                    } else {
                        const result = await response.json();
                        alert('Lỗi: ' + (result.message || 'Không thể xuất Excel'));
                    }
                } catch (error) {
                    console.error('Error exporting Excel:', error);
                    alert('Lỗi khi xuất Excel: ' + error.message);
                }
            }

            // Validate form
            function validateForm() {
                const customerId = document.getElementById('customerSelect').value;
                if (!customerId) {
                    alert('Vui lòng chọn khách hàng!');
                    return false;
                }
                if (items.length === 0) {
                    alert('Vui lòng thêm ít nhất một hạng mục!');
                    return false;
                }
                // Validate items
                for (const item of items) {
                    if (item.width <= 0 || item.height <= 0) {
                        alert(`Hạng mục ${item.code}: Kích thước phải lớn hơn 0!`);
                        return false;
                    }
                    if (item.quantity < 1) {
                        alert(`Hạng mục ${item.code}: Số bộ phải >= 1!`);
                        return false;
                    }
                    if (item.unitPrice < 0) {
                        alert(`Hạng mục ${item.code}: Đơn giá không được âm!`);
                        return false;
                    }
                }
                return true;
            }

            // Prepare quotation data
            function prepareQuotationData() {
                // Tính tổng tiền
                let subtotal = 0;
                items.forEach(item => {
                    subtotal += item.total || 0;
                });

                const discountPercent = parseFloat(document.getElementById('discountPercent')?.value || 0);
                const discountAmount = subtotal * (discountPercent / 100);
                const afterDiscount = subtotal - discountAmount;

                const vatPercent = parseFloat(document.getElementById('vatPercent')?.value || 10);
                const vatAmount = afterDiscount * (vatPercent / 100);

                const shippingFee = parseFloat(document.getElementById('shippingFee')?.value || 0);
                const totalAmount = afterDiscount + vatAmount + shippingFee;

                const data = {
                    customer_id: parseInt(document.getElementById('customerSelect').value),
                    project_id: document.getElementById('projectSelect').value ? parseInt(document.getElementById('projectSelect').value) : null,
                    quotation_date: document.getElementById('quoteDate').value,
                    validity_days: parseInt(document.getElementById('validityDays').value) || 15,
                    notes: document.getElementById('quoteNotes').value,
                    creator_name: document.getElementById('quoteCreator').value,
                    discount_percent: discountPercent,
                    vat_percent: vatPercent,
                    shipping_fee: shippingFee,
                    total_amount: totalAmount,
                    items: items.map(item => ({
                        item_name: item.spec || item.design || item.code, // Quy cách (spec) là cột chính
                        quantity: item.quantity,
                        unit: 'bộ',
                        unit_price: item.unitPrice,
                        total_price: item.total,
                        item_type: 'material',
                        code: item.code,
                        width: item.width,
                        height: item.height,
                        area: item.area,
                        spec: item.spec,
                        glass: item.glass,
                        accessories: item.accessories,
                        accessory_price: item.accessoryPrice
                    }))
                };

                // Gửi mã báo giá - ưu tiên giữ mã gốc khi tạo version mới
                // 1. Nếu đang tạo version mới, sử dụng mã gốc từ V1
                if (parentQuotationId && window.originalQuoteCode) {
                    data.quotation_code = window.originalQuoteCode;
                }
                // 2. Nếu người dùng đã nhập mã (và không phải readonly/version mode)
                else {
                    const codeInput = document.getElementById('quoteCodeInput');
                    const userEnteredCode = codeInput.value.trim();
                    if (userEnteredCode && !codeInput.readOnly) {
                        data.quotation_code = userEnteredCode;
                    }
                    // 3. Nếu đang cập nhật quotation hiện có, giữ nguyên mã cũ
                    else if (currentQuotationId) {
                        const existingCode = document.getElementById('quoteCode').textContent.trim();
                        if (existingCode && existingCode !== '---' && existingCode !== '' && existingCode !== 'Draft') {
                            data.quotation_code = existingCode;
                        }
                    }
                }

                // Nếu đang tạo version mới từ V1, thêm parent_quotation_id và version
                if (parentQuotationId && !currentQuotationId) {
                    data.parent_quotation_id = parentQuotationId;
                    data.version = currentVersion;
                }

                console.log('Prepared quotation data:', data);
                console.log('Items being sent:', items);
                console.log('Sample item (first):', items[0]);
                return data;
            }

            // Save quotation to server
            // Logic: Chỉ tạo mới khi chưa có quotation, còn lại luôn update báo giá hiện có
            async function saveQuotationToServer(data) {
                try {
                    const token = localStorage.getItem('token');

                    let url, method;

                    if (!currentQuotationId) {
                        // Lần đầu lưu - tạo V1
                        url = `${API_BASE}/quotations`;
                        method = 'POST';
                        data.version = 1;
                        currentVersion = 1;
                    } else {
                        // LUÔN cập nhật báo giá hiện có - không tạo version mới
                        // Giữ nguyên mã BG, version, và tất cả thông tin
                        url = `${API_BASE}/quotations/${currentQuotationId}`;
                        method = 'PUT';
                        // Giữ nguyên quotation_code - không xóa để update đúng báo giá
                        // Backend sẽ giữ nguyên quotation_code khi update
                        // KHÔNG tạo version mới, chỉ update báo giá hiện có
                    }

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    if (result.success) {
                        if (result.data && result.data.id) {
                            currentQuotationId = result.data.id;

                            // Cập nhật URL với id mới
                            const newUrl = new URL(window.location.href);
                            newUrl.searchParams.set('id', currentQuotationId);
                            window.history.replaceState({}, '', newUrl.toString());
                        }
                        if (result.data && result.data.quotation_code) {
                            const code = result.data.quotation_code;
                            document.getElementById('quoteCode').textContent = code;
                            document.getElementById('quoteCodeInput').value = code;
                        }

                        // Không cần hiển thị version nữa vì chỉ có 1 báo giá duy nhất

                        // Update status display - ưu tiên lấy từ response, nếu không có thì dùng từ data
                        const statusToDisplay = result.data?.status || data.status;
                        if (statusToDisplay) {
                            document.getElementById('quoteStatus').textContent = getStatusText(statusToDisplay);
                        }

                        // Show reset button if quotation is saved and has project_id
                        if (currentQuotationId && data.project_id) {
                            document.getElementById('resetBtn').classList.remove('hidden');
                        }

                        // Khi update (PUT), reset parentQuotationId về null để đảm bảo luôn update, không tạo mới
                        if (method === 'PUT') {
                            parentQuotationId = null; // Đảm bảo lần sau vẫn update, không tạo version mới
                        } else if (method === 'POST' && parentQuotationId) {
                            // Chỉ khi tạo mới và có parentQuotationId (trường hợp đặc biệt)
                            parentQuotationId = data.parent_quotation_id;
                        }

                        showSuccessNotification('Đã lưu báo giá thành công!');
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể lưu báo giá'));
                    }
                } catch (error) {
                    console.error('Error saving quotation:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            // Load quotation
            async function loadQuotation(id) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/quotations/${id}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result.success) {
                        const q = result.data;
                        currentQuotationId = q.id;

                        // Đảm bảo dropdowns đã được load trước khi set value
                        await loadCustomers();

                        // Lưu project_id để set lại sau khi load projects
                        const savedProjectId = q.project_id;

                        // Set customer value
                        if (q.customer_id) {
                            document.getElementById('customerSelect').value = q.customer_id;
                            // Load projects của customer này và giữ lại project_id nếu có
                            await loadProjectsByCustomer(q.customer_id, savedProjectId);
                        } else {
                            // Nếu không có customer_id, load tất cả projects
                            await loadProjects();
                        }

                        // QUAN TRỌNG: Đảm bảo project_id được set vào dropdown với text đầy đủ (mã + tên)
                        const projectSelect = document.getElementById('projectSelect');
                        if (savedProjectId) {
                            // Tìm option hiện tại (nếu có)
                            const existingOption = Array.from(projectSelect.options).find(opt => opt.value == savedProjectId);

                            // Luôn load thông tin project để đảm bảo có text đầy đủ
                            try {
                                const projectResponse = await fetch(`${API_BASE}/projects/${savedProjectId}`, {
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                const projectResult = await projectResponse.json();

                                if (projectResult.success && projectResult.data) {
                                    const project = projectResult.data;
                                    const fullText = `${project.project_code || ''} - ${project.project_name || 'Dự án ID: ' + savedProjectId}`.trim();

                                    if (existingOption) {
                                        // Cập nhật text của option hiện tại
                                        existingOption.textContent = fullText;
                                        projectSelect.value = savedProjectId;
                                    } else {
                                        // Thêm option mới với text đầy đủ
                                        const option = document.createElement('option');
                                        option.value = savedProjectId;
                                        option.textContent = fullText;
                                        projectSelect.appendChild(option);
                                        projectSelect.value = savedProjectId;
                                    }
                                } else {
                                    // Nếu không load được project, vẫn cập nhật option hiện tại hoặc tạo mới
                                    if (existingOption) {
                                        // Giữ nguyên text nếu đã có, hoặc set text mặc định
                                        if (!existingOption.textContent || existingOption.textContent.includes('Dự án ID:')) {
                                            existingOption.textContent = `Dự án ID: ${savedProjectId}`;
                                        }
                                        projectSelect.value = savedProjectId;
                                    } else {
                                        const option = document.createElement('option');
                                        option.value = savedProjectId;
                                        option.textContent = `Dự án ID: ${savedProjectId}`;
                                        projectSelect.appendChild(option);
                                        projectSelect.value = savedProjectId;
                                    }
                                }
                            } catch (projectError) {
                                console.error('Error loading project info:', projectError);
                                // Fallback: sử dụng option hiện tại hoặc tạo mới
                                if (existingOption) {
                                    projectSelect.value = savedProjectId;
                                } else {
                                    const option = document.createElement('option');
                                    option.value = savedProjectId;
                                    option.textContent = `Dự án ID: ${savedProjectId}`;
                                    projectSelect.appendChild(option);
                                    projectSelect.value = savedProjectId;
                                }
                            }
                        }

                        // QUAN TRỌNG: Đảm bảo dropdown luôn được enable và có thể tương tác
                        // (đặc biệt khi status là 'approved' để có thể chọn dự án và chốt hợp đồng)
                        projectSelect.disabled = false;
                        projectSelect.style.pointerEvents = 'auto';
                        projectSelect.style.opacity = '1';
                        projectSelect.style.cursor = 'pointer';

                        // Đảm bảo onchange event vẫn hoạt động
                        if (!projectSelect.onchange) {
                            projectSelect.onchange = loadProjectInfo;
                        }

                        console.log('Project select enabled:', {
                            disabled: projectSelect.disabled,
                            pointerEvents: projectSelect.style.pointerEvents,
                            opacity: projectSelect.style.opacity,
                            value: projectSelect.value,
                            hasOnchange: !!projectSelect.onchange
                        });

                        if (q.quotation_date) {
                            document.getElementById('quoteDate').value = q.quotation_date.split('T')[0];
                        }
                        document.getElementById('validityDays').value = q.validity_days || 15;
                        document.getElementById('quoteNotes').value = q.notes || '';
                        const quoteCode = q.quotation_code || '';
                        document.getElementById('quoteCode').textContent = quoteCode;
                        document.getElementById('quoteCodeInput').value = quoteCode;
                        document.getElementById('quoteStatus').textContent = getStatusText(q.status);

                        // ✅ CRITICAL: Load VAT, discount, shipping values from API response
                        // This fixes the bug where these values were not saved
                        const discountPercentEl = document.getElementById('discountPercent');
                        const discountPercentBothEl = document.getElementById('discountPercentBoth');
                        const vatPercentEl = document.getElementById('vatPercent');
                        const vatPercentBothEl = document.getElementById('vatPercentBoth');
                        const shippingFeeEl = document.getElementById('shippingFee');
                        const shippingFeeBothEl = document.getElementById('shippingFeeBoth');

                        // Set discount percent (default 0)
                        const loadedDiscount = parseFloat(q.discount_percent) || 0;
                        if (discountPercentEl) discountPercentEl.value = loadedDiscount;
                        if (discountPercentBothEl) discountPercentBothEl.value = loadedDiscount;

                        // Set VAT percent (default 10)
                        const loadedVat = (q.vat_percent !== undefined && q.vat_percent !== null) ? parseFloat(q.vat_percent) : 10;
                        if (vatPercentEl) vatPercentEl.value = loadedVat;
                        if (vatPercentBothEl) vatPercentBothEl.value = loadedVat;

                        // Set shipping fee (default 0)
                        const loadedShipping = parseFloat(q.shipping_fee) || 0;
                        if (shippingFeeEl) shippingFeeEl.value = loadedShipping;
                        if (shippingFeeBothEl) shippingFeeBothEl.value = loadedShipping;

                        console.log('Loaded VAT/discount from API:', {
                            discount_percent: loadedDiscount,
                            vat_percent: loadedVat,
                            shipping_fee: loadedShipping
                        });

                        // Không cần hiển thị version nữa vì chỉ có 1 báo giá duy nhất

                        // Lưu parent_quotation_id nếu có (chỉ khi thực sự có parent)
                        // Nếu không có parent, reset về null để không tạo version mới khi lưu
                        if (q.parent_quotation_id) {
                            parentQuotationId = q.parent_quotation_id;
                        } else {
                            parentQuotationId = null; // Đảm bảo không tạo version mới khi lưu
                        }

                        // Show/hide buttons based on status
                        if (q.status === 'approved') {
                            // ✅ CRITICAL FIX: Hiện nút "Chốt hợp đồng" ở 2 vị trí:
                            // 1. Ở header (nút cũ)
                            const signContractBtn = document.getElementById('signContractBtn');
                            if (signContractBtn) {
                                signContractBtn.classList.remove('hidden');
                            }
                            // 2. Cạnh dropdown Dự án (nút mới - ưu tiên)
                            const signContractBtnNextToProject = document.getElementById('signContractBtnNextToProject');
                            if (signContractBtnNextToProject) {
                                signContractBtnNextToProject.classList.remove('hidden');
                            }
                            document.getElementById('approveBtn').classList.add('hidden');
                            document.getElementById('resetBtn').classList.remove('hidden');
                            // Ẩn các nút không cần thiết
                            const sendBtn = document.getElementById('sendQuotationBtn');
                            if (sendBtn) sendBtn.classList.add('hidden');
                            const cancelBtn = document.getElementById('cancelBtn');
                            if (cancelBtn) cancelBtn.classList.add('hidden');
                            // Hiển thị thông báo "Đã chốt báo giá" (màu vàng/amber)
                            showStatusNotification('approved');
                            isLocked = true;
                            // QUAN TRỌNG: KHÔNG lock form - vẫn có thể xem và chỉnh sửa một số trường
                            // Đảm bảo body không có class 'locked' để không block pointer-events
                            document.body.classList.remove('locked');
                            // QUAN TRỌNG: Luôn cho phép chọn dự án khi approved để có thể chốt hợp đồng
                            // (kể cả đã có project_id, vẫn cho phép thay đổi nếu cần)
                            const projectSelect = document.getElementById('projectSelect');
                            const customerSelect = document.getElementById('customerSelect');

                            // Enable các dropdown
                            projectSelect.disabled = false;
                            customerSelect.disabled = false;

                            // Đảm bảo dropdown có thể tương tác được - fix mạnh mẽ hơn
                            projectSelect.style.pointerEvents = 'auto';
                            projectSelect.style.opacity = '1';
                            projectSelect.style.cursor = 'pointer';
                            projectSelect.style.position = 'relative';
                            projectSelect.style.zIndex = '100';

                            customerSelect.style.pointerEvents = 'auto';
                            customerSelect.style.opacity = '1';
                            customerSelect.style.cursor = 'pointer';

                            // Đảm bảo tất cả parent elements không block pointer-events
                            let parentElement = projectSelect.parentElement;
                            while (parentElement && parentElement !== document.body) {
                                parentElement.classList.remove('locked');
                                parentElement.style.pointerEvents = 'auto';
                                parentElement = parentElement.parentElement;
                            }

                            // Re-attach event listener để đảm bảo hoạt động
                            projectSelect.onchange = function () {
                                loadProjectInfo();
                            };
                            customerSelect.onchange = function () {
                                loadCustomerInfo();
                            };
                        } else if (q.status === 'contract_signed') {
                            document.getElementById('signContractBtn').classList.add('hidden');
                            // Ẩn nút cạnh dropdown Dự án
                            const signContractBtnNextToProject = document.getElementById('signContractBtnNextToProject');
                            if (signContractBtnNextToProject) {
                                signContractBtnNextToProject.classList.add('hidden');
                            }
                            document.getElementById('approveBtn').classList.add('hidden');
                            document.getElementById('resetBtn').classList.add('hidden');
                            // Ẩn các nút không cần thiết
                            const sendBtn = document.getElementById('sendQuotationBtn');
                            if (sendBtn) sendBtn.classList.add('hidden');
                            const cancelBtn = document.getElementById('cancelBtn');
                            if (cancelBtn) cancelBtn.classList.add('hidden');
                            // Hiển thị thông báo "Đã chốt hợp đồng thành công" (màu xanh lá/emerald)
                            showStatusNotification('contract_signed');
                            isLocked = true;
                            // KHÔNG lock form - vẫn có thể xem bình thường
                        } else {
                            // Ẩn thông báo nếu chưa chốt
                            hideAllStatusNotifications();
                            if (currentQuotationId) {
                                // Show reset button if quotation exists and has project_id
                                if (q.project_id) {
                                    document.getElementById('resetBtn').classList.remove('hidden');
                                }
                                // Hiển thị nút "Hủy báo giá" nếu chưa chốt
                                const cancelBtn = document.getElementById('cancelBtn');
                                if (cancelBtn) cancelBtn.classList.remove('hidden');
                            }
                        }

                        if (q.items && q.items.length > 0) {
                            items = q.items.map((item, index) => ({
                                id: index + 1,
                                stt: index + 1,
                                code: item.code || `C${String(index + 1).padStart(2, '0')}`,
                                design: item.item_name || '',
                                spec: item.spec || '',
                                glass: item.glass || '',
                                accessories: item.accessories || '',
                                width: item.width || 0,
                                height: item.height || 0,
                                area: item.area || 0,
                                quantity: item.quantity || 1,
                                unitPrice: item.unit_price || 0,
                                accessoryPrice: item.accessory_price || 0,
                                total: item.total_price || 0
                            }));
                            itemCounter = items.length;

                            // Load discount, VAT, shipping fee từ database
                            if (q.discount_percent !== undefined) {
                                document.getElementById('discountPercent').value = q.discount_percent;
                                if (document.getElementById('discountPercentBoth')) {
                                    document.getElementById('discountPercentBoth').value = q.discount_percent;
                                }
                            }
                            if (q.vat_percent !== undefined) {
                                document.getElementById('vatPercent').value = q.vat_percent;
                                if (document.getElementById('vatPercentBoth')) {
                                    document.getElementById('vatPercentBoth').value = q.vat_percent;
                                }
                            }
                            if (q.shipping_fee !== undefined) {
                                document.getElementById('shippingFee').value = q.shipping_fee;
                                if (document.getElementById('shippingFeeBoth')) {
                                    document.getElementById('shippingFeeBoth').value = q.shipping_fee;
                                }
                            }

                            renderItemsTable();
                            calculateTotals();
                        }

                        // Load customer and project info if they exist
                        if (q.customer_id) {
                            await loadCustomerInfo();
                        }
                        if (q.project_id) {
                            await loadProjectInfo();
                        }

                        // Đảm bảo tính toán lại totals sau khi load
                        calculateTotals();
                    }
                } catch (error) {
                    console.error('Error loading quotation:', error);
                }
            }

            // Lock form
            function lockForm() {
                document.body.classList.add('locked');
                document.querySelectorAll('input, select, textarea, button').forEach(el => {
                    if (!el.classList.contains('unlock-btn')) {
                        el.disabled = true;
                    }
                });
            }

            function unlockForm() {
                document.body.classList.remove('locked');
                document.querySelectorAll('input, select, textarea, button').forEach(el => {
                    el.disabled = false;
                });
                // Ensure customer and project selects are enabled for new quotation
                document.getElementById('customerSelect').disabled = false;
                document.getElementById('projectSelect').disabled = false;
            }

            // Hiển thị thông báo theo trạng thái
            function showStatusNotification(status) {
                // Ẩn tất cả thông báo trước
                hideAllStatusNotifications();

                if (status === 'approved') {
                    const notification = document.getElementById('approvedNotification');
                    if (notification) {
                        notification.classList.remove('hidden');
                    }
                } else if (status === 'contract_signed') {
                    const notification = document.getElementById('contractSignedNotification');
                    if (notification) {
                        notification.classList.remove('hidden');
                    }
                }
            }

            // Ẩn tất cả thông báo trạng thái
            function hideAllStatusNotifications() {
                const approvedNotification = document.getElementById('approvedNotification');
                const contractSignedNotification = document.getElementById('contractSignedNotification');

                if (approvedNotification) {
                    approvedNotification.classList.add('hidden');
                }
                if (contractSignedNotification) {
                    contractSignedNotification.classList.add('hidden');
                }
            }

            // Legacy functions (giữ lại để tương thích)
            function showApprovedNotification() {
                showStatusNotification('approved');
            }

            function hideApprovedNotification() {
                hideAllStatusNotifications();
            }

            // Format currency
            function formatCurrency(amount) {
                if (!amount) return '0 đ';
                return new Intl.NumberFormat('vi-VN').format(amount) + ' đ';
            }

            // Format number with comma separators (for input display)
            function formatNumberWithComma(value) {
                if (!value && value !== 0) return '';
                // Parse số trước, xử lý cả số dạng string từ database (ví dụ: "3022000.00")
                let num = parseFloat(value);
                if (isNaN(num)) return '';
                // Chỉ lấy phần nguyên (loại bỏ phần thập phân .00)
                num = Math.round(num);
                return new Intl.NumberFormat('vi-VN').format(num);
            }

            // Parse formatted number back to raw number
            function parseFormattedNumber(formattedValue) {
                if (!formattedValue) return 0;
                // Nếu đã là số, trả về luôn
                if (typeof formattedValue === 'number') return formattedValue;
                // Xử lý chuỗi: Loại bỏ dấu phân cách nghìn (dấu chấm hoặc dấu phẩy tùy locale)
                // Trong tiếng Việt, dấu chấm là phân cách nghìn, dấu phẩy là thập phân
                // Nhưng database thường dùng dấu chấm cho thập phân
                const str = String(formattedValue);
                // Nếu có dấu chấm ở cuối (ví dụ: 3022000.00), đây là số thập phân từ database
                if (/^\d+\.\d+$/.test(str)) {
                    return parseFloat(str);
                }
                // Nếu có dấu chấm làm phân cách nghìn (ví dụ: 3.022.000), loại bỏ
                const num = parseFloat(str.replace(/\./g, '').replace(/,/g, ''));
                return isNaN(num) ? 0 : num;
            }

            // Handle price input formatting - CHỈ CHO NHẬP SỐ, KHÔNG FORMAT KHI ĐANG NHẬP
            function handlePriceInput(input, itemId, field) {
                // Chỉ cho phép nhập số, không format ngay
                // Loại bỏ tất cả ký tự không phải số
                let value = input.value.replace(/[^\d]/g, '');

                // Cập nhật lại input với chỉ số
                input.value = value;

                // Parse thành số và update item
                const rawValue = parseInt(value) || 0;
                updateItem(itemId, field, rawValue);

                // Recalculate
                calculateItemTotal(itemId);
            }

            // Format price input on blur - CHỈ FORMAT KHI MẤT FOCUS
            function formatPriceOnBlur(input) {
                // Parse giá trị thô
                const rawValue = parseInt(input.value.replace(/[^\d]/g, '')) || 0;
                // Format lại với dấu phân cách
                input.value = formatNumberWithComma(rawValue);
            }

            // Number to words (Vietnamese)
            function numberToWords(num) {
                if (!num || num === 0) return 'Không đồng';

                num = Math.floor(num); // Chỉ lấy phần nguyên

                const ones = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
                const tens = ['', 'mười', 'hai mươi', 'ba mươi', 'bốn mươi', 'năm mươi', 'sáu mươi', 'bảy mươi', 'tám mươi', 'chín mươi'];
                const hundreds = ['', 'một trăm', 'hai trăm', 'ba trăm', 'bốn trăm', 'năm trăm', 'sáu trăm', 'bảy trăm', 'tám trăm', 'chín trăm'];

                function readThreeDigits(n) {
                    if (n === 0) return '';
                    let result = '';
                    const hundred = Math.floor(n / 100);
                    const remainder = n % 100;
                    const ten = Math.floor(remainder / 10);
                    const one = remainder % 10;

                    if (hundred > 0) {
                        result += hundreds[hundred] + ' ';
                    }

                    if (remainder === 0) {
                        return result.trim();
                    }

                    if (ten === 0) {
                        if (one === 5) result += 'lăm';
                        else if (one > 0) result += ones[one];
                    } else if (ten === 1) {
                        if (one === 0) result += 'mười';
                        else if (one === 5) result += 'mười lăm';
                        else result += 'mười ' + ones[one];
                    } else {
                        result += tens[ten];
                        if (one === 1) result += ' mốt';
                        else if (one === 5) result += ' lăm';
                        else if (one > 0) result += ' ' + ones[one];
                    }

                    return result.trim();
                }

                if (num < 1000) {
                    return readThreeDigits(num).charAt(0).toUpperCase() + readThreeDigits(num).slice(1) + ' đồng';
                }

                const billions = Math.floor(num / 1000000000);
                const millions = Math.floor((num % 1000000000) / 1000000);
                const thousands = Math.floor((num % 1000000) / 1000);
                const units = num % 1000;

                let result = '';

                if (billions > 0) {
                    result += readThreeDigits(billions) + ' tỷ ';
                }

                if (millions > 0) {
                    result += readThreeDigits(millions) + ' triệu ';
                }

                if (thousands > 0) {
                    result += readThreeDigits(thousands) + ' nghìn ';
                }

                if (units > 0) {
                    result += readThreeDigits(units);
                }

                if (result === '') return 'Không đồng';

                // Viết hoa chữ cái đầu
                result = result.trim();
                result = result.charAt(0).toUpperCase() + result.slice(1);
                result += ' đồng';

                return result;
            }

            // Get status text
            function getStatusText(status) {
                const statusMap = {
                    'draft': 'Bản nháp',
                    'sent': 'Đã gửi',
                    'revised': 'Đã sửa đổi',
                    'approved': 'Báo giá đã chốt',
                    'contract_signed': 'Đã ký hợp đồng',
                    'cancelled': 'Đã hủy'
                };
                return statusMap[status] || status;
            }
        </script>
    </div>
    <!-- End Main Content -->
    <script src="js/sidebar-enterprise.js"></script>
    <script src="js/success-notification.js"></script>
    <script src="js/notification-system.js"></script>
    <script src="js/notification-header.js"></script>
</body>

</html>