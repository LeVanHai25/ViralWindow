<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thiết kế & Bóc tách - ViralWindow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/sidebar-enterprise.css">
    <link rel="stylesheet" href="css/notification-system.css">
    <link rel="stylesheet" href="css/notification-header.css">
    <link rel="stylesheet" href="css/success-notification.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            z-index: 1000;
            border-left: 3px solid #60a5fa;
        }

        .main-content {
            margin-left: 260px;
            background: #f3f4f6;
            min-height: 100vh;
        }

        .step-indicator {
            transition: all 0.3s ease;
        }

        .step-indicator.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .step-indicator.completed {
            background: #10b981;
            color: white;
        }

        .step-indicator.available {
            background: #e0e7ff;
            color: #4f46e5;
            border: 2px solid #818cf8;
        }

        .step-indicator.available:hover {
            background: #c7d2fe;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.3);
        }

        .category-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .item-card {
            transition: all 0.3s ease;
        }

        .item-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>

    <!-- Header Notification (Top Right) -->
    <div class="header-notification-container">
        <button id="headerNotificationButton" class="header-notification-button" onclick="toggleHeaderNotifications()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <span id="headerNotificationBadge" class="header-notification-badge hidden">0</span>
        </button>

        <div id="headerNotificationsDropdown" class="header-notifications-dropdown">
            <div class="header-notifications-header">
                <h3>Thông báo</h3>
            </div>
            <div id="headerNotificationsList" class="header-notifications-list">
                <!-- Notifications will be loaded here -->
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar text-white">
        <!-- Logo -->
        <a href="settings.html" class="sidebar-logo block">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-400 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0"
                    id="companyLogoContainer">
                    <img id="companyLogo" src="" alt="Logo" class="hidden w-full h-full object-contain">
                    <svg id="companyLogoIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" class="w-6 h-6 text-white">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <span class="text-xl font-bold" id="companyName">ViralWindow</span>
            </div>
        </a>

        <!-- User Profile -->
        <div class="p-4 border-b border-blue-600 relative">
            <div class="flex items-center gap-3 cursor-pointer hover:bg-blue-700 rounded-lg p-2"
                onclick="toggleSidebarUserMenu()">
                <div class="w-10 h-10 bg-blue-400 rounded-full flex items-center justify-center font-semibold overflow-hidden"
                    id="sidebarUserAvatar">
                    <div id="sidebarUserAvatarInitial">U</div>
                    <img id="sidebarUserAvatarImage" src="" alt="Avatar"
                        class="hidden w-full h-full object-cover rounded-full">
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-sm" id="sidebarUserName">Lê Văn Hải</div>
                    <div class="text-xs text-blue-200">Quản lý</div>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <!-- User Menu Dropdown -->
            <div id="sidebarUserMenuDropdown"
                class="hidden absolute left-0 right-0 mt-2 bg-white rounded-lg shadow-xl z-[9999] border border-gray-200">
                <div class="p-2">
                    <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">Hồ
                        sơ</a>
                    <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">Cài
                        đặt</a>
                    <hr class="my-2">
                    <button onclick="handleLogout()"
                        class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 rounded">Đăng
                        xuất</button>
                </div>
            </div>
        </div>


        <!-- Navigation Menu -->
        <nav class="sidebar-nav">
            <!-- TỔNG QUAN -->
            <a href="index.html" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span>TỔNG QUAN</span>
            </a>

            <!-- KINH DOANH -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span>KINH DOANH</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="sales.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span>Khách hàng & Dự án</span>
                </a>
                <a href="quotation-new.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Báo giá</span>
                </a>
            </div>

            <!-- KỸ THUẬT -->
            <div class="nav-item has-submenu expanded">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>KỸ THUẬT</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu expanded">
                <a href="design-new.html" class="submenu-item active">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                    <span>Thiết kế & Bóc tách</span>
                </a>
                <a href="material-requests.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Yêu cầu vật tư</span>
                </a>
            </div>

            <!-- SẢN XUẤT -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                    </svg>
                    <span>SẢN XUẤT</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="production.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                    <span>Quy trình sản xuất</span>
                </a>
                <a href="production-management.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Lệnh sản xuất</span>
                </a>
            </div>

            <!-- KHO & VẬT TƯ -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    <span>KHO & VẬT TƯ</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="inventory.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    <span>Kho vật tư</span>
                </a>
                <a href="exported-materials.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                    <span>Xuất vật tư</span>
                </a>
            </div>

            <!-- THI CÔNG & NGHIỆM THU -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>THI CÔNG & NGHIỆM THU</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="installation.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>Lắp đặt</span>
                </a>
                <a href="handover.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    <span>Bàn giao</span>
                </a>
            </div>

            <!-- TÀI CHÍNH -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>TÀI CHÍNH</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="finance-dashboard.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span>Tài chính</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <!-- Top Header Bar -->
        <div class="bg-white border-b border-gray-200 px-6 py-4">
            <div>
                <h1 class="text-2xl font-semibold text-gray-800">Thiết kế & Bóc tách</h1>
                <p class="text-sm text-gray-500 mt-1">Thiết kế hạng mục nhôm kính và tự động bóc tách vật tư</p>
            </div>
        </div>

        <!-- Workflow Steps -->
        <div class="bg-white border-b border-gray-200 px-6 pb-4">
            <div class="flex items-center gap-4 overflow-x-auto pt-4">
                <div class="step-indicator active flex items-center gap-2 px-4 py-2 rounded-lg font-medium whitespace-nowrap cursor-pointer transition-all duration-300 hover:shadow-md"
                    id="step1" onclick="goToStep(1)">
                    <div
                        class="w-6 h-6 rounded-full bg-white text-purple-600 flex items-center justify-center font-bold text-sm">
                        1</div>
                    <span>Chọn Dự án</span>
                </div>
                <div class="w-8 h-0.5 bg-gray-300"></div>
                <div class="step-indicator flex items-center gap-2 px-4 py-2 rounded-lg font-medium whitespace-nowrap bg-gray-100 text-gray-600 cursor-pointer transition-all duration-300 hover:shadow-md hover:bg-gray-200"
                    id="step2" onclick="handleStepClick(2)">
                    <div
                        class="w-6 h-6 rounded-full bg-white text-gray-600 flex items-center justify-center font-bold text-sm">
                        2</div>
                    <span>Danh sách sản phẩm</span>
                </div>
                <div class="w-8 h-0.5 bg-gray-300"></div>
                <div class="step-indicator flex items-center gap-2 px-4 py-2 rounded-lg font-medium whitespace-nowrap bg-gray-100 text-gray-600 cursor-pointer transition-all duration-300 hover:shadow-md hover:bg-gray-200"
                    id="step3" onclick="handleStepClick(3)">
                    <div
                        class="w-6 h-6 rounded-full bg-white text-gray-600 flex items-center justify-center font-bold text-sm">
                        3</div>
                    <span>Bóc tách Vật tư</span>
                </div>
                <div class="w-8 h-0.5 bg-gray-300"></div>
                <div class="step-indicator flex items-center gap-2 px-4 py-2 rounded-lg font-medium whitespace-nowrap bg-gray-100 text-gray-600 cursor-pointer transition-all duration-300 hover:shadow-md hover:bg-gray-200"
                    id="step4" onclick="handleStepClick(4)">
                    <div
                        class="w-6 h-6 rounded-full bg-white text-gray-600 flex items-center justify-center font-bold text-sm">
                        4</div>
                    <span>Kiểm tra Kho</span>
                </div>
            </div>
        </div>

        <!-- DASHBOARD OVERVIEW (Hidden by default, shown when project selected) -->
        <div class="p-6">
            <!-- STEP 1: Chọn Dự án -->
            <div id="step1Content" class="step-content">

                <!-- Search and Filter Section -->
                <div class="bg-white rounded-xl shadow p-6 mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                        <div class="flex-1 min-w-[300px]">
                            <div class="relative">
                                <input type="text" id="projectSearch"
                                    placeholder="Tìm kiếm theo tên dự án, mã dự án, khách hàng..."
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    onkeyup="filterProjects()">
                                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <select id="projectStatusFilter" onchange="filterProjects()"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                <option value="all">Tất cả trạng thái</option>
                                <option value="new">Mới tạo</option>
                                <option value="designing">Đang thiết kế</option>
                                <option value="boc_tach">Đang bóc tách</option>
                            </select>
                            <select id="projectCustomerFilter" onchange="filterProjects()"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                <option value="all">Tất cả khách hàng</option>
                            </select>
                            <select id="projectSortBy" onchange="sortProjects()"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                <option value="name">Sắp xếp: Tên A-Z</option>
                                <option value="name_desc">Sắp xếp: Tên Z-A</option>
                                <option value="date">Sắp xếp: Mới nhất</option>
                                <option value="date_old">Sắp xếp: Cũ nhất</option>
                                <option value="deadline">Sắp xếp: Deadline gần</option>
                                <option value="progress">Sắp xếp: Tiến độ cao</option>
                            </select>
                            <div class="flex items-center gap-1 border border-gray-300 rounded-lg overflow-hidden">
                                <button onclick="setViewMode('grid')" id="viewGridBtn"
                                    class="px-3 py-2 bg-purple-600 text-white hover:bg-purple-700 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                    </svg>
                                </button>
                                <button onclick="setViewMode('list')" id="viewListBtn"
                                    class="px-3 py-2 bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6h16M4 12h16M4 18h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Projects Grid View -->
                <div id="projectsGridView" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Projects will be loaded here -->
                </div>

                <!-- Projects List View -->
                <div id="projectsListView" class="hidden space-y-4">
                    <!-- Projects will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="projectsEmptyState" class="hidden text-center py-16 bg-white rounded-xl shadow">
                    <svg class="w-24 h-24 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Không tìm thấy dự án</h3>
                    <p class="text-gray-500 mb-4">Thử thay đổi bộ lọc hoặc từ khóa tìm kiếm</p>
                    <button onclick="clearFilters()"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        Xóa bộ lọc
                    </button>
                </div>
            </div>

            <!-- STEP 2: Danh sách Sản phẩm -->
            <div id="step2Content" class="step-content hidden">
                <div class="bg-white rounded-xl shadow p-6 mb-6">
                    <!-- Project Info Card -->
                    <div
                        class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Tên dự án</p>
                                <p class="font-semibold text-gray-900" id="step2ProjectName">--</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Khách hàng</p>
                                <p class="font-semibold text-gray-900" id="step2Customer">--</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Địa điểm</p>
                                <p class="font-semibold text-gray-900" id="step2Location">--</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Ngày tạo</p>
                                <p class="font-semibold text-gray-900" id="step2CreatedDate">--</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Ngày giao</p>
                                <p class="font-semibold text-gray-900" id="step2DeliveryDate">--</p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-3 mb-6">
                        <button onclick="openAddProductModal()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            Thêm sản phẩm
                        </button>
                        <button onclick="openDesignUpload()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            📄 Upload Bản thiết kế
                        </button>
                        <button onclick="exportProductListExcel()"
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            📊 Xuất Excel
                        </button>
                        <!-- Design files display -->
                        <div id="designFilesList" class="flex flex-wrap gap-2 items-center"></div>
                    </div>

                    <!-- Products Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white rounded-lg overflow-hidden">
                            <thead class="bg-gradient-to-r from-purple-600 to-blue-600 text-white">
                                <tr>
                                    <th class="px-2 py-3 text-center font-medium" style="width:4%;">STT</th>
                                    <th class="px-2 py-3 text-center font-medium" style="width:8%;">Ký hiệu</th>
                                    <th class="px-3 py-3 text-left font-medium" style="width:24%;">Quy cách (mm)</th>
                                    <th class="px-2 py-3 text-center font-medium" style="width:10%;">Màu nhôm</th>
                                    <th class="px-2 py-3 text-center font-medium" style="width:10%;">Loại kính</th>
                                    <th class="px-2 py-3 text-center font-medium" style="width:12%;">Phụ kiện</th>
                                    <th class="px-2 py-3 text-center font-medium" style="width:8%;">Hệ nhôm</th>
                                    <th class="px-2 py-3 text-center font-medium" style="width:6%;">SL</th>
                                    <th class="px-2 py-3 text-left font-medium" style="width:10%;">Vị trí</th>
                                    <th class="px-2 py-3 text-center font-medium" style="width:8%;">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody" class="divide-y divide-gray-200">
                                <!-- Rows will be rendered here by JS -->
                            </tbody>
                            <tfoot class="bg-gray-50 border-t-2 border-gray-300">
                                <tr>
                                    <td colspan="7" class="px-4 py-3 text-right font-semibold text-gray-700">Tổng cộng:
                                    </td>
                                    <td class="px-3 py-3 text-center font-bold text-purple-600" id="footerTotalQty">0
                                    </td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyProductsState" class="text-center py-12 hidden">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-gray-500 mb-2">Chưa có sản phẩm nào</p>
                        <p class="text-sm text-gray-400">Nhấn "Thêm sản phẩm" để bắt đầu</p>
                    </div>

                    <!-- Navigation -->
                    <div class="mt-8 flex justify-between">
                        <button onclick="goToStep(1)"
                            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">
                            ← Quay lại
                        </button>
                        <button onclick="goToStep(3)"
                            class="px-6 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700">
                            Tiếp theo: Bóc tách →
                        </button>
                    </div>
                </div>
            </div>

            <!-- STEP 3: Bóc tách Vật tư -->
            <div id="step3Content" class="step-content hidden">
                <div class="bg-white rounded-xl shadow p-6 mb-6">
                    <!-- Project Info Card -->
                    <div
                        class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Tên dự án</p>
                                <p class="font-semibold text-gray-900" id="bocTachProjectName">--</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Khách hàng</p>
                                <p class="font-semibold text-gray-900" id="bocTachCustomer">--</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Địa điểm</p>
                                <p class="font-semibold text-gray-900" id="bocTachLocation">--</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Ngày tạo</p>
                                <p class="font-semibold text-gray-900" id="bocTachCreatedDate">--</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Ngày giao</p>
                                <p class="font-semibold text-gray-900" id="bocTachDeliveryDate">--</p>
                            </div>
                        </div>
                    </div>

                    <!-- 3 Main Tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex space-x-1" aria-label="Tabs">
                            <button onclick="switchBocTachTab('nhom')"
                                class="boc-tach-tab px-6 py-3 font-medium text-sm rounded-t-lg flex items-center gap-2 border-b-2 border-purple-600 text-purple-600 bg-purple-50"
                                data-tab="nhom">
                                <span class="text-lg">🔩</span>
                                Bóc tách Nhôm
                            </button>
                            <button onclick="switchBocTachTab('kinh')"
                                class="boc-tach-tab px-6 py-3 font-medium text-sm rounded-t-lg flex items-center gap-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50"
                                data-tab="kinh">
                                <span class="text-lg">🪟</span>
                                Bóc tách Kính
                            </button>
                            <button onclick="switchBocTachTab('vattu')"
                                class="boc-tach-tab px-6 py-3 font-medium text-sm rounded-t-lg flex items-center gap-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50"
                                data-tab="vattu">
                                <span class="text-lg">🔧</span>
                                Bóc tách Vật tư Phụ
                            </button>
                        </nav>
                    </div>

                    <!-- TAB 1: Bóc tách Nhôm -->
                    <div id="bocTachNhomContent" class="boc-tach-content">
                        <!-- Summary Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                        <span class="text-blue-600">📊</span>
                                    </div>
                                    <span class="text-sm text-gray-600">Tổng loại nhôm</span>
                                </div>
                                <div class="text-2xl font-bold text-blue-600" id="nhomTotalTypes">0</div>
                            </div>
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                        <span class="text-green-600">📏</span>
                                    </div>
                                    <span class="text-sm text-gray-600">Tổng số cây</span>
                                </div>
                                <div class="text-2xl font-bold text-green-600" id="nhomTotalPcs">0</div>
                            </div>
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                        <span class="text-purple-600">⚖️</span>
                                    </div>
                                    <span class="text-sm text-gray-600">Tổng khối lượng</span>
                                </div>
                                <div class="text-2xl font-bold text-purple-600" id="nhomTotalWeight">0 kg</div>
                            </div>
                        </div>

                        <!-- Actions Row -->
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex gap-2">
                                <input type="text" id="nhomSearchInput" placeholder="Tìm kiếm mã/tên nhôm..."
                                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent w-64"
                                    onkeyup="filterNhomTable()">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="addEmptyNhomRow()"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 flex items-center gap-2 text-sm">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Thêm mới
                                </button>
                                <button onclick="exportBocTachNhomExcel()"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 flex items-center gap-2 text-sm">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    Xuất Excel Nhôm
                                </button>
                            </div>
                        </div>

                        <!-- Aluminum Table -->
                        <div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="w-full text-sm">
                                <thead class="bg-gradient-to-r from-blue-500 to-blue-600 text-white">
                                    <tr>
                                        <th class="px-3 py-3 text-left font-medium">Tên vật tư</th>
                                        <th class="px-3 py-3 text-center font-medium w-24">Mã VT</th>
                                        <th class="px-3 py-3 text-center font-medium w-24">Tỷ trọng</th>
                                        <th class="px-3 py-3 text-center font-medium w-24">Dài (m)</th>
                                        <th class="px-3 py-3 text-center font-medium w-20">ĐVT</th>
                                        <th class="px-3 py-3 text-center font-medium w-20">SL</th>
                                        <th class="px-3 py-3 text-center font-medium w-24">KL (kg)</th>
                                        <th class="px-3 py-3 text-left font-medium w-32">Ghi chú</th>
                                        <th class="px-3 py-3 text-center font-medium w-16">Xóa</th>
                                    </tr>
                                </thead>
                                <tbody id="nhomTableBody" class="divide-y divide-gray-200 bg-white">
                                    <tr>
                                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                                            <p>Chưa có dữ liệu bóc tách nhôm</p>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot class="bg-blue-50 font-semibold">
                                    <tr>
                                        <td colspan="6" class="px-4 py-3 text-right">TỔNG CỘNG:</td>
                                        <td class="px-4 py-3 text-center text-blue-600" id="nhomFooterQty">0</td>
                                        <td class="px-4 py-3 text-center text-blue-600" id="nhomFooterWeight">0</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- Glass Table -->
                    <div id="bocTachKinhContent" class="boc-tach-content hidden">
                        <!-- Summary Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-cyan-50 border border-cyan-200 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-cyan-600">📊</span>
                                    <span class="text-sm text-gray-600">Tổng loại kính</span>
                                </div>
                                <div class="text-2xl font-bold text-cyan-600" id="kinhTotalTypes">0</div>
                            </div>
                            <div class="bg-teal-50 border border-teal-200 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-teal-600">🔢</span>
                                    <span class="text-sm text-gray-600">Tổng số tấm</span>
                                </div>
                                <div class="text-2xl font-bold text-teal-600" id="kinhTotalPcs">0</div>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-blue-600">📐</span>
                                    <span class="text-sm text-gray-600">Tổng diện tích</span>
                                </div>
                                <div class="text-2xl font-bold text-blue-600" id="kinhTotalArea">0 m²</div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-4">
                            <input type="text" id="kinhSearchInput" placeholder="Tìm kiếm kính..."
                                class="px-4 py-2 border border-gray-300 rounded-lg text-sm w-64"
                                onkeyup="filterKinhTable()">
                            <div class="flex gap-2">
                                <button onclick="addEmptyKinhRow()"
                                    class="px-4 py-2 bg-cyan-600 text-white rounded-lg font-medium hover:bg-cyan-700 text-sm">
                                    Thêm kính
                                </button>
                                <button onclick="exportBocTachKinhExcel()"
                                    class="px-4 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 text-sm">
                                    Xuất Excel Kính
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="w-full text-sm">
                                <thead class="bg-gradient-to-r from-cyan-500 to-teal-500 text-white">
                                    <tr>
                                        <th class="px-3 py-3 text-left font-medium">Mã kính</th>
                                        <th class="px-3 py-3 text-left font-medium">Loại kính</th>
                                        <th class="px-3 py-3 text-center font-medium">Rộng (mm)</th>
                                        <th class="px-3 py-3 text-center font-medium">Cao (mm)</th>
                                        <th class="px-3 py-3 text-center font-medium">ĐVT</th>
                                        <th class="px-3 py-3 text-center font-medium">SL</th>
                                        <th class="px-3 py-3 text-left font-medium">Vị trí</th>
                                        <th class="px-3 py-3 text-center font-medium">DT (m²)</th>
                                        <th class="px-3 py-3 text-center font-medium">Xóa</th>
                                    </tr>
                                </thead>
                                <tbody id="kinhTableBody" class="divide-y divide-gray-200 bg-white">
                                    <tr>
                                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                                            <p>Chưa có dữ liệu kính</p>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot class="bg-cyan-50 font-semibold">
                                    <tr>
                                        <td colspan="5" class="px-4 py-3 text-right">TỔNG:</td>
                                        <td class="px-4 py-3 text-center text-cyan-600" id="kinhFooterQty">0</td>
                                        <td colspan="2" class="px-4 py-3 text-center text-cyan-600" id="kinhFooterArea">
                                            0</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- Accessories Tab -->
                    <div id="bocTachVatTuContent" class="boc-tach-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-amber-600">🎯</span>
                                    <span class="text-sm text-gray-600">Ke góc</span>
                                </div>
                                <div class="text-2xl font-bold text-amber-600" id="vattuKeCount">0 cái</div>
                            </div>
                            <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-emerald-600">〰️</span>
                                    <span class="text-sm text-gray-600">Gioăng</span>
                                </div>
                                <div class="text-2xl font-bold text-emerald-600" id="vattuGioangCount">0 m</div>
                            </div>
                            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-indigo-600">🔐</span>
                                    <span class="text-sm text-gray-600">Bản lề & Khóa</span>
                                </div>
                                <div class="text-2xl font-bold text-indigo-600" id="vattuHardwareCount">0 bộ</div>
                            </div>
                            <div class="bg-rose-50 border border-rose-200 rounded-lg p-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-rose-600">📦</span>
                                    <span class="text-sm text-gray-600">Tổng loại</span>
                                </div>
                                <div class="text-2xl font-bold text-rose-600" id="vattuTotalTypes">0</div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-4">
                            <input type="text" id="vattuSearchInput" placeholder="Tìm kiếm phụ kiện..."
                                class="px-4 py-2 border border-gray-300 rounded-lg text-sm w-64"
                                onkeyup="filterVatTuTable()">
                            <div class="flex gap-2">
                                <button onclick="addEmptyVatTuRow()"
                                    class="px-4 py-2 bg-amber-600 text-white rounded-lg font-medium hover:bg-amber-700 text-sm">
                                    Thêm phụ kiện
                                </button>
                                <button onclick="exportBocTachVatTuExcel()"
                                    class="px-4 py-2 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700 text-sm">
                                    Xuất Excel
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="w-full text-sm">
                                <thead class="bg-gradient-to-r from-amber-500 to-orange-500 text-white">
                                    <tr>
                                        <th class="px-3 py-3 text-left font-medium">Tên phụ kiện</th>
                                        <th class="px-3 py-3 text-center font-medium w-24">Mã VT</th>
                                        <th class="px-3 py-3 text-center font-medium w-24">Loại</th>
                                        <th class="px-3 py-3 text-center font-medium w-20">ĐVT</th>
                                        <th class="px-3 py-3 text-center font-medium w-20">SL</th>
                                        <th class="px-3 py-3 text-left font-medium">Ghi chú</th>
                                        <th class="px-3 py-3 text-center font-medium w-16">Xóa</th>
                                    </tr>
                                </thead>
                                <tbody id="vattuTableBody" class="divide-y divide-gray-200 bg-white">
                                    <tr>
                                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                            <p>Chưa có dữ liệu phụ kiện</p>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot class="bg-amber-50 font-semibold">
                                    <tr>
                                        <td colspan="4" class="px-4 py-3 text-right">TỔNG CỘNG:</td>
                                        <td class="px-4 py-3 text-center text-amber-600" id="vattuFooterQty">0</td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t border-gray-200 flex justify-between">
                    <button onclick="goToStep(2)"
                        class="px-4 py-2 text-gray-600 hover:text-gray-900 border border-gray-300 rounded-lg">
                        ← Quay lại
                    </button>
                    <div class="flex gap-3">
                        <button onclick="exportAllBocTachExcel()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                            Xuất tổng hợp
                        </button>
                        <button onclick="goToStep(4)"
                            class="px-6 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700">
                            Tiếp theo →
                        </button>
                    </div>
                </div>
            </div>

            <!-- STEP 4: Kiểm kho -->
            <div id="step4Content" class="step-content hidden">
                <div class="bg-white rounded-xl shadow p-6">
                    <!-- Project Info -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Tên dự án</p>
                                <p class="font-semibold text-gray-900" id="step4ProjectName">--</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Khách hàng</p>
                                <p class="font-semibold text-gray-900" id="step4Customer">--</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Địa điểm</p>
                                <p class="font-semibold text-gray-900" id="step4Location">--</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Ngày tạo</p>
                                <p class="font-semibold text-gray-900" id="step4CreatedDate">--</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Ngày giao</p>
                                <p class="font-semibold text-gray-900" id="step4DeliveryDate">--</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Kiểm Tra Kho</h2>
                        <div class="flex gap-2">
                            <button onclick="refreshInventoryCheck()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Làm mới
                            </button>
                            <a href="inventory.html" target="_blank"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                                Quản lý Kho
                            </a>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-green-600">✓</span>
                                <span class="text-sm text-gray-600">Đủ hàng</span>
                            </div>
                            <div class="text-2xl font-bold text-green-600" id="step4SufficientCount">0</div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-yellow-600">⚠</span>
                                <span class="text-sm text-gray-600">Thiếu một phần</span>
                            </div>
                            <div class="text-2xl font-bold text-yellow-600" id="step4PartialCount">0</div>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-red-600">✗</span>
                                <span class="text-sm text-gray-600">Hết hàng</span>
                            </div>
                            <div class="text-2xl font-bold text-red-600" id="step4ShortageCount">0</div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-blue-600">📦</span>
                                <span class="text-sm text-gray-600">Tổng loại</span>
                            </div>
                            <div class="text-2xl font-bold text-blue-600" id="step4TotalCount">0</div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex space-x-1" aria-label="Tabs">
                            <button onclick="switchKhoTab('nhom')"
                                class="kho-tab px-6 py-3 font-medium text-sm rounded-t-lg flex items-center gap-2 border-b-2 border-blue-600 text-blue-600 bg-blue-50"
                                data-tab="nhom">
                                <span class="text-lg">🔩</span>
                                Nhôm
                            </button>
                            <button onclick="switchKhoTab('kinh')"
                                class="kho-tab px-6 py-3 font-medium text-sm rounded-t-lg flex items-center gap-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50"
                                data-tab="kinh">
                                <span class="text-lg">🪟</span>
                                Kính
                            </button>
                            <button onclick="switchKhoTab('vattu')"
                                class="kho-tab px-6 py-3 font-medium text-sm rounded-t-lg flex items-center gap-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50"
                                data-tab="vattu">
                                <span class="text-lg">🔧</span>
                                Vật tư Phụ
                            </button>
                        </nav>
                    </div>

                    <!-- Nhôm Tab -->
                    <div id="khoNhomContent" class="kho-content">
                        <div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="w-full text-sm">
                                <thead class="bg-gradient-to-r from-blue-500 to-blue-600 text-white">
                                    <tr>
                                        <th class="px-3 py-3 text-left font-medium">Mã VT</th>
                                        <th class="px-3 py-3 text-left font-medium">Tên vật tư</th>
                                        <th class="px-3 py-3 text-center font-medium">ĐVT</th>
                                        <th class="px-3 py-3 text-center font-medium">Cần</th>
                                        <th class="px-3 py-3 text-center font-medium">Tồn kho</th>
                                        <th class="px-3 py-3 text-center font-medium">Thiếu</th>
                                        <th class="px-3 py-3 text-center font-medium">Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody id="khoNhomTableBody" class="divide-y divide-gray-200 bg-white">
                                    <tr>
                                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                            <p>Đang tải dữ liệu...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Kính Tab -->
                    <div id="khoKinhContent" class="kho-content hidden">
                        <div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="w-full text-sm">
                                <thead class="bg-gradient-to-r from-cyan-500 to-teal-500 text-white">
                                    <tr>
                                        <th class="px-3 py-3 text-left font-medium">Mã kính</th>
                                        <th class="px-3 py-3 text-left font-medium">Loại kính</th>
                                        <th class="px-3 py-3 text-center font-medium">ĐVT</th>
                                        <th class="px-3 py-3 text-center font-medium">Cần (m²)</th>
                                        <th class="px-3 py-3 text-center font-medium">Tồn kho</th>
                                        <th class="px-3 py-3 text-center font-medium">Thiếu</th>
                                        <th class="px-3 py-3 text-center font-medium">Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody id="khoKinhTableBody" class="divide-y divide-gray-200 bg-white">
                                    <tr>
                                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                            <p>Đang tải dữ liệu...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Vật tư Phụ Tab -->
                    <div id="khoVatTuContent" class="kho-content hidden">
                        <div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="w-full text-sm">
                                <thead class="bg-gradient-to-r from-amber-500 to-orange-500 text-white">
                                    <tr>
                                        <th class="px-3 py-3 text-left font-medium">Mã VT</th>
                                        <th class="px-3 py-3 text-left font-medium">Tên phụ kiện</th>
                                        <th class="px-3 py-3 text-center font-medium">ĐVT</th>
                                        <th class="px-3 py-3 text-center font-medium">Cần</th>
                                        <th class="px-3 py-3 text-center font-medium">Tồn kho</th>
                                        <th class="px-3 py-3 text-center font-medium">Thiếu</th>
                                        <th class="px-3 py-3 text-center font-medium">Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody id="khoVatTuTableBody" class="divide-y divide-gray-200 bg-white">
                                    <tr>
                                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                            <p>Đang tải dữ liệu...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Yêu cầu Vật tư Section -->
                    <div class="mt-8 border-t border-gray-200 pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">📋 Yêu Cầu Vật Tư</h3>
                            <div class="flex gap-2">
                                <button onclick="openMaterialRequestForm()"
                                    class="px-4 py-2 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Tạo Yêu Cầu
                                </button>
                                <button onclick="exportAllMaterialRequestsExcel()"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    Xuất Excel
                                </button>
                            </div>
                        </div>

                        <!-- Material Request Form (Hidden by default) -->
                        <div id="materialRequestForm"
                            class="hidden bg-orange-50 border border-orange-200 rounded-lg p-6 mb-4">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-md font-bold text-orange-800">📋 Phiếu Yêu Cầu Vật Tư</h4>
                                <button onclick="closeMaterialRequestForm()"
                                    class="text-orange-600 hover:text-orange-800">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>

                            <!-- Tabs for categories -->
                            <div class="mb-4 border-b border-orange-200">
                                <div class="flex gap-2">
                                    <button onclick="switchMaterialRequestTab('nhom')" id="materialRequestTabNhom"
                                        class="px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600 bg-blue-50">
                                        PHIẾU YÊU CẦU VẬT TƯ NHÔM
                                    </button>
                                    <button onclick="switchMaterialRequestTab('kinh')" id="materialRequestTabKinh"
                                        class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-600 hover:text-cyan-600">
                                        PHIẾU YÊU CẦU VẬT TƯ KÍNH
                                    </button>
                                    <button onclick="switchMaterialRequestTab('phukien')" id="materialRequestTabPhuKien"
                                        class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-600 hover:text-amber-600">
                                        PHIẾU YÊU CẦU VẬT TƯ - PHỤ KIỆN
                                    </button>
                                </div>
                            </div>

                            <!-- Tab Content for Nhôm -->
                            <div id="materialRequestTabContentNhom" class="material-request-tab-content">
                                <div
                                    class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-white rounded-lg border border-blue-200">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Mã đơn hàng</label>
                                        <input type="text" id="requestOrderCodeNhom"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                            placeholder="Tự động tạo hoặc nhập mã">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ngày tạo
                                            phiếu</label>
                                        <input type="date" id="requestCreatedDateNhom"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" value="">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ngày vật tư cần
                                            về</label>
                                        <input type="date" id="requestRequiredDateNhom"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" value="">
                                    </div>
                                </div>
                                <div class="overflow-x-auto border border-blue-200 rounded-lg bg-white">
                                    <table class="w-full text-sm">
                                        <thead class="bg-blue-500 text-white">
                                            <tr>
                                                <th class="px-3 py-3 text-left font-medium">STT</th>
                                                <th class="px-3 py-3 text-left font-medium">Mã VT</th>
                                                <th class="px-3 py-3 text-left font-medium">Tên vật tư</th>
                                                <th class="px-3 py-3 text-center font-medium">ĐVT</th>
                                                <th class="px-3 py-3 text-center font-medium">Thiếu</th>
                                                <th class="px-3 py-3 text-center font-medium">Yêu cầu</th>
                                                <th class="px-3 py-3 text-center font-medium">Ghi chú</th>
                                            </tr>
                                        </thead>
                                        <tbody id="materialRequestTableBodyNhom" class="divide-y divide-gray-200">
                                            <tr>
                                                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                                    <p>Đang tải dữ liệu...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                    <div class="text-sm text-gray-600">
                                        <span id="materialRequestCountNhom">0</span> vật tư cần yêu cầu
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="clearMaterialRequest('nhom')"
                                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">
                                            Xóa tất cả
                                        </button>
                                        <button onclick="saveMaterialRequest('nhom')"
                                            class="px-4 py-2 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700">
                                            💾 Lưu Yêu Cầu
                                        </button>
                                        <button onclick="submitMaterialRequest('nhom')"
                                            class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                                            📤 Gửi Yêu Cầu
                                        </button>
                                        <button onclick="exportMaterialRequestExcel('nhom')"
                                            class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                            </svg>
                                            Xuất Excel
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab Content for Kính -->
                            <div id="materialRequestTabContentKinh" class="material-request-tab-content hidden">
                                <div
                                    class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-white rounded-lg border border-cyan-200">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Mã đơn hàng</label>
                                        <input type="text" id="requestOrderCodeKinh"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                            placeholder="Tự động tạo hoặc nhập mã">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ngày tạo
                                            phiếu</label>
                                        <input type="date" id="requestCreatedDateKinh"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" value="">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ngày vật tư cần
                                            về</label>
                                        <input type="date" id="requestRequiredDateKinh"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" value="">
                                    </div>
                                </div>
                                <div class="overflow-x-auto border border-cyan-200 rounded-lg bg-white">
                                    <table class="w-full text-sm">
                                        <thead class="bg-cyan-500 text-white">
                                            <tr>
                                                <th class="px-3 py-3 text-left font-medium">STT</th>
                                                <th class="px-3 py-3 text-left font-medium">Mã VT</th>
                                                <th class="px-3 py-3 text-left font-medium">Tên vật tư</th>
                                                <th class="px-3 py-3 text-center font-medium">ĐVT</th>
                                                <th class="px-3 py-3 text-center font-medium">Thiếu</th>
                                                <th class="px-3 py-3 text-center font-medium">Yêu cầu</th>
                                                <th class="px-3 py-3 text-center font-medium">Ghi chú</th>
                                            </tr>
                                        </thead>
                                        <tbody id="materialRequestTableBodyKinh" class="divide-y divide-gray-200">
                                            <tr>
                                                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                                    <p>Đang tải dữ liệu...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                    <div class="text-sm text-gray-600">
                                        <span id="materialRequestCountKinh">0</span> vật tư cần yêu cầu
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="clearMaterialRequest('kinh')"
                                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">
                                            Xóa tất cả
                                        </button>
                                        <button onclick="saveMaterialRequest('kinh')"
                                            class="px-4 py-2 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700">
                                            💾 Lưu Yêu Cầu
                                        </button>
                                        <button onclick="submitMaterialRequest('kinh')"
                                            class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                                            📤 Gửi Yêu Cầu
                                        </button>
                                        <button onclick="exportMaterialRequestExcel('kinh')"
                                            class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                            </svg>
                                            Xuất Excel
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab Content for Phụ kiện -->
                            <div id="materialRequestTabContentPhuKien" class="material-request-tab-content hidden">
                                <div
                                    class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-white rounded-lg border border-amber-200">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Mã đơn hàng</label>
                                        <input type="text" id="requestOrderCodePhuKien"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                            placeholder="Tự động tạo hoặc nhập mã">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ngày tạo
                                            phiếu</label>
                                        <input type="date" id="requestCreatedDatePhuKien"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" value="">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Ngày vật tư cần
                                            về</label>
                                        <input type="date" id="requestRequiredDatePhuKien"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" value="">
                                    </div>
                                </div>
                                <div class="overflow-x-auto border border-amber-200 rounded-lg bg-white">
                                    <table class="w-full text-sm">
                                        <thead class="bg-amber-500 text-white">
                                            <tr>
                                                <th class="px-3 py-3 text-left font-medium">STT</th>
                                                <th class="px-3 py-3 text-left font-medium">Mã VT</th>
                                                <th class="px-3 py-3 text-left font-medium">Tên vật tư</th>
                                                <th class="px-3 py-3 text-center font-medium">ĐVT</th>
                                                <th class="px-3 py-3 text-center font-medium">Thiếu</th>
                                                <th class="px-3 py-3 text-center font-medium">Yêu cầu</th>
                                                <th class="px-3 py-3 text-center font-medium">Ghi chú</th>
                                            </tr>
                                        </thead>
                                        <tbody id="materialRequestTableBodyPhuKien" class="divide-y divide-gray-200">
                                            <tr>
                                                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                                    <p>Đang tải dữ liệu...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                    <div class="text-sm text-gray-600">
                                        <span id="materialRequestCountPhuKien">0</span> vật tư cần yêu cầu
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="clearMaterialRequest('phukien')"
                                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">
                                            Xóa tất cả
                                        </button>
                                        <button onclick="saveMaterialRequest('phukien')"
                                            class="px-4 py-2 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700">
                                            💾 Lưu Yêu Cầu
                                        </button>
                                        <button onclick="submitMaterialRequest('phukien')"
                                            class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                                            📤 Gửi Yêu Cầu
                                        </button>
                                        <button onclick="exportMaterialRequestExcel('phukien')"
                                            class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                            </svg>
                                            Xuất Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Info Message -->
                        <div id="materialRequestInfo" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div class="flex-1">
                                    <p class="text-sm text-blue-800 font-medium">Hướng dẫn</p>
                                    <p class="text-sm text-blue-700 mt-1">
                                        Các vật tư có trạng thái "Thiếu" hoặc "Hết" sẽ được tự động thêm vào danh sách
                                        yêu cầu.
                                        Bạn có thể chỉnh sửa số lượng yêu cầu và xuất Excel để gửi cho bộ phận mua hàng.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-between">
                        <button onclick="goToStep(3)"
                            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium">← Quay lại</button>
                        <button onclick="goToInventoryExport()"
                            class="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                            </svg>
                            Chuyển đến kho để xuất vật tư →
                        </button>
                    </div>
                </div>
            </div>

        </div>
        <script>
            const API_BASE = 'http://localhost:3001/api';

            // Load sidebar user info
            async function loadSidebarUserInfo() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        return;
                    }

                    const response = await fetch(`${API_BASE}/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        const user = result.data;
                        const userNameEl = document.getElementById('sidebarUserName');
                        if (userNameEl) {
                            userNameEl.textContent = user.full_name || 'User';
                        }

                        const avatarInitial = document.getElementById('sidebarUserAvatarInitial');
                        const avatarImage = document.getElementById('sidebarUserAvatarImage');

                        if (avatarInitial && avatarImage) {
                            if (user.avatar_url) {
                                avatarImage.src = user.avatar_url;
                                avatarImage.classList.remove('hidden');
                                avatarInitial.classList.add('hidden');
                            } else {
                                const initial = (user.full_name || 'U').charAt(0).toUpperCase();
                                avatarInitial.textContent = initial;
                                avatarInitial.classList.remove('hidden');
                                avatarImage.classList.add('hidden');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Lỗi load sidebar user info:', error);
                }
            }

            // Toggle sidebar user menu
            function toggleSidebarUserMenu() {
                const dropdown = document.getElementById('sidebarUserMenuDropdown');
                if (dropdown) {
                    dropdown.classList.toggle('hidden');
                }
            }

            // Handle logout (shared function)
            function handleLogout() {
                if (confirm('Bạn có chắc muốn đăng xuất?')) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                }
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', function (event) {
                // Sidebar user dropdown
                const sidebarDropdown = document.getElementById('sidebarUserMenuDropdown');
                const sidebarButton = event.target.closest('[onclick="toggleSidebarUserMenu()"]');
                if (sidebarDropdown && !sidebarButton && !sidebarDropdown.contains(event.target)) {
                    sidebarDropdown.classList.add('hidden');
                }
            });

            // Load company logo and name
            async function loadCompanyLogo() {
                try {
                    const response = await fetch(`${API_BASE}/company-settings`);
                    const result = await response.json();

                    if (result.success && result.data) {
                        // Load logo
                        if (result.data.logo_path) {
                            const logoImg = document.getElementById('companyLogo');
                            const logoIcon = document.getElementById('companyLogoIcon');
                            if (logoImg && logoIcon) {
                                logoImg.src = result.data.logo_path;
                                logoImg.classList.remove('hidden');
                                logoIcon.classList.add('hidden');
                            }
                        }

                        // Load company name
                        const companyNameEl = document.getElementById('companyName');
                        if (companyNameEl && result.data.company_name) {
                            companyNameEl.textContent = result.data.company_name;
                        }
                    }
                } catch (error) {
                    console.error('Lỗi load logo:', error);
                }
            }

            // Global variables
            let currentProject = null;
            let currentItems = [];
            let uploadedDesignFiles = [];
            let bocTachData = { nhom: [], kinh: [], vattu: [] }; // BOM data structure

            // Global error handler - prevent page crashes
            window.addEventListener('error', function (e) {
                console.error('🚨 Global error caught:', e.error);
                e.preventDefault();
                return false;
            });

            window.addEventListener('unhandledrejection', function (e) {
                console.error('🚨 Unhandled promise rejection:', e.reason);
                e.preventDefault();
            });

            // Update the project card/dashboard with current project info
            function updateProjectCard() {
                if (!currentProject) return;

                const dashboardEl = document.getElementById('dashboardOverview');
                if (dashboardEl) {
                    // Update project name and code displays
                    const projectNameEl = dashboardEl.querySelector('.project-name, #dashboardProjectName');
                    const projectCodeEl = dashboardEl.querySelector('.project-code, #dashboardProjectCode');
                    const customerEl = dashboardEl.querySelector('.customer-name, #dashboardCustomer');

                    if (projectNameEl) projectNameEl.textContent = currentProject.name || currentProject.project_name || '--';
                    if (projectCodeEl) projectCodeEl.textContent = currentProject.code || currentProject.project_code || '--';
                    if (customerEl) customerEl.textContent = currentProject.customer_name || '--';
                }

                console.log('✅ Project card updated:', currentProject.name || currentProject.project_name);
            }

            // Update project info header for specific step
            function updateProjectInfo(stepNumber) {
                if (!currentProject) {
                    console.warn('⚠️ updateProjectInfo: No project selected');
                    return;
                }

                // Update selected project name display (global header if exists)
                const selectedProjectNameEl = document.getElementById('selectedProjectName');
                if (selectedProjectNameEl) {
                    selectedProjectNameEl.textContent = `${currentProject.name || currentProject.project_name || 'Dự án'} (${currentProject.code || currentProject.project_code || 'N/A'})`;
                }

                // Update step-specific info panels using correct element IDs
                // Step 2 info panel
                const step2ProjectName = document.getElementById('step2ProjectName');
                const step2Customer = document.getElementById('step2Customer');
                const step2Location = document.getElementById('step2Location');
                const step2CreatedDate = document.getElementById('step2CreatedDate');
                const step2DeliveryDate = document.getElementById('step2DeliveryDate');

                if (step2ProjectName) step2ProjectName.textContent = currentProject.name || currentProject.project_name || '--';
                if (step2Customer) step2Customer.textContent = currentProject.customer_name || '--';
                if (step2Location) step2Location.textContent = currentProject.location || currentProject.address || '--';
                if (step2CreatedDate) {
                    const createdDate = currentProject.created_at ? new Date(currentProject.created_at).toLocaleDateString('vi-VN') : '--';
                    step2CreatedDate.textContent = createdDate;
                }
                if (step2DeliveryDate) {
                    const deliveryDate = currentProject.deadline || currentProject.expected_date ?
                        new Date(currentProject.deadline || currentProject.expected_date).toLocaleDateString('vi-VN') : '--';
                    step2DeliveryDate.textContent = deliveryDate;
                }

                // Step 3 info panel (Bóc tách Vật tư)
                const step3ProjectName = document.getElementById('step3ProjectName');
                const step3Customer = document.getElementById('step3Customer');
                const bocTachProjectName = document.getElementById('bocTachProjectName');
                const bocTachCustomer = document.getElementById('bocTachCustomer');
                const bocTachLocation = document.getElementById('bocTachLocation');
                const bocTachCreatedDate = document.getElementById('bocTachCreatedDate');
                const bocTachDeliveryDate = document.getElementById('bocTachDeliveryDate');

                // Update step3ProjectName if exists
                if (step3ProjectName) step3ProjectName.textContent = currentProject.name || currentProject.project_name || '--';
                if (step3Customer) step3Customer.textContent = currentProject.customer_name || '--';

                // Update bocTach* elements (main info panel in step 3)
                if (bocTachProjectName) bocTachProjectName.textContent = currentProject.name || currentProject.project_name || '--';
                if (bocTachCustomer) bocTachCustomer.textContent = currentProject.customer_name || '--';
                if (bocTachLocation) bocTachLocation.textContent = currentProject.location || currentProject.address || '--';
                if (bocTachCreatedDate) {
                    const createdDate = currentProject.created_at ? new Date(currentProject.created_at).toLocaleDateString('vi-VN') : '--';
                    bocTachCreatedDate.textContent = createdDate;
                }
                if (bocTachDeliveryDate) {
                    const deliveryDate = currentProject.deadline || currentProject.expected_date ?
                        new Date(currentProject.deadline || currentProject.expected_date).toLocaleDateString('vi-VN') : '--';
                    bocTachDeliveryDate.textContent = deliveryDate;
                }

                // Step 4 info panel (Kiểm tra Kho)
                const step4ProjectName = document.getElementById('step4ProjectName');
                const step4Customer = document.getElementById('step4Customer');
                const step4Location = document.getElementById('step4Location');
                const step4CreatedDate = document.getElementById('step4CreatedDate');
                const step4DeliveryDate = document.getElementById('step4DeliveryDate');

                if (step4ProjectName) step4ProjectName.textContent = currentProject.name || currentProject.project_name || '--';
                if (step4Customer) step4Customer.textContent = currentProject.customer_name || '--';
                if (step4Location) step4Location.textContent = currentProject.location || currentProject.address || '--';
                if (step4CreatedDate) {
                    const createdDate = currentProject.created_at ? new Date(currentProject.created_at).toLocaleDateString('vi-VN') : '--';
                    step4CreatedDate.textContent = createdDate;
                }
                if (step4DeliveryDate) {
                    const deliveryDate = currentProject.deadline || currentProject.expected_date ?
                        new Date(currentProject.deadline || currentProject.expected_date).toLocaleDateString('vi-VN') : '--';
                    step4DeliveryDate.textContent = deliveryDate;
                }


                // Generic step header if exists
                const stepHeaderEl = document.getElementById(`step${stepNumber}ProjectHeader`);
                if (stepHeaderEl) {
                    stepHeaderEl.textContent = currentProject.name || currentProject.project_name || 'Chưa chọn dự án';
                }

                console.log(`✅ Project info updated for step ${stepNumber}:`, currentProject.name || currentProject.project_name);
            }

            // Load notification manager (if file exists)
            // Note: notification-manager.js is in FontEnd root, not in js/ folder
            // Commented out to prevent 404 error - uncomment if needed
            /*
            const notifScript = document.createElement('script');
            notifScript.src = 'notification-manager.js';
            notifScript.onerror = function() {
                console.warn('⚠️ notification-manager.js not found, skipping...');
            };
            document.head.appendChild(notifScript);
            */

            // Update notification badge
            setTimeout(() => {
                if (window.NotificationManager) {
                    window.NotificationManager.updateBadge();
                }
            }, 1000);

            // Initialize
            document.addEventListener('DOMContentLoaded', function () {
                loadCompanyLogo();
                loadSidebarUserInfo();
                console.log('🚀 Initializing design-new page...');

                // KHÔNG xóa sessionStorage - giữ lại để load dữ liệu khi reload trang
                // Chỉ reset nếu thực sự cần (ví dụ: user muốn bắt đầu mới)

                // Đánh dấu đang reload trang
                isPageReloading = true;

                // Kiểm tra xem có dự án đã chọn từ session không
                const savedProject = sessionStorage.getItem('currentProject');
                const savedStep = sessionStorage.getItem('currentStep');
                const savedQuotationItems = sessionStorage.getItem('quotationItemsForDesign');

                if (savedProject) {
                    try {
                        currentProject = JSON.parse(savedProject);
                        console.log('📂 Loaded project from session:', currentProject.name || currentProject.project_name);

                        // Load lại uploaded files từ sessionStorage
                        const savedFiles = sessionStorage.getItem('uploadedDesignFiles');
                        const savedProjectId = sessionStorage.getItem('uploadedDesignFiles_projectId');
                        if (savedFiles && savedProjectId == currentProject.id) {
                            try {
                                uploadedDesignFiles = JSON.parse(savedFiles);
                                console.log('📂 Loaded', uploadedDesignFiles.length, 'design files from sessionStorage');
                            } catch (e) {
                                console.warn('Could not parse saved files:', e);
                                uploadedDesignFiles = [];
                            }
                        }

                        // Load lại quotationItemsForDesign từ sessionStorage (tạm thời)
                        if (savedQuotationItems) {
                            try {
                                quotationItemsForDesign = JSON.parse(savedQuotationItems);
                                console.log('📂 Loaded', quotationItemsForDesign.length, 'quotation items from sessionStorage (temporary)');
                                // Render ngay với data từ sessionStorage để UI không bị trống
                                renderProductCards(quotationItemsForDesign);
                                updateProductTypeSummary(quotationItemsForDesign);
                            } catch (e) {
                                console.warn('Could not parse saved quotation items:', e);
                            }
                        }

                        const stepToShow = savedStep ? parseInt(savedStep) : 1;

                        // Chuyển đến step trước (để UI hiển thị ngay)
                        goToStep(stepToShow);

                        // Load lại dữ liệu sản phẩm từ SERVER nếu có project (refresh data)
                        if (currentProject && currentProject.id) {
                            console.log('📥 Refreshing product data from server for project:', currentProject.id);
                            // Skip auto step và skip render (vì đã render từ sessionStorage rồi)
                            loadQuotationItemsForDesign(currentProject.id, {
                                skipAutoStep: true,
                                skipRender: false  // Vẫn render để cập nhật với data mới nhất
                            }).then(() => {
                                console.log('✅ Product data refreshed from server');
                                isPageReloading = false; // Reset flag sau khi load xong
                            }).catch(error => {
                                console.error('❌ Error refreshing product data:', error);
                                isPageReloading = false; // Reset flag ngay cả khi lỗi
                            });
                        } else {
                            isPageReloading = false;
                        }
                    } catch (e) {
                        console.error('Error loading project from session:', e);
                        currentProject = null;
                        uploadedDesignFiles = [];
                        quotationItemsForDesign = [];
                        isPageReloading = false;
                        goToStep(1);
                    }
                } else {
                    // Không có project trong session, reset về step 1
                    currentProject = null;
                    uploadedDesignFiles = [];
                    quotationItemsForDesign = [];
                    isPageReloading = false;
                    goToStep(1);
                }

                // Load projects immediately
                loadProjects();
                loadAluminumSystems();
                loadAccessories();

                // Refresh stats after DOM is ready
                setTimeout(() => {
                    if (window.allProjects && Array.isArray(window.allProjects)) {
                        console.log('🔄 Refreshing stats with', window.allProjects.length, 'projects');
                        updateProjectStats(window.allProjects);
                    } else {
                        console.log('⚠️ Projects not available yet, will retry...');
                        setTimeout(() => {
                            if (window.allProjects && Array.isArray(window.allProjects)) {
                                updateProjectStats(window.allProjects);
                            }
                        }, 1000);
                    }
                }, 500);
            });

            // Load projects - CHỈ hiển thị dự án trong giai đoạn thiết kế
            let isLoadingProjects = false; // Guard to prevent concurrent calls
            let loadProjectsTimeout = null; // Debounce timer

            async function loadProjects() {
                // Clear any pending calls
                if (loadProjectsTimeout) {
                    clearTimeout(loadProjectsTimeout);
                    loadProjectsTimeout = null;
                }

                // Prevent concurrent calls
                if (isLoadingProjects) {
                    console.log('⏸️ loadProjects already in progress, skipping...');
                    return;
                }

                isLoadingProjects = true;
                // Hiển thị loading state
                const gridView = document.getElementById('projectsGridView');
                const listView = document.getElementById('projectsListView');
                const emptyState = document.getElementById('projectsEmptyState');

                // Hide empty state
                if (emptyState) emptyState.classList.add('hidden');

                // Show loading in grid (default)
                if (gridView) {
                    gridView.classList.remove('hidden');
                    gridView.innerHTML = `
                    <div class="col-span-full text-center py-12">
                            <div class="animate-spin w-8 h-8 border-4 border-purple-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p class="text-gray-600">Đang tải danh sách dự án...</p>
                    </div>
                `;
                }

                // Hide list view while loading
                if (listView) listView.classList.add('hidden');

                try {
                    // Lấy tất cả dự án từ API
                    console.log(`📡 Fetching projects from: ${API_BASE}/projects`);
                    const response = await fetch(`${API_BASE}/projects`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('📦 API Response:', result);

                    if (result.success && result.data) {
                        console.log(`📊 Total projects received: ${result.data.length}`);
                        const designProjects = result.data;

                        console.log(`📋 Showing all ${designProjects.length} projects`);

                        // Sắp xếp: designing trước, sau đó new
                        designProjects.sort((a, b) => {
                            const statusA = (a.status || 'new').toLowerCase();
                            const statusB = (b.status || 'new').toLowerCase();
                            if (statusA === 'designing' && statusB !== 'designing') return -1;
                            if (statusA !== 'designing' && statusB === 'designing') return 1;
                            if (statusA === 'new' && statusB !== 'new') return -1;
                            if (statusA !== 'new' && statusB === 'new') return 1;
                            // Nếu cùng status, sắp xếp theo ngày tạo (mới nhất trước)
                            const dateA = new Date(a.created_at || 0);
                            const dateB = new Date(b.created_at || 0);
                            return dateB - dateA;
                        });

                        // Hiển thị danh sách dự án
                        console.log(`✅ Filtered projects: ${designProjects.length} projects`);
                        displayProjects(designProjects);

                        // Force update stats
                        setTimeout(() => {
                            updateProjectStats(designProjects);
                        }, 100);
                    } else {
                        console.warn('⚠️ API response không có data hoặc result.success = false');
                        console.log('API Response:', result);
                        displayProjects([]);
                    }
                } catch (error) {
                    console.error('❌ Error loading projects:', error);
                    console.error('Error details:', {
                        message: error.message,
                        stack: error.stack,
                        API_BASE: API_BASE
                    });

                    // Show error in UI
                    const gridView = document.getElementById('projectsGridView');
                    if (gridView) {
                        gridView.innerHTML = `
                        <div class="col-span-full text-center py-12">
                                <svg class="w-16 h-16 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                                <p class="text-red-600 text-lg font-medium mb-2">Lỗi khi tải dự án</p>
                                <p class="text-sm text-gray-500">${error.message || 'Không thể kết nối tới server'}</p>
                                <button onclick="loadProjects()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                    Thử lại
                            </button>
                        </div>
                    `;
                    }
                    // Update stats to 0 on error
                    updateProjectStats([]);
                } finally {
                    // Always reset the loading flag
                    isLoadingProjects = false;
                }
            }

            // Store reference to the async function BEFORE creating the wrapper
            const _loadProjectsAsync = loadProjects;

            // Expose loadProjects globally for manual refresh (after function definition)
            // Use debounce to prevent rapid successive calls
            window.loadProjects = function () {
                console.log('🔄 Manual refresh triggered');

                // Clear any pending calls
                if (loadProjectsTimeout) {
                    clearTimeout(loadProjectsTimeout);
                }

                // Debounce: wait 100ms before actually calling the ORIGINAL async function
                loadProjectsTimeout = setTimeout(() => {
                    loadProjectsTimeout = null;
                    _loadProjectsAsync();
                }, 100);
            };

            function displayProjects(projects) {
                // Lưu danh sách để sử dụng sau
                window.allProjects = projects || [];

                // Nếu không có dự án nào
                if (!projects || projects.length === 0) {
                    document.getElementById('projectsGridView')?.classList.add('hidden');
                    document.getElementById('projectsListView')?.classList.add('hidden');
                    document.getElementById('projectsEmptyState')?.classList.remove('hidden');

                    // Xóa dropdown khách hàng
                    const customerFilter = document.getElementById('projectCustomerFilter');
                    if (customerFilter) {
                        customerFilter.innerHTML = '<option value="all">Tất cả khách hàng</option>';
                    }

                    // Update stats
                    updateProjectStats([]);
                    return;
                }

                // Cập nhật dropdown khách hàng
                const customerSet = new Set();
                projects.forEach(p => {
                    if (p.customer_name) customerSet.add(p.customer_name);
                });
                const customerFilter = document.getElementById('projectCustomerFilter');
                if (customerFilter) {
                    customerFilter.innerHTML = '<option value="all">Tất cả khách hàng</option>' +
                        Array.from(customerSet).sort().map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
                }

                // Store globally for sorting/filtering
                window.allProjects = projects;

                // Update stats
                updateProjectStats(projects);

                // Render projects
                renderProjectsList(projects);
            }

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function isDeadlineApproaching(deadline) {
                if (!deadline) return false;
                const deadlineDate = new Date(deadline);
                const today = new Date();
                const diffDays = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
                return diffDays <= 7 && diffDays >= 0;
            }

            // View mode functions
            let currentViewMode = 'grid';
            let allProjectsData = [];

            function setViewMode(mode) {
                currentViewMode = mode;
                const gridView = document.getElementById('projectsGridView');
                const listView = document.getElementById('projectsListView');
                const gridBtn = document.getElementById('viewGridBtn');
                const listBtn = document.getElementById('viewListBtn');

                if (mode === 'grid') {
                    gridView?.classList.remove('hidden');
                    listView?.classList.add('hidden');
                    gridBtn?.classList.remove('bg-gray-100', 'text-gray-600');
                    gridBtn?.classList.add('bg-purple-600', 'text-white');
                    listBtn?.classList.remove('bg-purple-600', 'text-white');
                    listBtn?.classList.add('bg-gray-100', 'text-gray-600');
                } else {
                    gridView?.classList.add('hidden');
                    listView?.classList.remove('hidden');
                    listBtn?.classList.remove('bg-gray-100', 'text-gray-600');
                    listBtn?.classList.add('bg-purple-600', 'text-white');
                    gridBtn?.classList.remove('bg-purple-600', 'text-white');
                    gridBtn?.classList.add('bg-gray-100', 'text-gray-600');
                }

                renderProjectsList(allProjectsData);
            }

            function updateProjectStats(projects) {
                try {
                    if (!projects) projects = [];

                    const stats = {
                        new: 0,
                        designing: 0,
                        boc_tach: 0,
                        deadline: 0
                    };

                    projects.forEach(project => {
                        const status = (project.status || 'new').toLowerCase();
                        if (status === 'new') {
                            stats.new++;
                        } else if (status === 'designing' || status === 'design') {
                            stats.designing++;
                        } else if (status === 'boc_tach' || status === 'bóc tách' || status === 'boc-tach') {
                            stats.boc_tach++;
                        }

                        // Check deadline approaching (within 7 days)
                        if (project.deadline) {
                            try {
                                const deadline = new Date(project.deadline);
                                if (!isNaN(deadline.getTime())) {
                                    deadline.setHours(0, 0, 0, 0);
                                    const today = new Date();
                                    today.setHours(0, 0, 0, 0);
                                    const diffDays = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                                    if (diffDays >= 0 && diffDays <= 7) {
                                        stats.deadline++;
                                    }
                                }
                            } catch (e) {
                                console.warn('Invalid deadline:', project.deadline, e);
                            }
                        }
                    });

                    // Stats calculation kept for reference, but UI elements removed
                    console.log('📊 Stats calculated:', stats, `(from ${projects.length} projects)`);
                    return stats;
                } catch (error) {
                    console.error('❌ Error updating project stats:', error);
                    return null;
                }
            }

            function renderProjectsList(projects) {
                try {
                    if (!projects) projects = [];
                    console.log(`🔄 renderProjectsList: ${projects.length} projects`);

                    allProjectsData = projects;
                    const filtered = filterProjectsData(projects);

                    console.log(`🔍 After filtering: ${filtered.length} projects`);
                    const filteredEl = document.getElementById('step1FilteredProjects');
                    if (filteredEl) {
                        filteredEl.textContent = filtered.length;
                    }

                    if (filtered.length === 0) {
                        console.log('📭 No projects to display, showing empty state');
                        const gridView = document.getElementById('projectsGridView');
                        const listView = document.getElementById('projectsListView');
                        const emptyState = document.getElementById('projectsEmptyState');
                        if (gridView) gridView.classList.add('hidden');
                        if (listView) listView.classList.add('hidden');
                        if (emptyState) emptyState.classList.remove('hidden');
                        return;
                    }

                    // Hide empty state
                    const emptyState = document.getElementById('projectsEmptyState');
                    if (emptyState) emptyState.classList.add('hidden');

                    // Render based on current view mode
                    if (currentViewMode === 'grid') {
                        console.log('🎨 Rendering grid view');
                        renderProjectsGrid(filtered);
                    } else {
                        console.log('📋 Rendering list view');
                        renderProjectsListView(filtered);
                    }
                } catch (error) {
                    console.error('❌ Error in renderProjectsList:', error);
                    console.error('Stack:', error.stack);
                }
            }

            function renderProjectsListView(projects) {
                const container = document.getElementById('projectsListView');
                if (!container) {
                    console.error('❌ projectsListView container not found!');
                    return;
                }

                console.log(`📋 Rendering ${projects.length} projects in list view`);

                // Render projects
                container.innerHTML = projects.map(project => createProjectCard(project, 'list')).join('');

                // Show container and hide grid view
                container.classList.remove('hidden');
                const gridView = document.getElementById('projectsGridView');
                if (gridView) gridView.classList.add('hidden');
                console.log(`✅ List view rendered with ${projects.length} projects`);
            }

            function renderProjectsGrid(projects) {
                const container = document.getElementById('projectsGridView');
                if (!container) {
                    console.error('❌ projectsGridView container not found!');
                    return;
                }

                console.log(`🎨 Rendering ${projects.length} projects in grid view`);

                // Clear loading state
                if (container.innerHTML.includes('Đang tải')) {
                    container.innerHTML = '';
                }

                // Render projects
                container.innerHTML = projects.map(project => createProjectCard(project, 'grid')).join('');

                // Show container and hide list view
                container.classList.remove('hidden');
                const listView = document.getElementById('projectsListView');
                if (listView) listView.classList.add('hidden');

                console.log(`✅ Grid view rendered with ${projects.length} projects`);
            }

            function createProjectCard(project, viewMode = 'grid') {
                const status = (project.status || 'new').toLowerCase();
                const progress = project.progress_percent || 0;
                const startDate = project.start_date ? new Date(project.start_date).toLocaleDateString('vi-VN') : '—';
                const deadline = project.deadline ? new Date(project.deadline).toLocaleDateString('vi-VN') : '—';
                const deadlineApproaching = isDeadlineApproaching(project.deadline);

                // Safe JSON encoding for onclick
                const projectDataJson = JSON.stringify(project).replace(/"/g, '&quot;').replace(/'/g, '&#39;');

                // Status badge
                let statusBadgeClass, statusText, statusIcon;
                switch (status) {
                    case 'new':
                        statusBadgeClass = 'bg-blue-100 text-blue-700 border-blue-200';
                        statusText = 'Mới tạo';
                        statusIcon = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>';
                        break;
                    case 'designing':
                    case 'design':
                        statusBadgeClass = 'bg-purple-100 text-purple-700 border-purple-200';
                        statusText = 'Đang thiết kế';
                        statusIcon = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>';
                        break;
                    case 'boc_tach':
                        statusBadgeClass = 'bg-yellow-100 text-yellow-700 border-yellow-200';
                        statusText = 'Đang bóc tách';
                        statusIcon = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>';
                        break;
                    default:
                        statusBadgeClass = 'bg-gray-100 text-gray-700 border-gray-200';
                        statusText = status;
                        statusIcon = '';
                }

                // Progress color
                let progressColor = 'bg-gray-400';
                if (progress >= 75) progressColor = 'bg-green-500';
                else if (progress >= 50) progressColor = 'bg-blue-500';
                else if (progress >= 25) progressColor = 'bg-yellow-500';
                else progressColor = 'bg-gray-400';

                if (viewMode === 'list') {
                    return `
                    <div class="project-card bg-white border border-gray-200 rounded-lg p-5 hover:shadow-lg transition-all cursor-pointer"
                         onclick="selectProject(${project.id}, '${escapeHtml(project.project_name || '')}', '${escapeHtml(project.project_code || '')}', ${projectDataJson})"
                     data-project-status="${status}"
                         data-customer="${escapeHtml(project.customer_name || '')}"
                         data-project-name="${escapeHtml(project.project_name || '')}"
                         data-project-code="${escapeHtml(project.project_code || '')}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="flex-shrink-0">
                                    <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-lg flex items-center justify-center text-white font-bold text-xl">
                                        ${(project.project_code || 'P').substring(0, 2).toUpperCase()}
                        </div>
                    </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-lg font-bold text-gray-900 mb-1 truncate">${escapeHtml(project.project_name || 'Dự án')}</h3>
                                    <p class="text-sm text-gray-500 mb-2">${escapeHtml(project.project_code || 'N/A')}</p>
                                    <div class="flex items-center gap-4 text-sm text-gray-600">
                                        <span class="flex items-center gap-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                            </svg>
                                            ${escapeHtml(project.customer_name || 'N/A')}
                                        </span>
                                        <span class="flex items-center gap-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            ${deadline}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-right">
                                    <div class="text-sm text-gray-500 mb-1">Tiến độ</div>
                                    <div class="text-xl font-bold text-gray-900">${progress}%</div>
                                    <div class="w-24 bg-gray-200 rounded-full h-2 mt-1">
                                        <div class="${progressColor} h-2 rounded-full transition-all" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                                <span class="${statusBadgeClass} border px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1.5">
                                    ${statusIcon}
                                    ${statusText}
                                </span>
                                <button onclick="event.stopPropagation(); viewProjectDetails(${project.id})" 
                                    class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                </button>
                            </div>
                    </div>
                </div>
                `;
                }

                // Grid view
                return `
                <div class="project-card bg-white border-2 border-gray-200 rounded-xl p-5 hover:border-purple-500 hover:shadow-xl transition-all cursor-pointer group"
                     onclick="selectProject(${project.id}, '${escapeHtml(project.project_name || '')}', '${escapeHtml(project.project_code || '')}', ${projectDataJson})"
                     data-project-status="${status}"
                     data-customer="${escapeHtml(project.customer_name || '')}"
                     data-project-name="${escapeHtml(project.project_name || '')}"
                     data-project-code="${escapeHtml(project.project_code || '')}">
                    <!-- Header -->
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-lg flex items-center justify-center text-white font-bold text-lg flex-shrink-0">
                                    ${(project.project_code || 'P').substring(0, 2).toUpperCase()}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-bold text-lg text-gray-900 truncate group-hover:text-purple-600 transition-colors">${escapeHtml(project.project_name || 'Dự án')}</h3>
                                    <p class="text-sm text-gray-500">${escapeHtml(project.project_code || 'N/A')}</p>
                                </div>
                            </div>
                        </div>
                        <span class="${statusBadgeClass} border px-2.5 py-1 rounded-lg text-xs font-medium flex items-center gap-1 flex-shrink-0">
                            ${statusIcon}
                            ${statusText}
                        </span>
                    </div>
                    
                    <!-- Customer Info -->
                    <div class="mb-4 pb-4 border-b border-gray-100">
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <span class="truncate">${escapeHtml(project.customer_name || 'N/A')}</span>
                        </div>
                    </div>
                    
                    <!-- Progress -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between text-sm mb-2">
                            <span class="text-gray-600 font-medium">Tiến độ</span>
                            <span class="font-bold text-gray-900">${progress}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="${progressColor} h-2.5 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    
                    <!-- Dates -->
                    <div class="grid grid-cols-2 gap-3 text-xs">
                        <div>
                            <div class="text-gray-500 mb-1">Ngày bắt đầu</div>
                            <div class="font-medium text-gray-700">${startDate}</div>
                        </div>
                        <div>
                            <div class="text-gray-500 flex items-center gap-1">
                                Deadline
                                ${deadlineApproaching ? '<span class="text-red-500">⚠️</span>' : ''}
                            </div>
                            <div class="font-medium ${deadlineApproaching ? 'text-red-600' : 'text-gray-700'}">${deadline}</div>
                        </div>
                    </div>
                    
                    <!-- Action Button -->
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <button onclick="event.stopPropagation(); selectProject(${project.id}, '${escapeHtml(project.project_name || '')}', '${escapeHtml(project.project_code || '')}', ${projectDataJson})"
                            class="w-full px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-medium hover:from-purple-700 hover:to-indigo-700 transition-all flex items-center justify-center gap-2">
                            <span>Chọn dự án</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            }

            function filterProjectsData(projects) {
                const searchTerm = (document.getElementById('projectSearch')?.value || '').toLowerCase();
                const statusFilter = document.getElementById('projectStatusFilter')?.value || 'all';
                const customerFilter = document.getElementById('projectCustomerFilter')?.value || 'all';

                return projects.filter(project => {
                    const text = `${project.project_name || ''} ${project.project_code || ''} ${project.customer_name || ''}`.toLowerCase();
                    const status = (project.status || 'new').toLowerCase();
                    const customer = (project.customer_name || '').toLowerCase();

                    const searchMatch = !searchTerm || text.includes(searchTerm);
                    const statusMatch = statusFilter === 'all' || status === statusFilter;
                    const customerMatch = customerFilter === 'all' || customer === customerFilter.toLowerCase();

                    return searchMatch && statusMatch && customerMatch;
                });
            }

            function filterProjects() {
                if (!allProjectsData || allProjectsData.length === 0) return;
                const filtered = filterProjectsData(allProjectsData);
                renderProjectsList(filtered);
            }

            function sortProjects() {
                const sortBy = document.getElementById('projectSortBy')?.value || 'name';
                let sorted = [...allProjectsData];

                switch (sortBy) {
                    case 'name':
                        sorted.sort((a, b) => (a.project_name || '').localeCompare(b.project_name || ''));
                        break;
                    case 'name_desc':
                        sorted.sort((a, b) => (b.project_name || '').localeCompare(a.project_name || ''));
                        break;
                    case 'date_new':
                        sorted.sort((a, b) => new Date(b.start_date || 0) - new Date(a.start_date || 0));
                        break;
                    case 'date_old':
                        sorted.sort((a, b) => new Date(a.start_date || 0) - new Date(b.start_date || 0));
                        break;
                    case 'deadline':
                        sorted.sort((a, b) => {
                            const aDeadline = a.deadline ? new Date(a.deadline) : new Date('9999-12-31');
                            const bDeadline = b.deadline ? new Date(b.deadline) : new Date('9999-12-31');
                            return aDeadline - bDeadline;
                        });
                        break;
                    case 'progress':
                        sorted.sort((a, b) => (b.progress_percent || 0) - (a.progress_percent || 0));
                        break;
                }

                allProjectsData = sorted;
                filterProjects();
            }

            function clearFilters() {
                document.getElementById('projectSearch').value = '';
                document.getElementById('projectStatusFilter').value = 'all';
                document.getElementById('projectCustomerFilter').value = 'all';
                filterProjects();
            }

            function viewProjectDetails(projectId) {
                // Open project modal or navigate to project page
                console.log('Xem chi tiết dự án ID:', projectId);
            }

            async function selectProject(projectId, projectName, projectCode, projectData) {
                // Lấy thông tin đầy đủ từ API nếu chưa có
                if (!projectData) {
                    try {
                        const response = await fetch(`${API_BASE}/projects/${projectId}`);
                        const result = await response.json();
                        if (result.success) {
                            projectData = result.data;
                        }
                    } catch (error) {
                        console.error('Error loading project details:', error);
                    }
                }

                currentProject = {
                    id: projectId,
                    name: projectName,
                    code: projectCode,
                    ...projectData
                };

                // Đảm bảo location/address được map đúng
                // API có thể trả về location, address, hoặc customer_address
                if (projectData) {
                    currentProject.location = projectData.location || projectData.address || projectData.customer_address || '';
                    currentProject.address = projectData.address || projectData.location || projectData.customer_address || '';
                }

                console.log('📋 Current project data:', {
                    id: currentProject.id,
                    name: currentProject.name,
                    location: currentProject.location,
                    address: currentProject.address,
                    customer_address: currentProject.customer_address
                });

                // Clear old design files when switching projects
                uploadedDesignFiles = [];
                sessionStorage.removeItem('uploadedDesignFiles');
                sessionStorage.removeItem('uploadedDesignFiles_projectId');

                // Save to session
                sessionStorage.setItem('currentProject', JSON.stringify(currentProject));
                console.log('💾 Saved currentProject to sessionStorage');

                // Update selected project name if element exists
                const selectedProjectNameEl = document.getElementById('selectedProjectName');
                if (selectedProjectNameEl) {
                    selectedProjectNameEl.textContent = `${projectName} (${projectCode})`;
                }

                // Load quotation items for design (API mới)
                await loadQuotationItemsForDesign(projectId);

                // Tự động chuyển sang step 2 (hàm goToStep sẽ tự động cập nhật step indicators)
                // Không cần gọi updateStepIndicators(1) vì goToStep(2) sẽ gọi updateStepIndicators(2)
                goToStep(2);

                // Update dashboard
                setTimeout(() => {
                    updateProjectCard();
                    const dashboardEl = document.getElementById('dashboardOverview');
                    if (dashboardEl) dashboardEl.classList.remove('hidden');
                }, 500);
            }

            // Note: Product edit functions (openEditProductModal, cancelEditProduct, saveEditProduct, updateProductItem, deleteProductItem) 
            // are defined in global scope below

            function openAddProductModal() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước');
                    return;
                }

                // Kiểm tra xem có row nào đang edit không
                const existingNewRow = document.getElementById('newProductRow');
                if (existingNewRow) {
                    alert('Vui lòng lưu hoặc hủy sản phẩm đang thêm');
                    return;
                }

                const existingEditRow = document.querySelector('tr.bg-yellow-50');
                if (existingEditRow) {
                    alert('Vui lòng lưu hoặc hủy sản phẩm đang sửa');
                    return;
                }

                const tbody = document.getElementById('productsTableBody');
                const emptyState = document.getElementById('emptyProductsState');

                if (emptyState) emptyState.classList.add('hidden');

                // Thêm row mới với input fields
                const newRow = document.createElement('tr');
                newRow.className = 'bg-blue-50 border-2 border-blue-300';
                newRow.id = 'newProductRow';
                newRow.innerHTML = `
                <td class="px-2 py-3 text-center text-sm text-gray-600">*</td>
                <td class="px-2 py-3 text-center">
                    <textarea id="newProductSymbol" placeholder="C01" rows="1"
                        class="w-full px-2 py-1 border border-gray-300 rounded text-center text-sm focus:ring-2 focus:ring-blue-500 resize-none"
                        oninput="autoResizeTextarea(this)"></textarea>
                </td>
                <td class="px-3 py-3">
                    <textarea id="newProductName" placeholder="VD: Cửa sổ 2 cánh mở quay..." rows="2"
                        class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 resize-none"
                        oninput="autoResizeTextarea(this)"></textarea>
                </td>
                <td class="px-2 py-3 text-center">
                    <input type="text" id="newProductColor" placeholder="Trắng sứ"
                        class="w-full min-w-[60px] px-2 py-1 border border-gray-300 rounded text-center text-sm focus:ring-2 focus:ring-blue-500"
                        oninput="autoResizeInput(this)">
                </td>
                <td class="px-2 py-3 text-center">
                    <input type="text" id="newProductGlass" placeholder="5+9A+5"
                        class="w-full min-w-[60px] px-2 py-1 border border-gray-300 rounded text-center text-sm focus:ring-2 focus:ring-blue-500"
                        oninput="autoResizeInput(this)">
                </td>
                <td class="px-2 py-3 text-center">
                    <input type="text" id="newProductAccessories" placeholder="Phụ kiện"
                        class="w-full min-w-[60px] px-2 py-1 border border-gray-300 rounded text-center text-sm focus:ring-2 focus:ring-blue-500"
                        oninput="autoResizeInput(this)">
                </td>
                <td class="px-2 py-3 text-center">
                    <input type="text" id="newProductSystem" placeholder="Hệ nhôm"
                        class="w-full min-w-[60px] px-2 py-1 border border-gray-300 rounded text-center text-sm focus:ring-2 focus:ring-blue-500"
                        oninput="autoResizeInput(this)">
                </td>
                <td class="px-2 py-3 text-center">
                    <input type="number" id="newProductQuantity" value="1" min="1" 
                        class="w-16 px-2 py-1 border border-gray-300 rounded text-center focus:ring-2 focus:ring-blue-500">
                </td>
                <td class="px-2 py-3">
                    <input type="text" id="newProductLocation" placeholder="Phòng khách..."
                        class="w-full min-w-[60px] px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                        oninput="autoResizeInput(this)">
                </td>
                <td class="px-2 py-3 text-center whitespace-nowrap">
                    <button onclick="saveNewProduct()" 
                        class="text-green-600 hover:text-green-800 mr-1" title="Lưu">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M5 13l4 4L19 7" />
                        </svg>
                    </button>
                    <button onclick="cancelNewProduct()" 
                        class="text-red-600 hover:text-red-800" title="Hủy">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </td>
            `;

                // Insert at the beginning (so it appears at top)
                if (tbody.firstChild) {
                    tbody.insertBefore(newRow, tbody.firstChild);
                } else {
                    tbody.appendChild(newRow);
                }

                // Focus on first input
                const firstInput = document.getElementById('newProductSymbol');
                if (firstInput) firstInput.focus();
            }

            function cancelNewProduct() {
                const newRow = document.getElementById('newProductRow');
                if (newRow) newRow.remove();

                // Check if table is empty and show empty state
                const tbody = document.getElementById('productsTableBody');
                const emptyState = document.getElementById('emptyProductsState');
                if (tbody && tbody.children.length === 0 && emptyState) {
                    emptyState.classList.remove('hidden');
                }
            }

            function saveNewProduct() {
                const symbol = document.getElementById('newProductSymbol')?.value?.trim() || '';
                const name = document.getElementById('newProductName')?.value?.trim() || '';
                const color = document.getElementById('newProductColor')?.value?.trim() || '';
                const glass = document.getElementById('newProductGlass')?.value?.trim() || '';
                const accessories = document.getElementById('newProductAccessories')?.value?.trim() || '';
                const system = document.getElementById('newProductSystem')?.value?.trim() || '';
                const quantityEl = document.getElementById('newProductQuantity');
                const quantity = quantityEl ? parseInt(quantityEl.value) || 1 : 1;
                const location = document.getElementById('newProductLocation')?.value?.trim() || '';

                // Không bắt buộc nhập hết - cho phép thêm với thông tin tối thiểu
                const itemName = name || symbol || 'Sản phẩm mới';

                addProductItem({
                    item_name: itemName,
                    product_code: symbol || '',
                    color: color || null,
                    glass_type: glass || null,
                    accessories: accessories || null,
                    aluminum_system: system || null,
                    quantity: quantity,
                    location: location || '',
                    notes: `Màu: ${color || '-'}, Kính: ${glass || '-'}, Hệ: ${system || '-'}, Phụ kiện: ${accessories || '-'}`
                });
            }

            async function addProductItem(data) {
                try {
                    let quotationId = currentProject?.quotation_id;

                    // Nếu chưa có quotation_id, tự động tạo quotation từ project
                    if (!quotationId) {
                        console.log('Chưa có quotation_id, tạo quotation mới cho project');
                        const createResponse = await fetch(`${API_BASE}/quotations`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                project_id: currentProject.project_id || currentProject.id
                            })
                        });
                        const createResult = await createResponse.json();

                        if (createResult.success && createResult.data) {
                            quotationId = createResult.data.id;
                            currentProject.quotation_id = quotationId;
                            console.log('Đã tạo quotation mới với ID:', quotationId);
                        } else if (createResult.data && createResult.data.quotation_id) {
                            // Trường hợp đã có quotation, dùng quotation_id trả về
                            quotationId = createResult.data.quotation_id;
                            currentProject.quotation_id = quotationId;
                            console.log('Sử dụng quotation đã tồn tại:', quotationId);
                        } else {
                            alert('Lỗi tạo báo giá: ' + (createResult.message || 'Không thể tạo'));
                            return;
                        }
                    }

                    console.log('Adding item to quotation:', quotationId, data);

                    const response = await fetch(`${API_BASE}/quotations/${quotationId}/items`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ...data,
                            product_type: 'door_swing',
                            unit_price: 0
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        // Remove new row
                        const newRow = document.getElementById('newProductRow');
                        if (newRow) newRow.remove();

                        // Refresh product list
                        refreshProductList();

                        // Show success message
                        showToast('Thêm sản phẩm thành công!', 'success');
                    } else {
                        console.error('Add item failed:', result);
                        alert('Lỗi: ' + (result.message || 'Không thể thêm'));
                    }
                } catch (error) {
                    console.error('Error adding product:', error);
                    alert('Lỗi kết nối đến server: ' + error.message);
                }
            }

            function openImage(imageUrl) {
                // Open image in modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
                modal.onclick = () => modal.remove();
                modal.innerHTML = `
                    <div class="relative max-w-4xl max-h-[90vh] p-4" onclick="event.stopPropagation()">
                        <img src="${imageUrl}" alt="Preview" class="max-w-full max-h-[85vh] object-contain rounded-lg">
                        <button onclick="this.closest('.fixed').remove()" 
                        class="absolute top-2 right-2 bg-white rounded-full p-2 shadow-lg hover:bg-gray-100">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `;
                document.body.appendChild(modal);
            }

            // Auto-resize textarea based on content
            function autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
            }

            // Note: uploadedDesignFiles is already declared at line 2437

            async function loadDesignFiles() {
                if (!currentProject) return;

                try {
                    const projectId = currentProject.project_id || currentProject.id;
                    console.log(`📂 Loading design files from server for project ${projectId}`);

                    // Get list of files from server uploads folder
                    const response = await fetch(`${API_BASE}/upload/design/${projectId}`);
                    const result = await response.json();

                    if (result.success && result.files && result.files.length > 0) {
                        console.log(`✅ Loaded ${result.files.length} files from server`);

                        // Merge with existing files
                        const existingUrls = new Set(uploadedDesignFiles.map(f => f.url));
                        const newFiles = result.files.filter(f => !existingUrls.has(f.url));

                        uploadedDesignFiles = [
                            ...uploadedDesignFiles,
                            ...newFiles.map(file => ({
                                name: file.name,
                                url: file.url,
                                type: file.type,
                                size: file.size,
                                serverUrl: file.url
                            }))
                        ];

                        if (newFiles.length > 0) {
                            console.log(`➕ Added ${newFiles.length} new files from server`);
                        }
                    } else {
                        console.log('ℹ️ No files found on server');
                    }
                } catch (error) {
                    console.error('Error loading design files from server:', error);
                    // Fallback to sessionStorage (đã có sẵn)
                }
            }

            function openDesignUpload() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!\n\nVui lòng quay lại Bước 1 để chọn dự án trước khi tải bản thiết kế.');
                    console.warn('openDesignUpload called but currentProject is null');
                    return;
                }

                console.log('Opening design upload for project:', currentProject);

                // Tạo input file ẩn
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.accept = '.pdf,.dwg,.dxf,image/*';

                input.onchange = async (e) => {
                    e.preventDefault();
                    e.stopPropagation(); // Ngăn event bubble

                    const files = Array.from(e.target.files);
                    if (files.length === 0) {
                        input.value = ''; // Reset input
                        return;
                    }

                    console.log(`📁 Processing ${files.length} files`);
                    let successCount = 0;
                    let errorCount = 0;

                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];

                        try {
                            console.log(`📄 Processing file ${i + 1}/${files.length}: ${file.name} (${Math.round(file.size / 1024)}KB)`);

                            // Tạo URL local để xem (không cần upload)
                            const localUrl = URL.createObjectURL(file);

                            // Thêm vào danh sách - LƯU TÊN GỐC NGAY TỪ ĐẦU
                            uploadedDesignFiles.push({
                                name: file.name,  // Tên gốc từ máy tính
                                originalName: file.name,  // Tên gốc (sẽ được cập nhật sau khi upload)
                                url: localUrl,
                                type: file.type,
                                size: file.size,
                                file: file // Lưu file object để upload sau
                            });

                            // Upload lên server - BẮT BUỘC để lưu file
                            try {
                                const formData = new FormData();
                                formData.append('design', file);

                                const projectId = currentProject.project_id || currentProject.id;

                                console.log(`📤 Uploading ${file.name} to server...`);
                                const uploadResponse = await fetch(`${API_BASE}/upload/design/${projectId}`, {
                                    method: 'POST',
                                    body: formData
                                });

                                if (uploadResponse.ok) {
                                    const uploadResult = await uploadResponse.json();
                                    console.log('📥 Upload response:', uploadResult);

                                    if (uploadResult.success && uploadResult.fileUrl) {
                                        // Cập nhật thông tin file từ server
                                        const fileIndex = uploadedDesignFiles.length - 1;
                                        uploadedDesignFiles[fileIndex].serverUrl = uploadResult.fileUrl;
                                        uploadedDesignFiles[fileIndex].serverFilename = uploadResult.filename;

                                        // QUAN TRỌNG: Ưu tiên originalName từ server, nếu không có thì dùng tên gốc từ file
                                        uploadedDesignFiles[fileIndex].originalName = uploadResult.originalName || file.name;
                                        uploadedDesignFiles[fileIndex].uploaded = true;

                                        // Dùng serverUrl làm url chính để hiển thị
                                        uploadedDesignFiles[fileIndex].url = uploadResult.fileUrl;

                                        console.log(`✅ Uploaded "${file.name}" to server as "${uploadResult.filename}"`);
                                        console.log(`   Original name: "${uploadResult.originalName || file.name}"`);
                                        successCount++;
                                    } else {
                                        console.warn(`⚠️ ${file.name} response không thành công:`, uploadResult);
                                        errorCount++;
                                    }
                                } else {
                                    const errorText = await uploadResponse.text();
                                    let errorData;
                                    try {
                                        errorData = JSON.parse(errorText);
                                    } catch (e) {
                                        errorData = { message: errorText };
                                    }
                                    console.error(`❌ Upload ${file.name} failed với status ${uploadResponse.status}:`, errorData);
                                    errorCount++;
                                    throw new Error(`Upload failed: ${errorData.message || uploadResponse.statusText}`);
                                }
                            } catch (uploadError) {
                                console.error('❌ Upload to server failed:', uploadError);
                                errorCount++;
                                // Vẫn giữ file trong danh sách với blob URL tạm thời
                            }
                        } catch (error) {
                            console.error('File processing error:', error);
                            errorCount++;
                        }
                    }

                    console.log(`📊 Upload summary: ${successCount} success, ${errorCount} errors out of ${files.length} files`);

                    // Update display ngay lập tức
                    renderDesignFiles();

                    // Save to sessionStorage WITH PROJECT ID - Lưu đầy đủ thông tin
                    try {
                        const projectId = (currentProject.project_id || currentProject.id).toString();
                        const filesToSave = uploadedDesignFiles.map(f => ({
                            name: f.name || f.originalName,
                            originalName: f.originalName || f.name,
                            url: f.serverUrl || f.url, // Ưu tiên serverUrl
                            serverUrl: f.serverUrl,
                            serverFilename: f.serverFilename,
                            type: f.type,
                            size: f.size,
                            uploaded: f.uploaded || false
                        }));
                        sessionStorage.setItem('uploadedDesignFiles', JSON.stringify(filesToSave));
                        sessionStorage.setItem('uploadedDesignFiles_projectId', projectId);
                        console.log('💾 Saved uploadedDesignFiles to sessionStorage for project', projectId, filesToSave);
                    } catch (e) {
                        console.error('❌ Could not save files to sessionStorage:', e);
                    }

                    // Hiển thị thông báo
                    if (successCount > 0) {
                        showToast(`Đã upload ${successCount}/${files.length} file thiết kế thành công!`, 'success');
                    } else {
                        showToast(`Lỗi khi upload ${files.length} file thiết kế. Vui lòng thử lại.`, 'error');
                    }

                    // Reset input để có thể upload lại file cùng tên
                    input.value = '';
                };

                input.click();
            }

            // Load design files from server for current project
            async function loadDesignFilesFromServer() {
                if (!currentProject) {
                    console.warn('⚠️ loadDesignFilesFromServer: No project selected');
                    // Fallback to sessionStorage
                    loadDesignFilesFromSession();
                    return;
                }

                const projectId = currentProject.id || currentProject.project_id;
                console.log('📂 Loading design files from server for project:', projectId);

                try {
                    // Thử load từ route list files
                    const response = await fetch(`${API_BASE}/upload/design/${projectId}/list`);

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.files && result.files.length > 0) {
                            // Map server files to uploadedDesignFiles format
                            // QUAN TRỌNG: Server trả về cả name (unique) và originalName (tên gốc)
                            uploadedDesignFiles = result.files.map(file => {
                                console.log('📄 File from server:', {
                                    name: file.name,
                                    originalName: file.originalName,
                                    url: file.url
                                });

                                return {
                                    name: file.name,  // Tên unique trên server
                                    originalName: file.originalName || file.name,  // Tên gốc để hiển thị (fallback về name nếu không có)
                                    url: file.url,
                                    serverUrl: file.url,
                                    serverFilename: file.name,  // Lưu tên unique để xóa
                                    type: file.type || 'application/octet-stream',
                                    size: file.size || 0,
                                    uploaded: true
                                };
                            });
                            console.log(`✅ Loaded ${uploadedDesignFiles.length} design files from server`);
                            console.log('📋 Files with originalName:', uploadedDesignFiles.map(f => ({
                                serverName: f.name,
                                originalName: f.originalName
                            })));

                            // Lưu vào sessionStorage
                            try {
                                const filesToSave = uploadedDesignFiles.map(f => ({
                                    name: f.name,
                                    originalName: f.originalName,
                                    url: f.url,
                                    serverUrl: f.serverUrl,
                                    type: f.type,
                                    size: f.size,
                                    uploaded: f.uploaded
                                }));
                                sessionStorage.setItem('uploadedDesignFiles', JSON.stringify(filesToSave));
                                sessionStorage.setItem('uploadedDesignFiles_projectId', projectId.toString());
                            } catch (e) {
                                console.warn('Could not save to sessionStorage:', e);
                            }

                            renderDesignFiles();
                            return;
                        }
                    }

                    // Nếu không có file từ server, thử load từ sessionStorage
                    console.log('📂 No design files found on server, trying sessionStorage...');
                    loadDesignFilesFromSession();
                } catch (error) {
                    console.warn('⚠️ Error loading design files from server:', error.message);
                    // Fallback to sessionStorage
                    loadDesignFilesFromSession();
                }
            }

            // Fallback: Load design files from sessionStorage
            function loadDesignFilesFromSession() {
                const projectId = currentProject?.id || currentProject?.project_id;
                const savedProjectId = sessionStorage.getItem('uploadedDesignFiles_projectId');
                const savedFiles = sessionStorage.getItem('uploadedDesignFiles');

                if (savedFiles && savedProjectId && savedProjectId == projectId) {
                    try {
                        const parsedFiles = JSON.parse(savedFiles);
                        // Đảm bảo có serverUrl hoặc url hợp lệ
                        uploadedDesignFiles = parsedFiles.map(f => ({
                            name: f.name || f.originalName,
                            originalName: f.originalName || f.name,
                            url: f.serverUrl || f.url, // Ưu tiên serverUrl
                            serverUrl: f.serverUrl || f.url,
                            serverFilename: f.serverFilename,
                            type: f.type || 'application/octet-stream',
                            size: f.size || 0,
                            uploaded: f.uploaded !== undefined ? f.uploaded : (f.serverUrl ? true : false)
                        }));
                        console.log(`✅ Loaded ${uploadedDesignFiles.length} design files from sessionStorage for project ${projectId}`);
                        renderDesignFiles();
                    } catch (e) {
                        console.error('❌ Error parsing saved files:', e);
                        uploadedDesignFiles = [];
                        renderDesignFiles();
                    }
                } else {
                    if (!savedFiles) {
                        console.log('📂 No files in sessionStorage');
                    } else if (savedProjectId != projectId) {
                        console.log(`📂 Saved files are for project ${savedProjectId}, current is ${projectId}`);
                    }
                    uploadedDesignFiles = [];
                    renderDesignFiles();
                }
            }

            function renderDesignFiles() {
                const container = document.getElementById('designFilesList');
                if (!container) {
                    console.warn('⚠️ designFilesList container not found');
                    return;
                }

                if (uploadedDesignFiles.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                console.log('Rendering', uploadedDesignFiles.length, 'design files');

                container.innerHTML = uploadedDesignFiles.map((file, index) => {
                    // Dùng serverUrl nếu có, nếu không thì dùng url (blob URL)
                    const fileUrl = file.serverUrl || file.url;

                    // QUAN TRỌNG: Ưu tiên hiển thị originalName (tên gốc) thay vì name (tên unique)
                    const displayFileName = file.originalName || file.name || 'Unknown';
                    const ext = displayFileName.toLowerCase().split('.').pop();
                    let icon = '📄';
                    let canPreview = true;

                    if (ext === 'pdf') icon = '📕';
                    else if (ext === 'dwg' || ext === 'dxf') {
                        icon = '📐';
                        canPreview = false; // DWG không thể xem trực tiếp trong trình duyệt
                    }
                    else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) icon = '🖼️';

                    const displayName = displayFileName.length > 30 ? displayFileName.substring(0, 30) + '...' : displayFileName;
                    const sizeKB = Math.round((file.size || 0) / 1024);

                    // Đảm bảo full URL từ API_BASE nếu là serverUrl
                    let fullUrl = fileUrl;
                    if (file.serverUrl && !fileUrl.startsWith('http')) {
                        fullUrl = `${API_BASE.replace('/api', '')}${fileUrl}`;
                    } else if (!fileUrl.startsWith('http') && !fileUrl.startsWith('blob:')) {
                        fullUrl = `${API_BASE.replace('/api', '')}${fileUrl}`;
                    }

                    // Dùng originalName cho download attribute
                    const downloadName = file.originalName || file.name || 'file';

                    return `
                        <div class="flex items-center justify-between p-1 bg-blue-50 border border-blue-200 rounded-lg overflow-hidden">
                        <a href="${fullUrl}" target="_blank" ${canPreview ? '' : `download="${downloadName}"`}
                               class="inline-flex items-center gap-1 px-3 py-1.5 text-blue-700 hover:bg-blue-100 transition-colors"
                               title="${canPreview ? 'Xem' : 'Tải xuống'}: ${displayName} (${sizeKB}KB)">
                            <span>${icon}</span>
                            <span>${displayName}</span>
                            ${file.uploaded ? '<span class="text-xs text-green-600">✓</span>' : ''}
                            ${canPreview ? '<span class="text-xs opacity-70">👁️</span>' : '<span class="text-xs opacity-70">⬇️</span>'}
                        </a>
                        <button onclick="deleteDesignFileByName('${(file.serverFilename || file.name || displayFileName).replace(/'/g, "\\'")}')" 
                                    class="px-2 py-1 text-red-600 hover:bg-red-100 transition-colors rounded"
                                title="Xóa file">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                `;
                }).join('');
            }

            async function deleteDesignFileByName(filename) {
                if (!confirm('Bạn có chắc muốn xóa file này?')) return;

                console.log('🗑️ Attempting to delete file:', filename);
                console.log('Current uploadedDesignFiles:', uploadedDesignFiles);

                // Tìm file trong array theo serverFilename (tên unique) hoặc name
                // filename được truyền vào là serverFilename (tên unique trên server)
                const fileIndex = uploadedDesignFiles.findIndex(f =>
                    f.serverFilename === filename || f.name === filename
                );

                if (fileIndex === -1) {
                    console.error('❌ File not found in array:', filename);
                    alert('Không tìm thấy file. Vui lòng reload trang.');
                    return;
                }

                const loadedDesignFile = uploadedDesignFiles[fileIndex];
                console.log('File to delete:', loadedDesignFile);

                // Lấy tên unique trên server để xóa (serverFilename hoặc name)
                const serverFilename = loadedDesignFile.serverFilename || loadedDesignFile.name || filename;

                // Xóa file trên server
                if (currentProject) {
                    try {
                        const projectId = currentProject.project_id || currentProject.id;

                        // Encode filename để xử lý ký tự đặc biệt
                        const encodedFilename = encodeURIComponent(serverFilename);
                        const response = await fetch(`${API_BASE}/upload/design/${projectId}/${encodedFilename}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            console.log('✅ Deleted file from server:', serverFilename);
                        } else {
                            const errorText = await response.text();
                            console.warn('⚠️ Could not delete file from server:', errorText);
                        }
                    } catch (error) {
                        console.error('Error deleting file from server:', error);
                    }
                }

                // Xóa khỏi array
                uploadedDesignFiles.splice(fileIndex, 1);
                console.log('✅ Remaining files:', uploadedDesignFiles.length);

                // Cập nhật sessionStorage WITH PROJECT ID
                try {
                    const projectId = (currentProject.project_id || currentProject.id).toString();
                    const filesToSave = uploadedDesignFiles.map(f => ({
                        name: f.name || f.originalName,
                        originalName: f.originalName || f.name,
                        url: f.serverUrl || f.url,
                        serverUrl: f.serverUrl,
                        serverFilename: f.serverFilename,
                        type: f.type,
                        size: f.size,
                        uploaded: f.uploaded || false
                    }));
                    sessionStorage.setItem('uploadedDesignFiles', JSON.stringify(filesToSave));
                    sessionStorage.setItem('uploadedDesignFiles_projectId', projectId);
                } catch (e) {
                    console.warn('Could not save to sessionStorage:', e);
                }

                // Re-render
                renderDesignFiles();
                showToast('Đã xóa file thành công!', 'success');
            }

            // Upload product image
            function uploadProductImage(itemId) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    // Show loading
                    showToast('Đang tải ảnh lên...', 'info');
                    const formData = new FormData();
                    formData.append('image', file);

                    try {
                        const response = await fetch(`${API_BASE}/upload/image/${itemId}`, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        if (result.success) {
                            showToast('Tải ảnh thành công!', 'success');
                            refreshProductList();
                        } else {
                            showToast('Lỗi: ' + result.message, 'error');
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        showToast('Lỗi kết nối server', 'error');
                    }
                };
                input.click();
            }

            // Upload product design PDF
            function uploadProductPDF(itemId) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.pdf';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    // Show loading
                    showToast('Đang tải PDF lên...', 'info');

                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const response = await fetch(`${API_BASE}/upload/design/${itemId}`, {
                            method: 'POST',
                            body: formData
                        });
                        const result = await response.json();
                        if (result.success) {
                            showToast('Tải PDF thiết kế thành công!', 'success');
                            refreshProductList();
                        } else {
                            showToast('Lỗi: ' + result.message, 'error');
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        showToast('Lỗi kết nối server', 'error');
                    }
                };
                input.click();
            }

            // Flag để biết đang reload trang hay không (tránh tự động chuyển step)
            let isPageReloading = false;

            async function loadQuotationItemsForDesign(projectId, options = {}) {
                const { skipAutoStep = false, skipRender = false } = options;

                try {
                    console.log('📥 Loading quotation items for design from server, projectId:', projectId);
                    const response = await fetch(`${API_BASE}/projects/${projectId}/quotation-items-for-design`);
                    const result = await response.json();

                    if (result.success && result.data) {
                        const serverItems = result.data.items || [];
                        console.log('✅ Loaded', serverItems.length, 'items from server');

                        // QUAN TRỌNG: Merge data từ server với local array thay vì overwrite hoàn toàn
                        // Điều này đảm bảo dữ liệu vừa edit không bị mất khi refresh
                        if (quotationItemsForDesign && quotationItemsForDesign.length > 0 && !skipRender) {
                            console.log('🔄 Merging server data with local array (preserving recent edits)...');

                            // Tạo map của local items để merge hiệu quả
                            const localMap = new Map();
                            quotationItemsForDesign.forEach(item => {
                                const key = item.quotation_item_id || item.id;
                                if (key) localMap.set(key, item);
                            });

                            // Merge: Update từ server nhưng giữ lại local data nếu mới hơn
                            serverItems.forEach(serverItem => {
                                const key = serverItem.id || serverItem.quotation_item_id;
                                const localItem = localMap.get(key);

                                if (localItem) {
                                    // So sánh updated_at để quyết định dùng data nào
                                    const localUpdatedAt = localItem.updated_at ? new Date(localItem.updated_at).getTime() : 0;
                                    const serverUpdatedAt = serverItem.updated_at ? new Date(serverItem.updated_at).getTime() : 0;

                                    if (localUpdatedAt > serverUpdatedAt) {
                                        // Local data mới hơn (vừa edit), giữ lại local data
                                        console.log(`⚠️ Keeping local data for item ${key} (local updated: ${localItem.updated_at})`);
                                        // Chỉ update các field không được edit (như id, quotation_id)
                                        Object.assign(localItem, {
                                            id: serverItem.id,
                                            quotation_id: serverItem.quotation_id,
                                            quotation_item_id: serverItem.quotation_item_id || serverItem.id
                                        });
                                    } else {
                                        // Server data mới hơn hoặc bằng, dùng server data
                                        Object.assign(localItem, serverItem);
                                    }
                                } else {
                                    // Item mới từ server, thêm vào
                                    quotationItemsForDesign.push(serverItem);
                                }
                            });

                            // Xóa items không còn trong server (nếu có)
                            const serverIds = new Set(serverItems.map(item => item.id || item.quotation_item_id));
                            quotationItemsForDesign = quotationItemsForDesign.filter(item => {
                                const key = item.quotation_item_id || item.id;
                                return key && serverIds.has(key);
                            });
                        } else {
                            // Nếu không có local data hoặc skipRender, dùng server data trực tiếp
                            quotationItemsForDesign = serverItems;
                        }

                        // Log để debug
                        if (quotationItemsForDesign.length > 0) {
                            console.log('📋 Final merged data:', quotationItemsForDesign.length, 'items');
                            console.log('📋 Sample item data:', quotationItemsForDesign[0]);
                        }

                        // Also update global items array for batch operations
                        items = quotationItemsForDesign.map(item => ({
                            ...item,
                            id: item.project_item_id || item.id || item.door_design_id
                        }));

                        // QUAN TRỌNG: Lưu quotation_id để CRUD items
                        if (result.data.quotation && result.data.quotation.id) {
                            currentProject.quotation_id = result.data.quotation.id;
                            console.log('Loaded quotation_id:', currentProject.quotation_id);
                        }

                        // Lưu currentProject vào sessionStorage để giữ lại khi reload
                        if (currentProject) {
                            sessionStorage.setItem('currentProject', JSON.stringify(currentProject));
                            console.log('💾 Saved currentProject to sessionStorage');
                        }

                        // Lưu quotationItemsForDesign vào sessionStorage để giữ lại khi reload
                        try {
                            sessionStorage.setItem('quotationItemsForDesign', JSON.stringify(quotationItemsForDesign));
                            console.log('💾 Saved quotationItemsForDesign to sessionStorage');
                        } catch (e) {
                            console.warn('Could not save quotationItemsForDesign to sessionStorage:', e);
                        }

                        // Hiển thị thông tin báo giá
                        const quotationInfoEl = document.getElementById('quotationInfo');
                        if (quotationInfoEl && result.data.quotation) {
                            quotationInfoEl.textContent =
                                `Báo giá: ${result.data.quotation.code || 'BG-' + result.data.quotation.id}`;
                        } else if (quotationInfoEl) {
                            quotationInfoEl.textContent = 'Chưa có báo giá';
                        }

                        // Render nếu không skip
                        if (!skipRender) {
                            renderProductCards(quotationItemsForDesign);
                            updateProductTypeSummary(quotationItemsForDesign);

                            // Re-add checkboxes if batch mode is active
                            if (batchMode) {
                                setTimeout(() => addCheckboxesToProducts(), 100);
                            }
                        }

                        // Tự động chuyển sang step 2 "Danh sách sản phẩm" nếu có sản phẩm và đang ở step 1
                        // NHƯNG chỉ khi không phải đang reload trang và không skip auto step
                        if (!skipAutoStep && !isPageReloading) {
                            const currentStep = parseInt(sessionStorage.getItem('currentStep') || '1');
                            if (quotationItemsForDesign.length > 0 && currentStep === 1) {
                                console.log('✅ Có sản phẩm, tự động chuyển sang step 2');
                                goToStep(2);
                            }
                        }
                    } else {
                        console.warn('⚠️ No data returned from server');
                        // KHÔNG reset về [] nếu không có data, giữ lại data cũ
                        if (!quotationItemsForDesign || quotationItemsForDesign.length === 0) {
                            quotationItemsForDesign = [];
                            items = [];
                            if (!skipRender) {
                                renderProductCards([]);
                                updateProductTypeSummary([]);
                            }
                        }
                    }
                } catch (error) {
                    console.error('❌ Error loading quotation items:', error);
                    // KHÔNG reset về [] khi lỗi, giữ lại data cũ nếu có
                    // Chỉ reset nếu thực sự không có data
                    if (!quotationItemsForDesign || quotationItemsForDesign.length === 0) {
                        quotationItemsForDesign = [];
                        items = [];
                        if (!skipRender) {
                            renderProductCards([]);
                            updateProductTypeSummary([]);
                        }
                    }
                }
            }

            let groupingEnabled = false;

            function toggleGrouping() {
                groupingEnabled = document.getElementById('enableGrouping')?.checked || false;
                const productsGrid = document.getElementById('productsGrid');
                const productsGrouped = document.getElementById('productsGrouped');
                const groupFilter = document.getElementById('groupFilter');
                const groupingToggleText = document.getElementById('groupingToggleText');

                if (groupingEnabled) {
                    productsGrid?.classList.add('hidden');
                    productsGrouped?.classList.remove('hidden');
                    groupFilter?.classList.remove('hidden');
                    if (groupingToggleText) groupingToggleText.textContent = 'Hiển thị dạng lưới';
                    renderProductsByGroup(quotationItemsForDesign);
                } else {
                    productsGrid?.classList.remove('hidden');
                    productsGrouped?.classList.add('hidden');
                    groupFilter?.classList.add('hidden');
                    if (groupingToggleText) groupingToggleText.textContent = 'Nhóm theo vị trí';
                    renderProductCards(quotationItemsForDesign);
                }
            }

            function renderProductsByGroup(items) {
                if (!items || items.length === 0) return;

                // Nhóm sản phẩm theo location/floor (nếu có)
                const groups = {};
                items.forEach(item => {
                    const groupKey = item.location || item.floor || item.group || 'Khác';
                    if (!groups[groupKey]) {
                        groups[groupKey] = [];
                    }
                    groups[groupKey].push(item);
                });

                // Render groups
                const container = document.getElementById('productsGrouped');
                const groupFilter = document.getElementById('groupFilter');
                if (!container) return;

                // Update filter dropdown
                if (groupFilter) {
                    groupFilter.innerHTML = '<option value="all">Tất cả nhóm</option>' +
                        Object.keys(groups).sort().map(g => `<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join('');
                }

                container.innerHTML = Object.keys(groups).sort().map(groupName => {
                    const groupItems = groups[groupName];
                    const totalQty = groupItems.reduce((sum, item) => sum + (parseInt(item.quantity || 0)), 0);

                    return `
                        <div class="border border-gray-200 rounded-lg overflow-hidden mb-4" data-group="${escapeHtml(groupName)}">
                            <div class="bg-gradient-to-r from-purple-50 to-blue-50 px-4 py-3 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-900">${escapeHtml(groupName)}</h3>
                                            <p class="text-sm text-gray-500">${groupItems.length} sản phẩm | Tổng SL: ${totalQty}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                            <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                            ${groupItems.map(item => renderProductCard(item)).join('')}
                        </div>
                    </div>
                `;
                }).join('');
            }

            function renderProductCard(item) {
                // Xác định màu và icon theo trạng thái
                let statusBg, statusText;
                switch (item.design_status) {
                    case 'DESIGNING':
                        statusBg = 'bg-yellow-100 text-yellow-800';
                        statusText = '🔧 Đang TK';
                        break;
                    case 'DESIGN_CONFIRMED':
                        statusBg = 'bg-green-100 text-green-800';
                        statusText = '✅ Đã TK';
                        break;
                    case 'BOM_EXTRACTED':
                        statusBg = 'bg-blue-100 text-blue-800';
                        statusText = '🧱 Đã bóc';
                        break;
                    default:
                        statusBg = 'bg-gray-100 text-gray-800';
                        statusText = '⏳ Chưa TK';
                }

                // Xác định hình minh họa theo loại sản phẩm
                let productIcon = getDoorSvg(item.product_type);

                const itemId = item.project_item_id || item.id || item.door_design_id;
                return `
                <div class="product-card item-card bg-white border-2 border-gray-200 rounded-xl p-4 cursor-pointer 
                            hover:border-purple-500 hover:shadow-lg transition-all duration-200"
                     onclick="onClickProductCard(${item.id}, ${item.project_item_id || 'null'})"
                     data-quotation-item-id="${item.id}"
                     data-item-id="${itemId}">
                    <!-- Hình minh họa -->
                    <div class="flex justify-center items-center h-28 bg-gray-50 rounded-lg mb-3">
                        ${productIcon}
                    </div>
                    
                    <!-- Kích thước -->
                    <div class="text-center mb-2">
                        <span class="text-lg font-bold text-gray-800">
                            ${item.width_mm || '?'} × ${item.height_mm || '?'}
                        </span>
                        <span class="text-xs text-gray-500 block">mm</span>
                    </div>
                    
                    <!-- Tên sản phẩm -->
                    <p class="text-xs text-gray-600 text-center truncate" title="${escapeHtml(item.item_name)}">
                        ${escapeHtml(item.item_name).length > 20 ? escapeHtml(item.item_name).substring(0, 20) + '...' : escapeHtml(item.item_name)}
                    </p>
                    
                    <!-- Số lượng -->
                    <div class="text-center mb-2">
                        <span class="text-sm font-medium text-purple-600">SL: ${item.quantity || 1}</span>
                    </div>
                    
                    <!-- Trạng thái -->
                    <div class="text-center">
                        <span class="inline-block px-2 py-1 rounded-full text-xs font-medium ${statusBg}">
                            ${statusText}
                        </span>
                    </div>
                </div>
            `;
            }

            function renderProductCards(items) {
                // Tìm tbody để render vào bảng mới
                const tbody = document.getElementById('productsTableBody');
                const emptyState = document.getElementById('emptyProductsState');

                if (!items || items.length === 0) {
                    if (tbody) tbody.innerHTML = '';
                    if (emptyState) emptyState.classList.remove('hidden');
                    return;
                }

                if (emptyState) emptyState.classList.add('hidden');

                // Render table rows
                tbody.innerHTML = items.map((item, index) => {
                    // Smart swap: nếu item_name giống mã (ngắn, kiểu D2-T1) và product_code giống tên sản phẩm (dài), thì hoán đổi
                    let displayCode = item.product_code || '-';
                    let displayName = item.item_name || 'N/A';

                    // Kiểm tra nếu item_name trông giống mã sản phẩm (ngắn, chứa dạng như D2-T1, S1-T1)
                    const isNameLikeCode = displayName && displayName.length < 15 && /^[A-Z0-9_-]+$/i.test(displayName.replace(/\s/g, ''));
                    // Kiểm tra nếu product_code trông giống tên sản phẩm (dài, chứa tiếng Việt hoặc từ mô tả)
                    const isCodeLikeName = displayCode && displayCode.length > 15;

                    // Hoán đổi nếu dữ liệu bị ngược
                    if (isNameLikeCode && isCodeLikeName) {
                        const temp = displayCode;
                        displayCode = displayName;
                        displayName = temp;
                    }

                    return `
                        <tr class="hover:bg-gray-50" data-item-id="${item.quotation_item_id || item.id}">
                        <td class="px-2 py-3 text-center text-sm text-gray-600">${index + 1}</td>
                            <td class="px-2 py-3 text-center text-sm font-mono text-blue-600">${escapeHtml(displayCode)}</td>
                            <td class="px-3 py-3 text-sm text-gray-900">${escapeHtml(displayName)}</td>
                            <td class="px-2 py-3 text-center text-sm text-gray-600">${escapeHtml(item.color || '-')}</td>
                            <td class="px-2 py-3 text-center text-sm text-gray-600">${escapeHtml(item.glass_type || '-')}</td>
                            <td class="px-2 py-3 text-center text-sm text-gray-600">${escapeHtml(item.accessories || '-')}</td>
                            <td class="px-2 py-3 text-center text-sm text-gray-600">${escapeHtml(item.aluminum_system || '-')}</td>
                            <td class="px-2 py-3 text-center text-sm font-bold text-purple-600">${item.quantity || 1}</td>
                            <td class="px-2 py-3 text-sm text-gray-600">${escapeHtml(item.location || '-')}</td>
                        <td class="px-2 py-3 text-center whitespace-nowrap">
                                <button onclick="openEditProductModal(${item.quotation_item_id || item.id})" 
                                        class="text-blue-600 hover:text-blue-800 mr-2" title="Sửa">
                                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                                <button onclick="deleteProductItem(${item.quotation_item_id || item.id})" 
                                class="text-red-600 hover:text-red-800" title="Xóa">
                                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
                }).join('');

                // Update footer totals
                const totalQty = items.reduce((sum, item) => sum + (parseInt(item.quantity || 0)), 0);
                const footerTotalQty = document.getElementById('footerTotalQty');
                if (footerTotalQty) footerTotalQty.textContent = totalQty;
            }

            function getDoorSvg(productType) {
                // SVG minh họa đơn giản cho từng loại sản phẩm
                if (productType === 'window') {
                    return `<svg class="w-16 h-16 text-blue-400" viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="10" y="10" width="80" height="80" rx="2"/>
                    <line x1="10" y1="50" x2="90" y2="50"/>
                        <line x1="50" x2="50" y1="10" y2="90"/>
                    <rect x="15" y="15" width="30" height="30" fill="currentColor" opacity="0.1"/>
                </svg>`;
                } else if (productType === 'railing') {
                    return `<svg class="w-16 h-16 text-gray-400" viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="10" y1="30" x2="90" y2="30"/>
                        <line x1="10" y1="30" x2="20" y2="90"/>
                    <line x1="40" y1="30" x2="40" y2="90"/>
                    <line x1="60" y1="30" x2="60" y2="90"/>
                    <line x1="80" y1="30" x2="80" y2="90"/>
                </svg>`;
                } else if (productType === 'glass_wall') {
                    return `<svg class="w-16 h-16 text-green-400" viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="10" y="10" width="80" height="80" rx="2"/>
                    <line x1="35" y1="10" x2="35" y2="90"/>
                    <line x1="65" y1="10" x2="65" y2="90"/>
                    <rect x="12" y="12" width="21" height="76" fill="currentColor" opacity="0.1"/>
                </svg>`;
                } else {
                    // Default door
                    return `<svg class="w-16 h-16 text-purple-400" viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="10" y="10" width="70" height="80" rx="2"/>
                    <rect x="20" y="15" width="60" height="35" fill="currentColor" opacity="0.1"/>
                        <rect x="20" y="55" width="60" height="35" fill="currentColor" opacity="0.1"/>
                        <circle cx="55" cy="55" r="4" fill="currentColor"/>
                </svg>`;
                }
            }

            function filterGroup() {
                const selectedGroup = document.getElementById('groupFilter')?.value || 'all';
                const groups = document.querySelectorAll('[data-group]');

                groups.forEach(group => {
                    const groupName = group.getAttribute('data-group');
                    if (selectedGroup === 'all' || groupName === selectedGroup) {
                        group.style.display = 'block';
                    } else {
                        group.style.display = 'none';
                    }
                });
            }

            function updateProductTypeSummary(items) {
                if (!items || items.length === 0) {
                    // Cập nhật summary cards mới
                    const step2TotalProducts = document.getElementById('step2TotalProducts');
                    const step2TotalQuantity = document.getElementById('step2TotalQuantity');
                    const step2TotalArea = document.getElementById('step2TotalArea');
                    const step2DesignedCount = document.getElementById('step2DesignedCount');

                    if (step2TotalProducts) step2TotalProducts.textContent = '0';
                    if (step2TotalQuantity) step2TotalQuantity.textContent = '0';
                    if (step2TotalArea) step2TotalArea.textContent = '0.00 m²';
                    if (step2DesignedCount) step2DesignedCount.textContent = '0';
                    return;
                }

                // Tính tổng số lượng
                const totalQuantity = items.reduce((sum, item) => sum + (parseFloat(item.quantity || 1)), 0);

                // Tính tổng diện tích
                const totalArea = items.reduce((sum, item) => {
                    if (item.width && item.height) {
                        return sum + ((item.width / 1000) * (item.height / 1000) * (item.quantity || 1));
                    }
                    return sum;
                }, 0);

                const designedCount = items.filter(item => item.design_status === 'DESIGN_CONFIRMED').length;

                // Cập nhật summary cards mới
                const step2TotalProducts = document.getElementById('step2TotalProducts');
                const step2TotalQuantity = document.getElementById('step2TotalQuantity');
                const step2TotalArea = document.getElementById('step2TotalArea');
                const step2DesignedCount = document.getElementById('step2DesignedCount');

                if (step2TotalProducts) step2TotalProducts.textContent = items.length;
                if (step2TotalQuantity) step2TotalQuantity.textContent = totalQuantity;
                if (step2TotalArea) step2TotalArea.textContent = totalArea.toFixed(2) + ' m²';
                if (step2DesignedCount) step2DesignedCount.textContent = designedCount;
            }

            function getProductTypeName(productType) {
                const typeMap = {
                    'door_swing': 'Cửa đi mở quay',
                    'door_sliding': 'Cửa lùa',
                    'door': 'Cửa đi',
                    'window': 'Cửa sổ',
                    'glass_wall': 'Vách kính',
                    'railing': 'Lan can',
                    'glass_panel': 'Tấm kính',
                    'other': 'Khác'
                };
                return typeMap[productType] || productType || 'Khác';
            }

            function getProductTypeIcon(typeName) {
                const iconMap = {
                    'Cửa đi mở quay': 'from-purple-50 to-purple-100',
                    'Cửa lùa': 'from-blue-50 to-blue-100',
                    'Cửa đi': 'from-purple-50 to-purple-100',
                    'Cửa sổ': 'from-cyan-50 to-cyan-100',
                    'Vách kính': 'from-green-50 to-green-100',
                    'Lan can': 'from-orange-50 to-orange-100',
                    'Tấm kính': 'from-indigo-50 to-indigo-100',
                    'Khác': 'from-gray-50 to-gray-100'
                };
                return iconMap[typeName] || 'from-gray-50 to-gray-100';
            }

            async function onClickProductCard(quotationItemId, projectItemId) {
                // Tìm thông tin item từ danh sách
                const item = quotationItemsForDesign.find(i =>
                    i.quotation_item_id === quotationItemId || i.id === quotationItemId
                );

                if (!item) {
                    alert('Không tìm thấy thông tin sản phẩm');
                    return;
                }

                // Nếu chưa có project_item, tạo mới
                if (!projectItemId) {
                    try {
                        const response = await fetch(`${API_BASE}/projects/${currentProject.id}/design-items`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ quotation_item_id: quotationItemId })
                        });

                        const result = await response.json();
                        if (result.success && result.data) {
                            console.log('✅ Created project_item:', result.data);
                            projectItemId = result.data.project_item_id;
                            item.project_item_id = projectItemId;
                            // Refresh để cập nhật status
                            await loadQuotationItemsForDesign(currentProject.id);
                        } else {
                            alert('Lỗi: ' + result.message);
                            return;
                        }
                    } catch (error) {
                        console.error('Error creating project_item:', error);
                        alert('Lỗi kết nối server');
                        return;
                    }
                }

                // Mở modal chi tiết sản phẩm
                openProductDetailModal({
                    quotation_item_id: quotationItemId,
                    project_item_id: projectItemId,
                    id: item.id
                });
            }

            // Biến lưu item đang thiết kế
            let currentDesignItem = null;
            let currentProductDetail = null;

            async function openProductDetailModal(item) {
                currentProductDetail = {
                    quotation_item_id: item.quotation_item_id,
                    project_item_id: item.project_item_id,
                    id: item.id
                };

                // Hiển thị tên sản phẩm
                document.getElementById('productDetailName').textContent = item.item_name || 'Đang tải...';

                // Hiển thị modal với trạng thái loading
                const modal = document.getElementById('productDetailModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
                switchTab('dimensions');

                const projectItemId = item.project_item_id;

                // Thử gọi API V2 trước
                try {
                    const v2Response = await fetch(`${API_BASE}/v2/project-items/${projectItemId}/calculate-bom`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ save: true })
                    });
                    const v2Result = await v2Response.json();

                    if (v2Result.success) {
                        console.log('✅ Using API V2 (ACT Style):', v2Result);

                        // Map V2 data sang format cũ để tương thích
                        const mappedData = mapV2ToLegacyFormat(v2Result, item);
                        // Populate dữ liệu từ API v2 vào các tab
                        populateDimensionsTabFromAPI(mappedData);
                        populateAluminumTabFromAPI(mappedData.aluminum);
                        populateGlassTabFromAPI(mappedData.glass);
                        populateHardwareTabFromAPI(mappedData.hardware);
                        populateConsumablesTabFromAPI(mappedData.consumables);
                        populateCostTabFromAPI(mappedData.cost);
                        return;
                    }
                } catch (v2Error) {
                    console.warn('API V2 không khả dụng, thử API cũ:', v2Error.message);
                }

                // Fallback: Gọi API cũ
                try {
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/items/${projectItemId}/bom-detail`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        const data = result.data;
                        document.getElementById('productDetailName').textContent = data.item_name || item.item_name;
                        populateDimensionsTabFromAPI(data);
                        populateAluminumTabFromAPI(data.aluminum);
                        populateGlassTabFromAPI(data.glass);
                        populateHardwareTabFromAPI(data.hardware);
                        populateConsumablesTabFromAPI(data.consumables);
                        populateCostTabFromAPI(data.cost);
                    } else {
                        console.error('API error:', result.message);
                        populateDimensionsTab(item);
                        populateAluminumTab(item);
                        populateGlassTab(item);
                        populateHardwareTab(item);
                        populateConsumablesTab(item);
                        populateCostTab(item);
                    }
                } catch (error) {
                    console.error('Error fetching BOM detail:', error);
                    populateDimensionsTab(item);
                    populateAluminumTab(item);
                    populateGlassTab(item);
                    populateHardwareTab(item);
                    populateConsumablesTab(item);
                    populateCostTab(item);
                }
            }

            // ======== MAP V2 DATA SANG LEGACY FORMAT ========
            function mapV2ToLegacyFormat(v2Result, originalItem) {
                const bom = v2Result.bom || {};
                const summary = v2Result.summary || {};
                const config = v2Result.config || {};

                return {
                    customer_name: currentProject?.customer_name || '-',
                    item_name: v2Result.item?.item_name || originalItem.item_name,
                    door_code: v2Result.item?.item_code || '',
                    dimensions: {
                        width: config.width_mm || 1200,
                        height: config.height_mm || 2200,
                        h1: (config.height_mm || 2200) + 50,
                        gap_sash: 7,
                        glass_type: 'Kính cường lực 8mm',
                        quantity: v2Result.item?.quantity || 1,
                        aluminum_price_per_kg: 90000,
                        glass_price_per_m2: 520000,
                        aluminum_system: config.aluminum_system || 'ViralWindow'
                    },
                    aluminum: (bom.aluminum?.lines || []).map(line => ({
                        name: line.material_name,
                        position: line.position || '-',
                        code: line.material_code,
                        cut_angle: line.cut_angle || '45-45',
                        qty: line.quantity,
                        length: line.cut_length_mm
                    })),
                    glass: {
                        panels: (bom.glass?.lines || []).map(line => ({
                            name: line.material_name,
                            width: line.width_mm,
                            height: line.height_mm,
                            qty: line.quantity,
                            area: line.area_m2,
                            position: line.position || 'Cánh'
                        })),
                        total_area_m2: bom.glass?.total_area_m2 || 0
                    },
                    hardware: (bom.hardware?.lines || []).map(line => ({
                        name: line.material_name,
                        code: line.material_code,
                        unit: line.unit || 'pcs',
                        qty: line.quantity,
                        price: line.unit_price || 0,
                        total: (line.unit_price || 0) * (line.quantity || 0)
                    })),
                    consumables: (bom.consumables?.lines || []).map(line => ({
                        name: line.material_name,
                        code: line.material_code,
                        unit: line.unit || 'm',
                        qty: line.quantity,
                        price: 0
                    })),
                    cost: {
                        aluminum_kg: summary.aluminum_kg || 0,
                        glass_m2: summary.glass_m2 || 0,
                        hardware_count: summary.hardware_count || 0,
                        aluminum_cost: summary.aluminum_cost || 0,
                        glass_cost: summary.glass_cost || 0,
                        hardware_cost: summary.hardware_cost || 0,
                        consumables_cost: summary.consumables_cost || 0,
                        total_cost: summary.total_cost || 0
                    }
                };
            }


            // ======== POPULATE FUNCTIONS FROM API ========
            function populateDimensionsTabFromAPI(data) {
                document.getElementById('pdCustomerName').textContent = data.customer_name || '-';
                document.getElementById('pdDoorCode').textContent = data.door_code || '-';
                document.getElementById('pdWidth').value = data.dimensions?.width || 1200;
                document.getElementById('pdHeight').value = data.dimensions?.height || 2200;
                document.getElementById('pdH1').value = data.dimensions?.h1 || 2250;
                document.getElementById('pdGapSash').value = data.dimensions?.gap_sash || 7;
                document.getElementById('pdGlassType').value = data.dimensions?.glass_type || 'Kính cường lực 8mm';
                document.getElementById('pdQuantity').value = data.dimensions?.quantity || 1;
                document.getElementById('pdAluminumPrice').value = (data.dimensions?.aluminum_price_per_kg || 90000).toLocaleString('vi-VN');
                document.getElementById('pdGlassPrice').value = (data.dimensions?.glass_price_per_m2 || 245000).toLocaleString('vi-VN');
                document.getElementById('pdAluminumSystem').value = data.dimensions?.aluminum_system || 'ViralWindow';
            }

            function populateAluminumTabFromAPI(aluminumData) {
                const tbody = document.getElementById('aluminumCutTable');
                if (!aluminumData || aluminumData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu KT Cắt</td></tr>';
                    return;
                }

                tbody.innerHTML = aluminumData.map(row => `
                <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-gray-900">${row.name || '-'}</td>
                        <td class="px-4 py-3 text-center"><span class="px-2 py-1 bg-gray-100 rounded text-xs">${row.position || '-'}</span></td>
                        <td class="px-4 py-3 text-center font-mono text-blue-600">${row.code || '-'}</td>
                        <td class="px-4 py-3 text-center">${row.cut_angle || '-'}</td>
                        <td class="px-4 py-3 text-center font-medium">${row.qty || 0}</td>
                        <td class="px-4 py-3 text-center font-medium text-green-600">${row.length || 0}</td>
                </tr>
            `).join('');
            }

            function populateGlassTabFromAPI(glassData) {
                const tbody = document.getElementById('glassPanelTable');
                if (!glassData || !glassData.panels || glassData.panels.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu KT Kính</td></tr>';
                    document.getElementById('totalGlassArea').textContent = '0 m²';
                    return;
                }

                tbody.innerHTML = glassData.panels.map(row => {
                    const area = (row.width * row.height) / 1000000;
                    return `
                <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-gray-900">${row.name || '-'}</td>
                            <td class="px-4 py-3 text-center">${row.width || 0}</td>
                            <td class="px-4 py-3 text-center">${row.height || 0}</td>
                            <td class="px-4 py-3 text-center">${row.qty || 1}</td>
                            <td class="px-4 py-3 text-center font-medium text-blue-600">${area.toFixed(6)}</td>
                            <td class="px-4 py-3 text-center"><span class="px-2 py-1 bg-${row.position === 'Cánh' ? 'purple' : 'green'}-100 rounded text-xs">${row.position || '-'}</span></td>
                </tr>
                    `;
                }).join('');
                document.getElementById('totalGlassArea').textContent = (glassData.total_area_m2 || 0).toFixed(2) + ' m²';
            }

            function populateHardwareTabFromAPI(hardwareData) {
                const tbody = document.getElementById('hardwareTable');
                if (!hardwareData || hardwareData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu Phụ kiện</td></tr>';
                    return;
                }

                tbody.innerHTML = hardwareData.map(row => `
                <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-gray-900">${row.name || '-'}</td>
                        <td class="px-4 py-3 text-center font-mono text-blue-600">${row.code || '-'}</td>
                        <td class="px-4 py-3 text-center">${row.unit || '-'}</td>
                        <td class="px-4 py-3 text-center">${row.qty || 0}</td>
                    <td class="px-4 py-3 text-right">${(row.price || 0).toLocaleString('vi-VN')} ₫</td>
                    <td class="px-4 py-3 text-right font-medium text-green-600">${(row.total || 0).toLocaleString('vi-VN')} ₫</td>
                </tr>
            `).join('');
            }

            function populateConsumablesTabFromAPI(consumablesData) {
                const tbody = document.getElementById('consumablesTable');
                if (!consumablesData || consumablesData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu Keo/Silicone</td></tr>';
                    return;
                }
                tbody.innerHTML = consumablesData.map(row => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-gray-900">${row.name}</td>
                    <td class="px-4 py-3 text-right"><input type="number" value="${row.price || 0}" class="w-24 px-2 py-1 border rounded text-right"></td>
                        <td class="px-4 py-3 text-center font-mono text-blue-600">${row.code || '-'}</td>
                        <td class="px-4 py-3 text-center">${row.unit || 'm'}</td>
                        <td class="px-4 py-3 text-center"><input type="number" value="${row.qty}" step="0.01" class="w-20 px-2 py-1 border rounded text-center"></td>
                </tr>
            `).join('');
            }

            function populateCostTabFromAPI(costData) {
                document.getElementById('totalAluminumKg').textContent = (costData.aluminum_kg || 0) + ' kg';
                document.getElementById('totalGlassM2').textContent = (costData.glass_m2 || 0) + ' m²';
                document.getElementById('totalHardwareCount').textContent = costData.hardware_count || 0;
                document.getElementById('costAluminum').textContent = (costData.aluminum_cost || 0).toLocaleString('vi-VN') + ' ₫';
                document.getElementById('costGlass').textContent = (costData.glass_cost || 0).toLocaleString('vi-VN') + ' ₫';
                document.getElementById('costHardware').textContent = (costData.hardware_cost || 0).toLocaleString('vi-VN') + ' ₫';
                document.getElementById('costConsumables').textContent = (costData.consumables_cost || 0).toLocaleString('vi-VN') + ' ₫';
                document.getElementById('totalProjectCost').textContent = (costData.total_cost || 0).toLocaleString('vi-VN') + ' ₫';
            }

            function closeProductDetailModal() {
                document.getElementById('productDetailModal').classList.add('hidden');
                currentDesignItem = null;
                currentProductDetail = null;
            }

            function switchTab(tabName) {
                // Ẩn tất cả tab contents
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));

                // Hiển thị tab được chọn
                const tabId = 'tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
                document.getElementById(tabId)?.classList.remove('hidden');

                // Update tab buttons
                document.querySelectorAll('.product-tab-btn').forEach(btn => {
                    btn.classList.remove('border-purple-600', 'text-purple-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });

                const activeBtn = document.querySelector(`.product-tab-btn[data-tab="${tabName}"]`);
                if (activeBtn) {
                    activeBtn.classList.remove('border-transparent', 'text-gray-500');
                    activeBtn.classList.add('border-purple-600', 'text-purple-600');
                }
            }

            function populateDimensionsTab(item) {
                const config = parseJSON(item.snapshot_config) || {};

                document.getElementById('pdCustomerName').textContent = currentProject?.name || '-';
                document.getElementById('pdDoorCode').textContent = `D${item.id}`;
                document.getElementById('pdWidth').value = config.size?.w || item.width_mm || 1200;
                document.getElementById('pdHeight').value = config.size?.h || item.height_mm || 2200;
                document.getElementById('pdH1').value = config.h1 || 2250;
                document.getElementById('pdGapSash').value = config.gap_sash || 7;
                document.getElementById('pdGlassType').value = config.glass?.thickness_mm || '8mm Tempered';
                document.getElementById('pdQuantity').value = item.quantity || 1;
                document.getElementById('pdAluminumPrice').value = '90,000';
                document.getElementById('pdGlassPrice').value = '245,000';
                document.getElementById('pdAluminumSystem').value = config.aluminum_system || 'ViralWindow';
            }

            function populateAluminumTab(item) {
                const config = parseJSON(item.snapshot_config) || {};
                const width = config.size?.w || item.width_mm || 1200;
                const height = config.size?.h || item.height_mm || 2200;

                // Dữ liệu mẫu - sau này sẽ lấy từ API
                const aluminumData = [
                    { name: 'Khung bao cửa đi 100', position: 'Ngang trên', code: 'C38019', cutAngle: '90-90', qty: 1, length: width },
                    { name: 'Khung bao cửa đi 100', position: 'Đứng', code: 'C38019', cutAngle: '90-45-90', qty: 2, length: height - 50 },
                    { name: 'XF- Cánh mở ngoài bản to 145', position: 'Ngang', code: 'C112592', cutAngle: '45-45', qty: 2, length: Math.round(width / 2 - 50) },
                    { name: 'XF- Cánh mở ngoài bản to 145', position: 'Đứng', code: 'C112592', cutAngle: '45-45', qty: 2, length: height - 100 },
                    { name: 'XF- Nẹp cánh, vách', position: 'Ngang', code: 'C3295', cutAngle: '90-90', qty: 4, length: Math.round(width / 2 - 80) },
                    { name: 'XF- Nẹp cánh, vách', position: 'Đứng', code: 'C3295', cutAngle: '90-90', qty: 4, length: height - 150 }
                ];

                const tbody = document.getElementById('aluminumCutTable');
                tbody.innerHTML = aluminumData.map(row => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-gray-900">${row.name}</td>
                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 bg-gray-100 rounded text-xs">${row.position}</span></td>
                    <td class="px-4 py-3 text-center font-mono text-blue-600">${row.code}</td>
                    <td class="px-4 py-3 text-center">${row.cutAngle}</td>
                    <td class="px-4 py-3 text-center font-medium">${row.qty}</td>
                        <td class="px-4 py-3 text-center font-medium text-purple-600">${row.length}</td>
                </tr>
            `).join('');
            }

            function populateGlassTab(item) {
                const config = parseJSON(item.snapshot_config) || {};
                const width = config.size?.w || item.width_mm || 1200;
                const height = config.size?.h || item.height_mm || 2200;

                // Dữ liệu mẫu
                const glassData = [
                    { name: config.glass?.type || 'Tempered 8mm', width: Math.round(width / 2), height: Math.round(height * 0.5), qty: 2, position: 'Cánh' },
                    { name: config.glass?.type || 'Tempered 8mm', width: Math.round(width / 2 - 80), height: Math.round(height * 0.4), qty: 4, position: 'Cánh' },
                    { name: config.glass?.type || 'Tempered 8mm', width: width - 328, height: height - 328, qty: 2, position: 'Vách' }
                ];

                let totalArea = 0;
                const tbody = document.getElementById('glassPanelTable');
                tbody.innerHTML = glassData.map(row => {
                    const area = (row.width * row.height) / 1000000;
                    totalArea += area;
                    return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-gray-900">${row.name}</td>
                            <td class="px-4 py-3 text-center">${row.width}</td>
                        <td class="px-4 py-3 text-center">${row.height}</td>
                        <td class="px-4 py-3 text-center">${row.qty}</td>
                            <td class="px-4 py-3 text-center font-medium text-purple-600">${area.toFixed(6)}</td>
                        <td class="px-4 py-3 text-center"><span class="px-2 py-1 bg-${row.position === 'Cánh' ? 'purple' : 'green'}-100 rounded text-xs">${row.position}</span></td>
                    </tr>
                `;
                }).join('');

                document.getElementById('totalGlassArea').textContent = totalArea.toFixed(2) + ' m²';
            }

            function populateHardwareTab(item) {
                const hardwareData = [
                    { name: 'Bản lề 3D', code: 'BANLE3D', unit: 'Bộ', qty: 3, price: 150000, total: 450000 },
                    { name: 'Ổ khóa điện tử', code: 'KHOADIENTU', unit: 'Bộ', qty: 1, price: 850000, total: 850000 },
                    { name: 'Tay nắm cửa', code: 'TAY_NAM', unit: 'Cái', qty: 1, price: 250000, total: 250000 },
                    { name: 'Thanh chống', code: 'CHONG', unit: 'Cái', qty: 4, price: 50000, total: 200000 }
                ];

                const tbody = document.getElementById('hardwareTable');
                tbody.innerHTML = hardwareData.map(row => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-gray-900">${row.name}</td>
                        <td class="px-4 py-3 text-center font-mono text-blue-600">${row.code}</td>
                    <td class="px-4 py-3 text-center">${row.unit}</td>
                    <td class="px-4 py-3 text-center">${row.qty}</td>
                    <td class="px-4 py-3 text-right">${row.price.toLocaleString('vi-VN')} ₫</td>
                    <td class="px-4 py-3 text-right font-medium text-green-600">${row.total.toLocaleString('vi-VN')} ₫</td>
                </tr>
            `).join('');
            }

            function populateConsumablesTab(item) {
                const consumablesData = [
                    { name: 'Gioăng kính mặt trong', price: 0, code: 'GKMT', unit: 'm dài', qty: 28.18 },
                    { name: 'Keo kính mặt ngoài', price: 0, code: 'KKMN', unit: 'm dài', qty: 28.18 },
                    { name: 'Keo tường - 2 mặt', price: 0, code: 'KT2M', unit: 'm dài', qty: 16.71 },
                    { name: 'Gioăng kính kính', price: 0, code: 'GKK', unit: 'm dài', qty: 12.44 },
                    { name: 'Vít nở lắp đặt', price: 0, code: 'VITNO', unit: 'Cái', qty: 16 }
                ];

                const tbody = document.getElementById('consumablesTable');
                tbody.innerHTML = consumablesData.map(row => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-gray-900">${row.name}</td>
                    <td class="px-4 py-3 text-right"><input type="number" value="${row.price}" class="w-24 px-2 py-1 border rounded text-right"></td>
                    <td class="px-4 py-3 text-center font-mono text-blue-600">${row.code}</td>
                    <td class="px-4 py-3 text-center">${row.unit}</td>
                        <td class="px-4 py-3 text-center"><input type="number" value="${row.qty}" step="0.01" class="w-20 px-2 py-1 border rounded text-center"></td>
                </tr>
            `).join('');
            }

            function populateCostTab(item) {
                // Chi phí mẫu
                const aluminumKg = 25.5;
                const glassM2 = 3.5;
                const hardwareCount = 9;

                const costAluminum = aluminumKg * 90000;
                const costGlass = glassM2 * 245000;
                const costHardware = hardwareCount * 150000;
                const costConsumables = 150000;
                const totalCost = costAluminum + costGlass + costHardware + costConsumables;

                document.getElementById('totalAluminumKg').textContent = aluminumKg + ' kg';
                document.getElementById('totalGlassM2').textContent = glassM2 + ' m²';
                document.getElementById('totalHardwareCount').textContent = hardwareCount;
                document.getElementById('costAluminum').textContent = costAluminum.toLocaleString('vi-VN') + ' ₫';
                document.getElementById('costGlass').textContent = costGlass.toLocaleString('vi-VN') + ' ₫';
                document.getElementById('costHardware').textContent = costHardware.toLocaleString('vi-VN') + ' ₫';
                document.getElementById('costConsumables').textContent = costConsumables.toLocaleString('vi-VN') + ' ₫';
                document.getElementById('totalProjectCost').textContent = totalCost.toLocaleString('vi-VN') + ' ₫';
            }

            function saveProductDetail() {
                alert('Đã lưu thông tin sản phẩm!');
                closeProductDetailModal();
            }

            function saveProductCopy() {
                alert('Đã lưu và tạo bản sao sản phẩm!');
            }

            function exportProductBOM() {
                alert('Đang xuất BOM...');
            }

            function recalculateAluminum() {
                alert('Đang tính lại KT Cắt...');
            }

            function editAluminumRatio() {
                alert('Chỉnh sửa tỷ trọng nhôm...');
            }

            function editGasketQuantity() {
                alert('Chỉnh sửa số lượng gioăng...');
            }

            function onClickProductCardLegacy(quotationItemId) {
                // Legacy function - redirect to modal
                const item = quotationItemsForDesign.find(i => i.quotation_item_id === quotationItemId);
                if (item) {
                    openProductDetailModal(item);
                }
            }
            // Legacy function placeholder - can be removed if not used
            function displayItems() { }

            function selectCategory(category, event) {
                // Highlight selected category
                document.querySelectorAll('.category-card').forEach(card => {
                    card.classList.remove('ring-4', 'ring-purple-500');
                });
                event.currentTarget.classList.add('ring-4', 'ring-purple-500');

                // Store selected category
                window.selectedCategory = category;
            }

            function openCreateItemModal() {
                document.getElementById('createItemModal').classList.remove('hidden');
                loadTemplatesV2(); // Load V2 templates
            }

            function closeCreateItemModal() {
                document.getElementById('createItemModal').classList.add('hidden');
                document.getElementById('createItemForm').reset();
                document.getElementById('templateDimensions').classList.add('hidden');
                document.getElementById('estimatedPrice').classList.add('hidden');
            }

            // Load templates từ API V2
            let templatesV2 = [];
            async function loadTemplatesV2() {
                try {
                    const response = await fetch(`${API_BASE}/v2/templates`);
                    const result = await response.json();
                    if (result.success) {
                        templatesV2 = result.data;
                        const select = document.getElementById('newItemTemplate');
                        select.innerHTML = '<option value="">-- Chọn mẫu --</option>';

                        // Group by item_type
                        const doors = templatesV2.filter(t => t.item_type === 'door');
                        const windows = templatesV2.filter(t => t.item_type === 'window');

                        if (doors.length > 0) {
                            select.innerHTML += '<optgroup label="🚪 Cửa đi">' +
                                doors.map(t => `<option value="${t.template_code}" data-width="${t.default_width_mm}" data-height="${t.default_height_mm}">${t.template_name}</option>`).join('') +
                                '</optgroup>';
                        }
                        if (windows.length > 0) {
                            select.innerHTML += '<optgroup label="🪟 Cửa sổ">' +
                                windows.map(t => `<option value="${t.template_code}" data-width="${t.default_width_mm}" data-height="${t.default_height_mm}">${t.template_name}</option>`).join('') +
                                '</optgroup>';
                        }
                    }
                } catch (error) {
                    console.error('Error loading templates V2:', error);
                }
            }

            // Khi chọn template
            function onTemplateSelect() {
                const select = document.getElementById('newItemTemplate');
                const templateCode = select.value;
                const dimSection = document.getElementById('templateDimensions');
                if (templateCode) {
                    const option = select.options[select.selectedIndex];
                    const width = option.getAttribute('data-width') || 1000;
                    const height = option.getAttribute('data-height') || 2200;
                    document.getElementById('newItemWidth').value = width;
                    document.getElementById('newItemHeight').value = height;
                    document.getElementById('newItemCategory').value = ''; // Clear legacy
                    dimSection.classList.remove('hidden');
                } else {
                    dimSection.classList.add('hidden');
                }
            }

            async function createNewItem(event) {
                event.preventDefault();
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }
                const itemName = document.getElementById('newItemName').value;
                const templateCode = document.getElementById('newItemTemplate').value;
                const category = document.getElementById('newItemCategory').value;
                const width = parseInt(document.getElementById('newItemWidth')?.value) || 1000;
                const height = parseInt(document.getElementById('newItemHeight')?.value) || 2200;

                // Ưu tiên template V2
                if (templateCode) {
                    try {
                        // Tạo bằng V2 API
                        const response = await fetch(`${API_BASE}/v2/project-items`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                project_id: currentProject.id,
                                item_type: templatesV2.find(t => t.template_code === templateCode)?.item_type || 'door',
                                item_code: `${templateCode}_${Date.now()}`,
                                item_name: itemName || `Item ${templateCode}`,
                                quantity: 1,
                                config: {
                                    width_mm: width,
                                    height_mm: height,
                                    template_code: templateCode,
                                    aluminum_system: 'VW-AL55'
                                }
                            })
                        });

                        const result = await response.json();
                        if (result.success) {
                            showSuccessNotification('Tạo thành công!', `Template: ${templateCode}`);
                            closeCreateItemModal();
                            loadQuotationItemsForDesign(currentProject.id);
                        } else {
                            alert(result.message || 'Lỗi khi tạo item');
                        }
                    } catch (error) {
                        console.error('Error creating item V2:', error);
                        alert('Lỗi kết nối server');
                    }
                } else if (category) {
                    // Fallback to legacy
                    try {
                        const response = await fetch(`${API_BASE}/projects/${currentProject.id}/items`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                template: category,
                                door_type: category,
                                width_mm: width,
                                height_mm: height,
                                quantity: 1
                            })
                        });

                        const result = await response.json();
                        if (result.success) {
                            closeCreateItemModal();
                            loadQuotationItemsForDesign(currentProject.id);
                        } else {
                            alert(result.message || 'Lỗi khi tạo item');
                        }
                    } catch (error) {
                        console.error('Error creating item:', error);
                        alert('Lỗi kết nối server');
                    }
                } else {
                    alert('Vui lòng chọn template hoặc loại hạng mục!');
                }
            }

            function selectItem(itemId) {
                const item = quotationItemsForDesign.find(i => i.id === itemId);
                if (!item) return;
                currentItem = item;
                document.getElementById('selectedItemName').textContent = item.design_code || 'Hạng mục';

                // Fill form with item data
                document.getElementById('itemWidth').value = item.width_mm || '';
                document.getElementById('itemHeight').value = item.height_mm || '';
                document.getElementById('itemPanels').value = item.number_of_panels || 1;
                document.getElementById('aluminumSystem').value = item.aluminum_system_id || '';
                document.getElementById('glassType').value = item.glass_type || '';
                document.getElementById('itemColor').value = item.color || 'white';

                goToStep(3);
            }

            async function saveItemSpecs(event) {
                event.preventDefault();
                if (!currentItem || !currentProject) return;

                const specs = {
                    width_mm: parseFloat(document.getElementById('itemWidth').value),
                    height_mm: parseFloat(document.getElementById('itemHeight').value),
                    number_of_panels: parseInt(document.getElementById('itemPanels').value),
                    aluminum_system_id: parseInt(document.getElementById('aluminumSystem').value),
                    glass_type: document.getElementById('glassType').value,
                    color: document.getElementById('itemColor').value
                };

                try {
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/items/${currentItem.id}/specs`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(specs)
                    });
                    const result = await response.json();
                    if (result.success) {
                        // Calculate structure and BOM
                        calculateStructureAndBOM();
                        alert('Đã lưu thông số kỹ thuật! Hệ thống đang tính toán và bóc tách vật tư...');
                    } else {
                        alert('Lỗi: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error saving specs:', error);
                    alert('Lỗi kết nối server');
                }
            }

            async function calculateStructureAndBOM() {
                // This will trigger automatic calculation of structure and BOM
                // Implementation depends on backend API
                if (!currentItem || !currentProject) return;
                try {
                    // Use correct BOM calculation endpoint (GET method)
                    const response = await fetch(`${API_BASE}/bom/projects/${currentProject.id}/doors/${currentItem.id}/calculate`);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        console.log('BOM calculated successfully');
                        // Handle response - reload BOM data if needed
                    } else {
                        console.error('BOM calculation failed:', result.message);
                    }
                } catch (error) {
                    console.error('Error calculating BOM:', error);
                }
            }

            async function loadAluminumSystems() {
                try {
                    const response = await fetch(`${API_BASE}/aluminum-systems`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        const select = document.getElementById('aluminumSystem');
                        if (select) {
                            select.innerHTML = '<option value="">-- Chọn hệ nhôm --</option>' +
                                result.data.map(system => `<option value="${system.id}">${system.name}</option>`).join('');
                        }
                    }
                } catch (error) {
                    console.error('Error loading aluminum systems:', error);
                }
            }

            // Load accessories (placeholder - can be expanded if needed)
            async function loadAccessories() {
                try {
                    // This function is called but accessories loading is handled elsewhere
                    // Keeping it as a placeholder to prevent ReferenceError
                    console.log('📦 loadAccessories called (placeholder)');
                } catch (error) {
                    console.error('Error loading accessories:', error);
                }
            }

            // Hàm xử lý click vào step 2-5
            function handleStepClick(stepNumber) {
                // Only allow steps 1-4
                if (stepNumber > 4) {
                    console.warn('⚠️ Step 5 has been removed. Maximum step is 4.');
                    return;
                }

                if (stepNumber > 1 && !currentProject) {
                    alert('❌ Vui lòng chọn dự án ở Bước 1 trước!');
                    return;
                }
                goToStep(stepNumber);
            }

            // Hàm cập nhật trạng thái các step indicator
            function updateStepIndicators(currentStep) {
                console.log(`🔄 updateStepIndicators called with currentStep: ${currentStep}`);

                // Only 4 steps now (removed Step 5)
                for (let i = 1; i <= 4; i++) {
                    const indicator = document.getElementById(`step${i}`);
                    if (!indicator) {
                        console.warn(`⚠️ Step indicator step${i} not found`);
                        continue;
                    }

                    // Reset classes
                    indicator.className = 'step-indicator flex items-center gap-2 px-4 py-2 rounded-lg font-medium whitespace-nowrap cursor-pointer transition-all duration-300 hover:shadow-md';

                    if (i === currentStep) {
                        // Step hiện tại - active (màu tím)
                        indicator.classList.add('active');
                        console.log(`✅ Step ${i} set to ACTIVE`);
                    } else if (i < currentStep) {
                        // Step đã hoàn thành - completed (màu xanh)
                        indicator.classList.add('completed');
                        console.log(`✅ Step ${i} set to COMPLETED`);
                    } else if (i === 1) {
                        // Step 1 luôn có thể truy cập (màu xám)
                        indicator.classList.add('bg-gray-100', 'text-gray-600');
                        indicator.classList.remove('active', 'completed', 'available');
                    } else {
                        // Step 2-4: nếu đã chọn dự án thì available, nếu chưa thì disabled
                        if (currentProject) {
                            indicator.classList.add('available');
                            console.log(`✅ Step ${i} set to AVAILABLE`);
                        } else {
                            indicator.classList.add('bg-gray-100', 'text-gray-600', 'opacity-50', 'cursor-not-allowed');
                            indicator.classList.remove('active', 'completed', 'available');
                        }
                    }
                }

                console.log(`✅ Step indicators updated. Current step: ${currentStep}`);
            }

            function goToStep(stepNumber) {
                // ⭐ QUAN TRỌNG: Force save BOM data trước khi chuyển step
                // Đảm bảo dữ liệu bóc tách không bị mất khi chuyển bước
                if (typeof flushBOMSave === 'function') {
                    flushBOMSave();
                }

                // Validation: Không cho vào bước 2-4 nếu chưa chọn dự án
                if (stepNumber > 1 && stepNumber <= 4 && !currentProject) {
                    alert('❌ Vui lòng chọn dự án ở Bước 1 trước!');
                    console.error('Cannot go to step', stepNumber, 'without selecting a project');
                    return; // Không chuyển bước
                }

                // Only allow steps 1-4
                if (stepNumber > 4) {
                    console.warn('⚠️ Step 5 has been removed. Maximum step is 4.');
                    return;
                }

                console.log(`🔄 Going to step ${stepNumber}`, currentProject ? `for project: ${currentProject.name}` : '');

                // Save current step to sessionStorage
                sessionStorage.setItem('currentStep', stepNumber.toString());

                // Clear session when going back to step 1
                if (stepNumber === 1) {
                    currentProject = null;
                    uploadedDesignFiles = [];
                    sessionStorage.removeItem('currentProject');
                    sessionStorage.removeItem('uploadedDesignFiles');
                    sessionStorage.removeItem('uploadedDesignFiles_projectId');
                    sessionStorage.removeItem('currentStep');
                    console.log('🧹 Cleared session data (returned to step 1)');
                }

                // Hide all steps
                document.querySelectorAll('.step-content').forEach(step => {
                    step.classList.add('hidden');
                });

                // Update step indicators TRƯỚC khi show content để UI cập nhật ngay
                updateStepIndicators(stepNumber);

                // Show current step
                const stepElement = document.getElementById(`step${stepNumber}Content`);
                if (stepElement) {
                    stepElement.classList.remove('hidden');
                    console.log(`✅ Step ${stepNumber} content shown`);
                } else {
                    console.error(`❌ Step ${stepNumber} content element not found`);
                }

                // Load data when entering specific steps
                setTimeout(() => {
                    if (stepNumber === 2) {
                        // Step 2: Danh sách Sản phẩm
                        if (currentProject) {
                            updateProjectInfo(2); // Update project info
                            loadDesignFilesFromServer(); // Load uploaded files from server

                            // QUAN TRỌNG: Luôn load lại dữ liệu sản phẩm từ server khi vào step 2
                            // Để đảm bảo dữ liệu mới nhất từ database
                            if (currentProject.id) {
                                console.log('📥 Loading product data from server when entering step 2...');
                                // Skip auto step vì đã ở step 2 rồi
                                loadQuotationItemsForDesign(currentProject.id, {
                                    skipAutoStep: true,
                                    skipRender: false  // Vẫn render để cập nhật UI
                                }).then(() => {
                                    console.log('✅ Product data loaded successfully');
                                }).catch(error => {
                                    console.error('❌ Error loading product data:', error);
                                });
                            }
                        } else {
                            console.warn('⚠️ Step 2 entered but currentProject is null');
                        }
                    } else if (stepNumber === 3) {
                        // Step 3: Bóc tách Vật tư
                        if (currentProject) {
                            updateProjectInfo(3); // Update project info
                            loadAllProductsBOM();
                            loadBOMDataFromServer(); // Load saved BOM data from server
                        }
                    } else if (stepNumber === 4) {
                        // Step 4: Kiểm Kho (Final Step)
                        if (currentProject) {
                            updateProjectInfo(4); // Update project info
                            loadBOMDataFromServer(); // Load dữ liệu bóc tách đã lưu
                            // Load và kiểm tra kho sau khi load BOM data
                            setTimeout(() => {
                                if (bocTachData && (bocTachData.nhom.length || bocTachData.kinh.length || bocTachData.vattu.length)) {
                                    console.log('ℹ️ BOM data loaded, checking inventory...');
                                    loadInventoryCheckData();
                                } else {
                                    console.warn('⚠️ No BOM data to check inventory');
                                }
                            }, 500);
                        }
                    }
                }, 100);
            }

            /**
             * Navigate to Inventory Export page and update project status
             */
            async function goToInventoryExport() {
                if (!currentProject) {
                    alert('❌ Vui lòng chọn dự án trước!');
                    return;
                }

                // Confirm before navigating
                if (!confirm('Bạn có muốn hoàn thành quy trình Thiết kế và Bóc tách, và chuyển đến Kho để xuất vật tư không?')) {
                    return;
                }

                try {
                    // Show loading
                    showToast('Đang cập nhật trạng thái dự án...', 'info');

                    // Update project status: Complete Design & BOM, move to Production stage
                    const projectId = currentProject.id || currentProject.project_id;
                    const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                        },
                        body: JSON.stringify({
                            status: 'in_production', // Chuyển sang giai đoạn sản xuất
                            progress_percent: 50 // Hoàn thành 50% (đã xong thiết kế & bóc tách)
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Lỗi không xác định' }));
                        throw new Error(errorData.message || `HTTP ${response.status}`);
                    }

                    // Save project ID to sessionStorage for inventory page
                    sessionStorage.setItem('exportProjectId', projectId);
                    sessionStorage.setItem('exportProjectName', currentProject.name || currentProject.project_name);
                    sessionStorage.setItem('autoSelectProject', 'true'); // Flag to auto-select project

                    // Navigate to inventory page with export tab
                    window.location.href = 'inventory.html?tab=export';
                } catch (error) {
                    console.error('Error updating project status:', error);
                    showToast(`Lỗi: ${error.message}`, 'error');
                    // Still navigate even if update fails
                    sessionStorage.setItem('exportProjectId', currentProject.id || currentProject.project_id);
                    sessionStorage.setItem('exportProjectName', currentProject.name || currentProject.project_name);
                    sessionStorage.setItem('autoSelectProject', 'true');
                    window.location.href = 'inventory.html?tab=export';
                }
            }

            async function loadTechnicalSpecsForStep3() {
                // Load technical specs for all products
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }

                // Reload quotation items if needed
                if (!quotationItemsForDesign || quotationItemsForDesign.length === 0) {
                    await loadQuotationItemsForDesign(currentProject.id);
                }

                renderTechnicalSpecsTable(quotationItemsForDesign);
                updateTechnicalSpecsSummary(quotationItemsForDesign);
            }

            function renderTechnicalSpecsTable(items) {
                const tbody = document.getElementById('technicalSpecsTableBody');
                const emptyState = document.getElementById('step3EmptyState');

                if (!items || items.length === 0) {
                    if (tbody) tbody.innerHTML = '';
                    if (emptyState) emptyState.classList.remove('hidden');
                    return;
                }
                if (emptyState) emptyState.classList.add('hidden');

                // Load detailed information for each item
                const tableRows = items.map((item, index) => {
                    // Get status badge
                    let statusBadge, statusText;
                    switch (item.design_status) {
                        case 'DESIGNING':
                            statusBadge = 'bg-yellow-100 text-yellow-800';
                            statusText = '🔧 Đang TK';
                            break;
                        case 'DESIGN_CONFIRMED':
                            statusBadge = 'bg-green-100 text-green-800';
                            statusText = '✅ Đã TK';
                            break;
                        case 'BOM_EXTRACTED':
                            statusBadge = 'bg-blue-100 text-blue-800';
                            statusText = '🧱 Đã bóc';
                            break;
                        default:
                            statusBadge = 'bg-gray-100 text-gray-800';
                            statusText = '⏳ Chưa TK';
                    }

                    // Get dimensions from item data
                    const width = item.width_mm || item.width || '—';
                    const height = item.height_mm || item.height || '—';
                    const panels = item.panels || item.number_of_panels || item.number_of_panels || '—';
                    const aluminumSystem = item.aluminum_system_name || item.aluminum_system || '-';
                    const glassType = item.glass_type_name || item.glass_type || '-';
                    const color = item.color_name || item.color || 'Trắng';
                    const quantity = item.quantity || 1;

                    // Validation logic
                    const validationResult = validateTechnicalSpecs(item);
                    let validationBadge = '';
                    if (validationResult.isValid && (!validationResult.warnings || validationResult.warnings.length === 0)) {
                        validationBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>Hợp lệ</span>';
                    } else if (validationResult.isValid && validationResult.warnings.length > 0) {
                        validationBadge = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800" title="${validationResult.warnings.join('; ')}"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.516.915.58 2.003.213 2.98l-.213.334-2.98 1.742-2.98H4.42c-1.53 0-2.493-1.58-1.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>Cảnh báo</span>`;
                    } else {
                        validationBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>Lỗi</span>';
                    }

                    return `
                    <tr class="hover:bg-gray-50 transition-colors ${validationResult.isValid && (!validationResult.warnings || validationResult.warnings.length === 0) ? '' : validationResult.errors.length > 0 ? 'bg-red-50' : 'bg-yellow-50'}" data-item-id="${item.id}" data-status="${item.design_status || 'new'}">
                        <td class="px-4 py-3 text-sm text-gray-700 border-b">${index + 1}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900 border-b">
                            <div class="flex items-center gap-2">
                                ${getProductTypeIcon(item.product_type)}
                                <span>${escapeHtml(item.item_name || 'Sản phẩm')}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700 border-b">
                            <span class="font-medium">${width} × ${height}</span>
                        </td>
                        <td class="px-4 py-3 text-sm border-b text-center">${panels}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 border-b">${escapeHtml(aluminumSystem)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 border-b">${escapeHtml(glassType)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 border-b">${escapeHtml(color)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 border-b text-center font-medium">${quantity}</td>
                        <td class="px-4 py-3 text-sm border-b">
                            <span class="inline-block px-2 py-1 rounded-full text-xs font-medium ${statusBadge}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm border-b">
                            ${validationBadge}
                        </td>
                        <td class="px-4 py-3 text-sm border-b">
                            <button type="button" onclick="onClickProductCard(${item.id}, ${item.project_item_id || 'null'})"
                                class="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-xs font-medium">
                                Chi tiết
                            </button>
                        </td>
                    </tr>
                `;
                });

                if (tbody) {
                    tbody.innerHTML = tableRows.join('');
                }
            }

            function getProductTypeIcon(productType) {
                if (productType === 'window') {
                    return '<span class="text-blue-500">🪟</span>';
                } else if (productType === 'door_swing' || productType === 'door') {
                    return '<span class="text-purple-500">🚪</span>';
                } else if (productType === 'door_sliding') {
                    return '<span class="text-blue-500">🚪</span>';
                } else if (productType === 'glass_wall') {
                    return '<span class="text-green-500">🧱</span>';
                } else if (productType === 'railing') {
                    return '<span class="text-orange-500">🛡️</span>';
                }
                return '<span class="text-gray-500">📦</span>';
            }

            function updateTechnicalSpecsSummary(items) {
                if (!items || items.length === 0) {
                    document.getElementById('step3TotalProducts').textContent = '0';
                    document.getElementById('step3DesignedCount').textContent = '0';
                    document.getElementById('step3DesigningCount').textContent = '0';
                    document.getElementById('step3NotDesignedCount').textContent = '0';
                    return;
                }

                const total = items.length;
                const designed = items.filter(i => i.design_status === 'DESIGN_CONFIRMED' || i.design_status === 'BOM_EXTRACTED').length;
                const designing = items.filter(i => i.design_status === 'DESIGNING').length;
                const notDesigned = items.filter(i => !i.design_status || i.design_status === 'new').length;

                document.getElementById('step3TotalProducts').textContent = total;
                document.getElementById('step3DesignedCount').textContent = designed;
                document.getElementById('step3DesigningCount').textContent = designing;
                document.getElementById('step3NotDesignedCount').textContent = notDesigned;
            }

            function validateTechnicalSpecs(item) {
                const result = {
                    isValid: true,
                    errors: [],
                    warnings: []
                };

                const width = parseFloat(item.width_mm || item.width) || 0;
                const height = parseFloat(item.height_mm || item.height) || 0;
                const panels = parseInt(item.panels || item.panel_count || item.number_of_panels) || 1;
                const aluminumSystem = item.aluminum_system_name || item.aluminum_system || '';
                const glassType = item.glass_type_name || item.glass_type || '';

                // Kiểm tra kích thước
                if (width <= 0 || height <= 0) {
                    result.isValid = false;
                    result.errors.push('Kích thước không hợp lệ');
                }

                // Validation: Cửa > 3000mm phải dùng bản lề chịu lực
                if (width > 3000 || height > 3000) {
                    // Kiểm tra thông tin về hardware/phụ kiện
                    const hardware = item.hardware || item.accessories || [];
                    const hasHeavyDutyHinge = hardware.some(h =>
                        (h.name || '').toLowerCase().includes('bản lề chịu lực') ||
                        (h.name || '').toLowerCase().includes('heavy duty') ||
                        (h.code || '').toLowerCase().includes('heavy')
                    );
                    if (!hasHeavyDutyHinge) {
                        result.warnings.push('Cửa cao trên 3m nên dùng bản lề chịu lực');
                    }
                }

                // Validation: Cửa rộng trên 1.5m với 1 cánh cần kiểm tra
                if (width > 1500 && panels === 1) {
                    result.warnings.push('Cửa 1 cánh rộng trên 1.5m cần kiểm tra khả năng mở');
                }

                // Validation: Kính cường lực với kích thước lớn
                if (glassType && (glassType.toLowerCase().includes('cường lực') || glassType.toLowerCase().includes('tempered'))) {
                    const area = (width * height) / 1000000; // Convert to m²
                    if (area > 3) {
                        result.warnings.push('Kính cường lực diện tích lớn (>3m²) cần kiểm tra độ dày phù hợp');
                    }
                }

                // Validation: Hệ nhôm phải được chọn
                if (!aluminumSystem || aluminumSystem === '—' || aluminumSystem === '-') {
                    result.warnings.push('Chưa chọn hệ nhôm');
                }

                // Nếu có lỗi thì không hợp lệ
                if (result.errors.length > 0) {
                    result.isValid = false;
                }

                return result;
            }

            // Scrap rate settings
            let aluminumScrapRate = 5; // 5% default
            let glassScrapRate = 3; // 3% default
            window.aluminumScrapRate = aluminumScrapRate;
            window.glassScrapRate = glassScrapRate;

            function updateScrapRateSettings() {
                // Show modal or inline form to edit scrap rates
                const newAluminumRate = prompt('Nhập % hao hụt nhôm (mặc định 5%):', aluminumScrapRate);
                if (newAluminumRate !== null && !isNaN(newAluminumRate)) {
                    aluminumScrapRate = parseFloat(newAluminumRate);
                    window.aluminumScrapRate = aluminumScrapRate;
                    const aluminumRateEl = document.getElementById('aluminumScrapRate');
                    if (aluminumRateEl) aluminumRateEl.textContent = aluminumScrapRate + '%';
                }

                const newGlassRate = prompt('Nhập % hao hụt kính (mặc định 3%):', glassScrapRate);
                if (newGlassRate !== null && !isNaN(newGlassRate)) {
                    glassScrapRate = parseFloat(newGlassRate);
                    window.glassScrapRate = glassScrapRate;
                    const glassRateEl = document.getElementById('glassScrapRate');
                    if (glassRateEl) glassRateEl.textContent = glassScrapRate + '%';
                }
            }

            function exportBOMSummary() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }
                // Export BOM summary to Excel
                alert('Chức năng xuất tổng hợp BOM đang được phát triển...');
            }

            let stockCheckData = [];
            let currentStockFilter = 'all';

            async function checkInventory() {
                // Redirect to new inventory check function
                return checkInventoryAll();
            }

            function renderStockCheckResults(items) {
                const container = document.getElementById('stockCheckResults');
                if (!container) {
                    console.warn('stockCheckResults element not found');
                    return;
                }

                if (!items || items.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Chưa có dữ liệu kiểm tra kho. Vui lòng bóc tách BOM ở bước trước.</div>';
                    return;
                }

                container.innerHTML = items.map(item => {
                    const required = parseFloat(item.required_quantity) || 0;
                    const available = parseFloat(item.available_quantity) || 0;
                    const shortage = Math.max(0, required - available);
                    const percentage = required > 0 ? Math.round((available / required) * 100) : 0;

                    // Determine status
                    let statusClass, statusText, statusIcon;
                    if (available >= required) {
                        statusClass = 'border-green-200 bg-green-50';
                        statusText = 'Đủ';
                        statusIcon = '✅';
                    } else if (available > 0) {
                        statusClass = 'border-yellow-200 bg-yellow-50';
                        statusText = 'Thiếu một phần';
                        statusIcon = '⚠️';
                    } else {
                        statusClass = 'border-red-200 bg-red-50';
                        statusText = 'Thiếu hoàn toàn';
                        statusIcon = '❌';
                    }

                    // Reservation status
                    const reserved = parseFloat(item.reserved_quantity) || 0;
                    const reservedBadge = reserved > 0
                        ? `<span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">Đã giữ: ${reserved}</span>`
                        : '';

                    return `
                    <div class="border-2 ${statusClass} rounded-lg p-4 hover:shadow-md" data-status="${available >= required ? 'sufficient' : available > 0 ? 'partial' : 'insufficient'}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span>${statusIcon}</span>
                                    <h3 class="font-semibold text-gray-900">${escapeHtml(item.material_name || item.item_name || 'N/A')}</h3>
                                    <span class="inline-block px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-mono">${escapeHtml(item.material_code || item.item_code || 'N/A')}</span>
                                    ${reservedBadge}
                                </div>
                                <div class="grid grid-cols-3 gap-4 mt-3">
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">Nhu cầu</div>
                                        <div class="text-lg font-bold text-gray-900">${required.toFixed(2)} ${escapeHtml(item.unit || 'cái')}</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">Tồn kho</div>
                                        <div class="text-lg font-bold ${available >= required ? 'text-green-600' : available > 0 ? 'text-yellow-600' : 'text-red-600'}">${available.toFixed(2)} ${escapeHtml(item.unit || 'cái')}</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">Thiếu</div>
                                        <div class="text-lg font-bold text-red-600">${shortage.toFixed(2)} ${escapeHtml(item.unit || 'cái')}</div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="flex items-center justify-between text-gray-600 mb-1">
                                        <span>Tỷ lệ đủ: ${percentage}%</span>
                                        <span>${statusText}</span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="h-full ${available >= required ? 'bg-green-500' : available > 0 ? 'bg-yellow-500' : 'bg-red-500'}" style="width: ${Math.min(100, percentage)}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
            }

            function updateStockCheckSummary(items) {
                if (!items || items.length === 0) return;

                const sufficient = items.filter(i => (i.available_quantity || 0) >= (i.required_quantity || 0)).length;
                const partial = items.filter(i => {
                    const avail = i.available_quantity || 0;
                    const req = i.required_quantity || 0;
                    return avail > 0 && avail < req;
                }).length;
                const insufficient = items.filter(i => (i.available_quantity || 0) === 0 && (i.required_quantity || 0) > 0).length;
                const reserved = items.filter(i => (i.reserved_quantity || 0) > 0).length;

                const suffEl = document.getElementById('step4SufficientCount');
                const partEl = document.getElementById('step4PartialCount');
                const shortEl = document.getElementById('step4ShortageCount');
                const resEl = document.getElementById('step4ReservedCount');

                if (suffEl) suffEl.textContent = sufficient;
                if (partEl) partEl.textContent = partial;
                if (shortEl) shortEl.textContent = insufficient;
                if (resEl) resEl.textContent = reserved;

                // Update filter counts (may not exist in new UI)
                const filterSuffEl = document.getElementById('filterSufficientCount');
                const filterPartEl = document.getElementById('filterPartialCount');
                const filterShortEl = document.getElementById('filterShortageCount');
                if (filterSuffEl) filterSuffEl.textContent = sufficient;
                if (filterPartEl) filterPartEl.textContent = partial;
                if (filterShortEl) filterShortEl.textContent = insufficient;
            }

            function filterStockCheck(filter) {
                currentStockFilter = filter;

                // Update button states
                document.querySelectorAll('.stock-filter-btn').forEach(btn => {
                    btn.classList.remove('border-b-2', 'border-blue-600');
                    btn.classList.add('text-gray-600');
                });
                const activeBtn = document.querySelector(`[data-filter="${filter}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
                    activeBtn.classList.remove('text-gray-600');
                }
                // Filter items
                const items = document.querySelectorAll('#stockCheckResults > div');
                items.forEach(item => {
                    const status = item.getAttribute('data-status');
                    if (filter === 'all' || status === filter) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }

            function moveToProductionWithInsufficientMaterials() {
                alert('Chức năng chuyển sang Sản xuất với vật tư thiếu đang được phát triển...');
                // window.location.href = 'inventory.html';
                return;

                /* LEGACY CODE - Keep for reference
                if (!currentProject || !stockCheckData || stockCheckData.length === 0) {
                    alert('Vui lòng kiểm tra kho trước!');
                    return;
                }
                const allSufficient = stockCheckData.every(item => {
                    const required = item.required_quantity || 0;
                    const available = item.available_quantity || 0;
                    return available >= required;
                });
     
                if (allSufficient) {
                    alert('Tất cả vật tư đều đủ, không cần đặt hàng từng mã!');
                    return;
                }
                */
            }

            // DEPRECATED: Đặt hàng từng mã vật tư
            async function reserveMaterialByCode(materialCode) {
                alert('Chức năng này đã được chuyển sang trang Quản lý Kho. Vui lòng sử dụng chức năng đặt hàng từ trang Kho.');
                // window.location.href = 'inventory.html';
            }

            function createPurchaseRequests() {
                // Store current project data in sessionStorage
                if (currentProject) {
                    sessionStorage.setItem('purchaseRequest_project', JSON.stringify(currentProject));
                }

                // Store inventory check data with shortage quantities (preferred)
                // This includes required, available, and shortage for each material
                if (inventoryCheckData && (inventoryCheckData.nhom.length > 0 || inventoryCheckData.kinh.length > 0 || inventoryCheckData.vattu.length > 0)) {
                    // Convert to purchase request format (only items with shortage > 0)
                    const purchaseData = {
                        nhom: inventoryCheckData.nhom.filter(item => item.shortage > 0).map(item => ({
                            name: item.name || item.item_name,
                            material_name: item.name || item.item_name,
                            material_code: item.code || item.item_code,
                            ma_vat_tu: item.code || item.item_code,
                            density: item.density || 0,
                            ty_trong: item.density || 0,
                            length: item.length_m || 6,
                            length_m: item.length_m || 6,
                            unit: item.unit || 'cây',
                            quantity: item.shortage,  // Use shortage as quantity to order
                            so_luong: item.shortage,
                            weight: (item.shortage * (item.length_m || 6) * (item.density || 0)).toFixed(2),
                            khoi_luong: (item.shortage * (item.length_m || 6) * (item.density || 0)).toFixed(2),
                            required: item.required,
                            available: item.available,
                            note: ''
                        })),
                        vattu: inventoryCheckData.vattu.filter(item => item.shortage > 0).map(item => ({
                            name: item.name || item.item_name,
                            material_name: item.name || item.item_name,
                            material_code: item.code || item.item_code,
                            ma_vat_tu: item.code || item.item_code,
                            unit: item.unit || 'cái',
                            quantity: item.shortage,  // Use shortage as quantity to order
                            so_luong: item.shortage,
                            required: item.required,
                            available: item.available
                        })),
                        kinh: inventoryCheckData.kinh.filter(item => item.shortage > 0).map(item => ({
                            glass_code: item.code || item.glass_code,
                            ma_kinh: item.code || item.glass_code,
                            glass_type: item.name || item.type || item.glass_type,
                            loai_kinh: item.name || item.type || item.glass_type,
                            width: item.width || 0,
                            chieu_rong: item.width || 0,
                            height: item.height || 0,
                            chieu_cao: item.height || 0,
                            panels: item.shortage,  // Use shortage as quantity to order
                            so_tam: item.shortage,
                            unit: 'tấm',
                            area: item.area || 0,
                            dien_tich: item.area || 0,
                            required: item.required,
                            available: item.available
                        }))
                    };
                    sessionStorage.setItem('purchaseRequest_bocTach', JSON.stringify(purchaseData));
                } else if (bocTachData) {
                    // Fallback to original BOM data if inventory check data not available
                    sessionStorage.setItem('purchaseRequest_bocTach', JSON.stringify(bocTachData));
                }

                // Navigate to purchase request page
                window.location.href = 'purchase-request.html';
            }

            function closePurchaseRequestPreview() {
                document.getElementById('purchaseRequestPreview').classList.add('hidden');
            }

            async function confirmCreatePurchaseRequests() {
                if (!currentProject) return;

                const itemsToPurchase = stockCheckData.filter(item => {
                    const required = item.required_quantity || 0;
                    const available = item.available_quantity || 0;
                    return available < required;
                });

                try {
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/purchase-requests`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            items: itemsToPurchase.map(item => ({
                                material_code: item.material_code || item.item_code,
                                material_name: item.material_name || item.item_name,
                                quantity: Math.max(0, (item.required_quantity || 0) - (item.available_quantity || 0)),
                                unit: item.unit || 'cái'
                            }))
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        showSuccessNotification(`Đã tạo ${itemsToPurchase.length} yêu cầu mua hàng thành công!`);
                        closePurchaseRequestPreview();
                        checkInventoryAll();
                    } else {
                        alert(result.message || 'Lỗi khi tạo yêu cầu mua hàng');
                    }
                } catch (error) {
                    console.error('Error creating purchase requests:', error);
                    alert('Lỗi kết nối server khi tạo yêu cầu mua hàng.');
                }
            }

            // =============================
            // NEW: Kiểm tra kho với dữ liệu Bóc tách
            // =============================
            async function checkInventoryAll() {
                if (!bocTachData || (!bocTachData.nhom.length && !bocTachData.kinh.length && !bocTachData.vattu.length)) {
                    alert('Vui lòng bóc tách BOM trước khi kiểm tra kho!');
                    return;
                }

                // Sử dụng mock data trực tiếp (API /inventory/check-availability chưa được triển khai)
                // TODO: Khi API sẵn sàng, uncomment đoạn code gọi API
                console.log('Kiểm tra kho với dữ liệu Bóc tách:', {
                    nhom: bocTachData.nhom.length,
                    kinh: bocTachData.kinh.length,
                    vattu: bocTachData.vattu.length
                });

                checkInventoryAllMock();
            }

            // Mock version for demo (when API not available)
            // Refactored to use real inventory data from API
            async function checkInventoryAllMock() {
                // Fetch real inventory data from API
                let inventoryData = [];
                try {
                    const response = await fetch(`${API_BASE}/inventory`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        inventoryData = result.data;
                        console.log('✅ Loaded inventory data:', inventoryData.length, 'items');
                    }
                } catch (error) {
                    console.error('Error loading inventory data:', error);
                }

                // Create a map of item_code -> quantity
                const inventoryMap = {};
                inventoryData.forEach(item => {
                    const code = (item.item_code || item.code || '').toLowerCase();
                    inventoryMap[code] = parseFloat(item.quantity) || 0;
                });

                const nhomWithStock = bocTachData.nhom.map(item => {
                    const required = parseInt(item.quantity) || 0;
                    const code = (item.code || item.item_code || '').toLowerCase();
                    const available = inventoryMap[code] !== undefined ? inventoryMap[code] : 0;
                    return {
                        ...item,
                        required,
                        available,
                        shortage: Math.max(0, required - available)
                    };
                });

                const kinhWithStock = bocTachData.kinh.map(item => {
                    const required = parseInt(item.quantity) || 1;
                    const code = (item.code || item.glass_code || '').toLowerCase();
                    const available = inventoryMap[code] !== undefined ? inventoryMap[code] : 0;
                    return {
                        ...item,
                        required,
                        available,
                        shortage: Math.max(0, required - available)
                    };
                });

                const vattuWithStock = bocTachData.vattu.map(item => {
                    const required = parseInt(item.quantity) || 0;
                    const code = (item.code || item.item_code || '').toLowerCase();
                    const available = inventoryMap[code] !== undefined ? inventoryMap[code] : 0;
                    return {
                        ...item,
                        required,
                        available,
                        shortage: Math.max(0, required - available)
                    };
                });

                renderKhoNhomTable(nhomWithStock);
                renderKhoKinhTable(kinhWithStock);
                renderKhoVattuTable(vattuWithStock);

                // Store inventory check data globally for later use
                inventoryCheckData = {
                    nhom: nhomWithStock,
                    kinh: kinhWithStock,
                    vattu: vattuWithStock
                };

                const allItems = [...nhomWithStock, ...kinhWithStock, ...vattuWithStock];
                updateInventorySummary(allItems);
            }

            function renderKhoNhomTable(data) {
                const tbody = document.getElementById('khoNhomTableBody');
                if (!tbody || !data || data.length == 0) {
                    if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Không có dữ liệu nhôm</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map((item, index) => {
                    const required = item.required || 0;
                    const available = item.available || 0;
                    const shortage = Math.max(0, required - available);
                    return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-3 text-center text-sm">${index + 1}</td>
                        <td class="px-3 py-3 text-center text-sm font-mono">${item.code || item.item_code || '--'}</td>
                        <td class="px-3 py-3 text-sm">${item.name || item.item_name || '--'}</td>
                        <td class="px-3 py-3 text-center text-sm">${item.unit || 'cây'}</td>
                        <td class="px-3 py-3 text-center text-sm font-semibold text-blue-600">${required}</td>
                        <td class="px-3 py-3 text-center text-sm font-semibold ${available >= required ? 'text-green-600' : available > 0 ? 'text-yellow-600' : 'text-red-600'}">${available}</td>
                        <td class="px-3 py-3 text-center text-sm font-semibold ${shortage > 0 ? 'text-red-600' : 'text-gray-400'}">${shortage}</td>
                    </tr>
                `;
                }).join('');
            }

            function renderKhoKinhTable(data) {
                const tbody = document.getElementById('khoKinhTableBody');
                if (!tbody || !data || data.length === 0) {
                    if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Không có dữ liệu kính</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map((item, index) => {
                    const required = item.required || item.quantity || 1;
                    const available = item.available || 0;
                    const shortage = Math.max(0, required - available);

                    return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-3 text-center text-sm">${index + 1}</td>
                        <td class="px-3 py-3 text-center text-sm font-mono">${item.code || item.glass_code || '--'}</td>
                        <td class="px-3 py-3 text-sm">${item.name || item.glass_type || '--'}</td>
                        <td class="px-3 py-3 text-center text-sm">${item.unit || 'tấm'}</td>
                        <td class="px-3 py-3 text-center text-sm font-semibold text-cyan-600">${required}</td>
                        <td class="px-3 py-3 text-center text-sm font-semibold ${available >= required ? 'text-green-600' : available > 0 ? 'text-yellow-600' : 'text-red-600'}">${available}</td>
                        <td class="px-3 py-3 text-center text-sm font-semibold ${shortage > 0 ? 'text-red-600' : 'text-gray-400'}">${shortage}</td>
                    </tr>
                `;
                }).join('');
            }

            function renderKhoVatTuTable(data) {
                const tbody = document.getElementById('khoVatTuTableBody');
                if (!tbody || !data || data.length === 0) {
                    if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Không có dữ liệu vật tư</td></tr>';
                    return;
                }
                tbody.innerHTML = data.map((item, index) => {
                    const required = item.required || item.quantity || 0;
                    const available = item.available || 0;
                    const shortage = Math.max(0, required - available);

                    return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-3 text-center text-sm">${index + 1}</td>
                        <td class="px-3 py-3 text-center text-sm font-mono">${item.code || item.item_code || '--'}</td>
                        <td class="px-3 py-3 text-sm">${item.name || item.item_name || '--'}</td>
                        <td class="px-3 py-3 text-center text-sm">${item.unit || 'cái'}</td>
                        <td class="px-3 py-3 text-center text-sm font-semibold text-amber-600">${required}</td>
                        <td class="px-3 py-3 text-center text-sm font-semibold ${available >= required ? 'text-green-600' : available > 0 ? 'text-orange-600' : 'text-red-600'}">${available}</td>
                        <td class="px-3 py-3 text-center text-sm font-semibold ${shortage > 0 ? 'text-red-600' : 'text-gray-400'}">${shortage}</td>
                    </tr>
                `;
                }).join('');
            }

            function getStatusBadge(required, available) {
                if (available >= required) {
                    return '<span class="inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">✓ Đủ</span>';
                } else if (available > 0) {
                    return '<span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">⚠ Thiếu</span>';
                } else {
                    return '<span class="inline-block px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">✗ Hết</span>';
                }
            }

            function updateInventorySummary(allItems) {
                let sufficient = 0;
                let partial = 0;
                let shortage = 0;
                if (allItems && allItems.length) {
                    allItems.forEach(item => {
                        const required = item.required || item.quantity || 0;
                        const available = item.available || 0;

                        if (available >= required) {
                            sufficient++;
                        } else if (available > 0) {
                            partial++;
                        } else {
                            shortage++;
                        }
                    });
                }

                const suffEl = document.getElementById('step4SufficientCount');
                const partEl = document.getElementById('step4PartialCount');
                const shortEl = document.getElementById('step4ShortageCount');
                const resEl = document.getElementById('step4ReservedCount');
                if (suffEl) suffEl.textContent = sufficient;
                if (partEl) partEl.textContent = partial;
                if (shortEl) shortEl.textContent = shortage;
                if (resEl) resEl.textContent = 0;
            }

            // ===========================================
            // AUTO SAVE & LOAD BOM DATA
            // ===========================================
            let autoSaveTimer = null;
            let hasBOMChanges = false; // Track if there are unsaved changes

            /**
             * Tự động lưu BOM data sau 500ms user ngừng chỉnh sửa
             * Giảm từ 2s xuống 500ms để đảm bảo data được lưu kịp thời
             */
            function autoSaveBOMData() {
                if (!currentProject) return;

                hasBOMChanges = true; // Mark that we have unsaved changes

                // Xóa timeout cũ
                if (autoSaveTimer) {
                    clearTimeout(autoSaveTimer);
                }
                // Đặt timeout mới - 500ms thay vì 2s
                autoSaveTimer = setTimeout(() => {
                    saveBOMData();
                    hasBOMChanges = false;
                }, 500); // Lưu sau 500ms
            }

            /**
             * Force save ngay lập tức (không chờ timeout)
             * Dùng khi user chuyển step hoặc rời trang
             */
            function flushBOMSave() {
                if (autoSaveTimer) {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = null;
                }
                if (hasBOMChanges && currentProject) {
                    saveBOMData();
                    hasBOMChanges = false;
                }
            }

            /**
             * Cảnh báo khi user rời trang với data chưa lưu
             */
            window.addEventListener('beforeunload', function (e) {
                if (hasBOMChanges && currentProject) {
                    // Force save before leaving
                    flushBOMSave();
                    // Show warning (some browsers ignore custom message)
                    const message = 'Bạn có dữ liệu chưa lưu. Bạn có chắc muốn rời trang?';
                    e.returnValue = message;
                    return message;
                }
            });


            /**
             * Lưu dữ liệu BOM lên server
             */
            async function saveBOMDataToServer() {
                if (!currentProject) {
                    console.warn('Không có project để lưu BOM data');
                    return;
                }
                try {
                    // Sửa: Sử dụng đúng endpoint /api/project-materials/:id/bom-data
                    const response = await fetch(`${API_BASE}/project-materials/${currentProject.id}/bom-data`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            nhom: bocTachData.nhom,
                            kinh: bocTachData.kinh,
                            vattu: bocTachData.vattu
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        console.log('✅ Đã lưu dữ liệu Bóc tách:', result.data);
                        // Subtle notification (optional)
                        // showSuccessNotification();
                    } else {
                        console.error('❌ Lỗi lưu BOM data:', result.message);
                    }
                } catch (error) {
                    console.error('❌ Lỗi khi lưu dữ liệu BOM:', error);
                    console.error('❌ Lỗi lưu BOM data: API endpoint không tồn tại: POST /api/project-materials/' + currentProject.id + '/bom-data');
                }
            }

            function saveBOMData() {
                if (bocTachData && (bocTachData.nhom.length > 0 || bocTachData.kinh.length > 0 || bocTachData.vattu.length > 0)) {
                    saveBOMDataToServer();
                }
            }

            /**
             * Load dữ liệu BOM từ server
             */
            async function loadBOMDataFromServer() {
                if (!currentProject) {
                    console.warn('Không có project để load BOM data');
                    return;
                }

                try {
                    // Sửa: Sử dụng đúng endpoint /api/project-materials/:id/bom-data
                    const response = await fetch(`${API_BASE}/project-materials/${currentProject.id}/bom-data`);

                    if (!response.ok) {
                        // Nếu 404, không có dữ liệu đã lưu, không cần báo lỗi
                        if (response.status === 404) {
                            console.log('ℹ️ Chưa có dữ liệu BOM đã lưu cho project này');
                            return;
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    if (result.success && result.data) {
                        // Khởi tạo bocTachData nếu chưa có
                        if (!bocTachData) {
                            bocTachData = { nhom: [], kinh: [], vattu: [] };
                        }

                        if (result.data.nhom && result.data.nhom.length > 0) {
                            bocTachData.nhom = result.data.nhom;
                            renderBocTachNhomTable(bocTachData.nhom);
                        }

                        if (result.data.kinh && result.data.kinh.length > 0) {
                            bocTachData.kinh = result.data.kinh;
                            renderBocTachKinhTable(bocTachData.kinh);
                        }

                        if (result.data.vattu && result.data.vattu.length > 0) {
                            bocTachData.vattu = result.data.vattu;
                            renderBocTachVatTuTable(bocTachData.vattu);
                        }
                    }
                } catch (error) {
                    // Chỉ log warning, không throw error vì có thể chưa có dữ liệu
                    console.warn('⚠️ Không thể load BOM data từ server:', error.message);
                }
            }

            /**
             * Hiển thị thông báo đã lưu (subtle)
             */
            function showSavedNotification() {
                const notification = document.createElement('div');
                notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg text-sm z-50';
                notification.textContent = 'Đã lưu';
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.classList.add('opacity-0', 'transition-opacity');
                    setTimeout(() => notification.remove(), 300);
                }, 2000);
            }

            function filterTechnicalSpecs() {
                const searchInput = document.getElementById('step3SearchInput');
                const statusFilter = document.getElementById('step3StatusFilter');
                const searchTerm = (searchInput?.value || '').toLowerCase();
                const statusValue = statusFilter?.value || 'all';

                const rows = document.querySelectorAll('#technicalSpecsTableBody tr');

                rows.forEach(row => {
                    const itemId = row.getAttribute('data-item-id');
                    const item = quotationItemsForDesign.find(i =>
                        (i.quotation_item_id || i.id || i.project_item_id) == itemId
                    );

                    if (!item) {
                        row.style.display = 'none';
                        return;
                    }

                    // Filter by status
                    const itemStatus = item.design_status || '';
                    const statusMatch = statusValue === 'all' || itemStatus === statusValue;

                    // Filter by search term
                    const itemName = (item.item_name || '').toLowerCase();
                    const searchMatch = !searchTerm || itemName.includes(searchTerm);

                    if (statusMatch && searchMatch) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            async function calculateStructureForStep4() {
                // Show loading message
                const structureDiv = document.getElementById('structureDesign');
                if (structureDiv) {
                    structureDiv.innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-blue-800">Hệ thống đang tính toán...</p>
                        <p class="text-sm text-blue-600 mt-2">Vui lòng đợi trong giây lát...</p>
                    </div>
                `;
                }

                // If we have a current item, calculate structure
                if (currentItem && currentProject) {
                    try {
                        const response = await fetch(`${API_BASE}/projects/${currentProject.id}/items/${currentItem.id}/calc`, {
                            method: 'POST'
                        });
                        const result = await response.json();

                        if (result.success && structureDiv) {
                            structureDiv.innerHTML = `
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <p class="text-green-800 font-semibold">✅ Tính toán cấu tạo thành công!</p>
                                    <p class="text-sm text-green-600 mt-2">Hệ thống đã tính toán xong cấu tạo nhôm kính.</p>
                                    <p class="text-sm text-gray-600 mt-2">Bạn có thể chuyển sang bước tiếp theo để xem chi tiết BOM.</p>
                            </div>
                        `;
                        }
                    } catch (error) {
                        console.error('Error calculating structure:', error);
                        if (structureDiv) {
                            structureDiv.innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <p class="text-yellow-800">⚠️ Chưa thể tính toán cấu tạo</p>
                                <p class="text-sm text-yellow-600 mt-2">Vui lòng quay lại bước trước và nhập đầy đủ thông số kỹ thuật.</p>
                            </div>
                        `;
                        }
                    }
                }
            }
            // Pricing settings
            let marginPercent = 30; // Default 30%
            let managementCostPercent = 5; // 5% of COGS
            let shippingCostPercent = 3; // 3% of COGS

            async function calculateProjectCosts() {
                return await calculateFullCost();
            }

            async function calculateFullCost() {
                if (!currentProject) return;
                try {
                    // Calculate cost from BOM data
                    const response = await fetch(`${API_BASE}/bom/projects/${currentProject.id}/calculate`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const result = await response.json();
                    if (result.success && result.data) {
                        const data = result.data;
                        // COGS Components - extract from BOM summary
                        const materialCost = data.total_material_cost || data.material_cost || (data.cost_summary && data.cost_summary.material_cost) || 0;
                        const laborCost = data.labor_cost || (data.cost_summary && data.cost_summary.labor_cost) || 0;
                        const machineCost = data.machine_cost || (data.cost_summary && data.cost_summary.machine_cost) || 0;
                        const totalCOGS = materialCost + laborCost + machineCost;
                        // Additional costs
                        const managementCost = totalCOGS * (managementCostPercent / 100);
                        const shippingCost = totalCOGS * (shippingCostPercent / 100);
                        // Selling price with margin
                        const marginAmount = totalCOGS * (marginPercent / 100);
                        const sellingPrice = totalCOGS + marginAmount + managementCost + shippingCost;
                        // Profit analysis
                        const grossProfit = sellingPrice - totalCOGS;
                        const grossProfitPercent = totalCOGS > 0 ? ((grossProfit / sellingPrice) * 100) : 0;
                        const costToPriceRatio = sellingPrice > 0 ? ((totalCOGS / sellingPrice) * 100) : 0;
                        // Update UI
                        updateCostDisplay({
                            materialCost,
                            laborCost,
                            machineCost,
                            totalCOGS,
                            managementCost,
                            shippingCost,
                            sellingPrice,
                            grossProfit,
                            grossProfitPercent,
                            costToPriceRatio
                        });
                    } else {
                        // Fallback: calculate from quotation items
                        await calculateCostsFromQuotationItems();
                    }
                } catch (error) {
                    console.error('Error calculating full cost:', error);
                    console.error('Error details:', {
                        message: error.message,
                        stack: error.stack,
                        projectId: currentProject?.id
                    });
                    // Fallback calculation
                    try {
                        await calculateCostsFromQuotationItems();
                    } catch (fallbackError) {
                        console.error('Fallback calculation also failed:', fallbackError);
                        // Show error to user but don't crash
                        const errorMsg = error.message || 'Không thể tính toán chi phí';
                        alert(`Lỗi: ${errorMsg}. Vui lòng kiểm tra dữ liệu BOM.`);
                    }
                }
            }

            // Fallback: Calculate costs from quotation items if API fails
            async function calculateCostsFromQuotationItems() {
                if (!currentProject) return;
                try {
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/quotation-items-for-design`);
                    const result = await response.json();
                    if (result.success && result.data && result.data.items) {
                        // Placeholder calculation - estimate from items
                        let materialCost = 0;
                        let laborCost = 0;
                        let machineCost = 0;
                        result.data.items.forEach(item => {
                            // Estimate area (m2)
                            const area = (parseFloat(item.width_mm || 0) * parseFloat(item.height_mm || 0)) / 1000000 * (item.quantity || 1);
                            materialCost += (item.quantity || 1) * 500000; // Estimate 500k VND per item
                            laborCost += area * (item.quantity || 1) * 200000; // Estimate 200k/m²
                        });
                        machineCost = materialCost * 0.05; // 5% of material cost
                        const totalCOGS = materialCost + laborCost + machineCost;
                        const managementCost = totalCOGS * (managementCostPercent / 100);
                        const shippingCost = totalCOGS * (shippingCostPercent / 100);
                        const marginAmount = totalCOGS * (marginPercent / 100);
                        const sellingPrice = totalCOGS + marginAmount + managementCost + shippingCost;
                        const grossProfit = sellingPrice - totalCOGS;
                        const grossProfitPercent = sellingPrice > 0 ? ((grossProfit / sellingPrice) * 100) : 0;
                        const costToPriceRatio = sellingPrice > 0 ? ((totalCOGS / sellingPrice) * 100) : 0;
                        updateCostDisplay({
                            materialCost,
                            laborCost,
                            machineCost,
                            totalCOGS,
                            managementCost,
                            shippingCost,
                            sellingPrice,
                            grossProfit,
                            grossProfitPercent,
                            costToPriceRatio
                        });
                    }
                } catch (error) {
                    console.error('Error calculating from quotation items:', error);
                }
            }

            function updateCostDisplay(costs) {
                // COGS components
                document.getElementById('step5MaterialCost').textContent = formatCurrency(costs.materialCost);
                document.getElementById('step5LaborCost').textContent = formatCurrency(costs.laborCost);
                document.getElementById('step5MachineCost').textContent = formatCurrency(costs.machineCost);
                document.getElementById('step5TotalCOGS').textContent = formatCurrency(costs.totalCOGS);
                // Percentages
                const total = costs.totalCOGS || 1;
                document.getElementById('step5MaterialPercent').textContent = Math.round((costs.materialCost / total) * 100) + '%';
                document.getElementById('step5LaborPercent').textContent = Math.round((costs.laborCost / total) * 100) + '%';
                document.getElementById('step5MachinePercent').textContent = Math.round((costs.machineCost / total) * 100) + '%';
                // Pricing
                document.getElementById('step5ManagementCost').textContent = formatCurrency(costs.managementCost);
                document.getElementById('step5ShippingCost').textContent = formatCurrency(costs.shippingCost);
                document.getElementById('step5SellingPrice').textContent = formatCurrency(costs.sellingPrice);
                // Profit analysis
                document.getElementById('step5GrossProfit').textContent = formatCurrency(costs.grossProfit);
                document.getElementById('step5GrossProfitPercent').textContent = costs.grossProfitPercent.toFixed(1) + '%';
                document.getElementById('step5CostToPriceRatio').textContent = costs.costToPriceRatio.toFixed(1) + '%';
                // Efficiency rating
                const efficiencyEl = document.getElementById('step5EfficiencyRating');
                const efficiencyNoteEl = document.getElementById('step5EfficiencyNote');
                if (costs.grossProfitPercent >= 30) {
                    efficiencyEl.textContent = 'Xuất sắc';
                    efficiencyEl.className = 'text-xl font-bold text-green-600';
                    efficiencyNoteEl.textContent = 'Lợi nhuận rất cao';
                } else if (costs.grossProfitPercent >= 25) {
                    efficiencyEl.textContent = 'Tốt';
                    efficiencyEl.className = 'text-xl font-bold text-emerald-600';
                    efficiencyNoteEl.textContent = 'Lợi nhuận hợp lý';
                } else if (costs.grossProfitPercent >= 15) {
                    efficiencyEl.textContent = 'Trung bình';
                    efficiencyEl.className = 'text-xl font-bold text-yellow-600';
                    efficiencyNoteEl.textContent = 'Cần cải thiện';
                } else {
                    efficiencyEl.textContent = 'Thấp';
                    efficiencyEl.className = 'text-xl font-bold text-red-600';
                    efficiencyNoteEl.textContent = 'Rủi ro cao';
                }
            }

            function updatePricingSettings() {
                const newMargin = prompt('Nhập % lợi nhuận (hiện tại ' + marginPercent + '%):', marginPercent);
                if (newMargin !== null && !isNaN(newMargin)) {
                    marginPercent = parseFloat(newMargin);
                    const marginSlider = document.getElementById('marginSlider');
                    if (marginSlider) marginSlider.value = marginPercent;
                    const marginPercentEl = document.getElementById('marginPercent');
                    if (marginPercentEl) marginPercentEl.textContent = marginPercent + '%';
                    calculateFullCost();
                }
            }

            function formatCurrency(amount) {
                return new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(amount);
            }

            // ===========================================
            // STEP 6: Tính giá đơn giá
            // ===========================================
            /**
             * Load dữ liệu từ Bóc tách và hiển thị
             */
            function loadStep5Data() {
                if (!bocTachData) {
                    console.warn('⚠️ No BOM data to load');
                    return;
                }

                // Tính tổng trọng lượng nhôm (kg)
                let totalNhomWeight = 0;
                if (bocTachData.nhom && bocTachData.nhom.length > 0) {
                    bocTachData.nhom.forEach(item => {
                        totalNhomWeight += parseFloat(item.weight_kg || (item.density || 0) * (item.quantity || 0)) || 0;
                    });
                }

                // Tính tổng diện tích kính (m²)
                let totalKinhArea = 0;
                if (bocTachData.kinh && bocTachData.kinh.length > 0) {
                    bocTachData.kinh.forEach(item => {
                        totalKinhArea += parseFloat(item.area_m2 || ((item.width_mm || 0) * (item.height_mm || 0) / 1000000 * (item.quantity || 0))) || 0;
                    });
                }

                // Đếm số loại Phụ kiện
                let totalVattuCount = (bocTachData.vattu && bocTachData.vattu.length) || 0;

                // Update summary cards
                const step5NhomQtyEl = document.getElementById('step5NhomQty');
                if (step5NhomQtyEl) step5NhomQtyEl.textContent = totalNhomWeight.toFixed(2);
                const step5NhomUnitEl = document.getElementById('step5NhomUnit');
                if (step5NhomUnitEl) step5NhomUnitEl.textContent = 'kg';

                const step5KinhQtyEl = document.getElementById('step5KinhQty');
                if (step5KinhQtyEl) step5KinhQtyEl.textContent = totalKinhArea.toFixed(2);

                const step5VattuQtyEl = document.getElementById('step5VattuQty');
                if (step5VattuQtyEl) step5VattuQtyEl.textContent = totalVattuCount;

                // Update table cells
                const step5NhomQtyCell = document.getElementById('step5NhomQtyCell');
                if (step5NhomQtyCell) step5NhomQtyCell.textContent = totalNhomWeight.toFixed(2);
                const step5NhomUnitCell = document.getElementById('step5NhomUnitCell');
                if (step5NhomUnitCell) step5NhomUnitCell.textContent = 'kg';

                const step5KinhQtyCell = document.getElementById('step5KinhQtyCell');
                if (step5KinhQtyCell) step5KinhQtyCell.textContent = totalKinhArea.toFixed(2);

                const step5VattuQtyCell = document.getElementById('step5VattuQtyCell');
                if (step5VattuQtyCell) step5VattuQtyCell.textContent = totalVattuCount;

                // Load default prices from inventory if available
                loadDefaultPrices();

                // Tính toán tổng tiền
                calculateStep5Total();
            }

            /**
             * Tính tổng giá Step 5
             */
            function calculateStep5Total() {
                // Lấy số lượng từ summary cards hoặc table cells
                const step5NhomQtyEl = document.getElementById('step5NhomQty');
                const step5KinhQtyEl = document.getElementById('step5KinhQty');
                const step5VattuQtyEl = document.getElementById('step5VattuQty');

                const nhomQty = step5NhomQtyEl ? (parseFloat(step5NhomQtyEl.textContent) || 0) : 0;
                const kinhQty = step5KinhQtyEl ? (parseFloat(step5KinhQtyEl.textContent) || 0) : 0;
                const vattuQty = step5VattuQtyEl ? (parseFloat(step5VattuQtyEl.textContent) || 0) : 0;

                // Lấy giá từ input fields
                const step5NhomPriceEl = document.getElementById('step5NhomPrice');
                const step5KinhPriceEl = document.getElementById('step5KinhPrice');
                const step5VattuPriceEl = document.getElementById('step5VattuPrice');

                const nhomPrice = step5NhomPriceEl ? (parseFloat(step5NhomPriceEl.value) || 0) : 0;
                const kinhPrice = step5KinhPriceEl ? (parseFloat(step5KinhPriceEl.value) || 0) : 0;
                const vattuPrice = step5VattuPriceEl ? (parseFloat(step5VattuPriceEl.value) || 0) : 0;

                // Tính tiền
                const nhomTotal = nhomQty * nhomPrice;
                const kinhTotal = kinhQty * kinhPrice;
                const vattuTotal = vattuQty * vattuPrice;

                // Tổng COGS (Chi phí vốn)
                const grandTotal = nhomTotal + kinhTotal + vattuTotal;

                // Tính phần trăm
                const total = grandTotal || 1;
                const nhomPercent = (nhomTotal / total * 100).toFixed(1);
                const kinhPercent = (kinhTotal / total * 100).toFixed(1);
                const vattuPercent = (vattuTotal / total * 100).toFixed(1);

                // Update UI - Cost Breakdown
                const nhomTotalEl = document.getElementById('step5NhomTotal');
                if (nhomTotalEl) nhomTotalEl.textContent = formatCurrency(nhomTotal);
                const nhomPercentEl = document.getElementById('step5NhomPercent');
                if (nhomPercentEl) nhomPercentEl.textContent = nhomPercent + '%';

                const kinhTotalEl = document.getElementById('step5KinhTotal');
                if (kinhTotalEl) kinhTotalEl.textContent = formatCurrency(kinhTotal);
                const kinhPercentEl = document.getElementById('step5KinhPercent');
                if (kinhPercentEl) kinhPercentEl.textContent = kinhPercent + '%';

                const vattuTotalEl = document.getElementById('step5VattuTotal');
                if (vattuTotalEl) vattuTotalEl.textContent = formatCurrency(vattuTotal);
                const vattuPercentEl = document.getElementById('step5VattuPercent');
                if (vattuPercentEl) vattuPercentEl.textContent = vattuPercent + '%';

                const grandTotalEl = document.getElementById('step5GrandTotal');
                if (grandTotalEl) grandTotalEl.textContent = formatCurrency(grandTotal);

                // Update UI - Table totals
                const nhomTotalCell = document.getElementById('step5NhomTotalCell');
                if (nhomTotalCell) nhomTotalCell.textContent = formatCurrency(nhomTotal);
                const kinhTotalCell = document.getElementById('step5KinhTotalCell');
                if (kinhTotalCell) kinhTotalCell.textContent = formatCurrency(kinhTotal);
                const vattuTotalCell = document.getElementById('step5VattuTotalCell');
                if (vattuTotalCell) vattuTotalCell.textContent = formatCurrency(vattuTotal);

                // Tính giá bán với biên lợi nhuận và chi phí phụ
                const marginInputEl = document.getElementById('step5MarginInput');
                const marginPercentValue = marginInputEl ? (parseFloat(marginInputEl.value) || 30) : 30;

                // Chi phí quản lý (5%) và vận chuyển (3%)
                const managementCost = grandTotal * 0.05;
                const shippingCost = grandTotal * 0.03;
                const marginAmount = grandTotal * (marginPercentValue / 100);

                // Giá bán = COGS + Margin + Chi phí quản lý + Chi phí vận chuyển
                const sellingPrice = grandTotal + marginAmount + managementCost + shippingCost;
                const profit = sellingPrice - grandTotal - managementCost - shippingCost;
                const profitPercent = grandTotal > 0 ? (profit / sellingPrice * 100) : 0;

                // Update UI - Pricing
                const managementCostEl = document.getElementById('step5ManagementCost');
                if (managementCostEl) managementCostEl.textContent = formatCurrency(managementCost);

                const shippingCostEl = document.getElementById('step5ShippingCost');
                if (shippingCostEl) shippingCostEl.textContent = formatCurrency(shippingCost);

                const sellingPriceEl = document.getElementById('step5SellingPrice');
                if (sellingPriceEl) sellingPriceEl.textContent = formatCurrency(sellingPrice);

                const profitEl = document.getElementById('step5ProfitDisplay');
                if (profitEl) profitEl.textContent = formatCurrency(profit);

                const profitPercentEl = document.getElementById('step5ProfitPercent');
                if (profitPercentEl) profitPercentEl.textContent = profitPercent.toFixed(1) + '%';
            }

            /**
             * Toggle margin settings
             */
            function toggleMarginSettings() {
                const marginInput = document.getElementById('step5MarginInput');
                if (!marginInput) {
                    console.warn('step5MarginInput not found');
                    return;
                }
                const currentValue = marginInput.value;
                const newValue = prompt('Nhập biên lợi nhuận (%)', currentValue);

                if (newValue !== null && !isNaN(newValue)) {
                    marginInput.value = parseFloat(newValue);
                    calculateStep5Total();
                }
            }

            /**
             * Refresh Step 5 data
             */
            function refreshStep5Data() {
                console.log('🔄 Refreshing Step 5 data...');
                loadBOMDataFromServer().then(() => {
                    loadStep5Data();
                });
            }

            /**
             * Load default prices from inventory
             */
            async function loadDefaultPrices() {
                if (!bocTachData) return;

                try {
                    // Load inventory to get average prices
                    const response = await fetch(`${API_BASE}/inventory?item_type=all`);
                    const result = await response.json();

                    if (result.success && result.data) {
                        const inventory = result.data;

                        // Calculate average price for aluminum (nhôm)
                        const aluminumItems = inventory.filter(inv => inv.item_type === 'aluminum' && inv.unit_price > 0);
                        if (aluminumItems.length > 0) {
                            const avgAluminumPrice = aluminumItems.reduce((sum, item) => sum + (item.unit_price || 0), 0) / aluminumItems.length;
                            const nhomPriceEl = document.getElementById('step5NhomPrice');
                            if (nhomPriceEl && !nhomPriceEl.value || nhomPriceEl.value === '0') {
                                nhomPriceEl.value = Math.round(avgAluminumPrice);
                            }
                        }

                        // Calculate average price for glass (kính)
                        const glassItems = inventory.filter(inv => inv.item_type === 'glass' && inv.unit_price > 0);
                        if (glassItems.length > 0) {
                            const avgGlassPrice = glassItems.reduce((sum, item) => sum + (item.unit_price || 0), 0) / glassItems.length;
                            const kinhPriceEl = document.getElementById('step5KinhPrice');
                            if (kinhPriceEl && (!kinhPriceEl.value || kinhPriceEl.value === '0')) {
                                kinhPriceEl.value = Math.round(avgGlassPrice);
                            }
                        }

                        // Calculate average price for accessories (vật tư phụ)
                        const materialItems = inventory.filter(inv => (inv.item_type === 'material' || inv.item_type === 'accessory') && inv.unit_price > 0);
                        if (materialItems.length > 0) {
                            const avgMaterialPrice = materialItems.reduce((sum, item) => sum + (item.unit_price || 0), 0) / materialItems.length;
                            const vattuPriceEl = document.getElementById('step5VattuPrice');
                            if (vattuPriceEl && (!vattuPriceEl.value || vattuPriceEl.value === '0')) {
                                vattuPriceEl.value = Math.round(avgMaterialPrice);
                            }
                        }

                        // Recalculate after loading prices
                        calculateStep5Total();
                    }
                } catch (error) {
                    console.warn('⚠️ Could not load default prices from inventory:', error);
                }
            }

            /**
             * Export quotation
             */
            function exportQuotation() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }

                // Get pricing data
                const sellingPriceEl = document.getElementById('step5SellingPrice');
                const sellingPrice = sellingPriceEl ? parseFloat(sellingPriceEl.textContent.replace(/[^\d]/g, '')) : 0;

                if (sellingPrice === 0) {
                    alert('Vui lòng nhập giá đơn vị và tính toán giá trước!');
                    return;
                }

                // Navigate to quotation page or export
                if (confirm('Xuất báo giá cho dự án này?')) {
                    window.location.href = `quotation-new.html?projectId=${currentProject.id}&totalAmount=${sellingPrice}`;
                }
            }

            /**
             * Save quotation
             */
            async function saveQuotation() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }

                const sellingPriceEl = document.getElementById('step5SellingPrice');
                const sellingPrice = sellingPriceEl ? parseFloat(sellingPriceEl.textContent.replace(/[^\d]/g, '')) : 0;

                if (sellingPrice === 0) {
                    alert('Vui lòng tính toán giá trước khi lưu!');
                    return;
                }

                try {
                    // Get pricing breakdown
                    const grandTotalEl = document.getElementById('step5GrandTotal');
                    const grandTotal = grandTotalEl ? parseFloat(grandTotalEl.textContent.replace(/[^\d]/g, '')) : 0;

                    const nhomTotalEl = document.getElementById('step5NhomTotal');
                    const kinhTotalEl = document.getElementById('step5KinhTotal');
                    const vattuTotalEl = document.getElementById('step5VattuTotal');

                    const nhomTotal = nhomTotalEl ? parseFloat(nhomTotalEl.textContent.replace(/[^\d]/g, '')) : 0;
                    const kinhTotal = kinhTotalEl ? parseFloat(kinhTotalEl.textContent.replace(/[^\d]/g, '')) : 0;
                    const vattuTotal = vattuTotalEl ? parseFloat(vattuTotalEl.textContent.replace(/[^\d]/g, '')) : 0;

                    const marginInputEl = document.getElementById('step5MarginInput');
                    const marginPercent = marginInputEl ? parseFloat(marginInputEl.value) : 30;

                    // Save to project or create quotation
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/update-pricing`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            total_cost: grandTotal,
                            selling_price: sellingPrice,
                            margin_percent: marginPercent,
                            cost_breakdown: {
                                nhom: nhomTotal,
                                kinh: kinhTotal,
                                vattu: vattuTotal
                            },
                            bom_data: bocTachData
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        showToast('Đã lưu báo giá thành công!', 'success');
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể lưu báo giá'));
                    }
                } catch (error) {
                    console.error('Error saving quotation:', error);
                    alert('Lỗi kết nối server');
                }
            }

            /**
             * Complete project
             */
            async function completeProject() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }

                const sellingPriceEl = document.getElementById('step5SellingPrice');
                const sellingPrice = sellingPriceEl ? parseFloat(sellingPriceEl.textContent.replace(/[^\d]/g, '')) : 0;

                if (sellingPrice === 0) {
                    if (!confirm('Giá bán đang là 0. Bạn có muốn tiếp tục hoàn thành dự án không?')) {
                        return;
                    }
                }

                if (confirm('Xác nhận hoàn thành dự án?\n\nDự án sẽ được chuyển sang trạng thái hoàn thành.')) {
                    try {
                        // Save quotation first
                        await saveQuotation();

                        // Update project status
                        const response = await fetch(`${API_BASE}/projects/${currentProject.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                status: 'completed',
                                progress_percent: 100
                            })
                        });

                        const result = await response.json();
                        if (result.success) {
                            showToast('Đã hoàn thành dự án!', 'success');
                            setTimeout(() => {
                                window.location.href = 'projects.html';
                            }, 2000);
                        } else {
                            alert('Lỗi: ' + (result.message || 'Không thể hoàn thành dự án'));
                        }
                    } catch (error) {
                        console.error('Error completing project:', error);
                        alert('Lỗi kết nối server');
                    }
                }
            }

            async function createQuotation() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/create-quotation`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (result.success) {
                        showSuccessNotification('Đã chuyển sang báo giá thành công!');
                        window.location.href = 'quotation-new.html?projectId=' + currentProject.id;
                    } else {
                        alert('Lỗi: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error exporting to quotation:', error);
                    alert('Lỗi kết nối server');
                }
            }

            // Chuyển sang Sản xuất với chưa đủ vật tư
            async function moveToProductionWithInsufficientMaterials() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }

                if (confirm('Xác nhận chuyển sang giai đoạn Sản xuất?\n\nLưu ý: Dự án vẫn ở giai đoạn Thiết kế và Bóc tách do chưa đủ vật tư.')) {
                    try {
                        const token = localStorage.getItem('token');
                        // Cập nhật project status thành 'in_production' nhưng giữ progress_percent ở mức thiết kế/bóc tách
                        const response = await fetch(`${API_BASE}/projects/${currentProject.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                status: 'in_production',
                                progress_percent: 40, // Giữ ở mức bóc tách (40%)
                                notes: (currentProject.notes || '') + '\n[Chuyển SX - Chưa đủ vật tư]'
                            })
                        });

                        const result = await response.json();
                        if (result.success) {
                            // Tạo production order nếu chưa có
                            await ensureProductionOrder(currentProject.id);

                            alert('✅ Đã chuyển sang giai đoạn Sản xuất!\n\nDự án vẫn ở giai đoạn Thiết kế và Bóc tách do chưa đủ vật tư.');
                            window.location.href = 'production.html';
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Error moving to production:', error);
                        alert('Lỗi khi chuyển sang sản xuất.');
                    }
                }
            }

            // Chuyển sang sản xuất khi đầy đủ vật tư
            async function moveToProductionWithFullMaterials() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }

                if (confirm('Xác nhận chuyển sang giai đoạn Sản xuất?\n\nDự án đã đầy đủ vật tư, sẽ chuyển hoàn toàn sang sản xuất.')) {
                    try {
                        const token = localStorage.getItem('token');
                        // Cập nhật project status thành 'in_production' với progress_percent = 60%
                        const response = await fetch(`${API_BASE}/projects/${currentProject.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                status: 'in_production',
                                progress_percent: 60, // Chuyển sang sản xuất (60%)
                                notes: (currentProject.notes || '') + '\n[Chuyển SX - Đầy đủ vật tư]'
                            })
                        });

                        const result = await response.json();
                        if (result.success) {
                            // Tạo production order nếu chưa có
                            await ensureProductionOrder(currentProject.id);

                            alert('✅ Đã chuyển sang giai đoạn Sản xuất!\n\nDự án đã đầy đủ vật tư.');
                            window.location.href = 'production.html';
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Error moving to production:', error);
                        alert('Lỗi khi chuyển sang sản xuất.');
                    }
                }
            }

            // Đảm bảo có production order
            async function ensureProductionOrder(projectId) {
                try {
                    // Kiểm tra xem đã có production order chưa
                    const checkResponse = await fetch(`${API_BASE}/production-orders?project_id=${projectId}`);
                    const checkResult = await checkResponse.json();

                    if (checkResult.success && checkResult.data && checkResult.data.length > 0) {
                        // Đã có production order
                        return;
                    }

                    // Tạo production order mới
                    const year = new Date().getFullYear();
                    const orderCode = `SX-${year}-${String(Date.now()).slice(-4)}`;

                    const createResponse = await fetch(`${API_BASE}/production-orders`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            project_id: projectId,
                            order_code: orderCode,
                            order_date: new Date().toISOString().split('T')[0],
                            status: 'pending',
                            priority: 'normal',
                            notes: 'Tự động tạo khi chuyển sang giai đoạn sản xuất'
                        })
                    });

                    const createResult = await createResponse.json();
                    if (createResult.success) {
                        console.log('✅ Đã tạo production order:', orderCode);
                    }
                } catch (error) {
                    console.error('Error ensuring production order:', error);
                    // Không throw để không làm gián đoạn flow chính
                }
            }

            // ======== BOM TAB FUNCTIONS ========
            function showBOMTab(tabName) {
                // Hide all bom sections
                document.querySelectorAll('.bom-section, [id^="bom"]').forEach(section => {
                    if (section.id && section.id.startsWith('bom')) {
                        section.classList.add('hidden');
                    }
                });

                // Show selected tab
                const tabMap = {
                    'aluminum': 'bomAluminum',
                    'glass': 'bomGlass',
                    'accessories': 'bomAccessories',
                    'consumables': 'bomConsumables'
                };

                const tabId = tabMap[tabName];
                if (tabId) {
                    const tabElement = document.getElementById(tabId);
                    if (tabElement) {
                        tabElement.classList.remove('hidden');
                    }
                }

                // Update tab button styles
                document.querySelectorAll('.bom-tab').forEach(btn => {
                    btn.classList.remove('active', 'border-b-2', 'border-purple-600', 'text-purple-600');
                    btn.classList.add('text-gray-600');
                });

                const activeBtn = event?.target;
                if (activeBtn) {
                    activeBtn.classList.add('active', 'border-b-2', 'border-purple-600', 'text-purple-600');
                    activeBtn.classList.remove('text-gray-600');
                }

                // Load data if needed
                loadBOMData(tabName);
            }

            function viewBOM(itemId) {
                // Navigate to BOM view
                window.location.href = `design-new.html?projectId=${currentProject.id}&doorId=${itemId}`;
            }

            function exportBOM() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }
                // Export BOM functionality
                alert('Chức năng xuất BOM đang được phát triển...');
            }

            function viewCostSummary() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }
                // View cost summary
                alert('Chức năng tổng hợp chi phí đang được phát triển...');
            }

            function exportDrawing() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }
                // Export drawing functionality
                try {
                    const url = `${API_BASE}/projects/${currentProject.id}/export-drawing`;
                    window.open(url, '_blank');
                } catch (error) {
                    console.error('Error exporting drawing:', error);
                    alert('Lỗi khi xuất bản vẽ. Vui lòng thử lại.');
                }
            }

            function exportDimensions() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }
                // Export dimensions functionality
                try {
                    const url = `${API_BASE}/projects/${currentProject.id}/export-dimensions`;
                    window.open(url, '_blank');
                } catch (error) {
                    console.error('Error exporting dimensions:', error);
                    alert('Lỗi khi xuất kích thước. Vui lòng thử lại.');
                }
            }

            function exportEntireProject() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }
                // Export entire project functionality
                try {
                    const url = `${API_BASE}/projects/${currentProject.id}/export-project`;
                    window.open(url, '_blank');
                } catch (error) {
                    console.error('Error exporting project:', error);
                    alert('Lỗi khi xuất toàn bộ công trình. Vui lòng thử lại.');
                }
            }

            function showBOMTab(tab) {
                // Hide all tabs
                document.querySelectorAll('.bom-section').forEach(section => {
                    section.classList.add('hidden');
                });
                document.querySelectorAll('.bom-tab').forEach(btn => {
                    btn.classList.remove('active', 'border-b-2', 'border-purple-600', 'text-purple-600');
                    btn.classList.add('text-gray-600');
                });

                // Show selected tab
                document.getElementById(`bom${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.remove('hidden');
                event.currentTarget.classList.add('active', 'border-b-2', 'border-purple-600', 'text-purple-600');
                event.currentTarget.classList.remove('text-gray-600');

                // Load BOM data for selected tab
                loadBOMData(tab);
            }

            // Load BOM for all products in step 4
            async function loadAllProductsBOM() {
                if (!currentProject) return;

                // Reload quotation items if needed
                if (!quotationItemsForDesign || quotationItemsForDesign.length === 0) {
                    await loadQuotationItemsForDesign(currentProject.id);
                }

                renderProductsBOMList(quotationItemsForDesign);
                updateBOMSummary(quotationItemsForDesign);
            }

            function renderProductsBOMList(items) {
                const container = document.getElementById('step4ProductsList');
                const emptyState = document.getElementById('step4EmptyState');

                if (!items || items.length === 0) {
                    if (container) container.innerHTML = '';
                    if (emptyState) emptyState.classList.remove('hidden');
                    return;
                }

                if (emptyState) emptyState.classList.add('hidden');

                // Filter items that have been designed (have project_item_id)
                const designedItems = items.filter(item => item.project_item_id);

                if (designedItems.length === 0) {
                    if (container) container.innerHTML = '<div class="text-center py-8 text-gray-500">Chưa có sản phẩm nào được thiết kế. Vui lòng thiết kế sản phẩm ở các bước trước.</div>';
                    if (emptyState) emptyState.classList.remove('hidden');
                    return;
                }

                if (!container) {
                    console.warn('step4ProductsList element not found');
                    return;
                }

                container.innerHTML = designedItems.map((item, index) => {
                    const itemId = item.project_item_id || item.id;
                    const uniqueId = `product-bom-${itemId}-${index}`;

                    return `
                    <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-shadow">
                        <!-- Header (Clickable) -->
                        <div class="bg-gray-50 px-6 py-4 cursor-pointer flex items-center justify-between" onclick="toggleProductBOM('${uniqueId}')">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                                    ${getProductTypeIcon(item.product_type)}
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-900">${item.item_name || 'N/A'}</h3>
                                    <div class="flex items-center gap-4 mt-1 text-sm text-gray-600">
                                        <span>Kích thước: <strong>${item.width_mm || '?'} x ${item.height_mm || '?'} mm</strong></span>
                                        <span>Số lượng: <strong>${item.quantity || 1}</strong></span>
                                        <span>Hệ nhôm: <strong>${item.aluminum_system_name || item.aluminum_system || '—'}</strong></span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="event.stopPropagation(); extractBOM(${item.project_item_id || item.id}, '${uniqueId}')"
                                    class="px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium flex items-center gap-1"
                                    title="Bóc tách BOM">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Bóc tách
                                </button>
                                <span class="text-xs px-2 py-1 rounded-full ${item.design_status === 'BOM_EXTRACTED' ? 'bg-green-100 text-green-800' : item.design_status === 'DESIGN_CONFIRMED' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${item.design_status === 'BOM_EXTRACTED' ? '✅ Đã bóc' : item.design_status === 'DESIGN_CONFIRMED' ? '🔧 Đã TK' : '⏳ Chưa TK'}
                                </span>
                                <svg id="icon-${uniqueId}" class="w-5 h-5 text-gray-400 transition-transform cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>

                        <!-- BOM Content (Collapsible) -->
                        <div id="${uniqueId}" class="hidden border-t border-gray-200">
                            <div class="p-6">
                                <!-- Material Type Tabs -->
                                <div class="border-b border-gray-200 mb-4">
                                    <div class="flex gap-4">
                                        <button onclick="showProductBOMTab('${uniqueId}', 'aluminum')" class="product-bom-tab active px-4 py-2 border-b-2 border-purple-600 text-purple-600"
                                            data-tab="aluminum">
                                            Nhôm
                                        </button>
                                        <button onclick="showProductBOMTab('${uniqueId}', 'glass')"
                                            class="product-bom-tab px-4 py-2 font-medium text-gray-600 hover:text-gray-900"
                                            data-tab="glass">
                                            Kính
                                        </button>
                                        <button onclick="showProductBOMTab('${uniqueId}', 'accessories')"
                                            class="product-bom-tab px-4 py-2 font-medium text-gray-600 hover:text-gray-900"
                                            data-tab="accessories">
                                            Phụ kiện
                                        </button>
                                        <button onclick="showProductBOMTab('${uniqueId}', 'consumables')"
                                            class="product-bom-tab px-4 py-2 font-medium text-gray-600 hover:text-gray-900"
                                            data-tab="consumables">
                                            Gioăng/Keo
                                        </button>
                                    </div>
                                </div>

                                <!-- BOM Content Tabs -->
                                <div id="${uniqueId}-aluminum" class="product-bom-content">
                                    <div class="overflow-x-auto">
                                        <table class="w-full">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tên thay</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chiều dài</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Số lượng</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tổng (m)</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hao hụt</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tổng + hao hụt</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phân loại</th>
                                                </tr>
                                            </thead>
                                            <tbody id="${uniqueId}-aluminum-list" class="bg-white divide-y divide-gray-200">
                                                <tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Đang tải...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div id="${uniqueId}-glass" class="product-bom-content hidden">
                                    <div class="overflow-x-auto">
                                        <table class="w-full">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã kính</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Loại kính</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kích thước (mm)</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Diện tích (m²)</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Số lượng</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tổng (m²)</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hao hụt</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tổng + hao hụt</th>
                                                </tr>
                                            </thead>
                                            <tbody id="${uniqueId}-glass-list" class="bg-white divide-y divide-gray-200">
                                                <tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Đang tải...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div id="${uniqueId}-accessories" class="product-bom-content hidden">
                                    <div class="overflow-x-auto">
                                        <table class="w-full">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã phụ kiện</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tên phụ kiện</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Đơn vị</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Số lượng</th>
                                                </tr>
                                            </thead>
                                            <tbody id="${uniqueId}-accessories-list" class="bg-white divide-y divide-gray-200">
                                                <tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Đang tải...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div id="${uniqueId}-consumables" class="product-bom-content hidden">
                                    <div class="overflow-x-auto">
                                        <table class="w-full">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã vật tư</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tên vật tư</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Đơn vị</th>
                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Số lượng</th>
                                                </tr>
                                            </thead>
                                            <tbody id="${uniqueId}-consumables-list" class="bg-white divide-y divide-gray-200">
                                                <tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Đang tải...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                    </div>
                `;
                }).join('');

                // Load BOM data for each product
                designedItems.forEach((item, index) => {
                    const itemId = item.project_item_id || item.id;
                    const uniqueId = `product-bom-${itemId}-${index}`;
                    loadProductBOM(itemId, uniqueId);
                });
            }

            function toggleProductBOM(uniqueId) {
                const content = document.getElementById(uniqueId);
                const icon = document.getElementById(`icon-${uniqueId}`);

                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    icon.classList.add('rotate-180');
                } else {
                    content.classList.add('hidden');
                    icon.classList.remove('rotate-180');
                }
            }

            function showProductBOMTab(uniqueId, tabName) {
                // Hide all product BOM content
                document.querySelectorAll(`#${uniqueId} .product-bom-content`).forEach(content => {
                    content.classList.add('hidden');
                });

                // Show selected tab
                const selectedTab = document.getElementById(`${uniqueId}-${tabName}`);
                if (selectedTab) {
                    selectedTab.classList.remove('hidden');
                }

                // Update button styles
                document.querySelectorAll(`#${uniqueId} .product-bom-tab`).forEach(btn => {
                    btn.classList.remove('active', 'border-b-2', 'border-purple-600', 'text-purple-600');
                    btn.classList.add('text-gray-600');
                });

                const activeBtn = document.querySelector(`#${uniqueId} .product-bom-tab[data-tab="${tabName}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active', 'border-b-2', 'border-purple-600', 'text-purple-600');
                    activeBtn.classList.remove('text-gray-600');
                }
            }

            async function loadProductBOM(projectItemId, uniqueId) {
                if (!currentProject || !projectItemId) return;

                try {
                    // Try API V2 first to get saved BOM
                    let response = await fetch(`${API_BASE}/v2/project-items/${projectItemId}/bom`);

                    // If V2 API fails, fallback to standard BOM endpoint
                    if (!response.ok) {
                        console.warn(`V2 API failed (${response.status}), trying fallback...`);
                        response = await fetch(`${API_BASE}/bom/projects/${currentProject.id}/doors/${projectItemId}`);
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.success && result.bom) {
                        const bom = result.bom;

                        // Map V2 format to display format
                        const aluminum = (bom.aluminum?.lines || []).map(item => ({
                            item_code: item.material_code || item.profile_code,
                            item_name: item.material_name || item.item_name,
                            length_m: parseFloat(item.length_m || item.length_mm / 1000) || 0,
                            quantity: parseInt(item.quantity) || 1
                        }));

                        const glass = (bom.glass?.lines || []).map(item => ({
                            item_code: item.glass_code || item.material_code,
                            item_name: item.material_name || item.glass_type || 'Kính',
                            width: parseInt(item.width_mm) || 0,
                            height: parseInt(item.height_mm) || 0,
                            area_m2: parseFloat(item.area_m2) || 0,
                            quantity: parseInt(item.quantity) || 1
                        }));

                        const accessories = (bom.hardware?.lines || []).map(item => ({
                            item_code: item.accessory_code || item.material_code,
                            item_name: item.material_name || item.item_name,
                            unit: item.unit || 'cái',
                            quantity: parseInt(item.quantity) || 1
                        }));

                        const consumables = (bom.consumables?.lines || []).map(item => ({
                            item_code: item.material_code || item.item_code,
                            item_name: item.material_name || item.item_name,
                            unit: item.unit || 'm',
                            quantity: parseInt(item.quantity) || parseFloat(item.length_m) || 1
                        }));

                        // Display BOM by type
                        displayProductAluminumBOM(uniqueId, aluminum);
                        displayProductGlassBOM(uniqueId, glass);
                        displayProductAccessoriesBOM(uniqueId, accessories);
                        displayProductConsumablesBOM(uniqueId, consumables);
                    } else {
                        // Show empty state
                        showEmptyBOM(uniqueId);
                    }
                } catch (error) {
                    console.error('Error loading product BOM:', error);
                    showEmptyBOM(uniqueId);
                }
            }

            function displayProductAluminumBOM(uniqueId, items) {
                const tbody = document.getElementById(`${uniqueId}-aluminum-list`);
                if (!tbody) return;

                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Không có dữ liệu</td></tr>';
                    return;
                }

                tbody.innerHTML = items.map(item => {
                    const lengthM = parseFloat(item.length_m) || 0;
                    const quantity = parseInt(item.quantity) || 1;
                    const totalLength = lengthM * quantity;

                    // Tính hao hụt (mặc định 5% cho nhôm)
                    const scrapRate = parseFloat(item.scrap_rate) || parseFloat(window.aluminumScrapRate) || 5;
                    const scrapAmount = (totalLength * scrapRate / 100);
                    const totalWithScrap = totalLength + scrapAmount;

                    // Phân loại: gia công, sản xuất, hoặc tồn kho
                    const classification = item.classification || item.source_type || 'purchase'; // purchase, manufacture, stock
                    let classificationBadge = '';
                    let classificationText = '';
                    switch (classification) {
                        case 'manufacture':
                        case 'gia_cong':
                            classificationBadge = 'bg-blue-100 text-blue-800';
                            classificationText = 'Gia công';
                            break;
                        case 'stock':
                            classificationBadge = 'bg-purple-100 text-purple-800';
                            classificationText = 'Tồn kho';
                            break;
                        case 'purchase':
                        default:
                            classificationBadge = 'bg-orange-100 text-orange-800';
                            classificationText = 'Mua ngoài';
                            break;
                    }

                    return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-mono">${escapeHtml(item.item_code || 'N/A')}</td>
                        <td class="px-4 py-3 text-sm font-medium">${escapeHtml(item.item_name || 'N/A')}</td>
                        <td class="px-4 py-3 text-sm">${lengthM.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center">${quantity}</td>
                        <td class="px-4 py-3 text-sm font-semibold text-purple-600">${totalLength.toFixed(2)}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${scrapAmount.toFixed(2)} (${scrapRate}%)</td>
                        <td class="px-4 py-3 text-sm font-bold text-indigo-600">${totalWithScrap.toFixed(2)}</td>
                        <td class="px-4 py-3">
                            <span class="inline-block px-2 py-1 rounded-full text-xs font-medium ${classificationBadge}">${classificationText}
                            </span>
                        </td>
                    </tr>
                `;
                }).join('');
            }

            function displayProductGlassBOM(uniqueId, items) {
                const tbody = document.getElementById(`${uniqueId}-glass-list`);
                if (!tbody) return;

                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Không có dữ liệu</td></tr>';
                    return;
                }

                tbody.innerHTML = items.map(item => {
                    const areaM2 = parseFloat(item.area_m2) || 0;
                    const width = parseInt(item.width) || 0;
                    const height = parseInt(item.height) || 0;
                    const quantity = parseInt(item.quantity) || 1;
                    const totalArea = areaM2 * quantity;

                    // Tính hao hụt (mặc định 3% cho kính)
                    const scrapRate = parseFloat(item.scrap_rate) || parseFloat(window.glassScrapRate) || 3;
                    const scrapAmount = (totalArea * scrapRate / 100);
                    const totalWithScrap = totalArea + scrapAmount;

                    // Phân loại
                    const classification = item.classification || item.source_type || 'purchase';
                    let classificationBadge = '';
                    let classificationText = '';
                    switch (classification) {
                        case 'manufacture':
                        case 'gia_cong':
                            classificationBadge = 'bg-blue-100 text-blue-800';
                            classificationText = 'Gia công';
                            break;
                        case 'stock':
                        case 'ton_kho':
                            classificationBadge = 'bg-purple-100 text-purple-800';
                            classificationText = 'Tồn kho';
                            break;
                        case 'purchase':
                        default:
                            classificationBadge = 'bg-green-100 text-green-800';
                            classificationText = 'Mua ngoài';
                            break;
                    }

                    return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-mono">${escapeHtml(item.item_code || 'N/A')}</td>
                        <td class="px-4 py-3 text-sm font-medium">${escapeHtml(item.item_name || 'N/A')}</td>
                        <td class="px-4 py-3 text-sm">${width} x ${height}</td>
                        <td class="px-4 py-3 text-sm">${areaM2.toFixed(2)}</td>
                        <td class="px-4 py-3 text-sm text-center">${quantity}</td>
                        <td class="px-4 py-3 text-sm font-semibold text-purple-600">${totalArea.toFixed(2)}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">+${scrapAmount.toFixed(2)} (${scrapRate}%)</td>
                        <td class="px-4 py-3 text-sm font-bold text-indigo-600">${totalWithScrap.toFixed(2)}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="inline-block px-2 py-1 rounded-full text-xs font-medium ${classificationBadge}">
                                ${classificationText}
                            </span>
                        </td>
                    </tr>
                `;
                }).join('');
            }

            function displayProductAccessoriesBOM(uniqueId, items) {
                const tbody = document.getElementById(`${uniqueId}-accessories-list`);
                if (!tbody) return;

                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu</td></tr>';
                    return;
                }

                tbody.innerHTML = items.map(item => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-mono">${escapeHtml(item.item_code || item.code || 'N/A')}</td>
                        <td class="px-4 py-3 text-sm font-medium">${escapeHtml(item.item_name || item.name || 'N/A')}</td>
                        <td class="px-4 py-3 text-sm">${escapeHtml(item.unit || 'N/A')}</td>
                        <td class="px-4 py-3 text-sm font-semibold text-blue-600">${item.quantity || 0}</td>
                    </tr>
                `).join('');
            }

            function displayProductConsumablesBOM(uniqueId, items) {
                const tbody = document.getElementById(`${uniqueId}-consumables-list`);
                if (!tbody) return;

                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu</td></tr>';
                    return;
                }

                tbody.innerHTML = items.map(item => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-mono">${escapeHtml(item.item_code || item.code || 'N/A')}</td>
                        <td class="px-4 py-3 text-sm font-medium">${escapeHtml(item.item_name || item.name || 'N/A')}</td>
                        <td class="px-4 py-3 text-sm">${escapeHtml(item.unit || 'N/A')}</td>
                        <td class="px-4 py-3 text-sm font-semibold text-orange-600">${item.quantity || 0}</td>
                    </tr>
                `).join('');
            }

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function getProductTypeIcon(productType) {
                const icons = {
                    'door_swing': '🚪',
                    'door_sliding': '↔️',
                    'door': '🚪',
                    'window': '🪟',
                    'window_sliding': '↔️',
                    'window_fixed': '🪟'
                };
                return icons[productType] || '📦';
            }

            function showEmptyBOM(uniqueId) {
                const tabs = ['aluminum', 'glass', 'accessories', 'consumables'];
                tabs.forEach(tab => {
                    const tbody = document.getElementById(`${uniqueId}-${tab}-list`);
                    if (tbody) {
                        const colSpan = tab === 'aluminum' || tab === 'glass' ? 5 : 4;
                        tbody.innerHTML = `<tr><td colspan="${colSpan}" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu BOM</td></tr>`;
                    }
                });
            }

            function updateBOMSummary(items) {
                // Helper function to safely set text content
                const safeSetText = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };

                if (!items || items.length === 0) {
                    safeSetText('step4TotalProducts', '0');
                    safeSetText('step4ExtractedCount', '0');
                    safeSetText('step4TotalAluminum', '0 m');
                    safeSetText('step4TotalGlass', '0 m²');
                    safeSetText('step4AluminumWithScrap', '0 m');

                    safeSetText('step4TotalArea', '0 m²');
                    safeSetText('step4ToPurchase', '0');
                    safeSetText('step4MaterialClassificationSummary', 'Đã bóc tách 0/0 sản phẩm');
                    return;
                }

                const designedItems = items.filter(item => item.project_item_id);
                const extractedItems = designedItems.filter(item => item.status === 'BOM_EXTRACTED');


                safeSetText('step4TotalProducts', designedItems.length);
                safeSetText('step4ExtractedProducts', extractedItems.length);
                safeSetText('step4MaterialClassificationSummary', `Đã bóc tách ${extractedItems.length}/${designedItems.length} sản phẩm`);


                // Batch BOM extraction logic (refactored)
                async function batchExtractBOM(items) {
                    if (!Array.isArray(items) || items.length === 0) return;
                    let successCount = 0;
                    let errorCount = 0;
                    const loadingOverlay = document.createElement('div');
                    loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50';
                    loadingOverlay.innerHTML = '<div class="bg-white px-8 py-6 rounded shadow text-lg font-semibold">Đang bóc tách BOM...</div>';
                    document.body.appendChild(loadingOverlay);
                    for (const item of items) {
                        let response = null;
                        let result = null;
                        let useV2 = false;
                        try {
                            // Try API V2 first
                            response = await fetch(`${API_BASE}/v2/project-items/${item.project_item_id}/calculate-bom`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ save: true })
                            });
                            if (response.ok) {
                                result = await response.json();
                                if (result.success) {
                                    useV2 = true;
                                }
                            }
                        } catch (v2Error) {
                            console.warn(`API V2 failed for item ${item.id}, trying fallback...`);
                        }
                        // Fallback to standard API
                        if (!useV2) {
                            response = await fetch(`${API_BASE}/bom/projects/${currentProject.id}/doors/${item.project_item_id}/calculate`, {
                                method: 'GET'
                            });
                            if (!response.ok) {
                                errorCount++;
                                console.error(`HTTP ${response.status}: ${response.statusText}`);
                                continue;
                            }
                            result = await response.json();
                        }
                        if (result.success && (result.data || result.bom)) {
                            // Save BOM to database (only if not using V2 which auto-saves)
                            if (!useV2) {
                                try {
                                    const saveResponse = await fetch(`${API_BASE}/bom/projects/${currentProject.id}/doors/${item.project_item_id}`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            items: result.data?.items || []
                                        })
                                    });
                                    const saveResult = await saveResponse.json();
                                    if (!saveResult.success) {
                                        console.warn(`Warning: Could not save BOM for item ${item.id}:`, saveResult.message);
                                    }
                                } catch (saveError) {
                                    console.warn(`Warning: Could not save BOM for item ${item.id}:`, saveError.message);
                                }
                            }
                            successCount++;
                        } else {
                            errorCount++;
                            console.error(`Error extracting BOM for item ${item.id}:`, result?.message);
                        }
                        // prevent overload
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    // Remove loading overlay
                    document.body.removeChild(loadingOverlay);
                    // Reload data
                    await loadQuotationItemsForDesign(currentProject.id);
                    renderProductsBOMList(quotationItemsForDesign);
                    updateBOMSummary(quotationItemsForDesign);
                    // Show result
                    if (errorCount === 0) {
                        showNotification(`Đã bóc tách BOM cho ${successCount} sản phẩm!`, 'success');
                    } else {
                        showNotification(`Đã bóc tách BOM cho ${successCount} sản phẩm. ${errorCount} sản phẩm gặp lỗi.`, 'warning');
                    }
                }
            }


            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500');
                notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center`;
                notification.innerHTML = `
            <span>${message}</span>
            <button onclick="this.parentElement.remove()" class="ml-2 text-gray-200">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;
                document.body.appendChild(notification);
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }


            // Backward compatibility: Load BOM data for current item
            async function loadBOMData(type) {
                if (!currentItem) return;
                try {
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/doors/${currentItem.id}/bom`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        if (type === 'aluminum') {
                            displayAluminumBOM(result.data.aluminum || []);
                        } else if (type === 'glass') {
                            displayGlassBOM(result.data.glass || []);
                        } else if (type === 'accessories') {
                            displayAccessoriesBOM(result.data.accessories || []);
                        }
                    }
                } catch (error) {
                    console.error('Error loading BOM:', error);
                }
            }


            function displayAluminumBOM(items) {
                const tbody = document.getElementById('aluminumBOMList');
                if (!tbody) return;
                if (!items || items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu</td></tr>';
                    return;
                }
                tbody.innerHTML = items.map(item => `
        <tr>
            <td class="px-4 py-3 text-sm">${item.item_code || 'N/A'}</td>
            <td class="px-4 py-3 text-sm">${item.item_name || 'N/A'}</td>
            <td class="px-4 py-3 text-sm">${(item.length_m || 0).toFixed(2)}</td>
            <td class="px-4 py-3 text-sm">${item.quantity || 1}</td>
            <td class="px-4 py-3 text-sm font-semibold">${((item.length_m || 0) * (item.quantity || 1)).toFixed(2)}</td>
        </tr>
    `).join('');
            }


            function displayGlassBOM(items) {
                const tbody = document.getElementById('glassBOMList');
                if (!tbody) return;
                if (!items || items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu</td></tr>';
                    return;
                }
                tbody.innerHTML = items.map(item => `
        <tr>
            <td class="px-4 py-3 text-sm">${item.glass_type || 'N/A'}</td>
            <td class="px-4 py-3 text-sm">${item.width || 0}</td>
            <td class="px-4 py-3 text-sm">${item.height || 0}</td>
            <td class="px-4 py-3 text-sm">${(item.area_m2 || 0).toFixed(2)}</td>
            <td class="px-4 py-3 text-sm">${item.quantity || 1}</td>
            <td class="px-4 py-3 text-sm font-semibold">${((item.area_m2 || 0) * (item.quantity || 1)).toFixed(2)}</td>
        </tr>
    `).join('');
            }


            function displayAccessoriesBOM(items) {
                const tbody = document.getElementById('accessoriesBOMList');
                if (!tbody) return;
                if (!items || items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Chưa có dữ liệu</td></tr>';
                    return;
                }
                tbody.innerHTML = items.map(item => `
        <tr>
            <td class="px-4 py-3 text-sm">${item.code || 'N/A'}</td>
            <td class="px-4 py-3 text-sm">${item.name || 'N/A'}</td>
            <td class="px-4 py-3 text-sm">${item.unit || 'cái'}</td>
            <td class="px-4 py-3 text-sm font-semibold">${item.quantity || 0}</td>
        </tr>
    `).join('');
            }


            async function checkStock() {
                if (!currentItem) return;
                try {
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/doors/${currentItem.id}/check-stock`);
                    const result = await response.json();
                    if (result.success) {
                        displayStockCheckResults(result.data);
                    }
                } catch (error) {
                    console.error('Error checking stock:', error);
                }
            }


            function displayStockCheckResults(data) {
                const container = document.getElementById('stockCheckResults');
                const warnings = data.warnings || [];
                const sufficient = data.sufficient || [];

                let html = '';
                if (warnings.length > 0) {
                    html += `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-2">
                            <h4 class="font-semibold text-red-800 mb-2">⚠️ Cảnh báo: Vật tư thiếu</h4>
                            <ul class="space-y-1">
                                ${warnings.map(w => `<li class="text-sm text-red-700">• ${w.item_name}: Cần ${w.required} ${w.unit}, Còn ${w.available} ${w.unit}</li>`).join('')}
                            </ul>
                        </div>`;
                }
                if (sufficient.length > 0) {
                    html += `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-green-800 mb-2">✓ Vật tư đủ</h4>
                            <p class="text-green-700">Tất cả vật tư đã đủ trong kho</p>
                        </div>`;
                }
                container.innerHTML = html;
            }


            async function calculateCosts() {
                if (!currentItem) return;
                try {
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/doors/${currentItem.id}/costs`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        document.getElementById('totalCost').textContent = formatCurrency(result.data.total_cost || 0);
                        document.getElementById('itemValue').textContent = formatCurrency(result.data.item_value || 0);

                        // Get project total
                        const projectResponse = await fetch(`${API_BASE}/projects/${currentProject.id}`);
                        const projectResult = await projectResponse.json();
                        if (projectResult.success && projectResult.data) {
                            document.getElementById('projectTotal').textContent = formatCurrency(projectResult.data.total_value || 0);
                        }
                    }
                } catch (error) {
                    console.error('Error calculating costs:', error);
                }
            }


            function formatCurrency(amount) {
                return new Intl.NumberFormat('vi-VN').format(amount) + ' ₫';
            }


            function goToQuotation() {
                if (!currentProject) return;
                window.location.href = `sales.html?projectId=${currentProject.id}&action=create-quotation`;
            }


            async function saveAndFinish() {
                if (!currentItem) return;
                try {
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/doors/${currentItem.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'completed' })
                    });
                    if (response.ok) {
                        alert('Đã hoàn thành thiết kế hạng mục!');
                        goToStep(2);
                        loadProjectItems(currentProject.id);
                    }
                } catch (error) {
                    console.error('Error saving and finishing:', error);
                    alert('Lỗi lưu dữ liệu');
                }
            }
            // ============================                    

            // ============================
            // ATC DESIGN WORKFLOW
            // ============================
            // Load project items using new API
            async function loadProjectItemsNew(projectId) {
                try {
                    // Try new API first
                    let response = await fetch(`${API_BASE}/projects/${projectId}/items`);
                    let result = await response.json();
                    if (result.success && result.data) {
                        items = result.data;
                    } else {
                        // Fallback to old API
                        response = await fetch(`${API_BASE}/projects/${projectId}/doors`);
                        result = await response.json();
                        items = result.success ? result.data : [];
                    }
                } catch (error) {
                    console.error('Error loading items:', error);
                    items = [];
                }
                displayItemsATC();
                updateStatusCounts();
            }




            // Display items in ATC-style table
            function displayItemsATC() {
                const container = document.getElementById('itemsList');
                const emptyState = document.getElementById('emptyItemsState');
                // Check - container may not exist in new layout
                if (!container) {
                    console.warn('displayItemsATC: container not found in layout');
                    return;
                }
                if (!items || items.length === 0) {
                    container.innerHTML = '';
                    emptyState?.classList.remove('hidden');
                    return;
                }
                emptyState?.classList.add('hidden');
                container.innerHTML = items.map((item, index) => {
                    const snapshotConfig = parseJSON(item.snapshot_config);
                    const width = snapshotConfig?.size?.w || item.width_mm || item.custom_width_mm || 1200;
                    const height = snapshotConfig?.size?.h || item.height_mm || item.custom_height_mm || 2200;
                    const status = item.status || 'DESIGNING';
                    const statusBadge = renderStatusBadge(status);
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">
                                ${item.product_code || `HM-${String(index + 1).padStart(3, '0')}`}
                            </td>
                            <td class="px-4 py-3 text-sm">
                                ${item.product_name || snapshotConfig?.original_item_name || item.notes || 'Hạng mục'}
                            </td>
                            <td class="px-4 py-3 text-sm text-center text-gray-600">${item.quantity || 1}</td>
                            <td class="px-4 py-3 text-sm text-center text-gray-600">${width} × ${height}</td>
                            <td class="px-4 py-3 text-sm text-center text-gray-600">
                                ${snapshotConfig?.aluminum_system || item.aluminum_system || '-'}</td>
                            <td class="px-4 py-3 text-center">${statusBadge}</td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex justify-center gap-1">
                                    ${status === 'DESIGNING' ? `
                                        <button onclick="openEditDesign(${item.id})" class="px-2 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700">Sửa</button>
                                    ` : `
                                        <button onclick="viewItemDetail(${item.id})" class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">Chi tiết</button>
                                    `}
                                    <button onclick="calculateBomForItem(${item.id})" class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">BOM</button>
                                    <button onclick="duplicateItem(${item.id})" class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs hover:bg-gray-300">Nhân bản</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }


            function renderStatusBadge(status) {
                const badges = {
                    'DESIGNING': '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">Đang thiết kế</span>',
                    'DESIGN_CONFIRMED': '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">✓ Đã xác nhận</span>',
                    'BOM_EXTRACTED': '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">Đã bóc tách</span>',
                    'EXPORTED': '<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">Đã xuất kho</span>'
                };
                return badges[status] || badges['DESIGNING'];
            }

            function updateStatusCounts() {
                const counts = {
                    DESIGNING: 0,
                    DESIGN_CONFIRMED: 0,
                    BOM_EXTRACTED: 0,
                    EXPORTED: 0,
                    total: items.length
                };
                items.forEach(item => {
                    const status = item.status || 'DESIGNING';
                    if (counts[status] !== undefined) counts[status]++;
                });
                // Safe updates with null checks
                const dg = document.getElementById('countDesigning');
                const cf = document.getElementById('countConfirmed');
                const bm = document.getElementById('countExtracted');
                const tt = document.getElementById('countTotal');
                if (dg) dg.textContent = counts.DESIGNING;
                if (cf) cf.textContent = counts.DESIGN_CONFIRMED;
                if (bm) bm.textContent = counts.BOM_EXTRACTED;
                if (tt) tt.textContent = counts.total;
            }

            function parseJSON(jsonStr) {
                if (!jsonStr) return null;
                try {
                    return typeof jsonStr === 'string' ? JSON.parse(jsonStr) : jsonStr;
                } catch (e) {
                    return null;
                }
            }

            // ============================
            // IMPORT FROM QUOTATION
            // ============================


            async function openImportQuotationModal() {
                document.getElementById('importQuotationModal').classList.remove('hidden');
                await loadQuotationsForProject();
            }


            function closeImportQuotationModal() {
                document.getElementById('importQuotationModal').classList.add('hidden');
                document.getElementById('quotationPreview').classList.add('hidden');
            }

            async function loadQuotationsForProject() {
                try {
                    // Get quotations for current project
                    const response = await fetch(`${API_BASE}/quotations`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        const select = document.getElementById('selectQuotation');
                        const quotations = result.data.filter(q =>
                            q.project_id === currentProject.id ||
                            ['approved', 'accepted', 'success'].includes(q.status?.toLowerCase())
                        );
                        select.innerHTML = '<option value="">-- Chọn báo giá --</option>' +
                            quotations.map(q => `<option value="${q.id}">${q.quotation_no || 'BG-' + q.id} - ${q.customer_name || ''} (${formatCurrency(q.total_amount || 0)})</option>`).join('');
                        select.onchange = () => previewQuotationItems(select.value);
                    }
                } catch (error) {
                    console.error('Error loading quotations:', error);
                }
            }

            async function previewQuotationItems(quotationId) {
                if (!quotationId) {
                    document.getElementById('quotationPreview').classList.add('hidden');
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE}/quotations/${quotationId}`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        const items = result.data.items || [];
                        document.getElementById('quotationItems').innerHTML =
                            items.length > 0 ?
                                items.map(item => `
                                    <div class="flex justify-between items-center p-2 bg-white border-b">
                                        <span class="font-medium">${item.product_name || 'Sản phẩm'}</span>
                                        <span class="text-gray-700">${item.quantity || 1}</span>
                                    </div>
                                `).join('') :
                                '<p class="text-gray-500">Không có sản phẩm</p>';
                        document.getElementById('quotationPreview').classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error previewing quotation:', error);
                }
            }


            async function importFromQuotation() {
                const quotationId = document.getElementById('selectQuotation').value;
                if (!quotationId) {
                    alert('Vui lòng chọn báo giá');
                    return;
                }
                try {
                    // Gọi API để tạo door_designs từ quotation (API cũ tạo project)
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/doors/from-quotation`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quotation_id: parseInt(quotationId) })
                    });
                    const result = await response.json();
                    if (result.success && result.data) {
                        alert(`Đã tạo ${result.data.items_created_count || 0} hạng mục từ báo giá!`);
                        closeImportQuotationModal();
                        loadProjectItems(currentProject.id);
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể tạo hạng mục từ báo giá.'));
                    }
                } catch (error) {
                    console.error('Error importing from quotation:', error);
                    alert('Lỗi kết nối server');
                }
            }


            // ============================
            // PRODUCT CATALOG
            // ============================
            function openAddFromCatalogModal() {
                // Navigate to product catalog with return URL
                window.location.href = `product-catalog.html?projectId=${currentProject?.id || ''}&returnUrl=${encodeURIComponent(window.location.href)}`;
            }


            let editingItemId = null;

            function openEditDesign(itemId) {
                const item = items.find(i => i.id === itemId);
                if (!item) return;
                editingItemId = itemId;
                currentItem = item;
                const snapshotConfig = parseJSON(item.snapshot_config) || {};
                // Populate edit form
                document.getElementById('editItemName').textContent = item.product_name || snapshotConfig.original_item_name || 'Hạng mục';
                document.getElementById('editWidth').value = snapshotConfig.size?.w || item.width_mm || 1200;
                document.getElementById('editHeight').value = snapshotConfig.size?.h || item.height_mm || 2200;
                document.getElementById('editOpenDirection').value = snapshotConfig.open_direction || '';
                document.getElementById('editLeafCount').value = snapshotConfig.leaf_count || 1;
                document.getElementById('editAluminumSystem').value = snapshotConfig.aluminum_system || item.aluminum_system || '';
                document.getElementById('editGlassType').value = snapshotConfig.glass_type || 'tempered';
                document.getElementById('editGlassThickness').value = snapshotConfig.thickness_mm || 8;
                document.getElementById('editColor').value = snapshotConfig.color || 'white';
                document.getElementById('editNotes').value = snapshotConfig.notes || '';
                // Show modal
                document.getElementById('editDesignModal').classList.remove('hidden');
                showDesignTab('size');
            }


            function closeEditDesignModal() {
                document.getElementById('editDesignModal').classList.add('hidden');
                editingItemId = null;
            }

            function showDesignTab(tabName) {
                // Hide all tab contents
                document.querySelectorAll('.design-tab-content').forEach(content => content.classList.add('hidden'));
                document.querySelectorAll('.design-tab').forEach(btn => btn.classList.remove('text-purple-600', 'border-b-2', 'border-purple-600'));
                // Show selected tab content
                const tabMap = { 'size': 'tabSize', 'glass': 'tabGlass', 'profile': 'tabProfile', 'bom': 'tabBom' };
                document.getElementById(tabMap[tabName])?.classList.remove('hidden');
                // Highlight selected button
                const buttons = document.querySelectorAll('.design-tab');
                const index = ['size', 'glass', 'profile', 'bom'].indexOf(tabName);
                if (buttons[index]) {
                    buttons[index].classList.add('text-purple-600', 'border-b-2', 'border-purple-600');
                    buttons[index].classList.remove('text-gray-600');
                }
            }


            async function saveDesign() {
                if (!editingItemId || !currentProject) return;
                const snapshotConfig = {
                    size: {
                        w: parseInt(document.getElementById('editWidth').value) || 1200,
                        h: parseInt(document.getElementById('editHeight').value) || 2200,
                        unit: 'mm'
                    },
                    open_direction: document.getElementById('editOpenDirection').value,
                    leaf_count: parseInt(document.getElementById('editLeafCount').value) || 1,
                    aluminum_system: document.getElementById('editAluminumSystem').value,
                    glass_type: document.getElementById('editGlassType').value,
                    thickness_mm: parseInt(document.getElementById('editGlassThickness').value) || 8,
                    color: document.getElementById('editColor').value,
                    notes: document.getElementById('editNotes').value
                };
                try {
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/items/${editingItemId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ snapshot_config: snapshotConfig })
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('Đã lưu thay đổi!');
                        loadProjectItemsNew(currentProject.id);
                    } else {
                        alert(result.message);
                    }
                } catch (error) {
                    console.error('Error saving design:', error);
                    alert('Lỗi kết nối server');
                }
            }


            async function confirmDesignAction() {
                if (!editingItemId || !currentProject) return;
                // Save first
                await saveDesign();
                try {
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/items/${editingItemId}/confirm-design`, {
                        method: 'POST'
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('Đã xác nhận thiết kế!');
                        closeEditDesignModal();
                        loadProjectItemsNew(currentProject.id);
                    } else {
                        alert('Lỗi: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error confirming design:', error);
                    alert('Lỗi kết nối server');
                }
            }


            async function calculateBomPreview() {
                if (!editingItemId || !currentProject) return;
                // Save current version before calculating
                await saveDesign();
                try {
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/items/${editingItemId}/calc`, {
                        method: 'POST'
                    });
                    const result = await response.json();
                    if (result.success && result.data && result.data.calc_cache) {
                        const cache = result.data.calc_cache;
                        document.getElementById('previewAluminumM').textContent = (cache.bom_summary?.aluminum_m || 0).toFixed(2);
                        document.getElementById('previewGlassM2').textContent = (cache.bom_summary?.glass_m2 || 0).toFixed(2);
                        document.getElementById('previewAccCount').textContent = cache.bom_summary?.accessories_count || 0;
                        document.getElementById('previewTotalCost').textContent = formatCurrency(cache.cost_summary?.total_cost || 0);
                    }
                } catch (error) {
                    console.error('Error calculating BOM:', error);
                }
            }

            async function calculateBomForItem(itemId) {
                if (!currentProject) return;
                try {
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/items/${itemId}/calc`, {
                        method: 'POST'
                    });
                    const result = await response.json();
                    if (result.success && result.data && result.data.calc_cache) {
                        alert(`BOM đã được tính!\nNhôm: ${(result.data.calc_cache.bom_summary?.aluminum_m || 0).toFixed(2)}m\nKính: ${(result.data.calc_cache.bom_summary?.glass_m2 || 0).toFixed(2)}m²\nChi phí: ${formatCurrency(result.data.calc_cache.cost_summary?.total_cost || 0)}`);
                    }
                } catch (error) {
                    console.error('Error calculating BOM:', error);
                }
            }

            function viewItemDetail(itemId) {
                const item = items.find(i => i.id === itemId);
                if (!item) return;
                const snapshotConfig = parseJSON(item.snapshot_config) || {};
                alert(`Chi tiết hạng mục:\n- Kích thước: ${snapshotConfig.size?.w || 0} × ${snapshotConfig.size?.h || 0}\n- Hệ nhôm: ${snapshotConfig.aluminum_system || '-'}\n- Kính: ${snapshotConfig.glass_type || '-'} ${snapshotConfig.thickness_mm || 0}mm\n- Trạng thái: ${item.status || 'DESIGNING'}`);
            }


            async function duplicateItem(itemId) {
                if (!currentProject) return;
                const item = items.find(i => i.id === itemId);
                if (!item) return;
                try {
                    const response = await fetch(`${API_BASE}/projects/${currentProject.id}/items`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            product_template_id: item.product_template_id,
                            quantity: item.quantity || 1,
                            snapshot_config: item.snapshot_config,
                            aluminum_system: item.aluminum_system,
                            notes: (item.notes || '') + ' (Nhân bản)'
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        loadProjectItemsNew(currentProject.id);
                    }
                } catch (error) {
                    console.error('Error duplicating item:', error);
                }
            }

            // ============================================
            // NEW ENHANCED FEATURES
            // ============================================

            // Quick Actions Menu
            function toggleQuickActions() {
                const menu = document.getElementById('quickActionsMenu');
                if (menu) menu.classList.toggle('hidden');
            }

            // Close quick actions when clicking outside
            document.addEventListener('click', function (event) {
                const menu = document.getElementById('quickActionsMenu');
                if (!menu) return; // Element doesn't exist, skip
                const button = event.target.closest('button[onclick="toggleQuickActions()"]');
                if (!button && !menu.contains(event.target)) {
                    menu.classList.add('hidden');
                }
            });

            // Dashboard Functions
            // Dashboard functions removed

            async function updateDashboard() {
                // Dashboard đã bị xóa, không làm gì cả
                return;
            }

            // Batch Operations
            let batchMode = false;
            let selectedItems = new Set();


            function toggleBatchMode() {
                batchMode = !batchMode;
                selectedItems.clear();
                const toolbar = document.getElementById('batchOperationsToolbar');
                if (batchMode) {
                    toolbar.classList.remove('hidden');
                    addCheckboxesToProducts();
                } else {
                    toolbar.classList.add('hidden');
                    removeCheckboxesFromProducts();
                }
            }


            function addCheckboxesToProducts() {
                const productCards = document.querySelectorAll('#productsGrid .item-card');
                productCards.forEach(card => {
                    if (!card.querySelector('.batch-checkbox')) {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'batch-checkbox absolute top-2 left-2 border-purple-600 rounded';
                        checkbox.onchange = function () {
                            const itemId = card.getAttribute('data-item-id');
                            if (this.checked) {
                                selectedItems.add(itemId);
                            } else {
                                selectedItems.delete(itemId);
                            }
                            updateSelectedCount();
                        };
                        checkbox.setAttribute('data-item-id', card.getAttribute('data-item-id') || '');
                        card.style.position = 'relative';
                        card.appendChild(checkbox);
                    }
                });
            }

            function removeCheckboxesFromProducts() {
                document.querySelectorAll('.batch-checkbox').forEach(cb => cb.remove());
                updateSelectedCount();
            }

            function selectAllItems() {
                document.querySelectorAll('.batch-checkbox').forEach(cb => {
                    cb.checked = true;
                    const itemId = cb.getAttribute('data-item-id');
                    selectedItems.add(itemId);
                });
                updateSelectedCount();
            }

            function deselectAllItems() {
                document.querySelectorAll('.batch-checkbox').forEach(cb => {
                    cb.checked = false;
                });
                selectedItems.clear();
                updateSelectedCount();
            }

            function updateSelectedCount() {
                document.getElementById('selectedItemsCount').textContent = selectedItems.size;
            }


            function removeCheckboxesFromProducts() {
                document.querySelectorAll('.batch-checkbox').forEach(cb => cb.remove());
                updateSelectedCount();
            }

            function selectAllItems() {
                document.querySelectorAll('.batch-checkbox').forEach(cb => {
                    cb.checked = true;
                    const itemId = cb.getAttribute('data-item-id');
                    selectedItems.add(itemId);
                });
                updateSelectedCount();
            }

            function deselectAllItems() {
                document.querySelectorAll('.batch-checkbox').forEach(cb => {
                    cb.checked = false;
                });
                selectedItems.clear();
                updateSelectedCount();
            }

            function updateSelectedCount() {
                document.getElementById('selectedItemsCount').textContent = selectedItems.size;
            }

            async function batchCalculateBOM() {
                if (selectedItems.size === 0) {
                    alert('Vui lòng chọn ít nhất một sản phẩm');
                    return;
                }
                if (!confirm(`Tính BOM cho ${selectedItems.size} sản phẩm đã chọn?`)) return;
                const itemIds = Array.from(selectedItems);
                let successCount = 0;
                let failCount = 0;
                for (const itemId of itemIds) {
                    try {
                        const response = await fetch(`${API_BASE}/projects/${currentProject.id}/items/${itemId}/calc`, {
                            method: 'POST'
                        });
                        const result = await response.json();
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }
                showSuccessNotification('Hoàn thành!', `Thành công: ${successCount}\nThất bại: ${failCount}`);
                closeBatchOperations();
                if (currentProject) {
                    loadProjectItems(currentProject.id);
                    updateDashboard();
                }
            }




            async function batchConfirmDesign() {
                if (selectedItems.size === 0) {
                    alert('Vui lòng chọn ít nhất một sản phẩm');
                    return;
                }
                if (!confirm(`Xác nhận thiết kế cho ${selectedItems.size} sản phẩm đã chọn?`)) return;
                const itemIds = Array.from(selectedItems);
                let successCount = 0;
                let failCount = 0;
                for (const itemId of itemIds) {
                    try {
                        const response = await fetch(`${API_BASE}/projects/${currentProject.id}/items/${itemId}/confirm-design`, {
                            method: 'POST'
                        });
                        const result = await response.json();
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }
                showSuccessNotification('Hoàn thành!', `Thành công: ${successCount}\nThất bại: ${failCount}`);
                closeBatchOperations();
                if (currentProject) {
                    loadProjectItems(currentProject.id);
                    updateDashboard();
                }
            }


            async function batchDuplicate() {
                if (selectedItems.size === 0) {
                    alert('Vui lòng chọn ít nhất một sản phẩm');
                    return;
                }
                if (!confirm(`Nhân bản ${selectedItems.size} sản phẩm đã chọn?`)) return;
                const itemIds = Array.from(selectedItems);
                let successCount = 0;
                let failCount = 0;
                for (const itemId of itemIds) {
                    try {
                        const item = items.find(i => i.id == itemId);
                        if (!item) continue;
                        const response = await fetch(`${API_BASE}/projects/${currentProject.id}/items`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                product_template_id: item.product_template_id,
                                quantity: item.quantity || 1,
                                snapshot_config: item.snapshot_config,
                                aluminum_system: item.aluminum_system,
                                notes: (item.notes || '') + ' (Nhân bản)'
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }
                showSuccessNotification('Hoàn thành!', `Thành công: ${successCount}\nThất bại: ${failCount}`);
                closeBatchOperations();
                if (currentProject) {
                    loadProjectItems(currentProject.id);
                    updateDashboard();
                }
            }

            async function batchDelete() {
                if (selectedItems.size === 0) {
                    alert('Vui lòng chọn ít nhất một sản phẩm');
                    return;
                }

                if (!confirm(`XÓA ${selectedItems.size} sản phẩm đã chọn?\nHành động này không thể hoàn tác!`)) return;

                const itemIds = Array.from(selectedItems);
                let successCount = 0;
                let failCount = 0;

                for (const itemId of itemIds) {
                    try {
                        const response = await fetch(`${API_BASE}/projects/${currentProject.id}/items/${itemId}`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }

                alert(`Hoàn thành!\nĐã xóa: ${successCount}\nThất bại: ${failCount}`);
                closeBatchOperations();
                if (currentProject) {
                    loadProjectItems(currentProject.id);
                    updateDashboard();
                }
            }

            // Template Library
            function openTemplateLibrary() {
                window.location.href = `template-library.html?projectId=${currentProject?.id || ''}`;
            }

            // Import/Export
            function openImportExport() {
                alert('Chức năng Import/Export đang được phát triển');
            }



            // ============================================
            // TAB SWITCHING FUNCTIONS
            // ============================================

            function switchBocTachTab(tabName) {
                // ⭐ Force save BOM data trước khi chuyển tab
                if (typeof flushBOMSave === 'function') {
                    flushBOMSave();
                }

                // Hide all tabs
                document.querySelectorAll('.boc-tach-content').forEach(tab => {
                    tab.classList.add('hidden');
                });

                // Show selected tab
                const tabMap = {
                    'nhom': 'bocTachNhomContent',
                    'kinh': 'bocTachKinhContent',
                    'vattu': 'bocTachVatTuContent'
                };

                const tabId = tabMap[tabName];
                if (tabId) {
                    const tabElement = document.getElementById(tabId);
                    if (tabElement) {
                        tabElement.classList.remove('hidden');
                    }
                }

                // Update tab button styles
                document.querySelectorAll('.boc-tach-tab').forEach(btn => {
                    btn.classList.remove('border-b-2', 'border-purple-600', 'text-purple-600', 'bg-purple-50');
                    btn.classList.add('border-b-2', 'border-transparent', 'text-gray-500');
                });

                const activeBtn = document.querySelector(`.boc-tach-tab[data-tab="${tabName}"]`);
                if (activeBtn) {
                    activeBtn.classList.remove('border-transparent', 'text-gray-500');
                    activeBtn.classList.add('border-b-2', 'border-purple-600', 'text-purple-600', 'bg-purple-50');
                }
            }

            function switchKhoTab(tabName) {
                // Hide all tabs
                document.querySelectorAll('.kho-content').forEach(tab => {
                    tab.classList.add('hidden');
                });

                // Show selected tab
                const tabMap = {
                    'nhom': 'khoNhomContent',
                    'kinh': 'khoKinhContent',
                    'vattu': 'khoVatTuContent'
                };

                const tabId = tabMap[tabName];
                if (tabId) {
                    const tabElement = document.getElementById(tabId);
                    if (tabElement) {
                        tabElement.classList.remove('hidden');
                    }
                }

                // Update tab button styles
                document.querySelectorAll('.kho-tab').forEach(btn => {
                    btn.classList.remove('border-b-2', 'border-blue-600', 'text-blue-600', 'bg-blue-50');
                    btn.classList.add('border-b-2', 'border-transparent', 'text-gray-500');
                });

                const activeBtn = document.querySelector(`.kho-tab[data-tab="${tabName}"]`);
                if (activeBtn) {
                    activeBtn.classList.remove('border-transparent', 'text-gray-500');
                    activeBtn.classList.add('border-b-2', 'border-blue-600', 'text-blue-600', 'bg-blue-50');
                }
            }

            // ===========================================
            // INVENTORY CHECK FUNCTIONS
            // ===========================================
            let inventoryData = []; // Store all inventory items
            let inventoryCheckResults = { nhom: [], kinh: [], vattu: [] };

            /**
             * Load inventory data and compare with BOM
             */
            async function loadInventoryCheckData() {
                if (!bocTachData || (!bocTachData.nhom.length && !bocTachData.kinh.length && !bocTachData.vattu.length)) {
                    console.warn('⚠️ No BOM data to check');
                    return;
                }

                try {
                    console.log('📥 Loading inventory data from multiple sources...');

                    // Load từ nhiều nguồn: accessories, aluminum_systems, và inventory table
                    const [accessoriesRes, aluminumRes, glassRes, inventoryRes] = await Promise.all([
                        fetch(`${API_BASE}/project-materials/inventory/accessory`).catch(e => ({ ok: false, json: () => ({ success: false, data: [] }) })),
                        fetch(`${API_BASE}/project-materials/inventory/aluminum`).catch(e => ({ ok: false, json: () => ({ success: false, data: [] }) })),
                        fetch(`${API_BASE}/project-materials/inventory/glass`).catch(e => ({ ok: false, json: () => ({ success: false, data: [] }) })),
                        fetch(`${API_BASE}/inventory?item_type=all`).catch(e => ({ ok: false, json: () => ({ success: false, data: [] }) }))
                    ]);

                    const [accessoriesData, aluminumData, glassData, inventoryRawData] = await Promise.all([
                        accessoriesRes.json().then(r => r.success ? r.data : []).catch(() => []),
                        aluminumRes.json().then(r => r.success ? r.data : []).catch(() => []),
                        glassRes.json().then(r => r.success ? r.data : []).catch(() => []),
                        inventoryRes.json().then(r => r.success ? r.data : []).catch(() => [])
                    ]);

                    console.log(`📦 Loaded: ${accessoriesData.length} accessories, ${aluminumData.length} aluminum, ${glassData.length} glass, ${inventoryRawData.length} inventory items`);

                    // Normalize tất cả về cùng format: { item_code, item_name, item_type, quantity, stock_quantity, ... }
                    inventoryData = [];

                    // 1. Phụ kiện từ bảng accessories
                    accessoriesData.forEach(item => {
                        inventoryData.push({
                            item_code: item.code || item.item_code,
                            item_name: item.name || item.item_name,
                            item_type: 'accessory', // Hoặc 'material'
                            quantity: parseFloat(item.stock || item.stock_quantity || item.quantity || 0),
                            stock_quantity: parseFloat(item.stock || item.stock_quantity || item.quantity || 0),
                            unit: item.unit || 'cái',
                            category: item.category,
                            unit_price: parseFloat(item.price || 0)
                        });
                    });

                    // 2. Nhôm từ bảng aluminum_systems
                    aluminumData.forEach(item => {
                        inventoryData.push({
                            item_code: item.code || item.item_code,
                            item_name: item.name || item.item_name,
                            item_type: 'aluminum',
                            quantity: parseFloat(item.stock || item.quantity || item.quantity_m || 0),
                            stock_quantity: parseFloat(item.stock || item.quantity || item.quantity_m || 0),
                            unit: item.unit || 'm',
                            aluminum_system: item.aluminum_system,
                            unit_price: parseFloat(item.price || 0)
                        });
                    });

                    // 3. Kính từ bảng inventory hoặc glass
                    glassData.forEach(item => {
                        inventoryData.push({
                            item_code: item.code || item.item_code,
                            item_name: item.name || item.item_name,
                            item_type: 'glass',
                            quantity: parseFloat(item.stock || item.quantity || 0),
                            stock_quantity: parseFloat(item.stock || item.quantity || 0),
                            unit: item.unit || 'm²',
                            unit_price: parseFloat(item.price || 0)
                        });
                    });

                    // 3b. Nếu glassData rỗng, load glass từ inventoryRawData
                    if (glassData.length === 0 && inventoryRawData.length > 0) {
                        console.log('⚠️ Glass API returned 0 items, trying to load from inventory table...');
                        inventoryRawData.forEach(item => {
                            if (item.item_code && item.item_type === 'glass') {
                                // Kiểm tra xem đã có trong inventoryData chưa (tránh duplicate)
                                const exists = inventoryData.some(inv =>
                                    inv.item_code === item.item_code && inv.item_type === 'glass'
                                );
                                if (!exists) {
                                    inventoryData.push({
                                        item_code: item.item_code,
                                        item_name: item.item_name,
                                        item_type: 'glass',
                                        quantity: parseFloat(item.quantity || 0),
                                        stock_quantity: parseFloat(item.stock_quantity || item.quantity || 0),
                                        unit: item.unit || 'm²',
                                        unit_price: parseFloat(item.unit_price || 0)
                                    });
                                }
                            }
                        });
                    }

                    // 4. Các vật tư khác từ bảng inventory (tránh duplicate với glass đã load)
                    inventoryRawData.forEach(item => {
                        if (item.item_code && item.item_type && item.item_type !== 'glass') {
                            // Kiểm tra xem đã có trong inventoryData chưa (tránh duplicate)
                            const exists = inventoryData.some(inv =>
                                inv.item_code === item.item_code && inv.item_type === item.item_type
                            );
                            if (!exists) {
                                inventoryData.push({
                                    item_code: item.item_code,
                                    item_name: item.item_name,
                                    item_type: item.item_type,
                                    quantity: parseFloat(item.quantity || 0),
                                    stock_quantity: parseFloat(item.stock_quantity || item.quantity || 0),
                                    unit: item.unit || 'cái',
                                    unit_price: parseFloat(item.unit_price || 0)
                                });
                            }
                        }
                    });

                    console.log(`✅ Total normalized inventory data: ${inventoryData.length} items`);

                    // Log sample để debug
                    if (inventoryData.length > 0) {
                        console.log('📋 Sample inventory items:', inventoryData.slice(0, 5).map(inv => ({
                            code: inv.item_code,
                            name: inv.item_name?.substring(0, 30),
                            type: inv.item_type,
                            quantity: inv.quantity,
                            stock_quantity: inv.stock_quantity
                        })));
                    }

                    // Compare BOM with inventory
                    compareBOMWithInventory();
                } catch (error) {
                    console.error('❌ Error loading inventory:', error);
                    showInventoryError('Lỗi kết nối đến server: ' + error.message);
                }
            }

            /**
             * Compare BOM data with inventory
             */
            function compareBOMWithInventory() {
                inventoryCheckResults = { nhom: [], kinh: [], vattu: [] };

                // Check Nhôm
                if (bocTachData.nhom && bocTachData.nhom.length > 0) {
                    bocTachData.nhom.forEach(item => {
                        const required = parseFloat(item.quantity) || 0;
                        const unit = item.unit || 'cây';
                        const stockItem = findInventoryItem(item.code || item.item_code, item.name || item.item_name, 'aluminum');
                        const found = stockItem !== null && stockItem !== undefined;
                        const available = found ? parseFloat(stockItem.stock_quantity || stockItem.quantity || 0) : 0;
                        const shortage = found ? Math.max(0, required - available) : required; // Nếu không tìm thấy, shortage = required
                        const status = getStockStatus(required, available, found);

                        inventoryCheckResults.nhom.push({
                            code: item.code || item.item_code || '',
                            name: item.name || item.item_name || '',
                            unit: unit,
                            required: required,
                            available: available,
                            shortage: shortage,
                            status: status,
                            stockItem: stockItem,
                            found: found
                        });
                    });
                }

                // Check Kính
                if (bocTachData.kinh && bocTachData.kinh.length > 0) {
                    bocTachData.kinh.forEach(item => {
                        const required = parseFloat(item.area_m2) || 0;
                        const unit = 'm²';
                        const bomCode = item.code || item.glass_code || '';
                        const bomName = item.type || item.glass_type || '';

                        console.log(`🔍 Checking kính: code="${bomCode}", name="${bomName}", required=${required} m²`);

                        const stockItem = findInventoryItem(bomCode, bomName, 'glass');
                        const found = stockItem !== null && stockItem !== undefined;
                        const available = found ? parseFloat(stockItem.stock_quantity || stockItem.quantity || 0) : 0;
                        const shortage = found ? Math.max(0, required - available) : required; // Nếu không tìm thấy, shortage = required
                        const status = getStockStatus(required, available, found);

                        console.log(`📊 Kính result: required=${required} m², available=${available} m², shortage=${shortage} m², status=${status}, found=${found}`);

                        inventoryCheckResults.kinh.push({
                            code: bomCode,
                            name: bomName,
                            unit: unit,
                            required: required,
                            available: available,
                            shortage: shortage,
                            status: status,
                            stockItem: stockItem,
                            found: found
                        });
                    });
                }

                // Check Vật tư Phụ
                if (bocTachData.vattu && bocTachData.vattu.length > 0) {
                    bocTachData.vattu.forEach(item => {
                        const required = parseFloat(item.quantity) || 0;
                        const unit = item.unit || 'cái';
                        const bomCode = item.code || item.item_code || '';
                        const bomName = item.name || item.item_name || '';

                        console.log(`🔍 Checking vật tư phụ: code="${bomCode}", name="${bomName}", required=${required}`);

                        const stockItem = findInventoryItem(bomCode, bomName, 'material');
                        const found = stockItem !== null && stockItem !== undefined;
                        // Lấy quantity từ stockItem - ưu tiên stock_quantity, sau đó quantity
                        const available = found ? parseFloat(stockItem.stock_quantity || stockItem.quantity || 0) : 0;
                        const shortage = found ? Math.max(0, required - available) : required; // Nếu không tìm thấy, shortage = required
                        const status = getStockStatus(required, available, found);

                        console.log(`📊 Result: required=${required}, available=${available}, shortage=${shortage}, status=${status}, found=${found}`);

                        inventoryCheckResults.vattu.push({
                            code: bomCode,
                            name: bomName,
                            unit: unit,
                            required: required,
                            available: available,
                            shortage: shortage,
                            status: status,
                            stockItem: stockItem,
                            found: found
                        });
                    });
                }

                // Render tables
                renderKhoNhomTable(inventoryCheckResults.nhom);
                renderKhoKinhTable(inventoryCheckResults.kinh);
                renderKhoVatTuTable(inventoryCheckResults.vattu);
                updateInventorySummary();

                // Check if there are shortages (chỉ tính những vật tư có trong kho nhưng thiếu, không tính "not_found")
                const hasShortage = (inventoryCheckResults.nhom && inventoryCheckResults.nhom.some(i => i.status !== 'not_found' && i.shortage > 0)) ||
                    (inventoryCheckResults.kinh && inventoryCheckResults.kinh.some(i => i.status !== 'not_found' && i.shortage > 0)) ||
                    (inventoryCheckResults.vattu && inventoryCheckResults.vattu.some(i => i.status !== 'not_found' && i.shortage > 0));

                if (hasShortage) {
                    console.log('⚠️ Có vật tư thiếu. Nhấn nút "Tạo Yêu Cầu" để tạo phiếu yêu cầu vật tư.');
                    // Show info message if form is not already open
                    const form = document.getElementById('materialRequestForm');
                    if (form && form.classList.contains('hidden')) {
                        const infoEl = document.getElementById('materialRequestInfo');
                        if (infoEl) {
                            infoEl.classList.remove('bg-blue-50', 'border-blue-200');
                            infoEl.classList.add('bg-orange-50', 'border-orange-200');
                            const infoText = infoEl.querySelector('p.text-blue-700');
                            if (infoText) {
                                infoText.textContent = '⚠️ Có vật tư thiếu! Nhấn nút "Tạo Yêu Cầu" ở trên để tạo phiếu yêu cầu vật tư.';
                                infoText.classList.remove('text-blue-700');
                                infoText.classList.add('text-orange-700');
                            }
                        }
                    }
                }
            }

            /**
             * Find inventory item by code or name
             */
            function findInventoryItem(code, name, type) {
                if (!inventoryData || inventoryData.length === 0) {
                    console.warn('⚠️ No inventory data available');
                    return null;
                }

                console.log(`🔍 Finding inventory item: code="${code}", name="${name}", type="${type}"`);

                // Try to find by code first (exact match)
                let item = inventoryData.find(inv => {
                    const codeMatch = inv.item_code && inv.item_code.trim().toUpperCase() === (code || '').trim().toUpperCase();
                    if (!codeMatch) return false;

                    // Kiểm tra item_type - linh hoạt hơn
                    if (type === 'aluminum') {
                        return inv.item_type === 'aluminum';
                    } else if (type === 'glass') {
                        return inv.item_type === 'glass';
                    } else {
                        // Vật tư phụ: có thể là 'material', 'accessory', hoặc các loại khác
                        return inv.item_type === 'material' ||
                            inv.item_type === 'accessory' ||
                            inv.item_type === 'consumable' ||
                            inv.item_type === 'other' ||
                            !inv.item_type; // Nếu không có item_type, vẫn chấp nhận
                    }
                });

                if (item) {
                    console.log(`✅ Found by code: ${item.item_code} (${item.item_name}), quantity: ${item.quantity}, item_type: ${item.item_type}`);
                    return item;
                }

                // If not found by code, try by name (fuzzy match)
                if (name) {
                    const nameLower = name.toLowerCase().trim();
                    item = inventoryData.find(inv => {
                        if (!inv.item_name) return false;

                        const invNameLower = inv.item_name.toLowerCase().trim();
                        const nameMatch = invNameLower === nameLower ||
                            invNameLower.includes(nameLower) ||
                            nameLower.includes(invNameLower);

                        if (!nameMatch) return false;

                        // Kiểm tra item_type - linh hoạt hơn
                        if (type === 'aluminum') {
                            return inv.item_type === 'aluminum';
                        } else if (type === 'glass') {
                            return inv.item_type === 'glass';
                        } else {
                            // Vật tư phụ: linh hoạt hơn
                            return inv.item_type === 'material' ||
                                inv.item_type === 'accessory' ||
                                inv.item_type === 'consumable' ||
                                inv.item_type === 'other' ||
                                !inv.item_type;
                        }
                    });
                }

                if (item) {
                    console.log(`✅ Found by name: ${item.item_code} (${item.item_name}), quantity: ${item.quantity}, item_type: ${item.item_type}`);
                    return item;
                }

                // If still not found for glass, try more flexible matching (code might be in name or vice versa)
                if (!item && type === 'glass' && code) {
                    item = inventoryData.find(inv => {
                        if (inv.item_type !== 'glass') return false;
                        // Try matching code in name or name in code
                        const codeInName = inv.item_name && inv.item_name.toUpperCase().includes(code.toUpperCase());
                        const nameInCode = inv.item_code && inv.item_code.toUpperCase().includes(code.toUpperCase());
                        const codeMatch = inv.item_code && inv.item_code.toUpperCase() === code.toUpperCase();
                        return codeInName || nameInCode || codeMatch;
                    });
                    if (item) {
                        console.log(`✅ Found glass by flexible match: ${item.item_code} (${item.item_name}), quantity: ${item.quantity}`);
                        return item;
                    }
                }

                // If still not found, log warning and similar items
                if (!item) {
                    console.warn(`❌ Not found: code="${code}", name="${name}", type="${type}"`);
                    // Log một số items gần giống để debug
                    const similarItems = inventoryData.filter(inv => {
                        if (type === 'glass' && inv.item_type === 'glass') {
                            // For glass, check if code or name contains search terms
                            if (code && inv.item_code) {
                                return inv.item_code.toLowerCase().includes(code.toLowerCase()) ||
                                    code.toLowerCase().includes(inv.item_code.toLowerCase());
                            }
                            if (name && inv.item_name) {
                                return inv.item_name.toLowerCase().includes(name.toLowerCase()) ||
                                    name.toLowerCase().includes(inv.item_name.toLowerCase());
                            }
                        } else if (code && inv.item_code) {
                            return inv.item_code.toLowerCase().includes(code.toLowerCase()) ||
                                code.toLowerCase().includes(inv.item_code.toLowerCase());
                        }
                        return false;
                    }).slice(0, 5);
                    if (similarItems.length > 0) {
                        console.log('💡 Similar items found:', similarItems.map(i => ({
                            code: i.item_code,
                            name: i.item_name,
                            type: i.item_type,
                            quantity: i.quantity || i.stock_quantity
                        })));
                    }
                }

                return item || null;
            }

            /**
             * Get stock status
             * @param {number} required - Số lượng cần
             * @param {number} available - Số lượng có trong kho (0 nếu không tìm thấy)
             * @param {boolean} found - Có tìm thấy trong kho hay không
             * @returns {string} - 'not_found', 'sufficient', 'partial', 'shortage'
             */
            function getStockStatus(required, available, found) {
                // Nếu không tìm thấy trong kho → "Không có trong kho"
                if (!found || found === false) {
                    return 'not_found';
                }
                // Nếu tìm thấy trong kho
                if (available >= required) return 'sufficient';
                if (available > 0) return 'partial';
                return 'shortage'; // Tìm thấy nhưng available = 0 → "Hết"
            }

            /**
             * Render Nhôm inventory check table
             */
            function renderKhoNhomTable(data) {
                const tbody = document.getElementById('khoNhomTableBody');
                if (!tbody) return;

                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                <p>Chưa có dữ liệu nhôm cần kiểm tra</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = data.map(item => {
                    const statusBadge = getStatusBadge(item.status, item.required, item.available);
                    // Xác định màu nền cho row
                    let rowClass = '';
                    if (item.status === 'not_found') {
                        rowClass = 'bg-gray-50';
                    } else if (item.status === 'sufficient') {
                        rowClass = '';
                    } else if (item.status === 'partial') {
                        rowClass = 'bg-yellow-50';
                    } else if (item.status === 'shortage') {
                        rowClass = 'bg-red-50';
                    }

                    // Xác định màu cho cột "Tồn kho"
                    let availableColor = 'text-gray-500';
                    if (item.status !== 'not_found') {
                        availableColor = item.available >= item.required ? 'text-green-600' :
                            item.available > 0 ? 'text-orange-600' : 'text-red-600';
                    }

                    return `
                        <tr class="hover:bg-gray-50 ${rowClass}">
                            <td class="px-3 py-3 text-sm font-mono text-blue-600">${escapeHtml(item.code)}</td>
                            <td class="px-3 py-3 text-sm text-gray-900">${escapeHtml(item.name)}</td>
                            <td class="px-3 py-3 text-sm text-center text-gray-600">${escapeHtml(item.unit)}</td>
                            <td class="px-3 py-3 text-sm text-center font-semibold text-blue-600">${item.required.toFixed(2)}</td>
                            <td class="px-3 py-3 text-sm text-center font-semibold ${availableColor}">${item.status === 'not_found' ? '-' : item.available.toFixed(2)}</td>
                            <td class="px-3 py-3 text-sm text-center font-semibold ${item.shortage > 0 ? 'text-red-600' : 'text-gray-400'}">${item.shortage.toFixed(2)}</td>
                            <td class="px-3 py-3 text-center">${statusBadge}</td>
                        </tr>
                    `;
                }).join('');
            }

            /**
             * Render Kính inventory check table
             */
            function renderKhoKinhTable(data) {
                const tbody = document.getElementById('khoKinhTableBody');
                if (!tbody) return;

                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                <p>Chưa có dữ liệu kính cần kiểm tra</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = data.map(item => {
                    const statusBadge = getStatusBadge(item.status, item.required, item.available);
                    // Xác định màu nền cho row
                    let rowClass = '';
                    if (item.status === 'not_found') {
                        rowClass = 'bg-gray-50';
                    } else if (item.status === 'sufficient') {
                        rowClass = '';
                    } else if (item.status === 'partial') {
                        rowClass = 'bg-yellow-50';
                    } else if (item.status === 'shortage') {
                        rowClass = 'bg-red-50';
                    }

                    // Xác định màu cho cột "Tồn kho"
                    let availableColor = 'text-gray-500';
                    if (item.status !== 'not_found') {
                        availableColor = item.available >= item.required ? 'text-green-600' :
                            item.available > 0 ? 'text-orange-600' : 'text-red-600';
                    }

                    return `
                        <tr class="hover:bg-gray-50 ${rowClass}">
                            <td class="px-3 py-3 text-sm font-mono text-cyan-600">${escapeHtml(item.code)}</td>
                            <td class="px-3 py-3 text-sm text-gray-900">${escapeHtml(item.name)}</td>
                            <td class="px-3 py-3 text-sm text-center text-gray-600">${escapeHtml(item.unit)}</td>
                            <td class="px-3 py-3 text-sm text-center font-semibold text-cyan-600">${item.required.toFixed(2)}</td>
                            <td class="px-3 py-3 text-sm text-center font-semibold ${availableColor}">${item.status === 'not_found' ? '-' : item.available.toFixed(2)}</td>
                            <td class="px-3 py-3 text-sm text-center font-semibold ${item.shortage > 0 ? 'text-red-600' : 'text-gray-400'}">${item.shortage.toFixed(2)}</td>
                            <td class="px-3 py-3 text-center">${statusBadge}</td>
                        </tr>
                    `;
                }).join('');
            }

            /**
             * Render Vật tư Phụ inventory check table
             */
            function renderKhoVatTuTable(data) {
                const tbody = document.getElementById('khoVatTuTableBody');
                if (!tbody) return;

                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                <p>Chưa có dữ liệu vật tư phụ cần kiểm tra</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = data.map(item => {
                    const statusBadge = getStatusBadge(item.status, item.required, item.available);
                    // Xác định màu nền cho row
                    let rowClass = '';
                    if (item.status === 'not_found') {
                        rowClass = 'bg-gray-50';
                    } else if (item.status === 'sufficient') {
                        rowClass = '';
                    } else if (item.status === 'partial') {
                        rowClass = 'bg-yellow-50';
                    } else if (item.status === 'shortage') {
                        rowClass = 'bg-red-50';
                    }

                    // Xác định màu cho cột "Tồn kho"
                    let availableColor = 'text-gray-500';
                    if (item.status !== 'not_found') {
                        availableColor = item.available >= item.required ? 'text-green-600' :
                            item.available > 0 ? 'text-orange-600' : 'text-red-600';
                    }

                    return `
                        <tr class="hover:bg-gray-50 ${rowClass}">
                            <td class="px-3 py-3 text-sm font-mono text-amber-600">${escapeHtml(item.code)}</td>
                            <td class="px-3 py-3 text-sm text-gray-900">${escapeHtml(item.name)}</td>
                            <td class="px-3 py-3 text-sm text-center text-gray-600">${escapeHtml(item.unit)}</td>
                            <td class="px-3 py-3 text-sm text-center font-semibold text-amber-600">${item.required}</td>
                            <td class="px-3 py-3 text-sm text-center font-semibold ${availableColor}">${item.status === 'not_found' ? '-' : item.available}</td>
                            <td class="px-3 py-3 text-sm text-center font-semibold ${item.shortage > 0 ? 'text-red-600' : 'text-gray-400'}">${item.shortage}</td>
                            <td class="px-3 py-3 text-center">${statusBadge}</td>
                        </tr>
                    `;
                }).join('');
            }

            /**
             * Get status badge HTML
             */
            function getStatusBadge(status, required, available) {
                if (status === 'not_found') {
                    return '<span class="inline-block px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-semibold">⊘ Không có trong kho</span>';
                } else if (status === 'sufficient') {
                    return '<span class="inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">✓ Đủ</span>';
                } else if (status === 'partial') {
                    return '<span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">⚠ Thiếu</span>';
                } else if (status === 'shortage') {
                    return '<span class="inline-block px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">✗ Hết</span>';
                } else {
                    return '<span class="inline-block px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-semibold">⊘ Không có trong kho</span>';
                }
            }

            /**
             * Update inventory summary
             */
            function updateInventorySummary() {
                const allItems = [
                    ...inventoryCheckResults.nhom,
                    ...inventoryCheckResults.kinh,
                    ...inventoryCheckResults.vattu
                ];

                let sufficient = 0;
                let partial = 0;
                let shortage = 0;
                let notFound = 0;

                allItems.forEach(item => {
                    if (item.status === 'not_found') {
                        notFound++;
                    } else if (item.status === 'sufficient') {
                        sufficient++;
                    } else if (item.status === 'partial') {
                        partial++;
                    } else if (item.status === 'shortage') {
                        shortage++; // Chỉ tính những vật tư có trong kho nhưng hết hàng
                    }
                });

                const sufficientEl = document.getElementById('step4SufficientCount');
                const partialEl = document.getElementById('step4PartialCount');
                const shortageEl = document.getElementById('step4ShortageCount');
                const totalEl = document.getElementById('step4TotalCount');

                if (sufficientEl) sufficientEl.textContent = sufficient;
                if (partialEl) partialEl.textContent = partial;
                // "Hết hàng" chỉ tính những vật tư có trong kho nhưng hết (shortage), không tính "not_found"
                if (shortageEl) shortageEl.textContent = shortage;
                if (totalEl) totalEl.textContent = allItems.length;
            }

            /**
             * Refresh inventory check
             */
            function refreshInventoryCheck() {
                console.log('🔄 Refreshing inventory check...');
                loadInventoryCheckData();
            }

            /**
             * Show inventory error
             */
            function showInventoryError(message) {
                const tbodyNhom = document.getElementById('khoNhomTableBody');
                const tbodyKinh = document.getElementById('khoKinhTableBody');
                const tbodyVatTu = document.getElementById('khoVatTuTableBody');

                const errorHtml = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-red-500">
                            <p>${escapeHtml(message)}</p>
                        </td>
                    </tr>
                `;

                if (tbodyNhom) tbodyNhom.innerHTML = errorHtml;
                if (tbodyKinh) tbodyKinh.innerHTML = errorHtml;
                if (tbodyVatTu) tbodyVatTu.innerHTML = errorHtml;
            }

            // ===========================================
            // MATERIAL REQUEST FUNCTIONS
            // ===========================================
            let materialRequestItems = {
                nhom: [],
                kinh: [],
                phukien: []
            }; // Store items by category

            /**
             * Generate order code automatically
             */
            function generateOrderCode(category) {
                const prefix = category === 'nhom' ? 'YC-NHOM' : category === 'kinh' ? 'YC-KINH' : 'YC-PK';
                const date = new Date();
                const dateStr = date.getFullYear().toString().substring(2) +
                    String(date.getMonth() + 1).padStart(2, '0') +
                    String(date.getDate()).padStart(2, '0');
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                return `${prefix}-${dateStr}-${random}`;
            }

            /**
             * Open material request form for specific category
             */
            /**
             * Open material request form - collect all categories and show tabs
             */
            function openMaterialRequestForm() {
                // Collect items with shortage for all categories
                materialRequestItems = { nhom: [], kinh: [], phukien: [] };

                console.log('📋 Opening material request form...');
                console.log('📊 inventoryCheckResults:', {
                    nhom: inventoryCheckResults.nhom?.length || 0,
                    kinh: inventoryCheckResults.kinh?.length || 0,
                    vattu: inventoryCheckResults.vattu?.length || 0
                });

                // Collect from Nhôm
                if (inventoryCheckResults.nhom && inventoryCheckResults.nhom.length > 0) {
                    inventoryCheckResults.nhom.forEach(item => {
                        console.log(`🔍 Nhôm item: code="${item.code}", name="${item.name}", shortage=${item.shortage}, status=${item.status}`);
                        // Thêm cả vật tư không có trong kho (not_found) và vật tư thiếu (shortage, partial)
                        if (item.shortage > 0 || item.status === 'not_found') {
                            // Tìm thông tin chi tiết từ bocTachData
                            let bocTachItem = null;
                            if (bocTachData && bocTachData.nhom) {
                                bocTachItem = bocTachData.nhom.find(b =>
                                    (b.code || b.material_code || b.ma_vat_tu) === item.code ||
                                    (b.name || b.material_name || b.ten_vat_tu) === item.name
                                );
                            }

                            materialRequestItems.nhom.push({
                                code: item.code,
                                name: item.name,
                                unit: item.unit,
                                shortage: item.shortage || item.required, // Nếu not_found, shortage = required
                                required: item.required,
                                available: item.available || 0,
                                type: 'nhom',
                                category: 'Nhôm',
                                requestQty: item.shortage || item.required, // Nếu not_found, requestQty = required
                                notes: '',
                                // Thêm thông tin chi tiết từ bocTachData
                                density: bocTachItem ? (bocTachItem.density || bocTachItem.ty_trong || 0) : 0,
                                length: bocTachItem ? (bocTachItem.length || bocTachItem.length_m || 6) : 6,
                                weight: bocTachItem ? (bocTachItem.weight || bocTachItem.khoi_luong || 0) : 0
                            });
                            console.log(`✅ Added Nhôm: ${item.name}, shortage=${item.shortage || item.required}, density=${bocTachItem?.density || 0}, weight=${bocTachItem?.weight || 0}`);
                        }
                    });
                }

                // Collect from Kính
                if (inventoryCheckResults.kinh && inventoryCheckResults.kinh.length > 0) {
                    inventoryCheckResults.kinh.forEach(item => {
                        console.log(`🔍 Kính item: code="${item.code}", name="${item.name}", shortage=${item.shortage}, status=${item.status}`);
                        // Thêm cả vật tư không có trong kho (not_found) và vật tư thiếu (shortage, partial)
                        if (item.shortage > 0 || item.status === 'not_found') {
                            // Tìm thông tin chi tiết từ bocTachData
                            let bocTachItem = null;
                            if (bocTachData && bocTachData.kinh) {
                                bocTachItem = bocTachData.kinh.find(b =>
                                    (b.code || b.glass_code || b.ma_kinh) === item.code ||
                                    (b.type || b.glass_type || b.loai_kinh) === item.name
                                );
                            }

                            // Ưu tiên width_mm/height_mm vì đó là format trong bocTachData
                            const width = bocTachItem ? (bocTachItem.width_mm || bocTachItem.width || bocTachItem.chieu_rong || 0) : 0;
                            const height = bocTachItem ? (bocTachItem.height_mm || bocTachItem.height || bocTachItem.chieu_cao || 0) : 0;
                            const area = bocTachItem ? (bocTachItem.area_m2 || bocTachItem.area || bocTachItem.dien_tich || 0) : 0;
                            const panels = bocTachItem ? (bocTachItem.quantity || bocTachItem.panels || bocTachItem.so_tam || bocTachItem.qty || 0) : (item.shortage || item.required);

                            materialRequestItems.kinh.push({
                                code: item.code,
                                name: item.name,
                                unit: item.unit || 'tấm',
                                shortage: item.shortage || item.required, // Nếu not_found, shortage = required
                                required: item.required,
                                available: item.available || 0,
                                type: 'kinh',
                                category: 'Kính',
                                requestQty: item.shortage || item.required, // Nếu not_found, requestQty = required
                                notes: '',
                                // Thêm thông tin chi tiết từ bocTachData - ưu tiên width_mm/height_mm
                                width: width,
                                width_mm: width, // Giữ cả hai để tương thích
                                height: height,
                                height_mm: height, // Giữ cả hai để tương thích
                                area: area,
                                area_m2: area, // Giữ cả hai để tương thích
                                panels: panels,
                                quantity: panels // Giữ cả hai để tương thích
                            });
                            console.log(`✅ Added Kính: ${item.name}, shortage=${item.shortage || item.required}, width=${width}, height=${height}, area=${area}, panels=${panels}, bocTachItem:`, bocTachItem);
                        }
                    });
                }

                // Collect from Vật tư Phụ
                if (inventoryCheckResults.vattu && inventoryCheckResults.vattu.length > 0) {
                    inventoryCheckResults.vattu.forEach(item => {
                        console.log(`🔍 Vật tư Phụ item: code="${item.code}", name="${item.name}", shortage=${item.shortage}, status=${item.status}`);
                        // Thêm cả vật tư không có trong kho (not_found) và vật tư thiếu (shortage, partial)
                        if (item.shortage > 0 || item.status === 'not_found') {
                            materialRequestItems.phukien.push({
                                code: item.code,
                                name: item.name,
                                unit: item.unit,
                                shortage: item.shortage || item.required, // Nếu not_found, shortage = required
                                required: item.required,
                                available: item.available || 0,
                                type: 'phukien',
                                category: 'Phụ kiện',
                                requestQty: item.shortage || item.required, // Nếu not_found, requestQty = required
                                notes: ''
                            });
                            console.log(`✅ Added Phụ kiện: ${item.name}, shortage=${item.shortage || item.required}`);
                        }
                    });
                }

                console.log('📦 Collected items:', {
                    nhom: materialRequestItems.nhom.length,
                    kinh: materialRequestItems.kinh.length,
                    phukien: materialRequestItems.phukien.length
                });

                const totalItems = materialRequestItems.nhom.length + materialRequestItems.kinh.length + materialRequestItems.phukien.length;
                if (totalItems === 0) {
                    alert('Không có vật tư nào cần yêu cầu. Tất cả vật tư đều đủ!');
                    return;
                }

                // Show form
                const form = document.getElementById('materialRequestForm');
                if (form) {
                    form.classList.remove('hidden');

                    // Initialize all category forms
                    ['nhom', 'kinh', 'phukien'].forEach(category => {
                        const orderCodeId = category === 'nhom' ? 'requestOrderCodeNhom' :
                            category === 'kinh' ? 'requestOrderCodeKinh' :
                                'requestOrderCodePhuKien';
                        const createdDateId = category === 'nhom' ? 'requestCreatedDateNhom' :
                            category === 'kinh' ? 'requestCreatedDateKinh' :
                                'requestCreatedDatePhuKien';
                        const requiredDateId = category === 'nhom' ? 'requestRequiredDateNhom' :
                            category === 'kinh' ? 'requestRequiredDateKinh' :
                                'requestRequiredDatePhuKien';

                        const orderCodeEl = document.getElementById(orderCodeId);
                        if (orderCodeEl && !orderCodeEl.value) {
                            orderCodeEl.value = generateOrderCode(category);
                        }

                        const createdDateEl = document.getElementById(createdDateId);
                        if (createdDateEl && !createdDateEl.value) {
                            const today = new Date().toISOString().split('T')[0];
                            createdDateEl.value = today;
                        }

                        const requiredDateEl = document.getElementById(requiredDateId);
                        if (requiredDateEl && !requiredDateEl.value) {
                            const futureDate = new Date();
                            futureDate.setDate(futureDate.getDate() + 7);
                            requiredDateEl.value = futureDate.toISOString().split('T')[0];
                        }

                        renderMaterialRequestTable(category);
                    });

                    // Show first tab with items
                    if (materialRequestItems.nhom.length > 0) {
                        switchMaterialRequestTab('nhom');
                    } else if (materialRequestItems.kinh.length > 0) {
                        switchMaterialRequestTab('kinh');
                    } else if (materialRequestItems.phukien.length > 0) {
                        switchMaterialRequestTab('phukien');
                    }
                }
            }

            /**
             * Switch material request tab
             */
            function switchMaterialRequestTab(category) {
                // Hide all tab contents
                document.querySelectorAll('.material-request-tab-content').forEach(el => {
                    el.classList.add('hidden');
                });

                // Remove active class from all tabs
                document.querySelectorAll('[id^="materialRequestTab"]').forEach(el => {
                    el.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
                    el.classList.remove('border-cyan-500', 'text-cyan-600', 'bg-cyan-50');
                    el.classList.remove('border-amber-500', 'text-amber-600', 'bg-amber-50');
                    el.classList.add('border-transparent', 'text-gray-600');
                });

                // Show selected tab content
                const tabContentId = category === 'nhom' ? 'materialRequestTabContentNhom' :
                    category === 'kinh' ? 'materialRequestTabContentKinh' :
                        'materialRequestTabContentPhuKien';
                const tabContent = document.getElementById(tabContentId);
                if (tabContent) {
                    tabContent.classList.remove('hidden');
                }

                // Activate selected tab
                const tabId = category === 'nhom' ? 'materialRequestTabNhom' :
                    category === 'kinh' ? 'materialRequestTabKinh' :
                        'materialRequestTabPhuKien';
                const tab = document.getElementById(tabId);
                if (tab) {
                    if (category === 'nhom') {
                        tab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
                    } else if (category === 'kinh') {
                        tab.classList.add('border-cyan-500', 'text-cyan-600', 'bg-cyan-50');
                    } else if (category === 'phukien') {
                        tab.classList.add('border-amber-500', 'text-amber-600', 'bg-amber-50');
                    }
                    tab.classList.remove('border-transparent', 'text-gray-600');
                }

                // Re-render table for this category to ensure data is displayed
                renderMaterialRequestTable(category);
            }

            /**
             * Close material request form
             */
            function closeMaterialRequestForm() {
                const form = document.getElementById('materialRequestForm');
                if (form) {
                    form.classList.add('hidden');
                }
            }

            /**
             * Get current active material request category from tab
             */
            function getCurrentMaterialRequestCategory() {
                // Check which tab is active
                const tabNhom = document.getElementById('materialRequestTabNhom');
                const tabKinh = document.getElementById('materialRequestTabKinh');
                const tabPhuKien = document.getElementById('materialRequestTabPhuKien');

                if (tabNhom && tabNhom.classList.contains('border-blue-500')) {
                    return 'nhom';
                } else if (tabKinh && tabKinh.classList.contains('border-cyan-500')) {
                    return 'kinh';
                } else if (tabPhuKien && tabPhuKien.classList.contains('border-amber-500')) {
                    return 'phukien';
                }

                // Default to first tab with items
                if (materialRequestItems.nhom && materialRequestItems.nhom.length > 0) {
                    return 'nhom';
                } else if (materialRequestItems.kinh && materialRequestItems.kinh.length > 0) {
                    return 'kinh';
                } else if (materialRequestItems.phukien && materialRequestItems.phukien.length > 0) {
                    return 'phukien';
                }

                return 'nhom'; // Default fallback
            }

            /**
             * Render material request table for specific category
             */
            function renderMaterialRequestTable(category) {
                const categoryMap = {
                    'nhom': { key: 'nhom', tbodyId: 'materialRequestTableBodyNhom', countId: 'materialRequestCountNhom' },
                    'kinh': { key: 'kinh', tbodyId: 'materialRequestTableBodyKinh', countId: 'materialRequestCountKinh' },
                    'phukien': { key: 'phukien', tbodyId: 'materialRequestTableBodyPhuKien', countId: 'materialRequestCountPhuKien' }
                };

                const config = categoryMap[category];
                if (!config) {
                    console.warn(`⚠️ Invalid category: ${category}`);
                    return;
                }

                const tbody = document.getElementById(config.tbodyId);
                const countEl = document.getElementById(config.countId);
                const items = materialRequestItems[config.key] || [];

                console.log(`🎨 Rendering material request table for ${category}:`, {
                    tbodyId: config.tbodyId,
                    countId: config.countId,
                    itemsCount: items.length,
                    items: items
                });

                if (!tbody) {
                    console.error(`❌ Table body not found: ${config.tbodyId}`);
                    return;
                }

                if (items.length === 0) {
                    console.log(`ℹ️ No items to render for ${category}`);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                <p>Không có vật tư cần yêu cầu</p>
                            </td>
                        </tr>
                    `;
                    if (countEl) countEl.textContent = '0';
                    return;
                }

                tbody.innerHTML = items.map((item, index) => {
                    // Đảm bảo shortage và requestQty luôn có giá trị hợp lệ
                    const shortage = parseFloat(item.shortage) || parseFloat(item.required) || 0;
                    const requestQty = parseFloat(item.requestQty) || shortage || parseFloat(item.required) || 0;
                    const categoryKey = config.key;

                    return `
                        <tr class="hover:bg-gray-50 material-request-row" data-index="${index}" data-category="${categoryKey}">
                            <td class="px-3 py-3 text-center text-sm text-gray-600">${index + 1}</td>
                            <td class="px-3 py-3 text-sm font-mono text-blue-600">${escapeHtml(item.code || '')}</td>
                            <td class="px-3 py-3 text-sm text-gray-900">${escapeHtml(item.name || '')}</td>
                            <td class="px-3 py-3 text-center text-sm text-gray-600">${escapeHtml(item.unit || '')}</td>
                            <td class="px-3 py-3 text-center text-sm font-semibold text-red-600">${shortage.toFixed(2)}</td>
                            <td class="px-3 py-3">
                                <input type="number" 
                                    class="request-qty-input w-24 px-2 py-1 border border-gray-300 rounded text-center text-sm font-semibold text-orange-600" 
                                    value="${requestQty.toFixed(2)}" 
                                    min="0" 
                                    step="0.01"
                                    data-index="${index}"
                                    data-category="${categoryKey}"
                                    onchange="updateMaterialRequestQty('${categoryKey}', ${index}, this.value)">
                            </td>
                            <td class="px-3 py-3">
                                <input type="text" 
                                    class="request-notes-input w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                    placeholder="Ghi chú..."
                                    data-index="${index}"
                                    data-category="${categoryKey}"
                                    value="${escapeHtml(item.notes || '')}"
                                    onchange="updateMaterialRequestNotes('${categoryKey}', ${index}, this.value)">
                            </td>
                        </tr>
                    `;
                }).join('');

                if (countEl) countEl.textContent = items.length;
            }

            /**
             * Update material request quantity
             */
            function updateMaterialRequestQty(category, index, value) {
                if (materialRequestItems[category] && materialRequestItems[category][index]) {
                    materialRequestItems[category][index].requestQty = parseFloat(value) || 0;
                }
            }

            /**
             * Update material request notes
             */
            function updateMaterialRequestNotes(category, index, value) {
                if (materialRequestItems[category] && materialRequestItems[category][index]) {
                    materialRequestItems[category][index].notes = value;
                }
            }

            /**
             * Clear all material requests for category
             */
            function clearMaterialRequest(category) {
                const categoryMap = {
                    'nhom': { key: 'nhom', label: 'Nhôm' },
                    'kinh': { key: 'kinh', label: 'Kính' },
                    'phukien': { key: 'phukien', label: 'Phụ kiện' }
                };
                const config = categoryMap[category];
                if (!config) return;

                if (confirm(`Xóa tất cả ${config.label.toLowerCase()} khỏi danh sách yêu cầu?`)) {
                    materialRequestItems[config.key] = [];
                    renderMaterialRequestTable(category);
                }
            }

            /**
             * Save material request for specific category - CALLS API TO PERSIST TO DATABASE
             */
            async function saveMaterialRequest(category) {
                const categoryMap = {
                    'nhom': { key: 'nhom', label: 'Nhôm', orderCodeId: 'requestOrderCodeNhom', createdDateId: 'requestCreatedDateNhom', requiredDateId: 'requestRequiredDateNhom' },
                    'kinh': { key: 'kinh', label: 'Kính', orderCodeId: 'requestOrderCodeKinh', createdDateId: 'requestCreatedDateKinh', requiredDateId: 'requestRequiredDateKinh' },
                    'phukien': { key: 'phukien', label: 'Phụ kiện', orderCodeId: 'requestOrderCodePhuKien', createdDateId: 'requestCreatedDatePhuKien', requiredDateId: 'requestRequiredDatePhuKien' }
                };

                const config = categoryMap[category];
                if (!config) return;

                const items = materialRequestItems[config.key] || [];
                if (items.length === 0) {
                    alert(`Không có ${config.label.toLowerCase()} nào để lưu!`);
                    return;
                }

                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }

                try {
                    // Get form values
                    const orderCode = document.getElementById(config.orderCodeId)?.value || generateOrderCode(category);
                    const createdDate = document.getElementById(config.createdDateId)?.value || new Date().toISOString().split('T')[0];
                    const requiredDate = document.getElementById(config.requiredDateId)?.value || '';

                    // Format items based on category for backend
                    const formatNhomData = (items) => items.map(item => ({
                        code: item.code || '',
                        name: item.name || '',
                        density: item.density || '',
                        length: item.length || 6,
                        unit: item.unit || 'cây',
                        quantity: parseFloat(item.requestQty || item.shortage || item.quantity) || 0,
                        weight: item.weight || '',
                        note: item.notes || ''
                    }));

                    const formatKinhData = (items) => items.map(item => ({
                        code: item.code || '',
                        type: item.name || '',
                        width: item.width || 0,
                        height: item.height || 0,
                        unit: item.unit || 'tấm',
                        panels: parseFloat(item.requestQty || item.shortage || item.panels || item.quantity) || 0,
                        area: item.area || 0,
                        note: item.notes || ''
                    }));

                    const formatPhukienData = (items) => items.map(item => ({
                        code: item.code || '',
                        name: item.name || '',
                        unit: item.unit || 'cái',
                        quantity: parseFloat(item.requestQty || item.shortage || item.quantity) || 0,
                        note: item.notes || ''
                    }));

                    // Prepare API payload
                    const payload = {
                        project_id: currentProject.id,
                        project_name: currentProject.name || currentProject.project_name,
                        order_code: orderCode,
                        product_type: currentProject.product_type || 'Cửa nhôm',
                        color: currentProject.color || '',
                        delivery_address: currentProject.address || currentProject.delivery_address || '',
                        created_date: createdDate,
                        required_date: requiredDate || null,
                        status: 'draft'
                    };

                    // Add formatted data for the specific category
                    if (category === 'nhom') {
                        payload.nhom = formatNhomData(items);
                        payload.vattu = null;
                        payload.phukien = null;
                        payload.kinh = null;
                    } else if (category === 'kinh') {
                        payload.nhom = null;
                        payload.vattu = null;
                        payload.phukien = null;
                        payload.kinh = formatKinhData(items);
                    } else if (category === 'phukien') {
                        payload.nhom = null;
                        payload.vattu = null;
                        payload.phukien = formatPhukienData(items);
                        payload.kinh = null;
                    }

                    console.log('📤 Saving material request to API:', payload);

                    // Call API to save to database
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/purchase-requests`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token || ''}`
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast(`Đã lưu phiếu yêu cầu ${config.label.toLowerCase()} thành công!`, 'success');
                        console.log('✅ Saved successfully:', result.data);

                        // Also save to sessionStorage for compatibility
                        const storageKey = `purchaseRequest_${config.key}`;
                        sessionStorage.setItem(storageKey, JSON.stringify(payload));
                        sessionStorage.setItem('purchaseRequest_project', JSON.stringify(currentProject));
                    } else {
                        throw new Error(result.message || 'Lỗi không xác định từ server');
                    }
                } catch (error) {
                    console.error('Error saving material request:', error);
                    alert('Lỗi khi lưu yêu cầu vật tư: ' + error.message);
                }
            }

            /**
             * Submit material request (navigate to purchase request page)
             */
            function submitMaterialRequest(category) {
                const categoryMap = {
                    'nhom': { key: 'nhom', label: 'Nhôm' },
                    'kinh': { key: 'kinh', label: 'Kính' },
                    'phukien': { key: 'phukien', label: 'Phụ kiện' }
                };

                const config = categoryMap[category];
                if (!config) return;

                const items = materialRequestItems[config.key] || [];
                if (items.length === 0) {
                    alert(`Không có ${config.label.toLowerCase()} nào để gửi!`);
                    return;
                }

                // Save first
                saveMaterialRequest(category).then(() => {
                    // Navigate to purchase request page
                    window.location.href = 'purchase-request.html';
                });
            }

            /**
             * Export material request to Excel for specific category
             */
            async function exportMaterialRequestExcel(category) {
                const categoryMap = {
                    'nhom': { key: 'nhom', label: 'NHÔM', orderCodeId: 'requestOrderCodeNhom', createdDateId: 'requestCreatedDateNhom', requiredDateId: 'requestRequiredDateNhom' },
                    'kinh': { key: 'kinh', label: 'KÍNH', orderCodeId: 'requestOrderCodeKinh', createdDateId: 'requestCreatedDateKinh', requiredDateId: 'requestRequiredDateKinh' },
                    'phukien': { key: 'phukien', label: 'PHỤ KIỆN', orderCodeId: 'requestOrderCodePhuKien', createdDateId: 'requestCreatedDatePhuKien', requiredDateId: 'requestRequiredDatePhuKien' }
                };

                const config = categoryMap[category];
                if (!config) {
                    console.error('Invalid category:', category);
                    return;
                }

                const items = materialRequestItems[config.key] || [];
                if (items.length === 0) {
                    alert(`Không có ${config.label.toLowerCase()} nào để xuất Excel!`);
                    return;
                }

                // Get form values
                const orderCode = document.getElementById(config.orderCodeId)?.value || generateOrderCode(category);
                const createdDate = document.getElementById(config.createdDateId)?.value || new Date().toISOString().split('T')[0];
                const requiredDate = document.getElementById(config.requiredDateId)?.value || '';

                // Title
                let title = '';
                if (category === 'nhom') {
                    title = 'PHIẾU YÊU CẦU VẬT TƯ NHÔM';
                } else if (category === 'kinh') {
                    title = 'PHIẾU YÊU CẦU VẬT TƯ KÍNH';
                } else if (category === 'phukien') {
                    title = 'PHIẾU YÊU CẦU VẬT TƯ - PHỤ KIỆN';
                }

                // Prepare items data
                const itemsData = items.map(item => ({
                    code: item.code || '',
                    name: item.name || '',
                    unit: item.unit || '',
                    shortage: parseFloat(item.shortage) || 0,
                    requestQty: parseFloat(item.requestQty || item.shortage) || 0,
                    notes: item.notes || ''
                }));

                try {
                    // Show loading
                    showToast('Đang tạo file Excel...', 'info');

                    // Call backend API
                    const response = await fetch(`${API_BASE}/bom-export/material-request`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                        },
                        body: JSON.stringify({
                            projectId: currentProject?.id || currentProject?.project_id,
                            category: category,
                            title: title,
                            orderCode: orderCode,
                            createdDate: createdDate,
                            requiredDate: requiredDate,
                            items: itemsData
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Lỗi không xác định' }));
                        throw new Error(errorData.message || `HTTP ${response.status}`);
                    }

                    // Get file as blob
                    const blob = await response.blob();

                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');

                    // Generate filename
                    const projectName = currentProject ? (currentProject.name || currentProject.project_name || 'Project') : 'Project';
                    const dateStr = new Date().toISOString().split('T')[0];
                    const filename = `${title.replace(/\s+/g, '_')}_${projectName.replace(/\s+/g, '_')}_${dateStr}.xlsx`;

                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);

                    showToast('Xuất Excel thành công!', 'success');
                } catch (error) {
                    console.error('Error exporting Excel:', error);
                    showToast(`Lỗi xuất Excel: ${error.message}`, 'error');
                }
            }

            /**
             * Export all material requests to separate Excel files
             */
            function exportAllMaterialRequestsExcel() {
                // Open form first if not open
                const form = document.getElementById('materialRequestForm');
                if (!form || form.classList.contains('hidden')) {
                    openMaterialRequestForm();
                }

                // Export each category separately
                const categories = ['nhom', 'kinh', 'phukien'];
                let exportedCount = 0;

                categories.forEach((category, index) => {
                    const items = materialRequestItems[category] || [];
                    if (items.length > 0) {
                        // Delay each export to avoid browser blocking multiple downloads
                        setTimeout(() => {
                            exportMaterialRequestExcel(category);
                            exportedCount++;
                        }, index * 500);
                    }
                });

                if (exportedCount === 0) {
                    alert('Không có vật tư nào để xuất Excel!');
                } else {
                    setTimeout(() => {
                        showToast(`Đã xuất ${exportedCount} file Excel thành công!`, 'success');
                    }, exportedCount * 500);
                }
            }

            // Render accessories table with inline editing
            function renderBocTachVatTuTable(data) {
                bocTachData.vattu = Array.isArray(data) ? data : [];
                const tbody = document.getElementById('vattuTableBody');
                if (!tbody) return;

                // Generate rows HTML
                let rowsHtml = '';
                if (bocTachData.vattu.length === 0) {
                    rowsHtml = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-gray-300 mb-2" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <p>Chưa có dữ liệu vật tư phụ</p>
                                <p class="text-sm text-gray-400 mt-1">Nhấn "Bóc tách BOM tất cả" để tính toán</p>
                            </div>
                        </td>
                    </tr>
                `;
                } else {
                    rowsHtml = bocTachData.vattu.map((item, index) => {
                        return `
                        <tr class="hover:bg-gray-50 vattu-row" data-index="${index}">
                            <td class="px-2 py-1"><input type="text" class="vattu-edit w-full px-2 py-1 border border-gray-200 rounded text-sm" data-field="name" value="${item.name || item.item_name || ''}" placeholder="Tên phụ kiện" /></td>
                            <td class="px-2 py-1"><input type="text" class="vattu-edit w-full px-2 py-1 border border-gray-200 rounded text-sm text-center" data-field="code" value="${item.code || item.item_code || ''}" placeholder="Mã VT" /></td>
                            <td class="px-2 py-1"><input type="text" class="vattu-edit w-full px-2 py-1 border border-gray-200 rounded text-sm text-center" data-field="category" value="${item.category || item.type || ''}" placeholder="Loại" /></td>
                            <td class="px-2 py-1"><input type="text" class="vattu-edit w-14 px-2 py-1 border border-gray-200 rounded text-sm text-center" data-field="unit" value="${item.unit || 'cái'}" /></td>
                            <td class="px-2 py-1"><input type="number" class="vattu-edit w-16 px-2 py-1 border border-gray-200 rounded text-sm text-center font-semibold text-amber-600" data-field="quantity" value="${item.quantity || 0}" /></td>
                            <td class="px-2 py-1"><input type="text" class="vattu-edit w-full px-2 py-1 border border-gray-200 rounded text-sm" data-field="notes" value="${item.notes || ''}" placeholder="Ghi chú" /></td>
                            <td class="px-2 py-1 text-center">
                                <button onclick="deleteVatTuRow(${index})" class="text-red-500 hover:text-red-700" title="Xóa">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M4 7h16" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                    }).join('');
                }

                tbody.innerHTML = rowsHtml;

                // Add change listeners
                tbody.querySelectorAll('.vattu-edit').forEach(input => {
                    input.addEventListener('change', function () {
                        const row = this.closest('tr');
                        const index = parseInt(row.dataset.index);
                        const field = this.dataset.field;
                        let value = this.value;
                        if (field === 'quantity') {
                            value = parseInt(value) || 0;
                        }
                        if (bocTachData.vattu[index]) {
                            bocTachData.vattu[index][field] = value;
                        }
                        updateVatTuSummary();
                        autoSaveBOMData(); // Auto-save
                    });
                });

                updateVatTuSummary();
            }

            function updateVatTuSummary() {
                let keCount = 0;
                let gioangCount = 0;
                let hardwareCount = 0;
                let totalQuantity = 0;
                bocTachData.vattu.forEach(item => {
                    const name = (item.name || item.item_name || '').toLowerCase();
                    const qty = parseInt(item.quantity) || 0;
                    totalQuantity += qty;
                    if (name.includes('ke') || name.includes('góc')) keCount += qty;
                    if (name.includes('gioăng') || name.includes('ron')) gioangCount += qty;
                    if (name.includes('bản lề') || name.includes('khóa') || name.includes('khoa')) hardwareCount += qty;
                });

                const vattuKeCountEl = document.getElementById('vattuKeCount');
                const vattuGioangCountEl = document.getElementById('vattuGioangCount');
                const vattuHardwareCountEl = document.getElementById('vattuHardwareCount');
                const vattuTotalTypesEl = document.getElementById('vattuTotalTypes');
                const footerQty = document.getElementById('vattuFooterQty');

                if (vattuKeCountEl) vattuKeCountEl.textContent = keCount + ' cái';
                if (vattuGioangCountEl) vattuGioangCountEl.textContent = gioangCount + ' cái';
                if (vattuHardwareCountEl) vattuHardwareCountEl.textContent = hardwareCount + ' bộ';
                if (vattuTotalTypesEl) vattuTotalTypesEl.textContent = bocTachData.vattu.length;
                if (footerQty) footerQty.textContent = totalQuantity;
            }

            function addVatTuRowFromTable() {
                const code = document.getElementById('newVatTuCode').value.trim();
                const name = document.getElementById('newVatTuName').value.trim();
                const unit = document.getElementById('newVatTuUnit').value.trim() || 'cái';
                const quantity = parseInt(document.getElementById('newVatTuQty').value) || 0;
                const notes = document.getElementById('newVatTuNotes').value.trim();

                if (!name) {
                    alert('Vui lòng nhập tên vật tư');
                    document.getElementById('newVatTuName').focus();
                    return;
                }
                bocTachData.vattu.push({ code, name, unit, quantity, notes });
                renderBocTachVatTuTable(bocTachData.vattu);
                autoSaveBOMData();
            }

            function deleteVatTuRow(index) {
                if (confirm('Xóa dòng này?')) {
                    bocTachData.vattu.splice(index, 1);
                    renderBocTachVatTuTable(bocTachData.vattu);
                    autoSaveBOMData(); // Auto-save
                }
            }

            // Add empty accessory row and scroll to it
            function addEmptyVatTuRow() {
                bocTachData.vattu.push({
                    name: '',
                    code: '',
                    category: '',
                    unit: 'cái',
                    quantity: 0,
                    notes: ''
                });

                renderBocTachVatTuTable(bocTachData.vattu);
                autoSaveBOMData(); // Auto-save

                setTimeout(() => {
                    const lastIndex = bocTachData.vattu.length - 1;
                    const newRow = document.querySelector(`.vattu-row[data-index="${lastIndex}"]`);
                    if (newRow) {
                        newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        const nameInput = newRow.querySelector('input[data-field="name"]');
                        if (nameInput) nameInput.focus();
                    }
                }, 100);
            }

            // Add empty nhôm row
            function addEmptyNhomRow() {
                if (!bocTachData) {
                    bocTachData = { nhom: [], kinh: [], vattu: [] };
                }
                bocTachData.nhom.push({
                    code: '',
                    name: '',
                    density: 0,
                    length_m: 0,
                    unit: 'cây',
                    quantity: 0,
                    weight_kg: 0,
                    notes: ''
                });

                renderBocTachNhomTable(bocTachData.nhom);
                autoSaveBOMData(); // Auto-save

                setTimeout(() => {
                    const lastIndex = bocTachData.nhom.length - 1;
                    const newRow = document.querySelector(`.nhom-row[data-index="${lastIndex}"]`);
                    if (newRow) {
                        newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        const nameInput = newRow.querySelector('input[data-field="name"]');
                        if (nameInput) nameInput.focus();
                    }
                }, 100);
            }

            // Add empty kính row
            function addEmptyKinhRow() {
                if (!bocTachData) {
                    bocTachData = { nhom: [], kinh: [], vattu: [] };
                }
                bocTachData.kinh.push({
                    code: '',
                    type: '',
                    width_mm: 0,
                    height_mm: 0,
                    quantity: 0,
                    unit: 'tấm',
                    area_m2: 0,
                    position: ''
                });

                renderBocTachKinhTable(bocTachData.kinh);
                autoSaveBOMData(); // Auto-save

                setTimeout(() => {
                    const lastIndex = bocTachData.kinh.length - 1;
                    const newRow = document.querySelector(`.kinh-row[data-index="${lastIndex}"]`);
                    if (newRow) {
                        newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        const codeInput = newRow.querySelector('input[data-field="code"]');
                        if (codeInput) codeInput.focus();
                    }
                }, 100);
            }

            // Filter functions
            function filterNhomTable() {
                const searchTerm = document.getElementById('nhomSearchInput').value.toLowerCase();
                const filtered = bocTachData.nhom.filter(item => {
                    const name = (item.name || item.item_name || '').toLowerCase();
                    const code = (item.code || item.item_code || '').toLowerCase();
                    return name.includes(searchTerm) || code.includes(searchTerm);
                });
                renderBocTachNhomTable(filtered.length > 0 || searchTerm ? filtered : bocTachData.nhom);
            }

            function filterKinhTable() {
                const searchTerm = document.getElementById('kinhSearchInput').value.toLowerCase();
                const typeFilter = document.getElementById('kinhTypeFilter').value;
                let filtered = bocTachData.kinh.filter(item => {
                    const code = (item.code || item.glass_code || '').toLowerCase();
                    const type = (item.type || item.glass_type || '').toLowerCase();
                    const matchSearch = code.includes(searchTerm) || type.includes(searchTerm);
                    const matchType = !typeFilter || type.includes(typeFilter.toLowerCase());
                    return matchSearch && matchType;
                });
                renderBocTachKinhTable(filtered.length > 0 || (searchTerm === '' && !typeFilter) ? filtered : bocTachData.kinh);
            }

            // Render Nhôm table
            function renderBocTachNhomTable(data) {
                if (!bocTachData) {
                    bocTachData = { nhom: [], kinh: [], vattu: [] };
                }
                bocTachData.nhom = Array.isArray(data) ? data : [];
                const tbody = document.getElementById('nhomTableBody');
                if (!tbody) return;

                let rowsHtml = '';
                if (bocTachData.nhom.length === 0) {
                    rowsHtml = `
                        <tr>
                            <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                                <p>Chưa có dữ liệu bóc tách nhôm</p>
                            </td>
                        </tr>
                    `;
                } else {
                    rowsHtml = bocTachData.nhom.map((item, index) => {
                        const weight = (item.weight_kg || (item.density || 0) * (item.quantity || 0)).toFixed(2);
                        return `
                            <tr class="hover:bg-gray-50 nhom-row" data-index="${index}">
                                <td class="px-3 py-2"><input type="text" class="nhom-edit w-full px-2 py-1 border border-gray-200 rounded text-sm" data-field="name" value="${item.name || item.item_name || ''}" /></td>
                                <td class="px-2 py-1"><input type="text" class="nhom-edit w-full px-2 py-1 border border-gray-200 rounded text-sm text-center" data-field="code" value="${item.code || item.item_code || ''}" /></td>
                                <td class="px-2 py-1"><input type="number" step="0.01" class="nhom-edit w-full px-2 py-1 border border-gray-200 rounded text-sm text-center" data-field="density" value="${item.density || 0}" /></td>
                                <td class="px-2 py-1"><input type="number" step="0.01" class="nhom-edit w-full px-2 py-1 border border-gray-200 rounded text-sm text-center" data-field="length_m" value="${item.length_m || 0}" /></td>
                                <td class="px-2 py-1"><input type="text" class="nhom-edit w-14 px-2 py-1 border border-gray-200 rounded text-sm text-center" data-field="unit" value="${item.unit || 'cây'}" /></td>
                                <td class="px-2 py-1"><input type="number" class="nhom-edit w-16 px-2 py-1 border border-gray-200 rounded text-sm text-center font-semibold text-blue-600" data-field="quantity" value="${item.quantity || 0}" /></td>
                                <td class="px-2 py-1 text-center text-sm font-semibold text-blue-600">${weight}</td>
                                <td class="px-2 py-1"><input type="text" class="nhom-edit w-full px-2 py-1 border border-gray-200 rounded text-sm" data-field="notes" value="${item.notes || ''}" /></td>
                                <td class="px-2 py-1 text-center">
                                    <button onclick="deleteNhomRow(${index})" class="text-red-500 hover:text-red-700" title="Xóa">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M4 7h16" />
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                tbody.innerHTML = rowsHtml;

                // Add change listeners
                tbody.querySelectorAll('.nhom-edit').forEach(input => {
                    input.addEventListener('change', function () {
                        const row = this.closest('tr');
                        const index = parseInt(row.dataset.index);
                        const field = this.dataset.field;
                        let value = this.value;
                        if (field === 'quantity' || field === 'density' || field === 'length_m') {
                            value = parseFloat(value) || 0;
                        }
                        if (bocTachData.nhom[index]) {
                            bocTachData.nhom[index][field] = value;
                            // Recalculate weight
                            if (field === 'quantity' || field === 'density') {
                                bocTachData.nhom[index].weight_kg = (bocTachData.nhom[index].density || 0) * (bocTachData.nhom[index].quantity || 0);
                                // Update weight cell
                                const weightCell = row.querySelector('td:nth-child(7)');
                                if (weightCell) {
                                    weightCell.textContent = bocTachData.nhom[index].weight_kg.toFixed(2);
                                }
                            }
                        }
                        updateNhomSummary();
                        autoSaveBOMData();
                    });
                });

                updateNhomSummary();
            }

            // Render Kính table
            function renderBocTachKinhTable(data) {
                if (!bocTachData) {
                    bocTachData = { nhom: [], kinh: [], vattu: [] };
                }
                bocTachData.kinh = Array.isArray(data) ? data : [];
                const tbody = document.getElementById('kinhTableBody');
                if (!tbody) return;

                let rowsHtml = '';
                if (bocTachData.kinh.length === 0) {
                    rowsHtml = `
                        <tr>
                            <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                                <p>Chưa có dữ liệu kính</p>
                            </td>
                        </tr>
                    `;
                } else {
                    rowsHtml = bocTachData.kinh.map((item, index) => {
                        const area = (item.area_m2 || ((item.width_mm || 0) * (item.height_mm || 0) / 1000000 * (item.quantity || 0))).toFixed(4);
                        return `
                            <tr class="hover:bg-gray-50 kinh-row" data-index="${index}">
                                <td class="px-2 py-1"><input type="text" class="kinh-edit w-full px-2 py-1 border border-gray-200 rounded text-sm" data-field="code" value="${item.code || item.glass_code || ''}" placeholder="Mã kính" /></td>
                                <td class="px-2 py-1"><input type="text" class="kinh-edit w-full px-2 py-1 border border-gray-200 rounded text-sm" data-field="type" value="${item.type || item.glass_type || ''}" placeholder="Loại kính" /></td>
                                <td class="px-2 py-1"><input type="number" class="kinh-edit w-20 px-2 py-1 border border-gray-200 rounded text-sm text-center" data-field="width_mm" value="${item.width_mm || 0}" placeholder="Rộng" /></td>
                                <td class="px-2 py-1"><input type="number" class="kinh-edit w-20 px-2 py-1 border border-gray-200 rounded text-sm text-center" data-field="height_mm" value="${item.height_mm || 0}" placeholder="Cao" /></td>
                                <td class="px-2 py-1"><input type="text" class="kinh-edit w-14 px-2 py-1 border border-gray-200 rounded text-sm text-center" data-field="unit" value="${item.unit || 'tấm'}" /></td>
                                <td class="px-2 py-1"><input type="number" class="kinh-edit w-16 px-2 py-1 border border-gray-200 rounded text-sm text-center font-semibold text-cyan-600" data-field="quantity" value="${item.quantity || 0}" /></td>
                                <td class="px-2 py-1"><input type="text" class="kinh-edit w-full px-2 py-1 border border-gray-200 rounded text-sm" data-field="position" value="${item.position || ''}" placeholder="Vị trí" /></td>
                                <td class="px-2 py-1 text-center text-sm font-semibold text-cyan-600">${area}</td>
                                <td class="px-2 py-1 text-center">
                                    <button onclick="deleteKinhRow(${index})" class="text-red-500 hover:text-red-700" title="Xóa">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M4 7h16" />
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                tbody.innerHTML = rowsHtml;

                // Add change listeners
                tbody.querySelectorAll('.kinh-edit').forEach(input => {
                    input.addEventListener('change', function () {
                        const row = this.closest('tr');
                        const index = parseInt(row.dataset.index);
                        const field = this.dataset.field;
                        let value = this.value;
                        if (field === 'quantity' || field === 'width_mm' || field === 'height_mm') {
                            value = parseFloat(value) || 0;
                        }
                        if (bocTachData.kinh[index]) {
                            bocTachData.kinh[index][field] = value;
                            // Recalculate area
                            if (field === 'quantity' || field === 'width_mm' || field === 'height_mm') {
                                const width = bocTachData.kinh[index].width_mm || 0;
                                const height = bocTachData.kinh[index].height_mm || 0;
                                const qty = bocTachData.kinh[index].quantity || 0;
                                bocTachData.kinh[index].area_m2 = (width * height / 1000000 * qty);
                                // Update area cell (now 8th column after removing STT)
                                const areaCell = row.querySelector('td:nth-child(8)');
                                if (areaCell) {
                                    areaCell.textContent = bocTachData.kinh[index].area_m2.toFixed(4);
                                }
                            }
                        }
                        updateKinhSummary();
                        autoSaveBOMData();
                    });
                });

                updateKinhSummary();
            }

            // Update summary functions
            function updateNhomSummary() {
                let totalQty = 0;
                let totalWeight = 0;
                bocTachData.nhom.forEach(item => {
                    totalQty += parseInt(item.quantity) || 0;
                    totalWeight += parseFloat(item.weight_kg || (item.density || 0) * (item.quantity || 0));
                });

                const footerQty = document.getElementById('nhomFooterQty');
                const footerWeight = document.getElementById('nhomFooterWeight');
                if (footerQty) footerQty.textContent = totalQty;
                if (footerWeight) footerWeight.textContent = totalWeight.toFixed(2);
            }

            function updateKinhSummary() {
                let totalTypes = bocTachData.kinh.length;
                let totalPcs = 0;
                let totalArea = 0;
                bocTachData.kinh.forEach(item => {
                    totalPcs += parseInt(item.quantity) || 0;
                    totalArea += parseFloat(item.area_m2 || ((item.width_mm || 0) * (item.height_mm || 0) / 1000000 * (item.quantity || 0)));
                });

                const totalTypesEl = document.getElementById('kinhTotalTypes');
                const totalPcsEl = document.getElementById('kinhTotalPcs');
                const totalAreaEl = document.getElementById('kinhTotalArea');
                const footerQty = document.getElementById('kinhFooterQty');
                const footerArea = document.getElementById('kinhFooterArea');

                if (totalTypesEl) totalTypesEl.textContent = totalTypes;
                if (totalPcsEl) totalPcsEl.textContent = totalPcs;
                if (totalAreaEl) totalAreaEl.textContent = totalArea.toFixed(2) + ' m²';
                if (footerQty) footerQty.textContent = totalPcs;
                if (footerArea) footerArea.textContent = totalArea.toFixed(2);
            }

            // Delete row functions
            function deleteNhomRow(index) {
                if (confirm('Xóa dòng này?')) {
                    bocTachData.nhom.splice(index, 1);
                    renderBocTachNhomTable(bocTachData.nhom);
                    autoSaveBOMData();
                }
            }

            function deleteKinhRow(index) {
                if (confirm('Xóa dòng này?')) {
                    bocTachData.kinh.splice(index, 1);
                    renderBocTachKinhTable(bocTachData.kinh);
                    autoSaveBOMData();
                }
            }

            function filterVatTuTable() {
                const searchTerm = document.getElementById('vattuSearchInput').value.toLowerCase();
                const categoryFilter = document.getElementById('vattuCategoryFilter').value;
                let filtered = bocTachData.vattu.filter(item => {
                    const name = (item.name || item.item_name || '').toLowerCase();
                    const code = (item.code || item.item_code || '').toLowerCase();
                    const matchSearch = name.includes(searchTerm) || code.includes(searchTerm);

                    let matchCategory = true;
                    if (categoryFilter) {
                        switch (categoryFilter) {
                            case 'ke': matchCategory = name.includes('ke') || name.includes('góc'); break;
                            case 'gioang': matchCategory = name.includes('gioăng') || name.includes('gioang'); break;
                            case 'banle': matchCategory = name.includes('bản lề') || name.includes('ban le'); break;
                            case 'khoa': matchCategory = name.includes('khóa') || name.includes('khoa'); break;
                            case 'khac': matchCategory = !name.includes('ke') && !name.includes('gioăng') && !name.includes('bản lề') && !name.includes('khóa'); break;
                        }
                    }
                    return matchSearch && matchCategory;
                });
                renderBocTachVatTuTable(filtered.length > 0 || (searchTerm === '' && !categoryFilter) ? filtered : bocTachData.vattu);
            }

            // Export functions
            async function exportBocTachNhomExcel() {
                if (!bocTachData.nhom || bocTachData.nhom.length === 0) {
                    alert('Chưa có dữ liệu nhôm để xuất!');
                    return;
                }

                if (!currentProject || !currentProject.id) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/bom-export/${currentProject.id}/aluminum`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            data: bocTachData.nhom
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Lỗi khi xuất Excel');
                    }

                    // Get filename from Content-Disposition header
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'Boc_tach_Nhom.xlsx';
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }

                    // Download file
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = decodeURIComponent(filename);
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } catch (error) {
                    console.error('Error exporting aluminum Excel:', error);
                    alert('Lỗi khi xuất Excel: ' + error.message);
                }
            }

            async function exportBocTachKinhExcel() {
                if (!bocTachData.kinh || bocTachData.kinh.length === 0) {
                    alert('Chưa có dữ liệu kính để xuất!');
                    return;
                }

                if (!currentProject || !currentProject.id) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/bom-export/${currentProject.id}/glass`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            data: bocTachData.kinh
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Lỗi khi xuất Excel');
                    }

                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'Boc_tach_Kinh.xlsx';
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = decodeURIComponent(filename);
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } catch (error) {
                    console.error('Error exporting glass Excel:', error);
                    alert('Lỗi khi xuất Excel: ' + error.message);
                }
            }

            async function exportBocTachVatTuExcel() {
                if (!bocTachData.vattu || bocTachData.vattu.length === 0) {
                    alert('Chưa có dữ liệu vật tư phụ để xuất!');
                    return;
                }

                if (!currentProject || !currentProject.id) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/bom-export/${currentProject.id}/accessories`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            data: bocTachData.vattu
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Lỗi khi xuất Excel');
                    }

                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'Boc_tach_Vat_Tu_Phu.xlsx';
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = decodeURIComponent(filename);
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } catch (error) {
                    console.error('Error exporting accessories Excel:', error);
                    alert('Lỗi khi xuất Excel: ' + error.message);
                }
            }

            async function exportAllBocTachExcel() {
                if (!currentProject || !currentProject.id) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }

                // Check if there's any data
                const hasData = (bocTachData.nhom && bocTachData.nhom.length > 0) ||
                    (bocTachData.kinh && bocTachData.kinh.length > 0) ||
                    (bocTachData.vattu && bocTachData.vattu.length > 0);

                if (!hasData) {
                    alert('Chưa có dữ liệu bóc tách để xuất!');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/bom-export/${currentProject.id}/combined`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            nhom: bocTachData.nhom || [],
                            kinh: bocTachData.kinh || [],
                            vattu: bocTachData.vattu || []
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Lỗi khi xuất Excel');
                    }

                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'Boc_tach_Tong_hop.xlsx';
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = decodeURIComponent(filename);
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } catch (error) {
                    console.error('Error exporting combined Excel:', error);
                    alert('Lỗi khi xuất Excel: ' + error.message);
                }
            }

            // Update BOM extraction to populate new tabs
            const originalExtractAllBOM = typeof extractAllBOM === 'function' ? extractAllBOM : null;

            // Enhanced extractAllBOM that also populates the new tabs
            async function extractAllBOMWithTabs() {
                if (!currentProject) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }

                // Show loading
                document.getElementById('bocTachStatusText').textContent = 'Đang bóc tách BOM...';

                try {
                    // Call the BOM calculate API
                    const response = await fetch(`${API_BASE}/bom/projects/${currentProject.id}/calculate`);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.success && result.data) {
                        const bomData = result.data;

                        // Categorize BOM items
                        const nhomItems = [];
                        const kinhItems = [];
                        const vattuItems = [];

                        if (bomData.items) {
                            bomData.items.forEach(item => {
                                const type = (item.item_type || item.type || '').toLowerCase();
                                if (type === 'frame' || type === 'mullion' || type === 'sash' || type === 'aluminum' || type.includes('nhôm')) {
                                    nhomItems.push(item);
                                } else if (type === 'glass' || type.includes('kính')) {
                                    kinhItems.push(item);
                                } else {
                                    vattuItems.push(item);
                                }
                            });
                        }

                        // Render to tables
                        renderBocTachNhomTable(nhomItems);
                        renderBocTachKinhTable(kinhItems);
                        renderBocTachVatTuTable(vattuItems);

                        // Update status
                        const total = nhomItems.length + kinhItems.length + vattuItems.length;
                        document.getElementById('bocTachStatusText').textContent = `Đã bóc tách ${total} loại vật tư`;

                        alert(`Bóc tách BOM hoàn thành!\n- Nhôm: ${nhomItems.length} loại\n- Kính: ${kinhItems.length} loại\n- Vật tư phụ: ${vattuItems.length} loại`);
                    } else {
                        document.getElementById('bocTachStatusText').textContent = 'Bóc tách không thành công';
                        alert('Không thể bóc tách BOM: ' + (result.message || 'Lỗi không xác định'));
                    }
                } catch (error) {
                    console.error('Error extracting BOM:', error);
                    document.getElementById('bocTachStatusText').textContent = 'Lỗi bóc tách BOM';
                    alert('Lỗi khi bóc tách BOM: ' + error.message);
                }
            }

            // Override extractAllBOM if it exists
            if (typeof window.extractAllBOM !== 'function') {
                window.extractAllBOM = extractAllBOMWithTabs;
            }

            // ============================================
            // MANUAL DATA ENTRY FUNCTIONS
            // ============================================

            // Modal functions for Nhôm
            function openAddNhomModal() {
                document.getElementById('addNhomModal').classList.remove('hidden');
                document.getElementById('nhomCode').value = '';
                document.getElementById('nhomName').value = '';
                document.getElementById('nhomDensity').value = '';
                document.getElementById('nhomQuantity').value = '';
                document.getElementById('nhomUnit').value = 'cây';
                document.getElementById('nhomNotes').value = '';
            }

            function closeAddNhomModal() {
                document.getElementById('addNhomModal').classList.add('hidden');
            }

            function saveNewNhom() {
                const code = document.getElementById('nhomCode').value.trim();
                const name = document.getElementById('nhomName').value.trim();
                const density = parseFloat(document.getElementById('nhomDensity').value) || 0;
                const quantity = parseInt(document.getElementById('nhomQuantity').value) || 0;
                const unit = document.getElementById('nhomUnit').value.trim() || 'cây';
                const notes = document.getElementById('nhomNotes').value.trim();

                if (!code || !name || !quantity) {
                    alert('Vui lòng nhập đầy đủ: Mã vật tư, Tên vật tư, Số lượng');
                    return;
                }

                const newItem = {
                    code: code,
                    name: name,
                    density: density,
                    quantity: quantity,
                    unit: unit,
                    notes: notes,
                    weight_kg: density * quantity
                };

                bocTachData.nhom.push(newItem);
                renderBocTachNhomTable(bocTachData.nhom);
                closeAddNhomModal();

                alert(`Đã thêm: ${name} (${quantity} ${unit})`);
            }

            // Modal functions for Kính
            function openAddKinhModal() {
                document.getElementById('addKinhModal').classList.remove('hidden');
                document.getElementById('kinhCode').value = '';
                document.getElementById('kinhType').value = '';
                document.getElementById('kinhWidth').value = '';
                document.getElementById('kinhHeight').value = '';
                document.getElementById('kinhQuantity').value = '';
                document.getElementById('kinhPosition').value = '';
            }

            function closeAddKinhModal() {
                document.getElementById('addKinhModal').classList.add('hidden');
            }

            function saveNewKinh() {
                const code = document.getElementById('kinhCode').value.trim();
                const type = document.getElementById('kinhType').value.trim();
                const width = parseInt(document.getElementById('kinhWidth').value) || 0;
                const height = parseInt(document.getElementById('kinhHeight').value) || 0;
                const quantity = parseInt(document.getElementById('kinhQuantity').value) || 1;
                const position = document.getElementById('kinhPosition').value.trim();

                if (!code || !type || !width || !height) {
                    alert('Vui lòng nhập đầy đủ: Mã Kính, Loại kính, Chiều rộng, Chiều cao');
                    return;
                }

                const area = (width * height / 1000000 * quantity).toFixed(4);

                const newItem = {
                    code: code,
                    type: type,
                    width_mm: width,
                    height_mm: height,
                    quantity: quantity,
                    unit: 'tấm',
                    area_m2: parseFloat(area),
                    position: position
                };

                bocTachData.kinh.push(newItem);
                renderBocTachKinhTable(bocTachData.kinh);
                closeAddKinhModal();

                alert(`Đã thêm: ${type} (${quantity} tấm, ${area} m²)`);
            }

            // Modal functions for Vật tư Phụ
            function openAddVatTuModal() {
                document.getElementById('addVatTuModal').classList.remove('hidden');
                document.getElementById('vattuCode').value = '';
                document.getElementById('vattuName').value = '';
                document.getElementById('vattuCategory').value = 'ke';
                document.getElementById('vattuUnit').value = 'cái';
                document.getElementById('vattuQuantity').value = '';
                document.getElementById('vattuNotes').value = '';
            }

            function closeAddVatTuModal() {
                document.getElementById('addVatTuModal').classList.add('hidden');
            }

            function saveNewVatTu() {
                const code = document.getElementById('vattuCode').value.trim();
                const name = document.getElementById('vattuName').value.trim();
                const category = document.getElementById('vattuCategory').value;
                const unit = document.getElementById('vattuUnit').value.trim() || 'cái';
                const quantity = parseInt(document.getElementById('vattuQuantity').value) || 0;
                const notes = document.getElementById('vattuNotes').value.trim();

                if (!code || !name || !quantity) {
                    alert('Vui lòng nhập đầy đủ: Mã vật tư, Tên vật tư, Số lượng');
                    return;
                }

                const newItem = {
                    code: code,
                    name: name,
                    category: category,
                    unit: unit,
                    quantity: quantity,
                    notes: notes
                };

                bocTachData.vattu.push(newItem);
                renderBocTachVatTuTable(bocTachData.vattu);
                closeAddVatTuModal();

                alert(`Đã thêm: ${name} (${quantity} ${unit})`);
            }




            // ========================================
            // AUTO-RESIZE FUNCTIONS FOR INPUTS & TEXTAREAS
            // ========================================

            // Auto-resize textarea based on content
            function autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
            }

            // Auto-resize input width based on content
            function autoResizeInput(input) {
                // Create a temporary span to measure text width
                const span = document.createElement('span');
                span.style.visibility = 'hidden';
                span.style.position = 'absolute';
                span.style.whiteSpace = 'pre';
                span.style.font = window.getComputedStyle(input).font;
                span.textContent = input.value || input.placeholder || '';
                document.body.appendChild(span);

                const minWidth = 60; // Minimum width in pixels
                const padding = 24; // Extra padding
                const newWidth = Math.max(minWidth, span.offsetWidth + padding);
                input.style.width = newWidth + 'px';

                document.body.removeChild(span);
            }

            // ========================================
            // PRODUCT EDIT FUNCTIONS
            // ========================================
            let quotationItemsForDesign = []; // Global variable for items

            function refreshProductList() {
                if (currentProject && currentProject.id) {
                    loadQuotationItemsForDesign(currentProject.id);
                } else {
                    console.warn('No current project to refresh');
                }
            }

            function openEditProductModal(itemId) {
                // Find the item in quotationItemsForDesign
                const item = quotationItemsForDesign.find(i =>
                    i.quotation_item_id === itemId || i.id === itemId
                );
                if (!item) {
                    console.error('Item not found:', itemId);
                    return;
                }

                // Find the row for the item
                const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
                if (!row) {
                    console.error('Row not found for itemId:', itemId);
                    return;
                }

                // Get current STT (index or fallback to 1)
                const stt = row.children[0]?.textContent?.trim() || '1';

                // Highlight the row being edited
                row.className = 'bg-yellow-50 border-2 border-yellow-300';

                // Build editable row HTML
                const editableRow = [
                    `<td class="px-2 py-3 text-center text-sm text-gray-600">${stt}</td>`,
                    `<td class="px-2 py-3 text-center">
                            <input type="text" id="edit_symbol_${itemId}" value="${item.product_code || ''}"
                                placeholder="Ký hiệu"
                                class="w-full min-w-[60px] px-2 py-1 border border-gray-300 rounded text-center text-sm focus:ring-2 focus:ring-yellow-500"
                                oninput="autoResizeInput(this)">
                        </td>`,
                    `<td class="px-3 py-3">
                            <textarea id="edit_name_${itemId}" rows="2"
                                class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-yellow-500 resize-none"
                                oninput="autoResizeTextarea(this)">${item.item_name || ''}</textarea>
                        </td>`,
                    `<td class="px-2 py-3 text-center">
                            <input type="text" id="edit_color_${itemId}" value="${item.color || ''}"
                                placeholder="Màu nhôm"
                                class="w-full min-w-[60px] px-2 py-1 border border-gray-300 rounded text-center text-sm focus:ring-2 focus:ring-yellow-500"
                                oninput="autoResizeInput(this)">
                        </td>`,
                    `<td class="px-2 py-3 text-center">
                            <input type="text" id="edit_glass_${itemId}" value="${item.glass_type || ''}"
                                placeholder="Loại kính"
                                class="w-full min-w-[60px] px-2 py-1 border border-gray-300 rounded text-center text-sm focus:ring-2 focus:ring-yellow-500"
                                oninput="autoResizeInput(this)">
                        </td>`,
                    `<td class="px-2 py-3 text-center">
                            <input type="text" id="edit_accessories_${itemId}" value="${item.accessories || ''}"
                                placeholder="Phụ kiện"
                                class="w-full min-w-[60px] px-2 py-1 border border-gray-300 rounded text-center text-sm focus:ring-2 focus:ring-yellow-500"
                                oninput="autoResizeInput(this)">
                        </td>`,
                    `<td class="px-2 py-3 text-center">
                            <input type="text" id="edit_system_${itemId}" value="${item.aluminum_system || ''}"
                                placeholder="Hệ nhôm"
                                class="w-full min-w-[60px] px-2 py-1 border border-gray-300 rounded text-center text-sm focus:ring-2 focus:ring-yellow-500"
                                oninput="autoResizeInput(this)">
                        </td>`,
                    `<td class="px-2 py-3 text-center">
                            <input type="number" id="edit_quantity_${itemId}" value="${item.quantity || 1}" min="1"
                                class="w-16 px-2 py-1 border border-gray-300 rounded text-center focus:ring-2 focus:ring-yellow-500">
                        </td>`,
                    `<td class="px-2 py-3">
                            <input type="text" id="edit_location_${itemId}" value="${item.location || ''}"
                                placeholder="Vị trí"
                                class="w-full min-w-[60px] px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-yellow-500"
                                oninput="autoResizeInput(this)">
                        </td>`,
                    `<td class="px-2 py-3 text-center whitespace-nowrap">
                            <button onclick="saveEditProduct(${itemId})" 
                                class="text-green-600 hover:text-green-800 mr-1" title="Lưu">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                        d="M5 13l4 4L19 7" />
                                </svg>
                            </button>
                            <button onclick="cancelEditProduct(${itemId})" 
                                class="text-red-600 hover:text-red-800" title="Hủy">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                        d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </td>`
                ].join('\n');

                row.innerHTML = editableRow;

                // Focus on first input
                const firstInput = document.getElementById(`edit_symbol_${itemId}`);
                if (firstInput) firstInput.focus();
            }

            function cancelEditProduct(itemId) {
                // Refresh the list to restore original display
                refreshProductList();
            }

            function saveEditProduct(itemId) {
                // Read values from all inputs
                const symbolInput = document.getElementById(`edit_symbol_${itemId}`);
                const nameInput = document.getElementById(`edit_name_${itemId}`);
                const colorInput = document.getElementById(`edit_color_${itemId}`);
                const glassInput = document.getElementById(`edit_glass_${itemId}`);
                const accessoriesInput = document.getElementById(`edit_accessories_${itemId}`);
                const systemInput = document.getElementById(`edit_system_${itemId}`);
                const quantityInput = document.getElementById(`edit_quantity_${itemId}`);
                const locationInput = document.getElementById(`edit_location_${itemId}`);

                // Check if all inputs exist
                if (!nameInput || !quantityInput) {
                    console.error('Cannot find input elements for itemId:', itemId);
                    alert('Lỗi: Không tìm thấy các input để lưu');
                    return;
                }

                // Get values using .value (NOT textContent!)
                const symbol = symbolInput?.value?.trim() || '';
                const name = nameInput?.value?.trim() || '';
                const color = colorInput?.value?.trim() || '';
                const glass = glassInput?.value?.trim() || '';
                const accessories = accessoriesInput?.value?.trim() || '';
                const system = systemInput?.value?.trim() || '';
                const quantity = quantityInput?.value || '1';
                const location = locationInput?.value?.trim() || '';

                // Debug logging
                console.log('📝 saveEditProduct - Reading values:');
                console.log('   itemId:', itemId);
                console.log('   symbol (product_code):', symbol);
                console.log('   name (item_name):', name);
                console.log('   color:', color);
                console.log('   glass (glass_type):', glass);
                console.log('   accessories:', accessories);
                console.log('   system (aluminum_system):', system);
                console.log('   quantity:', quantity);
                console.log('   location:', location);

                const itemName = name || symbol || 'Sản phẩm';

                const dataToSend = {
                    item_name: itemName,
                    product_code: symbol,
                    color: color,
                    glass_type: glass,
                    accessories: accessories,
                    aluminum_system: system,
                    quantity: parseInt(quantity) || 1,
                    location: location
                };

                console.log('📤 Sending to API:', dataToSend);

                updateProductItem(itemId, dataToSend);
            }

            async function updateProductItem(itemId, data) {
                try {
                    console.log('🔄 updateProductItem - Calling API:', `${API_BASE}/quotations/items/${itemId}`);

                    const response = await fetch(`${API_BASE}/quotations/items/${itemId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    console.log('📥 API Response:', result);

                    if (result.success) {
                        // Update local array to match new data
                        const itemToUpdate = quotationItemsForDesign.find(item =>
                            item.quotation_item_id === itemId || item.id === itemId
                        );
                        if (itemToUpdate) {
                            console.log('🔄 Updating local array for itemId:', itemId);
                            // Cập nhật tất cả các field từ data
                            Object.assign(itemToUpdate, {
                                item_name: data.item_name,
                                product_code: data.product_code,
                                color: data.color,
                                glass_type: data.glass_type,
                                accessories: data.accessories,
                                aluminum_system: data.aluminum_system,
                                quantity: data.quantity,
                                location: data.location,
                                // Giữ lại các field khác không bị mất
                                updated_at: new Date().toISOString()
                            });

                            // Lưu quotationItemsForDesign vào sessionStorage sau khi update
                            try {
                                sessionStorage.setItem('quotationItemsForDesign', JSON.stringify(quotationItemsForDesign));
                                console.log('💾 Saved updated quotationItemsForDesign to sessionStorage');
                            } catch (e) {
                                console.warn('Could not save to sessionStorage:', e);
                            }

                            // Render lại bảng ngay lập tức với dữ liệu đã cập nhật
                            console.log('🔄 Re-rendering table with updated data');
                            renderProductCards(quotationItemsForDesign);
                            updateProductTypeSummary(quotationItemsForDesign);

                            // Đảm bảo row không còn ở chế độ edit
                            const editedRow = document.querySelector(`tr[data-item-id="${itemId}"]`);
                            if (editedRow) {
                                editedRow.className = 'hover:bg-gray-50'; // Reset về class bình thường
                            }
                        }

                        // Cập nhật địa điểm nếu đang ở step 2
                        const currentStep = parseInt(sessionStorage.getItem('currentStep') || '1');
                        if (currentStep === 2) {
                            updateProjectInfo(2);
                        }

                        // KHÔNG refresh từ server ngay lập tức sau khi update
                        // Lý do: 
                        // 1. Database có thể chưa commit transaction ngay
                        // 2. Refresh sẽ overwrite array với data từ server (có thể là data cũ)
                        // 3. Dữ liệu đã được cập nhật trong local array và render rồi
                        // 4. Khi reload trang, sẽ tự động load từ server (lúc đó data đã được lưu)
                        // 
                        // Chỉ refresh khi thực sự cần (ví dụ: khi user reload trang hoặc chuyển step)
                        console.log('✅ Update successful. Data saved to database. Will refresh on next page load.');

                        showToast('Cập nhật sản phẩm thành công!', 'success');
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể cập nhật'));
                    }
                } catch (error) {
                    console.error('❌ Error updating product:', error);
                    alert('Lỗi kết nối đến server');
                }
            }

            /**
             * Export Product List to Excel (with company logo)
             */
            async function exportProductListExcel() {
                if (!quotationItemsForDesign || quotationItemsForDesign.length === 0) {
                    alert('Chưa có sản phẩm nào để xuất Excel!');
                    return;
                }

                if (!currentProject || !currentProject.id) {
                    alert('Vui lòng chọn dự án trước!');
                    return;
                }

                try {
                    console.log('📊 Exporting product list to Excel with logo...');
                    showToast('Đang xuất Excel...', 'info');

                    const response = await fetch(`${API_BASE}/bom-export/${currentProject.id}/product-list`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            data: quotationItemsForDesign
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Lỗi khi xuất Excel');
                    }

                    // Get filename from Content-Disposition header
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'DanhSachSanPham.xlsx';
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }

                    // Download file
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = decodeURIComponent(filename);
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    showToast('Đã xuất Excel thành công!', 'success');
                } catch (error) {
                    console.error('Error exporting product list Excel:', error);
                    alert('Lỗi khi xuất Excel: ' + error.message);
                }
            }

            /**
             * Delete product item
             */
            async function deleteProductItem(itemId) {
                if (!itemId) {
                    console.error('❌ deleteProductItem: itemId is required');
                    return;
                }

                // Tìm item trong danh sách để hiển thị tên
                const item = quotationItemsForDesign.find(i =>
                    i.quotation_item_id === itemId || i.id === itemId
                );

                const itemName = item ? (item.item_name || item.product_code || 'sản phẩm này') : 'sản phẩm này';

                // Xác nhận xóa
                if (!confirm(`Bạn có chắc muốn xóa "${itemName}"?\n\nHành động này không thể hoàn tác.`)) {
                    return;
                }

                try {
                    console.log('🗑️ Deleting product item:', itemId);

                    // Gọi API để xóa
                    const response = await fetch(`${API_BASE}/quotations/items/${itemId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const result = await response.json();
                    console.log('📥 Delete API Response:', result);

                    if (result.success) {
                        // Xóa khỏi local array
                        const itemIndex = quotationItemsForDesign.findIndex(i =>
                            i.quotation_item_id === itemId || i.id === itemId
                        );

                        if (itemIndex !== -1) {
                            quotationItemsForDesign.splice(itemIndex, 1);
                            console.log('✅ Removed item from local array. Remaining items:', quotationItemsForDesign.length);
                        }

                        // Re-render table
                        renderProductCards(quotationItemsForDesign);
                        updateProductTypeSummary(quotationItemsForDesign);

                        // Cập nhật project info nếu đang ở step 2
                        const currentStep = parseInt(sessionStorage.getItem('currentStep') || '1');
                        if (currentStep === 2) {
                            updateProjectInfo(2);
                        }

                        showToast('Đã xóa sản phẩm thành công!', 'success');
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể xóa sản phẩm'));
                    }
                } catch (error) {
                    console.error('❌ Error deleting product:', error);
                    alert('Lỗi kết nối đến server');
                }
            }

            // Toast notification helper
            function showToast(message, type = 'info') {
                const existingToast = document.querySelector('.toast-notification');
                if (existingToast) existingToast.remove();

                const toast = document.createElement('div');
                toast.className = `toast-notification fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-500' :
                    type === 'error' ? 'bg-red-500' :
                        'bg-blue-500'
                    }`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.5s';
                    setTimeout(() => toast.remove(), 500);
                }, 3000);
            }

        </script>
    </div> <!-- End main-content -->
    <script src="js/sidebar-enterprise.js"></script>
    <script src="js/success-notification.js"></script>
    <script src="js/notification-system.js"></script>
    <script src="js/notification-header.js"></script>
</body>

</html>