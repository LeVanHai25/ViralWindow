<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công nợ - ViralWindow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="finance-styles.css">
    <script src="finance-date-range-picker.js"></script>
    <style>
        /* Modern gradient background - đồng bộ với phần mềm */
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        /* Modern header with gradient */
        .header-gradient {
            background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1000;
        }

        /* KPI cards modern */
        .kpi-card-modern {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            padding: 1.5rem;
        }

        .kpi-card-modern:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        /* Filter bar modern */
        .filter-bar-modern {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        /* Table modern */
        .table-modern {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .table-modern thead {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .table-modern tbody tr {
            transition: all 0.2s ease;
        }

        .table-modern tbody tr:hover {
            background: #f8fafc;
        }

        /* Tab buttons */
        .tab-btn {
            transition: all 0.3s ease;
            border-radius: 8px;
            font-weight: 500;
        }

        .tab-btn.active {
            background: white;
            color: #3b82f6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Button modern */
        .btn-modern {
            transition: all 0.3s ease;
            border-radius: 8px;
            font-weight: 500;
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Modal modern */
        .modal-modern {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        /* Fade in animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            opacity: 0;
            animation: fadeIn 0.5s ease-out forwards;
        }

        .icon-square {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="bg-white shadow p-5 flex justify-between items-center header-gradient backdrop-blur-sm" style="position: relative; z-index: 1000;">
        <div class="flex items-center gap-4">
            <a href="javascript:void(0)" onclick="history.back()" title="Quay lại trang trước" class="icon-square bg-white text-blue-600 overflow-hidden rounded-lg shadow-md hover:shadow-lg transition-all duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </a>
            <div>
                <h1 class="text-2xl font-bold text-white">Công nợ</h1>
                <p class="text-blue-100 text-sm">Quản lý công nợ khách hàng và nhà cung cấp</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="switchDebtType('receivable')" class="px-6 py-2.5 bg-white bg-opacity-20 text-white rounded-lg font-medium hover:bg-opacity-30 transition-all tab-btn active" id="btnReceivable">
                Phải thu
            </button>
            <button onclick="switchDebtType('payable')" class="px-6 py-2.5 bg-white bg-opacity-20 text-white rounded-lg font-medium hover:bg-opacity-30 transition-all tab-btn" id="btnPayable">
                Phải trả
            </button>
        </div>
    </div>

    <div class="p-6">
        <!-- STATISTICS -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6" id="debtStats">
            <!-- Stats will be loaded here -->
        </div>

        <!-- FILTERS -->
        <div class="filter-bar-modern p-5 mb-6 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Khách hàng/NCC</label>
                    <select id="filterCustomer" class="form-select w-full" onchange="loadDebts()">
                        <option value="">Tất cả</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Dự án</label>
                    <select id="filterProject" class="form-select w-full" onchange="loadDebts()">
                        <option value="">Tất cả</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái</label>
                    <select id="filterStatus" class="form-select w-full" onchange="loadDebts()">
                        <option value="">Tất cả</option>
                        <option value="pending">Chờ thanh toán</option>
                        <option value="partial">Thanh toán một phần</option>
                        <option value="paid">Đã thanh toán</option>
                        <option value="overdue">Quá hạn</option>
                    </select>
                </div>
                <div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="filterOverdue" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" onchange="loadDebts()">
                        <span class="text-sm font-medium text-gray-700">Chỉ quá hạn</span>
                    </label>
                </div>
                <div>
                    <button onclick="resetFilters()" class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-all btn-modern">
                        Xóa bộ lọc
                    </button>
                </div>
            </div>
        </div>

        <!-- TABLE -->
        <div class="table-modern fade-in" style="animation-delay: 0.1s;">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr id="debtTableHeader">
                            <!-- Header will be set based on debt type -->
                        </tr>
                    </thead>
                    <tbody id="debtsTable" class="divide-y divide-gray-100">
                        <tr>
                            <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <p>Đang tải dữ liệu...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL: Debt Detail -->
    <div id="debtDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"
        style="z-index: 9999;">
        <div class="modal-modern w-full max-w-3xl max-h-[90vh] overflow-y-auto" style="z-index: 10000;">
            <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-blue-600 px-6 py-4 flex items-center justify-between rounded-t-2xl">
                <h2 class="text-xl font-bold text-white" id="debtDetailTitle">Chi tiết công nợ</h2>
                <button onclick="closeDebtDetailModal()" class="text-white hover:text-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div id="debtDetailContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Record Payment -->
    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"
        style="z-index: 9999;">
        <div class="modal-modern w-full max-w-md" style="z-index: 10000;">
            <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-blue-600 px-6 py-4 flex items-center justify-between rounded-t-2xl">
                <h2 class="text-xl font-bold text-white">Ghi nhận thanh toán</h2>
                <button onclick="closePaymentModal()" class="text-white hover:text-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="paymentForm" onsubmit="recordPayment(event)">
                <div class="p-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Số tiền thanh toán <span class="text-red-500">*</span></label>
                        <input type="number" id="paymentAmount" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" step="1000" min="0" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ngày thanh toán <span class="text-red-500">*</span></label>
                        <input type="date" id="paymentDate" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phương thức thanh toán</label>
                        <select id="paymentMethod" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="cash">Tiền mặt</option>
                            <option value="bank_transfer">Chuyển khoản</option>
                            <option value="check">Séc</option>
                            <option value="other">Khác</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ghi chú</label>
                        <textarea id="paymentNotes" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" rows="3"></textarea>
                    </div>
                </div>
                <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
                    <button type="button" onclick="closePaymentModal()" class="px-6 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-all btn-modern">
                        Hủy
                    </button>
                    <button type="submit" class="px-6 py-2.5 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg font-semibold hover:from-green-700 hover:to-green-800 transition-all btn-modern shadow-md">
                        Ghi nhận
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="finance-common.js"></script>
    <script>
        let currentDebtType = 'receivable';
        let currentDebtId = null;

        // Switch debt type
        function switchDebtType(type) {
            currentDebtType = type;
            const btnReceivable = document.getElementById('btnReceivable');
            const btnPayable = document.getElementById('btnPayable');
            
            if (type === 'receivable') {
                btnReceivable.classList.add('active');
                btnPayable.classList.remove('active');
            } else {
                btnReceivable.classList.remove('active');
                btnPayable.classList.add('active');
            }
            
            loadDebts();
            loadDebtStatistics();
        }

        // Load debts
        async function loadDebts() {
            try {
                const params = new URLSearchParams();
                params.append('type', currentDebtType);
                
                const customerId = document.getElementById('filterCustomer').value;
                const projectId = document.getElementById('filterProject').value;
                const status = document.getElementById('filterStatus').value;
                const overdueOnly = document.getElementById('filterOverdue').checked;

                if (customerId) params.append('customerId', customerId);
                if (projectId) params.append('projectId', projectId);
                if (status) params.append('status', status);
                if (overdueOnly) params.append('overdue', 'true');

                const token = localStorage.getItem('token');
                const res = await fetch(`${API_BASE}/debts?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                // Update table header
                const header = document.getElementById('debtTableHeader');
                if (currentDebtType === 'receivable') {
                    header.innerHTML = `
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Khách hàng</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Dự án</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Giá trị HĐ</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Đã thu</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Còn phải thu</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Hạn thanh toán</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Trạng thái</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Thao tác</th>
                    `;
                } else {
                    header.innerHTML = `
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Nhà cung cấp</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Dự án</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tổng mua</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Đã trả</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Còn nợ</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Hạn thanh toán</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Trạng thái</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Thao tác</th>
                    `;
                }

                const tbody = document.getElementById('debtsTable');
                if (!data.success || !data.data || data.data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <p class="text-lg font-medium">Chưa có công nợ nào</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = data.data.map(debt => {
                    const isOverdue = debt.due_date && new Date(debt.due_date) < new Date() && debt.status !== 'paid';
                    const status = isOverdue ? 'overdue' : (debt.status || 'pending');
                    
                    return `
                        <tr class="hover:bg-gray-50 ${isOverdue ? 'bg-red-50' : ''}" onclick="viewDebtDetail(${debt.id})" style="cursor: pointer;">
                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${escapeHtml(currentDebtType === 'receivable' ? (debt.customer_name || 'N/A') : (debt.supplier || 'N/A'))}</td>
                            <td class="px-6 py-4 text-sm text-gray-700">${escapeHtml(debt.project_name || 'N/A')}</td>
                            <td class="px-6 py-4 text-sm font-semibold text-gray-900">${formatCurrency(debt.total_amount)}</td>
                            <td class="px-6 py-4 text-sm text-green-600">${formatCurrency(debt.paid_amount || 0)}</td>
                            <td class="px-6 py-4 text-sm font-semibold ${isOverdue ? 'text-red-600' : 'text-orange-600'}">${formatCurrency(debt.remaining_amount || 0)}</td>
                            <td class="px-6 py-4 text-sm text-gray-700">${debt.due_date ? formatDate(debt.due_date) : 'N/A'}</td>
                            <td class="px-6 py-4">${getStatusBadge(status)}</td>
                            <td class="px-6 py-4" onclick="event.stopPropagation()">
                                <div class="flex items-center gap-2">
                                    <button onclick="viewDebtDetail(${debt.id})" class="px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                                        Xem
                                    </button>
                                    ${status !== 'paid' ? `
                                        <button onclick="openPaymentModal(${debt.id})" class="px-3 py-1.5 text-xs font-medium text-green-600 bg-green-50 rounded-lg hover:bg-green-100 transition-colors">
                                            Thanh toán
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading debts:', error);
                document.getElementById('debtsTable').innerHTML = '<tr><td colspan="8" class="text-center py-8 text-red-500">Lỗi khi tải dữ liệu</td></tr>';
            }
        }

        // Load debt statistics
        async function loadDebtStatistics() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_BASE}/debts/statistics`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.success) {
                    const stats = data.data;
                    const statsEl = document.getElementById('debtStats');
                    
                    if (currentDebtType === 'receivable') {
                        statsEl.innerHTML = `
                            <div class="kpi-card-modern fade-in">
                                <div class="text-sm text-gray-500 mb-2">Tổng phải thu</div>
                                <div class="text-2xl font-bold text-blue-600">${formatCurrency(stats.receivable?.total_amount || 0)}</div>
                            </div>
                            <div class="kpi-card-modern fade-in" style="animation-delay: 0.1s;">
                                <div class="text-sm text-gray-500 mb-2">Đã thu</div>
                                <div class="text-2xl font-bold text-green-600">${formatCurrency(stats.receivable?.paid_amount || 0)}</div>
                            </div>
                            <div class="kpi-card-modern fade-in" style="animation-delay: 0.2s;">
                                <div class="text-sm text-gray-500 mb-2">Còn phải thu</div>
                                <div class="text-2xl font-bold text-orange-600">${formatCurrency(stats.receivable?.remaining_amount || 0)}</div>
                            </div>
                            <div class="kpi-card-modern fade-in" style="animation-delay: 0.3s;">
                                <div class="text-sm text-gray-500 mb-2">Quá hạn</div>
                                <div class="text-2xl font-bold text-red-600">${formatCurrency(stats.overdue?.total_amount || 0)}</div>
                            </div>
                        `;
                    } else {
                        statsEl.innerHTML = `
                            <div class="kpi-card-modern fade-in">
                                <div class="text-sm text-gray-500 mb-2">Tổng phải trả</div>
                                <div class="text-2xl font-bold text-blue-600">${formatCurrency(stats.payable?.total_amount || 0)}</div>
                            </div>
                            <div class="kpi-card-modern fade-in" style="animation-delay: 0.1s;">
                                <div class="text-sm text-gray-500 mb-2">Đã trả</div>
                                <div class="text-2xl font-bold text-green-600">${formatCurrency(stats.payable?.paid_amount || 0)}</div>
                            </div>
                            <div class="kpi-card-modern fade-in" style="animation-delay: 0.2s;">
                                <div class="text-sm text-gray-500 mb-2">Còn phải trả</div>
                                <div class="text-2xl font-bold text-orange-600">${formatCurrency(stats.payable?.remaining_amount || 0)}</div>
                            </div>
                            <div class="kpi-card-modern fade-in" style="animation-delay: 0.3s;">
                                <div class="text-sm text-gray-500 mb-2">Quá hạn</div>
                                <div class="text-2xl font-bold text-red-600">${formatCurrency(stats.overdue?.total_amount || 0)}</div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading debt statistics:', error);
            }
        }

        // View debt detail
        async function viewDebtDetail(id) {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_BASE}/debts/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.success) {
                    const debt = data.data;
                    const content = document.getElementById('debtDetailContent');
                    
                    content.innerHTML = `
                        <div class="grid grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">${currentDebtType === 'receivable' ? 'Khách hàng' : 'Nhà cung cấp'}</label>
                                <p class="text-lg font-semibold text-gray-900">${escapeHtml(currentDebtType === 'receivable' ? (debt.customer_name || 'N/A') : (debt.supplier || 'N/A'))}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Dự án</label>
                                <p class="text-lg font-semibold text-gray-900">${escapeHtml(debt.project_name || 'N/A')}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Tổng tiền</label>
                                <p class="text-lg font-semibold text-gray-900">${formatCurrency(debt.total_amount)}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Đã ${currentDebtType === 'receivable' ? 'thu' : 'trả'}</label>
                                <p class="text-lg font-semibold text-green-600">${formatCurrency(debt.paid_amount || 0)}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Còn ${currentDebtType === 'receivable' ? 'phải thu' : 'nợ'}</label>
                                <p class="text-lg font-semibold text-orange-600">${formatCurrency(debt.remaining_amount || 0)}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500 mb-2">Hạn thanh toán</label>
                                <p class="text-lg font-semibold text-gray-900">${debt.due_date ? formatDate(debt.due_date) : 'N/A'}</p>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Timeline thanh toán</h3>
                            <div id="paymentTimeline" class="space-y-3">
                                <p class="text-sm text-gray-500">Chưa có lịch sử thanh toán</p>
                            </div>
                        </div>
                    `;
                    
                    // Load payment timeline
                    // TODO: Load payment history from API
                    
                    document.getElementById('debtDetailModal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading debt detail:', error);
                showAlert('Lỗi khi tải chi tiết công nợ');
            }
        }

        // Close debt detail modal
        function closeDebtDetailModal() {
            document.getElementById('debtDetailModal').classList.add('hidden');
        }

        // Open payment modal
        function openPaymentModal(debtId) {
            currentDebtId = debtId;
            document.getElementById('paymentModal').classList.remove('hidden');
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
        }

        // Close payment modal
        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            resetForm(document.getElementById('paymentForm'));
            currentDebtId = null;
        }

        // Record payment
        async function recordPayment(event) {
            event.preventDefault();
            
            const data = {
                payment_amount: parseFloat(document.getElementById('paymentAmount').value),
                payment_date: document.getElementById('paymentDate').value,
                payment_method: document.getElementById('paymentMethod').value,
                notes: document.getElementById('paymentNotes').value || null
            };

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_BASE}/debts/${currentDebtId}/payment`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                if (result.success) {
                    showAlert('Ghi nhận thanh toán thành công!');
                    closePaymentModal();
                    loadDebts();
                    loadDebtStatistics();
                } else {
                    showAlert('Lỗi: ' + (result.message || 'Không thể ghi nhận thanh toán'));
                }
            } catch (error) {
                console.error('Error recording payment:', error);
                showAlert('Lỗi kết nối server');
            }
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('filterCustomer').value = '';
            document.getElementById('filterProject').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterOverdue').checked = false;
            loadDebts();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            switchDebtType('receivable');
            loadCustomers(document.getElementById('filterCustomer'));
            loadProjects(document.getElementById('filterProject'));
        });
    </script>
</body>
</html>

