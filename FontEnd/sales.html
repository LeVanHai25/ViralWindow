<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khách hàng - Hệ thống quản lý cửa nhôm kính</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/sidebar-enterprise.css">
    <link rel="stylesheet" href="css/success-notification.css">
    <link rel="stylesheet" href="css/notification-system.css">
    <link rel="stylesheet" href="css/notification-header.css">
    <script src="js/success-notification.js"></script>
    <script src="js/notification-system.js"></script>
    <script src="js/notification-header.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            z-index: 1000;
        }

        .main-content {
            margin-left: 280px;
            background: #f3f4f6;
            min-height: 100vh;
        }


        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-button {
            transition: all 0.3s ease;
        }

        .tab-button.active {
            border-bottom: 3px solid #3B82F6;
            color: #3B82F6;
            font-weight: 600;
        }

        .customer-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .customer-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .quotation-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .quotation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* ====== PROJECT TAB STYLES (from projects.html) ====== */

        /* Enhanced KPI cards with gradients */
        .kpi-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .kpi-card:hover::before {
            transform: scaleX(1);
        }

        .kpi-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .kpi-card-blue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .kpi-card-yellow {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .kpi-card-orange {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .kpi-card-green {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        /* Enhanced project cards */
        .project-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.05);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

        .project-card:hover {
            transform: translateY(-8px) scale(1.01);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .project-card.hidden {
            display: none;
        }

        /* Enhanced action buttons */
        .action-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .action-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        /* Enhanced progress bar */
        .progress-bar {
            height: 10px;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Enhanced workflow steps */
        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            position: relative;
        }

        .workflow-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 16px;
            left: 60%;
            width: 100%;
            height: 2px;
            background: #e5e7eb;
            z-index: 0;
        }

        .workflow-step-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .workflow-step-circle.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .workflow-step-circle.inactive {
            background: #e5e7eb;
            color: #9ca3af;
        }

        /* Enhanced status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        /* Modern search section */
        .search-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* Icon square enhancement */
        .icon-square {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .kpi-card:hover .icon-square {
            transform: scale(1.1) rotate(5deg);
        }
    </style>
</head>

<body>

    <!-- Header Notification (Top Right) -->
    <div class="header-notification-container">
        <button id="headerNotificationButton" class="header-notification-button" onclick="toggleHeaderNotifications()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <span id="headerNotificationBadge" class="header-notification-badge hidden">0</span>
        </button>

        <div id="headerNotificationsDropdown" class="header-notifications-dropdown">
            <div class="header-notifications-header">
                <h3>Thông báo</h3>
            </div>
            <div id="headerNotificationsList" class="header-notifications-list">
                <!-- Notifications will be loaded here -->
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar text-white">
        <!-- Logo -->
        <a href="settings.html" class="sidebar-logo block">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-400 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0"
                    id="companyLogoContainer">
                    <img id="companyLogo" src="" alt="Logo" class="hidden w-full h-full object-contain">
                    <svg id="companyLogoIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" class="w-6 h-6 text-white">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <span class="text-xl font-bold" id="companyName">ViralWindow</span>
            </div>
        </a>

        <!-- User Profile -->
        <div class="p-4 border-b border-blue-600 relative">
            <div class="flex items-center gap-3 cursor-pointer hover:bg-blue-700 rounded-lg p-2"
                onclick="toggleSidebarUserMenu()">
                <div class="w-10 h-10 bg-blue-400 rounded-full flex items-center justify-center font-semibold overflow-hidden"
                    id="sidebarUserAvatar">
                    <div id="sidebarUserAvatarInitial">U</div>
                    <img id="sidebarUserAvatarImage" src="" alt="Avatar"
                        class="hidden w-full h-full object-cover rounded-full">
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-sm" id="sidebarUserName">Lê Văn Hải</div>
                    <div class="text-xs text-blue-200">Quản lý</div>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <!-- User Menu Dropdown -->
            <div id="sidebarUserMenuDropdown"
                class="hidden absolute left-0 right-0 mt-2 bg-white rounded-lg shadow-xl z-[9999] border border-gray-200">
                <div class="p-2">
                    <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">Hồ
                        sơ</a>
                    <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">Cài
                        đặt</a>
                    <hr class="my-2">
                    <button onclick="handleLogout()"
                        class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 rounded">Đăng
                        xuất</button>
                </div>
            </div>
        </div>



        <!-- Navigation Menu -->
        <nav class="sidebar-nav">
            <!-- TỔNG QUAN -->
            <a href="index.html" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span>TỔNG QUAN</span>
            </a>

            <!-- KINH DOANH -->
            <div class="nav-item has-submenu expanded">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span>KINH DOANH</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu expanded">
                <a href="sales.html" class="submenu-item active">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span>Khách hàng & Dự án</span>
                </a>
                <a href="quotation-new.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Báo giá</span>
                </a>
            </div>

            <!-- KỸ THUẬT -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>KỸ THUẬT</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="design-new.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                    <span>Thiết kế & Bóc tách</span>
                </a>
            </div>

            <!-- SẢN XUẤT -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                    </svg>
                    <span>SẢN XUẤT</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="production.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                    <span>Quy trình sản xuất</span>
                </a>
                <a href="production-management.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Lệnh sản xuất</span>
                </a>
            </div>

            <!-- KHO & VẬT TƯ -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    <span>KHO & VẬT TƯ</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="inventory.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    <span>Kho vật tư</span>
                </a>
                <a href="exported-materials.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                    <span>Xuất vật tư</span>
                </a>
            </div>

            <!-- THI CÔNG & NGHIỆM THU -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>THI CÔNG & NGHIỆM THU</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="installation.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>Lắp đặt</span>
                </a>
                <a href="handover.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    <span>Bàn giao</span>
                </a>
            </div>

            <!-- TÀI CHÍNH -->
            <div class="nav-item has-submenu">
                <div class="flex items-center gap-3 flex-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>TÀI CHÍNH</span>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-4 h-4 transition-transform duration-200 arrow-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div class="submenu">
                <a href="finance-dashboard.html" class="submenu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span>Tài chính</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <!-- Top Header Bar -->
        <div class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-semibold text-gray-800">Khách hàng & Dự án</h1>
        </div>

        <!-- TABS NAVIGATION -->
        <div class="bg-white border-b border-gray-200 px-6">
            <div class="flex gap-8">
                <button class="tab-button px-4 py-4 flex items-center gap-2 text-gray-600 hover:text-blue-600 active"
                    onclick="switchTab('customers', this)">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Quản lý Khách hàng
                </button>
                <button class="tab-button px-4 py-4 flex items-center gap-2 text-gray-600 hover:text-blue-600"
                    onclick="switchTab('projects', this)">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    Quản lý Dự án
                </button>
            </div>
        </div>

        <!-- TAB: QUẢN LÝ KHÁCH HÀNG -->
        <div id="tab-customers" class="tab-content active">
            <div class="p-6">
                <div class="bg-white rounded-xl shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Danh sách Khách hàng</h2>
                        <div class="flex gap-4">
                            <input type="text" id="searchCustomer" placeholder="Tìm kiếm khách hàng..."
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                onkeyup="searchCustomers()">
                            <button
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 hover:bg-blue-700"
                                onclick="openCustomerModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Thêm khách hàng
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="customersList">
                        <!-- Customer cards will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: QUẢN LÝ DỰ ÁN -->
        <div id="tab-projects" class="tab-content" style="display: none;">
            <!-- KPI SUMMARY SECTION -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 p-6 fade-in">
                <div
                    class="kpi-card kpi-card-blue shadow-lg rounded-2xl p-6 flex items-center justify-between text-white">
                    <div>
                        <p class="text-white text-opacity-80 text-sm mb-2 font-medium">Dự án đang chạy</p>
                        <p class="text-4xl font-bold" data-projects-kpi="running">0</p>
                    </div>
                    <div class="icon-square bg-white bg-opacity-20 backdrop-blur-sm text-white rounded-xl p-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-8 h-8">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                </div>

                <a href="pending-quotations.html"
                    class="kpi-card kpi-card-yellow shadow-lg rounded-2xl p-6 flex items-center justify-between cursor-pointer text-white">
                    <div>
                        <p class="text-white text-opacity-80 text-sm mb-2 font-medium">Báo giá chờ duyệt</p>
                        <p class="text-4xl font-bold" data-projects-kpi="pending">0</p>
                    </div>
                    <div class="icon-square bg-white bg-opacity-20 backdrop-blur-sm text-white rounded-xl p-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-8 h-8">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </a>

                <a href="production.html"
                    class="kpi-card kpi-card-orange shadow-lg rounded-2xl p-6 flex items-center justify-between cursor-pointer text-white">
                    <div>
                        <p class="text-white text-opacity-80 text-sm mb-2 font-medium">Lệnh sản xuất</p>
                        <p class="text-4xl font-bold" data-projects-kpi="production">0</p>
                    </div>
                    <div class="icon-square bg-white bg-opacity-20 backdrop-blur-sm text-white rounded-xl p-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-8 h-8">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                </a>

                <a href="completed-projects.html"
                    class="kpi-card kpi-card-green shadow-lg rounded-2xl p-6 flex items-center justify-between cursor-pointer text-white">
                    <div>
                        <p class="text-white text-opacity-80 text-sm mb-2 font-medium">Dự án đã hoàn thành</p>
                        <p class="text-4xl font-bold" data-projects-kpi="completed">0</p>
                    </div>
                    <div class="icon-square bg-white bg-opacity-20 backdrop-blur-sm text-white rounded-xl p-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-8 h-8">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </a>
            </div>

            <!-- SEARCH AND FILTER SECTION -->
            <div class="px-6 mb-6 fade-in">
                <div class="search-section rounded-2xl p-5 flex flex-wrap items-center gap-4">
                    <!-- Search Bar -->
                    <div class="flex-1 min-w-[300px] relative">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-5 h-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <input type="text" data-projects-search="input"
                            placeholder="Tìm theo tên công trình, khách hàng, SĐT, mã CT..."
                            class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300"
                            onkeyup="filterProjectsInTab()">
                    </div>

                    <!-- Filter Dropdowns -->
                    <select data-projects-filter="status"
                        class="px-5 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 font-medium"
                        onchange="filterProjectsInTab()">
                        <option value="all">Tất cả trạng thái</option>
                        <option value="approved">Đã duyệt</option>
                        <option value="pending">Chờ duyệt</option>
                        <option value="not-created">Chưa tạo báo giá</option>
                    </select>

                    <select data-projects-filter="progress"
                        class="px-5 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 font-medium"
                        onchange="filterProjectsInTab()">
                        <option value="all">Tất cả tiến độ</option>
                        <option value="0-25">0-25%</option>
                        <option value="25-50">25-50%</option>
                        <option value="50-75">50-75%</option>
                        <option value="75-100">75-100%</option>
                    </select>

                    <!-- Create New Project Button -->
                    <button onclick="openProjectModal()"
                        class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold flex items-center gap-2 hover:from-blue-700 hover:to-purple-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Tạo dự án mới
                    </button>
                </div>
            </div>

            <!-- PROJECTS LIST SECTION -->
            <div class="px-6 pb-6 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 data-projects-heading class="text-2xl font-bold text-gray-800">Dự án đang triển khai <span
                            class="text-blue-600">(0)</span></h2>
                </div>

                <!-- Projects Container - Will be populated dynamically -->
                <div data-projects-list class="space-y-4">
                    <p class="text-center text-gray-500 py-8">Đang tải dữ liệu...</p>
                </div>
            </div>
        </div>


        <!-- MODAL: Add Customer -->
        <div id="customerModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold" id="customerModalTitle">Thêm khách hàng mới</h2>
                    <button onclick="closeCustomerModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <form id="customerForm" onsubmit="saveCustomer(event)">
                    <div class="space-y-4">
                        <!-- Customer Code Field -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Mã khách hàng
                                <span class="text-gray-400 text-xs ml-1">(có thể để trống để tự tạo)</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="customerCode"
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                                    placeholder="Ví dụ: KH-001 hoặc để trống">
                                <button type="button" onclick="generateCustomerCode()"
                                    class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-1"
                                    title="Tạo mã tự động">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor" class="w-4 h-4">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                    Tự tạo
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Tên khách hàng <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="customerName" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Số điện thoại <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" id="customerPhone" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <p id="phoneError" class="hidden mt-1 text-sm text-orange-600 flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                Vui lòng điền vào trường này.
                            </p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="customerEmail"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Địa chỉ</label>
                            <textarea id="customerAddress" rows="3"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" onclick="closeCustomerModal()"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium hover:bg-gray-50">
                            Hủy
                        </button>
                        <button type="submit"
                            class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700">
                            Thêm mới
                        </button>
                    </div>
                    <input type="hidden" id="customerId">
                </form>
            </div>
        </div>

        <!-- MODAL: Calculate from BOM -->
        <div id="calculateBOMModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Tính giá từ BOM</h2>
                    <button onclick="closeCalculateBOMModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="p-6">
                    <!-- Step 1: Chọn dự án -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chọn dự án</label>
                        <select id="bomProjectSelect" onchange="loadDoorsForBOM()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Chọn dự án --</option>
                        </select>
                    </div>

                    <!-- Step 2: Chọn cửa -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chọn cửa (có thể chọn nhiều)</label>
                        <div id="bomDoorsList" class="border border-gray-300 rounded-lg p-4 max-h-60 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Vui lòng chọn dự án trước</p>
                        </div>
                    </div>

                    <!-- Step 3: Nhập giá -->
                    <div class="mb-6 bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-4">Giá vật tư</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Giá kính (₫/m²)</label>
                                <input type="number" id="glassPricePerM2" value="500000" step="10000"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Giá nhôm (₫/kg)</label>
                                <input type="number" id="aluminumPricePerKg" value="80000" step="1000"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Công lắp đặt (₫/m²)</label>
                                <input type="number" id="installationCostPerM2" value="200000" step="10000"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hoặc cố định (₫/cửa)</label>
                                <input type="number" id="installationCostFixed" value="0" step="10000"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3">
                        <button onclick="closeCalculateBOMModal()"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Hủy
                        </button>
                        <button onclick="calculateQuotationFromBOM()"
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            Tính toán
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Customer CRM -->
        <div id="customerCRMModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900" id="crmCustomerName">Thông tin CRM</h2>
                    <button onclick="closeCustomerCRMModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="p-6">
                    <!-- Customer Info & Status -->
                    <div class="grid grid-cols-3 gap-6 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="text-sm text-blue-600 mb-1">Tổng báo giá</div>
                            <div class="text-2xl font-bold text-blue-900" id="crmTotalQuotations">0</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="text-sm text-green-600 mb-1">Đã chốt</div>
                            <div class="text-2xl font-bold text-green-900" id="crmApprovedQuotations">0</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <div class="text-sm text-purple-600 mb-1">Tổng giá trị</div>
                            <div class="text-2xl font-bold text-purple-900" id="crmTotalValue">0 ₫</div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="border-b border-gray-200 mb-4">
                        <div class="flex gap-4">
                            <button onclick="switchCRMTab('quotations', this)"
                                class="crm-tab-btn active px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600">
                                Lịch sử Báo giá
                            </button>
                            <button onclick="switchCRMTab('appointments', this)"
                                class="crm-tab-btn px-4 py-2 font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent">
                                Lịch hẹn
                            </button>
                            <button onclick="switchCRMTab('interactions', this)"
                                class="crm-tab-btn px-4 py-2 font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent">
                                Tương tác
                            </button>
                            <button onclick="switchCRMTab('status', this)"
                                class="crm-tab-btn px-4 py-2 font-medium text-gray-600 hover:text-gray-900 border-b-2 border-transparent">
                                Trạng thái
                            </button>
                        </div>
                    </div>

                    <!-- Quotations Tab -->
                    <div id="crmTabQuotations" class="crm-tab-content">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Mã
                                        </th>
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">
                                            Ngày
                                        </th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">
                                            Giá
                                            trị</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">
                                            Trạng
                                            thái</th>
                                    </tr>
                                </thead>
                                <tbody id="crmQuotationsList">
                                    <!-- Will be populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Appointments Tab -->
                    <div id="crmTabAppointments" class="crm-tab-content hidden">
                        <div class="mb-4">
                            <button onclick="openAddAppointmentModal()"
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">
                                + Thêm lịch hẹn
                            </button>
                        </div>
                        <div id="crmAppointmentsList">
                            <!-- Will be populated -->
                        </div>
                    </div>

                    <!-- Interactions Tab -->
                    <div id="crmTabInteractions" class="crm-tab-content hidden">
                        <div class="mb-4">
                            <button onclick="openAddInteractionModal()"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700">
                                + Thêm tương tác
                            </button>
                        </div>
                        <div id="crmInteractionsList">
                            <!-- Will be populated -->
                        </div>
                    </div>

                    <!-- Status Tab -->
                    <div id="crmTabStatus" class="crm-tab-content hidden">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái khách
                                    hàng</label>
                                <select id="crmCustomerStatus"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="potential">Tiềm năng</option>
                                    <option value="interested">Đang quan tâm</option>
                                    <option value="closed">Chốt đơn</option>
                                    <option value="inactive">Không hoạt động</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ngày liên hệ tiếp
                                    theo</label>
                                <input type="date" id="crmNextFollowup"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <button onclick="updateCustomerStatus()"
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">
                                Cập nhật trạng thái
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Create New Project -->
        <div id="createProjectModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div
                class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto transform transition-all">
                <div
                    class="sticky top-0 bg-gradient-to-r from-blue-600 to-purple-600 text-white border-b border-gray-200 p-6 flex justify-between items-center rounded-t-2xl">
                    <h2 class="text-2xl font-bold">Tạo dự án mới</h2>
                    <button onclick="closeCreateProjectModal()"
                        class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-all duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <form id="createProjectForm" onsubmit="saveProjectInTab(event)" class="p-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Mã dự án <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="projectCode" required placeholder="Tự động tạo hoặc nhập thủ công"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                            <button type="button" onclick="generateProjectCodeForModal()"
                                class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors">
                                🔄 Tự động tạo mã
                            </button>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Tên dự án <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="projectName" required placeholder="VD: Biệt thự Hòa Lạc"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Khách hàng <span class="text-red-500">*</span>
                        </label>
                        <div class="flex gap-3">
                            <select id="projectCustomerId" required
                                class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                                <option value="">-- Chọn khách hàng --</option>
                            </select>
                            <button type="button" onclick="openAddCustomerModalFromProject()"
                                class="px-5 py-3 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 rounded-xl hover:from-gray-200 hover:to-gray-300 font-medium transition-all duration-300 shadow-sm">
                                + Thêm mới
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Ngày bắt đầu <span class="text-red-500">*</span>
                            </label>
                            <input type="date" id="projectStartDate" required
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Ngày giao dự kiến <span class="text-red-500">*</span>
                            </label>
                            <input type="date" id="projectDeadline" required
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Ghi chú
                        </label>
                        <textarea id="projectNotes" rows="4" placeholder="Ghi chú về dự án..."
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 resize-none"></textarea>
                    </div>

                    <div class="flex justify-end gap-4 pt-6 border-t border-gray-200">
                        <button type="button" onclick="closeCreateProjectModal()"
                            class="px-6 py-3 border-2 border-gray-300 rounded-xl font-semibold hover:bg-gray-50 transition-all duration-300">
                            Hủy
                        </button>
                        <button type="submit"
                            class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                            ✨ Tạo dự án
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL: Add Appointment -->
        <div id="addAppointmentModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Thêm lịch hẹn</h2>
                    <button onclick="closeAddAppointmentModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="appointmentForm" onsubmit="saveAppointment(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ngày giờ</label>
                            <input type="datetime-local" id="appointmentDate" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Loại</label>
                            <select id="appointmentType" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="meeting">Họp</option>
                                <option value="call">Gọi điện</option>
                                <option value="site_visit">Khảo sát</option>
                                <option value="followup">Theo dõi</option>
                                <option value="other">Khác</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tiêu đề</label>
                            <input type="text" id="appointmentTitle" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả</label>
                            <textarea id="appointmentDescription" rows="3"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Địa điểm</label>
                            <input type="text" id="appointmentLocation"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeAddAppointmentModal()"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Hủy
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Lưu
                        </button>
                    </div>
                    <input type="hidden" id="appointmentCustomerId">
                </form>
            </div>
        </div>

        <!-- MODAL: Add Interaction -->
        <div id="addInteractionModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Thêm tương tác</h2>
                    <button onclick="closeAddInteractionModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="interactionForm" onsubmit="saveInteraction(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Loại tương tác</label>
                            <select id="interactionType" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="call">Gọi điện</option>
                                <option value="email">Email</option>
                                <option value="meeting">Họp</option>
                                <option value="quotation_sent">Gửi báo giá</option>
                                <option value="quotation_viewed">Xem báo giá</option>
                                <option value="quotation_approved">Duyệt báo giá</option>
                                <option value="quotation_rejected">Từ chối báo giá</option>
                                <option value="note">Ghi chú</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ngày giờ</label>
                            <input type="datetime-local" id="interactionDate" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tiêu đề</label>
                            <input type="text" id="interactionTitle" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả</label>
                            <textarea id="interactionDescription" rows="3"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeAddInteractionModal()"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Hủy
                        </button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Lưu
                        </button>
                    </div>
                    <input type="hidden" id="interactionCustomerId">
                </form>
            </div>
        </div>

        <!-- MODAL: Product Selector -->
        <div id="productSelectorModal"
            class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4"
            style="backdrop-filter: blur(4px);">
            <div class="bg-white rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden shadow-2xl">
                <!-- Header -->
                <div
                    class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold">Chọn sản phẩm</h2>
                        <p class="text-indigo-100 text-sm">Chọn sản phẩm từ danh mục để thêm vào báo giá</p>
                    </div>
                    <button onclick="closeProductSelector()" class="p-2 hover:bg-white/20 rounded-lg transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Filters -->
                <div class="bg-gray-50 px-6 py-3 border-b flex items-center gap-4 flex-wrap">
                    <div class="relative flex-1 min-w-[200px]">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <input type="text" id="productSelectorSearch" placeholder="Tìm sản phẩm..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            oninput="filterProductSelector()">
                    </div>
                    <select id="productSelectorType"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        onchange="filterProductSelector()">
                        <option value="">Tất cả loại</option>
                        <option value="door">🚪 Cửa đi</option>
                        <option value="window">🪟 Cửa sổ</option>
                        <option value="railing">🏗️ Lan can</option>
                        <option value="glass_wall">🧱 Vách kính</option>
                        <option value="roof">🏠 Mái kính</option>
                        <option value="stair">🪜 Cầu thang</option>
                    </select>
                    <div class="text-sm text-gray-500">
                        <span id="productSelectorCount">0</span> sản phẩm
                    </div>
                </div>

                <!-- Products Grid -->
                <div id="productSelectorGrid"
                    class="p-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 overflow-y-auto max-h-[50vh]">
                    <!-- Products loaded here -->
                </div>

                <!-- Footer -->
                <div class="bg-gray-50 px-6 py-4 border-t flex justify-between items-center">
                    <p class="text-sm text-gray-500">Nhấn vào sản phẩm để thêm vào báo giá</p>
                    <button onclick="closeProductSelector()"
                        class="px-5 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-all">
                        Đóng
                    </button>
                </div>
            </div>
        </div>

        <script>
            const API_BASE = 'http://localhost:3001/api';
            let itemCounter = 0;
            let editingQuotationId = null;

            // Product Selector variables
            let allProductsForSelector = [];
            const typeLabelsSelector = { door: '🚪 Cửa đi', window: '🪟 Cửa sổ', railing: '🏗️ Lan can', glass_wall: '🧱 Vách kính', roof: '🏠 Mái kính', stair: '🪜 Cầu thang', other: '📦 Khác' };
            const typeColorsSelector = { door: 'bg-blue-100 text-blue-700', window: 'bg-cyan-100 text-cyan-700', railing: 'bg-purple-100 text-purple-700', glass_wall: 'bg-amber-100 text-amber-700', roof: 'bg-emerald-100 text-emerald-700', stair: 'bg-pink-100 text-pink-700', other: 'bg-gray-100 text-gray-700' };

            // ========== PRODUCT SELECTOR FUNCTIONS ==========
            async function openProductSelector() {
                document.getElementById('productSelectorModal').classList.remove('hidden');
                await loadProductsForSelector();
            }

            function closeProductSelector() {
                document.getElementById('productSelectorModal').classList.add('hidden');
            }

            async function loadProductsForSelector() {
                try {
                    // Try new API first
                    let response = await fetch(`${API_BASE}/product-templates`);
                    let result = await response.json();

                    if (result.success) {
                        allProductsForSelector = result.data;
                    } else {
                        // Fallback to door-templates
                        response = await fetch(`${API_BASE}/door-templates`);
                        result = await response.json();
                        if (result.success) {
                            allProductsForSelector = result.data.map(d => ({
                                ...d,
                                product_type: d.family?.includes('win') ? 'window' : 'door'
                            }));
                        }
                    }
                    filterProductSelector();
                } catch (error) {
                    console.error('Error loading products:', error);
                    document.getElementById('productSelectorGrid').innerHTML = '<p class="col-span-4 text-center text-gray-500 py-8">Không thể tải danh sách sản phẩm</p>';
                }
            }

            function filterProductSelector() {
                const search = document.getElementById('productSelectorSearch').value.toLowerCase();
                const type = document.getElementById('productSelectorType').value;

                let filtered = allProductsForSelector.filter(p => {
                    const matchSearch = !search || p.name?.toLowerCase().includes(search) || p.code?.toLowerCase().includes(search);
                    const matchType = !type || p.product_type === type;
                    return matchSearch && matchType;
                });

                renderProductSelectorGrid(filtered);
                document.getElementById('productSelectorCount').textContent = filtered.length;
            }

            function renderProductSelectorGrid(products) {
                const grid = document.getElementById('productSelectorGrid');

                if (products.length === 0) {
                    grid.innerHTML = '<p class="col-span-4 text-center text-gray-500 py-8">Không tìm thấy sản phẩm</p>';
                    return;
                }

                grid.innerHTML = products.map(p => {
                    const pType = p.product_type || 'other';
                    const icon = typeLabelsSelector[pType]?.split(' ')[0] || '📦';
                    return `
                    <div onclick="selectProductForQuotation(${p.id})" 
                         class="bg-white border-2 border-gray-200 rounded-xl p-4 cursor-pointer transition-all hover:border-indigo-500 hover:shadow-lg hover:-translate-y-1">
                        <div class="h-24 bg-gray-100 rounded-lg mb-3 flex items-center justify-center">
                            ${p.preview_image
                            ? `<img src="${API_BASE.replace('/api', '')}${p.preview_image}" class="w-full h-full object-contain rounded-lg" alt="${p.name}">`
                            : `<span class="text-4xl">${icon}</span>`}
                        </div>
                        <div class="mb-2">
                            <span class="text-xs px-2 py-1 rounded-full ${typeColorsSelector[pType] || 'bg-gray-100 text-gray-700'}">${typeLabelsSelector[pType] || 'Khác'}</span>
                        </div>
                        <h4 class="font-semibold text-gray-800 text-sm line-clamp-2">${p.name}</h4>
                        <p class="text-xs text-gray-500 mt-1">${p.code || ''}</p>
                        <p class="text-xs text-gray-400 mt-1">${p.default_width_mm || 1200} × ${p.default_height_mm || 2200} mm</p>
                    </div>
                `;
                }).join('');
            }

            async function selectProductForQuotation(productId) {
                try {
                    // Fetch product details
                    let response = await fetch(`${API_BASE}/product-templates/${productId}`);
                    let result = await response.json();

                    if (!result.success) {
                        // Fallback to door-templates
                        response = await fetch(`${API_BASE}/door-templates/${productId}`);
                        result = await response.json();
                    }

                    if (result.success && result.data) {
                        const product = result.data;

                        // Add item to quotation with product info
                        addQuotationItemFromProduct(product);

                        // Close modal
                        closeProductSelector();
                    }
                } catch (error) {
                    console.error('Error selecting product:', error);
                    alert('Không thể tải thông tin sản phẩm');
                }
            }

            function addQuotationItemFromProduct(product) {
                itemCounter++;
                const tbody = document.getElementById('quotationItemsList');

                // Generate product description
                const description = `${product.name} (${product.default_width_mm || 1200}×${product.default_height_mm || 2200}mm)`;
                const unit = 'bộ';
                // Note: Price should come from a pricing system, using 0 as placeholder
                const unitPrice = 0;

                const tr = document.createElement('tr');
                tr.id = `item-${itemCounter}`;
                tr.dataset.productId = product.id; // Store product reference
                tr.innerHTML = `
                <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                        <span class="px-2 py-1 text-xs rounded-full ${typeColorsSelector[product.product_type] || 'bg-gray-100 text-gray-700'}">${typeLabelsSelector[product.product_type]?.split(' ')[0] || '📦'}</span>
                        <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded bg-indigo-50" value="${description}" required>
                    </div>
                </td>
                <td class="px-4 py-3">
                    <input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded item-quantity" placeholder="0" value="1" onchange="calculateItemTotal(${itemCounter})" required>
                </td>
                <td class="px-4 py-3">
                    <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded" placeholder="Đơn vị" value="${unit}" required>
                </td>
                <td class="px-4 py-3">
                    <input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded item-price" placeholder="Nhập đơn giá" value="${unitPrice}" onchange="calculateItemTotal(${itemCounter})" required>
                </td>
                <td class="px-4 py-3">
                    <input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded item-total" readonly value="0">
                </td>
                <td class="px-4 py-3">
                    <button type="button" onclick="removeItem(${itemCounter})" class="text-red-600 hover:text-red-800">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </td>
            `;
                tbody.appendChild(tr);
                calculateTotals();
            }

            // Check authentication
            function checkAuth() {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            }

            // Load sidebar user info
            async function loadSidebarUserInfo() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        return;
                    }

                    const response = await fetch(`${API_BASE}/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        const user = result.data;
                        const userNameEl = document.getElementById('sidebarUserName');
                        if (userNameEl) {
                            userNameEl.textContent = user.full_name || 'User';
                        }

                        // Hiển thị avatar
                        const avatarInitial = document.getElementById('sidebarUserAvatarInitial');
                        const avatarImage = document.getElementById('sidebarUserAvatarImage');

                        if (avatarInitial && avatarImage) {
                            if (user.avatar_url) {
                                avatarImage.src = user.avatar_url;
                                avatarImage.classList.remove('hidden');
                                avatarInitial.classList.add('hidden');
                            } else {
                                // Hiển thị chữ cái đầu của tên
                                const initial = (user.full_name || 'U').charAt(0).toUpperCase();
                                avatarInitial.textContent = initial;
                                avatarInitial.classList.remove('hidden');
                                avatarImage.classList.add('hidden');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Lỗi load sidebar user info:', error);
                }
            }

            // Load header user info (if header exists)
            async function loadHeaderUserInfo() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        return;
                    }

                    const response = await fetch(`${API_BASE}/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        const user = result.data;
                        const userNameEl = document.getElementById('userName');
                        if (userNameEl) {
                            userNameEl.textContent = user.full_name || 'User';
                        }

                        const avatarInitial = document.getElementById('userAvatarInitial');
                        const avatarImage = document.getElementById('userAvatarImage');

                        if (avatarInitial && avatarImage) {
                            if (user.avatar_url) {
                                avatarImage.src = user.avatar_url;
                                avatarImage.classList.remove('hidden');
                                avatarInitial.classList.add('hidden');
                            } else {
                                const initial = (user.full_name || 'U').charAt(0).toUpperCase();
                                avatarInitial.textContent = initial;
                                avatarInitial.classList.remove('hidden');
                                avatarImage.classList.add('hidden');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Lỗi load header user info:', error);
                }
            }

            // Toggle notifications dropdown
            function toggleNotifications() {
                const dropdown = document.getElementById('notificationsDropdown');
                dropdown.classList.toggle('hidden');
                if (!dropdown.classList.contains('hidden')) {
                    loadNotifications();
                }
            }

            // Toggle sidebar user menu
            function toggleSidebarUserMenu() {
                const dropdown = document.getElementById('sidebarUserMenuDropdown');
                if (dropdown) {
                    dropdown.classList.toggle('hidden');
                }
            }

            // Toggle header user menu (if header exists)
            function toggleHeaderUserMenu() {
                const dropdown = document.getElementById('userMenuDropdown');
                if (dropdown) {
                    dropdown.classList.toggle('hidden');
                }
            }

            // Load notifications
            async function loadNotifications() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    const response = await fetch(`${API_BASE}/notifications`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        displayNotifications(result.data || []);
                        // ✅ Chỉ load unread count nếu DOM đã sẵn sàng
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', loadUnreadCount);
                        } else {
                            loadUnreadCount();
                        }
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            // Load unread count
            async function loadUnreadCount() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    const response = await fetch(`${API_BASE}/notifications/unread`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        const count = result.data.count || 0;
                        // ✅ Guard null - kiểm tra element tồn tại trước khi dùng
                        const badge = document.getElementById('notificationBadge') || document.getElementById('headerNotificationBadge');
                        if (!badge) {
                            // Element không tồn tại trong trang này, bỏ qua
                            return;
                        }

                        if (count > 0) {
                            badge.textContent = count > 99 ? '99+' : count;
                            badge.classList.remove('hidden');
                        } else {
                            badge.classList.add('hidden');
                        }
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            // Display notifications
            function displayNotifications(notifications) {
                const container = document.getElementById('notificationsList');

                if (notifications.length === 0) {
                    container.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <p>Không có thông báo nào</p>
                    </div>
                `;
                    return;
                }

                container.innerHTML = notifications.slice(0, 10).map(notif => {
                    const typeColors = {
                        'info': 'bg-blue-50 border-blue-200',
                        'success': 'bg-green-50 border-green-200',
                        'warning': 'bg-yellow-50 border-yellow-200',
                        'error': 'bg-red-50 border-red-200'
                    };

                    const typeIcons = {
                        'info': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-blue-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                        'success': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-green-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                        'warning': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-yellow-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>',
                        'error': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-red-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                    };

                    return `
                    <div class="p-4 border-b border-gray-200 hover:bg-gray-50 cursor-pointer ${notif.is_read ? '' : 'bg-blue-50'}" 
                         onclick="markNotificationRead(${notif.id})">
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0 mt-1">
                                ${typeIcons[notif.type] || typeIcons.info}
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-sm ${notif.is_read ? 'text-gray-700' : 'text-gray-900'}">${notif.title}</h4>
                                <p class="text-sm text-gray-600 mt-1">${notif.message}</p>
                                <p class="text-xs text-gray-400 mt-1">${formatTime(notif.created_at)}</p>
                            </div>
                            ${!notif.is_read ? '<div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>' : ''}
                        </div>
                    </div>
                `;
                }).join('');
            }

            // Mark notification as read
            async function markNotificationRead(id) {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    const response = await fetch(`${API_BASE}/notifications/${id}/read`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        loadNotifications();
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            // Handle logout (shared function)
            function handleLogout() {
                if (confirm('Bạn có chắc muốn đăng xuất?')) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                }
            }

            // Format time
            function formatTime(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return 'Vừa xong';
                if (minutes < 60) return `${minutes} phút trước`;
                if (hours < 24) return `${hours} giờ trước`;
                if (days < 7) return `${days} ngày trước`;
                return date.toLocaleDateString('vi-VN');
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', function (event) {
                // Notifications dropdown
                const notificationsDropdown = document.getElementById('notificationsDropdown');
                const notificationsButton = event.target.closest('[onclick="toggleNotifications()"]');
                if (notificationsDropdown && !notificationsButton && !notificationsDropdown.contains(event.target)) {
                    notificationsDropdown.classList.add('hidden');
                }

                // Sidebar user dropdown
                const sidebarDropdown = document.getElementById('sidebarUserMenuDropdown');
                const sidebarButton = event.target.closest('[onclick="toggleSidebarUserMenu()"]');
                if (sidebarDropdown && !sidebarButton && !sidebarDropdown.contains(event.target)) {
                    sidebarDropdown.classList.add('hidden');
                }

                // Header user dropdown (if exists)
                const headerDropdown = document.getElementById('userMenuDropdown');
                const headerButton = event.target.closest('[onclick="toggleHeaderUserMenu()"]');
                if (headerDropdown && !headerButton && !headerDropdown.contains(event.target)) {
                    headerDropdown.classList.add('hidden');
                }
            });

            // Tab switching - Make it global for onclick handlers
            window.switchTab = function (tabName, buttonElement) {
                // Check if elements exist
                const tabContent = document.getElementById('tab-' + tabName);
                if (!tabContent) {
                    console.error('Tab content not found:', 'tab-' + tabName);
                    return;
                }

                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                    tab.style.display = 'none';
                });
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });

                tabContent.classList.add('active');
                tabContent.style.display = '';
                if (buttonElement) {
                    buttonElement.classList.add('active');
                }

                // Load data when switching tabs
                if (tabName === 'customers') {
                    if (typeof loadCustomers === 'function') {
                        loadCustomers();
                    }
                } else if (tabName === 'projects') {
                    setActiveTab('projects');
                }
            };

            // Set active tab for projects
            let projectsTabLoaded = false;
            window.setActiveTab = function (tabName) {
                if (tabName === 'projects') {
                    // Load projects on first time
                    if (!projectsTabLoaded) {
                        projectsTabLoaded = true;
                        loadProjectsInTab();
                    }
                }
            };

            // Load projects in tab
            async function loadProjectsInTab() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        console.error('No token found');
                        return;
                    }

                    const container = document.querySelector('[data-projects-list]');
                    if (!container) {
                        console.error('Projects list container not found');
                        return;
                    }

                    // Show loading
                    container.innerHTML = '<p class="text-center text-gray-500 py-8">Đang tải dữ liệu...</p>';

                    const response = await fetch(`${API_BASE}/projects`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success && result.data) {
                        let projects = result.data || [];

                        // Filter out completed projects (100% progress or status = 'completed')
                        projects = projects.filter(p => {
                            const progress = parseFloat(p.progress_percent) || 0;
                            const status = (p.status || '').toLowerCase();
                            // Bỏ các dự án đã hoàn thành 100% hoặc status = 'completed' hoặc 'handover'
                            return progress < 100 && status !== 'completed' && status !== 'handover';
                        });

                        // Update KPI (use all projects for KPI calculation)
                        updateProjectsKPI(result.data || []);

                        // Render projects (only non-completed)
                        renderProjectsInTab(projects);
                    } else {
                        container.innerHTML = '<p class="text-center text-red-500 py-8">Lỗi khi tải dữ liệu dự án</p>';
                    }
                } catch (error) {
                    console.error('Error loading projects:', error);
                    const container = document.querySelector('[data-projects-list]');
                    if (container) {
                        container.innerHTML = '<p class="text-center text-red-500 py-8">Lỗi kết nối server</p>';
                    }
                }
            }

            // Update KPI counts
            function updateProjectsKPI(projects) {
                const running = projects.filter(p => {
                    const status = (p.status || '').toLowerCase();
                    const progress = parseFloat(p.progress_percent) || 0;
                    return status !== 'completed' && progress < 100;
                }).length;

                const pending = projects.filter(p => {
                    const status = (p.status || '').toLowerCase();
                    return status === 'pending' || status === 'quotation_pending' || status === 'waiting_quotation';
                }).length;

                const production = projects.filter(p => {
                    const status = (p.status || '').toLowerCase();
                    return status === 'in_production' || status === 'bom_extraction' || status === 'production';
                }).length;

                const completed = projects.filter(p => {
                    const status = (p.status || '').toLowerCase();
                    const progress = parseFloat(p.progress_percent) || 0;
                    return status === 'completed' || progress >= 100;
                }).length;

                const runningEl = document.querySelector('[data-projects-kpi="running"]');
                const pendingEl = document.querySelector('[data-projects-kpi="pending"]');
                const productionEl = document.querySelector('[data-projects-kpi="production"]');
                const completedEl = document.querySelector('[data-projects-kpi="completed"]');

                if (runningEl) runningEl.textContent = running;
                if (pendingEl) pendingEl.textContent = pending;
                if (productionEl) productionEl.textContent = production;
                if (completedEl) completedEl.textContent = completed;
            }

            // Render projects in tab
            function renderProjectsInTab(projects) {
                const container = document.querySelector('[data-projects-list]');
                if (!container) return;

                if (projects.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 py-8">Chưa có dự án nào. Hãy tạo dự án mới!</p>';
                    const heading = document.querySelector('[data-projects-heading]');
                    if (heading) {
                        heading.innerHTML = 'Dự án đang triển khai <span class="text-blue-600">(0)</span>';
                    }
                    return;
                }

                container.innerHTML = '';
                projects.forEach(project => {
                    try {
                        const card = createProjectCardForTab(project);
                        container.appendChild(card);
                    } catch (error) {
                        console.error('Error creating card for project:', project.id, error);
                    }
                });

                // Update heading
                const heading = document.querySelector('[data-projects-heading]');
                if (heading) {
                    heading.innerHTML = `Dự án đang triển khai <span class="text-blue-600">(${projects.length})</span>`;
                }
            }

            // Helper functions for project card
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN');
            }

            function formatCurrency(amount) {
                if (!amount) return '0₫';
                return new Intl.NumberFormat('vi-VN').format(amount) + '₫';
            }

            // Create project card for tab (simplified version from projects.html)
            function createProjectCardForTab(project) {
                if (!project || !project.id) {
                    throw new Error('Project data is invalid: missing id');
                }

                const card = document.createElement('div');
                card.className = 'project-card bg-white shadow-lg rounded-2xl p-6 mb-4 fade-in';

                const progress = project.progress_percent || 0;
                const status = project.status || 'new';
                const customerName = project.customer_name || 'N/A';
                const customerPhone = project.customer_phone || '';
                const projectCode = project.project_code || `CT-${project.id}`;
                const projectName = project.project_name || 'N/A';
                const startDate = project.start_date ? formatDate(project.start_date) : 'N/A';
                const deadline = project.deadline ? formatDate(project.deadline) : 'N/A';
                const totalValue = project.total_value ? formatCurrency(project.total_value) : '0₫';

                // Set data attributes for filtering
                card.setAttribute('data-status', status);
                card.setAttribute('data-progress', progress);
                card.setAttribute('data-name', projectName.toLowerCase());
                card.setAttribute('data-customer', customerName.toLowerCase());
                card.setAttribute('data-phone', customerPhone);
                card.setAttribute('data-code', projectCode.toLowerCase());
                card.setAttribute('data-project-id', project.id);

                // Status badge - Show quote_locked and contract_locked badges
                let statusBadge = '';

                // Priority: contract_locked > quote_locked > status-based
                if (project.contract_locked) {
                    statusBadge = '<span class="status-badge bg-purple-100 text-purple-700"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>Đã ký hợp đồng</span>';
                } else if (project.quote_locked) {
                    statusBadge = '<span class="status-badge bg-amber-100 text-amber-700"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Đã chốt báo giá</span>';
                } else if (status === 'approved' || status === 'quotation_approved') {
                    statusBadge = '<span class="status-badge bg-green-100 text-green-700"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>Đã duyệt</span>';
                } else if (status === 'pending' || status === 'quotation_pending' || status === 'waiting_quotation') {
                    statusBadge = '<span class="status-badge bg-yellow-100 text-yellow-700"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Chờ duyệt</span>';
                } else {
                    statusBadge = '<span class="status-badge bg-gray-100 text-gray-600">Mới</span>';
                }

                // Progress color
                let progressColor = 'bg-gray-400';
                if (progress >= 75) progressColor = 'bg-green-500';
                else if (progress >= 50) progressColor = 'bg-blue-500';
                else if (progress >= 25) progressColor = 'bg-orange-500';

                // Workflow steps
                const workflowSteps = ['Báo giá', 'Thiết kế', 'Bóc tách', 'Sản xuất', 'Lắp đặt', 'Bàn giao'];
                const progressNum = parseFloat(progress) || 0;
                let completedSteps;

                // Xác định số bước hoàn thành dựa trên status VÀ progress
                if (progressNum >= 95 || status === 'completed' || status === 'handover') {
                    completedSteps = 6; // Tất cả hoàn thành
                } else if (status === 'installation' || progressNum >= 80) {
                    completedSteps = 5; // Đến Lắp đặt
                } else if (status === 'in_production' || status === 'production' || progressNum >= 50) {
                    completedSteps = 4; // Đến Sản xuất (Báo giá, Thiết kế, Bóc tách đã xong)
                } else if (status === 'bom_extraction' || status === 'design' || progressNum >= 35) {
                    completedSteps = 3; // Đến Bóc tách
                } else if (status === 'quotation_approved' || status === 'approved' || project.contract_locked || progressNum >= 20) {
                    completedSteps = 2; // Đến Thiết kế
                } else if (status === 'quotation_pending' || status === 'waiting_quotation' || project.quote_locked || progressNum >= 10) {
                    completedSteps = 1; // Đến Báo giá
                } else {
                    completedSteps = 0; // Mới tạo
                }

                let workflowHTML = '';
                workflowSteps.forEach((step, index) => {
                    const isActive = index < completedSteps;
                    workflowHTML += `
                        <div class="workflow-step">
                            <div class="workflow-step-circle ${isActive ? 'active' : 'inactive'}">
                                ${isActive ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>' : '—'}
                            </div>
                            <span class="text-xs text-center mt-1">${step}</span>
                        </div>
                    `;
                });


                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-xl font-bold">${escapeHtml(projectName)}</h3>
                                <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">${escapeHtml(projectCode)}</span>
                            </div>
                            <div class="flex items-center gap-4 text-sm text-gray-600 mb-3">
                                <span class="flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                    ${escapeHtml(customerName)}
                                </span>
                                ${customerPhone ? `
                                <span class="flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                    </svg>
                                    ${escapeHtml(customerPhone)}
                                </span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-600 mb-1">Ngày bắt đầu: <span class="font-medium">${startDate}</span></div>
                            <div class="text-sm text-gray-600 mb-1">Ngày giao: <span class="font-medium">${deadline}</span></div>
                            <div class="text-lg font-bold text-green-600">${totalValue}</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium">Tiến độ: ${progress}%</span>
                        </div>
                        <div class="progress-bar bg-gray-200">
                            <div class="${progressColor} h-full" style="width: ${progress}%"></div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 mb-3">
                        ${statusBadge}
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between items-center">
                            ${workflowHTML}
                        </div>
                    </div>

                    <div class="mt-4 flex gap-2 flex-wrap">
                        ${(project.quotation_count || 0) === 0 &&
                        status !== 'quotation_pending' &&
                        status !== 'waiting_quotation' ? `
                        <button onclick="createQuotationFromProjectInTab(${project.id}, '${escapeHtml(projectCode)}', '${escapeHtml(projectName)}')" class="action-btn border-2 border-teal-500 text-teal-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2 bg-teal-50 hover:bg-teal-100">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Tạo báo giá
                        </button>
                        ` : ''}
                        <button onclick="goToDesignInTab('${escapeHtml(projectCode)}', ${project.id})" class="action-btn border-2 border-blue-500 text-blue-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                            Thiết kế
                        </button>
                        <button onclick="goToProjectDoorsInTab(${project.id})" class="action-btn border-2 border-indigo-500 text-indigo-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                            </svg>
                            Cửa
                        </button>
                        <button onclick="viewProjectDetailsInTab(${project.id})" class="action-btn border-2 border-purple-500 text-purple-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            Chi tiết
                        </button>
                        <button onclick="createProductionOrderInTab('${escapeHtml(projectCode)}', ${project.id})" class="action-btn border-2 border-orange-500 text-orange-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                            </svg>
                            Lệnh SX
                        </button>
                        <button onclick="viewProjectLogsInTab('${escapeHtml(projectCode)}', ${project.id})" class="action-btn border-2 border-purple-500 text-purple-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Nhật ký
                        </button>
                        <button onclick="openEditProjectModalInTab(${project.id})" class="action-btn border-2 border-green-500 text-green-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            Sửa
                        </button>
                        <button onclick="confirmDeleteProjectInTab(${project.id}, '${escapeHtml(projectCode)}', '${escapeHtml(projectName)}')" class="action-btn border-2 border-red-500 text-red-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Xóa
                        </button>
                    </div>
                `;

                return card;
            }

            // Filter projects in tab
            function filterProjectsInTab() {
                const searchInput = document.querySelector('[data-projects-search="input"]');
                const statusFilter = document.querySelector('[data-projects-filter="status"]');
                const progressFilter = document.querySelector('[data-projects-filter="progress"]');

                const searchTerm = (searchInput?.value || '').toLowerCase();
                const statusValue = statusFilter?.value || 'all';
                const progressValue = progressFilter?.value || 'all';

                const projectCards = document.querySelectorAll('[data-projects-list] .project-card');
                let visibleCount = 0;

                projectCards.forEach(card => {
                    const name = card.getAttribute('data-name') || '';
                    const customer = card.getAttribute('data-customer') || '';
                    const phone = card.getAttribute('data-phone') || '';
                    const code = card.getAttribute('data-code') || '';
                    const status = card.getAttribute('data-status') || '';
                    const progress = parseInt(card.getAttribute('data-progress') || 0);

                    // Search filter
                    const matchesSearch = !searchTerm ||
                        name.includes(searchTerm) ||
                        customer.includes(searchTerm) ||
                        phone.includes(searchTerm) ||
                        code.includes(searchTerm);

                    // Status filter
                    let matchesStatus = true;
                    if (statusValue !== 'all') {
                        if (statusValue === 'approved') {
                            matchesStatus = status === 'approved' || status === 'quotation_approved';
                        } else if (statusValue === 'pending') {
                            matchesStatus = status === 'pending' || status === 'quotation_pending' || status === 'waiting_quotation';
                        } else if (statusValue === 'not-created') {
                            matchesStatus = !status || status === 'new';
                        }
                    }

                    // Progress filter
                    let matchesProgress = true;
                    if (progressValue !== 'all') {
                        if (progressValue === '0-25') {
                            matchesProgress = progress >= 0 && progress <= 25;
                        } else if (progressValue === '25-50') {
                            matchesProgress = progress > 25 && progress <= 50;
                        } else if (progressValue === '50-75') {
                            matchesProgress = progress > 50 && progress <= 75;
                        } else if (progressValue === '75-100') {
                            matchesProgress = progress > 75 && progress <= 100;
                        }
                    }

                    // Show/hide card
                    if (matchesSearch && matchesStatus && matchesProgress) {
                        card.style.display = '';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                // Update heading
                const heading = document.querySelector('[data-projects-heading]');
                if (heading) {
                    heading.innerHTML = `Dự án đang triển khai <span class="text-blue-600">(${visibleCount})</span>`;
                }
            }

            // View project details in tab
            function viewProjectDetailsInTab(projectId) {
                window.location.href = `projects.html?id=${projectId}`;
            }

            // Function to go to design page
            function goToDesignInTab(projectCode, projectId = null) {
                if (projectId) {
                    window.location.href = `design-new.html?projectId=${projectId}`;
                } else {
                    alert('Không tìm thấy ID dự án. Vui lòng thử lại sau.');
                }
            }

            // Function to go to project doors page
            function goToProjectDoorsInTab(projectId) {
                if (projectId) {
                    window.location.href = `project-doors.html?projectId=${projectId}`;
                } else {
                    alert('Không tìm thấy ID dự án');
                }
            }

            // Function to create quotation from project
            async function createQuotationFromProjectInTab(projectId, projectCode, projectName) {
                if (!projectId) {
                    alert('Không tìm thấy ID dự án');
                    return;
                }

                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success && result.data) {
                        const project = result.data;
                        const customerId = project.customer_id;

                        if (!customerId) {
                            alert('Dự án chưa có khách hàng. Vui lòng cập nhật thông tin khách hàng cho dự án trước.');
                            return;
                        }

                        window.location.href = `quotation-new.html?projectId=${projectId}&customerId=${customerId}`;
                    } else {
                        alert('Không thể lấy thông tin dự án');
                    }
                } catch (error) {
                    console.error('Error getting project details:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            // Create production order
            async function createProductionOrderInTab(projectCode, projectId = null) {
                if (!projectId) {
                    alert('Không tìm thấy ID dự án. Vui lòng thử lại sau.');
                    return;
                }

                window.location.href = `production.html?projectId=${projectId}&action=create`;
            }

            // View project logs
            async function viewProjectLogsInTab(projectCode, projectId) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/projects/${projectId}/logs`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success && result.data) {
                        const logs = result.data;
                        let logsHTML = '<div class="space-y-4 max-h-96 overflow-y-auto">';

                        if (logs.length === 0) {
                            logsHTML += '<p class="text-gray-500 text-center py-4">Chưa có nhật ký nào</p>';
                        } else {
                            logs.forEach(log => {
                                const date = new Date(log.created_at).toLocaleString('vi-VN');
                                logsHTML += `
                                    <div class="border-l-4 border-blue-500 pl-4 py-2">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-medium text-gray-900">${escapeHtml(log.action || 'Hoạt động')}</p>
                                                <p class="text-sm text-gray-600 mt-1">${escapeHtml(log.description || '')}</p>
                                            </div>
                                            <span class="text-xs text-gray-500">${date}</span>
                                        </div>
                                    </div>
                                `;
                            });
                        }

                        logsHTML += '</div>';

                        // Show in modal or alert
                        alert('Nhật ký dự án:\n\n' + logs.map(log => {
                            const date = new Date(log.created_at).toLocaleString('vi-VN');
                            return `[${date}] ${log.action || 'Hoạt động'}: ${log.description || ''}`;
                        }).join('\n'));
                    } else {
                        alert('Không thể tải nhật ký dự án');
                    }
                } catch (error) {
                    console.error('Error loading logs:', error);
                    alert('Lỗi khi tải nhật ký dự án: ' + error.message);
                }
            }

            // Open edit project modal
            async function openEditProjectModalInTab(projectId) {
                window.location.href = `projects.html?id=${projectId}&action=edit`;
            }

            // Confirm delete project
            async function confirmDeleteProjectInTab(projectId, projectCode, projectName) {
                if (!confirm(`Bạn có chắc chắn muốn xóa dự án "${projectName}" (${projectCode})?\n\nHành động này không thể hoàn tác!`)) {
                    return;
                }

                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Đã xóa dự án thành công!');
                        // Reload projects
                        if (typeof loadProjectsInTab === 'function') {
                            await loadProjectsInTab();
                        }
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể xóa dự án'));
                    }
                } catch (error) {
                    console.error('Error deleting project:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }



            // Helper functions for customer status
            function getCustomerStatusColor(status) {
                const colors = {
                    'potential': 'bg-blue-100 text-blue-700',
                    'interested': 'bg-yellow-100 text-yellow-700',
                    'closed': 'bg-green-100 text-green-700',
                    'inactive': 'bg-gray-100 text-gray-700'
                };
                return colors[status] || 'bg-gray-100 text-gray-700';
            }

            function getCustomerStatusText(status) {
                const texts = {
                    'potential': 'Tiềm năng',
                    'interested': 'Đang quan tâm',
                    'closed': 'Chốt đơn',
                    'inactive': 'Không hoạt động'
                };
                return texts[status] || status;
            }

            function displayCustomers(customers) {
                const container = document.getElementById('customersList');
                container.innerHTML = '';

                if (!customers || customers.length === 0) {
                    container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-16 h-16 text-gray-400 mx-auto mb-4">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <p class="text-gray-500 text-lg mb-2">Chưa có khách hàng nào</p>
                        <p class="text-gray-400 text-sm">Nhấn nút "Thêm khách hàng" để bắt đầu</p>
                    </div>
                `;
                    return;
                }

                customers.forEach(customer => {
                    const card = `
                    <div class="customer-card bg-white border border-gray-200 rounded-lg p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                    <span class="text-blue-600 font-bold text-lg">${customer.full_name.charAt(0)}</span>
                                </div>
                                <div>
                                    <h3 class="font-bold">${customer.full_name}</h3>
                                    <p class="text-sm text-gray-600">${customer.customer_code || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="viewCustomerCRM(${customer.id})" class="text-purple-600 hover:text-purple-800" title="Xem CRM">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                </button>
                                <button onclick="editCustomer(${customer.id})" class="text-blue-600 hover:text-blue-800">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button onclick="deleteCustomer(${customer.id})" class="text-red-600 hover:text-red-800">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2 text-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                </svg>
                                ${customer.phone || 'N/A'}
                            </div>
                            <div class="flex items-center gap-2 text-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                ${customer.email || 'N/A'}
                            </div>
                            ${customer.customer_status ? `
                            <div class="pt-2">
                                <span class="px-2 py-1 rounded-full text-xs ${getCustomerStatusColor(customer.customer_status)}">
                                    ${getCustomerStatusText(customer.customer_status)}
                                </span>
                            </div>
                            ` : ''}
                            <div class="pt-2 border-t border-gray-200">
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-600">Báo giá:</span>
                                    <span class="font-medium">${customer.total_quotations || 0}</span>
                                </div>
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-600">Dự án:</span>
                                    <span class="font-medium">${customer.total_projects || 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                    container.innerHTML += card;
                });
            }

            // Load Quotations
            async function loadQuotations() {
                try {
                    const status = document.getElementById('filterStatus').value;
                    const search = document.getElementById('searchQuotation').value;

                    let url = `${API_BASE}/quotations`;
                    const params = [];
                    if (status !== 'all') params.push(`status=${status}`);
                    if (search) params.push(`search=${encodeURIComponent(search)}`);
                    if (params.length > 0) url += '?' + params.join('&');

                    const response = await fetch(url);
                    const result = await response.json();

                    if (result.success) {
                        displayQuotations(result.data);
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            async function loadQuotationStats() {
                try {
                    const response = await fetch(`${API_BASE}/quotations/stats`);
                    const result = await response.json();

                    if (result.success && result.data) {
                        const stats = result.data;

                        // Parse số liệu, đảm bảo là số nguyên
                        const total = parseInt(stats.total) || 0;
                        const approved = parseInt(stats.approved) || 0;
                        const pending = parseInt(stats.pending) || 0;
                        const sent = parseInt(stats.sent) || 0;
                        const rejected = parseInt(stats.rejected) || 0;

                        // Tổng báo giá
                        document.getElementById('statTotal').textContent = total;
                        // Đã chốt (approved)
                        document.getElementById('statApproved').textContent = approved;
                        // Chờ duyệt (pending + sent)
                        const pendingCount = pending + sent;
                        document.getElementById('statPending').textContent = pendingCount;
                        // Từ chối (rejected)
                        document.getElementById('statRejected').textContent = rejected;
                    } else {
                        // Nếu API trả về lỗi, hiển thị 0
                        document.getElementById('statTotal').textContent = '0';
                        document.getElementById('statApproved').textContent = '0';
                        document.getElementById('statPending').textContent = '0';
                        document.getElementById('statRejected').textContent = '0';
                        console.error('Lỗi khi tải thống kê:', result.message || 'Unknown error');
                    }
                } catch (error) {
                    console.error('Lỗi khi tải thống kê báo giá:', error);
                    // Hiển thị 0 nếu có lỗi
                    document.getElementById('statTotal').textContent = '0';
                    document.getElementById('statApproved').textContent = '0';
                    document.getElementById('statPending').textContent = '0';
                    document.getElementById('statRejected').textContent = '0';
                }
            }

            function displayQuotations(quotations) {
                const tbody = document.getElementById('quotationsTable');
                tbody.innerHTML = '';

                if (quotations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Chưa có báo giá nào</td></tr>';
                    return;
                }

                quotations.forEach(quotation => {
                    const statusColors = {
                        'draft': 'bg-gray-100 text-gray-700',
                        'sent': 'bg-blue-100 text-blue-700',
                        'pending': 'bg-yellow-100 text-yellow-700',
                        'approved': 'bg-green-100 text-green-700',
                        'rejected': 'bg-red-100 text-red-700'
                    };

                    const statusTexts = {
                        'draft': 'Mới tạo',
                        'sent': 'Đã gửi',
                        'pending': 'Chờ duyệt',
                        'approved': 'Đã chốt',
                        'rejected': 'Từ chối'
                    };

                    const isApproved = quotation.status === 'approved';
                    const isRejected = quotation.status === 'rejected';
                    const isLocked = isApproved || isRejected;

                    const row = `
                    <tr class="quotation-card">
                        <td class="px-4 py-3 text-sm font-medium">${quotation.quotation_code}</td>
                        <td class="px-4 py-3 text-sm">${quotation.project_name || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm">${quotation.customer_name || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm">${formatDate(quotation.quotation_date)}</td>
                        <td class="px-4 py-3 text-sm font-semibold">${formatCurrency(quotation.total_amount)}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs ${statusColors[quotation.status] || 'bg-gray-100'}">
                                ${statusTexts[quotation.status] || quotation.status}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex gap-2 items-center flex-wrap">
                                <button onclick="viewQuotation(${quotation.id})" class="text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-50 transition-all" title="Xem chi tiết">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                </button>
                                ${!isLocked ? `
                                <button onclick="editQuotation(${quotation.id})" class="text-purple-600 hover:text-purple-800 p-1 rounded hover:bg-purple-50 transition-all" title="Sửa">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button onclick="updateQuotationStatus(${quotation.id}, 'approved')" class="text-green-600 hover:text-green-800 p-1 rounded hover:bg-green-50 transition-all" title="Đã chốt">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                </button>
                                <button onclick="updateQuotationStatus(${quotation.id}, 'pending')" class="text-yellow-600 hover:text-yellow-800 p-1 rounded hover:bg-yellow-50 transition-all ${quotation.status === 'pending' || quotation.status === 'sent' ? 'opacity-50 cursor-not-allowed' : ''}" title="Chờ duyệt" ${quotation.status === 'pending' || quotation.status === 'sent' ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </button>
                                <button onclick="updateQuotationStatus(${quotation.id}, 'rejected')" class="text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-50 transition-all" title="Từ chối">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                                <button onclick="deleteQuotation(${quotation.id})" class="text-gray-600 hover:text-red-800 p-1 rounded hover:bg-red-50 transition-all" title="Xóa">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                                ` : `
                                <span class="text-xs text-gray-400 italic">${isApproved ? 'Đã khóa' : 'Đã từ chối'}</span>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
                    tbody.innerHTML += row;
                });
            }

            // Quotation Form Functions - Removed (no longer needed in this page)

            function searchCustomers() {
                const searchTerm = document.getElementById('searchCustomer').value;
                loadCustomers(searchTerm);
            }

            // Load projects for customer (used in quotation form)
            async function loadProjectsForCustomer() {
                const customerId = document.getElementById('quotationCustomer')?.value;
                const projectSelect = document.getElementById('quotationProject');

                if (!customerId || !projectSelect) return;

                projectSelect.innerHTML = '<option value="">-- Đang tải --</option>';

                try {
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    const response = await fetch(`${API_BASE}/projects?customer_id=${customerId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const result = await response.json();

                    if (result.success && result.data) {
                        projectSelect.innerHTML = '<option value="">-- Chọn dự án --</option>';
                        if (result.data.length === 0) {
                            projectSelect.innerHTML = '<option value="">-- Không có dự án nào --</option>';
                        } else {
                            result.data.forEach(project => {
                                if (project.status !== 'completed' && project.status !== 'cancelled' && project.status !== 'closed') {
                                    projectSelect.innerHTML += `<option value="${project.id}">${project.project_code} - ${project.project_name}</option>`;
                                }
                            });
                        }
                    } else {
                        projectSelect.innerHTML = '<option value="">-- Lỗi tải dự án --</option>';
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    projectSelect.innerHTML = '<option value="">-- Lỗi tải dự án --</option>';
                }
            }

            function addQuotationItem() {
                itemCounter++;
                const tbody = document.getElementById('quotationItemsList');

                // Tạo element mới thay vì dùng innerHTML để không mất dữ liệu
                const tr = document.createElement('tr');
                tr.id = `item-${itemCounter}`;
                tr.innerHTML = `
                <td class="px-4 py-3">
                    <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded" placeholder="Tên sản phẩm/dịch vụ" required>
                </td>
                <td class="px-4 py-3">
                    <input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded item-quantity" placeholder="0" value="1" onchange="calculateItemTotal(${itemCounter})" required>
                </td>
                <td class="px-4 py-3">
                    <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded" placeholder="Đơn vị" value="bộ" required>
                </td>
                <td class="px-4 py-3">
                    <input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded item-price" placeholder="0" onchange="calculateItemTotal(${itemCounter})" required>
                </td>
                <td class="px-4 py-3">
                    <input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded item-total" readonly value="0">
                </td>
                <td class="px-4 py-3">
                    <button type="button" onclick="removeItem(${itemCounter})" class="text-red-600 hover:text-red-800">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </td>
            `;
                tbody.appendChild(tr);
            }

            function calculateItemTotal(itemId) {
                const row = document.getElementById(`item-${itemId}`);
                // Xử lý số có dấu phẩy (format VN)
                const quantityStr = row.querySelector('.item-quantity').value.toString().replace(/,/g, '');
                const quantity = parseFloat(quantityStr) || 0;
                const priceStr = row.querySelector('.item-price').value.toString().replace(/,/g, '');
                const price = parseFloat(priceStr) || 0;
                const total = quantity * price;
                row.querySelector('.item-total').value = total.toFixed(2);
                calculateTotals();
            }

            function removeItem(itemId) {
                document.getElementById(`item-${itemId}`).remove();
                calculateTotals();
            }

            function calculateTotals() {
                let subtotal = 0;
                document.querySelectorAll('.item-total').forEach(input => {
                    subtotal += parseFloat(input.value) || 0;
                });

                // Không tính lợi nhuận nữa, tổng giá bán = tổng giá vốn
                const profit = 0;
                const total = subtotal;

                // Tính tiền tạm ứng: 30% tổng giá vốn
                const advanceAmount = Math.round(subtotal * 0.3);

                document.getElementById('totalSubtotal').textContent = formatCurrency(subtotal);
                document.getElementById('totalProfit').textContent = formatCurrency(profit);
                document.getElementById('totalAmount').textContent = formatCurrency(total);
                document.getElementById('displayAdvance').textContent = formatCurrency(advanceAmount);

                // Cập nhật trường tiền tạm ứng
                const advanceInput = document.getElementById('quotationAdvance');
                if (advanceInput) {
                    advanceInput.value = advanceAmount;
                }
            }

            async function saveQuotation(event) {
                event.preventDefault();

                // Validation
                const customerId = document.getElementById('quotationCustomer').value;
                if (!customerId) {
                    alert('Vui lòng chọn khách hàng');
                    return;
                }

                // Project không bắt buộc
                const projectId = document.getElementById('quotationProject').value || window.currentQuotationProjectId || null;


                const items = [];
                document.querySelectorAll('#quotationItemsList tr').forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    if (inputs.length >= 5) {
                        const description = inputs[0].value.trim();
                        // Xử lý số có dấu phẩy (format VN: 6000000,00)
                        const quantityStr = inputs[1].value.toString().replace(/,/g, '');
                        const quantity = parseFloat(quantityStr) || 0;
                        const unit = inputs[2].value.trim() || 'bộ';
                        // Xử lý số có dấu phẩy
                        const unitPriceStr = inputs[3].value.toString().replace(/,/g, '');
                        const unitPrice = parseFloat(unitPriceStr) || 0;
                        // Xử lý số có dấu phẩy
                        const totalStr = inputs[4].value.toString().replace(/,/g, '');
                        const total = parseFloat(totalStr) || 0;

                        if (description && quantity > 0) {
                            items.push({
                                item_name: description,
                                description: description,
                                quantity: quantity,
                                unit: unit,
                                unit_price: unitPrice,
                                total_price: total,
                                total: total,
                                item_type: 'material'
                            });
                        }
                    }
                });

                if (items.length === 0) {
                    alert('Vui lòng thêm ít nhất một mục vào báo giá');
                    return;
                }

                // Xử lý tiền tạm ứng - loại bỏ dấu phẩy nếu có
                const advanceInput = document.getElementById('quotationAdvance');
                const advanceAmountStr = advanceInput ? advanceInput.value.toString().replace(/,/g, '') : '0';
                const advanceAmount = parseFloat(advanceAmountStr) || 0;

                const data = {
                    customer_id: customerId,
                    project_id: projectId,
                    quotation_date: document.getElementById('quotationDate').value || new Date().toISOString().split('T')[0],
                    validity_days: 30, // Mặc định 30 ngày
                    status: 'draft',
                    profit_margin_percent: 0, // Không tính lợi nhuận
                    items: items,
                    notes: '',
                    advance_amount: advanceAmount
                };

                console.log('Sending quotation data:', data); // Debug

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const id = editingQuotationId;
                    const url = id ? `${API_BASE}/quotations/${id}` : `${API_BASE}/quotations`;
                    const method = id ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification(id ? 'Cập nhật báo giá thành công!' : 'Tạo báo giá thành công!');
                        resetForm();
                        const quotationsTab = document.querySelector('.tab-button[onclick*="quotations"]');
                        switchTab('quotations', quotationsTab);
                        // Cập nhật thống kê ngay sau khi tạo mới
                        await loadQuotations();
                        await loadQuotationStats();
                    } else {
                        console.error('API Error:', result);
                        alert('Lỗi: ' + (result.message || (id ? 'Không thể cập nhật báo giá' : 'Không thể tạo báo giá')));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            function resetForm() {
                document.getElementById('quotationForm').reset();
                document.getElementById('quotationItemsList').innerHTML = '';
                document.getElementById('quotationProject').innerHTML = '<option value="">-- Chọn dự án --</option>';
                itemCounter = 0;
                editingQuotationId = null;
                calculateTotals();
                document.getElementById('quotationDate').value = new Date().toISOString().split('T')[0];
                window.currentQuotationProjectId = null;
            }

            // Xem chi tiết báo giá
            async function viewQuotation(id) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/quotations/${id}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const result = await response.json();

                    if (result.success && result.data) {
                        const q = result.data;
                        const items = q.items || [];

                        let itemsHtml = items.map(item => `
                        <tr>
                            <td class="px-4 py-2 border">${item.item_name}</td>
                            <td class="px-4 py-2 border text-center">${item.quantity}</td>
                            <td class="px-4 py-2 border text-center">${item.unit}</td>
                            <td class="px-4 py-2 border text-right">${formatCurrency(item.unit_price)}</td>
                            <td class="px-4 py-2 border text-right">${formatCurrency(item.total_price)}</td>
                        </tr>
                    `).join('');

                        const modalHtml = `
                        <div id="viewQuotationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto m-4">
                                <div class="p-6 border-b flex justify-between items-center bg-blue-600 text-white rounded-t-xl">
                                    <h3 class="text-xl font-bold">Chi tiết Báo giá ${q.quotation_code}</h3>
                                    <button onclick="document.getElementById('viewQuotationModal').remove()" class="text-white hover:text-gray-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-2 gap-4 mb-6">
                                        <div><strong>Khách hàng:</strong> ${q.customer_name || 'N/A'}</div>
                                        <div><strong>Ngày tạo:</strong> ${formatDate(q.quotation_date)}</div>
                                        <div><strong>Trạng thái:</strong> ${q.status === 'approved' ? 'Đã chốt' : q.status === 'pending' ? 'Chờ duyệt' : q.status}</div>
                                        <div><strong>Tổng tiền:</strong> ${formatCurrency(q.total_amount)}</div>
                                    </div>
                                    <h4 class="font-bold mb-3">Danh sách vật tư</h4>
                                    <table class="w-full border-collapse border">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 border text-left">Tên sản phẩm</th>
                                                <th class="px-4 py-2 border text-center">SL</th>
                                                <th class="px-4 py-2 border text-center">ĐVT</th>
                                                <th class="px-4 py-2 border text-right">Đơn giá</th>
                                                <th class="px-4 py-2 border text-right">Thành tiền</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${itemsHtml || '<tr><td colspan="5" class="px-4 py-2 text-center text-gray-500">Không có vật tư</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="p-4 border-t flex justify-end">
                                    <button onclick="document.getElementById('viewQuotationModal').remove()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Đóng</button>
                                </div>
                            </div>
                        </div>
                    `;
                        document.body.insertAdjacentHTML('beforeend', modalHtml);
                    } else {
                        alert('Không thể tải thông tin báo giá');
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi khi tải thông tin báo giá: ' + error.message);
                }
            }

            // Sửa báo giá - mở form với dữ liệu cũ
            async function editQuotation(id) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/quotations/${id}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const result = await response.json();

                    if (result.success && result.data) {
                        const q = result.data;
                        const items = q.items || [];

                        // Set editing ID
                        editingQuotationId = id;

                        // Switch to create tab
                        const createTab = document.querySelector('.tab-button[onclick*="create-quotation"]');
                        switchTab('create-quotation', createTab);

                        // Load customers and select current customer
                        await loadCustomersForSelect();
                        document.getElementById('quotationCustomer').value = q.customer_id;

                        // Load projects for customer and select current project
                        if (q.customer_id) {
                            await loadProjectsForCustomer();
                            // Add current project to list if not already there
                            const projectSelect = document.getElementById('quotationProject');
                            if (q.project_id && !projectSelect.querySelector(`option[value="${q.project_id}"]`)) {
                                projectSelect.innerHTML += `<option value="${q.project_id}">Dự án hiện tại (ID: ${q.project_id})</option>`;
                            }
                            projectSelect.value = q.project_id || '';
                            window.currentQuotationProjectId = q.project_id;
                        }

                        // Set date
                        document.getElementById('quotationDate').value = q.quotation_date ? q.quotation_date.split('T')[0] : new Date().toISOString().split('T')[0];

                        // Set advance amount
                        const advanceInput = document.getElementById('quotationAdvance');
                        if (advanceInput) {
                            advanceInput.value = q.advance_amount || 0;
                        }

                        // Clear and add items
                        document.getElementById('quotationItemsList').innerHTML = '';
                        itemCounter = 0;

                        items.forEach(item => {
                            addQuotationItem();
                            const rows = document.querySelectorAll('#quotationItemsList tr');
                            const lastRow = rows[rows.length - 1];
                            const inputs = lastRow.querySelectorAll('input');

                            if (inputs.length >= 5) {
                                inputs[0].value = item.item_name || '';
                                inputs[1].value = item.quantity || 0;
                                inputs[2].value = item.unit || 'bộ';
                                inputs[3].value = item.unit_price || 0;
                                inputs[4].value = item.total_price || 0;
                            }
                        });

                        // Calculate totals
                        calculateTotals();

                        alert('Đang sửa báo giá ' + q.quotation_code + '. Hãy thay đổi và nhấn "Lưu Báo giá" để cập nhật.');
                    } else {
                        alert('Không thể tải thông tin báo giá');
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi khi tải thông tin báo giá: ' + error.message);
                }
            }

            // Xóa báo giá
            async function deleteQuotation(id) {
                if (!confirm('Bạn có chắc chắn muốn xóa báo giá này? Hành động này không thể hoàn tác.')) {
                    return;
                }

                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/quotations/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Xóa báo giá thành công!');
                        await loadQuotations();
                        await loadQuotationStats();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể xóa báo giá'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            async function updateQuotationStatus(id, status) {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                    window.location.href = 'login.html';
                    return;
                }
                const statusTexts = {
                    'approved': 'Đã chốt',
                    'pending': 'Chờ duyệt',
                    'rejected': 'Từ chối',
                    'sent': 'Đã gửi',
                    'draft': 'Mới tạo'
                };

                const statusText = statusTexts[status] || status;

                if (status === 'approved') {
                    // Use workflow to approve
                    const useWorkflow = confirm(`Chuyển báo giá sang trạng thái "${statusText}"?\n\nNếu duyệt, hệ thống sẽ tự động tạo:\n- Lệnh sản xuất\n- Công nợ phải thu\n\nBạn có muốn tiếp tục?`);
                    if (!useWorkflow) return;

                    try {
                        const response = await fetch(`${API_BASE}/workflow/quotations/${id}/approve`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                createProductionOrder: true,
                                createDebt: true,
                                createCommission: false
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert(`Đã chuyển báo giá sang trạng thái "${statusText}"!\n` +
                                (result.data.production_order ? `- Đã tạo lệnh SX: ${result.data.production_order.order_code}\n` : '') +
                                (result.data.debt ? '- Đã tạo công nợ\n' : ''));
                            // Cập nhật ngay lập tức
                            await loadQuotations();
                            await loadQuotationStats();
                        } else {
                            alert('Lỗi: ' + (result.message || 'Không thể cập nhật trạng thái'));
                        }
                    } catch (error) {
                        console.error('Lỗi:', error);
                        alert('Lỗi kết nối server');
                    }
                } else {
                    // Normal status update
                    if (!confirm(`Bạn có chắc muốn chuyển báo giá sang trạng thái "${statusText}"?`)) return;

                    try {
                        const response = await fetch(`${API_BASE}/quotations/${id}/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ status })
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Cập nhật ngay lập tức
                            await loadQuotations();
                            await loadQuotationStats();
                        } else {
                            alert('Lỗi: ' + (result.message || 'Không thể cập nhật trạng thái'));
                        }
                    } catch (error) {
                        console.error('Lỗi:', error);
                        alert('Lỗi kết nối server');
                    }
                }
            }

            async function deleteQuotation(id) {
                if (!confirm('Bạn có chắc muốn xóa báo giá này?')) return;

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/quotations/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Cập nhật ngay sau khi xóa
                        await loadQuotations();
                        await loadQuotationStats();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể xóa'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server');
                }
            }

            async function viewQuotation(id) {
                await viewQuotationDetail(id);
            }

            async function editQuotation(id) {
                // Chuyển sang tab tạo báo giá và load dữ liệu để sửa
                const createTab = document.querySelector('[onclick*="create-quotation"]');
                if (createTab) {
                    createTab.click();
                }

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/quotations/${id}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        const quotation = result.data;
                        editingQuotationId = id;

                        // Điền thông tin vào form
                        document.getElementById('quotationCustomer').value = quotation.customer_id || '';

                        // Load projects cho khách hàng đã chọn
                        if (quotation.customer_id) {
                            await loadProjectsForCustomer();
                            // Đợi một chút để dropdown được populate
                            setTimeout(() => {
                                if (quotation.project_id) {
                                    document.getElementById('quotationProject').value = quotation.project_id;
                                }
                            }, 100);
                        }

                        document.getElementById('quotationDate').value = quotation.quotation_date ? quotation.quotation_date.split('T')[0] : '';

                        // Điền tiền tạm ứng
                        if (quotation.advance_amount) {
                            document.getElementById('quotationAdvance').value = quotation.advance_amount;
                        }

                        // Load items
                        if (quotation.items && quotation.items.length > 0) {
                            itemCounter = 0;
                            const tbody = document.getElementById('quotationItemsList');
                            tbody.innerHTML = '';

                            quotation.items.forEach(item => {
                                itemCounter++;
                                const tr = document.createElement('tr');
                                tr.id = `item-${itemCounter}`;
                                tr.innerHTML = `
                                <td class="px-4 py-3">
                                    <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded" placeholder="Tên sản phẩm/dịch vụ" value="${item.description || item.item_name || ''}" required>
                                </td>
                                <td class="px-4 py-3">
                                    <input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded item-quantity" placeholder="0" value="${item.quantity || 1}" onchange="calculateItemTotal(${itemCounter})" required>
                                </td>
                                <td class="px-4 py-3">
                                    <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded" placeholder="Đơn vị" value="${item.unit || 'bộ'}" required>
                                </td>
                                <td class="px-4 py-3">
                                    <input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded item-price" placeholder="0" value="${item.unit_price || 0}" onchange="calculateItemTotal(${itemCounter})" required>
                                </td>
                                <td class="px-4 py-3">
                                    <input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded item-total" readonly value="${item.total || item.total_price || 0}">
                                </td>
                                <td class="px-4 py-3">
                                    <button type="button" onclick="removeItem(${itemCounter})" class="text-red-600 hover:text-red-800">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </td>
                            `;
                                tbody.appendChild(tr);
                            });

                            // Tính lại tổng tiền
                            calculateQuotationTotal();
                        }

                        // Scroll to form
                        setTimeout(() => {
                            document.getElementById('quotationForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể tải thông tin báo giá'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            function searchCustomers() {
                const searchTerm = document.getElementById('searchCustomer').value;
                loadCustomers(searchTerm);
            }

            // Load Customers with search
            async function loadCustomers(search = '') {
                try {
                    const token = localStorage.getItem('token');
                    const url = search ? `${API_BASE}/customers?search=${encodeURIComponent(search)}` : `${API_BASE}/customers`;
                    const headers = {};
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    const response = await fetch(url, { headers });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        displayCustomers(result.data || []);
                    } else {
                        console.error('API Error:', result.message);
                        displayCustomers([]);
                    }
                } catch (error) {
                    console.error('Lỗi khi tải danh sách khách hàng:', error);
                    const container = document.getElementById('customersList');
                    if (container) {
                        container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-16 h-16 text-red-400 mx-auto mb-4">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <p class="text-red-500 text-lg mb-2">Không thể tải danh sách khách hàng</p>
                            <p class="text-gray-400 text-sm mb-4">${error.message || 'Vui lòng kiểm tra kết nối server'}</p>
                            <button onclick="loadCustomers()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                Thử lại
                            </button>
                        </div>
                    `;
                    }
                }
            }

            async function saveCustomer(event) {
                event.preventDefault();

                const data = {
                    customer_code: document.getElementById('customerCode').value.trim() || null,
                    full_name: document.getElementById('customerName').value,
                    phone: document.getElementById('customerPhone').value,
                    email: document.getElementById('customerEmail').value || null,
                    address: document.getElementById('customerAddress').value || null
                };

                // Validate phone
                if (!data.phone) {
                    document.getElementById('phoneError').classList.remove('hidden');
                    return;
                } else {
                    document.getElementById('phoneError').classList.add('hidden');
                }

                try {
                    const customerId = document.getElementById('customerId').value;
                    const url = customerId ? `${API_BASE}/customers/${customerId}` : `${API_BASE}/customers`;
                    const method = customerId ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        const message = customerId ? 'Cập nhật khách hàng thành công!' : 'Thêm khách hàng thành công!';
                        const description = customerId ? '' : `Mã: ${result.data.customer_code || 'Tự tạo'}`;
                        showSuccessNotification(message, description);
                        closeCustomerModal();
                        loadCustomers();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể lưu'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server');
                }
            }

            // Generate next customer code from API
            async function generateCustomerCode() {
                try {
                    const response = await fetch(`${API_BASE}/customers/next-code`);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.success && result.data && result.data.customer_code) {
                        document.getElementById('customerCode').value = result.data.customer_code;
                    } else {
                        const errorMsg = result.message || 'Không thể tạo mã tự động';
                        console.error('API Error:', result);
                        alert(errorMsg);
                    }
                } catch (error) {
                    console.error('Error generating customer code:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            function openCustomerModal() {
                document.getElementById('customerModal').classList.remove('hidden');
                // Optionally auto-generate code when opening modal
                // generateCustomerCode();
            }

            function closeCustomerModal() {
                document.getElementById('customerModal').classList.add('hidden');
                document.getElementById('customerForm').reset();
                document.getElementById('customerId').value = '';
                document.getElementById('customerCode').value = '';
                document.getElementById('customerModalTitle').textContent = 'Thêm khách hàng mới';
                document.getElementById('customerForm').querySelector('button[type="submit"]').textContent = 'Thêm mới';
            }

            async function editCustomer(id) {
                try {
                    const response = await fetch(`${API_BASE}/customers/${id}`);
                    const result = await response.json();

                    if (result.success) {
                        const customer = result.data;
                        document.getElementById('customerName').value = customer.full_name || '';
                        document.getElementById('customerPhone').value = customer.phone || '';
                        document.getElementById('customerEmail').value = customer.email || '';
                        document.getElementById('customerAddress').value = customer.address || '';
                        document.getElementById('customerId').value = id;

                        document.getElementById('customerModalTitle').textContent = 'Chỉnh sửa khách hàng';
                        document.getElementById('customerForm').querySelector('button[type="submit"]').textContent = 'Cập nhật';
                        openCustomerModal();
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Không thể tải thông tin khách hàng');
                }
            }

            async function deleteCustomer(id) {
                if (!confirm('Bạn có chắc muốn xóa khách hàng này?')) return;

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Vui lòng đăng nhập lại');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/customers/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Xóa khách hàng thành công!');
                        loadCustomers();
                    } else {
                        // Hiển thị thông báo lỗi chi tiết
                        let errorMessage = result.message || 'Không thể xóa khách hàng';

                        // Nếu có thông tin về quotations hoặc projects
                        if (result.data) {
                            const details = [];
                            if (result.data.quotation_count > 0) {
                                details.push(`${result.data.quotation_count} báo giá`);
                            }
                            if (result.data.project_count > 0) {
                                details.push(`${result.data.project_count} dự án`);
                            }
                            if (details.length > 0) {
                                errorMessage += `\n\nKhách hàng đang được sử dụng trong: ${details.join(', ')}`;
                            }
                        }

                        alert(errorMessage);
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server. Vui lòng thử lại sau.');
                }
            }

            function formatCurrency(amount) {
                return new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(amount || 0);
            }

            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN');
            }

            // CRM Functions
            async function viewCustomerCRM(customerId) {
                try {
                    const response = await fetch(`${API_BASE}/customers/${customerId}`);
                    const result = await response.json();

                    if (result.success) {
                        const customer = result.data;
                        document.getElementById('crmCustomerName').textContent = customer.full_name || 'Thông tin CRM';
                        document.getElementById('customerCRMModal').classList.remove('hidden');

                        // Load CRM data
                        await loadCustomerCRMData(customerId);
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Không thể tải thông tin CRM');
                }
            }

            function closeCustomerCRMModal() {
                document.getElementById('customerCRMModal').classList.add('hidden');
            }

            async function loadCustomerCRMData(customerId) {
                try {
                    // Load quotations
                    const quotesResponse = await fetch(`${API_BASE}/quotations?customer_id=${customerId}`);
                    const quotesResult = await quotesResponse.json();

                    if (quotesResult.success) {
                        const quotations = quotesResult.data || [];
                        document.getElementById('crmTotalQuotations').textContent = quotations.length;
                        document.getElementById('crmApprovedQuotations').textContent = quotations.filter(q => q.status === 'approved').length;

                        const totalValue = quotations
                            .filter(q => q.status === 'approved')
                            .reduce((sum, q) => sum + (parseFloat(q.total_amount) || 0), 0);
                        document.getElementById('crmTotalValue').textContent = formatCurrency(totalValue);

                        // Display quotations
                        const tbody = document.getElementById('crmQuotationsList');
                        tbody.innerHTML = quotations.map(q => `
                        <tr>
                            <td class="border border-gray-300 px-4 py-2 text-sm">${q.quotation_code}</td>
                            <td class="border border-gray-300 px-4 py-2 text-sm">${formatDate(q.quotation_date)}</td>
                            <td class="border border-gray-300 px-4 py-2 text-sm text-center">${formatCurrency(q.total_amount)}</td>
                            <td class="border border-gray-300 px-4 py-2 text-sm text-center">
                                <span class="px-2 py-1 rounded-full text-xs ${q.status === 'approved' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                    ${q.status === 'approved' ? 'Đã chốt' : 'Chờ duyệt'}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                    }
                } catch (error) {
                    console.error('Lỗi khi tải dữ liệu CRM:', error);
                }
            }

            function switchCRMTab(tabName, buttonElement) {
                document.querySelectorAll('.crm-tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });
                document.querySelectorAll('.crm-tab-btn').forEach(btn => {
                    btn.classList.remove('active', 'text-blue-600', 'border-blue-600');
                    btn.classList.add('text-gray-600', 'border-transparent');
                });

                document.getElementById('crmTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.remove('hidden');
                buttonElement.classList.add('active', 'text-blue-600', 'border-blue-600');
                buttonElement.classList.remove('text-gray-600', 'border-transparent');
            }

            function openAddAppointmentModal() {
                document.getElementById('addAppointmentModal').classList.remove('hidden');
            }

            function closeAddAppointmentModal() {
                document.getElementById('addAppointmentModal').classList.add('hidden');
                document.getElementById('appointmentForm').reset();
            }

            function openAddInteractionModal() {
                document.getElementById('addInteractionModal').classList.remove('hidden');
            }

            function closeAddInteractionModal() {
                document.getElementById('addInteractionModal').classList.add('hidden');
                document.getElementById('interactionForm').reset();
            }

            async function saveAppointment(event) {
                event.preventDefault();
                // TODO: Implement save appointment
                alert('Chức năng đang được phát triển');
                closeAddAppointmentModal();
            }

            async function saveInteraction(event) {
                event.preventDefault();
                // TODO: Implement save interaction
                alert('Chức năng đang được phát triển');
                closeAddInteractionModal();
            }

            async function updateCustomerStatus() {
                // TODO: Implement update customer status
                alert('Chức năng đang được phát triển');
            }

            async function viewQuotationDetail(id) {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/quotations/${id}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        const quotation = result.data;
                        const statusTexts = {
                            'draft': 'Mới tạo',
                            'sent': 'Đã gửi',
                            'pending': 'Chờ duyệt',
                            'approved': 'Đã chốt',
                            'rejected': 'Từ chối'
                        };

                        let itemsHtml = '';
                        if (quotation.items && quotation.items.length > 0) {
                            itemsHtml = quotation.items.map((item, index) => `
                            <tr>
                                <td class="px-4 py-2 border">${index + 1}</td>
                                <td class="px-4 py-2 border">${item.description || item.item_name || 'N/A'}</td>
                                <td class="px-4 py-2 border text-right">${item.quantity || 0}</td>
                                <td class="px-4 py-2 border text-right">${formatCurrency(item.unit_price || 0)}</td>
                                <td class="px-4 py-2 border text-right font-semibold">${formatCurrency(item.total || item.total_price || 0)}</td>
                            </tr>
                        `).join('');
                        } else {
                            itemsHtml = '<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">Không có mục nào</td></tr>';
                        }

                        const modalHtml = `
                        <div class="fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center p-4">
                            <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                                <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-purple-600 to-blue-600">
                                    <div class="flex justify-between items-center">
                                        <h2 class="text-2xl font-bold text-white">Chi tiết Báo giá: ${quotation.quotation_code || 'N/A'}</h2>
                                        <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-gray-200">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-2 gap-4 mb-6">
                                        <div>
                                            <label class="text-sm font-medium text-gray-600">Khách hàng:</label>
                                            <p class="text-lg font-semibold">${quotation.customer_name || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-gray-600">Ngày tạo:</label>
                                            <p class="text-lg">${formatDate(quotation.quotation_date)}</p>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-gray-600">Trạng thái:</label>
                                            <p class="text-lg">
                                                <span class="px-3 py-1 rounded-full text-sm ${quotation.status === 'approved' ? 'bg-green-100 text-green-700' : quotation.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : quotation.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'}">
                                                    ${statusTexts[quotation.status] || quotation.status}
                                                </span>
                                            </p>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-gray-600">Tổng tiền:</label>
                                            <p class="text-2xl font-bold text-green-600">${formatCurrency(quotation.total_amount || 0)}</p>
                                        </div>
                                    </div>
                                    <div class="mb-6">
                                        <h3 class="text-lg font-semibold mb-3">Danh sách mục</h3>
                                        <table class="w-full border-collapse border border-gray-300">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-2 border text-left">STT</th>
                                                    <th class="px-4 py-2 border text-left">Mô tả</th>
                                                    <th class="px-4 py-2 border text-right">Số lượng</th>
                                                    <th class="px-4 py-2 border text-right">Đơn giá</th>
                                                    <th class="px-4 py-2 border text-right">Thành tiền</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${itemsHtml}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="flex justify-end gap-4">
                                        <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                            Đóng
                                        </button>
                                        <button onclick="editQuotation(${quotation.id}); this.closest('.fixed').remove();" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                            Sửa
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                        document.body.insertAdjacentHTML('beforeend', modalHtml);
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể tải thông tin báo giá'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            // BOM Functions
            function openCalculateFromBOMModal() {
                document.getElementById('calculateBOMModal').classList.remove('hidden');
                loadProjectsForBOM();
            }

            function closeCalculateBOMModal() {
                document.getElementById('calculateBOMModal').classList.add('hidden');
            }

            async function loadProjectsForBOM() {
                try {
                    const response = await fetch(`${API_BASE}/projects`);
                    const result = await response.json();

                    if (result.success) {
                        const select = document.getElementById('bomProjectSelect');
                        select.innerHTML = '<option value="">-- Chọn dự án --</option>';
                        result.data.forEach(project => {
                            select.innerHTML += `<option value="${project.id}">${project.project_code} - ${project.project_name}</option>`;
                        });
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            async function loadDoorsForBOM() {
                const projectId = document.getElementById('bomProjectSelect').value;
                if (!projectId) {
                    document.getElementById('bomDoorsList').innerHTML = '<p class="text-gray-500 text-sm">Vui lòng chọn dự án trước</p>';
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/quotations/projects/${projectId}/doors`);
                    const result = await response.json();

                    if (result.success) {
                        const doors = result.data || [];
                        const container = document.getElementById('bomDoorsList');

                        if (doors.length === 0) {
                            container.innerHTML = '<p class="text-gray-500 text-sm">Dự án này chưa có cửa nào</p>';
                            return;
                        }

                        container.innerHTML = doors.map(door => {
                            const doorName = door.design_code || `Cửa ${door.id}`;
                            const doorInfo = door.width_mm && door.height_mm
                                ? ` (${(door.width_mm / 1000).toFixed(1)}m × ${(door.height_mm / 1000).toFixed(1)}m)`
                                : '';
                            const bomStatus = door.bom_items_count > 0
                                ? `<span class="text-xs text-green-600">(Đã có BOM)</span>`
                                : `<span class="text-xs text-yellow-600">(Chưa có BOM)</span>`;

                            return `
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer border border-gray-200 rounded-lg mb-2">
                                <input type="checkbox" value="${door.id}" class="door-checkbox" name="door-${door.id}">
                                <div class="flex-1">
                                    <div class="font-medium">${doorName}${doorInfo}</div>
                                    ${door.aluminum_name ? `<div class="text-xs text-gray-500">${door.aluminum_name}</div>` : ''}
                                    ${bomStatus}
                                </div>
                            </label>
                        `;
                        }).join('');
                    } else {
                        document.getElementById('bomDoorsList').innerHTML = '<p class="text-red-500 text-sm">Lỗi: ' + (result.message || 'Không thể tải danh sách cửa') + '</p>';
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    document.getElementById('bomDoorsList').innerHTML = '<p class="text-red-500 text-sm">Lỗi khi tải danh sách cửa: ' + error.message + '</p>';
                }
            }

            async function calculateQuotationFromBOM() {
                const projectId = document.getElementById('bomProjectSelect').value;
                const selectedDoors = Array.from(document.querySelectorAll('.door-checkbox:checked')).map(cb => parseInt(cb.value));

                if (!projectId) {
                    alert('Vui lòng chọn dự án');
                    return;
                }

                if (selectedDoors.length === 0) {
                    alert('Vui lòng chọn ít nhất một cửa');
                    return;
                }

                const glassPricePerM2 = parseFloat(document.getElementById('glassPricePerM2').value) || 0;
                const aluminumPricePerKg = parseFloat(document.getElementById('aluminumPricePerKg').value) || 0;
                const installationCostPerM2 = parseFloat(document.getElementById('installationCostPerM2').value) || 0;
                const installationCostFixed = parseFloat(document.getElementById('installationCostFixed').value) || 0;

                try {
                    const response = await fetch(`${API_BASE}/quotations/calculate-from-bom`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            projectId: parseInt(projectId),
                            doorIds: selectedDoors,
                            glassPricePerM2: glassPricePerM2,
                            aluminumPricePerKg: aluminumPricePerKg,
                            installationCostPerM2: installationCostPerM2 || null,
                            installationCostFixed: installationCostFixed || null
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Điền dữ liệu vào form báo giá
                        const items = result.data.items || [];
                        const summary = result.data.summary || {};

                        // Hiển thị cảnh báo tồn kho nếu có
                        if (result.data.stock_warnings && result.data.stock_warnings.length > 0) {
                            const warnings = result.data.stock_warnings;
                            const isInsufficient = result.data.stock_status === 'insufficient';
                            let warningMsg = isInsufficient
                                ? '⚠️ CẢNH BÁO: Một số vật liệu không đủ trong kho:\n\n'
                                : '⚠️ Cảnh báo tồn kho:\n\n';

                            warnings.forEach(w => {
                                warningMsg += `• ${w.message}\n`;
                            });

                            if (isInsufficient) {
                                warningMsg += '\nVui lòng nhập thêm vật liệu trước khi sản xuất!';
                            }

                            alert(warningMsg);
                        }

                        // Xóa các items cũ
                        document.getElementById('quotationItemsList').innerHTML = '';
                        itemCounter = 0;

                        // Thêm các items mới
                        const tbody = document.getElementById('quotationItemsList');
                        items.forEach(item => {
                            itemCounter++;
                            const tr = document.createElement('tr');
                            tr.id = `item-${itemCounter}`;
                            tr.innerHTML = `
                            <td class="px-4 py-3">
                                <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded" value="${escapeHtml(item.item_name)}" required>
                            </td>
                            <td class="px-4 py-3">
                                <input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded item-quantity" value="${item.quantity}" onchange="calculateItemTotal(${itemCounter})" required>
                            </td>
                            <td class="px-4 py-3">
                                <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded" value="${escapeHtml(item.unit)}" required>
                            </td>
                            <td class="px-4 py-3">
                                <input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded item-price" value="${item.unit_price}" onchange="calculateItemTotal(${itemCounter})" required>
                            </td>
                            <td class="px-4 py-3">
                                <input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded item-total" readonly value="${item.total_price}">
                            </td>
                            <td class="px-4 py-3">
                                <button type="button" onclick="removeItem(${itemCounter})" class="text-red-600 hover:text-red-800">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </td>
                        `;
                            tbody.appendChild(tr);
                        });

                        // Cập nhật tổng tiền
                        calculateTotals();

                        // Đóng modal
                        closeCalculateBOMModal();

                        const successMsg = `Đã tính toán thành công!\n- Tổng diện tích kính: ${summary.total_glass_area_m2?.toFixed(2) || 0} m²\n- Tổng khối lượng nhôm: ${summary.total_aluminum_weight_kg?.toFixed(2) || 0} kg\n- Tổng phụ kiện: ${summary.total_accessories || 0} cái`;

                        // Chỉ hiển thị thông báo thành công nếu không có cảnh báo nghiêm trọng
                        if (!result.data.stock_warnings || result.data.stock_status !== 'insufficient') {
                            alert(successMsg);
                        }
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể tính toán từ BOM'));
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server: ' + error.message);
                }
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Initialize
            // Function to initialize page data
            function initializeSalesPage() {
                loadCompanyLogo();

                if (checkAuth()) {
                    loadSidebarUserInfo();
                    loadHeaderUserInfo();
                    loadUnreadCount();

                    // Refresh notifications every 30 seconds
                    setInterval(() => {
                        loadUnreadCount();
                    }, 30000);
                }

                loadCustomers();
            }

            // Listen for both DOMContentLoaded and SPA navigation
            document.addEventListener('DOMContentLoaded', function () {
                initializeSalesPage();

                // Check if URL has #projects hash to auto-switch to projects tab
                if (window.location.hash === '#projects') {
                    setTimeout(() => {
                        const projectsButton = document.querySelector('.tab-button[onclick*="projects"]');
                        if (projectsButton) {
                            switchTab('projects', projectsButton);
                        }
                    }, 100);
                }
            });

            // Listen for SPA page load event
            document.addEventListener('spaPageLoad', function (e) {
                if (e.detail.href && e.detail.href.includes('sales.html')) {
                    // Small delay to ensure DOM is ready
                    setTimeout(initializeSalesPage, 100);

                    // Check hash for projects tab
                    if (window.location.hash === '#projects') {
                        setTimeout(() => {
                            const projectsButton = document.querySelector('.tab-button[onclick*="projects"]');
                            if (projectsButton) {
                                switchTab('projects', projectsButton);
                            }
                        }, 200);
                    }
                }
            });

            // ========== PROJECT MANAGEMENT FUNCTIONS ==========

            // Load projects
            async function loadProjects() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    const statusEl = document.getElementById('filterProjectStatus') || document.getElementById('statusFilter');
                    const progressEl = document.getElementById('filterProjectProgress') || document.getElementById('progressFilter');
                    const searchEl = document.getElementById('searchProject') || document.getElementById('searchProjectInput');
                    const status = statusEl?.value || 'all';
                    const progress = progressEl?.value || 'all';
                    const search = searchEl?.value || '';

                    let url = `${API_BASE}/projects`;
                    const params = [];
                    if (status !== 'all') params.push(`status=${status}`);
                    if (search) params.push(`search=${encodeURIComponent(search)}`);
                    if (params.length > 0) url += '?' + params.join('&');

                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const result = await response.json();

                    if (result.success) {
                        let projects = result.data || [];

                        // Filter by progress if needed
                        if (progress !== 'all') {
                            const [min, max] = progress.split('-').map(p => parseInt(p));
                            projects = projects.filter(p => {
                                const prog = p.progress_percent || 0;
                                if (progress === '100') return prog === 100;
                                return prog >= min && prog < (max || 100);
                            });
                        }

                        displayProjects(projects);
                        loadProjectStats(projects);
                        loadProjectsKPI(projects);
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }

            // Load project statistics
            function loadProjectStats(projects) {
                const total = projects.length;
                const running = projects.filter(p => ['planning', 'waiting_quotation', 'quotation_approved', 'in_production', 'installation'].includes(p.status)).length;
                const pendingQuotations = projects.filter(p => p.status === 'waiting_quotation').length;
                const completed = projects.filter(p => p.status === 'completed' || p.status === 'handover').length;
                const totalValue = projects.reduce((sum, p) => sum + (parseFloat(p.total_value) || 0), 0);

                // Update stats only if elements exist
                const statTotalProjects = document.getElementById('statTotalProjects');
                const statRunningProjects = document.getElementById('statRunningProjects');
                const statPendingQuotations = document.getElementById('statPendingQuotations');
                const statCompletedProjects = document.getElementById('statCompletedProjects');
                const statTotalValue = document.getElementById('statTotalValue');

                if (statTotalProjects) statTotalProjects.textContent = total;
                if (statRunningProjects) statRunningProjects.textContent = running;
                if (statPendingQuotations) statPendingQuotations.textContent = pendingQuotations;
                if (statCompletedProjects) statCompletedProjects.textContent = completed;
                if (statTotalValue) statTotalValue.textContent = formatCurrency(totalValue);
            }

            // Display projects in table format
            function displayProjects(projects) {
                const tbody = document.getElementById('projectsTableBody');

                // Nếu không có table body, dùng render cards thay thế
                if (!tbody) {
                    renderProjectCards(projects);
                    return;
                }

                tbody.innerHTML = '';

                if (projects.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-12 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                <p class="text-lg font-medium">Chưa có dự án nào</p>
                                <p class="text-sm text-gray-400 mt-1">Hãy tạo dự án mới để bắt đầu</p>
                            </div>
                        </td>
                    </tr>
                `;
                    return;
                }

                projects.forEach(project => {
                    const row = createProjectTableRow(project);
                    tbody.innerHTML += row;
                });
            }

            // Create project table row
            function createProjectTableRow(project) {
                const statusColors = {
                    'planning': 'bg-gray-100 text-gray-700',
                    'waiting_quotation': 'bg-yellow-100 text-yellow-700',
                    'quotation_approved': 'bg-blue-100 text-blue-700',
                    'in_production': 'bg-purple-100 text-purple-700',
                    'installation': 'bg-indigo-100 text-indigo-700',
                    'handover': 'bg-green-100 text-green-700',
                    'completed': 'bg-green-100 text-green-700',
                    'cancelled': 'bg-red-100 text-red-700'
                };

                const statusLabels = {
                    'planning': 'Đang lập kế hoạch',
                    'waiting_quotation': 'Chờ báo giá',
                    'quotation_approved': 'Đã duyệt báo giá',
                    'in_production': 'Đang sản xuất',
                    'installation': 'Đang lắp đặt',
                    'handover': 'Đã bàn giao',
                    'completed': 'Hoàn thành',
                    'cancelled': 'Đã hủy'
                };

                const progress = project.progress_percent || 0;
                const status = project.status || 'planning';
                const statusColor = statusColors[status] || 'bg-gray-100 text-gray-700';
                const statusLabel = statusLabels[status] || status;

                // Calculate days remaining
                const deadline = project.deadline ? new Date(project.deadline) : null;
                const today = new Date();
                const daysRemaining = deadline ? Math.ceil((deadline - today) / (1000 * 60 * 60 * 24)) : null;
                const daysRemainingClass = daysRemaining !== null ? (daysRemaining < 0 ? 'text-red-600' : daysRemaining < 7 ? 'text-orange-600' : 'text-gray-600') : 'text-gray-600';

                return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm font-semibold text-gray-900">${escapeHtml(project.project_code || 'N/A')}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm font-medium text-gray-900">${escapeHtml(project.project_name || 'N/A')}</div>
                        ${project.notes ? `<div class="text-xs text-gray-500 mt-1">${escapeHtml(project.notes.substring(0, 50))}${project.notes.length > 50 ? '...' : ''}</div>` : ''}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${escapeHtml(project.customer_name || 'N/A')}</div>
                        ${project.customer_phone ? `<div class="text-xs text-gray-500">${escapeHtml(project.customer_phone)}</div>` : ''}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                            ${statusLabel}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center gap-2">
                            <div class="flex-1 bg-gray-200 rounded-full h-2 min-w-[60px]">
                                <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-300" 
                                     style="width: ${progress}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-900 w-12 text-right">${progress}%</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
                        ${formatDate(project.start_date)}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${formatDate(project.deadline)}</div>
                        ${daysRemaining !== null ? `<div class="text-xs ${daysRemainingClass} font-medium">${daysRemaining < 0 ? `Quá hạn ${Math.abs(daysRemaining)} ngày` : daysRemaining === 0 ? 'Hôm nay' : `Còn ${daysRemaining} ngày`}</div>` : ''}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm font-semibold text-green-600">${formatCurrency(project.total_value || 0)}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="viewProjectDetails(${project.id})" 
                                    class="p-1.5 text-blue-600 hover:bg-blue-50 rounded transition-colors" 
                                    title="Xem chi tiết">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </button>
                            <button onclick="editProject(${project.id})" 
                                    class="p-1.5 text-purple-600 hover:bg-purple-50 rounded transition-colors" 
                                    title="Sửa">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button onclick="manageProjectPhases(${project.id})" 
                                    class="p-1.5 text-indigo-600 hover:bg-indigo-50 rounded transition-colors" 
                                    title="Quản lý giai đoạn">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                </svg>
                            </button>
                            <button onclick="deleteProject(${project.id})" 
                                    class="p-1.5 text-red-600 hover:bg-red-50 rounded transition-colors" 
                                    title="Xóa">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }

            // Search projects
            function searchProjects() {
                loadProjects();
            }

            // View project details
            async function viewProjectDetails(projectId) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const result = await response.json();

                    if (result.success && result.data) {
                        const project = result.data;
                        showProjectDetailModal(project);
                    } else {
                        alert('Không thể tải chi tiết dự án');
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server');
                }
            }

            // Show project detail modal
            async function showProjectDetailModal(project) {
                // Create comprehensive project detail modal
                const modal = document.createElement('div');
                modal.id = 'projectDetailModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold">Chi tiết dự án</h2>
                            <p class="text-sm opacity-90 mt-1">${escapeHtml(project.project_code || 'N/A')}</p>
                        </div>
                        <button onclick="closeProjectDetailModal()" class="text-white hover:text-gray-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-2 gap-6 mb-6">
                            <div>
                                <h3 class="text-lg font-bold mb-4">Thông tin cơ bản</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm text-gray-600">Tên dự án</label>
                                        <p class="font-medium">${escapeHtml(project.project_name || 'N/A')}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600">Mã dự án</label>
                                        <p class="font-medium">${escapeHtml(project.project_code || 'N/A')}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600">Trạng thái</label>
                                        <p class="font-medium">${getStatusLabel(project.status)}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600">Tiến độ</label>
                                        <div class="flex items-center gap-2 mt-1">
                                            <div class="flex-1 bg-gray-200 rounded-full h-2">
                                                <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full" style="width: ${project.progress_percent || 0}%"></div>
                                            </div>
                                            <span class="text-sm font-medium">${project.progress_percent || 0}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold mb-4">Thông tin khách hàng</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm text-gray-600">Tên khách hàng</label>
                                        <p class="font-medium">${escapeHtml(project.customer_name || 'N/A')}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600">Số điện thoại</label>
                                        <p class="font-medium">${escapeHtml(project.customer_phone || 'N/A')}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600">Email</label>
                                        <p class="font-medium">${escapeHtml(project.customer_email || 'N/A')}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600">Địa chỉ</label>
                                        <p class="font-medium">${escapeHtml(project.customer_address || 'N/A')}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-6 mb-6">
                            <div>
                                <h3 class="text-lg font-bold mb-4">Thời gian</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm text-gray-600">Ngày bắt đầu</label>
                                        <p class="font-medium">${formatDate(project.start_date)}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600">Ngày kết thúc dự kiến</label>
                                        <p class="font-medium">${formatDate(project.deadline)}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600">Ngày tạo</label>
                                        <p class="font-medium">${formatDate(project.created_at)}</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold mb-4">Tài chính</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm text-gray-600">Tổng giá trị</label>
                                        <p class="font-medium text-green-600 text-lg">${formatCurrency(project.total_value || 0)}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600">Đã thanh toán</label>
                                        <p class="font-medium text-blue-600">${formatCurrency(project.paid_amount || 0)}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600">Còn lại</label>
                                        <p class="font-medium text-orange-600">${formatCurrency((project.total_value || 0) - (project.paid_amount || 0))}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${project.notes ? `
                        <div class="mb-6">
                            <h3 class="text-lg font-bold mb-4">Ghi chú</h3>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-sm text-gray-700 whitespace-pre-wrap">${escapeHtml(project.notes)}</p>
                            </div>
                        </div>
                        ` : ''}
                        <div class="flex justify-end gap-3">
                            <button onclick="closeProjectDetailModal()" 
                                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Đóng
                            </button>
                            <button onclick="editProject(${project.id}); closeProjectDetailModal();" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Chỉnh sửa
                            </button>
                        </div>
                    </div>
                </div>
            `;
                document.body.appendChild(modal);
            }

            // Close project detail modal
            function closeProjectDetailModal() {
                const modal = document.getElementById('projectDetailModal');
                if (modal) {
                    modal.remove();
                }
            }

            // Get status label
            function getStatusLabel(status) {
                const labels = {
                    'planning': 'Đang lập kế hoạch',
                    'waiting_quotation': 'Chờ báo giá',
                    'quotation_approved': 'Đã duyệt báo giá',
                    'in_production': 'Đang sản xuất',
                    'installation': 'Đang lắp đặt',
                    'handover': 'Đã bàn giao',
                    'completed': 'Hoàn thành',
                    'cancelled': 'Đã hủy'
                };
                return labels[status] || status;
            }

            // Manage project phases
            function manageProjectPhases(projectId) {
                window.location.href = `projects.html?projectId=${projectId}&tab=phases`;
            }

            // Export projects to Excel
            function exportProjects() {
                alert('Chức năng xuất Excel đang được phát triển');
            }

            // Edit project
            function editProject(projectId) {
                window.location.href = `projects.html?edit=${projectId}`;
            }

            // Delete project
            async function deleteProject(projectId) {
                if (!confirm('Bạn có chắc chắn muốn xóa dự án này?')) {
                    return;
                }

                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const result = await response.json();

                    if (result.success) {
                        loadProjects();
                        showSuccessNotification('Đã xóa dự án thành công');
                    } else {
                        alert('Lỗi: ' + result.message);
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi khi xóa dự án');
                }
            }

            // Open project modal (create new)
            function openProjectModal() {
                const modal = document.getElementById('createProjectModal');
                if (!modal) {
                    console.error('Create project modal not found');
                    return;
                }

                modal.classList.remove('hidden');

                // Load customers
                loadCustomersForProjectModal().catch(err => {
                    console.error('Error loading customers:', err);
                });

                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                const startDateInput = document.getElementById('projectStartDate');
                const deadlineInput = document.getElementById('projectDeadline');

                if (startDateInput) {
                    startDateInput.value = today;
                }

                if (deadlineInput) {
                    const nextMonth = new Date();
                    nextMonth.setMonth(nextMonth.getMonth() + 1);
                    deadlineInput.value = nextMonth.toISOString().split('T')[0];
                }

                // Auto-generate project code
                generateProjectCodeForModal().catch(err => {
                    console.error('Error generating project code:', err);
                });
            }

            // Close create project modal
            function closeCreateProjectModal() {
                const modal = document.getElementById('createProjectModal');
                if (modal) {
                    modal.classList.add('hidden');
                }
                const form = document.getElementById('createProjectForm');
                if (form) {
                    form.reset();
                }
            }

            // Generate project code
            async function generateProjectCodeForModal() {
                try {
                    const token = localStorage.getItem('token');

                    // Get existing project codes to avoid duplicates
                    const response = await fetch(`${API_BASE}/projects`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    let existingCodes = [];
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            existingCodes = result.data.map(p => p.project_code);
                        }
                    }

                    // Find all CTVR codes and get the highest number
                    const ctvrCodes = existingCodes.filter(code => code && code.startsWith('CTVR'));
                    let maxNumber = 0;

                    ctvrCodes.forEach(code => {
                        const match = code.match(/^CTVR(\d+)$/);
                        if (match) {
                            const num = parseInt(match[1], 10);
                            if (num > maxNumber) {
                                maxNumber = num;
                            }
                        }
                    });

                    // Generate next code: CTVR001, CTVR002, CTVR003, etc.
                    const nextNumber = maxNumber + 1;
                    const newCode = `CTVR${nextNumber.toString().padStart(3, '0')}`;

                    const codeInput = document.getElementById('projectCode');
                    if (codeInput) {
                        codeInput.value = newCode;
                    }
                } catch (error) {
                    console.error('Error generating project code:', error);
                    // Fallback: start from CTVR001 if error
                    const codeInput = document.getElementById('projectCode');
                    if (codeInput) {
                        codeInput.value = 'CTVR001';
                    }
                }
            }

            // Load customers for project modal
            async function loadCustomersForProjectModal() {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/customers`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    const select = document.getElementById('projectCustomerId');
                    if (!select) {
                        console.error('Customer select element not found');
                        return;
                    }

                    select.innerHTML = '<option value="">-- Chọn khách hàng --</option>';

                    if (result.success && result.data && result.data.length > 0) {
                        result.data.forEach(customer => {
                            const option = document.createElement('option');
                            option.value = customer.id;
                            option.textContent = `${customer.full_name || 'N/A'} - ${customer.phone || ''}`;
                            select.appendChild(option);
                        });
                    } else {
                        console.warn('No customers found or invalid response:', result);
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '-- Chưa có khách hàng --';
                        select.appendChild(option);
                    }
                } catch (error) {
                    console.error('Lỗi khi tải danh sách khách hàng:', error);
                    const select = document.getElementById('projectCustomerId');
                    if (select) {
                        select.innerHTML = '<option value="">-- Lỗi khi tải danh sách --</option>';
                    }
                }
            }

            // Save project
            async function saveProjectInTab(event) {
                event.preventDefault();

                // Get form values
                const projectCode = document.getElementById('projectCode')?.value.trim();
                const projectName = document.getElementById('projectName')?.value.trim();
                const customerId = document.getElementById('projectCustomerId')?.value;
                const startDate = document.getElementById('projectStartDate')?.value;
                const deadline = document.getElementById('projectDeadline')?.value;
                const notes = document.getElementById('projectNotes')?.value.trim();

                // Frontend validation
                if (!projectCode) {
                    alert('Vui lòng nhập mã dự án');
                    document.getElementById('projectCode')?.focus();
                    return;
                }

                if (!projectName) {
                    alert('Vui lòng nhập tên dự án');
                    document.getElementById('projectName')?.focus();
                    return;
                }

                if (!customerId) {
                    alert('Vui lòng chọn khách hàng');
                    document.getElementById('projectCustomerId')?.focus();
                    return;
                }

                if (!startDate) {
                    alert('Vui lòng chọn ngày bắt đầu');
                    document.getElementById('projectStartDate')?.focus();
                    return;
                }

                if (!deadline) {
                    alert('Vui lòng chọn ngày giao dự kiến');
                    document.getElementById('projectDeadline')?.focus();
                    return;
                }

                // Validate dates
                const startDateObj = new Date(startDate);
                const deadlineDateObj = new Date(deadline);

                if (deadlineDateObj < startDateObj) {
                    alert('Ngày giao dự kiến phải sau ngày bắt đầu');
                    document.getElementById('projectDeadline')?.focus();
                    return;
                }

                const projectData = {
                    project_code: projectCode,
                    project_name: projectName,
                    customer_id: parseInt(customerId),
                    start_date: startDate,
                    deadline: deadline,
                    status: 'new',
                    notes: notes || null
                };

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                        return;
                    }

                    const response = await fetch(`${API_BASE}/projects`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(projectData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccessNotification('Tạo dự án thành công!');
                        closeCreateProjectModal();
                        // Reload projects list
                        if (typeof loadProjectsInTab === 'function') {
                            await loadProjectsInTab();
                        }
                    } else {
                        const errorMsg = result.message || 'Không thể tạo dự án';
                        alert('Lỗi: ' + errorMsg);
                        console.error('Error creating project:', result);
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi kết nối server. Vui lòng kiểm tra kết nối mạng và thử lại.');
                }
            }

            // Open add customer modal from project modal
            function openAddCustomerModalFromProject() {
                // Close project modal temporarily
                closeCreateProjectModal();
                // Open customer modal
                if (typeof openCustomerModal === 'function') {
                    openCustomerModal();
                } else {
                    alert('Vui lòng thêm khách hàng tại tab "Quản lý Khách hàng"');
                }
            }

            // Format currency helper
            function formatCurrency(amount) {
                if (!amount) return '0₫';
                return new Intl.NumberFormat('vi-VN').format(amount) + '₫';
            }

            // Format date helper
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN');
            }

            // Escape HTML helper
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Load company logo and name
            async function loadCompanyLogo() {
                try {
                    const response = await fetch(`${API_BASE}/company-settings`);
                    const result = await response.json();

                    if (result.success && result.data) {
                        // Load logo
                        if (result.data.logo_path) {
                            const logoImg = document.getElementById('companyLogo');
                            const logoIcon = document.getElementById('companyLogoIcon');
                            if (logoImg && logoIcon) {
                                logoImg.src = result.data.logo_path;
                                logoImg.classList.remove('hidden');
                                logoIcon.classList.add('hidden');
                            }
                        }

                        // Load company name
                        const companyNameEl = document.getElementById('companyName');
                        if (companyNameEl && result.data.company_name) {
                            companyNameEl.textContent = result.data.company_name;
                        }
                    }
                } catch (error) {
                    console.error('Lỗi load logo:', error);
                }
            }

            // ====== PROJECT CARDS FUNCTIONS ======
            let projectCardsData = []; // Store projects data for filtering

            // Load and render project cards
            async function loadProjectCards() {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/projects`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const result = await response.json();

                    if (result.success && result.data) {
                        // Filter out completed projects
                        projectCardsData = (result.data || []).filter(project => {
                            const status = (project.status || '').toLowerCase();
                            const progress = parseFloat(project.progress_percent) || 0;
                            return status !== 'completed' && progress < 100;
                        });

                        // Update heading with count
                        const heading = document.getElementById('projectsHeading');
                        if (heading) {
                            heading.innerHTML = `Dự án đang triển khai <span class="text-blue-600">(${projectCardsData.length})</span>`;
                        }

                        // Render project cards
                        renderProjectCards(projectCardsData);

                        // Update KPI counts
                        loadProjectsKPI(result.data);
                    } else {
                        console.error('Failed to load projects:', result.message);
                        const container = document.getElementById('projectsContainer');
                        if (container) {
                            container.innerHTML = '<p class="text-center text-red-500 py-8">Lỗi khi tải dữ liệu dự án</p>';
                        }
                    }
                } catch (error) {
                    console.error('Error loading projects:', error);
                    const container = document.getElementById('projectsContainer');
                    if (container) {
                        container.innerHTML = '<p class="text-center text-red-500 py-8">Lỗi kết nối server</p>';
                    }
                }
            }

            // Render project cards
            function renderProjectCards(projects) {
                const container = document.getElementById('projectsContainer');
                if (!container) return;

                container.innerHTML = '';

                if (projects.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 py-8">Chưa có dự án nào. Hãy tạo dự án mới!</p>';
                    return;
                }

                projects.forEach(project => {
                    try {
                        const cardHTML = createProjectCardHTML(project);
                        container.insertAdjacentHTML('beforeend', cardHTML);
                    } catch (error) {
                        console.error('Error creating card for project:', project.id, error);
                    }
                });
            }

            // Create project card HTML
            function createProjectCardHTML(project) {
                const progress = project.progress_percent || 0;
                const status = project.status || 'new';
                const customerName = project.customer_name || 'N/A';
                const customerPhone = project.customer_phone || '';
                const projectCode = project.project_code || '';
                const projectName = project.project_name || 'N/A';
                const startDate = project.start_date ? formatDate(project.start_date) : 'N/A';
                const deadline = project.deadline ? formatDate(project.deadline) : 'N/A';
                const totalValue = project.total_value ? formatCurrency(project.total_value) : '0₫';

                // Determine status badge
                var statusBadge = '';
                if (status === 'approved' || status === 'quotation_approved') {
                    statusBadge = '<span class="status-badge bg-green-100 text-green-700"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>Đã duyệt</span>';
                } else if (status === 'pending' || status === 'quotation_pending' || status === 'waiting_quotation') {
                    statusBadge = '<span class="status-badge bg-yellow-100 text-yellow-700"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Chờ duyệt</span>';
                } else if (status === 'in_production') {
                    statusBadge = '<span class="status-badge bg-blue-100 text-blue-700">Đang sản xuất</span>';
                } else if (status === 'installation') {
                    statusBadge = '<span class="status-badge bg-purple-100 text-purple-700">Đang lắp đặt</span>';
                } else {
                    statusBadge = '<span class="status-badge bg-gray-100 text-gray-600">Mới</span>';
                }

                // Determine progress color
                var progressColor = 'bg-gray-400';
                if (progress >= 75) progressColor = 'bg-green-500';
                else if (progress >= 50) progressColor = 'bg-blue-500';
                else if (progress >= 25) progressColor = 'bg-orange-500';

                // Workflow steps
                var workflowSteps = ['Báo giá', 'Thiết kế', 'Bóc tách', 'Sản xuất', 'Lắp đặt', 'Bàn giao'];
                var progressNum = parseFloat(progress) || 0;
                var completedSteps = 0;

                // Xác định số bước hoàn thành dựa trên status VÀ progress
                if (progressNum >= 95 || status === 'completed' || status === 'handover') {
                    completedSteps = 6; // Tất cả hoàn thành
                } else if (status === 'installation' || progressNum >= 80) {
                    completedSteps = 5; // Đến Lắp đặt
                } else if (status === 'in_production' || status === 'production' || progressNum >= 50) {
                    completedSteps = 4; // Đến Sản xuất (Báo giá, Thiết kế, Bóc tách đã xong)
                } else if (status === 'bom_extraction' || status === 'design' || progressNum >= 35) {
                    completedSteps = 3; // Đến Bóc tách
                } else if (status === 'quotation_approved' || status === 'approved' || project.contract_locked || progressNum >= 20) {
                    completedSteps = 2; // Đến Thiết kế
                } else if (status === 'quotation_pending' || status === 'waiting_quotation' || project.quote_locked || progressNum >= 10) {
                    completedSteps = 1; // Đến Báo giá
                } else {
                    completedSteps = 0; // Mới tạo
                }

                var workflowHTML = '';
                workflowSteps.forEach(function (step, index) {
                    var isActive = index < completedSteps;
                    workflowHTML += '<div class="workflow-step">';
                    workflowHTML += '<div class="workflow-step-circle ' + (isActive ? 'active' : 'inactive') + '">';
                    workflowHTML += isActive ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>' : '—';
                    workflowHTML += '</div>';
                    workflowHTML += '<span class="text-xs text-center mt-1">' + step + '</span>';
                    workflowHTML += '</div>';
                });


                var customerPhoneHTML = '';
                if (customerPhone) {
                    customerPhoneHTML = '<span class="flex items-center gap-1">' +
                        '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />' +
                        '</svg>' + escapeHtml(customerPhone) + '</span>';
                }

                var html = '';
                html += '<div class="project-card bg-white shadow-lg rounded-2xl p-6 fade-in" ';
                html += 'data-status="' + status + '" ';
                html += 'data-progress="' + progress + '" ';
                html += 'data-name="' + escapeHtml(projectName) + '" ';
                html += 'data-customer="' + escapeHtml(customerName) + '" ';
                html += 'data-phone="' + customerPhone + '" ';
                html += 'data-code="' + projectCode + '" ';
                html += 'data-project-id="' + project.id + '">';

                html += '<div class="flex justify-between items-start mb-4">';
                html += '<div class="flex-1">';
                html += '<div class="flex items-center gap-3 mb-2">';
                html += '<h3 class="text-xl font-bold">' + escapeHtml(projectName) + '</h3>';
                html += '<span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">' + escapeHtml(projectCode) + '</span>';
                html += '</div>';
                html += '<div class="flex items-center gap-4 text-sm text-gray-600 mb-3">';
                html += '<span class="flex items-center gap-1">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">';
                html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />';
                html += '</svg>' + escapeHtml(customerName) + '</span>';
                html += customerPhoneHTML;
                html += '</div></div>';

                html += '<div class="text-right">';
                html += '<div class="text-sm text-gray-600 mb-1">Ngày bắt đầu: <span class="font-medium">' + startDate + '</span></div>';
                html += '<div class="text-sm text-gray-600 mb-1">Ngày giao: <span class="font-medium">' + deadline + '</span></div>';
                html += '<div class="text-lg font-bold text-green-600">' + totalValue + '</div>';
                html += '</div></div>';

                html += '<div class="mb-3">';
                html += '<div class="flex justify-between items-center mb-1">';
                html += '<span class="text-sm font-medium">Tiến độ: ' + progress + '%</span>';
                html += '</div>';
                html += '<div class="progress-bar bg-gray-200">';
                html += '<div class="' + progressColor + ' h-full" style="width: ' + progress + '%"></div>';
                html += '</div></div>';

                html += '<div class="flex items-center gap-2 mb-3">' + statusBadge + '</div>';

                html += '<div class="mt-4 pt-4 border-t border-gray-200">';
                html += '<div class="flex justify-between items-center">' + workflowHTML + '</div>';
                html += '</div>';

                html += '<div class="mt-4 flex gap-2 flex-wrap">';
                html += '<button onclick="window.location.href=\'design-new.html?projectId=' + project.id + '\'" class="action-btn border-2 border-blue-500 text-blue-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>';
                html += 'Thiết kế</button>';

                html += '<button onclick="window.location.href=\'project-doors.html?projectId=' + project.id + '\'" class="action-btn border-2 border-indigo-500 text-indigo-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>';
                html += 'Cửa</button>';

                html += '<button onclick="viewProjectDetails(\'' + projectCode + '\')" class="action-btn border-2 border-purple-500 text-purple-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>';
                html += 'Chi tiết</button>';

                html += '<button onclick="editProject(' + project.id + ')" class="action-btn border-2 border-green-500 text-green-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>';
                html += 'Sửa</button>';

                html += '<button onclick="deleteProject(' + project.id + ')" class="action-btn border-2 border-red-500 text-red-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>';
                html += 'Xóa</button>';
                html += '</div></div>';

                return html;
            }

            // Filter project cards
            function filterProjectCards() {
                const searchInput = document.getElementById('searchProjectInput');
                const statusFilter = document.getElementById('statusFilter');
                const progressFilter = document.getElementById('progressFilter');

                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                const statusValue = statusFilter ? statusFilter.value : 'all';
                const progressValue = progressFilter ? progressFilter.value : 'all';

                const projectCards = document.querySelectorAll('.project-card');
                let visibleCount = 0;

                projectCards.forEach(card => {
                    const name = (card.getAttribute('data-name') || '').toLowerCase();
                    const customer = (card.getAttribute('data-customer') || '').toLowerCase();
                    const phone = (card.getAttribute('data-phone') || '').toLowerCase();
                    const code = (card.getAttribute('data-code') || '').toLowerCase();
                    const status = card.getAttribute('data-status') || '';
                    const progress = parseInt(card.getAttribute('data-progress')) || 0;

                    // Search filter
                    const matchesSearch = !searchTerm ||
                        name.includes(searchTerm) ||
                        customer.includes(searchTerm) ||
                        phone.includes(searchTerm) ||
                        code.includes(searchTerm);

                    // Status filter
                    let matchesStatus = true;
                    if (statusValue !== 'all') {
                        if (statusValue === 'approved') {
                            matchesStatus = status === 'approved' || status === 'quotation_approved';
                        } else if (statusValue === 'pending') {
                            matchesStatus = status === 'pending' || status === 'quotation_pending' || status === 'waiting_quotation';
                        } else if (statusValue === 'not-created') {
                            matchesStatus = status === 'new' || status === 'planning';
                        }
                    }

                    // Progress filter
                    let matchesProgress = true;
                    if (progressValue !== 'all') {
                        if (progressValue === '0-25') {
                            matchesProgress = progress >= 0 && progress <= 25;
                        } else if (progressValue === '25-50') {
                            matchesProgress = progress > 25 && progress <= 50;
                        } else if (progressValue === '50-75') {
                            matchesProgress = progress > 50 && progress <= 75;
                        } else if (progressValue === '75-100') {
                            matchesProgress = progress > 75 && progress <= 100;
                        }
                    }

                    // Show/hide card
                    if (matchesSearch && matchesStatus && matchesProgress) {
                        card.classList.remove('hidden');
                        visibleCount++;
                    } else {
                        card.classList.add('hidden');
                    }
                });

                // Update count in heading
                const heading = document.getElementById('projectsHeading');
                if (heading) {
                    heading.innerHTML = 'Dự án đang triển khai <span class="text-blue-600">(' + visibleCount + ')</span>';
                }
            }

            // Load KPI counts for projects
            function loadProjectsKPI(allProjects) {
                // Running projects (not completed)
                const runningProjects = allProjects.filter(p => {
                    const status = (p.status || '').toLowerCase();
                    const progress = parseFloat(p.progress_percent) || 0;
                    return status !== 'completed' && progress < 100;
                });

                // Pending quotations
                const pendingQuotations = allProjects.filter(p => {
                    const status = (p.status || '').toLowerCase();
                    return status === 'pending' || status === 'quotation_pending' || status === 'waiting_quotation';
                });

                // Production orders (in_production or bom_extraction)
                const productionOrders = allProjects.filter(p => {
                    const status = (p.status || '').toLowerCase();
                    return status === 'in_production' || status === 'bom_extraction' || status === 'production';
                });

                // Completed projects
                const completedProjects = allProjects.filter(p => {
                    const status = (p.status || '').toLowerCase();
                    const progress = parseFloat(p.progress_percent) || 0;
                    return status === 'completed' || progress >= 100;
                });

                // Update KPI elements
                const runningEl = document.getElementById('runningProjectsCount');
                const pendingEl = document.getElementById('pendingQuotationsCount');
                const productionEl = document.getElementById('productionOrdersCount');
                const completedEl = document.getElementById('completedProjectsCount');

                if (runningEl) runningEl.textContent = runningProjects.length;
                if (pendingEl) pendingEl.textContent = pendingQuotations.length;
                if (productionEl) productionEl.textContent = productionOrders.length;
                if (completedEl) completedEl.textContent = completedProjects.length;
            }

            // Call loadProjectCards when switching to projects tab
            const originalSwitchTab = window.switchTab;
            window.switchTab = function (tabName, button) {
                if (typeof originalSwitchTab === 'function') {
                    originalSwitchTab(tabName, button);
                } else {
                    // Default tab switching logic
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    const targetTab = document.getElementById('tab-' + tabName);
                    if (targetTab) {
                        targetTab.classList.add('active');
                    }
                    if (button) {
                        button.classList.add('active');
                    }
                }

                // Load project cards when switching to projects tab
                if (tabName === 'projects') {
                    loadProjectCards();
                }
            };
        </script>

        <!-- User Menu Dropdown -->
        <div id="userMenuDropdown"
            class="hidden fixed right-4 top-16 w-48 bg-white rounded-lg shadow-xl z-[9999] border border-gray-200">
            <div class="p-2">
                <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">Hồ sơ</a>
                <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">Cài
                    đặt</a>
                <hr class="my-2">
                <button onclick="handleLogout()"
                    class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 rounded">Đăng
                    xuất</button>
            </div>
        </div>
    </div>
    <!-- End Main Content -->
    <script src="js/sidebar-enterprise.js"></script>
</body>

</html>