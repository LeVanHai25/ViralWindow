<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xuất kho - ViralWindow</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        nav {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        table {
            border-collapse: collapse;
        }

        table thead th {
            background-color: #f9fafb;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        table tbody tr {
            transition: background-color 0.2s ease;
        }

        table tbody tr:hover {
            background-color: #f9fafb;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .modal-overlay {
            backdrop-filter: blur(4px);
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea {
            transition: all 0.2s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        textarea:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        button {
            transition: all 0.2s ease;
        }

        button:hover {
            transform: translateY(-1px);
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <nav class="bg-white shadow-md px-6 py-4 flex justify-between items-center sticky top-0 z-50 backdrop-blur-sm">
        <div class="flex items-center gap-4">
            <a href="javascript:void(0)" onclick="history.back()" class="text-gray-600 hover:text-gray-800" title="Quay lại trang trước">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </a>
            <h1 class="text-2xl font-bold text-gray-800">Xuất kho</h1>
        </div>
        <div class="flex items-center gap-4">
            <a href="warehouse-export-form.html"
                class="btn-primary text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Tạo phiếu mới
            </a>
        </div>
    </nav>

    <div class="w-full max-w-full px-6 py-8">
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Tổng phiếu</p>
                        <p class="text-3xl font-bold text-gray-800" id="statTotal">0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6 text-blue-600">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Phiếu nháp</p>
                        <p class="text-3xl font-bold text-yellow-600" id="statDraft">0</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6 text-yellow-600">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Đã xác nhận</p>
                        <p class="text-3xl font-bold text-green-600" id="statConfirmed">0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6 text-green-600">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Đã xuất</p>
                        <p class="text-3xl font-bold text-purple-600" id="statExported">0</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            class="w-6 h-6 text-purple-600">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Danh sách phiếu xuất -->
        <div class="card overflow-hidden">
            <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-white">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Danh sách phiếu xuất kho
                        </h2>
                        <p class="text-sm text-gray-500 mt-1">Quản lý và theo dõi các phiếu xuất kho</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-3">
                        <!-- Bộ lọc trạng thái -->
                        <select id="statusFilter" onchange="filterExports()"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm">
                            <option value="">Tất cả trạng thái</option>
                            <option value="draft">Nháp</option>
                            <option value="confirmed">Đã xác nhận</option>
                            <option value="exported">Đã xuất</option>
                        </select>
                        <!-- Thanh tìm kiếm -->
                        <div class="relative">
                            <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <input type="text" id="searchInput" placeholder="Tìm số phiếu, khách hàng..."
                                class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 w-64"
                                oninput="filterExports()">
                        </div>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-gray-100 to-gray-50">
                        <tr>
                            <th
                                class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Số phiếu</th>
                            <th
                                class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Ngày xuất</th>
                            <th
                                class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Khách hàng</th>
                            <th
                                class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Số lượng</th>
                            <th
                                class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Trạng thái</th>
                            <th
                                class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="exportTableBody" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">Đang tải...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal: Tạo/Sửa phiếu xuất -->
    <div id="exportModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-xl w-full max-w-5xl max-h-[90vh] overflow-y-auto m-4">
            <div class="sticky top-0 bg-white p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-2xl font-bold" id="modalTitle">Tạo phiếu xuất kho</h2>
                <button onclick="closeExportModal()" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <form id="exportForm" onsubmit="saveExport(event)" class="p-6">
                <input type="hidden" id="exportId">

                <!-- Thông tin phiếu -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Số phiếu *</label>
                        <input type="text" id="exportNumber" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ngày xuất *</label>
                        <input type="date" id="exportDate" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Đại lý</label>
                        <input type="text" id="dealer"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Khách hàng</label>
                        <input type="text" id="customerName"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ký hiệu</label>
                        <input type="text" id="customerCode"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Địa chỉ</label>
                        <input type="text" id="customerAddress"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Số điện thoại</label>
                        <input type="text" id="phone"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Lý do xuất</label>
                    <input type="text" id="reason"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Xuất tại kho</label>
                        <input type="text" id="warehouseLocation"
                            value="Công ty cổ phần Viralwindow, Số 36 Đường Miền Đông Củ Khê Thanh Oai Hà Nội"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Thời điểm vận chuyển</label>
                        <input type="datetime-local" id="shippingTime"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                </div>

                <!-- Danh sách vật tư -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Danh sách vật tư xuất</h3>
                        <button type="button" onclick="addItemRow()"
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            Thêm vật tư
                        </button>
                    </div>
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                        <table class="w-full">
                            <thead class="bg-gray-100 border-b-2 border-gray-300">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium uppercase w-12 text-gray-900">STT
                                    </th>
                                    <th class="px-3 py-2 text-left text-xs font-medium uppercase text-gray-900">Mã hiệu
                                    </th>
                                    <th class="px-3 py-2 text-left text-xs font-medium uppercase text-gray-900">Nội dung
                                    </th>
                                    <th class="px-3 py-2 text-left text-xs font-medium uppercase w-24 text-gray-900">
                                        Rộng (mm)</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium uppercase w-24 text-gray-900">Cao
                                        (mm)</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium uppercase w-20 text-gray-900">ĐVT
                                    </th>
                                    <th class="px-3 py-2 text-left text-xs font-medium uppercase w-24 text-gray-900">Số
                                        lượng</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium uppercase w-24 text-gray-900">
                                        Diện tích</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium uppercase text-gray-900">Ghi chú
                                    </th>
                                    <th class="px-3 py-2 w-12 text-gray-900"></th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <!-- Items will be added here -->
                            </tbody>
                            <tfoot class="bg-green-100">
                                <tr>
                                    <td colspan="6" class="px-3 py-2 font-bold text-center">CỘNG</td>
                                    <td class="px-3 py-2 font-bold" id="totalQuantity">0</td>
                                    <td class="px-3 py-2 font-bold" id="totalArea">0</td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ghi chú</label>
                    <textarea id="notes" rows="2"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                </div>

                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeExportModal()"
                        class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Hủy
                    </button>
                    <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg font-semibold">
                        Lưu phiếu
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let allExports = [];
        let itemCounter = 0;

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadExports();
            document.getElementById('exportDate').valueAsDate = new Date();
        });

        // Load danh sách phiếu xuất
        async function loadExports() {
            try {
                const response = await fetch(`${API_BASE}/warehouse-export`);
                const result = await response.json();

                if (result.success) {
                    allExports = result.data || [];
                    displayExports(allExports);
                    updateStats();
                }
            } catch (error) {
                console.error('Error loading exports:', error);
                document.getElementById('exportTableBody').innerHTML =
                    '<tr><td colspan="6" class="px-6 py-8 text-center text-red-500">Lỗi khi tải dữ liệu</td></tr>';
            }
        }

        // Hiển thị danh sách
        function displayExports(data) {
            const tbody = document.getElementById('exportTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-16 h-16 text-gray-300 mb-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <p class="text-gray-500 text-lg">Chưa có phiếu xuất kho nào</p>
                                <a href="warehouse-export-form.html" class="mt-4 btn-primary text-white px-6 py-2 rounded-lg font-semibold inline-block">
                                    + Tạo phiếu đầu tiên
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.map(exp => {
                const statusColors = {
                    'draft': 'bg-yellow-100 text-yellow-700 border border-yellow-300',
                    'confirmed': 'bg-green-100 text-green-700 border border-green-300',
                    'exported': 'bg-purple-100 text-purple-700 border border-purple-300'
                };
                const statusNames = {
                    'draft': 'Nháp',
                    'confirmed': 'Đã xác nhận',
                    'exported': 'Đã xuất'
                };
                const statusIcons = {
                    'draft': '<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/></svg>',
                    'confirmed': '<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>',
                    'exported': '<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>'
                };

                return `
                    <tr class="hover:bg-gradient-to-r hover:from-green-50 hover:to-white transition-all duration-200">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="bg-green-100 p-2 rounded-lg mr-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-green-600">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-800">${exp.export_number}</p>
                                    <p class="text-xs text-gray-500">${exp.item_count || 0} vật tư</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center text-gray-600">
                                <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                ${formatDate(exp.export_date)}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div>
                                <p class="font-medium text-gray-800">${exp.customer_name || '-'}</p>
                                <p class="text-xs text-gray-500">${exp.customer_code || ''}</p>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-50 text-blue-700">
                                ${exp.item_count || 0} vật tư
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center status-badge ${statusColors[exp.status] || 'bg-gray-100 text-gray-700'}">
                                ${statusIcons[exp.status] || ''}
                                ${statusNames[exp.status] || exp.status}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2 flex-wrap">
                                <!-- Nút Xem/Sửa -->
                                <a href="warehouse-export-form.html?id=${exp.id}" 
                                    class="inline-flex items-center px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all text-sm font-medium"
                                    title="Xem chi tiết">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                    Xem
                                </a>
                                
                                <!-- Nút Xác nhận / Xuất (tùy trạng thái) -->
                                ${exp.status === 'draft' ? `
                                <button onclick="confirmExport(${exp.id})" 
                                    class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg hover:from-blue-600 hover:to-indigo-700 transition-all text-sm font-medium shadow-sm hover:shadow-md"
                                    title="Xác nhận phiếu">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Xác nhận
                                </button>
                                ` : ''}
                                ${exp.status === 'confirmed' ? `
                                <button onclick="markExported(${exp.id})" 
                                    class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-purple-500 to-violet-600 text-white rounded-lg hover:from-purple-600 hover:to-violet-700 transition-all text-sm font-medium shadow-sm hover:shadow-md"
                                    title="Đánh dấu đã xuất">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Đã xuất
                                </button>
                                ` : ''}
                                
                                <!-- Nút Xuất Excel - NỔI BẬT -->
                                <button onclick="exportExcel(${exp.id})" 
                                    class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all text-sm font-medium shadow-sm hover:shadow-md"
                                    title="Xuất file Excel">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    Excel
                                </button>
                                
                                <!-- Nút Xóa -->
                                <button onclick="deleteExport(${exp.id})" 
                                    class="inline-flex items-center px-2 py-1.5 text-red-500 hover:bg-red-50 rounded-lg transition-all"
                                    title="Xóa phiếu">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update stats
        function updateStats() {
            document.getElementById('statTotal').textContent = allExports.length;
            document.getElementById('statDraft').textContent = allExports.filter(e => e.status === 'draft').length;
            document.getElementById('statConfirmed').textContent = allExports.filter(e => e.status === 'confirmed').length;
            document.getElementById('statExported').textContent = allExports.filter(e => e.status === 'exported').length;
        }

        // Filter exports
        function filterExports() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter')?.value || '';

            const filtered = allExports.filter(exp => {
                // Text search filter
                const matchesSearch =
                    (exp.export_number || '').toLowerCase().includes(search) ||
                    (exp.customer_name || '').toLowerCase().includes(search) ||
                    (exp.customer_code || '').toLowerCase().includes(search);

                // Status filter
                const matchesStatus = !statusFilter || exp.status === statusFilter;

                return matchesSearch && matchesStatus;
            });

            displayExports(filtered);
        }

        // Open modal for new export
        async function openNewExportModal() {
            document.getElementById('modalTitle').textContent = 'Tạo phiếu xuất kho';
            document.getElementById('exportForm').reset();
            document.getElementById('exportId').value = '';
            document.getElementById('exportDate').valueAsDate = new Date();
            document.getElementById('warehouseLocation').value = 'Công ty cổ phần Viralwindow, Số 36 Đường Miền Đông Củ Khê Thanh Oai Hà Nội';
            document.getElementById('itemsTableBody').innerHTML = '';
            itemCounter = 0;
            updateTotals();

            // Get next export number
            try {
                const response = await fetch(`${API_BASE}/warehouse-export/next-number`);
                const result = await response.json();
                if (result.success) {
                    document.getElementById('exportNumber').value = result.data.number;
                }
            } catch (error) {
                console.error('Error getting next number:', error);
                document.getElementById('exportNumber').value = 'NEW-001';
            }

            document.getElementById('exportModal').classList.remove('hidden');
        }

        // View/Edit export
        async function viewExport(id) {
            try {
                const response = await fetch(`${API_BASE}/warehouse-export/${id}`);
                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    document.getElementById('modalTitle').textContent = 'Chỉnh sửa phiếu xuất kho';
                    document.getElementById('exportId').value = data.id;
                    document.getElementById('exportNumber').value = data.export_number;
                    document.getElementById('exportDate').value = data.export_date ? data.export_date.split('T')[0] : '';
                    document.getElementById('customerName').value = data.customer_name || '';
                    document.getElementById('customerCode').value = data.customer_code || '';
                    document.getElementById('customerAddress').value = data.customer_address || '';
                    document.getElementById('phone').value = data.phone || '';
                    document.getElementById('reason').value = data.reason || '';
                    document.getElementById('warehouseLocation').value = data.warehouse_location || '';
                    // Format shipping_time cho datetime-local (YYYY-MM-DDTHH:mm)
                    if (data.shipping_time) {
                        const shippingDate = new Date(data.shipping_time);
                        if (!isNaN(shippingDate.getTime())) {
                            const year = shippingDate.getFullYear();
                            const month = String(shippingDate.getMonth() + 1).padStart(2, '0');
                            const day = String(shippingDate.getDate()).padStart(2, '0');
                            const hours = String(shippingDate.getHours()).padStart(2, '0');
                            const minutes = String(shippingDate.getMinutes()).padStart(2, '0');
                            document.getElementById('shippingTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
                        } else {
                            document.getElementById('shippingTime').value = '';
                        }
                    } else {
                        document.getElementById('shippingTime').value = '';
                    }
                    document.getElementById('dealer').value = data.dealer || '';
                    document.getElementById('notes').value = data.notes || '';

                    // Load items
                    document.getElementById('itemsTableBody').innerHTML = '';
                    itemCounter = 0;
                    (data.items || []).forEach(item => {
                        addItemRow(item);
                    });

                    updateTotals();
                    document.getElementById('exportModal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading export:', error);
                alert('Lỗi khi tải phiếu xuất');
            }
        }

        // Close modal
        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        // Add item row
        function addItemRow(item = null) {
            itemCounter++;
            const tbody = document.getElementById('itemsTableBody');
            const row = document.createElement('tr');
            row.id = `item-row-${itemCounter}`;
            row.innerHTML = `
                <td class="px-3 py-2 text-center">${itemCounter}</td>
                <td class="px-3 py-2">
                    <input type="text" class="w-full px-2 py-1 border rounded item-code" value="${item?.material_code || ''}">
                </td>
                <td class="px-3 py-2">
                    <input type="text" class="w-full px-2 py-1 border rounded item-name" value="${item?.material_name || ''}">
                </td>
                <td class="px-3 py-2">
                    <input type="number" class="w-full px-2 py-1 border rounded item-width" value="${item?.width_mm || ''}" step="0.01" onchange="calculateArea(this)">
                </td>
                <td class="px-3 py-2">
                    <input type="number" class="w-full px-2 py-1 border rounded item-height" value="${item?.height_mm || ''}" step="0.01" onchange="calculateArea(this)">
                </td>
                <td class="px-3 py-2">
                    <input type="text" class="w-full px-2 py-1 border rounded item-unit" value="${item?.unit || 'Cái'}">
                </td>
                <td class="px-3 py-2">
                    <input type="number" class="w-full px-2 py-1 border rounded item-quantity" value="${item?.quantity || 1}" step="0.01" onchange="updateTotals()">
                </td>
                <td class="px-3 py-2">
                    <input type="number" class="w-full px-2 py-1 border rounded item-area" value="${item?.area || ''}" step="0.01" onchange="updateTotals()">
                </td>
                <td class="px-3 py-2">
                    <input type="text" class="w-full px-2 py-1 border rounded item-notes" value="${item?.notes || ''}">
                </td>
                <td class="px-3 py-2 text-center">
                    <button type="button" onclick="removeItemRow(${itemCounter})" class="text-red-600 hover:text-red-800">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            updateTotals();
        }

        // Remove item row
        function removeItemRow(counter) {
            const row = document.getElementById(`item-row-${counter}`);
            if (row) row.remove();
            updateTotals();
            renumberRows();
        }

        // Renumber rows
        function renumberRows() {
            const rows = document.querySelectorAll('#itemsTableBody tr');
            rows.forEach((row, index) => {
                row.querySelector('td:first-child').textContent = index + 1;
            });
        }

        // Calculate area
        function calculateArea(input) {
            const row = input.closest('tr');
            const width = parseFloat(row.querySelector('.item-width').value) || 0;
            const height = parseFloat(row.querySelector('.item-height').value) || 0;
            const area = (width * height) / 1000000; // mm2 to m2
            row.querySelector('.item-area').value = area.toFixed(3);
            updateTotals();
        }

        // Update totals
        function updateTotals() {
            let totalQty = 0;
            let totalArea = 0;

            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                totalQty += parseFloat(row.querySelector('.item-quantity')?.value) || 0;
                totalArea += parseFloat(row.querySelector('.item-area')?.value) || 0;
            });

            document.getElementById('totalQuantity').textContent = totalQty.toFixed(2);
            document.getElementById('totalArea').textContent = totalArea.toFixed(3);
        }

        // Save export
        async function saveExport(event) {
            event.preventDefault();

            const id = document.getElementById('exportId').value;
            const items = [];

            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                items.push({
                    material_code: row.querySelector('.item-code').value,
                    material_name: row.querySelector('.item-name').value,
                    width_mm: parseFloat(row.querySelector('.item-width').value) || 0,
                    height_mm: parseFloat(row.querySelector('.item-height').value) || 0,
                    unit: row.querySelector('.item-unit').value,
                    quantity: parseFloat(row.querySelector('.item-quantity').value) || 0,
                    area: parseFloat(row.querySelector('.item-area').value) || 0,
                    notes: row.querySelector('.item-notes').value,
                    material_type: 'other',
                    material_id: null
                });
            });

            const data = {
                export_number: document.getElementById('exportNumber').value,
                export_date: document.getElementById('exportDate').value,
                customer_name: document.getElementById('customerName').value,
                customer_code: document.getElementById('customerCode').value,
                customer_address: document.getElementById('customerAddress').value,
                phone: document.getElementById('phone').value,
                reason: document.getElementById('reason').value,
                warehouse_location: document.getElementById('warehouseLocation').value,
                shipping_time: document.getElementById('shippingTime').value,
                dealer: document.getElementById('dealer').value,
                notes: document.getElementById('notes').value,
                items
            };

            try {
                const url = id ? `${API_BASE}/warehouse-export/${id}` : `${API_BASE}/warehouse-export`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert(id ? 'Cập nhật phiếu thành công!' : 'Tạo phiếu thành công!');
                    closeExportModal();
                    loadExports();
                } else {
                    alert('Lỗi: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving export:', error);
                alert('Lỗi khi lưu phiếu');
            }
        }

        // Export Excel
        async function exportExcel(id) {
            try {
                const response = await fetch(`${API_BASE}/warehouse-export/${id}/excel`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `PhieuXuatKho_${id}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Lỗi khi xuất Excel');
                }
            } catch (error) {
                console.error('Error exporting Excel:', error);
                alert('Lỗi khi xuất Excel');
            }
        }

        // Confirm export (draft -> confirmed)
        async function confirmExport(id) {
            if (!confirm('Xác nhận phiếu này? Trạng thái sẽ chuyển từ "Nháp" sang "Đã xác nhận"')) return;

            try {
                const response = await fetch(`${API_BASE}/warehouse-export/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'confirmed' })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Đã xác nhận phiếu xuất kho!');
                    loadExports();
                } else {
                    alert('Lỗi: ' + result.message);
                }
            } catch (error) {
                console.error('Error confirming export:', error);
                alert('Lỗi khi xác nhận phiếu');
            }
        }

        // Mark as exported (confirmed -> exported)
        async function markExported(id) {
            if (!confirm('Đánh dấu phiếu này đã xuất? Trạng thái sẽ chuyển từ "Đã xác nhận" sang "Đã xuất"')) return;

            try {
                const response = await fetch(`${API_BASE}/warehouse-export/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'exported' })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Đã đánh dấu phiếu đã xuất!');
                    loadExports();
                } else {
                    alert('Lỗi: ' + result.message);
                }
            } catch (error) {
                console.error('Error marking exported:', error);
                alert('Lỗi khi cập nhật trạng thái');
            }
        }

        // Delete export
        async function deleteExport(id) {
            if (!confirm('Bạn có chắc muốn xóa phiếu này?')) return;

            try {
                const response = await fetch(`${API_BASE}/warehouse-export/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Xóa phiếu thành công!');
                    loadExports();
                } else {
                    alert('Lỗi: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting export:', error);
                alert('Lỗi khi xóa phiếu');
            }
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('vi-VN');
        }
    </script>
</body>

</html>