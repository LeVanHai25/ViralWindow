<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ª± √°n ƒëang tri·ªÉn khai - H·ªá th·ªëng qu·∫£n l√Ω c·ª≠a nh√¥m k√≠nh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/success-notification.css">
    <script src="js/success-notification.js"></script>
    <style>
        /* Modern gradient background */
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        /* Modern header with gradient */
        .header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced project cards */
        .project-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.05);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

        .project-card:hover {
            transform: translateY(-8px) scale(1.01);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
            border-color: rgba(102, 126, 234, 0.3);
        }

        /* Enhanced KPI cards with gradients */
        .kpi-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .kpi-card:hover::before {
            transform: scaleX(1);
        }

        .kpi-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .kpi-card-blue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .kpi-card-blue .text-gray-500 {
            color: rgba(255, 255, 255, 0.8);
        }

        .kpi-card-yellow {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .kpi-card-yellow .text-gray-500 {
            color: rgba(255, 255, 255, 0.8);
        }

        .kpi-card-orange {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .kpi-card-orange .text-gray-500 {
            color: rgba(255, 255, 255, 0.8);
        }

        .kpi-card-green {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .kpi-card-green .text-gray-500 {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Enhanced action buttons */
        .action-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .action-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        /* Enhanced progress bar */
        .progress-bar {
            height: 10px;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Enhanced workflow steps */
        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            position: relative;
        }

        .workflow-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 16px;
            left: 60%;
            width: 100%;
            height: 2px;
            background: #e5e7eb;
            z-index: 0;
        }

        .workflow-step-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .workflow-step-circle.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .workflow-step-circle.inactive {
            background: #e5e7eb;
            color: #9ca3af;
        }

        /* Enhanced status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        /* Enhanced alert banner */
        .alert-banner {
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            margin-top: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modern search section */
        .search-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* Smooth animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        /* Icon square enhancement */
        .icon-square {
            transition: all 0.3s ease;
        }

        .kpi-card:hover .icon-square {
            transform: scale(1.1) rotate(5deg);
        }
    </style>
    <link rel="stylesheet" href="css/notification-header.css">
</head>

<body class="bg-gray-100 text-gray-800">

    <!-- Header Notification (Top Right) -->
    <div class="header-notification-container">
        <button id="headerNotificationButton" class="header-notification-button" onclick="toggleHeaderNotifications()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <span id="headerNotificationBadge" class="header-notification-badge hidden">0</span>
        </button>
        
        <div id="headerNotificationsDropdown" class="header-notifications-dropdown">
            <div class="header-notifications-header">
                <h3>Th√¥ng b√°o</h3>
            </div>
            <div id="headerNotificationsList" class="header-notifications-list">
                <!-- Notifications will be loaded here -->
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <div class="header-gradient text-white shadow-lg p-6 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <a href="javascript:void(0)" onclick="history.back()" title="Quay l·∫°i trang tr∆∞·ªõc"
                class="icon-square bg-white bg-opacity-20 backdrop-blur-sm text-white overflow-hidden rounded-xl p-2 hover:bg-opacity-30 transition-all duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </a>
            <div>
                <h1 class="text-3xl font-bold mb-1">D·ª± √°n ƒëang tri·ªÉn khai</h1>
                <p class="text-white text-opacity-80 text-sm">Qu·∫£n l√Ω v√† theo d√µi ti·∫øn ƒë·ªô c√°c c√¥ng tr√¨nh</p>
            </div>
        </div>


            <!-- User Menu -->
            <div class="relative">
                <button onclick="toggleUserMenu()"
                    class="flex items-center gap-3 p-2 text-white hover:bg-white hover:bg-opacity-20 rounded-xl transition-all duration-300">
                    <div class="w-10 h-10 bg-white bg-opacity-30 backdrop-blur-sm text-white rounded-full flex items-center justify-center font-semibold overflow-hidden relative border-2 border-white border-opacity-50"
                        id="userAvatar">
                        <div id="userAvatarInitial">U</div>
                        <img id="userAvatarImage" src="" alt="Avatar"
                            class="hidden w-full h-full object-cover rounded-full">
                    </div>
                    <span id="userName" class="hidden md:block font-medium">User</span>
                </button>
                <!-- User Dropdown -->
                <div id="userMenuDropdown"
                    class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-2xl z-50 border border-gray-200 overflow-hidden">
                    <div class="p-2">
                        <a href="profile.html"
                            class="block px-4 py-3 text-sm text-gray-700 hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 rounded-lg transition-all duration-200">H·ªì
                            s∆°</a>
                        <a href="settings.html"
                            class="block px-4 py-3 text-sm text-gray-700 hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 rounded-lg transition-all duration-200">C√†i
                            ƒë·∫∑t</a>
                        <hr class="my-2">
                        <button onclick="logout()"
                            class="block w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200">ƒêƒÉng
                            xu·∫•t</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI SUMMARY SECTION -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 p-6 fade-in">
        <div class="kpi-card kpi-card-blue shadow-lg rounded-2xl p-6 flex items-center justify-between text-white">
            <div>
                <p class="text-white text-opacity-80 text-sm mb-2 font-medium">D·ª± √°n ƒëang ch·∫°y</p>
                <p class="text-4xl font-bold" id="runningProjectsCount">0</p>
            </div>
            <div class="icon-square bg-white bg-opacity-20 backdrop-blur-sm text-white rounded-xl p-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
            </div>
        </div>

        <a href="pending-quotations.html"
            class="kpi-card kpi-card-yellow shadow-lg rounded-2xl p-6 flex items-center justify-between cursor-pointer text-white">
            <div>
                <p class="text-white text-opacity-80 text-sm mb-2 font-medium">B√°o gi√° ch·ªù duy·ªát</p>
                <p class="text-4xl font-bold" id="pendingQuotationsCount">0</p>
            </div>
            <div class="icon-square bg-white bg-opacity-20 backdrop-blur-sm text-white rounded-xl p-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
        </a>

        <a href="production.html"
            class="kpi-card kpi-card-orange shadow-lg rounded-2xl p-6 flex items-center justify-between cursor-pointer text-white">
            <div>
                <p class="text-white text-opacity-80 text-sm mb-2 font-medium">L·ªánh s·∫£n xu·∫•t</p>
                <p class="text-4xl font-bold" id="productionOrdersCount">0</p>
            </div>
            <div class="icon-square bg-white bg-opacity-20 backdrop-blur-sm text-white rounded-xl p-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </div>
        </a>

        <a href="completed-projects.html"
            class="kpi-card kpi-card-green shadow-lg rounded-2xl p-6 flex items-center justify-between cursor-pointer text-white">
            <div>
                <p class="text-white text-opacity-80 text-sm mb-2 font-medium">D·ª± √°n ƒë√£ ho√†n th√†nh</p>
                <p class="text-4xl font-bold" id="completedProjectsCount">0</p>
            </div>
            <div class="icon-square bg-white bg-opacity-20 backdrop-blur-sm text-white rounded-xl p-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
        </a>
    </div>

    <!-- SEARCH AND FILTER SECTION -->
    <div class="px-6 mb-6 fade-in">
        <div class="search-section rounded-2xl p-5 flex flex-wrap items-center gap-4">
            <!-- Search Bar -->
            <div class="flex-1 min-w-[300px] relative">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-5 h-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="searchInput" placeholder="T√¨m theo t√™n c√¥ng tr√¨nh, kh√°ch h√†ng, SƒêT, m√£ CT..."
                    class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300"
                    onkeyup="filterProjects()">
            </div>

            <!-- Filter Dropdowns -->
            <select id="statusFilter"
                class="px-5 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 font-medium"
                onchange="filterProjects()">
                <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="approved">ƒê√£ duy·ªát</option>
                <option value="pending">Ch·ªù duy·ªát</option>
                <option value="not-created">Ch∆∞a t·∫°o b√°o gi√°</option>
            </select>

            <select id="progressFilter"
                class="px-5 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 font-medium"
                onchange="filterProjects()">
                <option value="all">T·∫•t c·∫£ ti·∫øn ƒë·ªô</option>
                <option value="0-25">0-25%</option>
                <option value="25-50">25-50%</option>
                <option value="50-75">50-75%</option>
                <option value="75-100">75-100%</option>
            </select>

            <!-- Create New Project Button -->
            <button onclick="openCreateProjectModal()"
                class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold flex items-center gap-2 hover:from-blue-700 hover:to-purple-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                T·∫°o d·ª± √°n m·ªõi
            </button>
        </div>
    </div>

    <!-- PROJECTS LIST SECTION -->
    <div class="px-6 pb-6 fade-in">
        <div class="flex items-center justify-between mb-6">
            <h2 id="projectsHeading" class="text-2xl font-bold text-gray-800">D·ª± √°n ƒëang tri·ªÉn khai <span
                    class="text-blue-600">(0)</span></h2>
        </div>

        <!-- Projects Container - Will be populated dynamically -->
        <div id="projectsContainer" class="space-y-4"></div>
    </div>

    <!-- MODAL: Create New Project -->
    <div id="createProjectModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto transform transition-all">
            <div
                class="sticky top-0 bg-gradient-to-r from-blue-600 to-purple-600 text-white border-b border-gray-200 p-6 flex justify-between items-center rounded-t-2xl">
                <h2 class="text-2xl font-bold">T·∫°o d·ª± √°n m·ªõi</h2>
                <button onclick="closeCreateProjectModal()"
                    class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-all duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <form id="createProjectForm" onsubmit="saveProject(event)" class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            M√£ d·ª± √°n <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="projectCode" required placeholder="T·ª± ƒë·ªông t·∫°o ho·∫∑c nh·∫≠p th·ªß c√¥ng"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                        <button type="button" onclick="generateProjectCode()"
                            class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors">
                            üîÑ T·ª± ƒë·ªông t·∫°o m√£
                        </button>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            T√™n d·ª± √°n <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="projectName" required placeholder="VD: Bi·ªát th·ª± H√≤a L·∫°c"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Kh√°ch h√†ng <span class="text-red-500">*</span>
                    </label>
                    <div class="flex gap-3">
                        <select id="customerId" required
                            class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                            <option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
                        </select>
                        <button type="button" onclick="openAddCustomerModal()"
                            class="px-5 py-3 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 rounded-xl hover:from-gray-200 hover:to-gray-300 font-medium transition-all duration-300 shadow-sm">
                            + Th√™m m·ªõi
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Ng√†y b·∫Øt ƒë·∫ßu <span class="text-red-500">*</span>
                        </label>
                        <input type="date" id="startDate" required
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Ng√†y giao d·ª± ki·∫øn <span class="text-red-500">*</span>
                        </label>
                        <input type="date" id="deadline" required
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Tr·∫°ng th√°i
                    </label>
                    <select id="projectStatus"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                        <option value="new">M·ªõi t·∫°o</option>
                        <option value="quotation_pending">Ch·ªù b√°o gi√°</option>
                        <option value="quotation_approved">ƒê√£ duy·ªát b√°o gi√°</option>
                        <option value="in_production">ƒêang s·∫£n xu·∫•t</option>
                        <option value="completed">Ho√†n th√†nh</option>
                        <option value="paused">T·∫°m d·ª´ng</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Ghi ch√∫
                    </label>
                    <textarea id="projectNotes" rows="4" placeholder="Ghi ch√∫ v·ªÅ d·ª± √°n..."
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 resize-none"></textarea>
                </div>

                <div class="flex justify-end gap-4 pt-6 border-t border-gray-200">
                    <button type="button" onclick="closeCreateProjectModal()"
                        class="px-6 py-3 border-2 border-gray-300 rounded-xl font-semibold hover:bg-gray-50 transition-all duration-300">
                        H·ªßy
                    </button>
                    <button type="submit"
                        class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                        ‚ú® T·∫°o d·ª± √°n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Edit Project -->
    <div id="editProjectModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold">S·ª≠a d·ª± √°n</h2>
                <button onclick="closeEditProjectModal()" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <form id="editProjectForm" onsubmit="updateProject(event)" class="p-6 space-y-6">
                <input type="hidden" id="editProjectId" value="">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            M√£ d·ª± √°n
                        </label>
                        <input type="text" id="editProjectCode" readonly
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600">
                        <p class="text-xs text-gray-500 mt-1">M√£ d·ª± √°n kh√¥ng th·ªÉ thay ƒë·ªïi</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            T√™n d·ª± √°n <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="editProjectName" required placeholder="VD: Bi·ªát th·ª± H√≤a L·∫°c"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Kh√°ch h√†ng <span class="text-red-500">*</span>
                    </label>
                    <select id="editCustomerId" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Ng√†y b·∫Øt ƒë·∫ßu <span class="text-red-500">*</span>
                        </label>
                        <input type="date" id="editStartDate" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Ng√†y giao d·ª± ki·∫øn <span class="text-red-500">*</span>
                        </label>
                        <input type="date" id="editDeadline" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Tr·∫°ng th√°i
                    </label>
                    <select id="editProjectStatus"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="new">M·ªõi t·∫°o</option>
                        <option value="quotation_pending">Ch·ªù b√°o gi√°</option>
                        <option value="quotation_approved">ƒê√£ duy·ªát b√°o gi√°</option>
                        <option value="in_production">ƒêang s·∫£n xu·∫•t</option>
                        <option value="completed">Ho√†n th√†nh</option>
                        <option value="paused">T·∫°m d·ª´ng</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Ghi ch√∫
                    </label>
                    <textarea id="editProjectNotes" rows="3" placeholder="Ghi ch√∫ v·ªÅ d·ª± √°n..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <div class="flex justify-end gap-4 pt-4 border-t border-gray-200">
                    <button type="button" onclick="closeEditProjectModal()"
                        class="px-6 py-2 border border-gray-300 rounded-lg font-medium hover:bg-gray-50">
                        H·ªßy
                    </button>
                    <button type="submit"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">
                        C·∫≠p nh·∫≠t
                    </button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .icon-square {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 24px;
        }

        .project-card.hidden {
            display: none;
        }
    </style>

    <script>
        function filterProjects() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const progressFilter = document.getElementById('progressFilter').value;
            const projectCards = document.querySelectorAll('.project-card');
            let visibleCount = 0;

            projectCards.forEach(card => {
                const name = card.getAttribute('data-name').toLowerCase();
                const customer = card.getAttribute('data-customer').toLowerCase();
                const phone = card.getAttribute('data-phone').toLowerCase();
                const code = card.getAttribute('data-code').toLowerCase();
                const status = card.getAttribute('data-status');
                const progress = parseInt(card.getAttribute('data-progress'));

                // Search filter
                const matchesSearch = !searchTerm ||
                    name.includes(searchTerm) ||
                    customer.includes(searchTerm) ||
                    phone.includes(searchTerm) ||
                    code.includes(searchTerm);

                // Status filter
                let matchesStatus = true;
                if (statusFilter !== 'all') {
                    if (statusFilter === 'approved') {
                        matchesStatus = status === 'approved';
                    } else if (statusFilter === 'pending') {
                        matchesStatus = status === 'pending';
                    } else if (statusFilter === 'not-created') {
                        matchesStatus = status === 'not-created';
                    }
                }

                // Progress filter
                let matchesProgress = true;
                if (progressFilter !== 'all') {
                    if (progressFilter === '0-25') {
                        matchesProgress = progress >= 0 && progress <= 25;
                    } else if (progressFilter === '25-50') {
                        matchesProgress = progress > 25 && progress <= 50;
                    } else if (progressFilter === '50-75') {
                        matchesProgress = progress > 50 && progress <= 75;
                    } else if (progressFilter === '75-100') {
                        matchesProgress = progress > 75 && progress <= 100;
                    }
                }

                // Show/hide card
                if (matchesSearch && matchesStatus && matchesProgress) {
                    card.classList.remove('hidden');
                    visibleCount++;
                } else {
                    card.classList.add('hidden');
                }
            });

            // Update count in heading
            const heading = document.querySelector('h2');
            if (heading) {
                heading.textContent = `D·ª± √°n ƒëang tri·ªÉn khai (${visibleCount})`;
            }
        }

        const API_BASE = 'http://localhost:3001/api';
        let projectsData = []; // Store projects data globally
        let projectCodeToIdMap = {}; // Map project codes to IDs

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Load user info
        async function loadUserInfo() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const user = result.data;
                    document.getElementById('userName').textContent = user.full_name || 'User';

                    // Hi·ªÉn th·ªã avatar
                    const avatarInitial = document.getElementById('userAvatarInitial');
                    const avatarImage = document.getElementById('userAvatarImage');

                    if (user.avatar_url) {
                        avatarImage.src = user.avatar_url;
                        avatarImage.classList.remove('hidden');
                        avatarInitial.classList.add('hidden');
                    } else {
                        // Hi·ªÉn th·ªã ch·ªØ c√°i ƒë·∫ßu c·ªßa t√™n
                        const initial = (user.full_name || 'U').charAt(0).toUpperCase();
                        avatarInitial.textContent = initial;
                        avatarInitial.classList.remove('hidden');
                        avatarImage.classList.add('hidden');
                    }
                } else {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('L·ªói:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }

        // Toggle notifications dropdown
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationsDropdown');
            dropdown.classList.toggle('hidden');
            if (!dropdown.classList.contains('hidden')) {
                loadNotifications();
            }
        }

        // Toggle user menu dropdown
        function toggleUserMenu() {
            const dropdown = document.getElementById('userMenuDropdown');
            dropdown.classList.toggle('hidden');
        }

        // Navigate to notifications page with correct path
        function goToNotificationsPage() {
            // Close dropdown first
            document.getElementById('notificationsDropdown').classList.add('hidden');

            // Navigate to notifications page (same folder)
            window.location.href = 'notifications.html';
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const response = await fetch(`${API_BASE}/notifications`);
                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    displayNotifications(result.data);
                    loadUnreadCount();
                } else {
                    // Show demo data if API returns empty array
                    console.log('Kh√¥ng c√≥ th√¥ng b√°o t·ª´ API, hi·ªÉn th·ªã d·ªØ li·ªáu demo');
                    displayDemoNotifications();
                }
            } catch (error) {
                console.error('L·ªói:', error);
                displayDemoNotifications();
            }
        }

        // Display demo notifications
        function displayDemoNotifications() {
            const demoNotifications = [
                {
                    id: 1,
                    type: 'info',
                    title: 'üèóÔ∏è D·ª± √°n m·ªõi ƒë∆∞·ª£c t·∫°o',
                    message: 'D·ª± √°n "Nh√† S10-Anh Tri·ªáu" v·ª´a ƒë∆∞·ª£c t·∫°o',
                    is_read: false,
                    created_at: new Date().toISOString()
                },
                {
                    id: 2,
                    type: 'warning',
                    title: '‚ö†Ô∏è V·∫≠t t∆∞ s·∫Øp h·∫øt',
                    message: 'Thanh nh√¥m Y6501 c√≤n 5 c√¢y',
                    is_read: false,
                    created_at: new Date(Date.now() - 3600000).toISOString()
                },
                {
                    id: 3,
                    type: 'success',
                    title: '‚úÖ S·∫£n xu·∫•t ho√†n th√†nh',
                    message: 'LSX-2025-001 ƒë√£ ho√†n th√†nh 100%',
                    is_read: true,
                    created_at: new Date(Date.now() - 86400000).toISOString()
                }
            ];
            displayNotifications(demoNotifications);

            // Update badge with demo count
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                const unreadCount = demoNotifications.filter(n => !n.is_read).length;
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        // Load unread count
        async function loadUnreadCount() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                const response = await fetch(`${API_BASE}/notifications/unread`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const count = result.data.count || 0;
                    const badge = document.getElementById('notificationBadge');
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('L·ªói:', error);
            }
        }

        // Display notifications
        function displayNotifications(notifications) {
            const container = document.getElementById('notificationsList');

            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <p>Kh√¥ng c√≥ th√¥ng b√°o n√†o</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = notifications.slice(0, 10).map(notif => {
                const typeColors = {
                    'info': 'bg-blue-50 border-blue-200',
                    'success': 'bg-green-50 border-green-200',
                    'warning': 'bg-yellow-50 border-yellow-200',
                    'error': 'bg-red-50 border-red-200'
                };

                const typeIcons = {
                    'info': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-blue-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                    'success': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-green-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                    'warning': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-yellow-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>',
                    'error': '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-red-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                };

                return `
                    <div class="p-4 border-b border-gray-200 hover:bg-gray-50 cursor-pointer ${notif.is_read ? '' : 'bg-blue-50'}" 
                         onclick="markNotificationRead(${notif.id})">
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0 mt-1">
                                ${typeIcons[notif.type] || typeIcons.info}
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-sm ${notif.is_read ? 'text-gray-700' : 'text-gray-900'}">${notif.title}</h4>
                                <p class="text-sm text-gray-600 mt-1">${notif.message}</p>
                                <p class="text-xs text-gray-400 mt-1">${formatTime(notif.created_at)}</p>
                            </div>
                            ${!notif.is_read ? '<div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Mark notification as read
        async function markNotificationRead(id) {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                const response = await fetch(`${API_BASE}/notifications/${id}/read`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    loadNotifications();
                }
            } catch (error) {
                console.error('L·ªói:', error);
            }
        }

        // Logout
        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }

        // Format time
        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'V·ª´a xong';
            if (minutes < 60) return `${minutes} ph√∫t tr∆∞·ªõc`;
            if (hours < 24) return `${hours} gi·ªù tr∆∞·ªõc`;
            if (days < 7) return `${days} ng√†y tr∆∞·ªõc`;
            return date.toLocaleDateString('vi-VN');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (event) {
            const notificationsDropdown = document.getElementById('notificationsDropdown');
            const userMenuDropdown = document.getElementById('userMenuDropdown');
            const notificationsButton = event.target.closest('[onclick="toggleNotifications()"]');
            const userMenuButton = event.target.closest('[onclick="toggleUserMenu()"]');

            if (notificationsDropdown && !notificationsButton && !notificationsDropdown.contains(event.target)) {
                notificationsDropdown.classList.add('hidden');
            }

            if (userMenuDropdown && !userMenuButton && !userMenuDropdown.contains(event.target)) {
                userMenuDropdown.classList.add('hidden');
            }
        });

        // Function to go to design page
        async function goToDesign(projectCode) {
            // Try to get project ID from map
            let projectId = projectCodeToIdMap[projectCode];

            // If not in map, try to find in projectsData
            if (!projectId && projectsData.length > 0) {
                const project = projectsData.find(p => p.project_code === projectCode);
                if (project) {
                    projectId = project.id;
                    projectCodeToIdMap[projectCode] = projectId;
                }
            }

            // If still not found, try to get from card's data attribute
            if (!projectId) {
                const card = document.querySelector(`[data-code="${projectCode}"]`);
                if (card) {
                    projectId = card.getAttribute('data-project-id');
                }
            }

            // If found, navigate
            if (projectId) {
                console.log('Navigating to design-new.html with projectId:', projectId);
                window.location.href = `design-new.html?projectId=${projectId}`;
            } else {
                // Try to load projects again
                console.log('Project ID not found, loading projects...');
                await loadProjectsAndAddButtons();

                // Try again
                projectId = projectCodeToIdMap[projectCode] ||
                    document.querySelector(`[data-code="${projectCode}"]`)?.getAttribute('data-project-id');

                if (projectId) {
                    window.location.href = `design-new.html?projectId=${projectId}`;
                } else {
                    alert('Kh√¥ng t√¨m th·∫•y ID d·ª± √°n. Vui l√≤ng th·ª≠ l·∫°i sau.');
                }
            }
        }

        // Function to go to project doors page
        function goToProjectDoors(projectId) {
            if (projectId) {
                window.location.href = `project-doors.html?projectId=${projectId}`;
            } else {
                alert('Kh√¥ng t√¨m th·∫•y ID d·ª± √°n');
            }
        }

        // Function to create quotation from project - redirect to quotation-new page
        async function createQuotationFromProject(projectId, projectCode, projectName) {
            if (!projectId) {
                alert('Kh√¥ng t√¨m th·∫•y ID d·ª± √°n');
                return;
            }

            try {
                // Get project details to get customer_id
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const project = result.data;
                    const customerId = project.customer_id;

                    if (!customerId) {
                        alert('D·ª± √°n ch∆∞a c√≥ kh√°ch h√†ng. Vui l√≤ng c·∫≠p nh·∫≠t th√¥ng tin kh√°ch h√†ng cho d·ª± √°n tr∆∞·ªõc.');
                        return;
                    }

                    // Redirect to quotation-new page with project_id and customer_id
                    window.location.href = `quotation-new.html?projectId=${projectId}&customerId=${customerId}`;
                } else {
                    alert('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin d·ª± √°n');
                }
            } catch (error) {
                console.error('Error getting project details:', error);
                alert('L·ªói k·∫øt n·ªëi server: ' + error.message);
            }
        }

        // Load and render projects from API
        async function loadProjects() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/projects`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const result = await response.json();

                if (result.success && result.data) {
                    // Filter ra c√°c d·ª± √°n ƒë√£ ho√†n th√†nh (status === 'completed' ho·∫∑c progress_percent >= 100)
                    projectsData = (result.data || []).filter(project => {
                        const status = (project.status || '').toLowerCase();
                        const progress = parseFloat(project.progress_percent) || 0;
                        // Lo·∫°i b·ªè d·ª± √°n ƒë√£ ho√†n th√†nh
                        return status !== 'completed' && progress < 100;
                    });

                    // Update heading with count
                    const heading = document.getElementById('projectsHeading');
                    if (heading) {
                        heading.textContent = `D·ª± √°n ƒëang tri·ªÉn khai (${projectsData.length})`;
                    }

                    // Clear container
                    const container = document.getElementById('projectsContainer');
                    if (!container) return;

                    container.innerHTML = '';

                    if (projectsData.length === 0) {
                        container.innerHTML = '<p class="text-center text-gray-500 py-8">Ch∆∞a c√≥ d·ª± √°n n√†o. H√£y t·∫°o d·ª± √°n m·ªõi!</p>';
                        return;
                    }

                    // Render each project with error handling
                    projectsData.forEach(project => {
                        try {
                            const card = createProjectCard(project);
                            container.appendChild(card);
                        } catch (error) {
                            console.error('Error creating card for project:', project.id, project.project_code, error);
                            // T·∫°o card l·ªói ƒë·ªÉ hi·ªÉn th·ªã
                            const errorCard = document.createElement('div');
                            errorCard.className = 'project-card bg-red-50 border border-red-200 shadow rounded-xl p-6 mb-4';
                            errorCard.innerHTML = `
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-bold text-red-700">L·ªói hi·ªÉn th·ªã d·ª± √°n</h3>
                                        <p class="text-sm text-red-600 mt-1">M√£: ${escapeHtml(project.project_code || 'N/A')}</p>
                                        <p class="text-xs text-red-500 mt-1">ID: ${project.id}</p>
                                    </div>
                                    <button onclick="openEditProjectModal(${project.id})" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700">
                                        S·ª≠a
                                    </button>
                                </div>
                            `;
                            container.appendChild(errorCard);
                        }
                    });

                    // Update project code to ID map
                    result.data.forEach(project => {
                        if (project.project_code) {
                            projectCodeToIdMap[project.project_code] = project.id;
                        }
                    });

                    // Apply filters
                    filterProjects();
                } else {
                    console.error('Failed to load projects:', result.message);
                    const container = document.getElementById('projectsContainer');
                    if (container) {
                        container.innerHTML = '<p class="text-center text-red-500 py-8">L·ªói khi t·∫£i d·ªØ li·ªáu d·ª± √°n</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                const container = document.getElementById('projectsContainer');
                if (container) {
                    container.innerHTML = '<p class="text-center text-red-500 py-8">L·ªói k·∫øt n·ªëi server</p>';
                }
            }
        }

        // Create project card HTML element
        function createProjectCard(project) {
            // Validate required fields
            if (!project || !project.id) {
                throw new Error('Project data is invalid: missing id');
            }

            const card = document.createElement('div');
            card.className = 'project-card bg-white shadow-lg rounded-2xl p-6 mb-4 fade-in';

            // Safe attribute setting v·ªõi default values
            card.setAttribute('data-status', project.status || 'new');
            card.setAttribute('data-progress', project.progress_percent || 0);
            card.setAttribute('data-name', project.project_name || 'Ch∆∞a c√≥ t√™n');
            card.setAttribute('data-customer', project.customer_name || '');
            card.setAttribute('data-phone', project.customer_phone || '');
            card.setAttribute('data-code', project.project_code || `CT-${project.id}`);
            card.setAttribute('data-project-id', project.id);

            const progress = project.progress_percent || 0;
            const status = project.status || 'new';
            const customerName = project.customer_name || 'N/A';
            const customerPhone = project.customer_phone || '';
            const projectCode = project.project_code || '';
            const projectName = project.project_name || 'N/A';
            const startDate = project.start_date ? formatDate(project.start_date) : 'N/A';
            const deadline = project.deadline ? formatDate(project.deadline) : 'N/A';
            const totalValue = project.total_value ? formatCurrency(project.total_value) : '0‚Ç´';

            // Determine status badge
            let statusBadge = '';
            if (status === 'approved') {
                statusBadge = '<span class="status-badge bg-green-100 text-green-700"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>ƒê√£ duy·ªát</span>';
            } else if (status === 'pending' || status === 'quotation_pending') {
                statusBadge = '<span class="status-badge bg-yellow-100 text-yellow-700"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Ch·ªù duy·ªát</span>';
            } else {
                statusBadge = '<span class="status-badge bg-gray-100 text-gray-600">M·ªõi</span>';
            }

            // Determine progress color
            let progressColor = 'bg-gray-400';
            if (progress >= 75) progressColor = 'bg-green-500';
            else if (progress >= 50) progressColor = 'bg-blue-500';
            else if (progress >= 25) progressColor = 'bg-orange-500';

            // Workflow steps (simplified - can be enhanced based on actual workflow data)
            // Th·ª© t·ª± m·ªõi: B√°o gi√° l√™n ƒë·∫ßu ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi l·ªánh s·∫£n xu·∫•t
            const workflowSteps = ['B√°o gi√°', 'Thi·∫øt k·∫ø', 'B√≥c t√°ch', 'S·∫£n xu·∫•t', 'L·∫Øp ƒë·∫∑t', 'B√†n giao'];

            // T√≠nh s·ªë b∆∞·ªõc ƒë√£ ho√†n th√†nh
            // N·∫øu progress >= 95 (ƒë√£ ·ªü "B√†n giao") ho·∫∑c progress >= 100 ho·∫∑c status === 'completed', t·∫•t c·∫£ 6 b∆∞·ªõc ƒë·ªÅu ho√†n th√†nh
            let completedSteps;
            const progressNum = parseFloat(progress) || 0;
            const statusStr = String(status || '').toLowerCase();

            if (progressNum >= 95 || progressNum >= 100 || statusStr === 'completed') {
                completedSteps = workflowSteps.length; // T·∫•t c·∫£ 6 b∆∞·ªõc (bao g·ªìm "B√†n giao")
                console.log('All steps completed:', { projectCode, progress: progressNum, status: statusStr, completedSteps });
            } else {
                // T√≠nh s·ªë b∆∞·ªõc d·ª±a tr√™n progress
                // M·ªói b∆∞·ªõc t∆∞∆°ng ·ª©ng v·ªõi ~16.67% (100% / 6 b∆∞·ªõc)
                completedSteps = Math.min(Math.floor(progressNum / 16.67), workflowSteps.length - 1);
            }

            let workflowHTML = '';
            workflowSteps.forEach((step, index) => {
                const isActive = index < completedSteps;
                workflowHTML += `
                    <div class="workflow-step">
                        <div class="workflow-step-circle ${isActive ? 'active' : 'inactive'}">
                            ${isActive ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>' : '‚Äî'}
                        </div>
                        <span class="text-xs text-center mt-1">${step}</span>
                    </div>
                `;
            });

            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-xl font-bold">${escapeHtml(projectName)}</h3>
                            <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">${escapeHtml(projectCode)}</span>
                        </div>
                        <div class="flex items-center gap-4 text-sm text-gray-600 mb-3">
                            <span class="flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                ${escapeHtml(customerName)}
                            </span>
                            ${customerPhone ? `
                            <span class="flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                </svg>
                                ${escapeHtml(customerPhone)}
                            </span>
                            ` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600 mb-1">Ng√†y b·∫Øt ƒë·∫ßu: <span class="font-medium">${startDate}</span></div>
                        <div class="text-sm text-gray-600 mb-1">Ng√†y giao: <span class="font-medium">${deadline}</span></div>
                        <div class="text-lg font-bold text-green-600">${totalValue}</div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium">Ti·∫øn ƒë·ªô: ${progress}%</span>
                    </div>
                    <div class="progress-bar bg-gray-200">
                        <div class="${progressColor} h-full" style="width: ${progress}%"></div>
                    </div>
                </div>

                <div class="flex items-center gap-2 mb-3">
                    ${statusBadge}
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        ${workflowHTML}
                    </div>
                </div>

                <div class="mt-4 flex gap-2 flex-wrap">
                    ${(project.quotation_count || 0) === 0 &&
                    status !== 'quotation_pending' &&
                    status !== 'waiting_quotation' ? `
                    <button onclick="createQuotationFromProject(${project.id}, '${escapeHtml(projectCode)}', '${escapeHtml(projectName)}')" class="action-btn border-2 border-teal-500 text-teal-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2 bg-teal-50 hover:bg-teal-100">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        T·∫°o b√°o gi√°
                    </button>
                    ` : ''}
                    <button onclick="goToDesign('${projectCode}')" class="action-btn border-2 border-blue-500 text-blue-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                        Thi·∫øt k·∫ø
                    </button>
                    <button onclick="goToProjectDoors(${project.id})" class="action-btn border-2 border-indigo-500 text-indigo-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                        </svg>
                        C·ª≠a
                    </button>
                    <button onclick="viewProjectDetails('${projectCode}')" class="action-btn border-2 border-purple-500 text-purple-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        Chi ti·∫øt
                    </button>
                    <button onclick="createProductionOrder('${projectCode}', ${project.id})" class="action-btn border-2 border-orange-500 text-orange-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                        </svg>
                        L·ªánh SX
                    </button>
                    <button onclick="viewProjectLogs('${projectCode}')" class="action-btn border-2 border-purple-500 text-purple-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Nh·∫≠t k√Ω
                    </button>
                    <button onclick="openEditProjectModal(${project.id})" class="action-btn border-2 border-green-500 text-green-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        S·ª≠a
                    </button>
                    <button onclick="confirmDeleteProject(${project.id}, '${escapeHtml(projectCode)}', '${escapeHtml(projectName)}')" class="action-btn border-2 border-red-500 text-red-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        X√≥a
                    </button>
                </div>
            `;

            return card;
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        // Helper function to format currency
        function formatCurrency(amount) {
            if (!amount) return '0‚Ç´';
            return new Intl.NumberFormat('vi-VN').format(amount) + '‚Ç´';
        }

        // Load projects from API and add design buttons (kept for backward compatibility)
        async function loadProjectsAndAddButtons() {
            try {
                console.log('Loading projects from API...');
                const response = await fetch(`${API_BASE}/projects`);
                const result = await response.json();

                console.log('API Response:', result);

                if (result.success && result.data && result.data.length > 0) {
                    // Store projects data globally
                    projectsData = result.data;

                    // Create a map of project codes to IDs
                    const projectMap = {};
                    result.data.forEach(project => {
                        if (project.project_code) {
                            projectMap[project.project_code] = project.id;
                            projectCodeToIdMap[project.project_code] = project.id;
                        }
                        // Also map by name for fallback
                        if (project.project_name) {
                            projectMap[project.project_name] = project.id;
                        }
                    });

                    console.log('Project Map:', projectMap);

                    // Add design buttons to all project cards
                    const cards = document.querySelectorAll('.project-card');
                    console.log('Found project cards:', cards.length);

                    cards.forEach((card, index) => {
                        const projectCode = card.getAttribute('data-code');
                        const projectName = card.querySelector('h3')?.textContent?.trim();

                        console.log(`Card ${index}: code=${projectCode}, name=${projectName}`);

                        // Try to get project ID from map
                        let projectId = projectMap[projectCode] || projectMap[projectName] || card.getAttribute('data-project-id');

                        // If still no ID, try to find by matching project name in API data
                        if (!projectId && projectName) {
                            const matchedProject = result.data.find(p => {
                                const nameMatch = p.project_name && p.project_name.trim() === projectName;
                                const codeMatch = p.project_code && p.project_code.trim() === projectCode;
                                return nameMatch || codeMatch;
                            });
                            if (matchedProject) {
                                projectId = matchedProject.id;
                                console.log(`Found match: ${matchedProject.id}`);
                            }
                        }

                        // Store project ID in data attribute for future use
                        if (projectId) {
                            card.setAttribute('data-project-id', projectId);
                            console.log(`Set project ID ${projectId} for card ${index}`);
                        } else {
                            console.warn(`No project ID found for card ${index} (${projectCode || projectName})`);
                        }

                        // Find action buttons container
                        const actionContainer = card.querySelector('.mt-4.flex.gap-2');
                        if (actionContainer) {
                            // Remove existing design button if any
                            const existingBtn = actionContainer.querySelector('.design-btn');
                            if (existingBtn) {
                                existingBtn.remove();
                            }

                            // Create design button
                            const designBtn = document.createElement('button');
                            designBtn.className = 'action-btn border-2 border-blue-500 text-blue-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2 design-btn';
                            designBtn.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                                Thi·∫øt k·∫ø
                            `;

                            // Store projectId in closure
                            const finalProjectId = projectId;

                            designBtn.onclick = function (e) {
                                e.preventDefault();
                                e.stopPropagation();

                                // Try multiple ways to get project ID
                                let pid = finalProjectId ||
                                    card.getAttribute('data-project-id') ||
                                    projectMap[projectCode] ||
                                    projectMap[projectName];

                                // Last resort: try to find in API data again
                                if (!pid && projectName) {
                                    const matched = projectsData.find(p =>
                                        (p.project_name && p.project_name.trim() === projectName) ||
                                        (p.project_code && p.project_code.trim() === projectCode)
                                    );
                                    if (matched) {
                                        pid = matched.id;
                                    }
                                }

                                if (pid) {
                                    console.log('Navigating to design-new.html with projectId:', pid);
                                    window.location.href = `design-new.html?projectId=${pid}`;
                                } else {
                                    console.error('No project ID found. Code:', projectCode, 'Name:', projectName);
                                    // Fallback: Try to create project or use a temporary ID
                                    const confirmCreate = confirm(`Kh√¥ng t√¨m th·∫•y d·ª± √°n "${projectName}" trong h·ªá th·ªëng.\n\nB·∫°n c√≥ mu·ªën t·∫°o d·ª± √°n m·ªõi v√† chuy·ªÉn ƒë·∫øn trang thi·∫øt k·∫ø kh√¥ng?`);
                                    if (confirmCreate) {
                                        // Create new project with data from card
                                        createProjectFromCard(card, projectCode, projectName).then(newProjectId => {
                                            if (newProjectId) {
                                                window.location.href = `design-new.html?projectId=${newProjectId}`;
                                            } else {
                                                alert('Kh√¥ng th·ªÉ t·∫°o d·ª± √°n m·ªõi. Vui l√≤ng th·ª≠ l·∫°i sau.');
                                            }
                                        });
                                    }
                                }
                            };

                            // Insert before first button
                            actionContainer.insertBefore(designBtn, actionContainer.firstChild);
                            console.log(`Added design button to card ${index}`);
                        } else {
                            console.warn(`No action container found for card ${index}`);
                        }
                    });
                } else {
                    console.warn('No projects found in API response');
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                alert('L·ªói k·∫øt n·ªëi server. Vui l√≤ng ki·ªÉm tra l·∫°i.');
            }
        }

        // Create project from card data (fallback)
        async function createProjectFromCard(card, projectCode, projectName) {
            try {
                const customerName = card.getAttribute('data-customer');
                const customerPhone = card.getAttribute('data-phone');

                // First, try to find or create customer
                let customerId = null;
                try {
                    const customerResponse = await fetch(`${API_BASE}/customers`);
                    const customerResult = await customerResponse.json();
                    if (customerResult.success && customerResult.data) {
                        const existingCustomer = customerResult.data.find(c =>
                            c.phone === customerPhone || c.full_name === customerName
                        );
                        if (existingCustomer) {
                            customerId = existingCustomer.id;
                        }
                    }
                } catch (e) {
                    console.error('Error finding customer:', e);
                }

                // Create project
                const projectData = {
                    project_code: projectCode || `CT${new Date().getFullYear()}-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`,
                    project_name: projectName,
                    customer_id: customerId || 1, // Default to first customer if not found
                    start_date: new Date().toISOString().split('T')[0],
                    deadline: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    status: 'pending',
                    progress_percent: 0
                };

                const response = await fetch(`${API_BASE}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(projectData)
                });

                const result = await response.json();
                if (result.success && result.data) {
                    return result.data.id || result.data.insertId;
                }
                return null;
            } catch (error) {
                console.error('Error creating project:', error);
                return null;
            }
        }

        // Get project ID from code
        async function getProjectIdFromCode(projectCode) {
            // Try from map first
            if (projectCodeToIdMap[projectCode]) {
                return projectCodeToIdMap[projectCode];
            }

            // Try from projectsData
            if (projectsData.length > 0) {
                const project = projectsData.find(p => p.project_code === projectCode);
                if (project) {
                    projectCodeToIdMap[projectCode] = project.id;
                    return project.id;
                }
            }

            // Try from card attribute
            const card = document.querySelector(`[data-code="${projectCode}"]`);
            if (card) {
                const id = card.getAttribute('data-project-id');
                if (id) return id;
            }

            // Try to load from API
            try {
                const response = await fetch(`${API_BASE}/projects?search=${encodeURIComponent(projectCode)}`);
                const result = await response.json();
                if (result.success && result.data && result.data.length > 0) {
                    const project = result.data.find(p => p.project_code === projectCode);
                    if (project) {
                        projectCodeToIdMap[projectCode] = project.id;
                        return project.id;
                    }
                }
            } catch (error) {
                console.error('Error fetching project:', error);
            }

            return null;
        }

        // View project details
        async function viewProjectDetails(projectCode) {
            const projectId = await getProjectIdFromCode(projectCode);
            if (!projectId) {
                alert('Kh√¥ng t√¨m th·∫•y ID d·ª± √°n. Vui l√≤ng th·ª≠ l·∫°i sau.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/projects/${projectId}`);
                const result = await response.json();

                if (result.success) {
                    const project = result.data;
                    const name = escapeHtml(project.project_name || 'N/A');
                    const code = escapeHtml(project.project_code || 'N/A');
                    const customer = escapeHtml(project.customer_name || 'N/A');
                    const phone = escapeHtml(project.customer_phone || '');
                    const status = escapeHtml(getStatusLabel(project.status));
                    const startDate = formatDate(project.start_date);
                    const deadline = formatDate(project.deadline);
                    const progress = project.progress_percent || 0;
                    const value = formatCurrency(project.total_value || 0);
                    const notes = project.notes ? escapeHtml(project.notes) : '';

                    let detailHTML = '<div class="space-y-4">';
                    detailHTML += '<div><h3 class="text-xl font-bold mb-2">' + name + '</h3>';
                    detailHTML += '<p class="text-gray-600">M√£ d·ª± √°n: <span class="font-medium">' + code + '</span></p></div>';
                    detailHTML += '<div class="grid grid-cols-2 gap-4">';
                    detailHTML += '<div><label class="text-sm text-gray-600">Kh√°ch h√†ng</label>';
                    detailHTML += '<p class="font-medium">' + customer + '</p>';
                    detailHTML += '<p class="text-sm text-gray-500">' + phone + '</p></div>';
                    detailHTML += '<div><label class="text-sm text-gray-600">Tr·∫°ng th√°i</label>';
                    detailHTML += '<p class="font-medium">' + status + '</p></div>';
                    detailHTML += '<div><label class="text-sm text-gray-600">Ng√†y b·∫Øt ƒë·∫ßu</label>';
                    detailHTML += '<p class="font-medium">' + startDate + '</p></div>';
                    detailHTML += '<div><label class="text-sm text-gray-600">Ng√†y giao</label>';
                    detailHTML += '<p class="font-medium">' + deadline + '</p></div>';
                    detailHTML += '<div><label class="text-sm text-gray-600">Ti·∫øn ƒë·ªô</label>';
                    detailHTML += '<p class="font-medium">' + progress + '%</p></div>';
                    detailHTML += '<div><label class="text-sm text-gray-600">Gi√° tr·ªã</label>';
                    detailHTML += '<p class="font-medium text-green-600">' + value + '</p></div></div>';
                    if (notes) {
                        detailHTML += '<div><label class="text-sm text-gray-600">Ghi ch√∫</label>';
                        detailHTML += '<p class="mt-1">' + notes + '</p></div>';
                    }
                    detailHTML += '</div>';

                    showProjectModal('Chi ti·∫øt d·ª± √°n', detailHTML);
                } else {
                    alert('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt d·ª± √°n');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('L·ªói k·∫øt n·ªëi server');
            }
        }

        // View project logs - bao g·ªìm project_logs v√† production_orders
        async function viewProjectLogs(projectCode) {
            const projectId = await getProjectIdFromCode(projectCode);
            if (!projectId) {
                alert('Kh√¥ng t√¨m th·∫•y ID d·ª± √°n. Vui l√≤ng th·ª≠ l·∫°i sau.');
                return;
            }

            try {
                const token = localStorage.getItem('token');

                // Load project logs v√† production orders
                const [logsResponse, ordersResponse] = await Promise.all([
                    fetch(`${API_BASE}/projects/${projectId}/logs`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json()).catch(() => ({ success: false, data: [] })),
                    fetch(`${API_BASE}/production-orders?project_id=${projectId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json()).catch(() => ({ success: false, data: [] }))
                ]);

                const projectLogs = logsResponse.success ? (logsResponse.data || []) : [];
                const productionOrders = ordersResponse.success ? (ordersResponse.data || []) : [];

                // T·∫°o danh s√°ch logs k·∫øt h·ª£p
                const allLogs = [];

                // Th√™m project logs
                projectLogs.forEach(log => {
                    allLogs.push({
                        type: 'project_log',
                        date: log.created_at,
                        title: log.title || getLogTypeLabel(log.action_type || log.log_type),
                        content: log.action_description || log.content || '',
                        user: log.created_by_name || ''
                    });
                });

                // Th√™m production order logs
                productionOrders.forEach(order => {
                    // Log t·∫°o l·ªánh s·∫£n xu·∫•t
                    if (order.created_at) {
                        allLogs.push({
                            type: 'production_order',
                            date: order.created_at,
                            title: 'L·ªánh s·∫£n xu·∫•t ƒë∆∞·ª£c t·∫°o',
                            content: `M√£ l·ªánh: ${escapeHtml(order.order_code || 'N/A')} - Tr·∫°ng th√°i: ${escapeHtml(order.status || 'N/A')}`,
                            user: ''
                        });
                    }

                    // Log c·∫≠p nh·∫≠t l·ªánh s·∫£n xu·∫•t
                    if (order.updated_at && order.updated_at !== order.created_at) {
                        allLogs.push({
                            type: 'production_order_update',
                            date: order.updated_at,
                            title: 'L·ªánh s·∫£n xu·∫•t ƒë∆∞·ª£c c·∫≠p nh·∫≠t',
                            content: `M√£ l·ªánh: ${escapeHtml(order.order_code || 'N/A')} - Tr·∫°ng th√°i: ${escapeHtml(order.status || 'N/A')}`,
                            user: ''
                        });
                    }
                });

                // S·∫Øp x·∫øp theo th·ªùi gian (m·ªõi nh·∫•t tr∆∞·ªõc)
                allLogs.sort((a, b) => new Date(b.date) - new Date(a.date));

                let logsHTML = '<div class="space-y-3 max-h-96 overflow-y-auto">';

                if (allLogs.length === 0) {
                    logsHTML += '<p class="text-center text-gray-500 py-8">Ch∆∞a c√≥ nh·∫≠t k√Ω n√†o</p>';
                } else {
                    allLogs.forEach(log => {
                        const date = formatDateTime(log.date);
                        const borderColor = log.type === 'production_order' ? 'border-green-500' :
                            log.type === 'production_order_update' ? 'border-orange-500' :
                                'border-blue-500';
                        const icon = log.type === 'production_order' ? 'üîß' :
                            log.type === 'production_order_update' ? 'üìù' : 'üìã';

                        logsHTML += `<div class="border-l-4 ${borderColor} pl-4 py-2 hover:bg-gray-50">`;
                        logsHTML += '<div class="flex justify-between items-start">';
                        logsHTML += '<div class="flex-1">';
                        logsHTML += `<p class="font-medium flex items-center gap-2"><span>${icon}</span>${escapeHtml(log.title)}</p>`;
                        if (log.content) {
                            logsHTML += `<p class="text-sm text-gray-600 mt-1">${log.content}</p>`;
                        }
                        if (log.user) {
                            logsHTML += `<p class="text-xs text-gray-400 mt-1">Ng∆∞·ªùi th·ª±c hi·ªán: ${escapeHtml(log.user)}</p>`;
                        }
                        logsHTML += '</div>';
                        logsHTML += `<span class="text-xs text-gray-500 ml-4 whitespace-nowrap">${date}</span>`;
                        logsHTML += '</div></div>';
                    });
                }

                logsHTML += '</div>';

                // L·∫•y t√™n d·ª± √°n ƒë·ªÉ hi·ªÉn th·ªã
                try {
                    const projectResponse = await fetch(`${API_BASE}/projects/${projectId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const projectResult = await projectResponse.json();
                    const projectName = projectResult.success ? (projectResult.data.project_name || projectCode) : projectCode;
                    showProjectModal(`Nh·∫≠t k√Ω d·ª± √°n: ${escapeHtml(projectName)}`, logsHTML);
                } catch (e) {
                    showProjectModal('Nh·∫≠t k√Ω d·ª± √°n', logsHTML);
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                alert('L·ªói khi t·∫£i nh·∫≠t k√Ω d·ª± √°n: ' + error.message);
            }
        }

        // Create production order
        async function createProductionOrder(projectCode, projectId = null) {
            // N·∫øu c√≥ projectId ƒë∆∞·ª£c truy·ªÅn v√†o, s·ª≠ d·ª•ng lu√¥n
            if (!projectId) {
                // N·∫øu kh√¥ng c√≥, th·ª≠ l·∫•y t·ª´ map ho·∫∑c t√¨m l·∫°i
                projectId = projectCodeToIdMap[projectCode] || await getProjectIdFromCode(projectCode);
            }

            if (!projectId) {
                alert('Kh√¥ng t√¨m th·∫•y ID d·ª± √°n. Vui l√≤ng th·ª≠ l·∫°i sau.');
                return;
            }

            // Redirect to production page with project ID
            window.location.href = `production.html?projectId=${projectId}&action=create`;
        }

        // Helper functions
        function getStatusLabel(status) {
            const labels = {
                'new': 'M·ªõi',
                'designing': 'ƒêang thi·∫øt k·∫ø',
                'quotation_pending': 'Ch·ªù b√°o gi√°',
                'quotation_approved': 'ƒê√£ duy·ªát',
                'in_production': 'ƒêang s·∫£n xu·∫•t',
                'completed': 'Ho√†n th√†nh',
                'paused': 'T·∫°m d·ª´ng',
                'cancelled': 'ƒê√£ h·ªßy',
                'approved': 'ƒê√£ duy·ªát',
                'pending': 'Ch·ªù duy·ªát'
            };
            return labels[status] || status;
        }

        function getLogTypeLabel(type) {
            const labels = {
                'status_change': 'Thay ƒë·ªïi tr·∫°ng th√°i',
                'progress_update': 'C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô',
                'note': 'Ghi ch√∫',
                'file_upload': 'T·∫£i file',
                'door_added': 'Th√™m c·ª≠a',
                'other': 'Kh√°c'
            };
            return labels[type] || type;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN');
            } catch (e) {
                return dateString;
            }
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('vi-VN');
            } catch (e) {
                return dateString;
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount || 0);
        }

        function escapeHtml(text) {
            if (!text) return '';
            if (typeof text !== 'string') text = String(text);
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show project modal
        function showProjectModal(title, content) {
            // Remove existing modal if any
            const existingModal = document.getElementById('projectDetailModal');
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = 'projectDetailModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';

            const titleEscaped = escapeHtml(title);
            let modalHTML = '<div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">';
            modalHTML += '<div class="flex justify-between items-center mb-6">';
            modalHTML += '<h2 class="text-2xl font-bold">' + titleEscaped + '</h2>';
            modalHTML += '<button onclick="closeProjectModal()" class="text-gray-500 hover:text-gray-700">';
            modalHTML += '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">';
            modalHTML += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />';
            modalHTML += '</svg></button></div>';
            modalHTML += '<div>' + content + '</div>';
            modalHTML += '<div class="flex justify-end mt-6">';
            modalHTML += '<button onclick="closeProjectModal()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">ƒê√≥ng</button>';
            modalHTML += '</div></div>';

            modal.innerHTML = modalHTML;
            document.body.appendChild(modal);
        }

        function closeProjectModal() {
            const modal = document.getElementById('projectDetailModal');
            if (modal) {
                modal.remove();
            }
        }

        // Call after page loads
        document.addEventListener('DOMContentLoaded', function () {
            // Load projects and statistics when page loads
            if (checkAuth()) {
                loadProjects();
                loadProjectStatistics();
            }
        });

        // Listen for project updates from other pages (e.g., production.html)
        window.addEventListener('projectUpdated', function (event) {
            console.log('Project updated event received:', event.detail);
            // Reload projects to reflect changes
            loadProjects();
            loadProjectStatistics();
        });

        // Open create project modal
        function openCreateProjectModal() {
            const modal = document.getElementById('createProjectModal');
            if (!modal) {
                console.error('Create project modal not found');
                return;
            }

            modal.classList.remove('hidden');

            // Load customers
            loadCustomers().catch(err => {
                console.error('Error loading customers:', err);
            });

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const startDateInput = document.getElementById('startDate');
            const deadlineInput = document.getElementById('deadline');

            if (startDateInput) {
                startDateInput.value = today;
            }

            if (deadlineInput) {
                const nextMonth = new Date();
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                deadlineInput.value = nextMonth.toISOString().split('T')[0];
            }

            // Auto-generate project code
            generateProjectCode().catch(err => {
                console.error('Error generating project code:', err);
            });
        }

        // Close create project modal
        function closeCreateProjectModal() {
            document.getElementById('createProjectModal').classList.add('hidden');
            document.getElementById('createProjectForm').reset();
        }

        // Generate project code
        async function generateProjectCode() {
            try {
                const year = new Date().getFullYear();
                const token = localStorage.getItem('token');

                // Get existing project codes to avoid duplicates
                const response = await fetch(`${API_BASE}/projects`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                let existingCodes = [];
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        existingCodes = result.data.map(p => p.project_code);
                    }
                }

                // Generate unique code
                let newCode;
                let attempts = 0;
                do {
                    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                    newCode = `CT${year}-${random}`;
                    attempts++;
                    if (attempts > 100) {
                        // Fallback: use timestamp if too many attempts
                        newCode = `CT${year}-${Date.now().toString().slice(-3)}`;
                        break;
                    }
                } while (existingCodes.includes(newCode));

                document.getElementById('projectCode').value = newCode;
            } catch (error) {
                console.error('Error generating project code:', error);
                // Fallback to simple generation
                const year = new Date().getFullYear();
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                document.getElementById('projectCode').value = `CT${year}-${random}`;
            }
        }

        // Load customers
        async function loadCustomers() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/customers`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                const select = document.getElementById('customerId');
                if (!select) {
                    console.error('Customer select element not found');
                    return;
                }

                select.innerHTML = '<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>';

                if (result.success && result.data && result.data.length > 0) {
                    result.data.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = `${customer.full_name || 'N/A'} - ${customer.phone || ''}`;
                        select.appendChild(option);
                    });
                } else {
                    console.warn('No customers found or invalid response:', result);
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '-- Ch∆∞a c√≥ kh√°ch h√†ng --';
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('L·ªói khi t·∫£i danh s√°ch kh√°ch h√†ng:', error);
                const select = document.getElementById('customerId');
                if (select) {
                    select.innerHTML = '<option value="">-- L·ªói khi t·∫£i danh s√°ch --</option>';
                }
                alert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch kh√°ch h√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.');
            }
        }

        // Save project
        async function saveProject(event) {
            event.preventDefault();

            // Get form values
            const projectCode = document.getElementById('projectCode').value.trim();
            const projectName = document.getElementById('projectName').value.trim();
            const customerId = document.getElementById('customerId').value;
            const startDate = document.getElementById('startDate').value;
            const deadline = document.getElementById('deadline').value;
            const status = document.getElementById('projectStatus').value;
            const notes = document.getElementById('projectNotes').value.trim();

            // Frontend validation
            if (!projectCode) {
                alert('Vui l√≤ng nh·∫≠p m√£ d·ª± √°n');
                document.getElementById('projectCode').focus();
                return;
            }

            if (!projectName) {
                alert('Vui l√≤ng nh·∫≠p t√™n d·ª± √°n');
                document.getElementById('projectName').focus();
                return;
            }

            if (!customerId) {
                alert('Vui l√≤ng ch·ªçn kh√°ch h√†ng');
                document.getElementById('customerId').focus();
                return;
            }

            if (!startDate) {
                alert('Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu');
                document.getElementById('startDate').focus();
                return;
            }

            if (!deadline) {
                alert('Vui l√≤ng ch·ªçn ng√†y giao d·ª± ki·∫øn');
                document.getElementById('deadline').focus();
                return;
            }

            // Validate dates
            const startDateObj = new Date(startDate);
            const deadlineDateObj = new Date(deadline);

            if (deadlineDateObj < startDateObj) {
                alert('Ng√†y giao d·ª± ki·∫øn ph·∫£i sau ng√†y b·∫Øt ƒë·∫ßu');
                document.getElementById('deadline').focus();
                return;
            }

            const projectData = {
                project_code: projectCode,
                project_name: projectName,
                customer_id: parseInt(customerId),
                start_date: startDate,
                deadline: deadline,
                status: status,
                notes: notes || null
            };

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch(`${API_BASE}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(projectData)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccessNotification('T·∫°o d·ª± √°n th√†nh c√¥ng!');
                    closeCreateProjectModal();
                    // Reload projects list and statistics
                    await loadProjects();
                    await loadProjectStatistics();
                } else {
                    // Show detailed error message
                    const errorMsg = result.message || 'Kh√¥ng th·ªÉ t·∫°o d·ª± √°n';
                    alert('L·ªói: ' + errorMsg);
                    console.error('Error creating project:', result);
                }
            } catch (error) {
                console.error('L·ªói:', error);
                alert('L·ªói k·∫øt n·ªëi server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.');
            }
        }

        // Open add customer modal (placeholder)
        function openAddCustomerModal() {
            alert('Ch·ª©c nƒÉng th√™m kh√°ch h√†ng m·ªõi s·∫Ω m·ªü trong tab m·ªõi. Vui l√≤ng th√™m kh√°ch h√†ng t·∫°i trang Kinh doanh & B√°o gi√°.');
            window.open('sales.html', '_blank');
        }

        // Load project statistics
        async function loadProjectStatistics() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/projects/stats/summary`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const stats = result.data;
                        // Update KPI cards
                        const runningEl = document.getElementById('runningProjectsCount');
                        const pendingEl = document.getElementById('pendingQuotationsCount');
                        const ordersEl = document.getElementById('productionOrdersCount');
                        const completedEl = document.getElementById('completedProjectsCount');

                        // D·ª± √°n ƒëang ch·∫°y = running_projects ho·∫∑c in_production (kh√¥ng bao g·ªìm completed)
                        if (runningEl) runningEl.textContent = stats.running_projects || stats.in_production || 0;
                        // B√°o gi√° ch·ªù duy·ªát t·ª´ b·∫£ng quotations
                        if (pendingEl) pendingEl.textContent = stats.pending_quotations || 0;
                        // L·ªánh s·∫£n xu·∫•t t·ª´ b·∫£ng production_orders
                        if (ordersEl) ordersEl.textContent = stats.production_orders || 0;
                        // D·ª± √°n ƒë√£ ho√†n th√†nh
                        if (completedEl) completedEl.textContent = stats.completed || 0;
                    }
                } else {
                    console.error('Failed to load statistics:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Error loading project statistics:', error);
            }
        }

        // Load completed projects count (kept for backward compatibility)
        async function loadCompletedProjectsCount() {
            await loadProjectStatistics();
        }

        // Open edit project modal
        async function openEditProjectModal(projectId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (!result.success) {
                    alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin d·ª± √°n: ' + (result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
                    return;
                }

                const project = result.data;

                // Fill edit form
                document.getElementById('editProjectId').value = project.id;
                document.getElementById('editProjectCode').value = project.project_code || '';
                document.getElementById('editProjectName').value = project.project_name || '';
                document.getElementById('editCustomerId').value = project.customer_id || '';
                document.getElementById('editStartDate').value = project.start_date ? project.start_date.split('T')[0] : '';
                document.getElementById('editDeadline').value = project.deadline ? project.deadline.split('T')[0] : '';
                document.getElementById('editProjectStatus').value = project.status || 'new';
                document.getElementById('editProjectNotes').value = project.notes || '';

                // Load customers if not already loaded
                await loadCustomersForEdit();

                // Show modal
                document.getElementById('editProjectModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading project:', error);
                alert('L·ªói khi t·∫£i th√¥ng tin d·ª± √°n: ' + error.message);
            }
        }

        // Close edit project modal
        function closeEditProjectModal() {
            document.getElementById('editProjectModal').classList.add('hidden');
            document.getElementById('editProjectForm').reset();
        }

        // Load customers for edit modal
        async function loadCustomersForEdit() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/customers`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                const select = document.getElementById('editCustomerId');
                if (!select) return;

                select.innerHTML = '<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>';

                if (result.success && result.data && result.data.length > 0) {
                    result.data.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = `${customer.full_name || 'N/A'} - ${customer.phone || ''}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        // Update project
        async function updateProject(event) {
            event.preventDefault();

            const projectId = document.getElementById('editProjectId').value;
            const projectName = document.getElementById('editProjectName').value.trim();
            const customerId = document.getElementById('editCustomerId').value;
            const startDate = document.getElementById('editStartDate').value;
            const deadline = document.getElementById('editDeadline').value;
            const status = document.getElementById('editProjectStatus').value;
            const notes = document.getElementById('editProjectNotes').value.trim();

            // Validation
            if (!projectName) {
                alert('Vui l√≤ng nh·∫≠p t√™n d·ª± √°n');
                document.getElementById('editProjectName').focus();
                return;
            }

            if (!customerId) {
                alert('Vui l√≤ng ch·ªçn kh√°ch h√†ng');
                document.getElementById('editCustomerId').focus();
                return;
            }

            if (!startDate) {
                alert('Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu');
                document.getElementById('editStartDate').focus();
                return;
            }

            if (!deadline) {
                alert('Vui l√≤ng ch·ªçn ng√†y giao d·ª± ki·∫øn');
                document.getElementById('editDeadline').focus();
                return;
            }

            const startDateObj = new Date(startDate);
            const deadlineDateObj = new Date(deadline);

            if (deadlineDateObj < startDateObj) {
                alert('Ng√†y giao d·ª± ki·∫øn ph·∫£i sau ng√†y b·∫Øt ƒë·∫ßu');
                document.getElementById('editDeadline').focus();
                return;
            }

            const projectData = {
                project_name: projectName,
                customer_id: parseInt(customerId),
                start_date: startDate,
                deadline: deadline,
                status: status,
                notes: notes || null
            };

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(projectData)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccessNotification('C·∫≠p nh·∫≠t d·ª± √°n th√†nh c√¥ng!');
                    closeEditProjectModal();
                    await loadProjects();
                    await loadProjectStatistics();
                } else {
                    const errorMsg = result.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t d·ª± √°n';
                    alert('L·ªói: ' + errorMsg);
                    console.error('Error updating project:', result);
                }
            } catch (error) {
                console.error('L·ªói:', error);
                alert('L·ªói k·∫øt n·ªëi server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.');
            }
        }

        // Confirm and delete project
        function confirmDeleteProject(projectId, projectCode, projectName) {
            if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a d·ª± √°n "${projectName}" (${projectCode})?\n\nL∆∞u √Ω: Kh√¥ng th·ªÉ x√≥a d·ª± √°n n·∫øu ƒë√£ c√≥ c·ª≠a ƒë∆∞·ª£c thi·∫øt k·∫ø.`)) {
                deleteProject(projectId);
            }
        }

        // Delete project
        async function deleteProject(projectId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showSuccessNotification('X√≥a d·ª± √°n th√†nh c√¥ng!');
                    await loadProjects();
                    await loadProjectStatistics();
                } else {
                    const errorMsg = result.message || 'Kh√¥ng th·ªÉ x√≥a d·ª± √°n';
                    alert('L·ªói: ' + errorMsg);
                    console.error('Error deleting project:', result);
                }
            } catch (error) {
                console.error('L·ªói:', error);
                alert('L·ªói k·∫øt n·ªëi server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            // Check authentication and load user info
            if (checkAuth()) {
                loadUserInfo();
                loadUnreadCount();
                loadProjectStatistics();

                // Refresh notifications every 30 seconds
                setInterval(() => {
                    loadUnreadCount();
                }, 30000);

                // Refresh completed projects count every 30 seconds
                setInterval(() => {
                    loadCompletedProjectsCount();
                }, 30000);
            }

            // Auto-generate project code on modal open
            const modal = document.getElementById('createProjectModal');
            if (modal) {
                const observer = new MutationObserver(function (mutations) {
                    if (!modal.classList.contains('hidden')) {
                        // Call async function properly
                        generateProjectCode().catch(err => {
                            console.error('Error auto-generating project code:', err);
                        });
                    }
                });
                observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
            }
        });
    </script>
    <script src="js/notification-header.js"></script>
</body>

</html>