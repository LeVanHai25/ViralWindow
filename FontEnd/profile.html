<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ sơ - Hệ thống quản lý cửa nhôm kính</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">
    <!-- HEADER -->
    <div class="bg-white shadow p-5 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <a href="index.html" class="icon-square bg-blue-600 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </a>
            <div>
                <h1 class="text-2xl font-bold">Hồ sơ cá nhân</h1>
                <p class="text-gray-500 text-sm">Quản lý thông tin tài khoản của bạn</p>
            </div>
        </div>
    </div>

    <div class="p-6 max-w-4xl mx-auto">
        <!-- Profile Card -->
        <div class="bg-white rounded-xl shadow p-6 mb-6">
            <div class="flex items-center gap-6 mb-6">
                <div class="relative">
                    <div class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center text-white text-3xl font-bold overflow-hidden relative" id="avatarContainer">
                        <div id="avatarInitial" class="absolute inset-0 flex items-center justify-center">U</div>
                        <img id="avatarImage" src="" alt="Avatar" class="hidden w-full h-full object-cover rounded-full">
                    </div>
                    <input type="file" id="avatarUpload" accept="image/png,image/jpeg,image/jpg" class="hidden" onchange="handleAvatarUpload(event)">
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold mb-1" id="userFullName">Người dùng</h2>
                    <p class="text-gray-600" id="userEmail">user@example.com</p>
                    <p class="text-sm text-gray-500 mt-1" id="userType">Người dùng</p>
                </div>
                <button onclick="changeAvatar()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Đổi ảnh đại diện
                </button>
            </div>
        </div>

        <!-- Profile Form -->
        <div class="bg-white rounded-xl shadow p-6">
            <h3 class="text-xl font-bold mb-6">Thông tin cá nhân</h3>
            
            <form id="profileForm" onsubmit="updateProfile(event)" class="space-y-6">
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Họ và tên <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="fullName" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Số điện thoại
                        </label>
                        <input type="tel" id="phone"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Email <span class="text-red-500">*</span>
                    </label>
                    <input type="email" id="email" required readonly
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 cursor-not-allowed">
                    <p class="text-xs text-gray-500 mt-1">Email không thể thay đổi</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Địa chỉ
                    </label>
                    <textarea id="address" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <div class="pt-4 border-t border-gray-200">
                    <h4 class="text-lg font-semibold mb-4">Đổi mật khẩu</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Mật khẩu hiện tại
                            </label>
                            <input type="password" id="currentPassword"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Mật khẩu mới
                                </label>
                                <input type="password" id="newPassword"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Xác nhận mật khẩu mới
                                </label>
                                <input type="password" id="confirmPassword"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-4 pt-4 border-t border-gray-200">
                    <button type="button" onclick="window.location.href='index.html'"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium hover:bg-gray-50">
                        Hủy
                    </button>
                    <button type="submit"
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">
                        Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let currentAvatarBase64 = null; // Lưu avatar base64 hiện tại

        // Load user profile
        async function loadProfile() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const user = result.data;
                    document.getElementById('fullName').value = user.full_name || '';
                    document.getElementById('phone').value = user.phone || '';
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('address').value = user.address || '';
                    document.getElementById('userFullName').textContent = user.full_name || 'Người dùng';
                    document.getElementById('userEmail').textContent = user.email || '';
                    document.getElementById('userType').textContent = user.user_type === 'admin' ? 'Quản trị viên' : 'Người dùng';
                    
                    // Load avatar
                    const avatarInitial = document.getElementById('avatarInitial');
                    const avatarImage = document.getElementById('avatarImage');
                    
                    if (user.avatar_url) {
                        currentAvatarBase64 = user.avatar_url;
                        avatarImage.src = user.avatar_url;
                        avatarImage.classList.remove('hidden');
                        avatarInitial.classList.add('hidden');
                    } else {
                        // Hiển thị chữ cái đầu của tên
                        const initial = (user.full_name || 'U').charAt(0).toUpperCase();
                        avatarInitial.textContent = initial;
                        avatarInitial.classList.remove('hidden');
                        avatarImage.classList.add('hidden');
                        currentAvatarBase64 = null; // Reset avatar
                    }
                } else {
                    alert('Không thể tải thông tin người dùng');
                }
            } catch (error) {
                console.error('Lỗi:', error);
                alert('Lỗi kết nối server');
            }
        }

        // Update profile
        async function updateProfile(event) {
            event.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Check if password change is requested
            if (newPassword || currentPassword) {
                if (!currentPassword) {
                    alert('Vui lòng nhập mật khẩu hiện tại');
                    return;
                }
                if (newPassword.length < 6) {
                    alert('Mật khẩu mới phải có ít nhất 6 ký tự');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    alert('Mật khẩu xác nhận không khớp');
                    return;
                }
            }

            const profileData = {
                full_name: document.getElementById('fullName').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value
            };

            // Thêm avatar nếu có
            if (currentAvatarBase64) {
                profileData.avatar_url = currentAvatarBase64;
            }

            if (newPassword) {
                profileData.current_password = currentPassword;
                profileData.new_password = newPassword;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/auth/update-profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(profileData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Cập nhật thông tin thành công!');
                    loadProfile();
                    // Clear password fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    alert('Lỗi: ' + (result.message || 'Không thể cập nhật'));
                }
            } catch (error) {
                console.error('Lỗi:', error);
                alert('Lỗi kết nối server');
            }
        }

        // Change avatar button click
        function changeAvatar() {
            document.getElementById('avatarUpload').click();
        }

        // Handle avatar upload với tối ưu hóa ảnh
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Kiểm tra kích thước file (tối đa 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('File quá lớn! Vui lòng chọn file nhỏ hơn 2MB.');
                event.target.value = '';
                return;
            }

            // Kiểm tra định dạng file
            if (!file.type.match('image/(png|jpeg|jpg)')) {
                alert('Chỉ chấp nhận file PNG, JPG hoặc JPEG!');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Tạo canvas để resize và compress ảnh
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Giới hạn kích thước tối đa 300x300px cho avatar
                    const maxSize = 300;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Vẽ ảnh đã resize lên canvas
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Chuyển sang base64 với chất lượng 0.85
                    const base64 = canvas.toDataURL('image/jpeg', 0.85);
                    currentAvatarBase64 = base64;
                    
                    // Hiển thị avatar
                    const avatarInitial = document.getElementById('avatarInitial');
                    const avatarImage = document.getElementById('avatarImage');
                    
                    avatarImage.src = base64;
                    avatarImage.classList.remove('hidden');
                    avatarInitial.classList.add('hidden');
                    
                    // Tự động lưu avatar (không hiển thị alert trong saveAvatar vì đã có ở đây)
                    saveAvatar().then(() => {
                        // Avatar đã được lưu, không cần làm gì thêm
                    }).catch(err => {
                        console.error('Lỗi khi lưu avatar:', err);
                    });
                };
                img.onerror = function() {
                    alert('Lỗi khi tải ảnh!');
                };
                img.src = e.target.result;
            };
            reader.onerror = function() {
                alert('Lỗi khi đọc file!');
            };
            reader.readAsDataURL(file);
        }

        // Save avatar to server
        async function saveAvatar() {
            if (!currentAvatarBase64) {
                console.warn('Không có avatar để lưu');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Vui lòng đăng nhập lại');
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch(`${API_BASE}/auth/update-profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        avatar_url: currentAvatarBase64
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Cập nhật avatar ngay lập tức từ response
                    if (result.data && result.data.avatar_url) {
                        currentAvatarBase64 = result.data.avatar_url;
                        const avatarInitial = document.getElementById('avatarInitial');
                        const avatarImage = document.getElementById('avatarImage');
                        avatarImage.src = result.data.avatar_url;
                        avatarImage.classList.remove('hidden');
                        avatarInitial.classList.add('hidden');
                    }
                    alert('Đổi ảnh đại diện thành công!');
                } else {
                    console.error('Lỗi khi lưu avatar:', result.message);
                    alert('Lỗi khi lưu ảnh đại diện: ' + (result.message || 'Không thể lưu'));
                    // Khôi phục lại avatar cũ nếu lưu thất bại
                    await loadProfile();
                }
            } catch (error) {
                console.error('Lỗi khi lưu avatar:', error);
                alert('Lỗi kết nối server khi lưu ảnh đại diện');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadProfile();
        });
    </script>

    <style>
        .icon-square {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
    </style>
</body>
</html>

